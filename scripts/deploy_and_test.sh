#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
# –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–æ—Ç–∞

set -e

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º..."
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ bot.py..."
if ps aux | grep 'python.*bot\.py' | grep -v grep > /dev/null 2>&1; then
    echo "‚ùå –û–®–ò–ë–ö–ê: –û–±–Ω–∞—Ä—É–∂–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å bot.py!"
    echo ""
    echo "–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã:"
    ps aux | grep 'python.*bot\.py' | grep -v grep
    echo ""
    echo "‚ö†Ô∏è  –û–°–¢–ê–ù–û–í–ò–¢–ï –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º!"
    echo "–ö–æ–º–∞–Ω–¥–∞: pkill -f 'python.*bot\.py'"
    exit 1
fi
echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
echo ""

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å–∞..."
if ! git diff-index --quiet HEAD --; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è!"
    git status --short
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–µ–ø–ª–æ–π? (y/n): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "–î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω–µ–Ω"
        exit 1
    fi
fi
echo "‚úÖ Git —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω"
echo ""

# 3. –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub
echo "3Ô∏è‚É£ –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ GitHub..."
git push origin main || {
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É—à–µ –≤ GitHub"
    exit 1
}
echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã"
echo ""

# 4. –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "4Ô∏è‚É£ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä Yandex Cloud..."
SERVER_USER="ubuntu"
SERVER_HOST="84.252.137.116"
SSH_KEY="$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599"

ssh -i "$SSH_KEY" "${SERVER_USER}@${SERVER_HOST}" << 'ENDSSH'
cd /home/ubuntu/marketingbot
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
git pull
echo "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
/home/ubuntu/marketingbot/.venv/bin/pip install -r requirements.txt
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
sudo systemctl restart marketingbot-bot.service
echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞..."
sleep 2
ENDSSH

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω"
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
ssh -i "$SSH_KEY" "${SERVER_USER}@${SERVER_HOST}" \
    "sudo systemctl status marketingbot-bot.service | head -20"
echo ""

echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo ""
echo "üì± –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram"
echo "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ssh -i $SSH_KEY ${SERVER_USER}@${SERVER_HOST} 'journalctl -u marketingbot-bot.service -f'"
