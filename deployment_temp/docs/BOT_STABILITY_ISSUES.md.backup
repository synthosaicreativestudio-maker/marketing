# Техническая проблематика стабильности Telegram бота

## 1. Симптомы

### 1.1 Периодические остановки бота
- Бот периодически прекращает работу без явных причин
- Systemd сервис `marketingbot-bot.service` переходит в состояние `failed` или `inactive`
- За последние 7 дней зафиксировано **552 ошибки** в логах

### 1.2 Ошибки внешних API
- Регулярные ошибки Google Sheets API с кодом **503 (Service Unavailable)**
- Ошибки возникают в компонентах:
  - `promotions_api.py` - при подключении к таблице акций
  - `appeals_service.py` - при работе с листом обращений
  - `auth_service.py` - при проверке авторизации пользователей

### 1.3 Нестабильность фоновых задач
- Фоновые мониторинговые задачи (`ResponseMonitor`, `PromotionsNotifier`) могут завершаться с необработанными исключениями
- Отсутствие автоматического восстановления после ошибок в циклах мониторинга

## 2. Корневые причины

### 2.1 Отсутствие механизма повторных попыток (Retry Logic)
**Проблема:** Все вызовы Google Sheets API выполняются без механизма повторных попыток при временных сбоях.

**Затронутые компоненты:**
- `promotions_api.py:17-74` - функция `_get_promotions_client_and_sheet()`
- `sheets.py:54-87` - функция `_get_client_and_sheet()`
- `sheets.py:90-123` - функция `_get_appeals_client_and_sheet()`
- `appeals_service.py:18-33` - инициализация `AppealsService`
- Все методы работы с Google Sheets API в `gspread` библиотеке

**Техническая деталь:** При возникновении HTTP 503 (Service Unavailable) или других временных ошибок (429 Rate Limit, 500 Internal Server Error) запросы не повторяются, что приводит к немедленному провалу операции.

### 2.2 Отсутствие Circuit Breaker паттерна
**Проблема:** При частых ошибках Google Sheets API система продолжает выполнять запросы, что может привести к:
- Каскадным отказам
- Исчерпанию квот API
- Блокировке service account

**Техническая деталь:** Нет механизма временного отключения проблемного сервиса при превышении порога ошибок.

### 2.3 Недостаточная изоляция ошибок в фоновых задачах

#### 2.3.1 PromotionsNotifier
**Файл:** `promotions_notifier.py`

**Проблемные участки:**
- `start_monitoring()` (строки 189-199): основной цикл мониторинга имеет общий `try-except`, но при критических ошибках (например, `PromotionsNotConfiguredError`) цикл может завершиться
- `check_and_send_notifications()` (строки 20-47): ошибки Google Sheets API могут привести к необработанным исключениям
- `_get_promotions_client_and_sheet()` вызывается без обработки временных ошибок

**Техническая деталь:** При ошибке `APIError: [503]: The service is currently unavailable` в `promotions_api.py:73`, исключение пробрасывается вверх по стеку и может завершить фоновую задачу.

#### 2.3.2 ResponseMonitor
**Файл:** `response_monitor.py`

**Проблемные участки:**
- `_monitoring_loop()` (строки 61-78): цикл имеет обработку исключений, но при критических ошибках Google Sheets API может произойти неожиданное завершение
- `_check_and_send_responses()` (строки 80-97): вызовы `appeals_service` методов не имеют retry логики
- Методы `appeals_service.check_for_responses()` и `appeals_service.check_for_resolved_status()` могут выбрасывать необработанные исключения при ошибках API

**Техническая деталь:** Ошибки в методах `AppealsService` могут привести к завершению мониторинга ответов специалистов.

### 2.4 Недостаточная обработка ошибок в основном цикле бота
**Файл:** `bot.py`

**Проблемные участки:**
- `main()` (строки 101-207): при инициализации сервисов ошибки могут привести к `sys.exit(1)` без graceful shutdown
- Фоновые задачи запускаются через `post_init` callback, но ошибки в них могут повлиять на основной event loop
- Отсутствие watchdog механизма для автоматического восстановления после критических ошибок

## 3. Влияние на систему

### 3.1 Функциональное влияние
- **Потеря мониторинга ответов специалистов:** `ResponseMonitor` может прекратить работу, пользователи не получат ответы
- **Потеря уведомлений о акциях:** `PromotionsNotifier` может прекратить работу, пользователи не получат информацию о новых акциях
- **Полная остановка бота:** при критических ошибках бот может полностью прекратить работу

### 3.2 Операционное влияние
- Необходимость ручного перезапуска сервиса через systemd
- Потеря доступности сервиса для пользователей
- Увеличение нагрузки на администратора для мониторинга и восстановления

### 3.3 Техническое влияние
- Накопление ошибок в логах (552 ошибки за 7 дней)
- Потенциальная блокировка service account при частых запросах
- Неэффективное использование ресурсов при повторных попытках без backoff

## 4. Технические детали

### 4.1 Типы ошибок Google Sheets API

#### 4.1.1 Временные ошибки (требуют retry)
- **503 Service Unavailable:** сервис временно недоступен
- **429 Too Many Requests:** превышен лимит запросов (rate limiting)
- **500 Internal Server Error:** внутренняя ошибка сервера Google
- **502 Bad Gateway:** проблемы с прокси/шлюзом

#### 4.1.2 Постоянные ошибки (не требуют retry)
- **401 Unauthorized:** проблемы с аутентификацией
- **403 Forbidden:** недостаточно прав доступа
- **404 Not Found:** ресурс не найден

### 4.2 Архитектурные проблемы

#### 4.2.1 Синхронные вызовы в асинхронном контексте
**Проблема:** Методы `gspread` выполняются синхронно, что может блокировать event loop при длительных операциях или таймаутах.

**Затронутые компоненты:**
- Все вызовы `worksheet.get_all_records()`
- Все вызовы `worksheet.update()`, `worksheet.append_row()`
- Все вызовы `spreadsheet.worksheet()`

#### 4.2.2 Отсутствие таймаутов
**Проблема:** Вызовы Google Sheets API не имеют явных таймаутов, что может привести к зависанию при сетевых проблемах.

#### 4.2.3 Отсутствие экспоненциального backoff
**Проблема:** При повторных попытках не используется экспоненциальный backoff, что может привести к:
- Перегрузке API при восстановлении сервиса
- Блокировке service account
- Неэффективному использованию ресурсов

## 5. Затронутые компоненты

### 5.1 Основные модули
- `bot.py` - основной модуль бота
- `promotions_api.py` - API для работы с акциями
- `promotions_notifier.py` - сервис уведомлений о акциях
- `response_monitor.py` - мониторинг ответов специалистов
- `appeals_service.py` - сервис работы с обращениями
- `sheets.py` - утилиты для работы с Google Sheets
- `auth_service.py` - сервис авторизации

### 5.2 Зависимости
- `gspread` - библиотека для работы с Google Sheets API
- `google-auth` - библиотека аутентификации Google
- `python-telegram-bot` - библиотека Telegram Bot API

## 6. Метрики проблемы

- **Частота ошибок:** 552 ошибки за 7 дней (~79 ошибок/день)
- **Типы ошибок:** преимущественно 503 Service Unavailable
- **Время восстановления:** требует ручного вмешательства
- **Влияние на пользователей:** полная потеря функциональности при остановке бота

## 7. Требуемые исправления

### 7.1 Критичные (высокий приоритет)
1. Реализация retry логики с экспоненциальным backoff для всех вызовов Google Sheets API
2. Реализация Circuit Breaker паттерна для защиты от каскадных ошибок
3. Улучшение обработки ошибок в фоновых задачах (`PromotionsNotifier`, `ResponseMonitor`)
4. Добавление таймаутов для всех вызовов Google Sheets API

### 7.2 Важные (средний приоритет)
1. Реализация watchdog механизма для автоматического восстановления
2. Улучшение graceful shutdown при критических ошибках
3. Добавление метрик и мониторинга для отслеживания здоровья системы
4. Оптимизация использования ресурсов при повторных попытках

### 7.3 Желательные (низкий приоритет)
1. Миграция синхронных вызовов `gspread` на асинхронные обертки
2. Реализация кэширования для снижения нагрузки на API
3. Добавление health check endpoints для мониторинга
