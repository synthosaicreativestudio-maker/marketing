================================================================================
PROJECT CODE COLLECTION FOR CODE REVIEW
================================================================================

=== PROJECT STRUCTURE ===

./
  GOOGLE_APPS_SCRIPT_FULL.js
  PROJECT_SUMMARY.md
  README.md
  TESTING_GUIDE.md
  analyze_new_sheet.py
  analyze_sheets.py
  api_wsgi.py
  app.js
  appeals_service.py
  auth_service.py
  bot.py
  bot_health_monitor.py
  check_pythonanywhere.py
  collect_code.py
  debug_auth_issue.py
  error_handler.py
  google_apps_script_complete.js
  google_apps_script_promotions.js
  handlers.py
  index.html
  init_db.py
  menu.html
  openai_service.py
  promotions_api.py
  promotions_notifier.py
  requirements.txt
  response_monitor.py
  sheets_gateway.py
  sheets_utils.py
  test_appeals.py
  webhook_handler.py
  –ò–ù–°–¢–†–£–ö–¶–ò–Ø_–ü–û_–£–°–¢–ê–ù–û–í–ö–ï.txt
  –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_CORS.md
  migrations/
    __init__.py
    migrate_appeals.py
  admin/
    README.md
    app.js
    index.html
    styles.css
  docs/
    ARCHITECTURE.md
    BOT_STABILITY_ISSUES.md
    BOT_STABILITY_ISSUES.md.backup
    CHANGELOG.md
    COMPREHENSIVE_STABILITY_FIX.md
    DATABASE_SETUP.md
    DEPLOYMENT.md
    DEPLOYMENT_ARCHITECTURE.md
    DESIGN_PLAN.md
    FEATURES.md
    IMPLEMENTATION_PLAN.md
    MIGRATION_IMPLEMENTATION.md
    MIGRATION_TO_DATABASE.md
    PLAN_IMPROVEMENTS.md
    PROJECT_AUDIT.md
    PROJECT_RULES.md
    README.md
    REORGANIZATION_SUMMARY.md
    SECURITY.md
    TESTING.md
    tools/
      debug_telegram_auth.js
      fetch_sheets.py
      telegram_webapp_debug.py
    archive/
      CLOUDFLARE_TUNNEL_SETUP.md
      QUICK_START_CLOUDFLARE.md
    troubleshooting/
      DEPLOYMENT_ISSUES.md
      PROMOTIONS_ISSUES.md
      TROUBLESHOOTING.md
    getting-started/
      INSTALLATION.md
      QUICK_START_GOOGLE_APPS_SCRIPT.md
      SIMPLE_SETUP.md
    guides/
      GOOGLE_APPS_SCRIPT_SETUP.md
      GOOGLE_SHEETS.md
      UPDATE_GOOGLE_APPS_SCRIPT_WEBHOOK.md
    deployment/
      DEPLOYMENT_PYTHONANYWHERE.md
      DEPLOYMENT_YANDEX.md
    reference/
      API_REFERENCE.md
  scripts/
    README.md
    check_bot_status.sh
    deploy_yandex.sh
    install_cloudflare_tunnel.sh
    setup_cloudflare_tunnel.sh
    setup_cloudflare_tunnel_simple.sh
    setup_yandex_systemd.sh
    ssh_yandex.sh
    start_bot_pythonanywhere.sh
    start_yandex_services.sh
    update_bot_pythonanywhere.sh
    update_env.py
    update_gas_url.py
    update_google_apps_script_url.sh
    update_pythonanywhere.sh
    update_server_from_local.sh
    update_sheet_id.py
    update_yandex_server.sh
  db/
    __init__.py
    database.py
    models.py
  api/
    __init__.py
    main.py
    schemas.py
    routers/
      __init__.py
      appeals.py
    services/
      __init__.py
      appeals_db.py
  handlers/
    utils.py


================================================================================
=== FILE CONTENTS ===
================================================================================



================================================================================
FILE: ./GOOGLE_APPS_SCRIPT_FULL.js
SIZE: 23336 bytes
================================================================================

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê) ===

// –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞
const SHEET_NAME = "–ê–∫—Ü–∏–∏";

// –ù–æ–º–µ—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
const RELEASE_DATE_COL = 1;
const TITLE_COL = 2;
const DESCRIPTION_COL = 3;
const STATUS_COL = 4;
const START_DATE_COL = 5;
const END_DATE_COL = 6;
const CONTENT_COL = 7;
const LINK_COL = 8;
const ACTION_COL = 9;

// –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
const HEADERS = [
  "–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–°—Ç–∞—Ç—É—Å", 
  "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞", "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è", "–ö–æ–Ω—Ç–µ–Ω—Ç", "–°—Å—ã–ª–∫–∞", "–î–µ–π—Å—Ç–≤–∏–µ"
];

// –ù–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã
const STATUS_PENDING = "–û–∂–∏–¥–∞–µ—Ç";
const STATUS_ACTIVE = "–ê–∫—Ç–∏–≤–Ω–∞";
const STATUS_FINISHED = "–ó–∞–∫–æ–Ω—á–µ–Ω–∞";

// –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
const ACTION_PUBLISH = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
const ACTION_FINISH = "–ó–∞–≤–µ—Ä—à–∏—Ç—å";

// –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–ª–∏–≤–∫–∏
const COLOR_PENDING = "#fff2cc";   // –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π
const COLOR_ACTIVE = "#d9ead3";    // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
const COLOR_FINISHED = "#f4cccc";  // –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π

// Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const WEBHOOK_URL = 'http://158.160.0.127:8080/webhook/promotions';
const WEBHOOK_SECRET = 'default_secret'; // –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å WEBHOOK_SECRET –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

// === –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===


/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞–±–ª–∏—Ü—ã.
 */
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê–∫—Ü–∏—è–º–∏')
    .addItem('‚úÖ 1. –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª', 'setupSheet')
    .addToUi();
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏—Å—Ç–∞.
 */
function setupSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME, 0);
  const ui = SpreadsheetApp.getUi();

  sheet.getRange(1, 1, 1, sheet.getMaxColumns()).clearDataValidations();
  sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]).setFontWeight("bold");
  sheet.setFrozenRows(1);

  const dateColumns = [RELEASE_DATE_COL, START_DATE_COL, END_DATE_COL];
  dateColumns.forEach(col => {
    sheet.getRange(2, col, sheet.getMaxRows() - 1, 1).setNumberFormat("dd.MM.yyyy");
  });

  const statusRange = sheet.getRange(2, STATUS_COL, sheet.getMaxRows() - 1, 1);
  const protection = statusRange.protect().setDescription('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
  const me = Session.getEffectiveUser();
  protection.addEditor(me);
  protection.removeEditors(protection.getEditors());
  if (protection.canDomainEdit()) {
    protection.setDomainEdit(false);
  }

  sheet.getRange(2, ACTION_COL, sheet.getMaxRows() - 1, 1)
    .setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList([ACTION_PUBLISH, ACTION_FINISH], true).build());
  sheet.getRange(2, START_DATE_COL, sheet.getMaxRows() - 1, 2)
    .setDataValidation(SpreadsheetApp.newDataValidation().requireDate().setAllowInvalid(false).build());

  sheet.clearConditionalFormatRules();
  const fullRange = `A2:I${sheet.getMaxRows()}`;
  const rules = [
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_PENDING}"`).setBackground(COLOR_PENDING).setRanges([sheet.getRange(fullRange)]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_ACTIVE}"`).setBackground(COLOR_ACTIVE).setRanges([sheet.getRange(fullRange)]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_FINISHED}"`).setBackground(COLOR_FINISHED).setRanges([sheet.getRange(fullRange)]).build()
  ];
  sheet.setConditionalFormatRules(rules);
  
  createTriggers();

  ui.alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', '–õ–∏—Å—Ç "–ê–∫—Ü–∏–∏" –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.', ui.ButtonSet.OK);
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏).
 */
function createTriggers() {
  ScriptApp.getProjectTriggers().forEach(trigger => ScriptApp.deleteTrigger(trigger));

  ScriptApp.newTrigger('onEditTrigger')
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onEdit()
    .create();

  ScriptApp.newTrigger('updateStatusesDaily')
    .timeBased()
    .everyDays(1)
    .atHour(1)
    .create();
}

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫.
 * @param {Object} e - –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è.
 */
function onEditTrigger(e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è e —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ –≤—ã—Ö–æ–¥–∏–º.
  if (!e || !e.range) {
    return;
  }

  const range = e.range;
  const sheet = range.getSheet();
  if (sheet.getName() !== SHEET_NAME || range.getRow() <= 1) return;

  const col = range.getColumn();
  const row = range.getRow();
  
  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ"
  if (col === TITLE_COL) {
    const titleValue = range.getValue();
    const releaseDateCell = sheet.getRange(row, RELEASE_DATE_COL);

    // –ï—Å–ª–∏ –≤ —è—á–µ–π–∫–µ –ø–æ—è–≤–∏–ª–æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –¥–∞—Ç–∞ –µ—â–µ –Ω–µ —Å—Ç–æ–∏—Ç - —Å—Ç–∞–≤–∏–º –¥–∞—Ç—É
    if (titleValue !== "" && releaseDateCell.isBlank()) {
      releaseDateCell.setValue(new Date());
    } 
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —è—á–µ–π–∫–∏ —É–¥–∞–ª–∏–ª–∏ - —Å—Ç–∏—Ä–∞–µ–º –¥–∞—Ç—É
    else if (titleValue === "") {
      releaseDateCell.clearContent();
    }
  }

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–î–µ–π—Å—Ç–≤–∏–µ"
  if (col === ACTION_COL) {
    const actionValue = range.getValue();
    if (actionValue === ACTION_PUBLISH) {
      handlePublish(sheet, row);
    } else if (actionValue === ACTION_FINISH) {
      handleFinish(sheet, row);
    }
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –Ω–∞ webhook –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
 * @param {Object} promotionData - –î–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å webhook_handler.py
 * @returns {boolean} - true –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, false –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
 */
function sendWebhookNotification(promotionData) {
  try {
    var payload = {
      action: 'publish',
      promotion: promotionData
    };
    
    var options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'X-Webhook-Secret': WEBHOOK_SECRET
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    var response = UrlFetchApp.fetch(WEBHOOK_URL, options);
    var responseCode = response.getResponseCode();
    var responseText = response.getContentText();
    
    Logger.log('Webhook response code: ' + responseCode);
    Logger.log('Webhook response: ' + responseText);
    
    if (responseCode === 200) {
      Logger.log('‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –∞–∫—Ü–∏–∏: ' + promotionData.title);
      return true;
    } else {
      Logger.log('‚ö†Ô∏è Webhook –≤–µ—Ä–Ω—É–ª –∫–æ–¥ –æ—à–∏–±–∫–∏: ' + responseCode);
      return false;
    }
  } catch (error) {
    Logger.log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ webhook: ' + error.toString());
    return false;
  }
}

/**
 * –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å".
 */
function handlePublish(sheet, row) {
  const ui = SpreadsheetApp.getUi();
  const rowValues = sheet.getRange(row, 1, 1, HEADERS.length).getValues()[0];

  const missingFields = [];
  if (!rowValues[TITLE_COL - 1]) missingFields.push(HEADERS[TITLE_COL - 1]);
  if (!rowValues[DESCRIPTION_COL - 1]) missingFields.push(HEADERS[DESCRIPTION_COL - 1]);
  if (!rowValues[START_DATE_COL - 1]) missingFields.push(HEADERS[START_DATE_COL - 1]);
  if (!rowValues[END_DATE_COL - 1]) missingFields.push(HEADERS[END_DATE_COL - 1]);

  if (missingFields.length > 0) {
    ui.alert('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', `–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- ${missingFields.join('\n- ')}`, ui.ButtonSet.OK);
    sheet.getRange(row, ACTION_COL).clearContent();
    return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const startDate = new Date(rowValues[START_DATE_COL - 1]);
  startDate.setHours(0,0,0,0);

  const statusCell = sheet.getRange(row, STATUS_COL);
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
  var finalStatus;
  if (startDate > today) {
    finalStatus = STATUS_PENDING;
  } else {
    finalStatus = STATUS_ACTIVE;
  }
  statusCell.setValue(finalStatus);
  
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º webhook –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"
  if (finalStatus === STATUS_ACTIVE) {
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ webhook
    var releaseDate = rowValues[RELEASE_DATE_COL - 1];
    var title = rowValues[TITLE_COL - 1];
    var description = rowValues[DESCRIPTION_COL - 1];
    var content = rowValues[CONTENT_COL - 1];
    var link = rowValues[LINK_COL - 1];
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
    var formattedReleaseDate = '';
    var formattedStartDate = '';
    var formattedEndDate = '';
    
    if (releaseDate instanceof Date) {
      formattedReleaseDate = Utilities.formatDate(releaseDate, Session.getScriptTimeZone(), 'dd.MM.yyyy HH:mm:ss');
    } else if (releaseDate) {
      formattedReleaseDate = String(releaseDate).trim();
    } else {
      // –ï—Å–ª–∏ –¥–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
      formattedReleaseDate = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'dd.MM.yyyy HH:mm:ss');
    }
    
    if (startDate instanceof Date) {
      formattedStartDate = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
    } else if (startDate) {
      formattedStartDate = String(startDate).trim();
    }
    
    var endDate = rowValues[END_DATE_COL - 1];
    if (endDate instanceof Date) {
      formattedEndDate = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
    } else if (endDate) {
      formattedEndDate = String(endDate).trim();
    }
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (–µ—Å–ª–∏ —ç—Ç–æ Google Drive —Å—Å—ã–ª–∫–∞)
    var convertedContent = content && content !== 'None' && content !== '' 
      ? convertImageUrl(content) 
      : null;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ü–∏–∏ –¥–ª—è webhook
    var promotionData = {
      title: String(title).trim(),
      description: description ? String(description).trim() : '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
      start_date: formattedStartDate,
      end_date: formattedEndDate,
      release_date: formattedReleaseDate,
      status: finalStatus  // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (convertedContent) {
      promotionData.content = convertedContent;
    } else if (content && content !== 'None' && content !== '') {
      promotionData.content = String(content).trim();
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (link && link !== 'None' && link !== '') {
      promotionData.link = String(link).trim();
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ webhook –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ê–∫—Ç–∏–≤–Ω–∞")
    sendWebhookNotification(promotionData);
  }
  
  sheet.getRange(row, ACTION_COL).clearContent();
}

/**
 * –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è "–ó–∞–≤–µ—Ä—à–∏—Ç—å".
 */
function handleFinish(sheet, row) {
  sheet.getRange(row, STATUS_COL).setValue(STATUS_FINISHED);
  sheet.getRange(row, ACTION_COL).clearContent();
}

/**
 * –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤.
 */
function updateStatusesDaily() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet || sheet.getLastRow() < 2) return;

  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADERS.length);
  const values = dataRange.getValues();
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  let changesMade = false;
  for (let i = 0; i < values.length; i++) {
    const status = values[i][STATUS_COL - 1];
    const startDate = values[i][START_DATE_COL - 1] ? new Date(values[i][START_DATE_COL - 1]) : null;
    const endDate = values[i][END_DATE_COL - 1] ? new Date(values[i][END_DATE_COL - 1]) : null;
    
    if (status === STATUS_ACTIVE && endDate && endDate < today) {
      values[i][STATUS_COL - 1] = STATUS_FINISHED;
      values[i][ACTION_COL - 1] = "";
      changesMade = true;
    } 
    else if (status === STATUS_PENDING && startDate && startDate <= today) {
      values[i][STATUS_COL - 1] = STATUS_ACTIVE;
      changesMade = true;
    }
  }

  if (changesMade) {
    dataRange.setValues(values);
  }
}

// ============================================================================
// –§–£–ù–ö–¶–ò–Ø –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò –°–°–´–õ–û–ö –ù–ê –ö–ê–†–¢–ò–ù–ö–ò
// ============================================================================

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫–∏ Google Drive –≤ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
 * –û–±—ã—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏ base64 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
 * 
 * –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã Google Drive:
 * - https://drive.google.com/file/d/ID/view?usp=sharing
 * - https://drive.google.com/file/d/ID/view
 * - https://drive.google.com/open?id=ID
 * - https://drive.google.com/uc?id=ID
 * - https://drive.google.com/uc?export=view&id=ID
 * 
 * @param {string} url - URL –∫–∞—Ä—Ç–∏–Ω–∫–∏ (Google Drive, –æ–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ base64)
 * @returns {string|null} - –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏–ª–∏ null
 */
function convertImageUrl(url) {
  // –ï—Å–ª–∏ URL –ø—É—Å—Ç–æ–π –∏–ª–∏ null
  if (!url || url === 'None' || url === '') {
    return null;
  }
  
  var urlStr = String(url).trim();
  
  // –ï—Å–ª–∏ —ç—Ç–æ base64 ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (urlStr.indexOf('data:image') === 0) {
    return urlStr;
  }
  
  // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è Google Drive —Å—Å—ã–ª–æ–∫
  var drivePatterns = [
    /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,      // /file/d/ID/
    /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,     // /open?id=ID
    /drive\.google\.com\/uc\?.*id=([a-zA-Z0-9_-]+)/,     // /uc?id=ID –∏–ª–∏ /uc?export=view&id=ID
    /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]+)/        // /uc?id=ID
  ];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
  for (var i = 0; i < drivePatterns.length; i++) {
    var match = urlStr.match(drivePatterns[i]);
    if (match && match[1]) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ googleusercontent
      // –≠—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±, —á–µ–º drive.google.com/uc?export=view
      return 'https://lh3.googleusercontent.com/d/' + match[1];
    }
  }
  
  // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ Google Drive ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–æ–±—ã—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞)
  return urlStr;
}

// ============================================================================
// API –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ê–ö–¢–ò–í–ù–´–• –ê–ö–¶–ò–ô (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
// ============================================================================

/**
 * Google Apps Script –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –∏–∑ Google Sheets.
 * 
 * –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ API –≤ Telegram Mini App.
 * 
 * @param {Object} e - –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è doGet)
 * @returns {TextOutput} JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
 */
function doGet(e) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // –ü–æ–ª—É—á–∞–µ–º –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏"
    var sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    // –ï—Å–ª–∏ –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
    if (!sheet) {
      sheet = spreadsheet.getActiveSheet();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    var data = sheet.getDataRange().getValues();
    
    // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (data.length < 2) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏)
    var rows = data.slice(1);
    var result = [];
    
    rows.forEach(function(row, rowIndex) {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º –∫–æ–ª–æ–Ω–æ–∫ (–∏–Ω–¥–µ–∫—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)
      var releaseDate = row[RELEASE_DATE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ A (–∏–Ω–¥–µ–∫—Å 0)
      var status = row[STATUS_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ D (–∏–Ω–¥–µ–∫—Å 3)
      var title = row[TITLE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ B (–∏–Ω–¥–µ–∫—Å 1)
      var description = row[DESCRIPTION_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ C (–∏–Ω–¥–µ–∫—Å 2)
      var startDate = row[START_DATE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ E (–∏–Ω–¥–µ–∫—Å 4)
      var endDate = row[END_DATE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ F (–∏–Ω–¥–µ–∫—Å 5)
      var content = row[CONTENT_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ G (–∏–Ω–¥–µ–∫—Å 6)
      var link = row[LINK_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ H (–∏–Ω–¥–µ–∫—Å 7)
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Ä–∞–≤–µ–Ω "–ê–∫—Ç–∏–≤–Ω–∞"
      if (status && String(status).trim() === STATUS_ACTIVE) {
        // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (!title || title === 'None' || title === '') {
          title = description ? '–ê–∫—Ü–∏—è ' + description : '–ê–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        var formattedReleaseDate = '';
        var formattedStartDate = '';
        var formattedEndDate = '';
        
        if (releaseDate instanceof Date) {
          formattedReleaseDate = Utilities.formatDate(releaseDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
        } else if (releaseDate) {
          formattedReleaseDate = String(releaseDate).trim();
        }
        
        if (startDate instanceof Date) {
          formattedStartDate = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
        } else if (startDate) {
          formattedStartDate = String(startDate).trim();
        }
        
        if (endDate instanceof Date) {
          formattedEndDate = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
        } else if (endDate) {
          formattedEndDate = String(endDate).trim();
        }
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        var uniqueId = (title + '_' + description + '_' + formattedStartDate + '_' + formattedEndDate)
          .replace(/\s+/g, '_')
          .replace(/:/g, '')
          .replace(/-/g, '');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å promotions_api.py
        var promotion = {
          'id': uniqueId,
          'title': String(title).trim(),
          'description': description ? String(description).trim() : '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
          'status': STATUS_ACTIVE,
          'release_date': formattedReleaseDate,
          'start_date': formattedStartDate,
          'end_date': formattedEndDate
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç (–∫–∞—Ä—Ç–∏–Ω–∫—É), –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Google Drive —Å—Å—ã–ª–∫–∏ –≤ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏
        if (content && content !== 'None' && content !== '') {
          var convertedContent = convertImageUrl(content);
          if (convertedContent) {
            promotion['content'] = convertedContent;
          }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if (link && link !== 'None' && link !== '') {
          promotion['link'] = String(link).trim();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ü–∏—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
        if (promotion['title'] && promotion['title'] !== 'None') {
          result.push(promotion);
        }
      }
    });
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ release_date (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º)
    result.sort(function(a, b) {
      var dateA = a.release_date ? new Date(a.release_date.split('.').reverse().join('-')) : new Date(0);
      var dateB = b.release_date ? new Date(b.release_date.split('.').reverse().join('-')) : new Date(0);
      return dateB - dateA; // –û—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
    });
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    // –í Google Apps Script CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ "Anyone" –¥–æ—Å—Ç—É–ø–∞
    return ContentService
      .createTextOutput(JSON.stringify(result, null, 2))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
    Logger.log('–û—à–∏–±–∫–∞ –≤ doGet: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.toString(),
        promotions: []
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã API.
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 */
function testGetPromotions() {
  var result = doGet({});
  Logger.log(result.getContent());
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏.
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 */
function testConvertImageUrl() {
  var testUrls = [
    'https://drive.google.com/file/d/1Mw89IfV3FlK0TGPJbFyPAdMFhqpp0Csl/view?usp=sharing',
    'https://drive.google.com/file/d/ABC123XYZ/view',
    'https://drive.google.com/open?id=ABC123XYZ',
    'https://drive.google.com/uc?id=ABC123XYZ',
    'https://drive.google.com/uc?export=view&id=ABC123XYZ',
    'https://example.com/image.jpg',
    'data:image/jpeg;base64,/9j/4AAQSkZJRg...',
    '',
    null
  ];
  
  testUrls.forEach(function(url) {
    var result = convertImageUrl(url);
    Logger.log('Input:  ' + url);
    Logger.log('Output: ' + result);
    Logger.log('---');
  });
}


================================================================================
FILE: ./PROJECT_SUMMARY.md
SIZE: 13979 bytes
================================================================================

# üìã Project Summary: –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –≤ MarketingBot

## üéØ –ß—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

### –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å **–∞–∫—Ü–∏–∏ –∏–∑ Google Sheets** –≤ **Telegram Mini App (WebApp)**. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å Mini App –∏ —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å–∏—Å—Ç–µ–º–µ –∞–∫—Ü–∏–π

1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ü–∏—è–º–∏ —á–µ—Ä–µ–∑ Google Sheets**
   - –ê–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ "–ê–∫—Ü–∏–∏" –≤ Google Sheets
   - –ö–æ–ª–æ–Ω–∫–∏: –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞, –ù–∞–∑–≤–∞–Ω–∏–µ, –û–ø–∏—Å–∞–Ω–∏–µ, –°—Ç–∞—Ç—É—Å, –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è, –ö–æ–Ω—Ç–µ–Ω—Ç
   - –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"

2. **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ü–∏–π –≤ Mini App**
   - –ê–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞" –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ (Mini App)
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App (`menu.html`) ‚Üí –≤–∏–¥–∏—Ç —Ä–∞–∑–¥–µ–ª "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è" ‚Üí –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
   - –ê–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–∞–∑–¥–µ–ª–∞

---

## üèóÔ∏è –ö–∞–∫ —ç—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mini App       ‚îÇ    ‚îÇ  Yandex Cloud VM ‚îÇ    ‚îÇ  Google Sheets   ‚îÇ
‚îÇ  (menu.html)    ‚îÇ    ‚îÇ  (158.160.0.127) ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ  GitHub Pages   ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ    ‚îÇ  ‚îÇ  –¢–∞–±–ª–∏—Ü–∞    ‚îÇ‚îÇ
‚îÇ  JavaScript     ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  ‚îÇ Flask API   ‚îÇ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ  ‚îÇ  "–ê–∫—Ü–∏–∏"    ‚îÇ‚îÇ
‚îÇ  fetch()        ‚îÇ    ‚îÇ  ‚îÇ /api/       ‚îÇ‚îÇ    ‚îÇ  ‚îÇ             ‚îÇ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ  ‚îÇ promotions  ‚îÇ‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                      ‚îÇ
         ‚îÇ                      ‚îÇ
         ‚îÇ                      ‚ñº
         ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ              ‚îÇ Cloudflare      ‚îÇ
         ‚îÇ              ‚îÇ Tunnel          ‚îÇ
         ‚îÇ              ‚îÇ (API Proxy)     ‚îÇ
         ‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ https://marketingbot.trycloudflare.com/api/promotions
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π

#### 1. **Google Sheets (–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö)**
- –¢–∞–±–ª–∏—Ü–∞ "–ê–∫—Ü–∏–∏" —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
  - –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞, –ù–∞–∑–≤–∞–Ω–∏–µ, –û–ø–∏—Å–∞–Ω–∏–µ, –°—Ç–∞—Ç—É—Å, –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è, –ö–æ–Ω—Ç–µ–Ω—Ç
- –ú–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Google Service Account –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ API

#### 2. **Backend API (Python)**
- **`promotions_api.py`** - —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏, –∫—ç—à–∏—Ä—É–µ—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç
- **`api/main.py`** –∏–ª–∏ **`webhook_handler.py`** - Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º `/api/promotions`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏

#### 3. **Frontend Mini App (JavaScript)**
- **`menu.html`** - –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å —Ä–∞–∑–¥–µ–ª–æ–º "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è"
- JavaScript –¥–µ–ª–∞–µ—Ç `fetch()` –∑–∞–ø—Ä–æ—Å –∫ `/api/promotions`
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º, –æ–ø–∏—Å–∞–Ω–∏–µ–º, –¥–∞—Ç–∞–º–∏

#### 4. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
- **Yandex Cloud VM** (158.160.0.127) - —Å–µ—Ä–≤–µ—Ä –¥–ª—è API
- **Cloudflare Tunnel** - —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API
- **GitHub Pages** - —Ö–æ—Å—Ç–∏–Ω–≥ –¥–ª—è Mini App

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏

#### –ö–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å:

1. **–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–∫—Ü–∏—é –≤ Google Sheets:**
   - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É "–ê–∫—Ü–∏–∏"
   - –ó–∞–ø–æ–ª–Ω—è–µ—Ç: –ù–∞–∑–≤–∞–Ω–∏–µ, –û–ø–∏—Å–∞–Ω–∏–µ, –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞/–æ–∫–æ–Ω—á–∞–Ω–∏—è
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"

2. **–ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ:**
   - `promotions_api.py` —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets —á–µ—Ä–µ–∑ API
   - –§–∏–ª—å—Ç—Ä—É–µ—Ç –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
   - –ö—ç—à–∏—Ä—É–µ—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

3. **API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ:**
   - Flask API –Ω–∞ `/api/promotions` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∞–∫—Ü–∏—è–º–∏
   - API —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `http://localhost:8080` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
   - Cloudflare Tunnel –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `https://marketingbot.trycloudflare.com/api/promotions`

4. **Mini App –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∞–∫—Ü–∏–∏:**
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App (`menu.html`)
   - JavaScript –¥–µ–ª–∞–µ—Ç `fetch()` –∑–∞–ø—Ä–æ—Å –∫ `/api/promotions`
   - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### –ü–æ—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π:
```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Mini App (menu.html)
2. JavaScript –¥–µ–ª–∞–µ—Ç fetch() –∑–∞–ø—Ä–æ—Å –∫ /api/promotions
3. –ó–∞–ø—Ä–æ—Å –∏–¥–µ—Ç —á–µ—Ä–µ–∑ Cloudflare Tunnel –Ω–∞ https://marketingbot.trycloudflare.com/api/promotions
4. Cloudflare Tunnel –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –Ω–∞ Yandex VM (localhost:8080)
5. Flask API –≤—ã–∑—ã–≤–∞–µ—Ç promotions_api.py
6. promotions_api.py —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets —á–µ—Ä–µ–∑ gspread
7. –§–∏–ª—å—Ç—Ä—É–µ—Ç –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
8. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON —Å –∞–∫—Ü–∏—è–º–∏
9. Mini App –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
```

#### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:
- **Python 3.x** - –¥–ª—è API —Å–µ—Ä–≤–µ—Ä–∞
- **Flask** - –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è REST API
- **gspread** - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è Google Sheets API
- **Google Service Account** - –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets
- **Cloudflare Tunnel (cloudflared)** - —Ç—É–Ω–Ω–µ–ª—å –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API
- **JavaScript (Vanilla)** - –¥–ª—è Mini App
- **GitHub Pages** - —Ö–æ—Å—Ç–∏–Ω–≥ –¥–ª—è Mini App

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å

#### 1. **DNS –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –¥–ª—è Cloudflare Tunnel** ‚ùå

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–∑–¥–∞–Ω –º–∞—Ä—à—Ä—É—Ç `marketingbot.trycloudflare.com` –≤ Cloudflare Dashboard
- –¢—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω (4 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
- –õ–æ–∫–∞–ª—å–Ω—ã–π API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8080/api/promotions`
- –ù–æ DNS –¥–ª—è `marketingbot.trycloudflare.com` –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è (NXDOMAIN)

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
```bash
nslookup marketingbot.trycloudflare.com 8.8.8.8
# Server can't find marketingbot.trycloudflare.com: NXDOMAIN
```

**–ü—Ä–∏—á–∏–Ω—ã:**
- –î–æ–º–µ–Ω `trycloudflare.com` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –¥–æ–º–µ–Ω Cloudflare –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- DNS –º–æ–∂–µ—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è—Ç—å—Å—è –¥–æ 30-60 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
- –í–æ–∑–º–æ–∂–Ω–æ, –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ Dashboard

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Cloudflare Dashboard
- –ü–æ–¥–æ–∂–¥–∞—Ç—å 30-60 –º–∏–Ω—É—Ç –¥–ª—è —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è DNS
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –¥–æ–º–µ–Ω –≤–º–µ—Å—Ç–æ `trycloudflare.com` (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)

#### 2. **–ê–∫—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ Mini App** ‚ö†Ô∏è

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –í Google Sheets –µ—Å—Ç—å 3 –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
- –õ–æ–∫–∞–ª—å–Ω—ã–π API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (`curl http://localhost:8080/api/promotions`)
- –ù–æ Mini App –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Failed to load promotions"

**–ü—Ä–∏—á–∏–Ω—ã:**
- Mini App –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ API –∏–∑-–∑–∞ DNS –ø—Ä–æ–±–ª–µ–º—ã
- `menu.html` –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å `https://marketingbot.trycloudflare.com/api/promotions`
- –ù–æ –¥–æ–º–µ–Ω –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è DNS –ø—Ä–æ–±–ª–µ–º—ã –∞–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –≤ `menu.html` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

#### 3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** ‚úÖ (–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ß–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Google Sheets API –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ª–∏–º–∏—Ç–∞–º
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç –≤ `promotions_api.py`
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∑–∞–ø—Ä–æ—Å—ã –∫ Google Sheets

### –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|-----------|--------|--------|
| Google Sheets (—Ç–∞–±–ª–∏—Ü–∞ "–ê–∫—Ü–∏–∏") | ‚úÖ 100% | 3 –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏, –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã |
| Backend API (promotions_api.py) | ‚úÖ 100% | –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| –õ–æ–∫–∞–ª—å–Ω—ã–π API (/api/promotions) | ‚úÖ 100% | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 3 –∞–∫—Ü–∏–∏, HTTP 200 OK |
| Cloudflare Tunnel | ‚úÖ 100% | 4 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è |
| –ú–∞—Ä—à—Ä—É—Ç –≤ Dashboard | ‚úÖ 100% | –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ |
| DNS Resolution | ‚ùå 0% | NXDOMAIN - –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è |
| Mini App (–∫–æ–¥ menu.html) | ‚úÖ 100% | –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞ |
| Mini App (–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö) | ‚ö†Ô∏è 50% | –ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑-–∑–∞ DNS |

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%

1. ‚úÖ **Google Sheets** - —Ç–∞–±–ª–∏—Ü–∞ "–ê–∫—Ü–∏–∏" —Å–æ–¥–µ—Ä–∂–∏—Ç 3 –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏
2. ‚úÖ **Backend API** - `promotions_api.py` —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –∫—ç—à–∏—Ä—É–µ—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç
3. ‚úÖ **–õ–æ–∫–∞–ª—å–Ω—ã–π API** - `http://localhost:8080/api/promotions` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. ‚úÖ **Cloudflare Tunnel** - –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω, —Ç—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç
5. ‚úÖ **Mini App –∫–æ–¥** - `menu.html` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∞

### –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. ‚ùå **DNS –¥–ª—è `marketingbot.trycloudflare.com`** - –Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è (NXDOMAIN)
2. ‚ö†Ô∏è **–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ü–∏–π –≤ Mini App** - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ DNS –ø—Ä–æ–±–ª–µ–º—ã (Mini App –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ API)

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –≤ Cloudflare Dashboard:**
   - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –º–∞—Ä—à—Ä—É—Ç `marketingbot.trycloudflare.com`
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å —Ç–µ–º–∏ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
   - –ü–æ–¥–æ–∂–¥–∞—Ç—å 10-15 –º–∏–Ω—É—Ç

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å DNS:**
   ```bash
   nslookup marketingbot.trycloudflare.com 8.8.8.8
   ```

3. **–ö–æ–≥–¥–∞ DNS —Ä–∞–∑—Ä–µ—à–∏—Ç—Å—è:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API: `curl https://marketingbot.trycloudflare.com/api/promotions`
   - –û—Ç–∫—Ä—ã—Ç—å Mini App –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∞–∫—Ü–∏–π

4. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –¥–æ–º–µ–Ω –≤ Cloudflare –≤–º–µ—Å—Ç–æ `trycloudflare.com`
   - –û–±–Ω–æ–≤–∏—Ç—å `menu.html` —Å –Ω–æ–≤—ã–º URL

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets –¥–ª—è —á—Ç–µ–Ω–∏—è –∞–∫—Ü–∏–π
- ‚úÖ –°–æ–∑–¥–∞–Ω API —ç–Ω–¥–ø–æ–∏–Ω—Ç `/api/promotions` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ä–∞–∑–¥–µ–ª "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è" –≤ Mini App (`menu.html`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω Cloudflare Tunnel –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ API
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ Mini App

### –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å —Ä–µ—à–∏—Ç—å:
- ‚ùå DNS –ø—Ä–æ–±–ª–µ–º–∞ –¥–ª—è Cloudflare Tunnel –¥–æ–º–µ–Ω–∞ (`marketingbot.trycloudflare.com`)
- ‚ö†Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ü–∏–π –≤ Mini App (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç DNS)

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
–ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è DNS –ø—Ä–æ–±–ª–µ–º—ã:
- ‚úÖ Mini App —Å–º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏ –∏–∑ API
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç 3 –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è"
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 6 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** üü° –í –ø—Ä–æ—Ü–µ—Å—Å–µ (–æ–∂–∏–¥–∞–Ω–∏–µ DNS)


================================================================================
FILE: ./README.md
SIZE: 7271 bytes
================================================================================

# üöÄ MarketingBot ‚Äî –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Telegram-–±–æ—Ç

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Telegram-–±–æ—Ç –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ —Å –≤–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Google Sheets. –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º.

## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- **ü§ñ Telegram-–±–æ—Ç** —Å –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –Ω–∞ Python.
- **üåê WebApp-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞.
- **üìä –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏.
- **üîê –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ —á–µ—Ä–µ–∑ WebApp.
- **üß† –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** –Ω–∞ –±–∞–∑–µ OpenAI –¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
- **üìã –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.
- **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤** –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞.
- **üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π** —á–µ—Ä–µ–∑ GitHub Actions.
- **üîß –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.
### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: WebApp (Mini App) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
marketingbot/
‚îú‚îÄ‚îÄ ü§ñ bot.py                  # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞
‚îú‚îÄ‚îÄ üéØ handlers.py             # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ üîê auth_service.py         # –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ üìä sheets.py               # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets
‚îú‚îÄ‚îÄ ü§ñ appeals_service.py       # –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ üß† openai_service.py       # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI
‚îú‚îÄ‚îÄ üìä response_monitor.py     # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤
‚îú‚îÄ‚îÄ üìä promotions_api.py        # API –¥–ª—è –∞–∫—Ü–∏–π
‚îú‚îÄ‚îÄ üåê index.html              # WebApp –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ üåê menu.html               # WebApp –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
‚îú‚îÄ‚îÄ üåê app.js                  # JavaScript –¥–ª—è WebApp
‚îú‚îÄ‚îÄ üìö docs/                   # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
‚îÇ   ‚îú‚îÄ‚îÄ getting-started/       # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
‚îÇ   ‚îú‚îÄ‚îÄ deployment/            # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ guides/                # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
‚îÇ   ‚îú‚îÄ‚îÄ troubleshooting/       # –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
‚îÇ   ‚îî‚îÄ‚îÄ reference/             # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
‚îú‚îÄ‚îÄ üîß scripts/                # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
‚îú‚îÄ‚îÄ üîÑ .github/workflows/      # GitHub Actions
‚îú‚îÄ‚îÄ requirements.txt            # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ .env.example               # –ü—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ README.md                  # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1.  **–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
    ```bash
    pip install -r requirements.txt
    ```

2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ `.env`:**
    ```bash
    cp .env.example .env
    # –£–∫–∞–∂–∏—Ç–µ –≤–∞—à TELEGRAM_TOKEN
    nano .env
    ```

3.  **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
    ```bash
    python3 bot.py
    ```

4.  **–î–µ–ø–ª–æ–π WebApp:**
    - –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ GitHub Pages –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—à—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫—É `main`
    - –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ [`docs/WEBAPP_DEPLOY.md`](./docs/WEBAPP_DEPLOY.md).

    –ü–æ–¥—Ä–æ–±–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –¥–æ—Å—Ç—É–ø–Ω—ã –≤ [`docs/DEPLOYMENT.md`](./docs/DEPLOYMENT.md).

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–í—Å—è –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ [`docs`](./docs/). –ù–∞—á–Ω–∏—Ç–µ —Å [README –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](./docs/README.md) –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.

### –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø

- **[üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](./docs/getting-started/INSTALLATION.md)** - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- **[üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](./docs/ARCHITECTURE.md)** - –û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –ø–æ—Ç–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **[üö¢ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](./docs/deployment/DEPLOYMENT_YANDEX.md)** - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- **[üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](./docs/troubleshooting/TROUBLESHOOTING.md)** - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫
- **[üì° API –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫](./docs/reference/API_REFERENCE.md)** - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è REST API
- **[üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π](./docs/CHANGELOG.md)** - –õ–æ–≥ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### üß∞ Dev-tools

–í –∫–∞—Ç–∞–ª–æ–≥–µ `docs/tools/` –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã –∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

- `debug_telegram_auth.js` ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö WebApp
- `telegram_webapp_debug.py` ‚Äî –ø–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ—Ç–æ–∫–∞ Mini App ‚Üí –±–æ—Ç
- `fetch_sheets.py` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –∏ —Å–≤–æ–¥–∫–∞ Google Sheets (read-only)

–≠—Ç–∏ —Ñ–∞–π–ª—ã –Ω–µ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Ä–∞–±–æ—Ç–µ –ø—Ä–æ–¥–∞–∫—à–µ–Ω-–±–æ—Ç–∞, –∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.

### üõ†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Mini App

- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: –¢–µ–ø–µ—Ä—å Mini App –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `KeyboardButton` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –º–µ—Ç–æ–¥–∞ `Telegram.WebApp.sendData()`.
- **–î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö**: –ë–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ Mini App, –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ Google Sheets.
- **–£–ª—É—á—à–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è `initData` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.

### üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

1. **–û–±–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞**:
    - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `KeyboardButton` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Mini App.
    - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `web_app_data` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ WebApp**:
    - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Mini App —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ HTTPS (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages).
    - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É Mini App –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.

3. **–û–±–Ω–æ–≤–∏—Ç–µ Google Sheets**:
    - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.
    - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

================================================================================
FILE: ./TESTING_GUIDE.md
SIZE: 6315 bytes
================================================================================

# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã

## –®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –í –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
python3.10 init_db.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–î: sqlite:///./db/appeals.db
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!
–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:
  - appeals (–æ–±—Ä–∞—â–µ–Ω–∏—è)
  - appeal_messages (—Å–æ–æ–±—â–µ–Ω–∏—è)
  - specialist_responses (–æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤)
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
ls -la db/appeals.db
# –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è —Ñ–∞–π–ª db/appeals.db
```

---

## –®–∞–≥ 2: –ó–∞–ø—É—Å–∫ REST API

–í **–æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ**:

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
pip3.10 install --user fastapi uvicorn sqlalchemy pydantic

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ API
cd /Users/verakoroleva/Desktop/marketingbot
python3.10 -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     Started reloader process
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8000/docs

–î–æ–ª–∂–Ω–∞ –æ—Ç–∫—Ä—ã—Ç—å—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Swagger API.

---

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `admin/app.js` –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä–æ–∫—É:

```javascript
const API_BASE_URL = window.location.origin + '/api';
```

**–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è** –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞:

```javascript
const API_BASE_URL = 'http://localhost:8000/api';
```

---

## –®–∞–≥ 4: –ó–∞–ø—É—Å–∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

### –í–∞—Ä–∏–∞–Ω—Ç A: –ß–µ—Ä–µ–∑ PythonAnywhere (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–∞–ø–∫—É `admin/` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Static files –≤ PythonAnywhere:
   - Web ‚Üí Static files
   - URL: `/admin/`
   - Directory: `/home/yourusername/marketingbot/admin/`
3. –û—Ç–∫—Ä–æ–π—Ç–µ: `https://yourusername.pythonanywhere.com/admin/`

### –í–∞—Ä–∏–∞–Ω—Ç B: –õ–æ–∫–∞–ª—å–Ω–æ (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±)

```bash
# –í –ø–∞–ø–∫–µ admin/
cd admin
python3.10 -m http.server 8080
```

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8080

---

## –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –í–≤–µ–¥–∏—Ç–µ:
   - **–õ–æ–≥–∏–Ω:** `admin`
   - **–ü–∞—Ä–æ–ª—å:** `admin`
3. –ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏"

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—á–µ–∑–∞–µ—Ç
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π)

---

## –®–∞–≥ 6: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è

### –ß–µ—Ä–µ–∑ API (–¥–ª—è —Ç–µ—Å—Ç–∞):

```bash
curl -X POST "http://localhost:8000/api/appeals/" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": 123456789,
    "partner_code": "TEST001",
    "phone": "+79991234567",
    "fio": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "status": "–Ω–æ–≤–æ–µ"
  }'
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Swagger UI: http://localhost:8000/docs

1. –ù–∞–π–¥–∏—Ç–µ endpoint `POST /api/appeals/`
2. –ù–∞–∂–º–∏—Ç–µ "Try it out"
3. –í—Å—Ç–∞–≤—å—Ç–µ JSON –≤—ã—à–µ
4. –ù–∞–∂–º–∏—Ç–µ "Execute"

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```bash
curl -X POST "http://localhost:8000/api/appeals/1/messages" \
  -H "Content-Type: application/json" \
  -d '{
    "message_type": "user",
    "message_text": "–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!"
  }'
```

---

## –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

1. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (F5)
2. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –Ω–µ–≥–æ
4. –î–æ–ª–∂–Ω—ã –æ—Ç–∫—Ä—ã—Ç—å—Å—è –¥–µ—Ç–∞–ª–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º

---

## –®–∞–≥ 8: –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞

1. –í –¥–µ—Ç–∞–ª—è—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
2. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç"
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
4. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ë–î

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
sqlite3 db/appeals.db "SELECT * FROM appeals;"

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
sqlite3 db/appeals.db "SELECT * FROM appeal_messages;"
```

---

## ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. API –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
```bash
pip3.10 install --user -r requirements.txt
```

### 2. CORS –æ—à–∏–±–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
**–†–µ—à–µ–Ω–∏–µ:** –í `api/main.py` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω CORS –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

### 3. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ API
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `API_BASE_URL` –≤ `admin/app.js`

### 4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ `db/` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
```bash
mkdir -p db
python3.10 init_db.py
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (`db/appeals.db` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- [ ] API –∑–∞–ø—É—â–µ–Ω (http://localhost:8000/docs –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è)
- [ ] –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å)
- [ ] –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (–¥–∞–∂–µ –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π)
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
- [ ] –¢–µ—Å—Ç–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
- [ ] –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
- [ ] –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç

---

**–ì–æ—Ç–æ–≤–æ!** –ï—Å–ª–∏ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ


================================================================================
FILE: ./analyze_new_sheet.py
SIZE: 6243 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–æ–≤–æ–π Google Sheets —Ç–∞–±–ª–∏—Ü—ã —Å –ª–∏—Å—Ç–æ–º "–û–±—Ä–∞—â–µ–Ω–∏—è".
"""

import os
from dotenv import load_dotenv
from sheets import _load_service_account, SheetsNotConfiguredError

def analyze_new_spreadsheet():
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É —Å –ª–∏—Å—Ç–æ–º '–û–±—Ä–∞—â–µ–Ω–∏—è'."""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º .env
        load_dotenv()
        
        # –í—Ä–µ–º–µ–Ω–Ω–æ –º–µ–Ω—è–µ–º SHEET_ID
        old_sheet_id = os.environ.get('SHEET_ID')
        os.environ['SHEET_ID'] = '15XxSIpD_gMZaSOIrqDVCNI2EqBzphEGiG0ZNJ3HR8hI'
        
        try:
            import gspread
            from google.oauth2.service_account import Credentials
            
            sa_info = _load_service_account()
            scopes = [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive'
            ]
            
            creds = Credentials.from_service_account_info(sa_info, scopes=scopes)
            client = gspread.authorize(creds)
            
            sheet_id = os.environ.get('SHEET_ID')
            spreadsheet = client.open_by_key(sheet_id)
            
            print(f"üìä –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã: {spreadsheet.title}")
            print(f"üîó ID —Ç–∞–±–ª–∏—Ü—ã: {spreadsheet.id}")
            print(f"üìã URL: https://docs.google.com/spreadsheets/d/{spreadsheet.id}")
            print("=" * 80)
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã
            worksheets = spreadsheet.worksheets()
            print(f"üìÑ –ù–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç–æ–≤: {len(worksheets)}")
            print()
            
            for i, worksheet in enumerate(worksheets, 1):
                print(f"üìù –õ–∏—Å—Ç {i}: '{worksheet.title}'")
                print(f"   –†–∞–∑–º–µ—Ä: {worksheet.row_count} —Å—Ç—Ä–æ–∫ √ó {worksheet.col_count} –∫–æ–ª–æ–Ω–æ–∫")
                
                try:
                    # –ß–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
                    headers = worksheet.row_values(1)
                    print(f"   –ó–∞–≥–æ–ª–æ–≤–∫–∏ ({len(headers)}): {headers}")
                    
                    # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                    if worksheet.row_count > 1:
                        print("   –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö:")
                        for row_num in range(2, min(5, worksheet.row_count + 1)):
                            row_data = worksheet.row_values(row_num)
                            print(f"     –°—Ç—Ä–æ–∫–∞ {row_num}: {row_data}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                    key_columns = []
                    for header in headers:
                        header_lower = header.lower()
                        if any(keyword in header_lower for keyword in ['–∫–æ–¥', 'code', '—Ç–µ–ª–µ—Ñ–æ–Ω', 'phone', '—Å—Ç–∞—Ç—É—Å', 'status', 'telegram', '–¥–∞—Ç–∞', 'date', '–æ–±—Ä–∞—â–µ–Ω–∏–µ', 'appeal', '—Å–æ–æ–±—â–µ–Ω–∏–µ', 'message']):
                            key_columns.append(header)
                    
                    if key_columns:
                        print(f"   üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {key_columns}")
                    
                except Exception as e:
                    print(f"   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
                
                print("-" * 60)
            
            # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Å—Ç–∞ "–û–±—Ä–∞—â–µ–Ω–∏—è"
            print("\nüîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Å—Ç–∞ '–û–±—Ä–∞—â–µ–Ω–∏—è':")
            try:
                appeals_sheet = None
                for worksheet in worksheets:
                    if '–æ–±—Ä–∞—â–µ–Ω–∏—è' in worksheet.title.lower() or 'appeals' in worksheet.title.lower():
                        appeals_sheet = worksheet
                        break
                
                if appeals_sheet:
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ª–∏—Å—Ç: '{appeals_sheet.title}'")
                    
                    # –ß–∏—Ç–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    all_data = appeals_sheet.get_all_records()
                    print(f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(all_data)}")
                    
                    if all_data:
                        print("\nüìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:")
                        for i, record in enumerate(all_data[:3], 1):  # –ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏
                            print(f"   –ó–∞–ø–∏—Å—å {i}:")
                            for key, value in record.items():
                                print(f"     {key}: {value}")
                            print()
                    
                    # –ê–Ω–∞–ª–∏–∑ –∫–æ–ª–æ–Ω–æ–∫
                    if all_data:
                        headers = list(all_data[0].keys())
                        print(f"üìù –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ ({len(headers)}):")
                        for i, header in enumerate(headers, 1):
                            print(f"   {i:2d}. {header}")
                    
                else:
                    print("‚ùå –õ–∏—Å—Ç '–û–±—Ä–∞—â–µ–Ω–∏—è' –Ω–µ –Ω–∞–π–¥–µ–Ω")
                    print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–∏—Å—Ç—ã:")
                    for worksheet in worksheets:
                        print(f"   - {worksheet.title}")
                        
            except Exception as e:
                print(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ª–∏—Å—Ç–∞ '–û–±—Ä–∞—â–µ–Ω–∏—è': {e}")
                
        finally:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π SHEET_ID
            if old_sheet_id:
                os.environ['SHEET_ID'] = old_sheet_id
            else:
                os.environ.pop('SHEET_ID', None)
                
    except SheetsNotConfiguredError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google Sheets: {e}")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env –∑–∞–¥–∞–Ω—ã GCP_SA_JSON –∏–ª–∏ GCP_SA_FILE")
    except Exception as e:
        print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    analyze_new_spreadsheet()


================================================================================
FILE: ./analyze_sheets.py
SIZE: 5090 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Google Sheets —Ç–∞–±–ª–∏—Ü—ã.
–ß–∏—Ç–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –≤—Å–µ—Ö –ª–∏—Å—Ç–æ–≤.
"""

from dotenv import load_dotenv
from sheets import _get_client_and_sheet, SheetsNotConfiguredError

def analyze_spreadsheet():
    """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã –∏ –≤—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª–∏—Å—Ç–∞—Ö."""
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º .env
        load_dotenv()
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–ª–∏–µ–Ω—Ç –∏ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
        client, main_worksheet = _get_client_and_sheet()
        spreadsheet = main_worksheet.spreadsheet
        
        print(f"üìä –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü—ã: {spreadsheet.title}")
        print(f"üîó ID —Ç–∞–±–ª–∏—Ü—ã: {spreadsheet.id}")
        print(f"üìã URL: https://docs.google.com/spreadsheets/d/{spreadsheet.id}")
        print("=" * 80)
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã
        worksheets = spreadsheet.worksheets()
        print(f"üìÑ –ù–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç–æ–≤: {len(worksheets)}")
        print()
        
        for i, worksheet in enumerate(worksheets, 1):
            print(f"üìù –õ–∏—Å—Ç {i}: '{worksheet.title}'")
            print(f"   –†–∞–∑–º–µ—Ä: {worksheet.row_count} —Å—Ç—Ä–æ–∫ √ó {worksheet.col_count} –∫–æ–ª–æ–Ω–æ–∫")
            
            try:
                # –ß–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
                headers = worksheet.row_values(1)
                print(f"   –ó–∞–≥–æ–ª–æ–≤–∫–∏ ({len(headers)}): {headers}")
                
                # –ß–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                if worksheet.row_count > 1:
                    print("   –ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö:")
                    for row_num in range(2, min(5, worksheet.row_count + 1)):
                        row_data = worksheet.row_values(row_num)
                        print(f"     –°—Ç—Ä–æ–∫–∞ {row_num}: {row_data}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                key_columns = []
                for header in headers:
                    header_lower = header.lower()
                    if any(keyword in header_lower for keyword in ['–∫–æ–¥', 'code', '—Ç–µ–ª–µ—Ñ–æ–Ω', 'phone', '—Å—Ç–∞—Ç—É—Å', 'status', 'telegram', '–¥–∞—Ç–∞', 'date']):
                        key_columns.append(header)
                
                if key_columns:
                    print(f"   üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏: {key_columns}")
                
            except Exception as e:
                print(f"   ‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ª–∏—Å—Ç–∞: {e}")
            
            print("-" * 60)
        
        # –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Å—Ç–∞ "–û–±—Ä–∞—â–µ–Ω–∏—è"
        print("\nüîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ª–∏—Å—Ç–∞ '–û–±—Ä–∞—â–µ–Ω–∏—è':")
        try:
            appeals_sheet = None
            for worksheet in worksheets:
                if '–æ–±—Ä–∞—â–µ–Ω–∏—è' in worksheet.title.lower() or 'appeals' in worksheet.title.lower():
                    appeals_sheet = worksheet
                    break
            
            if appeals_sheet:
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ª–∏—Å—Ç: '{appeals_sheet.title}'")
                
                # –ß–∏—Ç–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                all_data = appeals_sheet.get_all_records()
                print(f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(all_data)}")
                
                if all_data:
                    print("\nüìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:")
                    for i, record in enumerate(all_data[:3], 1):  # –ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏
                        print(f"   –ó–∞–ø–∏—Å—å {i}:")
                        for key, value in record.items():
                            print(f"     {key}: {value}")
                        print()
                
                # –ê–Ω–∞–ª–∏–∑ –∫–æ–ª–æ–Ω–æ–∫
                if all_data:
                    headers = list(all_data[0].keys())
                    print(f"üìù –í—Å–µ –∫–æ–ª–æ–Ω–∫–∏ ({len(headers)}):")
                    for i, header in enumerate(headers, 1):
                        print(f"   {i:2d}. {header}")
                
            else:
                print("‚ùå –õ–∏—Å—Ç '–û–±—Ä–∞—â–µ–Ω–∏—è' –Ω–µ –Ω–∞–π–¥–µ–Ω")
                print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–∏—Å—Ç—ã:")
                for worksheet in worksheets:
                    print(f"   - {worksheet.title}")
                    
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ª–∏—Å—Ç–∞ '–û–±—Ä–∞—â–µ–Ω–∏—è': {e}")
            
    except SheetsNotConfiguredError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google Sheets: {e}")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ .env –∑–∞–¥–∞–Ω—ã SHEET_ID, GCP_SA_JSON –∏–ª–∏ GCP_SA_FILE")
    except Exception as e:
        print(f"‚ùå –û–±—â–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    analyze_spreadsheet()


================================================================================
FILE: ./api_wsgi.py
SIZE: 1272 bytes
================================================================================

"""
WSGI —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ FastAPI –Ω–∞ PythonAnywhere.
FastAPI —Ç—Ä–µ–±—É–µ—Ç ASGI, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–µ—Ä.
"""
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
path = '/home/SynthosAI/marketing'
if path not in sys.path:
    sys.path.insert(0, path)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ.setdefault('DATABASE_URL', 'sqlite:///./db/appeals.db')

# –ú–µ–Ω—è–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
os.chdir(path)

try:
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    from api.main import app
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º ASGI-to-WSGI –∞–¥–∞–ø—Ç–µ—Ä
    from asgiref.wsgi import WsgiToAsgi
    
    # –û–±–µ—Ä—Ç—ã–≤–∞–µ–º FastAPI app –≤ WSGI –∞–¥–∞–ø—Ç–µ—Ä
    application = WsgiToAsgi(app)
    
except ImportError as e:
    # –ï—Å–ª–∏ –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    # –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip3.10 install --user asgiref
    def application(environ, start_response):
        start_response('500 Internal Server Error', [('Content-Type', 'text/plain')])
        return [f'Error: {str(e)}\nPlease install asgiref: pip3.10 install --user asgiref'.encode()]


================================================================================
FILE: ./app.js
SIZE: 5298 bytes
================================================================================

document.addEventListener('DOMContentLoaded', function () {
  // Initialize Telegram Web App
  if (window.Telegram && window.Telegram.WebApp) {
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    
    console.log('üîç Telegram Web App initialized:', tg);
    console.log('üîç MainButton available:', !!tg.MainButton);
    
    // Set theme colors
    document.body.style.backgroundColor = tg.themeParams.bg_color || '#ffffff';
    document.body.style.color = tg.themeParams.text_color || '#000000';
    
    // Try to setup MainButton as additional option
    try {
      tg.MainButton.setText('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
      tg.MainButton.show();
      tg.MainButton.onClick(doAuth);
      console.log('üîç MainButton configured as additional option');
    } catch (e) {
      console.log('‚ùå MainButton setup failed:', e);
    }

    // Setup keyboard button for input fields
    try {
      // Show keyboard button when user focuses on input fields
      const codeInput = document.getElementById('partner_code');
      const phoneInput = document.getElementById('partner_phone');
      
      if (codeInput && phoneInput) {
        const updateMainButton = () => {
          const code = codeInput.value.trim();
          const phone = phoneInput.value.trim();
          
          if (tg.MainButton) {
            if (code && phone) {
              tg.MainButton.setText('–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
              tg.MainButton.show();
              tg.MainButton.enable();
            } else {
              tg.MainButton.setText('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');
              tg.MainButton.show();
              tg.MainButton.disable();
            }
          }
        };
        
        // Show/update button on focus and input
        codeInput.addEventListener('focus', updateMainButton);
        phoneInput.addEventListener('focus', updateMainButton);
        codeInput.addEventListener('input', updateMainButton);
        phoneInput.addEventListener('input', updateMainButton);
        
        // Initial check
        updateMainButton();
        
        console.log('üîç Smart keyboard button setup for input fields');
      }
    } catch (e) {
      console.log('‚ùå Keyboard button setup failed:', e);
    }
  } else {
    console.log('‚ùå Telegram Web App not available');
  }

  const msg = document.getElementById('msg')

  function setMessage(text, isError) {
    msg.textContent = text
    msg.style.color = isError ? 'crimson' : 'green'
  }

  // Function to normalize phone number and check if complete
  function normalizePhone(phone) {
    const digits = phone.replace(/\D/g, ''); // Remove non-digits
    return digits;
  }

  function isPhoneComplete(phone) {
    const digits = normalizePhone(phone);
    return digits.length >= 11; // Russian phone number
  }

  async function doAuth() {
    console.log('üöÄ doAuth function called');
    
    const codeEl = document.getElementById('partner_code')
    const phoneEl = document.getElementById('partner_phone')
    const code = codeEl.value.trim()
    const phone = phoneEl.value.trim()

    console.log('üîç –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é:', { code, phone })

    if (!/^[0-9]{1,20}$/.test(code)) {
      setMessage('–ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã (1-20)', true)
      return
    }
    if (!phone) {
      setMessage('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω', true)
      return
    }

    // initData from Telegram Web App (when opened inside Telegram). If not present, still allow for local testing.
    const initData = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) || ''

    // Show loader on MainButton
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.MainButton.showProgress();
    }
    setMessage('–ü—Ä–æ–≤–µ—Ä—è—é...', false)

    try {
      // Use Telegram Web App sendData for keyboard button
      if (window.Telegram && window.Telegram.WebApp) {
        const dataToSend = JSON.stringify({
          partner_code: code,
          partner_phone: phone
        })
        
        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sendData:', dataToSend)
        window.Telegram.WebApp.sendData(dataToSend)
        setMessage('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –±–æ—Ç—É...', false)
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
        setTimeout(() => {
          window.Telegram.WebApp.close();
        }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race condition
      } else {
        setMessage('–û—à–∏–±–∫–∞: Telegram Web App –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', true)
      }
    } catch (e) {
      setMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message, true)
      console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
    } finally {
      // Hide loader on MainButton
      if (window.Telegram && window.Telegram.WebApp) {
        window.Telegram.WebApp.MainButton.hideProgress();
      }
    }
  }

  // Bind explicit button for reply action
  const authBtn = document.getElementById('auth-btn')
  if (authBtn) {
    authBtn.addEventListener('click', doAuth)
  }
})


================================================================================
FILE: ./appeals_service.py
SIZE: 42372 bytes
================================================================================

"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –≤ Google Sheets.
–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ª–∏—Å—Ç–∞ '–æ–±—Ä–∞—â–µ–Ω–∏—è'.
"""

import logging
import datetime
from typing import Optional, List, Dict
from sheets_gateway import (
    _get_appeals_client_and_sheet,
    SheetsNotConfiguredError,
    AsyncGoogleSheetsGateway,
    CircuitBreakerOpenError
)

logger = logging.getLogger(__name__)


class AppealsService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –≤ –ª–∏—Å—Ç–µ '–æ–±—Ä–∞—â–µ–Ω–∏—è'."""
    
    def __init__(self, gateway: Optional[AsyncGoogleSheetsGateway] = None):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
        self.worksheet = None
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gateway
        if gateway is None:
            self.gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='appeals')
        else:
            self.gateway = gateway
        
        try:
            client, worksheet = _get_appeals_client_and_sheet()
            self.worksheet = worksheet
            
            if not self.worksheet:
                logger.critical("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ç–∞–±–ª–∏—Ü–µ –æ–±—Ä–∞—â–µ–Ω–∏–π")
            else:
                logger.info(f"–õ–∏—Å—Ç '–æ–±—Ä–∞—â–µ–Ω–∏—è' –Ω–∞–π–¥–µ–Ω: {self.worksheet.title}")
                
        except SheetsNotConfiguredError as e:
            logger.critical(f"Sheets –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω: {e}")
        except Exception as e:
            logger.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª–∏—Å—Ç—É '–æ–±—Ä–∞—â–µ–Ω–∏—è': {e}")

    def is_available(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
        return self.worksheet is not None and self.gateway is not None

    async def create_appeal(self, code: str, phone: str, fio: str, telegram_id: int, text: str) -> bool:
        """
        –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ª–∏—Å—Ç–µ (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ).
        
        Args:
            code: –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            phone: —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            fio: –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            text: —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è telegram_id={telegram_id}, code={code}, phone={phone}, fio={fio}")
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(records)} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π")
            existing_row = None
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                # –ò—â–µ–º telegram_id –≤ –∫–æ–ª–æ–Ω–∫–µ D (–∏–Ω–¥–µ–∫—Å 3 –≤ –º–∞—Å—Å–∏–≤–µ)
                record_telegram_id = str(record.get('telegram_id', ''))
                logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ {i}: telegram_id='{record_telegram_id}' vs '{telegram_id}'")
                if record_telegram_id == str(telegram_id):
                    existing_row = i
                    logger.info(f"–ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ {i} –¥–ª—è telegram_id {telegram_id}")
                    break
            
            timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            new_appeal = f"{timestamp}: {text}"
            
            if existing_row:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É - –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ
                cell = await self.gateway.cell(self.worksheet, existing_row, 5)
                current_appeals = cell.value or ""  # –∫–æ–ª–æ–Ω–∫–∞ E
                
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö—É
                if current_appeals.strip():
                    updated_appeals = f"{new_appeal}\n{current_appeals}"
                else:
                    updated_appeals = new_appeal
                
                # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è (>30 –¥–Ω–µ–π)
                updated_appeals = self._cleanup_old_appeals(updated_appeals)
                # –£—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥ –ª–∏–º–∏—Ç Google Sheets
                updated_appeals = self._truncate_to_gs_limit(updated_appeals)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –∏ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ batch_update
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'E{existing_row}',
                    'values': [[updated_appeals]]
                }, {
                    'range': f'H{existing_row}',
                    'values': [[timestamp]]
                }])
                
                logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
            else:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
                next_row = len(records) + 2  # +2 –ø–æ—Ç–æ–º—É —á—Ç–æ records –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫
                logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ {next_row} –¥–ª—è telegram_id {telegram_id}")
                
                row_data = [
                    code,
                    phone,
                    fio,
                    telegram_id,  # telegram_id (–∫–æ–ª–æ–Ω–∫–∞ D)
                    self._truncate_to_gs_limit(new_appeal),  # —Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π (–∫–æ–ª–æ–Ω–∫–∞ E)
                    '–ù–æ–≤–æ–µ',  # —Å—Ç–∞—Ç—É—Å (–∫–æ–ª–æ–Ω–∫–∞ F)
                    '',  # —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç (–∫–æ–ª–æ–Ω–∫–∞ G)
                    timestamp  # –≤—Ä–µ–º—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–∫–æ–ª–æ–Ω–∫–∞ H)
                ]
                
                logger.info(f"–î–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏: {row_data}")
                await self.gateway.append_row(self.worksheet, row_data)
                
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É #f3cccc (—Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π) –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ù–æ–≤–æ–µ"
                try:
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #f3cccc –¥–ª—è –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏ F{next_row}")
                    await self.gateway.format(self.worksheet, f'F{next_row}', {
                        "backgroundColor": {
                            "red": 0.95,    # #f3cccc
                            "green": 0.8,
                            "blue": 0.8
                        }
                    })
                    logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{next_row}")
                except Exception as format_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è —è—á–µ–π–∫–∏ F{next_row}: {format_error}", exc_info=True)
                
                logger.info(f"–°–æ–∑–¥–∞–Ω–æ –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {next_row})")
            
            return True
            
        except CircuitBreakerOpenError as e:
            logger.warning(f"Circuit Breaker –æ—Ç–∫—Ä—ã—Ç –¥–ª—è Appeals Service: {e}")
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}")
            return False

    def _cleanup_old_appeals(self, appeals_text: str) -> str:
        """
        –û—á–∏—â–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π.
        
        Args:
            appeals_text: —Ç–µ–∫—Å—Ç —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
            
        Returns:
            str: –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        try:
            if not appeals_text.strip():
                return appeals_text
                
            cutoff_date = datetime.datetime.now() - datetime.timedelta(days=30)
            lines = appeals_text.split('\n')
            cleaned_lines = []
            
            for line in lines:
                if not line.strip():
                    continue
                    
                # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏ (—Ñ–æ—Ä–º–∞—Ç: YYYY-MM-DD HH:MM:SS)
                try:
                    if len(line) >= 19 and line[4] == '-' and line[7] == '-':
                        date_str = line[:19]
                        appeal_date = datetime.datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
                        
                        if appeal_date >= cutoff_date:
                            cleaned_lines.append(line)
                        else:
                            logger.debug(f"–£–¥–∞–ª–µ–Ω–æ —Å—Ç–∞—Ä–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ: {line[:50]}...")
                    else:
                        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
                        cleaned_lines.append(line)
                except ValueError:
                    # –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã, –æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
                    cleaned_lines.append(line)
            
            return '\n'.join(cleaned_lines)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π: {e}")
            return appeals_text

    def _truncate_to_gs_limit(self, text: str, limit: int = 49000) -> str:
        """
        –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ Google Sheets (–ª–∏–º–∏—Ç ~50k —Å–∏–º–≤–æ–ª–æ–≤).
        –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª—è—è –ø–æ–º–µ—Ç–∫—É –æ–± —É—Å–µ—á–µ–Ω–∏–∏.
        """
        try:
            if text is None:
                return ""
            if len(text) <= limit:
                return text
            suffix = "\n[...] (—É—Å–µ—á–µ–Ω–æ –¥–æ –ª–∏–º–∏—Ç–∞ Google Sheets)"
            keep = max(0, limit - len(suffix))
            return text[-keep:] + suffix
        except Exception:
            return text[:limit]

    async def get_user_appeals(self, telegram_id: int) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return []

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            user_appeals = []
            
            for record in records:
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    user_appeals.append(record)
            
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(user_appeals)} –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            return user_appeals
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return []

    async def update_appeal_status(self, telegram_id: int, appeal_text: str, status: str, specialist_answer: str = '') -> bool:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            appeal_text: —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞
            status: –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
            specialist_answer: –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if (str(record.get('telegram_id', '')) == str(telegram_id) and 
                    record.get('—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π', '') == appeal_text):
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
                    await self.gateway.update(self.worksheet, f'F{i}', [[status]])  # —Å—Ç–∞—Ç—É—Å
                    if specialist_answer:
                        await self.gateway.update(self.worksheet, f'G{i}', [[specialist_answer]])  # —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç
                    await self.gateway.update(self.worksheet, f'H{i}', [[timestamp]])  # –≤—Ä–µ–º—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    
                    logger.info(f"–û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                    return True
            
            logger.warning(f"–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            return False
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}")
            return False

    async def get_all_appeals(self, status: Optional[str] = None) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—è –ø–æ —Å—Ç–∞—Ç—É—Å—É.
        
        Args:
            status: —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return []

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            
            if status:
                filtered_records = [r for r in records if r.get('—Å—Ç–∞—Ç—É—Å', '').lower() == status.lower()]
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(filtered_records)} –æ–±—Ä–∞—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{status}'")
                return filtered_records
            else:
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(records)} –æ–±—Ä–∞—â–µ–Ω–∏–π –≤—Å–µ–≥–æ")
                return records
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π: {e}")
            return []

    async def check_for_responses(self) -> List[Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –≤ –∫–æ–ª–æ–Ω–∫–µ G.
        
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π —Å –Ω–æ–≤—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return []

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            responses_to_send = []
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                specialist_answer = record.get('—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç', '').strip()
                telegram_id = record.get('telegram_id', '')
                
                if specialist_answer and telegram_id:
                    responses_to_send.append({
                        'row': i,
                        'telegram_id': int(telegram_id),
                        'response': specialist_answer,
                        'code': record.get('–∫–æ–¥', ''),
                        'fio': record.get('–§–ò–û', '')
                    })
            
            if responses_to_send:
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(responses_to_send)} –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏")
            
            return responses_to_send
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤: {e}")
            return []

    async def check_for_resolved_status(self) -> List[Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '–†–µ—à–µ–Ω–æ', –æ –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ —É–≤–µ–¥–æ–º–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
        –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –ø–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ä–µ—à–µ–Ω–∏–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–π.
        
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        """
        if not self.is_available():
            return []

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            resolved_appeals = []
            
            for i, record in enumerate(records, start=2):
                status = str(record.get('—Å—Ç–∞—Ç—É—Å', '')).strip().lower()
                appeals_text = str(record.get('—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π', ''))
                telegram_id = record.get('telegram_id', '')
                
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "—Ä–µ—à–µ–Ω–æ" –∏ –≤ —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
                if status == '—Ä–µ—à–µ–Ω–æ' and telegram_id:
                    # –ú–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
                    closing_markers = [
                        "‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–æ",
                        "‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω–æ–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."
                    ]
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–∞—Ä–∫–µ—Ä
                    has_marker = any(marker in appeals_text for marker in closing_markers)
                    
                    if not has_marker:
                        resolved_appeals.append({
                            'row': i,
                            'telegram_id': int(telegram_id),
                            'appeals_text': appeals_text
                        })
            
            if resolved_appeals:
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(resolved_appeals)} —Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
                
            return resolved_appeals
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—à–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤: {e}")
            return []

    async def clear_response(self, row: int) -> bool:
        """
        –û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.
        
        Args:
            row: –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –û—á–∏—â–∞–µ–º –∫–æ–ª–æ–Ω–∫—É G (—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç) - –∏—Å–ø–æ–ª—å–∑—É–µ–º batch_update
            await self.gateway.batch_update(self.worksheet, [{
                'range': f'G{row}',
                'values': [['']]
            }])
            logger.info(f"–û—á–∏—â–µ–Ω –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row}")
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ {row}: {e}")
            return False

    async def has_records(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.
        
        Returns:
            bool: True –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏
        """
        if not self.is_available():
            return False

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            return len(records) > 0
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–µ–π: {e}")
            return False

    async def add_specialist_response(self, telegram_id: int, response_text: str) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            response_text: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break
            
            if existing_row:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
                cell = await self.gateway.cell(self.worksheet, existing_row, 5)
                current_appeals = cell.value or ""  # –∫–æ–ª–æ–Ω–∫–∞ E
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ —Å–≤–µ—Ä—Ö—É
                if current_appeals.strip():
                    updated_appeals = f"{response_text}\n{current_appeals}"
                else:
                    updated_appeals = response_text
                # –£—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥ –ª–∏–º–∏—Ç Google Sheets
                updated_appeals = self._truncate_to_gs_limit(updated_appeals)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'E{existing_row}',
                    'values': [[updated_appeals]]
                }])
                
                logger.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: {e}")
            return False

    async def add_ai_response(self, telegram_id: int, response_text: str) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–û—Ç–≤–µ—Ç –ò–ò".
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            response_text: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ò–ò
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break
            
            if existing_row:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
                cell = await self.gateway.cell(self.worksheet, existing_row, 5)
                current_appeals = cell.value or ""  # –∫–æ–ª–æ–Ω–∫–∞ E
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò —Å–≤–µ—Ä—Ö—É —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º
                ai_response = f"ü§ñ –ò–ò: {response_text}"
                if current_appeals.strip():
                    updated_appeals = f"{ai_response}\n{current_appeals}"
                else:
                    updated_appeals = ai_response
                # –£—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥ –ª–∏–º–∏—Ç Google Sheets
                updated_appeals = self._truncate_to_gs_limit(updated_appeals)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —è—á–µ–π–∫—É —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –∏ —Å—Ç–∞—Ç—É—Å
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'E{existing_row}',
                    'values': [[updated_appeals]]
                }, {
                    'range': f'F{existing_row}',
                    'values': [['–û—Ç–≤–µ—Ç –ò–ò']]
                }])
                
                logger.info(f"–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '–û—Ç–≤–µ—Ç –ò–ò' –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {existing_row}")
                
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É #ffffff (–±–µ–ª—ã–π) –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–≤–µ—Ç –ò–ò"
                try:
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                    await self.gateway.format(self.worksheet, f'F{existing_row}', {
                        "backgroundColor": {
                            "red": 1.0,    # #ffffff
                            "green": 1.0,
                            "blue": 1.0
                        }
                    })
                    logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                except Exception as format_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}: {format_error}", exc_info=True)
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
                
                logger.info(f"–û—Ç–≤–µ—Ç –ò–ò –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò: {e}")
            return False

    async def add_user_message(self, telegram_id: int, message_text: str) -> bool:
        """
        –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫—É E –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø—Ä–∏ —Ä–µ–∂–∏–º–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            for i, record in enumerate(records, start=2):
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break

            if existing_row:
                cell = await self.gateway.cell(self.worksheet, existing_row, 5)
                current_appeals = cell.value or ""
                timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                user_line = f"{timestamp}: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {message_text}"
                updated_appeals = f"{user_line}\n{current_appeals}" if current_appeals.strip() else user_line
                # –£—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥ –ª–∏–º–∏—Ç Google Sheets
                updated_appeals = self._truncate_to_gs_limit(updated_appeals)
                await self.gateway.batch_update(self.worksheet, [
                    {'range': f'E{existing_row}', 'values': [[updated_appeals]]},
                    {'range': f'H{existing_row}', 'values': [[timestamp]]}
                ])
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–æ (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞) –¥–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–°—Ç—Ä–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (telegram_id={telegram_id})")
                return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            return False

    async def set_status_escalated(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É' —Å –∫—Ä–∞—Å–Ω–æ–π –∑–∞–ª–∏–≤–∫–æ–π #f3cccc.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break
            
            if existing_row:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É" –≤ –∫–æ–ª–æ–Ω–∫–µ F (—Å—Ç–∞—Ç—É—Å)
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'F{existing_row}',
                    'values': [['–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É']]
                }])
                
                logger.info(f"–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É' –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {existing_row}")
                
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É #f3cccc (—Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π) –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ F
                try:
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #f3cccc –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                    await self.gateway.format(self.worksheet, f'F{existing_row}', {
                        "backgroundColor": {
                            "red": 0.95,    # #f3cccc
                            "green": 0.8,
                            "blue": 0.8
                        }
                    })
                    logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                except Exception as format_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}: {format_error}", exc_info=True)
                
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É': {e}")
            return False

    async def set_status_in_work(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–í —Ä–∞–±–æ—Ç–µ' —Å –∑–∞–ª–∏–≤–∫–æ–π #fff2cc.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            
            for i, record in enumerate(records, start=2):  # start=2 –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ 1 - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break
            
            if existing_row:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ" –≤ –∫–æ–ª–æ–Ω–∫–µ F (—Å—Ç–∞—Ç—É—Å)
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'F{existing_row}',
                    'values': [['–í —Ä–∞–±–æ—Ç–µ']]
                }])
                
                logger.info(f"–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {existing_row}")
                
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ª–∏–≤–∫—É #fff2cc (—Å–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π) –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ F
                try:
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #fff2cc –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                    await self.gateway.format(self.worksheet, f'F{existing_row}', {
                        "backgroundColor": {
                            "red": 1.0,    # #fff2cc
                            "green": 0.95,
                            "blue": 0.8
                        }
                    })
                    logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                except Exception as format_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}: {format_error}", exc_info=True)
                
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ '–í —Ä–∞–±–æ—Ç–µ': {e}")
            return False

    async def set_status_resolved(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–†–µ—à–µ–Ω–æ' —Å –∑–µ–ª—ë–Ω–æ–π –∑–∞–ª–∏–≤–∫–æ–π #d9ead3.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return False

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            existing_row = None
            
            for i, record in enumerate(records, start=2):
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    existing_row = i
                    break
            
            if existing_row:
                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–†–µ—à–µ–Ω–æ" –≤ –∫–æ–ª–æ–Ω–∫–µ F (—Å—Ç–∞—Ç—É—Å)
                await self.gateway.batch_update(self.worksheet, [{
                    'range': f'F{existing_row}',
                    'values': [['–†–µ—à–µ–Ω–æ']]
                }])
                
                logger.info(f"–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ '–†–µ—à–µ–Ω–æ' –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {existing_row}")
                
                # –ó–µ–ª—ë–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ #d9ead3
                try:
                    logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #d9ead3 –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                    await self.gateway.format(self.worksheet, f'F{existing_row}', {
                        "backgroundColor": {
                            "red": 0.85,
                            "green": 0.92,
                            "blue": 0.83
                        }
                    })
                    logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}")
                except Exception as format_error:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ª–∏–≤–∫–∏ –¥–ª—è —è—á–µ–π–∫–∏ F{existing_row}: {format_error}", exc_info=True)
                
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–†–µ—à–µ–Ω–æ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (—Å—Ç—Ä–æ–∫–∞ {existing_row})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ '–†–µ—à–µ–Ω–æ': {e}")
            return False

    async def get_appeal_status(self, telegram_id: int) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            str: —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –∏–ª–∏ '–Ω–æ–≤–æ–µ' –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        if not self.is_available():
            logger.error("–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return '–Ω–æ–≤–æ–µ'

        try:
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —ç—Ç–æ–≥–æ telegram_id
            records = await self.gateway.get_all_records(self.worksheet)
            
            for i, record in enumerate(records, start=2):
                if str(record.get('telegram_id', '')) == str(telegram_id):
                    status = record.get('—Å—Ç–∞—Ç—É—Å', '–Ω–æ–≤–æ–µ')
                    logger.info(f"–ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}: {status}")
                    # –ê–≤—Ç–æ-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–ª–∏–≤–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                    try:
                        status_lower = str(status).strip().lower()
                        if status_lower == '—Ä–µ—à–µ–Ω–æ':
                            logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #d9ead3 –¥–ª—è —è—á–µ–π–∫–∏ F{i} (—Å—Ç–∞—Ç—É—Å: —Ä–µ—à–µ–Ω–æ)")
                            await self.gateway.format(self.worksheet, f'F{i}', {
                                "backgroundColor": {
                                    "red": 0.85,
                                    "green": 0.92,
                                    "blue": 0.83
                                }
                            })
                            logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{i}")
                        elif status_lower == '–≤ —Ä–∞–±–æ—Ç–µ':
                            logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ª–∏–≤–∫—É #fff2cc –¥–ª—è —è—á–µ–π–∫–∏ F{i} (—Å—Ç–∞—Ç—É—Å: –≤ —Ä–∞–±–æ—Ç–µ)")
                            await self.gateway.format(self.worksheet, f'F{i}', {
                                "backgroundColor": {
                                    "red": 1.0,
                                    "green": 0.95,
                                    "blue": 0.8
                                }
                            })
                            logger.info(f"–ó–∞–ª–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –¥–ª—è —è—á–µ–π–∫–∏ F{i}")
                    except Exception as e:
                        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {i}: {e}", exc_info=True)
                    return status
            
            logger.info(f"–°—Ç–∞—Ç—É—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º '–Ω–æ–≤–æ–µ'")
            return '–Ω–æ–≤–æ–µ'
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}")
            return '–Ω–æ–≤–æ–µ'


================================================================================
FILE: ./auth_service.py
SIZE: 13236 bytes
================================================================================

import logging
import datetime
from typing import Optional, Dict
import json
import os

from sheets_gateway import (
    _get_client_and_sheet,
    normalize_phone,
    SheetsNotConfiguredError,
)

logger = logging.getLogger(__name__)

class AuthService:
    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ sheets.py (–≤–∞—Ä–∏–∞–Ω—Ç A).

        –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
        - SHEET_ID (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
        - SHEET_NAME (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é Sheet1)
        - GCP_SA_JSON –∏–ª–∏ GCP_SA_FILE (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–¥–∏–Ω –∏–∑)
        """
        self.worksheet = None
        self.auth_cache_file = "auth_cache.json"
        self.auth_cache = self._load_auth_cache()
        
        try:
            _, worksheet = _get_client_and_sheet()
            self.worksheet = worksheet
            logger.info("Worksheet —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ sheets.py")
        except SheetsNotConfiguredError as e:
            logger.critical(f"Sheets –Ω–µ —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω: {e}")
        except Exception as e:
            logger.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ Google Sheets: {e}")

    def _load_auth_cache(self) -> Dict:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–∑ —Ñ–∞–π–ª–∞."""
        try:
            if os.path.exists(self.auth_cache_file):
                with open(self.auth_cache_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—ç—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        return {}

    def _save_auth_cache(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ —Ñ–∞–π–ª."""
        try:
            with open(self.auth_cache_file, 'w', encoding='utf-8') as f:
                json.dump(self.auth_cache, f, ensure_ascii=False, indent=2)
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—ç—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")

    def _is_auth_cache_valid(self, telegram_id: int, max_age_minutes: int = 5) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –ª–∏ –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        if str(telegram_id) not in self.auth_cache:
            return False
        
        cache_time = self.auth_cache[str(telegram_id)].get('timestamp')
        if not cache_time:
            return False
        
        try:
            cache_datetime = datetime.datetime.fromisoformat(cache_time)
            now = datetime.datetime.now()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –º–µ–Ω–µ–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏–Ω—É—Ç
            return (now - cache_datetime).total_seconds() < max_age_minutes * 60
        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∫—ç—à–∞: {e}")
            return False

    def _update_auth_cache(self, telegram_id: int, is_authorized: bool):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
        self.auth_cache[str(telegram_id)] = {
            'is_authorized': is_authorized,
            'timestamp': datetime.datetime.now().isoformat()
        }
        self._save_auth_cache()
    
    def clear_auth_cache(self, telegram_id: int = None):
        """–û—á–∏—â–∞–µ—Ç –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
        if telegram_id:
            if str(telegram_id) in self.auth_cache:
                del self.auth_cache[str(telegram_id)]
                logger.info(f"–ö—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
        else:
            self.auth_cache.clear()
            logger.info("–ö—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—á–∏—â–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
        self._save_auth_cache()

    def find_and_update_user(self, partner_code: str, partner_phone: str, telegram_id: int) -> bool:
        """
        –ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
        """
        logger.info(f"–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –∫–æ–¥={partner_code}, —Ç–µ–ª–µ—Ñ–æ–Ω={partner_phone}, telegram_id={telegram_id}")

        if not self.worksheet:
            logger.error("Worksheet –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (Sheets –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç).")
            return False

        try:
            if not partner_code or not partner_phone:
                logger.warning("–ü–æ–ª—É—á–µ–Ω—ã –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
                return False

            phone_norm = normalize_phone(partner_phone)
            logger.info(f"–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Ñ–æ—Ä–º—ã: '{phone_norm}'")
            try:
                logger.info(f"Worksheet: '{self.worksheet.title}' ‚Äî –ø–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å–∏...")
            except Exception:
                pass
            row_index: Optional[int] = find_row_by_partner_and_phone(partner_code, phone_norm)

            if row_index:
                logger.info(f"–ù–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: {row_index}")
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å/telegram_id —á–µ—Ä–µ–∑ batch API –∏–∑ sheets.py
                try:
                    update_row_with_auth(row_index, telegram_id, status='authorized')
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ {row_index}: {e}")
                    return False

                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º —Å—Ç–æ–ª–±–µ—Ü —Å –¥–∞—Ç–æ–π (F)
                try:
                    timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    self.worksheet.update(f'F{row_index}', timestamp)
                except Exception as e:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –¥–∞—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")

                logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–¥–æ–º {partner_code} —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.")
                # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                self._update_auth_cache(telegram_id, True)
                return True

            logger.warning(
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–¥–æ–º {partner_code} –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º {partner_phone} –Ω–µ –Ω–∞–π–¥–µ–Ω."
            )
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return False

    def get_user_auth_status(self, telegram_id: int) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ Telegram ID.
        –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ Google Sheets.
        """
        logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç)
        if self._is_auth_cache_valid(telegram_id, max_age_minutes=5):
            cached_result = self.auth_cache[str(telegram_id)]['is_authorized']
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π): {cached_result}")
            return cached_result
        
        # –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
        if not self.worksheet:
            logger.error("Worksheet –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (Sheets –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç).")
            return False

        try:
            logger.info("–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞...")
            records = self.worksheet.get_all_records()
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(records)} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞")
            
            for i, row in enumerate(records):
                logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–∏ {i+1} –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞: {row}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ 'Telegram ID' –≤ —Å—Ç—Ä–æ–∫–µ –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –æ–Ω
                telegram_id_in_sheet = row.get('Telegram ID')
                logger.info(f"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ Telegram ID: –≤ —Ç–∞–±–ª–∏—Ü–µ='{telegram_id_in_sheet}' vs –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–π='{telegram_id}'")
                
                if str(telegram_id_in_sheet) == str(telegram_id):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∫–æ–ª–æ–Ω–∫–µ '–°—Ç–∞—Ç—É—Å' –∏–ª–∏ '–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'
                    status = row.get('–°—Ç–∞—Ç—É—Å') or row.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏')
                    logger.info(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {telegram_id}, —Å—Ç–∞—Ç—É—Å: {status}")
                    status_norm = str(status or '').strip().lower()
                    result = status_norm in ("–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω", "authorized")
                    logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {result}")
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                    self._update_auth_cache(telegram_id, result)
                    return result
                else:
                    logger.info(f"–ó–∞–ø–∏—Å—å {i+1} –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–º—É Telegram ID")
                    
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ")
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º "–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
            self._update_auth_cache(telegram_id, False)
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            # –ò–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ–º –∫—ç—à –ø—Ä–∏ –æ—à–∏–±–∫–µ
            self.clear_auth_cache(telegram_id)
            return False

    def force_check_auth_status(self, telegram_id: int) -> bool:
        """
        –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫—ç—à.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ.
        """
        logger.info(f"–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
        
        if not self.worksheet:
            logger.error("Worksheet –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (Sheets –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç).")
            return False

        try:
            logger.info("–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏...")
            records = self.worksheet.get_all_records()
            logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(records)} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏")
            
            for i, row in enumerate(records):
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ 'Telegram ID' –≤ —Å—Ç—Ä–æ–∫–µ –∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –æ–Ω
                telegram_id_in_sheet = row.get('Telegram ID')
                
                if str(telegram_id_in_sheet) == str(telegram_id):
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –∫–æ–ª–æ–Ω–∫–µ '–°—Ç–∞—Ç—É—Å' –∏–ª–∏ '–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏'
                    status = row.get('–°—Ç–∞—Ç—É—Å') or row.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏')
                    logger.info(f"–ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {telegram_id}, —Å—Ç–∞—Ç—É—Å: {status}")
                    status_norm = str(status or '').strip().lower()
                    result = status_norm in ("–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω", "authorized")
                    logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {result}")
                    
                    # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                    self._update_auth_cache(telegram_id, result)
                    return result
                    
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å Telegram ID {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ")
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º "–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
            self._update_auth_cache(telegram_id, False)
            return False
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return False


================================================================================
FILE: ./bot.py
SIZE: 15877 bytes
================================================================================

"""
MarketingBot - Telegram –±–æ—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–∞–¥–µ–Ω–∏–π.
–í–∫–ª—é—á–∞–µ—Ç:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ event loop
- Graceful shutdown
- –ì–ª–æ–±–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
"""
import logging
import os
import signal
import sys
import atexit
from dotenv import load_dotenv
from telegram.ext import Application
from telegram.error import TelegramError

# –ó–∞–≥—Ä—É–∂–∞–µ–º .env –∫–∞–∫ –º–æ–∂–Ω–æ —Ä–∞–Ω—å—à–µ, –¥–æ –∏–º–ø–æ—Ä—Ç–æ–≤, —á–∏—Ç–∞—é—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv(dotenv_path=os.path.join(os.path.dirname(__file__), '.env'))

from auth_service import AuthService  # noqa: E402
from handlers import setup_handlers  # noqa: E402
from openai_service import OpenAIService  # noqa: E402
from response_monitor import ResponseMonitor  # noqa: E402
from promotions_notifier import PromotionsNotifier  # noqa: E402
from appeals_service import AppealsService  # noqa: E402
from bot_health_monitor import BotHealthMonitor  # noqa: E402
from sheets_gateway import AsyncGoogleSheetsGateway  # noqa: E402

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è graceful shutdown
application_instance = None
response_monitor_instance = None
promotions_notifier_instance = None
health_monitor_instance = None
shutdown_in_progress = False


def signal_handler(sig, frame):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã."""
    global shutdown_in_progress
    
    if shutdown_in_progress:
        logger.warning("–ü–æ–ª—É—á–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...")
        sys.exit(1)
        
    shutdown_in_progress = True
    logger.info(f"–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª {sig}, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è graceful shutdown...")
    
    try:
        if application_instance and application_instance.running:
            logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ polling...")
            application_instance.stop()
            application_instance.shutdown()
        logger.info("Graceful shutdown –∑–∞–≤–µ—Ä—à–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ graceful shutdown: {e}", exc_info=True)
    finally:
        sys.exit(0)


def setup_signal_handlers():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤."""
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    logger.info("–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã")


def cleanup_on_exit():
    """–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ."""
    global shutdown_in_progress
    if not shutdown_in_progress:
        logger.info("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ...")
        shutdown_in_progress = True


# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏
atexit.register(cleanup_on_exit)


def main() -> None:
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞."""
    global application_instance, response_monitor_instance
    global promotions_notifier_instance, health_monitor_instance
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–∏–≥–Ω–∞–ª–æ–≤
    setup_signal_handlers()
    
    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞ ---
    token = os.getenv("TELEGRAM_TOKEN")
    logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω TELEGRAM_TOKEN: {'<TOKEN_FOUND>' if token else 'None'}")
    if not token:
        logger.critical("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ! –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω.")
        sys.exit(1)

    # --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gateway –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ ---
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AsyncGoogleSheetsGateway...")
    auth_gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='auth')
    appeals_gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='appeals')
    promotions_gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='promotions')
    
    # --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫ ---
    logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤...")
    
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AuthService —Å Gateway...")
        auth_service = AuthService(gateway=auth_gateway)
        if not auth_service.worksheet:
            logger.critical("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ Google Sheets. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SHEET_ID/GCP_SA_JSON.")
            sys.exit(1)
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AuthService: {e}", exc_info=True)
        sys.exit(1)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAIService (Assistants Threads)...")
        openai_service = OpenAIService()
        if not openai_service.is_enabled():
            logger.warning("OpenAIService –æ—Ç–∫–ª—é—á–µ–Ω: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç OPENAI_API_KEY/OPENAI_ASSISTANT_ID")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAIService: {e}", exc_info=True)
        openai_service = OpenAIService()  # –°–æ–∑–¥–∞–µ–º —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π (Google Sheets)
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AppealsService —Å Gateway...")
        appeals_service = AppealsService(gateway=appeals_gateway)
        if not appeals_service.is_available():
            logger.warning("AppealsService –æ—Ç–∫–ª—é—á–µ–Ω: –ª–∏—Å—Ç '–æ–±—Ä–∞—â–µ–Ω–∏—è' –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ AppealsService: {e}", exc_info=True)
        appeals_service = None

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ResponseMonitor...")
        if appeals_service and appeals_service.is_available():
            response_monitor = ResponseMonitor(appeals_service, token)
            logger.info("ResponseMonitor –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
        else:
            response_monitor = None
            logger.warning("ResponseMonitor –æ—Ç–∫–ª—é—á–µ–Ω: AppealsService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ResponseMonitor: {e}", exc_info=True)
        response_monitor = None

    # --- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    try:
        logger.info("–°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞...")
        application = Application.builder().token(token).build()
        application_instance = application
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: {e}", exc_info=True)
        sys.exit(1)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∞–∫—Ü–∏—è—Ö
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PromotionsNotifier —Å Gateway...")
        promotions_notifier = PromotionsNotifier(application.bot, auth_service, gateway=promotions_gateway)
        promotions_notifier_instance = promotions_notifier
        logger.info("PromotionsNotifier –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ PromotionsNotifier: {e}", exc_info=True)
        promotions_notifier = None

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ –∑–¥–æ—Ä–æ–≤—å—è
    try:
        logger.info("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è BotHealthMonitor...")
        health_monitor = BotHealthMonitor(application.bot, check_interval=300)
        health_monitor_instance = health_monitor
        logger.info("BotHealthMonitor –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BotHealthMonitor: {e}", exc_info=True)
        health_monitor = None

    # --- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ---
    logger.info("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...")
    try:
        setup_handlers(application, auth_service, openai_service, appeals_service)
        logger.info("–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤: {e}", exc_info=True)
        sys.exit(1)

    # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ post_init callback ---
    async def post_init(application: Application) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        import asyncio
        
        # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è
        if health_monitor:
            try:
                await health_monitor.start_monitoring()
                logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –∑–∞–ø—É—â–µ–Ω")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è: {e}", exc_info=True)
        
        # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
        if response_monitor and appeals_service and appeals_service.is_available():
            logger.info("–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤...")
            try:
                asyncio.create_task(response_monitor.start_monitoring(interval_seconds=60))
                logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ –∑–∞–ø—É—â–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤: {e}", exc_info=True)

        # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ü–∏–π
        if promotions_notifier:
            logger.info("–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏–π...")
            try:
                asyncio.create_task(promotions_notifier.start_monitoring(interval_minutes=15))
                logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ü–∏–π –∑–∞–ø—É—â–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç)")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ü–∏–π: {e}", exc_info=True)

    async def post_stop(application: Application) -> None:
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞."""
        logger.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤...")
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è
        if health_monitor:
            try:
                await health_monitor.stop_monitoring()
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è: {e}")
        
        # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤
        if response_monitor and appeals_service and appeals_service.is_available():
            try:
                await response_monitor.stop_monitoring()
                logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤: {e}")

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ö—É–∫–æ–≤
    application.post_init = post_init
    application.post_stop = post_stop

    # --- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è polling ---
    def error_handler(update, context):
        """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫."""
        error = context.error
        
        # –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏
        if isinstance(error, TelegramError):
            logger.error(f"–û—à–∏–±–∫–∞ Telegram API: {error}")
        else:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {error}", exc_info=True)
        
        # –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É

    application.add_error_handler(error_handler)

    # --- –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π ---
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
    max_restart_attempts = 5
    restart_count = 0
    
    while restart_count < max_restart_attempts:
        try:
            application.run_polling(
                stop_signals=(signal.SIGINT, signal.SIGTERM),
                allowed_updates=None,
                drop_pending_updates=False,
                close_loop=False  # –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º loop –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
            )
            # –ï—Å–ª–∏ polling –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –≤—ã—Ö–æ–¥–∏–º
            break
            
        except KeyboardInterrupt:
            logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞...")
            break
            
        except (TelegramError, ConnectionError, TimeoutError) as e:
            restart_count += 1
            logger.error(
                f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ (–ø–æ–ø—ã—Ç–∫–∞ {restart_count}/{max_restart_attempts}): {e}",
                exc_info=True
            )
            
            if restart_count < max_restart_attempts:
                wait_time = min(30, 5 * restart_count)  # –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 30 —Å–µ–∫
                logger.info(f"–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ {wait_time} —Å–µ–∫—É–Ω–¥...")
                # –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –Ω–µ –Ω—É–∂–Ω–∞
                # –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å await asyncio.sleep() –≤ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
                
                # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                try:
                    application = Application.builder().token(token).build()
                    application_instance = application
                    setup_handlers(application, auth_service, openai_service, appeals_service)
                    application.post_init = post_init
                    application.post_stop = post_stop
                    application.add_error_handler(error_handler)
                    logger.info("–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫...")
                except Exception as recreate_error:
                    logger.critical(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: {recreate_error}", exc_info=True)
                    break
            else:
                logger.critical(f"–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ ({max_restart_attempts}). –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.")
                break
                
        except Exception as e:
            logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
            # –î–ª—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º - —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ
            break
    
    logger.info("–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")


if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ main(): {e}", exc_info=True)
        sys.exit(1)


================================================================================
FILE: ./bot_health_monitor.py
SIZE: 5084 bytes
================================================================================

"""
–ú–æ–¥—É–ª—å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.
"""
import logging
import asyncio
import time
from typing import Optional
from telegram import Bot
from telegram.error import TelegramError, NetworkError, TimedOut

logger = logging.getLogger(__name__)


class BotHealthMonitor:
    """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ."""
    
    def __init__(self, bot: Bot, check_interval: int = 300):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ –∑–¥–æ—Ä–æ–≤—å—è.
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
            check_interval: –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5 –º–∏–Ω—É—Ç)
        """
        self.bot = bot
        self.check_interval = check_interval
        self.is_running = False
        self._task: Optional[asyncio.Task] = None
        self.last_successful_check = time.time()
        self.consecutive_failures = 0
        self.max_failures = 3
        
    async def start_monitoring(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è."""
        if self.is_running:
            logger.warning("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            return
            
        self.is_running = True
        logger.info(f"–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ {self.check_interval} —Å–µ–∫)")
        self._task = asyncio.create_task(self._monitoring_loop())
        
    async def stop_monitoring(self):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è."""
        if not self.is_running:
            return
            
        self.is_running = False
        if self._task:
            self._task.cancel()
            try:
                await self._task
            except asyncio.CancelledError:
                pass
        logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        
    async def _monitoring_loop(self):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
        while self.is_running:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ getMe
                is_healthy = await self._check_bot_health()
                
                if is_healthy:
                    self.last_successful_check = time.time()
                    self.consecutive_failures = 0
                    logger.debug("–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞: OK")
                else:
                    self.consecutive_failures += 1
                    logger.warning(
                        f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞: FAILED "
                        f"(–ø–æ–¥—Ä—è–¥ –æ—à–∏–±–æ–∫: {self.consecutive_failures}/{self.max_failures})"
                    )
                    
                    if self.consecutive_failures >= self.max_failures:
                        logger.error(
                            f"–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï: –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ {self.max_failures} –ø–æ–ø—ã—Ç–æ–∫. "
                            f"–ü–æ—Å–ª–µ–¥–Ω—è—è —É—Å–ø–µ—à–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: {time.time() - self.last_successful_check:.0f} —Å–µ–∫ –Ω–∞–∑–∞–¥"
                        )
                        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
                        
                await asyncio.sleep(self.check_interval)
                
            except asyncio.CancelledError:
                logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Ç–º–µ–Ω—ã)")
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–¥–æ—Ä–æ–≤—å—è: {e}", exc_info=True)
                self.consecutive_failures += 1
                try:
                    await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                except asyncio.CancelledError:
                    break
                    
    async def _check_bot_health(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ getMe.
        
        Returns:
            True –µ—Å–ª–∏ –±–æ—Ç –∑–¥–æ—Ä–æ–≤, False –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ
        """
        try:
            # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ getMe —Å —Ç–∞–π–º–∞—É—Ç–æ–º
            me = await asyncio.wait_for(self.bot.get_me(), timeout=10.0)
            return me is not None
        except (TelegramError, NetworkError, TimedOut, asyncio.TimeoutError) as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞: {e}")
            return False
        except Exception as e:
            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞: {e}", exc_info=True)
            return False


================================================================================
FILE: ./check_pythonanywhere.py
SIZE: 5302 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ PythonAnywhere
–ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –Ω–∞ PythonAnywhere –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
"""

import logging
import os
import json
from datetime import datetime

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO, 
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def check_pythonanywhere_status():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ PythonAnywhere"""
    print("=== –ü–†–û–í–ï–†–ö–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ù–ê PYTHONANYWHERE ===\n")
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    print("1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    env_vars = [
        'SHEET_ID', 'SHEET_NAME', 'GCP_SA_JSON', 'GCP_SA_FILE',
        'TELEGRAM_TOKEN', 'WEB_APP_URL', 'SPA_MENU_URL'
    ]
    
    for var in env_vars:
        value = os.getenv(var)
        if value:
            if 'TOKEN' in var or 'JSON' in var:
                print(f"   {var}: ‚úì (—Å–∫—Ä—ã—Ç–æ)")
            else:
                print(f"   {var}: ‚úì {value}")
        else:
            print(f"   {var}: ‚úó")
    print()
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    print("2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets:")
    try:
        from sheets import _get_client_and_sheet
        client, worksheet = _get_client_and_sheet()
        print("   ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ")
        print(f"   –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞: {worksheet.title}")
        print(f"   ID —Ç–∞–±–ª–∏—Ü—ã: {worksheet.spreadsheet.id}")
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
        records = worksheet.get_all_records()
        print(f"   –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        print("   –ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏:")
        for i, record in enumerate(records[:3], start=2):
            name = record.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞', '')
            code = record.get('–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞', '')
            phone = record.get('–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞', '')
            status = record.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', '')
            print(f"     –°—Ç—Ä–æ–∫–∞ {i}: {name} | {code} | {phone} | {status}")
        
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞: {e}")
        return
    print()
    
    # 3. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    print("3. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ù–∞—Ç–∞–ª—å–∏:")
    try:
        from sheets import find_row_by_partner_and_phone, normalize_phone
        
        # –î–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        partner_code = '1245797092'
        partner_phone = '89634528665'
        
        print(f"   –ò—â–µ–º: –∫–æ–¥={partner_code}, —Ç–µ–ª–µ—Ñ–æ–Ω={partner_phone}")
        
        phone_norm = normalize_phone(partner_phone)
        print(f"   –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: {phone_norm}")
        
        row = find_row_by_partner_and_phone(partner_code, phone_norm)
        print(f"   –ù–∞–π–¥–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: {row}")
        
        if row:
            print("   ‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ê–ô–î–ï–ù")
        else:
            print("   ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù")
            
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {e}")
    print()
    
    # 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    print("4. –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:")
    try:
        from auth_service import AuthService
        
        auth_service = AuthService()
        if not auth_service.worksheet:
            print("   ‚úó AuthService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å —Ç–µ—Å—Ç–æ–≤—ã–º Telegram ID
        test_telegram_id = 999999999
        result = auth_service.find_and_update_user(partner_code, partner_phone, test_telegram_id)
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {result}")
        
        if result:
            print("   ‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê")
        else:
            print("   ‚ùå –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨")
            
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
    print()
    
    # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    print("5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:")
    try:
        if os.path.exists('auth_cache.json'):
            with open('auth_cache.json', 'r', encoding='utf-8') as f:
                cache = json.load(f)
            print(f"   –ö—ç—à –Ω–∞–π–¥–µ–Ω, –∑–∞–ø–∏—Å–µ–π: {len(cache)}")
            for user_id, data in cache.items():
                print(f"     –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id}: {data}")
        else:
            print("   –ö—ç—à –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞: {e}")
    print()
    
    print("=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
    print(f"–í—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∫–∏: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")

if __name__ == "__main__":
    check_pythonanywhere_status()


================================================================================
FILE: ./collect_code.py
SIZE: 9173 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∞ –≤—Å–µ–≥–æ –∫–æ–¥–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è Code Review.
–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–µ–∫—Ä–µ—Ç—ã, –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∫—ç—à –∏ –¥—Ä—É–≥–∏–µ –Ω–µ–Ω—É–∂–Ω—ã–µ —Ñ–∞–π–ª—ã.
"""
import os
import re

# –ü–∞–ø–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ò–ì–ù–û–†–ò–†–£–ï–ú
IGNORE_DIRS = {
    '.git', 'venv', 'env', '.venv', '__pycache__', '.idea', '.vscode', 
    'logs', '.ruff_cache', '.mypy_cache', 'node_modules', '.pytest_cache',
    'build', 'dist', '.eggs', '*.egg-info'
}

# –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ò–ì–ù–û–†–ò–†–£–ï–ú
IGNORE_FILES = {
    '.DS_Store', 'poetry.lock', 'yarn.lock', 'Thumbs.db', '.gitignore',
    'full_project_code.txt'  # –ß—Ç–æ–±—ã –Ω–µ –≤–∫–ª—é—á–∞—Ç—å —Å–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}

# –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ò–ì–ù–û–†–ò–†–£–ï–ú
IGNORE_EXTENSIONS = {
    '.pyc', '.pyo', '.pyd', '.png', '.jpg', '.jpeg', '.gif', '.svg', 
    '.ico', '.webp', '.sqlite', '.db', '.log', '.tmp', '.temp',
    '.key', '.pem', '.p12', '.pfx', '.crt', '.cer'
}

# –§–∞–π–ª—ã —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï–õ–¨–ó–Ø —á–∏—Ç–∞—Ç—å
SECRET_FILES = {
    '.env', '.env.local', '.env.production', '.env.staging', '.env.backup',
    '.env.enc', 'env.server.txt', 'cloudflare_tunnel_token.txt',
    'config.py', 'secrets.py'
}

# –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ —Ñ–∞–π–ª–∞—Ö (–¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è)
SECRET_PATTERNS = [
    r'API[_\s]*KEY\s*[:=]\s*["\']?[A-Za-z0-9_-]{20,}',
    r'SECRET\s*[:=]\s*["\']?[A-Za-z0-9_-]{20,}',
    r'PASSWORD\s*[:=]\s*["\']?[A-Za-z0-9_-]{10,}',
    r'TOKEN\s*[:=]\s*["\']?[A-Za-z0-9_-]{20,}',
    r'PRIVATE[_\s]*KEY',
    r'CREDENTIALS',
]

# –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ .json —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å
SAFE_JSON_FILES = {
    'package.json', 'tsconfig.json', '.eslintrc.json', '.prettierrc.json'
}

def is_secret_file(file_path: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª —Å–µ–∫—Ä–µ—Ç–Ω—ã–º."""
    file_name = os.path.basename(file_path)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞
    if file_name in SECRET_FILES:
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
    if any(pattern in file_name.lower() for pattern in ['secret', 'credential', 'key', 'token']):
        # –ò—Å–∫–ª—é—á–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ–∞–π–ª—ã
        if file_name in SAFE_JSON_FILES:
            return False
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ .json (–∫—Ä–æ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö)
    if file_path.endswith('.json'):
        if file_name in SAFE_JSON_FILES:
            return False
        # –ò—Å–∫–ª—é—á–∞–µ–º –≤—Å–µ .json —Ñ–∞–π–ª—ã (–º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–∏)
        return True
    
    return False

def check_for_secrets(content: str, file_path: str) -> list:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤."""
    warnings = []
    for pattern in SECRET_PATTERNS:
        matches = re.finditer(pattern, content, re.IGNORECASE)
        for match in matches:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è (–±–µ–∑ —Å–∞–º–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞)
            start = max(0, match.start() - 20)
            end = min(len(content), match.end() + 20)
            snippet = content[start:end].replace('\n', ' ')
            warnings.append(f"  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ {file_path}: ...{snippet}...")
    return warnings

def collect_project_code(output_file='full_project_code.txt'):
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤–µ—Å—å –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞ –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª."""
    warnings = []
    total_files = 0
    total_size = 0
    
    with open(output_file, 'w', encoding='utf-8') as outfile:
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        outfile.write("=" * 80 + "\n")
        outfile.write("PROJECT CODE COLLECTION FOR CODE REVIEW\n")
        outfile.write("=" * 80 + "\n\n")
        
        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
        outfile.write("=== PROJECT STRUCTURE ===\n\n")
        for root, dirs, files in os.walk('.'):
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∞–ø–æ–∫
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS and not d.startswith('.')]
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–∞–ø–∫–∏ (–∫—Ä–æ–º–µ –∫–æ—Ä–Ω—è)
            if root != '.' and os.path.basename(root).startswith('.'):
                continue
            
            level = root.replace('.', '').count(os.sep)
            indent = ' ' * 2 * level
            rel_path = root if root != '.' else '.'
            outfile.write(f"{indent}{os.path.basename(root) or '.'}/\n")
            
            subindent = ' ' * 2 * (level + 1)
            for f in sorted(files):
                if f in IGNORE_FILES or f.startswith('.'):
                    continue
                if any(f.endswith(ext) for ext in IGNORE_EXTENSIONS):
                    continue
                if is_secret_file(os.path.join(root, f)):
                    outfile.write(f"{subindent}{f} [SECRET - EXCLUDED]\n")
                    continue
                outfile.write(f"{subindent}{f}\n")
        
        outfile.write("\n\n" + "=" * 80 + "\n")
        outfile.write("=== FILE CONTENTS ===\n")
        outfile.write("=" * 80 + "\n\n")
        
        # –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤
        for root, dirs, files in os.walk('.'):
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–∞–ø–æ–∫
            dirs[:] = [d for d in dirs if d not in IGNORE_DIRS and not d.startswith('.')]
            
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –ø–∞–ø–∫–∏
            if root != '.' and os.path.basename(root).startswith('.'):
                continue
            
            for file in sorted(files):
                if file in IGNORE_FILES or file.startswith('.'):
                    continue
                if any(file.endswith(ext) for ext in IGNORE_EXTENSIONS):
                    continue
                if is_secret_file(os.path.join(root, file)):
                    continue
                
                file_path = os.path.join(root, file)
                
                try:
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
                    file_size = os.path.getsize(file_path)
                    total_size += file_size
                    
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as infile:
                        content = infile.read()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–µ–∫—Ä–µ—Ç—ã
                    file_warnings = check_for_secrets(content, file_path)
                    if file_warnings:
                        warnings.extend(file_warnings)
                    
                    total_files += 1
                    outfile.write(f"\n\n{'='*80}\n")
                    outfile.write(f"FILE: {file_path}\n")
                    outfile.write(f"SIZE: {file_size} bytes\n")
                    outfile.write(f"{'='*80}\n\n")
                    outfile.write(content)
                    
                except UnicodeDecodeError:
                    outfile.write(f"\n\n{'='*80}\n")
                    outfile.write(f"FILE: {file_path} [BINARY FILE - SKIPPED]\n")
                    outfile.write(f"{'='*80}\n\n")
                except Exception as e:
                    outfile.write(f"\n\n{'='*80}\n")
                    outfile.write(f"FILE: {file_path} [ERROR READING: {e}]\n")
                    outfile.write(f"{'='*80}\n\n")
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        outfile.write("\n\n" + "=" * 80 + "\n")
        outfile.write("=== STATISTICS ===\n")
        outfile.write("=" * 80 + "\n\n")
        outfile.write(f"Total files processed: {total_files}\n")
        outfile.write(f"Total size: {total_size / 1024 / 1024:.2f} MB\n")
        
        if warnings:
            outfile.write(f"\n\n{'='*80}\n")
            outfile.write("=== SECURITY WARNINGS ===\n")
            outfile.write("=" * 80 + "\n\n")
            outfile.write("‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:\n\n")
            for warning in warnings:
                outfile.write(warning + "\n")
            outfile.write("\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!\n")
    
    print(f"\n‚úÖ –ì–æ—Ç–æ–≤–æ! –í–µ—Å—å –∫–æ–¥ —Å–æ–±—Ä–∞–Ω –≤ —Ñ–∞–π–ª: {output_file}")
    print(f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    print(f"   - –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {total_files}")
    print(f"   - –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: {total_size / 1024 / 1024:.2f} MB")
    
    if warnings:
        print(f"\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {len(warnings)} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–∞—Ö!")
        print("   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—É!")
    else:
        print("\n‚úÖ –°–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –§–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.")

if __name__ == '__main__':
    collect_project_code()


================================================================================
FILE: ./debug_auth_issue.py
SIZE: 5500 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
–ü–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –±–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç "–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
"""

import logging
import os
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO, 
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

def debug_auth_issue():
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    print("=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´ –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===\n")
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    print("1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:")
    sheet_id = os.getenv('SHEET_ID')
    sheet_name = os.getenv('SHEET_NAME', 'Sheet1')
    gcp_sa_json = os.getenv('GCP_SA_JSON')
    
    print(f"   SHEET_ID: {'‚úì' if sheet_id else '‚úó'} {sheet_id}")
    print(f"   SHEET_NAME: {sheet_name}")
    print(f"   GCP_SA_JSON: {'‚úì' if gcp_sa_json else '‚úó'}")
    print()
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    print("2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets:")
    try:
        from sheets import _get_client_and_sheet
        client, worksheet = _get_client_and_sheet()
        print("   ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ")
        print(f"   –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞: {worksheet.title}")
        print(f"   ID —Ç–∞–±–ª–∏—Ü—ã: {worksheet.spreadsheet.id}")
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
        return
    print()
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
    print("3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ:")
    try:
        records = worksheet.get_all_records()
        print(f"   –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(records)}")
        
        # –ò—â–µ–º –∑–∞–ø–∏—Å–∏ —Å –∏–º–µ–Ω–µ–º –ù–∞—Ç–∞–ª—å—è
        natalia_records = []
        for i, record in enumerate(records, start=2):
            name = record.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞', '')
            if '–Ω–∞—Ç–∞–ª' in name.lower() or '–Ω–∞—Ç–∞—à' in name.lower():
                natalia_records.append((i, record))
        
        print(f"   –ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π —Å –∏–º–µ–Ω–µ–º –ù–∞—Ç–∞–ª—å—è: {len(natalia_records)}")
        for row_num, record in natalia_records:
            print(f"   –°—Ç—Ä–æ–∫–∞ {row_num}: {record.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞')} - {record.get('–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞')} - {record.get('–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞')}")
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {e}")
        return
    print()
    
    # 4. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    print("4. –¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:")
    try:
        from sheets import find_row_by_partner_and_phone, normalize_phone
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        test_cases = [
            {'code': '1245797092', 'phone': '89634528665', 'name': '–ì–∞–π–¥–∞–º–∞–∫–∞ –ù–∞—Ç–∞–ª—å—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞'},
            {'code': '111098', 'phone': '89827701055', 'name': '–ú–∞—Ä—á–µ–Ω–∫–æ –†–æ–º–∞–Ω –û–ª–µ–≥–æ–≤–∏—á'},
        ]
        
        for test in test_cases:
            print(f"   –¢–µ—Å—Ç: {test['name']}")
            print(f"     –ö–æ–¥: {test['code']}, –¢–µ–ª–µ—Ñ–æ–Ω: {test['phone']}")
            
            phone_norm = normalize_phone(test['phone'])
            print(f"     –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: {phone_norm}")
            
            row = find_row_by_partner_and_phone(test['code'], phone_norm)
            print(f"     –ù–∞–π–¥–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: {row}")
            
            if row:
                print("     ‚úÖ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ê–ô–î–ï–ù")
            else:
                print("     ‚ùå –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ù–ï –ù–ê–ô–î–ï–ù")
            print()
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–∞: {e}")
        return
    
    # 5. –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    print("5. –¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:")
    try:
        from auth_service import AuthService
        
        auth_service = AuthService()
        if not auth_service.worksheet:
            print("   ‚úó AuthService –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        test_telegram_id = 123456789
        result = auth_service.find_and_update_user('1245797092', '89634528665', test_telegram_id)
        print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç find_and_update_user: {result}")
        
        if result:
            print("   ‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê")
        else:
            print("   ‚ùå –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ù–ï –£–î–ê–õ–ê–°–¨")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        status = auth_service.get_user_auth_status(test_telegram_id)
        print(f"   –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {status}")
        
    except Exception as e:
        print(f"   ‚úó –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        return
    
    print("\n=== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")

if __name__ == "__main__":
    debug_auth_issue()


================================================================================
FILE: ./error_handler.py
SIZE: 6672 bytes
================================================================================

"""
–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–∞–¥–µ–Ω–∏–π –±–æ—Ç–∞.
"""
import logging
import functools
import asyncio
from typing import Callable, Any
from telegram.error import (
    TelegramError,
    NetworkError,
    TimedOut,
    RetryAfter,
    Conflict,
    BadRequest,
    Unauthorized,
    Forbidden,
    ChatNotFound,
    InvalidToken
)

logger = logging.getLogger(__name__)


def safe_telegram_call(max_retries: int = 3, retry_delay: float = 1.0):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ Telegram API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏.
    
    Args:
        max_retries: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        retry_delay: –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    """
    def decorator(func: Callable) -> Callable:
        @functools.wraps(func)
        async def wrapper(*args, **kwargs) -> Any:
            last_exception = None
            
            for attempt in range(max_retries):
                try:
                    return await func(*args, **kwargs)
                    
                except RetryAfter as e:
                    # Telegram –ø—Ä–æ—Å–∏—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å
                    wait_time = e.retry_after + retry_delay
                    logger.warning(
                        f"Telegram API rate limit, –æ–∂–∏–¥–∞–Ω–∏–µ {wait_time:.1f} —Å–µ–∫ "
                        f"(–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries})"
                    )
                    await asyncio.sleep(wait_time)
                    last_exception = e
                    continue
                    
                except (NetworkError, TimedOut) as e:
                    # –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ - –ø–æ–≤—Ç–æ—Ä—è–µ–º
                    if attempt < max_retries - 1:
                        wait_time = retry_delay * (2 ** attempt)  # Exponential backoff
                        logger.warning(
                            f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ {func.__name__}: {e}. "
                            f"–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time:.1f} —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries})"
                        )
                        await asyncio.sleep(wait_time)
                        last_exception = e
                        continue
                    else:
                        logger.error(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫: {e}")
                        raise
                        
                except Conflict as e:
                    # –ö–æ–Ω—Ñ–ª–∏–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
                    logger.error(f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç Telegram API: {e}. –í–æ–∑–º–æ–∂–Ω–æ, –∑–∞–ø—É—â–µ–Ω –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞.")
                    raise
                    
                except (Unauthorized, InvalidToken) as e:
                    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º
                    logger.critical(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram: {e}")
                    raise
                    
                except (Forbidden, ChatNotFound, BadRequest) as e:
                    # –û—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ - –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º
                    logger.warning(f"–û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Telegram API: {e}")
                    raise
                    
                except TelegramError as e:
                    # –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ Telegram API
                    if attempt < max_retries - 1:
                        wait_time = retry_delay * (2 ** attempt)
                        logger.warning(
                            f"–û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –≤—ã–∑–æ–≤–µ {func.__name__}: {e}. "
                            f"–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ {wait_time:.1f} —Å–µ–∫ (–ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries})"
                        )
                        await asyncio.sleep(wait_time)
                        last_exception = e
                        continue
                    else:
                        logger.error(f"–û—à–∏–±–∫–∞ Telegram API –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫: {e}")
                        raise
                        
                except Exception as e:
                    # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º
                    logger.error(
                        f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ {func.__name__}: {e}",
                        exc_info=True
                    )
                    raise
                    
            # –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
            if last_exception:
                logger.error(
                    f"–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å {func.__name__} –ø–æ—Å–ª–µ {max_retries} –ø–æ–ø—ã—Ç–æ–∫. "
                    f"–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_exception}"
                )
                raise last_exception
                
        return wrapper
    return decorator


def safe_handler(handler_func: Callable) -> Callable:
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π Telegram.
    –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –±–æ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö.
    """
    @functools.wraps(handler_func)
    async def wrapper(update, context):
        try:
            return await handler_func(update, context)
        except (NetworkError, TimedOut) as e:
            logger.warning(f"–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {handler_func.__name__}: {e}")
            # –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
        except (Unauthorized, Forbidden, ChatNotFound) as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {handler_func.__name__}: {e}")
            # –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
        except TelegramError as e:
            logger.error(f"–û—à–∏–±–∫–∞ Telegram API –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {handler_func.__name__}: {e}")
            # –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
        except Exception as e:
            logger.error(
                f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ {handler_func.__name__}: {e}",
                exc_info=True
            )
            # –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º - –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
            
    return wrapper


================================================================================
FILE: ./google_apps_script_complete.js
SIZE: 14384 bytes
================================================================================

// === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê) ===

// –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞
const SHEET_NAME = "–ê–∫—Ü–∏–∏";

// –ù–æ–º–µ—Ä–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
const RELEASE_DATE_COL = 1;
const TITLE_COL = 2;
const DESCRIPTION_COL = 3;
const STATUS_COL = 4;
const START_DATE_COL = 5;
const END_DATE_COL = 6;
const CONTENT_COL = 7;
const ACTION_COL = 8;

// –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
const HEADERS = [
  "–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞", "–ù–∞–∑–≤–∞–Ω–∏–µ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–°—Ç–∞—Ç—É—Å", 
  "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞", "–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è", "–ö–æ–Ω—Ç–µ–Ω—Ç", "–î–µ–π—Å—Ç–≤–∏–µ"
];

// –ù–æ–≤—ã–µ —Å—Ç–∞—Ç—É—Å—ã
const STATUS_PENDING = "–û–∂–∏–¥–∞–µ—Ç";
const STATUS_ACTIVE = "–ê–∫—Ç–∏–≤–Ω–∞";
const STATUS_FINISHED = "–ó–∞–∫–æ–Ω—á–µ–Ω–∞";

// –ù–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
const ACTION_PUBLISH = "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
const ACTION_FINISH = "–ó–∞–≤–µ—Ä—à–∏—Ç—å";

// –ù–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∑–∞–ª–∏–≤–∫–∏
const COLOR_PENDING = "#fff2cc";   // –°–≤–µ—Ç–ª–æ-–∂–µ–ª—Ç—ã–π
const COLOR_ACTIVE = "#d9ead3";    // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
const COLOR_FINISHED = "#f4cccc";  // –°–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π

// === –ö–û–ù–ï–¶ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===


/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ç–∞–±–ª–∏—Ü—ã.
 */
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê–∫—Ü–∏—è–º–∏')
    .addItem('‚úÖ 1. –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞/–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª', 'setupSheet')
    .addToUi();
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏—Å—Ç–∞.
 */
function setupSheet() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME, 0);
  const ui = SpreadsheetApp.getUi();

  sheet.getRange(1, 1, 1, sheet.getMaxColumns()).clearDataValidations();
  sheet.getRange(1, 1, 1, HEADERS.length).setValues([HEADERS]).setFontWeight("bold");
  sheet.setFrozenRows(1);

  const dateColumns = [RELEASE_DATE_COL, START_DATE_COL, END_DATE_COL];
  dateColumns.forEach(col => {
    sheet.getRange(2, col, sheet.getMaxRows() - 1, 1).setNumberFormat("dd.MM.yyyy");
  });

  const statusRange = sheet.getRange(2, STATUS_COL, sheet.getMaxRows() - 1, 1);
  const protection = statusRange.protect().setDescription('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
  const me = Session.getEffectiveUser();
  protection.addEditor(me);
  protection.removeEditors(protection.getEditors());
  if (protection.canDomainEdit()) {
    protection.setDomainEdit(false);
  }

  sheet.getRange(2, ACTION_COL, sheet.getMaxRows() - 1, 1)
    .setDataValidation(SpreadsheetApp.newDataValidation().requireValueInList([ACTION_PUBLISH, ACTION_FINISH], true).build());
  sheet.getRange(2, START_DATE_COL, sheet.getMaxRows() - 1, 2)
    .setDataValidation(SpreadsheetApp.newDataValidation().requireDate().setAllowInvalid(false).build());

  sheet.clearConditionalFormatRules();
  const fullRange = `A2:H${sheet.getMaxRows()}`;
  const rules = [
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_PENDING}"`).setBackground(COLOR_PENDING).setRanges([sheet.getRange(fullRange)]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_ACTIVE}"`).setBackground(COLOR_ACTIVE).setRanges([sheet.getRange(fullRange)]).build(),
    SpreadsheetApp.newConditionalFormatRule().whenFormulaSatisfied(`=$D2="${STATUS_FINISHED}"`).setBackground(COLOR_FINISHED).setRanges([sheet.getRange(fullRange)]).build()
  ];
  sheet.setConditionalFormatRules(rules);
  
  createTriggers();

  ui.alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', '–õ–∏—Å—Ç "–ê–∫—Ü–∏–∏" –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.', ui.ButtonSet.OK);
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏).
 */
function createTriggers() {
  ScriptApp.getProjectTriggers().forEach(trigger => ScriptApp.deleteTrigger(trigger));

  ScriptApp.newTrigger('onEditTrigger')
    .forSpreadsheet(SpreadsheetApp.getActive())
    .onEdit()
    .create();

  ScriptApp.newTrigger('updateStatusesDaily')
    .timeBased()
    .everyDays(1)
    .atHour(1)
    .create();
}

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–µ–∫.
 * @param {Object} e - –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è.
 */
function onEditTrigger(e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è e —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ –≤—ã—Ö–æ–¥–∏–º.
  if (!e || !e.range) {
    return;
  }

  const range = e.range;
  const sheet = range.getSheet();
  if (sheet.getName() !== SHEET_NAME || range.getRow() <= 1) return;

  const col = range.getColumn();
  const row = range.getRow();
  
  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–ù–∞–∑–≤–∞–Ω–∏–µ"
  if (col === TITLE_COL) {
    const titleValue = range.getValue();
    const releaseDateCell = sheet.getRange(row, RELEASE_DATE_COL);

    // –ï—Å–ª–∏ –≤ —è—á–µ–π–∫–µ –ø–æ—è–≤–∏–ª–æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –¥–∞—Ç–∞ –µ—â–µ –Ω–µ —Å—Ç–æ–∏—Ç - —Å—Ç–∞–≤–∏–º –¥–∞—Ç—É
    if (titleValue !== "" && releaseDateCell.isBlank()) {
      releaseDateCell.setValue(new Date());
    } 
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —è—á–µ–π–∫–∏ —É–¥–∞–ª–∏–ª–∏ - —Å—Ç–∏—Ä–∞–µ–º –¥–∞—Ç—É
    else if (titleValue === "") {
      releaseDateCell.clearContent();
    }
  }

  // –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ "–î–µ–π—Å—Ç–≤–∏–µ"
  if (col === ACTION_COL) {
    const actionValue = range.getValue();
    if (actionValue === ACTION_PUBLISH) {
      handlePublish(sheet, row);
    } else if (actionValue === ACTION_FINISH) {
      handleFinish(sheet, row);
    }
  }
}

/**
 * –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å".
 */
function handlePublish(sheet, row) {
  const ui = SpreadsheetApp.getUi();
  const rowValues = sheet.getRange(row, 1, 1, HEADERS.length).getValues()[0];

  const missingFields = [];
  if (!rowValues[TITLE_COL - 1]) missingFields.push(HEADERS[TITLE_COL - 1]);
  if (!rowValues[DESCRIPTION_COL - 1]) missingFields.push(HEADERS[DESCRIPTION_COL - 1]);
  if (!rowValues[START_DATE_COL - 1]) missingFields.push(HEADERS[START_DATE_COL - 1]);
  if (!rowValues[END_DATE_COL - 1]) missingFields.push(HEADERS[END_DATE_COL - 1]);

  if (missingFields.length > 0) {
    ui.alert('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', `–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- ${missingFields.join('\n- ')}`, ui.ButtonSet.OK);
    sheet.getRange(row, ACTION_COL).clearContent();
    return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const startDate = new Date(rowValues[START_DATE_COL - 1]);
  startDate.setHours(0,0,0,0);

  const statusCell = sheet.getRange(row, STATUS_COL);
  
  if (startDate > today) {
    statusCell.setValue(STATUS_PENDING);
  } else {
    statusCell.setValue(STATUS_ACTIVE);
  }
  
  sheet.getRange(row, ACTION_COL).clearContent();
}

/**
 * –õ–æ–≥–∏–∫–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏—è "–ó–∞–≤–µ—Ä—à–∏—Ç—å".
 */
function handleFinish(sheet, row) {
  sheet.getRange(row, STATUS_COL).setValue(STATUS_FINISHED);
  sheet.getRange(row, ACTION_COL).clearContent();
}

/**
 * –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤.
 */
function updateStatusesDaily() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  if (!sheet || sheet.getLastRow() < 2) return;

  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, HEADERS.length);
  const values = dataRange.getValues();
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  let changesMade = false;
  for (let i = 0; i < values.length; i++) {
    const status = values[i][STATUS_COL - 1];
    const startDate = values[i][START_DATE_COL - 1] ? new Date(values[i][START_DATE_COL - 1]) : null;
    const endDate = values[i][END_DATE_COL - 1] ? new Date(values[i][END_DATE_COL - 1]) : null;
    
    if (status === STATUS_ACTIVE && endDate && endDate < today) {
      values[i][STATUS_COL - 1] = STATUS_FINISHED;
      values[i][ACTION_COL - 1] = "";
      changesMade = true;
    } 
    else if (status === STATUS_PENDING && startDate && startDate <= today) {
      values[i][STATUS_COL - 1] = STATUS_ACTIVE;
      changesMade = true;
    }
  }

  if (changesMade) {
    dataRange.setValues(values);
  }
}

// ============================================================================
// API –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ê–ö–¢–ò–í–ù–´–• –ê–ö–¶–ò–ô
// ============================================================================

/**
 * Google Apps Script –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –∏–∑ Google Sheets.
 * 
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:
 * 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤ Apps Script
 * 2. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
 * 3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø: "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
 * 4. –£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø: "–í—Å–µ"
 * 5. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"
 * 6. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * 
 * @param {Object} e - –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è doGet)
 * @returns {TextOutput} JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
 */
function doGet(e) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // –ü–æ–ª—É—á–∞–µ–º –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏"
    var sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    // –ï—Å–ª–∏ –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
    if (!sheet) {
      sheet = spreadsheet.getActiveSheet();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    var data = sheet.getDataRange().getValues();
    
    // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (data.length < 2) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏)
    var rows = data.slice(1);
    var result = [];
    
    rows.forEach(function(row, rowIndex) {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º –∫–æ–ª–æ–Ω–æ–∫ (–∏–Ω–¥–µ–∫—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0)
      var status = row[STATUS_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ D (–∏–Ω–¥–µ–∫—Å 3)
      var title = row[TITLE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ B (–∏–Ω–¥–µ–∫—Å 1)
      var description = row[DESCRIPTION_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ C (–∏–Ω–¥–µ–∫—Å 2)
      var startDate = row[START_DATE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ E (–∏–Ω–¥–µ–∫—Å 4)
      var endDate = row[END_DATE_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ F (–∏–Ω–¥–µ–∫—Å 5)
      var content = row[CONTENT_COL - 1]; // –ö–æ–ª–æ–Ω–∫–∞ G (–∏–Ω–¥–µ–∫—Å 6)
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Ä–∞–≤–µ–Ω "–ê–∫—Ç–∏–≤–Ω–∞" (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
      if (status && String(status).trim() === STATUS_ACTIVE) {
        // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (!title || title === 'None' || title === '') {
          title = description ? '–ê–∫—Ü–∏—è ' + description : '–ê–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        var formattedStartDate = '';
        var formattedEndDate = '';
        
        if (startDate instanceof Date) {
          formattedStartDate = Utilities.formatDate(startDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
        } else if (startDate) {
          formattedStartDate = String(startDate).trim();
        }
        
        if (endDate instanceof Date) {
          formattedEndDate = Utilities.formatDate(endDate, Session.getScriptTimeZone(), 'dd.MM.yyyy');
        } else if (endDate) {
          formattedEndDate = String(endDate).trim();
        }
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        var uniqueId = (title + '_' + description + '_' + formattedStartDate + '_' + formattedEndDate)
          .replace(/\s+/g, '_')
          .replace(/:/g, '')
          .replace(/-/g, '');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å promotions_api.py
        var promotion = {
          'id': uniqueId,
          'title': String(title).trim(),
          'description': description ? String(description).trim() : '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
          'status': STATUS_ACTIVE,
          'start_date': formattedStartDate,
          'end_date': formattedEndDate
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (content && content !== 'None' && content !== '') {
          promotion['content'] = String(content).trim();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ü–∏—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
        if (promotion['title'] && promotion['title'] !== 'None') {
          result.push(promotion);
        }
      }
    });
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    // –í Google Apps Script CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ "Anyone" –¥–æ—Å—Ç—É–ø–∞
    return ContentService
      .createTextOutput(JSON.stringify(result, null, 2))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
    Logger.log('–û—à–∏–±–∫–∞ –≤ doGet: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.toString(),
        promotions: []
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã API.
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 */
function testGetPromotions() {
  var result = doGet({});
  Logger.log(result.getContent());
}


================================================================================
FILE: ./google_apps_script_promotions.js
SIZE: 7103 bytes
================================================================================

/**
 * Google Apps Script –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –∏–∑ Google Sheets
 * 
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:
 * 1. –û—Ç–∫—Ä–æ–π—Ç–µ Google –¢–∞–±–ª–∏—Ü—É —Å –∞–∫—Ü–∏—è–º–∏
 * 2. –†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script
 * 3. –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥
 * 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç (Ctrl+S)
 * 5. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
 * 6. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø: "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
 * 7. –£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø: "–í—Å–µ"
 * 8. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"
 * 9. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 */

function doGet(e) {
  try {
    // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // –ü–æ–ª—É—á–∞–µ–º –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏" (–µ—Å–ª–∏ –ª–∏—Å—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ-–¥—Ä—É–≥–æ–º—É, –∏–∑–º–µ–Ω–∏—Ç–µ –∑–¥–µ—Å—å)
    var sheet = spreadsheet.getSheetByName("–ê–∫—Ü–∏–∏");
    
    // –ï—Å–ª–∏ –ª–∏—Å—Ç "–ê–∫—Ü–∏–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
    if (!sheet) {
      sheet = spreadsheet.getActiveSheet();
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    var data = sheet.getDataRange().getValues();
    
    // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    if (data.length < 2) {
      return ContentService
        .createTextOutput(JSON.stringify([]))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    var headers = data[0];
    
    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
    var headerMap = {};
    headers.forEach(function(header, index) {
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
      var normalizedHeader = String(header).trim().toLowerCase();
      headerMap[normalizedHeader] = index;
    });
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π)
    var statusIndex = headerMap['—Å—Ç–∞—Ç—É—Å'] !== undefined ? headerMap['—Å—Ç–∞—Ç—É—Å'] : 
                      headerMap['status'] !== undefined ? headerMap['status'] : 3; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ D (–∏–Ω–¥–µ–∫—Å 3)
    
    var titleIndex = headerMap['–Ω–∞–∑–≤–∞–Ω–∏–µ'] !== undefined ? headerMap['–Ω–∞–∑–≤–∞–Ω–∏–µ'] : 
                     headerMap['title'] !== undefined ? headerMap['title'] : 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ B (–∏–Ω–¥–µ–∫—Å 1)
    
    var descriptionIndex = headerMap['–æ–ø–∏—Å–∞–Ω–∏–µ'] !== undefined ? headerMap['–æ–ø–∏—Å–∞–Ω–∏–µ'] : 
                           headerMap['description'] !== undefined ? headerMap['description'] : 2; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ C (–∏–Ω–¥–µ–∫—Å 2)
    
    var startDateIndex = headerMap['–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'] !== undefined ? headerMap['–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞'] : 
                         headerMap['start date'] !== undefined ? headerMap['start date'] : 4; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ E (–∏–Ω–¥–µ–∫—Å 4)
    
    var endDateIndex = headerMap['–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'] !== undefined ? headerMap['–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è'] : 
                       headerMap['end date'] !== undefined ? headerMap['end date'] : 5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ F (–∏–Ω–¥–µ–∫—Å 5)
    
    var contentIndex = headerMap['–∫–æ–Ω—Ç–µ–Ω—Ç'] !== undefined ? headerMap['–∫–æ–Ω—Ç–µ–Ω—Ç'] : 
                       headerMap['content'] !== undefined ? headerMap['content'] : 6; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–æ–ª–æ–Ω–∫–∞ G (–∏–Ω–¥–µ–∫—Å 6)
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏)
    var rows = data.slice(1);
    var result = [];
    
    rows.forEach(function(row, rowIndex) {
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ü–∏–∏
      var status = row[statusIndex];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–∞—Ç—É—Å —Ä–∞–≤–µ–Ω "–ê–∫—Ç–∏–≤–Ω–∞" (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
      if (status && String(status).trim().toLowerCase() === '–∞–∫—Ç–∏–≤–Ω–∞') {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏
        var title = row[titleIndex] || '';
        var description = row[descriptionIndex] || '';
        var startDate = row[startDateIndex] || '';
        var endDate = row[endDateIndex] || '';
        var content = row[contentIndex] || '';
        
        // –ï—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (!title || title === 'None' || title === '') {
          title = description ? '–ê–∫—Ü–∏—è ' + description : '–ê–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
        }
        
        // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
        var uniqueId = (title + '_' + description + '_' + startDate + '_' + endDate)
          .replace(/\s+/g, '_')
          .replace(/:/g, '')
          .replace(/-/g, '');
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–º —Å promotions_api.py
        var promotion = {
          'id': uniqueId,
          'title': String(title).trim(),
          'description': description ? String(description).trim() : '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç',
          'status': '–ê–∫—Ç–∏–≤–Ω–∞',
          'start_date': startDate ? String(startDate).trim() : '',
          'end_date': endDate ? String(endDate).trim() : ''
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (content && content !== 'None' && content !== '') {
          promotion['content'] = String(content).trim();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ü–∏—é –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ
        if (promotion['title'] && promotion['title'] !== 'None') {
          result.push(promotion);
        }
      }
    });
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
    // –í Google Apps Script CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ "Anyone" –¥–æ—Å—Ç—É–ø–∞
    return ContentService
      .createTextOutput(JSON.stringify(result, null, 2))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—à–∏–±–∫–µ
    Logger.log('–û—à–∏–±–∫–∞ –≤ doGet: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({ 
        error: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.toString(),
        promotions: []
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
function testGetPromotions() {
  var result = doGet({});
  Logger.log(result.getContent());
}


================================================================================
FILE: ./handlers.py
SIZE: 45312 bytes
================================================================================

import logging
import os
import json
import asyncio
from telegram import Update, WebAppInfo, KeyboardButton, ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CommandHandler, MessageHandler, CallbackQueryHandler, filters

from auth_service import AuthService
from openai_service import OpenAIService
from appeals_service import AppealsService
from promotions_api import get_promotions_json, is_promotions_available

logger = logging.getLogger(__name__)

def get_web_app_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL WebApp –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ .env)."""
    base_url = os.getenv("WEB_APP_URL") or ""
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    return base_url + "index.html"

def get_spa_menu_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL SPA –º–µ–Ω—é –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    base_url = os.getenv("WEB_APP_URL") or ""
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    # –í–µ—Ä—Å–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞ WebApp
    cache_bust = "v=20260108-2"
    return f"{base_url}menu.html?{cache_bust}"

def create_specialist_button() -> InlineKeyboardMarkup:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    keyboard = [[InlineKeyboardButton("üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", callback_data="contact_specialist")]]
    return InlineKeyboardMarkup(keyboard)

def _is_user_escalation_request(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
    
    Args:
        text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        bool: True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
    """
    import re
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: —É–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    text_normalized = re.sub(r'[^\w\s]', '', text.lower())
    
    # –ü—Ä—è–º—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (30 —Ñ—Ä–∞–∑)
    escalation_phrases = [
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Ö–æ—á—É –∫ —á–µ–ª–æ–≤–µ–∫—É',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫',
        '—Ä–µ–∞–ª—å–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–¥–∞–π—Ç–µ –º–Ω–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫',
        '—Ö–æ—á—É –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–Ω—É–∂–µ–Ω –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
        '—Ö–æ—á—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–¥–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–π –≤–æ–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ—é –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–¥–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞'
    ]
    
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    # confirmation_phrases removed as it was unused

    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    for phrase in escalation_phrases:
        if phrase in text_normalized:
            return True
    
    return False

def _is_ai_asking_for_escalation(ai_response: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ò–ò –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    
    Args:
        ai_response: –æ—Ç–≤–µ—Ç –ò–ò
        
    Returns:
        bool: True –µ—Å–ª–∏ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    """
    if not ai_response:
        return False
        
    response_lower = ai_response.lower()
    
    # –§—Ä–∞–∑—ã, –∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    escalation_questions = [
        '–Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    for phrase in escalation_questions:
        if phrase in response_lower:
            return True
    
    return False

def _is_escalation_confirmation(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    
    Args:
        text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        bool: True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ñ—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    """
    text_lower = text.lower()
    
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    confirmation_phrases = [
        '–¥–∞',
        '–¥–∞, –Ω—É–∂–Ω–æ',
        '–¥–∞, –ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '–¥–∞, —Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '–¥–∞, —Å–≤—è–∂–∏—Ç–µ',
        '–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–¥–∞, –∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞, –¥–∞–≤–∞–π—Ç–µ',
        '–¥–∞, —Ö–æ—Ä–æ—à–æ',
        '–¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω',
        '–Ω—É–∂–Ω–æ',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '—Å–≤—è–∂–∏—Ç–µ',
        '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞–≤–∞–π—Ç–µ',
        '—Ö–æ—Ä–æ—à–æ',
        '—Å–æ–≥–ª–∞—Å–µ–Ω',
        '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—Ä–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    for phrase in confirmation_phrases:
        if phrase in text_lower:
            return True
    
    return False

def _should_show_specialist_button(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å –µ–≥–æ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º/–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
    
    Args:
        text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
    Returns:
        bool: True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
    """
    text_lower = text.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
    specialist_keywords = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–º—É —á–µ–ª–æ–≤–µ–∫—É', '–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–º–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞', '–º–µ–Ω–µ–¥–∂–µ—Ä—É', '–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º',
        '–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä—É', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
        '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å', '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ', '—Å–æ–µ–¥–∏–Ω–∏', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
        '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '—á–µ–ª–æ–≤–µ–∫', '—á–µ–ª–æ–≤–µ–∫–∞', '—á–µ–ª–æ–≤–µ–∫—É', '—á–µ–ª–æ–≤–µ–∫–æ–º',
        '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç–µ', '–∑–≤–æ–Ω–æ–∫', '–∑–≤–æ–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '—Å–≤—è–∑–∞—Ç—å—Å—è —Å', '—Å–≤—è–∑–∞—Ç—å', '—Å–≤—è–∑–∞—Ç—å —Å',
        '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '–ø–æ–¥–¥–µ—Ä–∂–∫—É', '–ø–æ–¥–¥–µ—Ä–∂–∫–µ', '–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',
        '–ø–æ–º–æ—â—å', '–ø–æ–º–æ—â–∏', '–ø–æ–º–æ—á—å', '–ø–æ–º–æ—â—å—é',
        '–Ω–µ –º–æ–≥—É', '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
        '–ø—Ä–æ–±–ª–µ–º–∞', '–ø—Ä–æ–±–ª–µ–º—ã', '–ø—Ä–æ–±–ª–µ–º—É', '–ø—Ä–æ–±–ª–µ–º–æ–π',
        '—Å–ª–æ–∂–Ω–æ', '—Å–ª–æ–∂–Ω—ã–π', '—Å–ª–æ–∂–Ω–∞—è', '—Å–ª–æ–∂–Ω–æ–µ',
        '–Ω–µ –ø–æ–Ω–∏–º–∞—é', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ', '–Ω–µ —è—Å–Ω–æ',
        '–æ–±—ä—è—Å–Ω–∏—Ç–µ', '–æ–±—ä—è—Å–Ω–∏', '–æ–±—ä—è—Å–Ω–∏—Ç—å',
        '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–ø–æ–¥—Ä–æ–±–Ω–æ', '–ø–æ–¥—Ä–æ–±–Ω—ã–π',
        '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '–¥–µ—Ç–∞–ª—å–Ω–æ'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for keyword in specialist_keywords:
        if keyword in text_lower:
            return True
    
    return False




def setup_handlers(application, auth_service: AuthService, openai_service: OpenAIService, appeals_service: AppealsService):
    """–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏."""
    application.add_handler(CommandHandler("start", start_command_handler(auth_service)))
    application.add_handler(CommandHandler("appeals", appeals_command_handler(auth_service, appeals_service)))
    application.add_handler(CommandHandler("promotions", promotions_command_handler(auth_service)))
    application.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, web_app_data_handler(auth_service)))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND & ~filters.StatusUpdate.WEB_APP_DATA, chat_handler(auth_service, openai_service, appeals_service)))
    application.add_handler(CallbackQueryHandler(callback_query_handler(auth_service, appeals_service)))

def start_command_handler(auth_service: AuthService):
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ /start —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–µ—Ä–≤–∏—Å—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."""
    async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} ({user.first_name}) –∑–∞–ø—É—Å—Ç–∏–ª –∫–æ–º–∞–Ω–¥—É /start.")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        auth_status = await auth_service.get_user_auth_status(user.id)
        logger.info(f"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {auth_status}")
        if auth_status:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SPA –º–µ–Ω—é –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            SPA_MENU_URL = get_spa_menu_url()
            logger.info(f"SPA_MENU_URL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {SPA_MENU_URL}")
            if SPA_MENU_URL:
                # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ —Å –∫–Ω–æ–ø–∫–æ–π "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
                keyboard = [
                    [KeyboardButton(
                        text="üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
                        web_app=WebAppInfo(url=SPA_MENU_URL)
                    )]
                ]
                reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
                
                await update.message.reply_text(
                    f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user.first_name}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MarketingBot! üéØ\n\n"
                    "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª–∞–º.",
                    reply_markup=reply_markup
                )
            else:
                await update.message.reply_text(
                    f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user.first_name}! –í—ã —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ú–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É."
                )
        else:
            WEB_APP_URL = get_web_app_url()
            logger.info(f"WEB_APP_URL –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {WEB_APP_URL}")
            if WEB_APP_URL:
                keyboard_button = KeyboardButton(
                    text="–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏",
                    web_app=WebAppInfo(url=WEB_APP_URL)
                )
                reply_markup = ReplyKeyboardMarkup.from_button(keyboard_button, resize_keyboard=True)
                await update.message.reply_text(
                    f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user.first_name}! –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≤–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è.",
                    reply_markup=reply_markup,
                )
            else:
                logger.error("WEB_APP_URL –Ω–µ –∑–∞–¥–∞–Ω, –∫–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω–∞.")
                await update.message.reply_text(
                    f"–î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user.first_name}! –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                )
    return start

def web_app_data_handler(auth_service: AuthService):
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Mini App."""
    async def handle_data(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        logger.info(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ Web App –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} ({user.first_name})")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–∫—Ü–∏–π
        # –î–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —ç—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
        
        await update.message.reply_text("–ü—Ä–æ–≤–µ—Ä—è—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ...")
        
        try:
            web_app_data = update.effective_message.web_app_data.data
            logger.info(f"–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Web App: {web_app_data}")
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ
            if not web_app_data:
                logger.warning("–ü–æ–ª—É—á–µ–Ω—ã –ø—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Web App")
                await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
                return
                
            data = json.loads(web_app_data)
            logger.info(f"–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ Web App –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {data}")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –∞–∫—Ü–∏–π –∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            if data.get('action') == 'get_promotions':
                logger.info(f"–ó–∞–ø—Ä–æ—Å –∞–∫—Ü–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–∫—Ü–∏–π –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                auth_status = await auth_service.get_user_auth_status(user.id)
                if not auth_status:
                    logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ü–∏–∏")
                    await update.message.reply_text("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å.")
                    return
                await handle_promotions_request(update, context)
                return
            
            partner_code = data.get('partner_code')
            partner_phone = data.get('partner_phone')
            
            logger.info(f"–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞: {partner_code}, –¢–µ–ª–µ—Ñ–æ–Ω: {partner_phone}")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
            current_auth_status = await auth_service.get_user_auth_status(user.id)
            logger.info(f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {current_auth_status}")
            
            # –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            logger.info("–ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...")
            auth_result = await auth_service.find_and_update_user(partner_code, partner_phone, user.id)
            logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {auth_result}")
            
            if auth_result:
                await update.message.reply_text(
                    "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MarketingBot! üéØ",
                    reply_markup=ReplyKeyboardRemove()
                )
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º SPA –º–µ–Ω—é
                SPA_MENU_URL = get_spa_menu_url()
                if SPA_MENU_URL:
                    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ —Å –∫–Ω–æ–ø–∫–æ–π "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
                    keyboard = [
                        [KeyboardButton(
                            text="üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
                            web_app=WebAppInfo(url=SPA_MENU_URL)
                        )]
                    ]
                    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=False)
                    
                    await update.message.reply_text(
                        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–∑–¥–µ–ª–∞–º.",
                        reply_markup=reply_markup
                    )
                else:
                    await update.message.reply_text(
                        "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–¥–∞—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É."
                    )
            else:
                logger.warning(f"–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} - –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                logger.warning(f"–ò—Å–∫–∞–ª–∏: –∫–æ–¥={partner_code}, —Ç–µ–ª–µ—Ñ–æ–Ω={partner_phone}")
                
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                try:
                    from sheets_gateway import normalize_phone
                    phone_norm = normalize_phone(partner_phone)
                    logger.info(f"–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω: {phone_norm}")
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º async –º–µ—Ç–æ–¥ –∏–∑ auth_service)
                    # row = await auth_service._find_row_by_partner_and_phone(partner_code, phone_norm)  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                    if row:
                        logger.error(f"–û–®–ò–ë–ö–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç—Ä–æ–∫–µ {row}, –Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å!")
                    else:
                        logger.info("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: {e}")
                
                keyboard_button = KeyboardButton(
                    text="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é",
                    web_app=WebAppInfo(url=get_web_app_url())
                )
                reply_markup = ReplyKeyboardMarkup.from_button(keyboard_button, resize_keyboard=True)
                await update.message.reply_text(
                    "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n\n"
                    "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    reply_markup=reply_markup
                )
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –∏–∑ Web App: {e}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        except Exception as e:
            logger.error(f"–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ web_app_data_handler: {e}")
            await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞. –ú—ã —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ–º –Ω–∞–¥ —ç—Ç–∏–º.")

    return handle_data


def appeals_command_handler(auth_service: AuthService, appeals_service: AppealsService):
    """–§–∞–±—Ä–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã /appeals –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
    async def handle_appeals(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /appeals –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if not await auth_service.get_user_auth_status(user.id):
            await update.message.reply_text(
                "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ /start."
            )
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
        if not appeals_service or not appeals_service.is_available():
            await update.message.reply_text(
                "–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ."
            )
            return

        try:
            appeals = await appeals_service.get_user_appeals(user.id)
            
            if not appeals:
                await update.message.reply_text(
                    "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ."
                )
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π
            message = "üìã –í–∞—à–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è:\n\n"
            for i, appeal in enumerate(appeals, 1):
                status_emoji = {
                    '–Ω–æ–≤–æ–µ': 'üÜï',
                    '–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ': '‚è≥',
                    '—Ä–µ—à–µ–Ω–æ': '‚úÖ',
                    '–∑–∞–∫—Ä—ã—Ç–æ': 'üîí'
                }.get(appeal.get('—Å—Ç–∞—Ç—É—Å', '').lower(), '‚ùì')
                
                message += f"{i}. {status_emoji} {appeal.get('—Å—Ç–∞—Ç—É—Å', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')}\n"
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è (–ø–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏)
                appeals_text = appeal.get('—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π', '')
                if appeals_text:
                    lines = appeals_text.split('\n')
                    recent_appeals = lines[:2]  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –æ–±—Ä–∞—â–µ–Ω–∏—è
                    for appeal_line in recent_appeals:
                        if appeal_line.strip():
                            message += f"   üìù {appeal_line[:80]}{'...' if len(appeal_line) > 80 else ''}\n"
                    
                    if len(lines) > 2:
                        message += f"   ... –∏ –µ—â—ë {len(lines) - 2} –æ–±—Ä–∞—â–µ–Ω–∏–π\n"
                
                if appeal.get('—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç'):
                    message += f"   üí¨ –û—Ç–≤–µ—Ç: {appeal.get('—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç', '')[:100]}{'...' if len(appeal.get('—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç', '')) > 100 else ''}\n"
                message += f"   üïí {appeal.get('–≤—Ä–µ–º—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', '')}\n\n"

            await update.message.reply_text(message)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    return handle_appeals


def promotions_command_handler(auth_service: AuthService):
    """–§–∞–±—Ä–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã /promotions –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ü–∏–π."""
    async def handle_promotions(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /promotions –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if not await auth_service.get_user_auth_status(user.id):
            await update.message.reply_text(
                "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–∫—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ /start."
            )
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π
        if not is_promotions_available():
            await update.message.reply_text(
                "–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ."
            )
            return

        try:
            # –ü–æ–ª—É—á–∞–µ–º JSON —Å –∞–∫—Ü–∏—è–º–∏
            promotions_json = get_promotions_json()
            promotions_data = json.loads(promotions_json)
            
            if not promotions_data:
                await update.message.reply_text(
                    "üéâ –ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è\n\n"
                    "–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –Ω–µ—Ç. "
                    "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!"
                )
                return

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–∫—Ü–∏—è–º–∏
            message = "üéâ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è:\n\n"
            for i, promotion in enumerate(promotions_data, 1):
                message += f"{i}. **{promotion.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}**\n"
                message += f"   üìÖ {promotion.get('start_date', '')} - {promotion.get('end_date', '')}\n"
                message += f"   üìù {promotion.get('description', '')[:100]}{'...' if len(promotion.get('description', '')) > 100 else ''}\n\n"

            # –î–æ–±–∞–≤–ª—è–µ–º JSON –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
            if user.id == int(os.getenv('ADMIN_TELEGRAM_ID', '0')):
                message += f"\nüìä JSON –¥–∞–Ω–Ω—ã–µ:\n```json\n{promotions_json}\n```"

            await update.message.reply_text(
                message,
                parse_mode='Markdown'
            )
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ü–∏–π: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    return handle_promotions

async def handle_promotions_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –∞–∫—Ü–∏–π –æ—Ç WebApp."""
    user = update.effective_user
    logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∞–∫—Ü–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º JSON —Å –∞–∫—Ü–∏—è–º–∏
        from promotions_api import get_promotions_json, is_promotions_available
        from sheets_gateway import AsyncGoogleSheetsGateway
        
        # –°–æ–∑–¥–∞–µ–º gateway –¥–ª—è promotions
        promotions_gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='promotions')
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π
        if not await is_promotions_available(promotions_gateway):
            await update.message.reply_text(
                "–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ."
            )
            return
        
        promotions_json = await get_promotions_json(promotions_gateway)
        promotions_data = json.loads(promotions_json)
        
        if not promotions_data:
            await update.message.reply_text(
                "üéâ –ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è\n\n"
                "–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –Ω–µ—Ç. "
                "–°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!"
            )
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–∫—Ü–∏—è–º–∏
        message = "üéâ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è:\n\n"
        for i, promotion in enumerate(promotions_data, 1):
            message += f"{i}. **{promotion.get('title', '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}**\n"
            message += f"   üìÖ {promotion.get('start_date', '')} - {promotion.get('end_date', '')}\n"
            message += f"   üìù {promotion.get('description', '')[:100]}{'...' if len(promotion.get('description', '')) > 100 else ''}\n\n"
        
        await update.message.reply_text(
            message,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –∞–∫—Ü–∏–π: {e}")
        await update.message.reply_text(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


def chat_handler(auth_service: AuthService, openai_service: OpenAIService, appeals_service: AppealsService):
    """–§–∞–±—Ä–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —á–∞—Ç–∞ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ Threads API.

    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º. –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º OpenAIService ‚Äî –≤–µ–∂–ª–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    async def handle_chat(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        user = update.effective_user
        text = update.effective_message.text or ""
        logger.info(f"CHAT_HANDLER: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.id}: {text}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        auth_status = auth_service.get_user_auth_status(user.id)
        logger.info(f"–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {auth_status}")
        
        if not auth_status:
            await update.message.reply_text(
                "‚ùå –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è.\n\n"
                "–ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."
            )
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é (—É–±—Ä–∞–Ω—ã –∫–Ω–æ–ø–∫–∏ "–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É" –∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º")

        # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
        if appeals_service and appeals_service.is_available():
            try:
                logger.info(f"–ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                records = auth_service.worksheet.get_all_records()
                user_data = None
                for record in records:
                    if str(record.get('Telegram ID', '')) == str(user.id):
                        user_data = record
                        break
                
                if user_data:
                    logger.info(f"–ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_data}")
                    result = await appeals_service.create_appeal(
                        code=user_data.get('–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                        phone=user_data.get('–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                        fio=user_data.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                        telegram_id=user.id,
                        text=f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {text}"  # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
                    )
                    logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è: {result}")
                else:
                    logger.warning(f"–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}", exc_info=True)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ü–ï–†–ï–î –≤—ã–∑–æ–≤–æ–º –ò–ò
        is_escalation_request = _is_user_escalation_request(text)
        if is_escalation_request:
            logger.info(f"–û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –±–µ–∑ –≤—ã–∑–æ–≤–∞ –ò–ò")
            try:
                await update.message.reply_text(
                    "–í–∞—à –∑–∞–ø—Ä–æ—Å –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.",
                    reply_markup=create_specialist_button()
                )
                logger.info(f"–ü–æ–∫–∞–∑–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} (–±–µ–∑ –≤—ã–∑–æ–≤–∞ –ò–ò)")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–Ω–æ–ø–∫–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: {e}")
            return

        # –ï—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º –æ–±—â–µ–Ω–∏—è —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
        if appeals_service and appeals_service.is_available():
            try:
                current_status = await appeals_service.get_appeal_status(user.id)
                current_status = str(current_status or '').strip().lower()
                logger.info(f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {current_status}")
                # –†–µ–∂–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: –ª—é–±—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã "–≤ —Ä–∞–±–æ—Ç–µ" –∏–ª–∏ "–ø–µ—Ä–µ–¥–∞–Ω–æ ..." (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
                is_specialist_mode = (
                    current_status == "–≤ —Ä–∞–±–æ—Ç–µ" or
                    current_status == "–ø–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É" or
                    ("–≤ —Ä–∞–±–æ—Ç" in current_status) or
                    ("–ø–µ—Ä–µ–¥–∞–Ω–æ" in current_status)
                )
                if is_specialist_mode:
                    # –†–µ–∂–∏–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º –ò–ò –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    # –°—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω–æ –ª–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É –æ–±—Ä–∞—â–µ–Ω–∏–π
                    try:
                        appeals_service.add_user_message(user.id, text)
                    except Exception:
                        pass
                    # –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
                    try:
                        await appeals_service.set_status_in_work(user.id)
                    except Exception:
                        pass
                    return
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ OpenAI
        if not openai_service or not openai_service.is_enabled():
            await update.message.reply_text(
                "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∞–Ω–æ, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–≤–µ—Ç–∏—Ç –ø–æ–∑–∂–µ."
            )
            return

        # –ò–Ω–¥–∏–∫–∞—Ü–∏—è –Ω–∞–±–æ—Ä–∞
        try:
            await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
        except Exception:
            pass

        try:
            reply = await asyncio.get_event_loop().run_in_executor(
                None, openai_service.ask, user.id, text
            )

            # –ï—Å–ª–∏ –ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ/—Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ–º.
            if not reply:
                logger.warning(f"–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –ò–ò –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                return

            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ò–ò –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            logger.info(f"–û—Ç–≤–µ—Ç –ò–ò –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {reply[:200]}...")
                
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ò–ò –≤ —Ç–∞–±–ª–∏—Ü—É –æ–±—Ä–∞—â–µ–Ω–∏–π
            if appeals_service and appeals_service.is_available():
                try:
                    success = appeals_service.add_ai_response(user.id, reply)
                    if success:
                        logger.info(f"–û—Ç–≤–µ—Ç –ò–ò –∑–∞–ø–∏—Å–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                        # –ï—Å–ª–∏ —Ä–∞–Ω–µ–µ –±—ã–ª–æ '–†–µ—à–µ–Ω–æ' —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –∏ –¥–∏–∞–ª–æ–≥ –≤–æ–∑–≤—Ä–∞—â—ë–Ω –∫ –ò–ò ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–ª—É—é –∑–∞–ª–∏–≤–∫—É
                    else:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç –ò–ò –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –æ—Ç–≤–µ—Ç–∞ –ò–ò: {e}")
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ Markdown
            clean_reply = reply.replace('*', '').replace('_', '').replace('[', '').replace(']', '').replace('`', '')
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            try:
                await update.message.reply_text(
                    clean_reply
                )
                logger.info(f"–û—Ç–≤–µ—Ç –ò–ò –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ò–ò: {e}")
                # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
                await update.message.reply_text(
                    "–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."
                )
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É "–û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", –µ—Å–ª–∏ –ò–ò –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —ç—Å–∫–∞–ª–∞—Ü–∏—é
            is_ai_asking = _is_ai_asking_for_escalation(reply)
            is_confirmation = _is_escalation_confirmation(text)
            
            logger.info(f"–û—Ç–ª–∞–¥–∫–∞ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}:")
            logger.info(f"  - is_ai_asking: {is_ai_asking}")
            logger.info(f"  - is_confirmation: {is_confirmation}")
            logger.info(f"  - text: '{text}'")
            logger.info(f"  - reply: '{reply[:100] if reply else 'None'}...'")
            
            if is_ai_asking:
                # –í—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫–Ω–æ–ø–∫—É –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏, –µ—Å–ª–∏ –ò–ò –≥–æ–≤–æ—Ä–∏—Ç –æ –ø–µ—Ä–µ–¥–∞—á–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
                try:
                    await update.message.reply_text(
                        "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.",
                        reply_markup=create_specialist_button()
                    )
                    logger.info(f"–ü–æ–∫–∞–∑–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id} (–ò–ò –ø—Ä–µ–¥–ª–æ–∂–∏–ª —ç—Å–∫–∞–ª–∞—Ü–∏—é)")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–Ω–æ–ø–∫–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: {e}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ OpenAI: {e}")
            await update.message.reply_text(
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )

    return handle_chat


def callback_query_handler(auth_service: AuthService, appeals_service: AppealsService):
    """–§–∞–±—Ä–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è callback query (–∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏)."""
    async def handle_callback_query(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        query = update.callback_query
        user = update.effective_user
        
        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ callback
        await query.answer()
        
        logger.info(f"Callback query –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {query.data}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if not await auth_service.get_user_auth_status(user.id):
            await query.edit_message_text(
                "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ /start."
            )
            return
        
        if query.data == "contact_specialist":
            # –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
            if appeals_service and appeals_service.is_available():
                try:
                    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                    records = auth_service.worksheet.get_all_records()
                    user_data = None
                    for record in records:
                        if str(record.get('Telegram ID', '')) == str(user.id):
                            user_data = record
                            break
                    
                    if user_data:
                        # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–í —Ä–∞–±–æ—Ç–µ" —Å –∂–µ–ª—Ç–æ–π –∑–∞–ª–∏–≤–∫–æ–π
                        success = appeals_service.set_status_in_work(user.id)
                        if success:
                            await query.edit_message_text(
                                "‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞. "
                                "–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '–í —Ä–∞–±–æ—Ç–µ'. –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–≤–µ—Ç–∏—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
                            )
                        else:
                            await query.edit_message_text(
                                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                            )
                    else:
                        await query.edit_message_text(
                            "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
                        )
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É: {e}")
                    await query.edit_message_text(
                        "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                    )
            else:
                await query.edit_message_text(
                    "‚ùå –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
                )
        else:
            await query.edit_message_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞.")
    
    return handle_callback_query


================================================================================
FILE: ./index.html
SIZE: 14180 bytes
================================================================================

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MarketingBot - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Google Fonts: Outfit for modern premium look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #8A2BE2;
            /* BlueViolet */
            --accent-color: #00BFFF;
            /* DeepSkyBlue */
            --bg-gradient: linear-gradient(135deg, #050505 0%, #1a1a2e 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --error-color: #ff5252;
            --success-color: #00e676;
            --card-radius: 24px;
            --input-radius: 16px;
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Background Ambient Glow */
        .ambient-glow {
            position: fixed;
            top: -20%;
            left: -20%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.2) 0%, transparent 70%);
            filter: blur(80px);
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }

        .ambient-glow-2 {
            position: fixed;
            bottom: -20%;
            right: -20%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, rgba(0, 191, 255, 0.15) 0%, transparent 70%);
            filter: blur(80px);
            z-index: -1;
            animation: float 15s infinite ease-in-out reverse;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(30px, 30px);
            }
        }

        .container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            z-index: 1;
        }

        /* Glass Card */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 32px 24px;
            width: 100%;
            box-shadow: var(--glass-shadow);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #a5a5a5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 5px;
        }

        .input-wrapper {
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            border-radius: var(--input-radius);
            font-size: 16px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            transition: all var(--transition-speed);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.3);
            background: rgba(0, 0, 0, 0.4);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .auth-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary-color), #6a0dad);
            color: #fff;
            border: none;
            border-radius: var(--input-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
            position: relative;
            overflow: hidden;
        }

        .auth-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(138, 43, 226, 0.6);
        }

        .auth-button:hover::after {
            left: 100%;
        }

        .auth-button:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 8px;
            margin-left: 5px;
            display: none;
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .success-message {
            color: var(--success-color);
            font-size: 14px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- Ambient Background -->
    <div class="ambient-glow"></div>
    <div class="ambient-glow-2"></div>

    <div class="container">
        <div class="glass-card">
            <div class="header">
                <h1>üîê –í—Ö–æ–¥</h1>
                <p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</p>
            </div>

            <form id="authForm">
                <div class="form-group">
                    <label for="partnerCode">–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</label>
                    <div class="input-wrapper">
                        <input type="text" id="partnerCode" name="partnerCode" placeholder="123456" maxlength="20"
                            pattern="[0-9]*" inputmode="numeric" required>
                    </div>
                    <div class="error-message" id="partnerCodeError"></div>
                </div>

                <div class="form-group">
                    <label for="partnerPhone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <div class="input-wrapper">
                        <input type="tel" id="partnerPhone" name="partnerPhone" placeholder="89001234567" maxlength="15"
                            required>
                    </div>
                    <div class="error-message" id="partnerPhoneError"></div>
                </div>

                <button type="submit" class="auth-button" id="authButton">
                    –í–æ–π—Ç–∏
                </button>

                <div class="error-message" id="generalError" style="text-align: center; margin-top: 15px;"></div>
                <div class="success-message" id="successMessage"></div>
            </form>

            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <div>–ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ...</div>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –≠–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã
        const form = document.getElementById('authForm');
        const partnerCodeInput = document.getElementById('partnerCode');
        const partnerPhoneInput = document.getElementById('partnerPhone');
        const authButton = document.getElementById('authButton');
        const loading = document.getElementById('loading');
        const generalError = document.getElementById('generalError');
        const successMessage = document.getElementById('successMessage');

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
        [partnerCodeInput, partnerPhoneInput].forEach(input => {
            input.addEventListener('input', function (e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                clearError(input.id + 'Error');
            });
        });

        function clearError(errorId) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.style.display = 'none';
                errorElement.textContent = '';
            }
        }

        function showError(errorId, message) {
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function validateForm() {
            let isValid = true;
            const partnerCode = partnerCodeInput.value.trim();
            const partnerPhone = partnerPhoneInput.value.trim();

            if (!partnerCode) {
                showError('partnerCodeError', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞');
                isValid = false;
            } else if (partnerCode.length < 3) {
                showError('partnerCodeError', '–ú–∏–Ω–∏–º—É–º 3 —Ü–∏—Ñ—Ä—ã');
                isValid = false;
            }

            if (!partnerPhone) {
                showError('partnerPhoneError', '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                isValid = false;
            } else if (partnerPhone.length < 10) {
                showError('partnerPhoneError', '–ú–∏–Ω–∏–º—É–º 10 —Ü–∏—Ñ—Ä');
                isValid = false;
            }

            return isValid;
        }

        // Main Logic
        let isSubmitting = false;

        form.addEventListener('submit', function (e) {
            e.preventDefault();
            clearError('partnerCodeError');
            clearError('partnerPhoneError');
            generalError.style.display = 'none';
            successMessage.style.display = 'none';

            if (isSubmitting) return;

            if (!validateForm()) {
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            isSubmitting = true;
            authButton.disabled = true;
            authButton.style.opacity = '0.7';
            loading.style.display = 'block';

            const partnerCode = partnerCodeInput.value.trim();
            const partnerPhone = partnerPhoneInput.value.trim();

            try {
                // Simulate network delay for better UX
                setTimeout(() => {
                    tg.sendData(JSON.stringify({
                        partner_code: partnerCode,
                        partner_phone: partnerPhone
                    }));

                    showSuccess('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—è–µ–º...');

                    setTimeout(() => {
                        tg.close();
                    }, 1500);
                }, 500); // Added a small delay before sending data
            } catch (error) {
                console.error('Error:', error);
                showError('generalError', '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                isSubmitting = false; // Reset flag on error
                authButton.disabled = false;
                authButton.style.opacity = '1';
                loading.style.display = 'none';
            }
        });

        // Haptic Feedback on focus
        partnerCodeInput.addEventListener('focus', () => {
            if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        });
    </script>
</body>

</html>

================================================================================
FILE: ./init_db.py
SIZE: 1038 bytes
================================================================================

"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
–°–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏.
"""
import os
import sys

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DATABASE_URL –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
if not os.getenv('DATABASE_URL'):
    os.environ['DATABASE_URL'] = 'sqlite:///./db/appeals.db'

from db.database import init_db, engine
from db.models import Base, Appeal, AppealMessage, SpecialistResponse

if __name__ == "__main__":
    print("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    print(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ë–î: {engine.url}")
    
    # –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
    Base.metadata.create_all(bind=engine)
    
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!")
    print("–°–æ–∑–¥–∞–Ω—ã —Ç–∞–±–ª–∏—Ü—ã:")
    print("  - appeals (–æ–±—Ä–∞—â–µ–Ω–∏—è)")
    print("  - appeal_messages (—Å–æ–æ–±—â–µ–Ω–∏—è)")
    print("  - specialist_responses (–æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤)")


================================================================================
FILE: ./menu.html
SIZE: 63878 bytes
================================================================================

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Marketing Bot Menu</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Google Fonts: Outfit for modern premium look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #8A2BE2;
            /* BlueViolet */
            --accent-color: #00BFFF;
            /* DeepSkyBlue */
            --bg-gradient: linear-gradient(135deg, #050505 0%, #1a1a2e 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --success-color: #00e676;
            --card-radius: 20px;
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
            /* Space for bottom nav */
        }

        /* Background Ambient Glow */
        .ambient-glow {
            position: fixed;
            top: -20%;
            left: -20%;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.2) 0%, transparent 70%);
            filter: blur(80px);
            z-index: -1;
            animation: float 10s infinite ease-in-out;
        }

        .ambient-glow-2 {
            position: fixed;
            bottom: -20%;
            right: -20%;
            width: 60%;
            height: 60%;
            background: radial-gradient(circle, rgba(0, 191, 255, 0.15) 0%, transparent 70%);
            filter: blur(80px);
            z-index: -1;
            animation: float 15s infinite ease-in-out reverse;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(20px, 20px);
            }
        }

        /* Header */
        header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #a5a5a5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        /* Container */
        .container {
            padding: 0 20px;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Glass Cards */
        .glass-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--glass-shadow);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            position: relative;
            overflow: hidden;
        }

        .glass-card:active {
            transform: scale(0.98);
        }

        /* Menu Grid */
        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 120px;
            cursor: pointer;
        }

        .menu-item-icon {
            font-size: 32px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .menu-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Promotions Section */
        .promotion-card {
            position: relative;
        }

        .promotion-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
        }

        .promotion-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .promotion-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-right: 10px;
        }

        .status-badge {
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 230, 118, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(0, 230, 118, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            box-shadow: 0 0 10px rgba(0, 230, 118, 0.2);
        }

        .promotion-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .promotion-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            border-top: 1px solid var(--glass-border);
            padding-top: 10px;
        }

        .date-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Lists (for Tools, Knowledge, Services) */
        .glass-list {
            list-style: none;
        }

        .glass-list-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .glass-list-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--primary-color);
            transform: translateX(5px);
        }

        .item-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
            font-size: 15px;
        }

        .item-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Accordion (for Services) */
        .accordion-item {
            margin-bottom: 10px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
        }

        .accordion-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        .accordion-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .accordion-header.active {
            background: rgba(138, 43, 226, 0.2);
            border-left: 3px solid var(--primary-color);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 15px;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: rgba(0, 0, 0, 0.2);
            padding: 0;
        }

        .accordion-content.open {
            max-height: 5000px;
            padding: 15px;
            /* Arbitrary large height */
        }

        .accordion-inner-list {
            list-style: none;
            padding: 15px;
        }

        .accordion-inner-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 14px;
            color: var(--text-secondary);
        }

        .accordion-inner-list li:last-child {
            border-bottom: none;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            height: 140px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            height: 60px;
            background: rgba(20, 20, 35, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 10px;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            width: 60px;
        }

        .nav-item.active {
            color: var(--accent-color);
        }

        .nav-item.active .nav-icon {
            transform: translateY(-5px);
            text-shadow: 0 0 10px var(--accent-color);
        }

        .nav-icon {
            font-size: 20px;
            transition: transform 0.3s;
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Error State */
        .error-state {
            text-align: center;
            padding: 40px 20px;
            color: #ff5252;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .profile-modal.open {
            display: flex;
        }

        .profile-card {
            background: linear-gradient(135deg, rgba(15, 15, 30, 0.95), rgba(30, 30, 60, 0.95));
            border-radius: 20px;
            padding: 24px 20px 20px;
            width: 90%;
            max-width: 360px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 2px solid var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .profile-username {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 14px;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .profile-field-label {
            color: var(--text-secondary);
        }

        .profile-field-value {
            font-weight: 500;
        }

        .profile-close {
            position: absolute;
            top: 10px;
            right: 14px;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>

    <!-- Ambient Background -->
    <div class="ambient-glow"></div>
    <div class="ambient-glow-2"></div>

    <header>
        <div class="logo">Marketing Bot</div>
        <div class="user-profile">üë§</div>
    </header>

    <div class="container">
        <!-- Main Menu Grid -->
        <div id="home-section" class="section active">
            <h2>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <div class="menu-grid">
                <div class="glass-card menu-item" onclick="switchTab('promotions')">
                    <div class="menu-item-icon">üî•</div>
                    <div class="menu-item-title">–ê–∫—Ü–∏–∏</div>
                </div>
                <div class="glass-card menu-item" onclick="switchTab('services')">
                    <div class="menu-item-icon">üéØ</div>
                    <div class="menu-item-title">–£—Å–ª—É–≥–∏</div>
                </div>
            </div>

            <h2>üì¢ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏</h2>
            <div id="promotions-container">
                <!-- Content will be loaded here -->
                <div class="glass-card skeleton skeleton-card"></div>
                <div class="glass-card skeleton skeleton-card"></div>
            </div>
        </div>

        <!-- Promotions Section -->
        <div id="promotions-section" class="section">
            <h2>üî• –í—Å–µ –∞–∫—Ü–∏–∏</h2>
            <div id="all-promotions-container">
                <!-- Content will be loaded here -->
            </div>
        </div>

        <!-- Tools Section -->
        <div id="tools-section" class="section">
            <h2>üõ† –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
            <ul class="glass-list">
                <li class="glass-list-item">
                    <div class="item-title">üì± CRM –ö–û–°–ú–û–°</div>
                    <div class="item-desc">–†–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑–æ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–¥–µ–ª–∫–∞–º–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üè† –ê–≤–∏—Ç–æ.–ü—Ä–æ</div>
                    <div class="item-desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–≥—Ä—É–∑–∫–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã</div>
                    <div class="item-desc">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –∫–æ–º–∏—Å—Å–∏–π –∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üìã –®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
                    <div class="item-desc">–ì–æ—Ç–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üîç –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤</div>
                    <div class="item-desc">–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤</div>
                </li>
            </ul>
        </div>

        <!-- Analytics Section -->
        <div id="analytics-section" class="section">
            <h2>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù</h2>
            <ul class="glass-list">
                <li class="glass-list-item">
                    <div class="item-title">üìà –û—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º</div>
                    <div class="item-desc">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–π</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                    <div class="item-desc">–ê–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã –∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üè† –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤</div>
                    <div class="item-desc">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º –∏ –∏—Ö —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å</div>
                    <div class="item-desc">–û—Ç—á–µ—Ç—ã –ø–æ –¥–æ—Ö–æ–¥–∞–º, —Ä–∞—Å—Ö–æ–¥–∞–º –∏ –ø—Ä–∏–±—ã–ª–∏</div>
                </li>
            </ul>
        </div>

        <!-- Knowledge Section -->
        <div id="knowledge-section" class="section">
            <h2>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
            <ul class="glass-list">
                <li class="glass-list-item">
                    <div class="item-title">üìñ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</div>
                    <div class="item-desc">–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ –ø–æ —Ä–∞–±–æ—Ç–µ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">‚ùì FAQ –∏ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º</div>
                    <div class="item-desc">–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üéì –û–±—É—á–∞—é—â–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
                    <div class="item-desc">–í–∏–¥–µ–æ—É—Ä–æ–∫–∏, –≤–µ–±–∏–Ω–∞—Ä—ã –∏ –∫—É—Ä—Å—ã</div>
                </li>
                <li class="glass-list-item">
                    <div class="item-title">üìã –ß–µ–∫-–ª–∏—Å—Ç—ã –∏ –ø–∞–º—è—Ç–∫–∏</div>
                    <div class="item-desc">–ì–æ—Ç–æ–≤—ã–µ —á–µ–∫-–ª–∏—Å—Ç—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∑–∞–¥–∞—á</div>
                </li>
            </ul>
        </div>

        <!-- Services Section (Accordion) -->
        <div id="services-section" class="section">
            <h2>üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏</h2>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>üì±</span> –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π</div>
                    <div>‚ñº</div>
                </div>
                <div class="accordion-content">
                    <ul class="accordion-inner-list">
                        <li>–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π</li>
                        <li>–ü–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞</li>
                        <li>–í–µ–¥–µ–Ω–∏–µ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–í–ö, Instagram, –î–∑–µ–Ω)</li>
                        <li>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞</li>
                        <li>–§–æ—Ç–æ- –∏ –≤–∏–¥–µ–æ—Å—ä–µ–º–∫–∞ –ª—é–¥–µ–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>‚úçÔ∏è</span> –¢–µ–∫—Å—Ç—ã –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥</div>
                    <div>‚ñº</div>
                </div>
                <div class="accordion-content">
                    <ul class="accordion-inner-list">
                        <li>–ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π, –∑–∞–º–µ—Ç–∫–∏</li>
                        <li>–ò–Ω—Ç–µ—Ä–≤—å—é –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –≤–∏–¥–µ–æ</li>
                        <li>–í–µ–¥–µ–Ω–∏–µ Telegram-–∫–∞–Ω–∞–ª–∞</li>
                        <li>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>üé®</span> –î–∏–∑–∞–π–Ω –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥</div>
                    <div>‚ñº</div>
                </div>
                <div class="accordion-content">
                    <ul class="accordion-inner-list">
                        <li>–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω (–±—É–∫–ª–µ—Ç—ã, –∫–∞—Ç–∞–ª–æ–≥–∏)</li>
                        <li>–í–µ–±-–±–∞–Ω–Ω–µ—Ä—ã –∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</li>
                        <li>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω: –ª–æ–≥–æ—Ç–∏–ø—ã, –±—Ä–µ–Ω–¥–∏–Ω–≥</li>
                        <li>3D-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>üìà</span> –†–µ–∫–ª–∞–º–∞ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</div>
                    <div>‚ñº</div>
                </div>
                <div class="accordion-content">
                    <ul class="accordion-inner-list">
                        <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã</li>
                        <li>–£—Å–ª—É–≥–∏ SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</li>
                        <li>–ü—Ä–æ–¥—é—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–≤ –∫—É—Ä—Å–æ–≤</li>
                        <li>SEO-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</li>
                    </ul>
                </div>
            </div>

            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div class="accordion-title"><span>ü§ñ</span> –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è</div>
                    <div>‚ñº</div>
                </div>
                <div class="accordion-content">
                    <ul class="accordion-inner-list">
                        <li>–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞</li>
                        <li>–ß–∞—Ç-–±–æ—Ç—ã –∏ —á–∞—Ç-–±–æ—Ç—ã —Å –ò–ò</li>
                        <li>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ –∏ —Å–∞–π—Ç–æ–≤</li>
                        <li>–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å CRM</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="profile-modal">
        <div class="profile-card">
            <div class="profile-close" onclick="closeProfileModal()">‚úï</div>
            <div class="profile-avatar" id="profile-avatar">
                <span>üë§</span>
            </div>
            <div class="profile-name" id="profile-name">–ü—Ä–æ—Ñ–∏–ª—å</div>
            <div class="profile-username" id="profile-username"></div>
            <div class="profile-field">
                <div class="profile-field-label">–ö–æ–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</div>
                <div class="profile-field-value" id="profile-code">‚Äî</div>
            </div>
            <div class="profile-field">
                <div class="profile-field-label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                <div class="profile-field-value" id="profile-phone">‚Äî</div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <span class="nav-icon">üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="nav-item" onclick="switchTab('promotions')">
            <span class="nav-icon">üî•</span>
            <span>–ê–∫—Ü–∏–∏</span>
        </div>
        <div class="nav-item" onclick="switchTab('services')">
            <span class="nav-icon">üéØ</span>
            <span>–£—Å–ª—É–≥–∏</span>
        </div>
    </nav>

    <script>
        // --- Logic ---
        const tg = window.Telegram.WebApp;
        tg.expand();

        // API Configuration
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API_BASE_URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Google Apps Script > Cloudflare Tunnel > –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
        
        // Google Apps Script URL
        // –í–ê–ñ–ù–û: –ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Google Apps Script —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –∏–∑ –æ–∫–Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
        // –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –µ–≥–æ –∑–¥–µ—Å—å. URL –±—É–¥–µ—Ç –≤–∏–¥–∞: https://script.google.com/macros/s/.../exec
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLWWXHpDinqz0F6-Nkf1OBXv0IpHx66J3D-P_4MA5N5qSO8QmaJh5JlUjTYJuLUt0BBg/exec';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–∫—Ä—ã—Ç–æ –ª–∏ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram WebApp
        const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
        const isGitHubPages = window.location.hostname.includes('github.io') || 
                              window.location.hostname.includes('github.com');
        
        let API_BASE_URL;
        
        if (isGitHubPages) {
            // –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ GitHub Pages
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ Google Apps Script (–ª–æ–∫–∞–ª—å–Ω—ã–π API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
            API_BASE_URL = null;
        } else {
            // –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å
            API_BASE_URL = window.location.origin;
        }
        
        console.log('API_BASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', API_BASE_URL);
        console.log('Google Apps Script URL:', GOOGLE_APPS_SCRIPT_URL || '–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
        console.log('Hostname:', window.location.hostname);
        console.log('Is GitHub Pages:', isGitHubPages);
        console.log('Is Telegram WebApp:', isTelegramWebApp);

        // State
        let promotionsCache = null;

        // Telegram user info
        const tgUser = tg?.initDataUnsafe?.user || null;

        // Navigation Logic
        function switchTab(tabName) {
            // Update Bottom Nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            // Map tab names to nav indices
            const navItems = document.querySelectorAll('.nav-item');
            if (tabName === 'home') navItems[0].classList.add('active');
            if (tabName === 'promotions') navItems[1].classList.add('active');
            if (tabName === 'services') navItems[2].classList.add('active');

            // Switch Sections
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));

            const targetSection = document.getElementById(`${tabName}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
            } else {
                document.getElementById('home-section').classList.add('active');
            }

            // Load data if needed
            if (tabName === 'promotions' || tabName === 'home') {
                loadPromotions();
            }

            // Haptic Feedback
            if (tg.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Accordion Logic
        function toggleAccordion(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('open');

            if (tg.HapticFeedback) {
                tg.HapticFeedback.selectionChanged();
            }
        }

        // Data Fetching
        async function fetchPromotions() {
            // –°–ø–∏—Å–æ–∫ URL –¥–ª—è –ø–æ–ø—ã—Ç–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
            const urlsToTry = [];
            
            // 1. Google Apps Script (–æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫)
            if (GOOGLE_APPS_SCRIPT_URL && GOOGLE_APPS_SCRIPT_URL.trim()) {
                urlsToTry.push({
                    url: GOOGLE_APPS_SCRIPT_URL,
                    isGas: true,
                    name: 'Google Apps Script'
                });
                console.log('‚úÖ Google Apps Script URL –¥–æ–±–∞–≤–ª–µ–Ω:', GOOGLE_APPS_SCRIPT_URL);
            } else {
                console.warn('‚ö†Ô∏è Google Apps Script URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø—É—Å—Ç');
            }
            
            // 2. –õ–æ–∫–∞–ª—å–Ω—ã–π API (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ)
            if (API_BASE_URL && !isGitHubPages) {
                urlsToTry.push({
                    url: `${API_BASE_URL}/api/promotions`,
                    isGas: false,
                    name: 'Local API'
                });
            }
            
            console.log(`üì° –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏ —Å ${urlsToTry.length} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:`, urlsToTry.map(u => `${u.name}: ${u.url}`));
            
            for (let i = 0; i < urlsToTry.length; i++) {
                const { url, isGas, name } = urlsToTry[i];
                const isLast = i === urlsToTry.length - 1;
                
                try {
                    console.log(`üîÑ [${i + 1}/${urlsToTry.length}] –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏ —Å: ${name} (${url})`);
                    
                    // –î–ª—è Google Apps Script –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    // Google Apps Script –¥–µ–ª–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ script.googleusercontent.com
                    // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å CORS
                    const fetchOptions = {
                        method: 'GET',
                        mode: 'cors', // –í–∞–∂–Ω–æ: 'cors' –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º–∏
                        cache: 'no-cache',
                        redirect: 'follow', // –°–ª–µ–¥—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞–º (Google Apps Script —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ googleusercontent.com)
                        credentials: 'omit', // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookies
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º timeout —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
                    if (typeof AbortSignal !== 'undefined' && AbortSignal.timeout) {
                        fetchOptions.signal = AbortSignal.timeout(20000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 20 —Å–µ–∫—É–Ω–¥ –¥–ª—è GAS
                    }
                    
                    let response;
                    try {
                        console.log(`üåê –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ ${name}...`);
                        response = await fetch(url, fetchOptions);
                        console.log(`‚úÖ –ó–∞–ø—Ä–æ—Å –∫ ${name} –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ`);
                    } catch (fetchError) {
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (CORS, DNS, etc.)
                        console.error(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ ${name}:`, fetchError);
                        console.error(`   –¢–∏–ø –æ—à–∏–±–∫–∏: ${fetchError.name}`);
                        console.error(`   –°–æ–æ–±—â–µ–Ω–∏–µ: ${fetchError.message}`);
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ CORS –æ—à–∏–±–∫–∞, –¥–∞–µ–º –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        if (fetchError.name === 'TypeError' && fetchError.message.includes('Failed to fetch')) {
                            if (isGas) {
                                console.error(`   üí° CORS –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Google Apps Script. –†–µ—à–µ–Ω–∏–µ:`);
                                console.error(`      1. –û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script`);
                                console.error(`      2. "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"`);
                                console.error(`      3. –ù–∞–∂–º–∏—Ç–µ ‚úèÔ∏è (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å) –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏`);
                                console.error(`      4. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ "–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø" = "–í—Å–µ"`);
                                console.error(`      5. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏`);
                                console.error(`      6. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞`);
                            } else {
                                console.error(`   üí° –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ ${name}`);
                            }
                        }
                        
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        throw fetchError;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                    console.log(`üìä ${name} - Response status: ${response.status}, ok: ${response.ok}, type: ${response.type}, redirected: ${response.redirected}`);
                    
                    // –î–ª—è Google Apps Script —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ googleusercontent.com - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                    if (isGas && response.redirected) {
                        console.log(`‚úÖ ${name} - –†–µ–¥–∏—Ä–µ–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è Google Apps Script)`);
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type
                    const contentType = response.headers.get('content-type') || '';
                    console.log(`üìã ${name} - Content-Type: ${contentType}`);
                    
                    // –î–ª—è Google Apps Script –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Content-Type –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
                    if (isGas && contentType && !contentType.includes('json') && !contentType.includes('text')) {
                        console.warn(`‚ö†Ô∏è ${name} - –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π Content-Type: ${contentType}. –û–∂–∏–¥–∞–ª—Å—è JSON.`);
                    }
                    
                    // –î–ª—è Google Apps Script, –¥–∞–∂–µ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ ok, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç
                    // (GAS –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 200 —Å —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º –∏–ª–∏ –¥—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã)
                    // –ù–æ –µ—Å–ª–∏ —ç—Ç–æ —è–≤–Ω–∞—è –æ—à–∏–±–∫–∞ (4xx, 5xx) –∏ –Ω–µ GAS, —Ç–æ –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫
                    if (!response.ok && response.status !== 0 && !isGas && response.status >= 400) {
                        const errorText = await response.text().catch(() => '');
                        console.warn(`‚ö†Ô∏è HTTP error –æ—Ç ${name}! status: ${response.status}, body: ${errorText.substring(0, 200)}`);
                        if (response.status >= 400 && response.status < 500) {
                            if (!isLast) {
                                console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                                continue;
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    let responseText;
                    try {
                        responseText = await response.text();
                    } catch (textError) {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç ${name}:`, textError);
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        throw textError;
                    }
                    
                    console.log(`üì• ${name} - –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω (${responseText.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π
                    if (!responseText || responseText.trim().length === 0) {
                        console.warn(`‚ö†Ô∏è ${name} –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç`);
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        throw new Error('Empty response');
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (GAS –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å HTML –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
                    const trimmedText = responseText.trim();
                    if (trimmedText.startsWith('<') || trimmedText.startsWith('<!DOCTYPE') || trimmedText.startsWith('<html')) {
                        console.error(`‚ùå ${name} –≤–µ—Ä–Ω—É–ª HTML –≤–º–µ—Å—Ç–æ JSON. –≠—Ç–æ –º–æ–∂–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å:`);
                        console.error(`   1. URL –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ`);
                        console.error(`   2. –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –≤ Google Apps Script)`);
                        console.error(`   3. –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ —Å–∫—Ä–∏–ø—Ç–µ`);
                        console.error(`üìÑ –ü–µ—Ä–≤—ã–µ 1000 —Å–∏–º–≤–æ–ª–æ–≤ HTML:`, trimmedText.substring(0, 1000));
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        throw new Error('Received HTML instead of JSON. Check Google Apps Script deployment settings.');
                    }
                    
                    console.log(`üìÑ ${name} - –ü–µ—Ä–≤—ã–µ 500 —Å–∏–º–≤–æ–ª–æ–≤:`, responseText.substring(0, 500));
                    
                    // –ü–∞—Ä—Å–∏–º JSON
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç ${name}:`, parseError);
                        console.error(`üìÑ –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ (–ø–µ—Ä–≤—ã–µ 2000 —Å–∏–º–≤–æ–ª–æ–≤):`, responseText.substring(0, 2000));
                        
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        throw new Error(`Invalid JSON response: ${parseError.message}`);
                    }
                    
                    console.log(`‚úÖ ${name} - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã:`, data);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    if (Array.isArray(data)) {
                        if (data.length === 0) {
                            console.warn(`‚ö†Ô∏è ${name} –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∞–∫—Ü–∏–π`);
                            if (!isLast) {
                                console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                                continue;
                            }
                            return []; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫
                        }
                        console.log(`‚úÖ ‚úÖ ‚úÖ –ê–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ —Å: ${name} (${data.length} –∞–∫—Ü–∏–π)`);
                        return data;
                    } else if (data.promotions && Array.isArray(data.promotions)) {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ –æ–±—ä–µ–∫—Ç
                        console.log(`‚úÖ ‚úÖ ‚úÖ –ê–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ —Å: ${name} (${data.promotions.length} –∞–∫—Ü–∏–π)`);
                        return data.promotions;
                    } else if (data.error) {
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ, –ø—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π URL
                        console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç ${name}:`, data.error);
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        return { error: data.error };
                    } else {
                        // –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
                        console.warn(`‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç ${name}:`, data);
                        if (!isLast) {
                            console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                            continue;
                        }
                        return { error: '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö' };
                    }
                } catch (error) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å ${name} (${url}):`, error);
                    console.error(`   –¢–∏–ø –æ—à–∏–±–∫–∏: ${error.name}`);
                    console.error(`   –°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}`);
                    if (error.stack) {
                        console.error(`   Stack:`, error.stack);
                    }
                    
                    // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π URL, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π
                    if (!isLast) {
                        console.log(`‚è≠Ô∏è –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫...`);
                        continue;
                    }
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π URL, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
                    console.error('‚ùå ‚ùå ‚ùå –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ü–∏–π –Ω–µ —É–¥–∞–ª–∏—Å—å. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞:', error);
                    return { error: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏' };
                }
            }
            
            return { error: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏: –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã' };
        }

        function _escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderPromotions(promotions, container, isPreview = false) {
            if (!container) return;

            const list = Array.isArray(promotions) ? promotions : [];
            // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ü–∏—è
            const items = isPreview ? list.slice(0, 1) : list;

            // Clear skeleton / previous content
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="glass-card promotion-card">
                        <div class="promotion-header">
                            <div class="promotion-title">–ê–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                            <div class="status-badge">–ü–£–°–¢–û</div>
                        </div>
                        <div class="promotion-desc">–°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ.</div>
                    </div>
                `;
                return;
            }

            for (const p of items) {
                const title = _escapeHtml(p.title || '–ê–∫—Ü–∏—è');
                const desc = _escapeHtml(p.description || '');
                const status = _escapeHtml(p.status || '');
                const start = _escapeHtml(p.start_date || '');
                const end = _escapeHtml(p.end_date || '');
                const content = (p.content || '').toString().trim();

                let mediaHtml = '';
                if (content) {
                    const lower = content.toLowerCase();
                    const isDataImage = lower.startsWith('data:image/');
                    const isHttp = lower.startsWith('http://') || lower.startsWith('https://');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–æ—Å—Ç–∏–Ω–≥–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Google Drive, Imgur, etc.)
                    const isImageHosting = isHttp && (
                        lower.includes('googleusercontent.com') ||  // Google Drive –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
                        lower.includes('drive.google.com') ||      // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ Google Drive —Å—Å—ã–ª–∫–∏
                        lower.includes('googleapis.com') ||        // Google API —Å—Å—ã–ª–∫–∏
                        lower.includes('imgur.com') ||             // Imgur
                        lower.includes('imgbb.com') ||             // ImgBB
                        lower.includes('cloudinary.com')           // Cloudinary
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
                    const hasImageExtension = isHttp && (
                        lower.endsWith('.jpg') || 
                        lower.endsWith('.jpeg') || 
                        lower.endsWith('.png') || 
                        lower.endsWith('.gif') || 
                        lower.endsWith('.webp') ||
                        lower.endsWith('.svg')
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
                    const isVideoUrl = isHttp && (
                        lower.endsWith('.mp4') || 
                        lower.endsWith('.webm') || 
                        lower.endsWith('.mov') ||
                        lower.endsWith('.avi')
                    );
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ HTTP —Å—Å—ã–ª–∫–∞ –∏ –Ω–µ –≤–∏–¥–µ–æ, –∏ (–∏–º–µ–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ò–õ–ò –∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
                    // –¢–æ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                    const isImageUrl = isHttp && !isVideoUrl && (hasImageExtension || isImageHosting);

                    if (isDataImage || isImageUrl) {
                        mediaHtml = `<img src="${_escapeHtml(content)}" alt="promotion" style="width:100%; border-radius:12px; margin:10px 0; display:block;" loading="lazy" />`;
                    } else if (isVideoUrl) {
                        mediaHtml = `<video src="${_escapeHtml(content)}" controls style="width:100%; border-radius:12px; margin:10px 0; display:block;"></video>`;
                    }
                }

                const dateText = (start || end) ? `${start}${start && end ? ' ‚Äî ' : ''}${end}` : '–ë–µ–∑ –¥–∞—Ç—ã';
                const link = (p.link || '').toString().trim();
                
                // –ö–Ω–æ–ø–∫–∞ —Å–æ —Å—Å—ã–ª–∫–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const linkButtonHtml = link ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                        <a href="${_escapeHtml(link)}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(138, 43, 226, 0.3); border: 1px solid var(--primary-color); border-radius: 8px; color: white; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                            üìé –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                        </a>
                    </div>
                ` : '';

                const card = document.createElement('div');
                card.className = 'glass-card promotion-card';
                card.innerHTML = `
                    <div class="promotion-header">
                        <div class="promotion-title">${title}</div>
                        <div class="status-badge">${status ? _escapeHtml(status) : '–ê–ö–¢–ò–í–ù–ê'}</div>
                    </div>
                    ${mediaHtml}
                    <div class="promotion-desc">${desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                    <div class="promotion-footer">
                        <div class="date-info">üìÖ ${dateText}</div>
                    </div>
                    ${linkButtonHtml}
                `;
                container.appendChild(card);
            }
        }

        function renderPromotionsAccordion(promotions, container) {
            if (!container) return;

            const list = Array.isArray(promotions) ? promotions : [];

            // Clear skeleton / previous content
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="glass-card promotion-card">
                        <div class="promotion-header">
                            <div class="promotion-title">–ê–∫—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                            <div class="status-badge">–ü–£–°–¢–û</div>
                        </div>
                        <div class="promotion-desc">–°–µ–π—á–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π. –ó–∞–≥–ª—è–Ω–∏—Ç–µ –ø–æ–∑–∂–µ.</div>
                    </div>
                `;
                return;
            }

            for (const p of list) {
                const title = _escapeHtml(p.title || '–ê–∫—Ü–∏—è');
                const desc = _escapeHtml(p.description || '');
                const status = _escapeHtml(p.status || '');
                const start = _escapeHtml(p.start_date || '');
                const end = _escapeHtml(p.end_date || '');
                const content = (p.content || '').toString().trim();
                const link = (p.link || '').toString().trim();

                let mediaHtml = '';
                if (content) {
                    const lower = content.toLowerCase();
                    const isDataImage = lower.startsWith('data:image/');
                    const isHttp = lower.startsWith('http://') || lower.startsWith('https://');
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–æ—Å—Ç–∏–Ω–≥–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Google Drive, Imgur, etc.)
                    const isImageHosting = isHttp && (
                        lower.includes('googleusercontent.com') ||
                        lower.includes('drive.google.com') ||
                        lower.includes('googleapis.com') ||
                        lower.includes('imgur.com') ||
                        lower.includes('imgbb.com') ||
                        lower.includes('cloudinary.com')
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
                    const hasImageExtension = isHttp && (
                        lower.endsWith('.jpg') || 
                        lower.endsWith('.jpeg') || 
                        lower.endsWith('.png') || 
                        lower.endsWith('.gif') || 
                        lower.endsWith('.webp') ||
                        lower.endsWith('.svg')
                    );
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
                    const isVideoUrl = isHttp && (
                        lower.endsWith('.mp4') || 
                        lower.endsWith('.webm') || 
                        lower.endsWith('.mov') ||
                        lower.endsWith('.avi')
                    );
                    
                    const isImageUrl = isHttp && !isVideoUrl && (hasImageExtension || isImageHosting);

                    if (isDataImage || isImageUrl) {
                        mediaHtml = `<img src="${_escapeHtml(content)}" alt="promotion" style="width:100%; border-radius:12px; margin:10px 0; display:block;" loading="lazy" />`;
                    } else if (isVideoUrl) {
                        mediaHtml = `<video src="${_escapeHtml(content)}" controls style="width:100%; border-radius:12px; margin:10px 0; display:block;"></video>`;
                    }
                }

                const dateText = (start || end) ? `${start}${start && end ? ' ‚Äî ' : ''}${end}` : '–ë–µ–∑ –¥–∞—Ç—ã';
                
                // –ö–Ω–æ–ø–∫–∞ —Å–æ —Å—Å—ã–ª–∫–æ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
                const linkButtonHtml = link ? `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--glass-border);">
                        <a href="${_escapeHtml(link)}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(138, 43, 226, 0.3); border: 1px solid var(--primary-color); border-radius: 8px; color: white; text-decoration: none; font-size: 14px; transition: all 0.3s;">
                            üìé –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º
                        </a>
                    </div>
                ` : '';

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞: "–ù–∞–∑–≤–∞–Ω–∏–µ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ ‚Äî –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                const accordionTitle = `${title} ${dateText}`;

                const accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.innerHTML = `
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <div class="accordion-title">${accordionTitle}</div>
                    </div>
                    <div class="accordion-content">
                        <div class="glass-card promotion-card" style="background: rgba(255, 255, 255, 0.03);">
                            <div class="promotion-header">
                                <div class="promotion-title">${title}</div>
                                <div class="status-badge">${status ? _escapeHtml(status) : '–ê–ö–¢–ò–í–ù–ê'}</div>
                            </div>
                            ${mediaHtml}
                            <div class="promotion-desc">${desc || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</div>
                            <div class="promotion-footer">
                                <div class="date-info">üìÖ ${dateText}</div>
                            </div>
                            ${linkButtonHtml}
                        </div>
                    </div>
                `;

                container.appendChild(accordionItem);
            }
        }

        async function loadPromotions() {
            const container = document.getElementById('promotions-container');
            const allContainer = document.getElementById('all-promotions-container');

            // If already loaded, don't reload
            if (promotionsCache && !promotionsCache.error) {
                // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ü–∏—è
                renderPromotions(promotionsCache[0] ? [promotionsCache[0]] : [], container, true);
                // –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–í—Å–µ –∞–∫—Ü–∏–∏": –≤—Å–µ –∞–∫—Ü–∏–∏ –≤ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞—Ö
                renderPromotionsAccordion(promotionsCache, allContainer);
                return;
            }

            const data = await fetchPromotions();

            if (data && !data.error) {
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ release_date (–æ—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º), –µ—Å–ª–∏ –Ω–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ GAS
                let sortedData = Array.isArray(data) ? [...data] : [];
                if (sortedData.length > 0 && sortedData[0].release_date) {
                    sortedData.sort((a, b) => {
                        const dateA = a.release_date ? new Date(a.release_date.split('.').reverse().join('-')) : new Date(0);
                        const dateB = b.release_date ? new Date(b.release_date.split('.').reverse().join('-')) : new Date(0);
                        return dateB - dateA; // –û—Ç –Ω–æ–≤—ã—Ö –∫ —Å—Ç–∞—Ä—ã–º
                    });
                }
                
                promotionsCache = sortedData;
                
                // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ü–∏—è (–ø–µ—Ä–≤–∞—è –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)
                renderPromotions(sortedData[0] ? [sortedData[0]] : [], container, true);
                
                // –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–í—Å–µ –∞–∫—Ü–∏–∏": –≤—Å–µ –∞–∫—Ü–∏–∏ –≤ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞—Ö
                renderPromotionsAccordion(sortedData, allContainer);
            } else {
                const errorMsg = data ? data.error : 'Unknown error';
                showError(container, errorMsg);
                showError(allContainer, errorMsg);
            }
        }

        function showError(container, message) {
            console.error('showError –≤—ã–∑–≤–∞–Ω–∞:', message, '–¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', container);
            if (!container) {
                console.error('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            // –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let userMessage = message;
            if (message.includes('Failed to fetch') || message.includes('CORS')) {
                userMessage = '–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–∞–Ω–Ω—ã–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Google Apps Script: –¥–æ—Å—Ç—É–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ "–í—Å–µ" (Anyone).';
            }
            
            container.innerHTML = `
                <div class="glass-card error-state">
                    <p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏</p>
                    <p style="font-size: 12px; opacity: 0.7; margin: 5px 0;">${userMessage}</p>
                    <p style="font-size: 11px; opacity: 0.5; margin: 5px 0; margin-top: 10px;">
                        üí° –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    </p>
                    <button onclick="loadPromotions()" style="margin-top:10px; padding: 8px 16px; border-radius: 8px; border: none; background: var(--primary-color); color: white; cursor: pointer;">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                </div>
            `;
        }

        function openProfileModal() {
            const modal = document.getElementById('profile-modal');
            const nameEl = document.getElementById('profile-name');
            const usernameEl = document.getElementById('profile-username');
            const codeEl = document.getElementById('profile-code');
            const phoneEl = document.getElementById('profile-phone');
            const avatarEl = document.getElementById('profile-avatar');

            if (tgUser) {
                const fullName = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ');
                nameEl.textContent = fullName || '–ü—Ä–æ—Ñ–∏–ª—å';
                usernameEl.textContent = tgUser.username ? `@${tgUser.username}` : '';
            } else {
                nameEl.textContent = '–ü—Ä–æ—Ñ–∏–ª—å';
                usernameEl.textContent = '';
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
            codeEl.textContent = '‚Ä¶';
            phoneEl.textContent = '‚Ä¶';

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
            if (tgUser && tgUser.id) {
                fetch(`${API_BASE_URL}/api/profile?telegram_id=${tgUser.id}`)
                    .then(r => r.json())
                    .then(data => {
                        if (!data || data.error) return;
                        if (data.partner_code) codeEl.textContent = data.partner_code;
                        if (data.phone) phoneEl.textContent = data.phone;
                    })
                    .catch(err => {
                        console.error('Profile fetch error', err);
                    });
            }

            modal.classList.add('open');
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('open');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadPromotions();

            const profileEl = document.querySelector('.user-profile');
            if (tgUser) {
                // –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä –∏–∑ Telegram, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (tgUser.photo_url) {
                    profileEl.style.backgroundImage = `url(${tgUser.photo_url})`;
                    profileEl.style.backgroundSize = 'cover';
                    profileEl.style.backgroundPosition = 'center';
                    profileEl.textContent = '';
                }

                profileEl.addEventListener('click', () => {
                    openProfileModal();
                    if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('medium');
                    }
                });
            }
        });

    </script>
</body>

</html>

================================================================================
FILE: ./openai_service.py
SIZE: 3971 bytes
================================================================================

import os
import logging
from typing import Dict, Optional

import httpx
from openai import OpenAI


logger = logging.getLogger(__name__)


class OpenAIService:
    """Thin wrapper around OpenAI Assistants Threads API for simple Q/A flows.

    Notes:
    - Maintains an in-memory map of user_id -> thread_id. This will reset on restart.
    - Expects OPENAI_API_KEY and OPENAI_ASSISTANT_ID in environment.
    """

    def __init__(self) -> None:
        api_key = os.getenv("OPENAI_API_KEY")
        assistant_id = os.getenv("OPENAI_ASSISTANT_ID")
        proxy_url = os.getenv("OPENAI_PROXY_URL")

        if not api_key or not assistant_id:
            logger.warning(
                "OpenAIService disabled: missing OPENAI_API_KEY or OPENAI_ASSISTANT_ID"
            )
            self.client = None
            self.assistant_id = None
        else:
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTP –∫–ª–∏–µ–Ω—Ç–∞ —Å –ø—Ä–æ–∫—Å–∏, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
            http_client = None
            if proxy_url:
                logger.info(f"Using proxy for OpenAI API: {proxy_url.split('@')[1] if '@' in proxy_url else proxy_url}")
                http_client = httpx.Client(
                    proxy=proxy_url,
                    timeout=60.0
                )
            else:
                http_client = httpx.Client(timeout=60.0)
            
            self.client = OpenAI(api_key=api_key, http_client=http_client)
            self.assistant_id = assistant_id

        self.user_threads: Dict[int, str] = {}

    def is_enabled(self) -> bool:
        return self.client is not None and self.assistant_id is not None

    def _get_or_create_thread(self, user_id: int) -> Optional[str]:
        if not self.is_enabled():
            return None
        thread_id = self.user_threads.get(user_id)
        if thread_id:
            return thread_id
        thread = self.client.beta.threads.create()
        self.user_threads[user_id] = thread.id
        logger.info(f"Created new OpenAI thread for user {user_id}: {thread.id}")
        return thread.id

    def _wait_for_run(self, thread_id: str, run_id: str, timeout_sec: int = 60) -> Optional[str]:
        """Polls until run completes or times out; returns final status."""
        start = time.time()
        while time.time() - start < timeout_sec:
            run = self.client.beta.threads.runs.retrieve(
                thread_id=thread_id, run_id=run_id
            )
            if run.status in ("completed", "failed", "cancelled", "expired"):
                return run.status
            # –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∞ - –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –Ω–µ –Ω—É–∂–Ω–∞
        return None

    def ask(self, user_id: int, content: str) -> Optional[str]:
        """Send a message to user's thread and return the assistant's latest reply text."""
        if not self.is_enabled():
            return None

        thread_id = self._get_or_create_thread(user_id)
        if not thread_id:
            return None

        # Add user message
        self.client.beta.threads.messages.create(
            thread_id=thread_id,
            role="user",
            content=content,
        )

        # Create run
        run = self.client.beta.threads.runs.create(
            thread_id=thread_id, assistant_id=self.assistant_id
        )

        status = self._wait_for_run(thread_id, run.id)
        if status != "completed":
            logger.warning(f"OpenAI run did not complete (status={status}) for user {user_id}")
            return None

        # Read latest messages and return the most recent assistant response
        messages = self.client.beta.threads.messages.list(thread_id=thread_id, order="desc")
        for m in messages.data:
            if m.role == "assistant":
                # Extract first text segment
                for part in m.content:
                    if part.type == "text":
                        return part.text.value
        return None





================================================================================
FILE: ./promotions_api.py
SIZE: 13225 bytes
================================================================================

"""API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–∑ Google Sheets"""
import logging
import os
import json
from typing import List, Dict, Optional
from datetime import datetime, date
from dotenv import load_dotenv

from sheets_gateway import AsyncGoogleSheetsGateway, SheetsNotConfiguredError, CircuitBreakerOpenError

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

logger = logging.getLogger(__name__)

class PromotionsNotConfiguredError(Exception):
    """–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π"""
    pass

def _get_promotions_client_and_sheet():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ª–∏—Å—Ç–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ü–∏–π (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)"""
    try:
        import gspread
        from google.oauth2.service_account import Credentials
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É, —á—Ç–æ –∏ –≤ sheets.py
        sa_json = os.environ.get('GCP_SA_JSON')
        sa_file = os.environ.get('GCP_SA_FILE')
        
        if sa_json:
            sa_info = json.loads(sa_json)
        elif sa_file and os.path.exists(sa_file):
            with open(sa_file, 'r', encoding='utf-8') as f:
                sa_info = json.load(f)
        else:
            raise PromotionsNotConfiguredError(
                'Service account JSON not provided (GCP_SA_JSON or GCP_SA_FILE)'
            )
        
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]
        
        creds = Credentials.from_service_account_info(sa_info, scopes=scopes)
        client = gspread.authorize(creds)
        
        sheet_id = os.environ.get('PROMOTIONS_SHEET_ID')
        if not sheet_id:
            raise PromotionsNotConfiguredError('PROMOTIONS_SHEET_ID not provided')
        
        spreadsheet = client.open_by_key(sheet_id)
        logger.info(f"Connected to Promotions Spreadsheet: '{spreadsheet.title}'")
        
        sheet_name = os.environ.get('PROMOTIONS_SHEET_NAME', 'Sheet1')
        try:
            worksheet = spreadsheet.worksheet(sheet_name)
            logger.info(f"Successfully opened worksheet: '{sheet_name}'")
        except Exception as e:
            logger.warning(f"Promotions worksheet '{sheet_name}' not found ({e}). Falling back to first sheet.")
            worksheet = spreadsheet.sheet1
            logger.info(f"Fallback to first worksheet: '{worksheet.title}'")

        # Debug: Log headers
        try:
            headers = worksheet.row_values(1)
            logger.info(f"Sheet Headers: {headers}")
        except Exception as e:
            logger.error(f"Could not read headers: {e}")

        return client, worksheet
    
    except ImportError as e:
        raise PromotionsNotConfiguredError(f'Import error: {e}')
    except Exception as e:
        logger.error(f"Failed to connect to Promotions Google Sheets: {e}")
        raise PromotionsNotConfiguredError(f'Promotions Google Sheets connection failed: {e}')

# Global cache for promotions
_promotions_cache = {
    'data': [],
    'timestamp': 0
}
CACHE_TTL = 300  # 5 minutes in seconds

async def get_active_promotions(gateway: AsyncGoogleSheetsGateway) -> List[Dict]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –∏–∑ Google Sheets.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç.
    
    Args:
        gateway: AsyncGoogleSheetsGateway –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
        
    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π
    """
    global _promotions_cache
    
    current_time = datetime.now().timestamp()
    
    # Return cached data if valid
    if _promotions_cache['data'] and (current_time - _promotions_cache['timestamp'] < CACHE_TTL):
        logger.info("–í–æ–∑–≤—Ä–∞—Ç –∞–∫—Ü–∏–π –∏–∑ –∫—ç—à–∞")
        return _promotions_cache['data']

    try:
        _, worksheet = _get_promotions_client_and_sheet()
        records = await gateway.get_all_records(worksheet)
        
        active_promotions = []
        
        for record in records:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ü–∏–∏
            status = str(record.get('–°—Ç–∞—Ç—É—Å', '')).strip()
            if status.lower() == '–∞–∫—Ç–∏–≤–Ω–∞':
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—É—Å—Ç–æ–µ
                title = str(record.get('–ù–∞–∑–≤–∞–Ω–∏–µ', '')).strip()
                description = str(record.get('–û–ø–∏—Å–∞–Ω–∏–µ', '')).strip()
                start_date = str(record.get('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', '')).strip()
                end_date = str(record.get('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', '')).strip()
                content = str(record.get('–ö–æ–Ω—Ç–µ–Ω—Ç', '')).strip()
                
                if not title or title == 'None' or title == '':
                    title = f"–ê–∫—Ü–∏—è {description}" if description and description != 'None' else "–ê–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
                
                # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
                unique_id = f"{title}_{description}_{start_date}_{end_date}".replace(' ', '_').replace(':', '').replace('-', '')
                
                promotion = {
                    'id': unique_id,
                    'title': title,
                    'description': description if description and description != 'None' else "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
                    'status': status,
                    'start_date': start_date if start_date and start_date != 'None' else '',
                    'end_date': end_date if end_date and end_date != 'None' else ''
                }
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if content and content != 'None' and content != '':
                    promotion['content'] = content
                
                # –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ü–∏—é, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
                if promotion['title'] and promotion['title'] != 'None':
                    active_promotions.append(promotion)
                    logger.info(f"–ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∞–∫—Ü–∏—è: {promotion['title']}")
                else:
                    logger.warning(f"–ü—Ä–æ–ø—É—â–µ–Ω–∞ –∞–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –æ–ø–∏—Å–∞–Ω–∏—è (row data: {record})")
        
        logger.info(f"–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π: {len(active_promotions)}")
        
        # Update cache
        _promotions_cache['data'] = active_promotions
        _promotions_cache['timestamp'] = current_time
        
        return active_promotions
        
    except (PromotionsNotConfiguredError, SheetsNotConfiguredError, CircuitBreakerOpenError) as e:
        logger.error(f"–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
        # Return cached data if available even if expired in case of error
        if _promotions_cache['data']:
            logger.warning("–í–æ–∑–≤—Ä–∞—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫—ç—à–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
            return _promotions_cache['data']
        return []
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π: {e}")
        # Return cached data if available even if expired in case of error
        if _promotions_cache['data']:
            logger.warning("–í–æ–∑–≤—Ä–∞—Ç —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∫—ç—à–∞ –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏")
            return _promotions_cache['data']
        return []

async def get_promotions_json(gateway: AsyncGoogleSheetsGateway) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –¥–ª—è API.
    
    Args:
        gateway: AsyncGoogleSheetsGateway –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
    
    Returns:
        str: JSON —Å—Ç—Ä–æ–∫–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
    """
    try:
        promotions = await get_active_promotions(gateway)
        return json.dumps(promotions, ensure_ascii=False, indent=2)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ JSON –∞–∫—Ü–∏–π: {e}")
        return json.dumps([], ensure_ascii=False)

async def check_new_promotions(gateway: AsyncGoogleSheetsGateway) -> List[Dict]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
    
    Args:
        gateway: AsyncGoogleSheetsGateway –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
    
    Returns:
        List[Dict]: –°–ø–∏—Å–æ–∫ –Ω–æ–≤—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π
    """
    try:
        _, worksheet = _get_promotions_client_and_sheet()
        records = await gateway.get_all_records(worksheet)
        
        new_promotions = []
        
        for record in records:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Ü–∏–∏
            status = str(record.get('–°—Ç–∞—Ç—É—Å', '')).strip()
            if status.lower() == '–∞–∫—Ç–∏–≤–Ω–∞':
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ (–∫–æ–≥–¥–∞ –∞–∫—Ü–∏—è —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–æ–π)
                release_date = str(record.get('–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞', '')).strip()
                if release_date and release_date != 'None':
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–∫—Ü–∏—è –±—ã–ª–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                    try:
                        release_dt = datetime.strptime(release_date, '%d.%m.%Y').date()
                        today = date.today()
                        
                        if release_dt == today:
                            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è ID, —á—Ç–æ –∏ –≤ get_active_promotions
                            title = str(record.get('–ù–∞–∑–≤–∞–Ω–∏–µ', '')).strip()
                            description = str(record.get('–û–ø–∏—Å–∞–Ω–∏–µ', '')).strip()
                            start_date = str(record.get('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', ''))
                            end_date = str(record.get('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', ''))
                            content = str(record.get('–ö–æ–Ω—Ç–µ–Ω—Ç', '')).strip()
                            
                            if not title or title == 'None' or title == '':
                                title = f"–ê–∫—Ü–∏—è {description}" if description and description != 'None' else "–ê–∫—Ü–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
                            
                            unique_id = f"{title}_{description}_{start_date}_{end_date}".replace(' ', '_').replace(':', '').replace('-', '')
                            
                            promotion = {
                                'id': unique_id,
                                'title': title,
                                'description': description if description and description != 'None' else "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
                                'status': status,
                                'start_date': start_date,
                                'end_date': end_date,
                                'release_date': release_date
                            }
                            
                            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                            if content and content != 'None' and content != '':
                                promotion['content'] = content
                            
                            if promotion['title'] and promotion['title'] != 'None':
                                new_promotions.append(promotion)
                                logger.info(f"–ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è –∞–∫—Ü–∏—è: {promotion['title']} (—Ä–µ–ª–∏–∑: {release_date})")
                    except ValueError as e:
                        logger.warning(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã —Ä–µ–ª–∏–∑–∞ '{release_date}': {e}")
                        continue
        
        logger.info(f"–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏–π: {len(new_promotions)}")
        return new_promotions
        
    except (PromotionsNotConfiguredError, SheetsNotConfiguredError, CircuitBreakerOpenError) as e:
        logger.error(f"–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: {e}")
        return []
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏–π: {e}")
        return []

async def is_promotions_available(gateway: AsyncGoogleSheetsGateway) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π.
    
    Args:
        gateway: AsyncGoogleSheetsGateway –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
    
    Returns:
        bool: True –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
    """
    try:
        _get_promotions_client_and_sheet()
        return True
    except (PromotionsNotConfiguredError, SheetsNotConfiguredError, CircuitBreakerOpenError):
        return False
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π: {e}")
        return False


================================================================================
FILE: ./promotions_notifier.py
SIZE: 10781 bytes
================================================================================

"""–°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö"""
import logging
import asyncio
from typing import List, Dict

from promotions_api import check_new_promotions, is_promotions_available
from auth_service import AuthService
from sheets_gateway import AsyncGoogleSheetsGateway

logger = logging.getLogger(__name__)

class PromotionsNotifier:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö"""
    
    def __init__(self, bot, auth_service: AuthService, gateway: AsyncGoogleSheetsGateway):
        self.bot = bot
        self.auth_service = auth_service
        self.gateway = gateway
        self.last_check_time = None
        self.sent_promotions = set()  # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–∫—Ü–∏–π
        
    async def check_and_send_notifications(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ–≤—ã–µ –∞–∫—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
        if not await is_promotions_available(self.gateway):
            logger.warning("–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
            return
            
        try:
            new_promotions = await check_new_promotions(self.gateway)
            
            if not new_promotions:
                logger.info("–ù–æ–≤—ã—Ö –∞–∫—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
                return
                
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            authorized_users = await self._get_authorized_users()
            
            if not authorized_users:
                logger.info("–ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
                return
                
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö
            for promotion in new_promotions:
                if promotion['id'] not in self.sent_promotions:
                    await self._send_promotion_notification(promotion, authorized_users)
                    self.sent_promotions.add(promotion['id'])
                    
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∞–∫—Ü–∏—è—Ö: {e}")
    
    async def _get_authorized_users(self) -> List[int]:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ ID –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        try:
            if not self.auth_service.worksheet:
                return []
                
            records = await self.auth_service.gateway.get_all_records(self.auth_service.worksheet)
            authorized_users = []
            
            for record in records:
                telegram_id = record.get('Telegram ID')
                status = record.get('–°—Ç–∞—Ç—É—Å') or record.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏')
                
                if telegram_id and str(status).strip().lower() in ('–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'authorized'):
                    try:
                        authorized_users.append(int(telegram_id))
                    except (ValueError, TypeError):
                        continue
                        
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(authorized_users)} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
            return authorized_users
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
            return []
    
    async def _send_promotion_notification(self, promotion: Dict, users: List[int]):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            message = "üéâ **–ù–æ–≤–∞—è –∞–∫—Ü–∏—è!**\n\n"
            message += f"**{promotion['title']}**\n\n"
            message += f"üìù {promotion['description'][:200]}{'...' if len(promotion['description']) > 200 else ''}\n\n"
            message += f"üìÖ **–ü–µ—Ä–∏–æ–¥ –¥–µ–π—Å—Ç–≤–∏—è:** {promotion['start_date']} - {promotion['end_date']}\n\n"
            message += f"‚ú® –ê–∫—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞ —Å {promotion['release_date']}"
            
            # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
            from telegram import InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
            import os
            web_app_url = os.getenv('WEB_APP_URL', 'https://synthosaicreativestudio-maker.github.io/marketing/')
            # –î–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞ Telegram WebView
            version = "v=20260107-4"
            menu_url = (
                f"{web_app_url}menu.html?{version}"
                if web_app_url.endswith('/')
                else f"{web_app_url}/menu.html?{version}"
            )
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏: —Å–Ω–∞—á–∞–ª–∞ —Å—Å—ã–ª–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å), –ø–æ—Ç–æ–º –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            buttons = []
            if promotion.get('link') and promotion['link'].strip():
                buttons.append([InlineKeyboardButton(
                    "üìé –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º",
                    url=promotion['link'].strip()
                )])
            buttons.append([InlineKeyboardButton(
                "üìã –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–∫—Ü–∏–∏", 
                web_app=WebAppInfo(url=menu_url)
            )])
            reply_markup = InlineKeyboardMarkup(buttons)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content_url = promotion.get('content', '').strip()
            has_media = content_url and content_url != 'None' and content_url != ''
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é –∏–ª–∏ URL
            is_photo = False
            is_video = False
            if has_media:
                content_lower = content_url.lower()
                photo_extensions = ('.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg')
                video_extensions = ('.mp4', '.mov', '.avi', '.mkv', '.webm')
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
                has_photo_extension = any(content_lower.endswith(ext) for ext in photo_extensions)
                has_video_extension = any(content_lower.endswith(ext) for ext in video_extensions)
                
                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ö–æ—Å—Ç–∏–Ω–≥–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–∞–∫ –≤ menu.html)
                is_image_hosting = (
                    'googleusercontent.com' in content_lower or
                    'drive.google.com' in content_lower or
                    'googleapis.com' in content_lower or
                    'imgur.com' in content_lower or
                    'imgbb.com' in content_lower or
                    'cloudinary.com' in content_lower
                )
                
                if has_photo_extension or 'photo' in content_lower or 'image' in content_lower or (is_image_hosting and not has_video_extension):
                    is_photo = True
                elif has_video_extension or 'video' in content_lower:
                    is_video = True
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
            sent_count = 0
            for user_id in users:
                try:
                    if has_media and is_photo:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é
                        await self.bot.send_photo(
                            chat_id=user_id,
                            photo=content_url,
                            caption=message,
                            parse_mode='Markdown',
                            reply_markup=reply_markup
                        )
                        logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{promotion['title']}' —Å —Ñ–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    elif has_media and is_video:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ —Å –ø–æ–¥–ø–∏—Å—å—é
                        await self.bot.send_video(
                            chat_id=user_id,
                            video=content_url,
                            caption=message,
                            parse_mode='Markdown',
                            reply_markup=reply_markup
                        )
                        logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{promotion['title']}' —Å –≤–∏–¥–µ–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    else:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        await self.bot.send_message(
                            chat_id=user_id,
                            text=message,
                            parse_mode='Markdown',
                            reply_markup=reply_markup
                        )
                        logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{promotion['title']}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                    
                    sent_count += 1
                    
                    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏
                    await asyncio.sleep(0.1)
                    
                except Exception as e:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
                    continue
            
            logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{promotion['title']}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∞–∫—Ü–∏–∏: {e}")
    
    async def start_monitoring(self, interval_minutes: int = 15):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏–π"""
        logger.info(f"–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ü–∏–π (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ {interval_minutes} –º–∏–Ω—É—Ç)")
        
        while True:
            try:
                await self.check_and_send_notifications()
                await asyncio.sleep(interval_minutes * 60)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –∞–∫—Ü–∏–π: {e}")
                await asyncio.sleep(60)  # –ñ–¥–µ–º –º–∏–Ω—É—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ


================================================================================
FILE: ./requirements.txt
SIZE: 210 bytes
================================================================================

requests>=2.32.0
python-dotenv>=1.0.0
gspread>=6.1.0
google-auth>=2.37.0
python-telegram-bot>=20.7
openai>=1.45.0
flask>=3.0.0
sqlalchemy>=2.0.0
alembic>=1.12.0
fastapi>=0.104.0
uvicorn>=0.24.0
pydantic>=2.0.0


================================================================================
FILE: ./response_monitor.py
SIZE: 14028 bytes
================================================================================

"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –≤ Telegram.
"""

import logging
import asyncio
from telegram import Bot
from appeals_service import AppealsService
from typing import Union

logger = logging.getLogger(__name__)


class ResponseMonitor:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤."""
    
    def __init__(self, appeals_service: Union[AppealsService, object], bot_token: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤.
        
        Args:
            appeals_service: —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
            bot_token: —Ç–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
        """
        self.appeals_service = appeals_service
        self.bot = Bot(token=bot_token)
        self.is_running = False
        self._task = None

    async def start_monitoring(self, interval_seconds: int = 60):
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.
        
        Args:
            interval_seconds: –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60)
        """
        if self.is_running:
            logger.warning("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–∂–µ –∑–∞–ø—É—â–µ–Ω")
            return

        self.is_running = True
        logger.info(f"–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ (–∏–Ω—Ç–µ—Ä–≤–∞–ª: {interval_seconds} —Å–µ–∫)")
        
        self._task = asyncio.create_task(self._monitoring_loop(interval_seconds))

    async def stop_monitoring(self):
        """–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤."""
        if not self.is_running:
            return

        self.is_running = False
        if self._task:
            self._task.cancel()
            try:
                await self._task
            except asyncio.CancelledError:
                pass
        
        logger.info("–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

    async def _monitoring_loop(self, interval_seconds: int):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞."""
        while self.is_running:
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
                if await self.appeals_service.has_records():
                    await self._check_and_send_responses()
                else:
                    logger.debug("–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É")
                
                # –ñ–¥–µ–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                await asyncio.sleep(interval_seconds)
                
            except asyncio.CancelledError:
                break
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: {e}")
                await asyncio.sleep(interval_seconds)  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—à–∏–±–∫–µ

    async def _check_and_send_responses(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤."""
        try:
            # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –∫–æ–ª–æ–Ω–∫–µ G
            responses = await self.appeals_service.check_for_responses()
            
            for response_data in responses:
                await self._send_response(response_data)
                
                # –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä "—Ä–µ—à–µ–Ω–æ", –ø–æ–º–µ—á–∞–µ–º
                if self._is_resolved_response(response_data.get('response', '')):
                    await self._mark_as_resolved(response_data)

            # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "–†–µ—à–µ–Ω–æ" –≤ –∫–æ–ª–æ–Ω–∫–µ F (—Ä—É—á–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ)
            await self._check_and_process_resolved_status()
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–æ–≤: {e}")

    async def _check_and_process_resolved_status(self):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è, –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—ã–µ –≤ —Å—Ç–∞—Ç—É—Å '–†–µ—à–µ–Ω–æ' –≤—Ä—É—á–Ω—É—é."""
        try:
            resolved_appeals = await self.appeals_service.check_for_resolved_status()
            
            for appeal in resolved_appeals:
                telegram_id = appeal['telegram_id']
                row = appeal['row']
                
                message = "‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω–æ–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º."
                
                # –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –î–û –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º add_specialist_response –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
                try:
                    self.appeals_service.add_specialist_response(
                        telegram_id=telegram_id,
                        response_text=message
                    )
                    logger.info(f"–ú–∞—Ä–∫–µ—Ä '—Ä–µ—à–µ–Ω–æ' –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}: {e}")
                    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                try:
                    await self.bot.send_message(
                        chat_id=telegram_id,
                        text=message
                    )
                    logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä—É—á–Ω–æ–º —Ä–µ—à–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}: {e}")
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä—É—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π: {e}")

    def _is_resolved_response(self, response_text: str) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ "—Ä–µ—à–µ–Ω–æ".
        
        Args:
            response_text: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            
        Returns:
            bool: True –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
        """
        if not response_text:
            return False
            
        text_lower = response_text.lower()
        
        # –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: —Ç–æ–ª—å–∫–æ –æ—á–µ–Ω—å —è–≤–Ω—ã–µ —Ñ—Ä–∞–∑—ã
        # –¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "—Ä–µ—à–µ–Ω–æ" (—Ç–æ–ª—å–∫–æ —è–≤–Ω—ã–µ —É–∫–∞–∑–∞–Ω–∏—è)
        resolved_phrases = [
            '—Å—Ç–∞—Ç—É—Å —Ä–µ—à–µ–Ω–æ', '–æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω–æ–µ', '–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞',
            '–º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å', '–∑–∞–∫—Ä—ã–≤–∞–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ', '–æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ'
        ]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑
        for phrase in resolved_phrases:
            if phrase in text_lower:
                logger.info(f"–ù–∞–π–¥–µ–Ω–∞ —Ñ—Ä–∞–∑–∞ '—Ä–µ—à–µ–Ω–æ': '{phrase}' –≤ –æ—Ç–≤–µ—Ç–µ: {response_text[:100]}...")
                return True
        
        # –í–†–ï–ú–ï–ù–ù–û: –ª–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        logger.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ—Ä–∞–∑ '—Ä–µ—à–µ–Ω–æ': '{response_text[:100]}...'")
        return False

    async def _mark_as_resolved(self, response_data: dict):
        """
        –û—Ç–º–µ—á–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω–æ–µ –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            response_data: –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
        """
        try:
            telegram_id = response_data['telegram_id']
            response_text = response_data['response']
            telegram_id = response_data['telegram_id']
            response_text = response_data['response']
            # fio and code are unused
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ—à–µ–Ω–∏–∏
            message = f"‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞!\n\n{response_text}"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.bot.send_message(
                chat_id=telegram_id,
                text=message
            )
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ—à–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")
            
            # –°—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "—Ä–µ—à–µ–Ω–æ" —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º —É–∫–∞–∑–∞–Ω–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑
            logger.info(f"–û–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ —Ä–µ—à–µ–Ω–Ω–æ–µ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–º —Ñ—Ä–∞–∑–∞–º –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {response_data['row']}")
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ
            await self.appeals_service.clear_response(response_data['row'])
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {response_data.get('telegram_id', 'unknown')}: {e}")

    async def _send_response(self, response_data: dict):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
        
        Args:
            response_data: –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞ (row, telegram_id, response, code, fio)
        """
        try:
            telegram_id = response_data['telegram_id']
            response_text = response_data['response']
            telegram_id = response_data['telegram_id']
            response_text = response_data['response']
            # fio and code are unused
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ)
            message = f"üí¨ –û—Ç–≤–µ—Ç –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞:\n\n{response_text}"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.bot.send_message(
                chat_id=telegram_id,
                text=message
            )
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")
            
            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–í —Ä–∞–±–æ—Ç–µ" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–≤–µ—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            try:
                success = await self.appeals_service.set_status_in_work(telegram_id)
                if success:
                    logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                else:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ '–í —Ä–∞–±–æ—Ç–µ': {e}")
            
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü—É –æ–±—Ä–∞—â–µ–Ω–∏–π
            try:
                # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
                specialist_response = f"üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢: {response_text}"
                
                # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏—è–º
                self.appeals_service.add_specialist_response(
                    telegram_id=telegram_id,
                    response_text=specialist_response
                )
                logger.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∑–∞–ø–∏—Å–∞–Ω –≤ —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ —Ç–∞–±–ª–∏—Ü—É: {e}")
            
            # –ù–ï –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º —É–∫–∞–∑–∞–Ω–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            logger.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∑–∞–ø–∏—Å–∞–Ω –¥–ª—è —Å—Ç—Ä–æ–∫–∏ {response_data['row']}, —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
            
            # –û—á–∏—â–∞–µ–º –æ—Ç–≤–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ
            await self.appeals_service.clear_response(response_data['row'])
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {response_data.get('telegram_id', 'unknown')}: {e}")

    async def send_test_response(self, telegram_id: int, test_message: str = "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤"):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            test_message: —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        """
        try:
            await self.bot.send_message(
                chat_id=telegram_id,
                text=f"üß™ {test_message}"
            )
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {telegram_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")


================================================================================
FILE: ./sheets_gateway.py
SIZE: 16404 bytes
================================================================================

"""
–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —à–ª—é–∑ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets API.
–ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets —Å retry –ª–æ–≥–∏–∫–æ–π –∏ Circuit Breaker.
"""
import logging
import asyncio
import json
import os
from pathlib import Path
from typing import List, Dict, Optional, Any, Callable
import gspread
from gspread.exceptions import APIError
from tenacity import (
    retry,
    stop_after_attempt,
    wait_exponential,
    retry_if_exception_type,
    retry_if_exception,
    RetryError
)
from requests.exceptions import ConnectionError, ReadTimeout
from dotenv import load_dotenv

from sheets_utils import (
    get_auth_circuit_breaker,
    get_appeals_circuit_breaker,
    get_promotions_circuit_breaker,
    CircuitBreakerOpenError
)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

logger = logging.getLogger(__name__)


class SheetsNotConfiguredError(Exception):
    """–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google Sheets"""
    pass


def normalize_phone(phone: str) -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫ —Ñ–æ—Ä–º–∞—Ç—É 8XXXXXXXXXX"""
    digits = ''.join(ch for ch in (phone or '') if ch.isdigit())
    if len(digits) == 10:
        return '8' + digits
    elif len(digits) == 11 and digits.startswith('7'):
        return '8' + digits[1:]
    elif len(digits) == 11 and digits.startswith('8'):
        return digits
    else:
        return digits


def _load_service_account():
    """–ó–∞–≥—Ä—É–∑–∫–∞ service account –¥–ª—è Google Sheets"""
    sa_json = os.environ.get('GCP_SA_JSON')
    sa_file = os.environ.get('GCP_SA_FILE')
    
    if sa_json:
        try:
            return json.loads(sa_json)
        except Exception as e:
            raise ValueError('Invalid GCP_SA_JSON: ' + str(e)) from e
    
    if sa_file and Path(sa_file).exists():
        with Path(sa_file).open(encoding='utf-8') as f:
            return json.load(f)
    
    raise SheetsNotConfiguredError(
        'Service account JSON not provided (GCP_SA_JSON or GCP_SA_FILE)'
    )


def _get_client_and_sheet():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ª–∏—Å—Ç–∞ Google Sheets (–¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)"""
    try:
        import gspread
        from google.oauth2.service_account import Credentials
        
        sa_info = _load_service_account()
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]
        
        creds = Credentials.from_service_account_info(sa_info, scopes=scopes)
        client = gspread.authorize(creds)
        
        sheet_id = os.environ.get('SHEET_ID')
        if not sheet_id:
            raise SheetsNotConfiguredError('SHEET_ID not provided')
        
        spreadsheet = client.open_by_key(sheet_id)
        sheet_name = os.environ.get('SHEET_NAME', 'Sheet1')
        try:
            worksheet = spreadsheet.worksheet(sheet_name)
        except Exception as e:
            logger.warning(f"Worksheet '{sheet_name}' not found ({e}). Falling back to first sheet.")
            worksheet = spreadsheet.sheet1

        return client, worksheet
    
    except ImportError as e:
        raise SheetsNotConfiguredError(f'Import error: {e}')
    except Exception as e:
        logger.error(f"Failed to connect to Google Sheets: {e}")
        raise SheetsNotConfiguredError(f'Google Sheets connection failed: {e}')


def _get_appeals_client_and_sheet():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –ª–∏—Å—Ç–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π (–¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)"""
    try:
        import gspread
        from google.oauth2.service_account import Credentials
        
        sa_info = _load_service_account()
        scopes = [
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ]
        
        creds = Credentials.from_service_account_info(sa_info, scopes=scopes)
        client = gspread.authorize(creds)
        
        sheet_id = os.environ.get('APPEALS_SHEET_ID')
        if not sheet_id:
            raise SheetsNotConfiguredError('APPEALS_SHEET_ID not provided')
        
        spreadsheet = client.open_by_key(sheet_id)
        sheet_name = os.environ.get('APPEALS_SHEET_NAME', '–æ–±—Ä–∞—â–µ–Ω–∏—è')
        try:
            worksheet = spreadsheet.worksheet(sheet_name)
        except Exception as e:
            logger.warning(f"Appeals worksheet '{sheet_name}' not found ({e}). Falling back to first sheet.")
            worksheet = spreadsheet.sheet1

        return client, worksheet
    
    except ImportError as e:
        raise SheetsNotConfiguredError(f'Import error: {e}')
    except Exception as e:
        logger.error(f"Failed to connect to Appeals Google Sheets: {e}")
        raise SheetsNotConfiguredError(f'Appeals Google Sheets connection failed: {e}')


def _is_retryable_error(exception: Exception) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π (—Ç—Ä–µ–±—É–µ—Ç retry).
    
    Args:
        exception: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
    Returns:
        True –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏ —Ç—Ä–µ–±—É–µ—Ç retry
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º APIError —Å –∫–æ–¥–∞–º–∏ –æ—à–∏–±–æ–∫
    if isinstance(exception, APIError):
        status_code = getattr(exception, 'response', {}).get('status', 0)
        # Retry –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
        if status_code in [500, 502, 503, 504]:
            return True
        # –ù–µ retry –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
        if status_code in [400, 401, 403, 404]:
            return False
    
    # Retry –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫
    if isinstance(exception, (ConnectionError, ReadTimeout)):
        return True
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏
    error_str = str(exception).lower()
    retryable_keywords = ['503', '502', '500', '504', 'unavailable', 'timeout', 'connection']
    if any(keyword in error_str for keyword in retryable_keywords):
        return True
    
    return False


def _should_not_retry(exception: Exception) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –¥–µ–ª–∞—Ç—å retry (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏).
    
    Args:
        exception: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        
    Returns:
        True –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–∞—è –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç retry
    """
    if isinstance(exception, APIError):
        status_code = getattr(exception, 'response', {}).get('status', 0)
        if status_code in [400, 401, 403, 404]:
            return True
    
    return False


class AsyncGoogleSheetsGateway:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —à–ª—é–∑ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets API.
    
    –í—Å–µ –º–µ—Ç–æ–¥—ã gspread –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ run_in_executor –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è
    –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop. Retry –ª–æ–≥–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ tenacity.
    Circuit Breaker –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—à–∏–±–æ–∫.
    """
    
    def __init__(self, circuit_breaker_name: str = 'auth'):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Gateway.
        
        Args:
            circuit_breaker_name: –ò–º—è Circuit Breaker ('auth', 'appeals', 'promotions')
        """
        self.circuit_breaker_name = circuit_breaker_name
        self._get_circuit_breaker()
        self._loop = None
    
    def _get_circuit_breaker(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π Circuit Breaker."""
        if self.circuit_breaker_name == 'auth':
            self.circuit_breaker = get_auth_circuit_breaker()
        elif self.circuit_breaker_name == 'appeals':
            self.circuit_breaker = get_appeals_circuit_breaker()
        elif self.circuit_breaker_name == 'promotions':
            self.circuit_breaker = get_promotions_circuit_breaker()
        else:
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º auth
            self.circuit_breaker = get_auth_circuit_breaker()
    
    def _get_loop(self):
        """–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π event loop."""
        if self._loop is None:
            try:
                self._loop = asyncio.get_event_loop()
            except RuntimeError:
                self._loop = asyncio.new_event_loop()
                asyncio.set_event_loop(self._loop)
        return self._loop
    
    def _retry_exec(self, func: Callable, *args, **kwargs) -> Any:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —Å retry –ª–æ–≥–∏–∫–æ–π —á–µ—Ä–µ–∑ tenacity.
        
        Args:
            func: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
            
        Raises:
            Exception: –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        """
        @retry(
            stop=stop_after_attempt(5),
            wait=wait_exponential(min=2, max=30),
            retry=retry_if_exception(_is_retryable_error),
            reraise=True
        )
        def _execute():
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º Circuit Breaker –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º
            try:
                return self.circuit_breaker.call(func, *args, **kwargs)
            except CircuitBreakerOpenError as e:
                logger.warning(f"Circuit Breaker –æ—Ç–∫—Ä—ã—Ç: {e}")
                raise
        
        try:
            return _execute()
        except RetryError as e:
            # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
            logger.error(f"–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ retry –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è {func.__name__}: {e.last_attempt.exception()}")
            raise e.last_attempt.exception() from e
        except Exception as e:
            # –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (400, 401, 403, 404) –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ä–∞–∑—É
            if _should_not_retry(e):
                logger.error(f"–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º: {e}")
            raise
    
    async def _run_in_executor(self, func: Callable, *args, **kwargs) -> Any:
        """
        –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ executor –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop.
        
        Args:
            func: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            *args: –ü–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            **kwargs: –ò–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
        """
        loop = self._get_loop()
        return await loop.run_in_executor(
            None,
            lambda: self._retry_exec(func, *args, **kwargs)
        )
    
    async def get_all_records(self, worksheet: gspread.Worksheet) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ worksheet.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            
        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å–µ–π
        """
        return await self._run_in_executor(worksheet.get_all_records)
    
    async def append_row(self, worksheet: gspread.Worksheet, values: List[Any]) -> None:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ worksheet.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            values: –°–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Å—Ç—Ä–æ–∫–∏
        """
        await self._run_in_executor(worksheet.append_row, values)
    
    async def update(self, worksheet: gspread.Worksheet, range_name: str, values: List[List[Any]]) -> None:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫ –≤ worksheet.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            range_name: –ò–º—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'A1:B2')
            values: –î–≤—É–º–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π
        """
        await self._run_in_executor(worksheet.update, range_name, values)
    
    async def update_cell(self, worksheet: gspread.Worksheet, row: int, col: int, value: Any) -> None:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –æ–¥–Ω—É —è—á–µ–π–∫—É –≤ worksheet.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            row: –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 1)
            col: –ù–æ–º–µ—Ä –∫–æ–ª–æ–Ω–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 1)
            value: –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —è—á–µ–π–∫–∏
        """
        await self._run_in_executor(worksheet.update_cell, row, col, value)
    
    async def find(self, worksheet: gspread.Worksheet, query: str, in_row: Optional[int] = None, in_column: Optional[int] = None) -> Optional[gspread.Cell]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç —è—á–µ–π–∫—É –ø–æ –∑–∞–ø—Ä–æ—Å—É.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            query: –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
            in_row: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ —Å—Ç—Ä–æ–∫–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            in_column: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –∫–æ–ª–æ–Ω–∫–æ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            Cell –æ–±—ä–µ–∫—Ç –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
        """
        return await self._run_in_executor(worksheet.find, query, in_row, in_column)
    
    async def findall(self, worksheet: gspread.Worksheet, query: str) -> List[gspread.Cell]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —è—á–µ–π–∫–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            query: –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
            
        Returns:
            –°–ø–∏—Å–æ–∫ Cell –æ–±—ä–µ–∫—Ç–æ–≤
        """
        return await self._run_in_executor(worksheet.findall, query)
    
    async def row_values(self, worksheet: gspread.Worksheet, row: int) -> List[str]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            row: –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 1)
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π —Å—Ç—Ä–æ–∫–∏
        """
        return await self._run_in_executor(worksheet.row_values, row)
    
    async def col_values(self, worksheet: gspread.Worksheet, col: int) -> List[str]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            col: –ù–æ–º–µ—Ä –∫–æ–ª–æ–Ω–∫–∏ (–Ω–∞—á–∏–Ω–∞—è —Å 1)
            
        Returns:
            –°–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π –∫–æ–ª–æ–Ω–∫–∏
        """
        return await self._run_in_executor(worksheet.col_values, col)
    
    async def get_worksheet(self, spreadsheet: gspread.Spreadsheet, sheet_name: str) -> gspread.Worksheet:
        """
        –ü–æ–ª—É—á–∞–µ—Ç worksheet –ø–æ –∏–º–µ–Ω–∏.
        
        Args:
            spreadsheet: Spreadsheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            sheet_name: –ò–º—è –ª–∏—Å—Ç–∞
            
        Returns:
            Worksheet –æ–±—ä–µ–∫—Ç
        """
        return await self._run_in_executor(spreadsheet.worksheet, sheet_name)
    
    async def batch_update(self, worksheet: gspread.Worksheet, data: List[Dict]) -> None:
        """
        –ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–µ–∫.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            data: –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        """
        await self._run_in_executor(worksheet.batch_update, data)
    
    async def format(self, worksheet: gspread.Worksheet, range_name: str, format_dict: Dict) -> None:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω —è—á–µ–µ–∫.
        
        Args:
            worksheet: Worksheet –æ–±—ä–µ–∫—Ç –∏–∑ gspread
            range_name: –ò–º—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            format_dict: –°–ª–æ–≤–∞—Ä—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        """
        await self._run_in_executor(worksheet.format, range_name, format_dict)


================================================================================
FILE: ./sheets_utils.py
SIZE: 6607 bytes
================================================================================

"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω–∞.
"""
import logging
import time
from enum import Enum
from typing import Callable, Any, Optional

logger = logging.getLogger(__name__)


class CircuitState(Enum):
    """–°–æ—Å—Ç–æ—è–Ω–∏—è Circuit Breaker"""
    CLOSED = "closed"  # –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞, –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
    OPEN = "open"  # –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è
    HALF_OPEN = "half_open"  # –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º, –ø—Ä–æ–±—É–µ–º –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å


class CircuitBreaker:
    """
    –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—à–∏–±–æ–∫.
    
    Circuit Breaker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –ø—Ä–æ–±–ª–µ–º–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É
    –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –æ—à–∏–±–æ–∫ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞.
    """
    
    def __init__(
        self,
        failure_threshold: int = 5,
        recovery_timeout: int = 60,
        expected_exception: type = Exception
    ):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Circuit Breaker.
        
        Args:
            failure_threshold: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è circuit
            recovery_timeout: –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –¥–æ –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (half-open)
            expected_exception: —Ç–∏–ø –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—à–∏–±–∫–æ–π
        """
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.expected_exception = expected_exception
        
        self.failure_count = 0
        self.last_failure_time: Optional[float] = None
        self.state = CircuitState.CLOSED
        
    def call(self, func: Callable, *args, **kwargs) -> Any:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é —á–µ—Ä–µ–∑ Circuit Breaker.
        
        Args:
            func: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            *args: –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            **kwargs: –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            
        Returns:
            –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
            
        Raises:
            CircuitBreakerOpenError: –µ—Å–ª–∏ circuit –æ—Ç–∫—Ä—ã—Ç
            Exception: –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ circuit
        if self.state == CircuitState.OPEN:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–æ –ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            if self.last_failure_time and (time.time() - self.last_failure_time) >= self.recovery_timeout:
                logger.info("Circuit Breaker –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ HALF_OPEN –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞")
                self.state = CircuitState.HALF_OPEN
                self.failure_count = 0
            else:
                raise CircuitBreakerOpenError(
                    f"Circuit Breaker –æ—Ç–∫—Ä—ã—Ç. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {self.last_failure_time}"
                )
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é
        try:
            result = func(*args, **kwargs)
            # –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
            if self.state == CircuitState.HALF_OPEN:
                logger.info("–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, Circuit Breaker –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è")
                self.state = CircuitState.CLOSED
                self.failure_count = 0
            elif self.state == CircuitState.CLOSED:
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –≤ –∑–∞–∫—Ä—ã—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                self.failure_count = 0
            return result
            
        except self.expected_exception as e:
            self.failure_count += 1
            self.last_failure_time = time.time()
            
            logger.warning(
                f"–û—à–∏–±–∫–∞ –≤ Circuit Breaker (–ø–æ–ø—ã—Ç–∫–∞ {self.failure_count}/{self.failure_threshold}): {e}"
            )
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–∫—Ä—ã—Ç—å circuit
            if self.failure_count >= self.failure_threshold:
                self.state = CircuitState.OPEN
                logger.error(
                    f"Circuit Breaker –æ—Ç–∫—Ä—ã—Ç –ø–æ—Å–ª–µ {self.failure_count} –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫. "
                    f"–ó–∞–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ {self.recovery_timeout} —Å–µ–∫—É–Ω–¥."
                )
            
            # –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
            raise
    
    def reset(self):
        """–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ."""
        self.failure_count = 0
        self.last_failure_time = None
        self.state = CircuitState.CLOSED
        logger.info("Circuit Breaker —Å–±—Ä–æ—à–µ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ CLOSED")
    
    def get_state(self) -> CircuitState:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ Circuit Breaker."""
        return self.state


class CircuitBreakerOpenError(Exception):
    """–ò—Å–∫–ª—é—á–µ–Ω–∏–µ, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º–æ–µ –∫–æ–≥–¥–∞ Circuit Breaker –æ—Ç–∫—Ä—ã—Ç."""
    pass


# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã Circuit Breaker –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
_promotions_circuit_breaker = CircuitBreaker(
    failure_threshold=5,
    recovery_timeout=60,
    expected_exception=Exception
)

_appeals_circuit_breaker = CircuitBreaker(
    failure_threshold=5,
    recovery_timeout=60,
    expected_exception=Exception
)

_auth_circuit_breaker = CircuitBreaker(
    failure_threshold=5,
    recovery_timeout=60,
    expected_exception=Exception
)


def get_promotions_circuit_breaker() -> CircuitBreaker:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Circuit Breaker –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∞–∫—Ü–∏–π."""
    return _promotions_circuit_breaker


def get_appeals_circuit_breaker() -> CircuitBreaker:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Circuit Breaker –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
    return _appeals_circuit_breaker


def get_auth_circuit_breaker() -> CircuitBreaker:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç Circuit Breaker –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏."""
    return _auth_circuit_breaker


================================================================================
FILE: ./test_appeals.py
SIZE: 1904 bytes
================================================================================

#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ —Ç–∞–±–ª–∏—Ü—É.
"""

import logging
from dotenv import load_dotenv
from appeals_service import AppealsService

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)

def test_appeals():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è."""
    logger.info("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π...")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
    appeals_service = AppealsService()
    
    if not appeals_service.is_available():
        logger.error("AppealsService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!")
        return False
    
    logger.info("AppealsService –¥–æ—Å—Ç—É–ø–µ–Ω")
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_data = {
        'code': 'TEST001',
        'phone': '89199999999',
        'fio': '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        'telegram_id': 123456789,
        'text': '–¢–µ—Å—Ç–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É'
    }
    
    logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è: {test_data}")
    
    # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
    result = appeals_service.create_appeal(
        code=test_data['code'],
        phone=test_data['phone'],
        fio=test_data['fio'],
        telegram_id=test_data['telegram_id'],
        text=test_data['text']
    )
    
    if result:
        logger.info("‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ!")
        return True
    else:
        logger.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è!")
        return False

if __name__ == "__main__":
    test_appeals()


================================================================================
FILE: ./webhook_handler.py
SIZE: 15468 bytes
================================================================================

"""
Webhook handler –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç Google Sheets
"""
import logging
import os
from flask import Flask, request, jsonify
from telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from auth_service import AuthService

logger = logging.getLogger(__name__)

app = Flask(__name__, static_folder='.', static_url_path='')

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ —Å–µ—Ä–≤–∏—Å–æ–≤
bot_token = os.getenv('TELEGRAM_TOKEN')
admin_telegram_id = int(os.getenv('ADMIN_TELEGRAM_ID', '0'))
web_app_url = os.getenv('WEB_APP_URL', '')

bot = Bot(token=bot_token)
auth_service = AuthService()

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º API –∞–∫—Ü–∏–π
import promotions_api

@app.after_request
def after_request(response):
    """–î–æ–±–∞–≤–ª—è–µ–º CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤"""
    response.headers.add('Access-Control-Allow-Origin', '*')
    response.headers.add('Access-Control-Allow-Headers', 'Content-Type,Authorization')
    response.headers.add('Access-Control-Allow-Methods', 'GET,PUT,POST,DELETE,OPTIONS')
    return response

@app.route('/api/promotions', methods=['GET'])
def get_promotions_api():
    """API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ü–∏–π"""
    try:
        import asyncio
        from sheets_gateway import AsyncGoogleSheetsGateway
        
        logger.info("API Request: GET /api/promotions")
        
        # –°–æ–∑–¥–∞–µ–º gateway –¥–ª—è promotions
        promotions_gateway = AsyncGoogleSheetsGateway(circuit_breaker_name='promotions')
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º asyncio.run –¥–ª—è –≤—ã–∑–æ–≤–∞ async —Ñ—É–Ω–∫—Ü–∏–∏
        promotions_json = asyncio.run(promotions_api.get_promotions_json(promotions_gateway))
        return promotions_json, 200, {'Content-Type': 'application/json'}
    except Exception as e:
        logger.error(f"API Error: {e}")
        return jsonify({'error': 'Internal Server Error'}), 500


@app.route('/api/profile', methods=['GET'])
def get_profile():
    """API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ Telegram ID."""
    try:
        telegram_id = request.args.get('telegram_id')
        if not telegram_id:
            return jsonify({'error': 'telegram_id is required'}), 400

        if not auth_service or not auth_service.worksheet:
            logger.error("AuthService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è /api/profile")
            return jsonify({'error': 'auth_service_unavailable'}), 500

        records = auth_service.worksheet.get_all_records()
        for record in records:
            if str(record.get('Telegram ID', '')) == str(telegram_id):
                profile = {
                    'full_name': record.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                    'partner_code': record.get('–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                    'phone': record.get('–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞', ''),
                }
                return jsonify(profile), 200

        logger.info(f"–ü—Ä–æ—Ñ–∏–ª—å –¥–ª—è telegram_id={telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏")
        return jsonify({'error': 'user_not_found'}), 404
    except Exception as e:
        logger.error(f"API Error in /api/profile: {e}")
        return jsonify({'error': 'Internal Server Error'}), 500

@app.route('/webhook/promotions', methods=['GET', 'POST'])
def handle_promotion_webhook():
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –æ—Ç Google Sheets –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–π"""
    # –î–ª—è GET –∑–∞–ø—Ä–æ—Å–∞ (–∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ) - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    if request.method == 'GET':
        return jsonify({
            'status': 'webhook_active',
            'message': 'Webhook endpoint –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–π',
            'method': 'POST',
            'url': '/webhook/promotions',
            'note': '–≠—Ç–æ—Ç endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å POST –∑–∞–ø—Ä–æ—Å–∞–º–∏. –ë—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç GET –∑–∞–ø—Ä–æ—Å, –ø–æ—ç—Ç–æ–º—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.'
        }), 200
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ POST –∑–∞–ø—Ä–æ—Å–∞ (–æ—Ç Google Apps Script)
    try:
        data = request.get_json()
        promotion_data = data.get('promotion', {})
        action = data.get('action', '')
        title = promotion_data.get('title', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∞–∫—Ü–∏—è')
        status = promotion_data.get('status', '')
        
        logger.info(f"–ü–æ–ª—É—á–µ–Ω webhook –æ—Ç Google Sheets: action={action}, title='{title}', status='{status}'")
        logger.info(f"–î–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏: {promotion_data}")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        secret_key = request.headers.get('X-Webhook-Secret')
        expected_secret = os.getenv('WEBHOOK_SECRET', 'default_secret')
        
        if secret_key != expected_secret:
            logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á webhook: –ø–æ–ª—É—á–µ–Ω '{secret_key}', –æ–∂–∏–¥–∞–µ—Ç—Å—è '{expected_secret}'")
            return jsonify({'error': 'Unauthorized'}), 401
        
        if action == 'publish':
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –≤ –Ω–æ–≤–æ–º event loop
            import asyncio
            import threading
            
            def run_async(coro):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                try:
                    loop.run_until_complete(coro)
                finally:
                    loop.close()
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç webhook
            threading.Thread(target=run_async, args=(send_promotion_notification(promotion_data),), daemon=True).start()
        elif action == 'update':
            import asyncio
            import threading
            
            def run_async(coro):
                loop = asyncio.new_event_loop()
                asyncio.set_event_loop(loop)
                try:
                    loop.run_until_complete(coro)
                finally:
                    loop.close()
            
            threading.Thread(target=run_async, args=(send_promotion_update_notification(promotion_data),), daemon=True).start()
        
        return jsonify({'status': 'success'})
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ webhook handler: {e}", exc_info=True)
        return jsonify({'error': 'Internal server error'}), 500

async def send_promotion_notification(promotion_data):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∞–∫—Ü–∏–∏ –≤—Å–µ–º –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    try:
        title = promotion_data.get('title', '–ù–æ–≤–∞—è –∞–∫—Ü–∏—è')
        description = promotion_data.get('description', '')
        start_date = promotion_data.get('start_date', '')
        end_date = promotion_data.get('end_date', '')
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ü–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
        # Webhook —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ê–∫—Ç–∏–≤–Ω–∞"
        message = "üéâ **–ù–æ–≤–∞—è –∞–∫—Ü–∏—è!**\n\n"
        message += f"**{title}**\n\n"
        if description:
            message += f"üìù {description}\n\n"
        if start_date and end_date:
            message += f"üìÖ –ü–µ—Ä–∏–æ–¥: {start_date} - {end_date}\n\n"
        message += "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–∫—Ü–∏–∏!"
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini App (–¥–æ–±–∞–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞)
        version = "v=20260108-2"
        menu_url = (
            f"{web_app_url}menu.html?{version}#promotions"
            if web_app_url.endswith('/')
            else f"{web_app_url}/menu.html?{version}#promotions"
        )
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(
                "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–∫—Ü–∏–∏", 
                web_app=WebAppInfo(url=menu_url)
            )]
        ])
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        logger.info(f"üë• –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∞–∫—Ü–∏–∏ '{title}'")
        authorized_users = get_authorized_users()
        logger.info(f"üë• –ù–∞–π–¥–µ–Ω–æ {len(authorized_users)} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
        
        if not authorized_users:
            logger.warning(f"‚ö†Ô∏è –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∞–∫—Ü–∏–∏ '{title}'")
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –µ—Å–ª–∏ –µ—Å—Ç—å
            if admin_telegram_id:
                try:
                    await bot.send_message(
                        chat_id=admin_telegram_id,
                        text=f"‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏**\n\n"
                             f"–ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–∫—Ü–∏–∏ '{title}' –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ, –Ω–æ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.\n\n"
                             f"–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.",
                        parse_mode='Markdown'
                    )
                    logger.info(f"üìß –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É {admin_telegram_id}")
                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        sent_count = 0
        failed_count = 0
        for user_id in authorized_users:
            try:
                await bot.send_message(
                    chat_id=user_id,
                    text=message,
                    parse_mode='Markdown',
                    reply_markup=keyboard
                )
                sent_count += 1
                logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{title}' (—Å—Ç–∞—Ç—É—Å: {status}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
            except Exception as e:
                failed_count += 1
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
        
        logger.info(f"üìä –ò—Ç–æ–≥–æ: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∞–∫—Ü–∏–∏ '{title}' (—Å—Ç–∞—Ç—É—Å: {status}) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –æ—à–∏–±–æ–∫: {failed_count}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∞–∫—Ü–∏–∏: {e}", exc_info=True)

async def send_promotion_update_notification(promotion_data):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Ü–∏–∏"""
    try:
        title = promotion_data.get('title', '–ê–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞')
        
        message = "üîÑ **–ê–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!**\n\n"
        message += f"**{title}**\n\n"
        message += "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ü–∏–∏ –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!"
        
        version = "v=20260108-2"
        menu_url = (
            f"{web_app_url}menu.html?{version}#promotions"
            if web_app_url.endswith('/')
            else f"{web_app_url}/menu.html?{version}#promotions"
        )
        keyboard = InlineKeyboardMarkup([
            [InlineKeyboardButton(
                "üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∞–∫—Ü–∏–∏", 
                web_app=WebAppInfo(url=menu_url)
            )]
        ])
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
        if admin_telegram_id:
            await bot.send_message(
                chat_id=admin_telegram_id,
                text=message,
                parse_mode='Markdown',
                reply_markup=keyboard
            )
            logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Ü–∏–∏ '{title}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω—É")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–∫—Ü–∏–∏: {e}")

def get_authorized_users():
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    try:
        if not auth_service or not auth_service.worksheet:
            logger.error("AuthService –∏–ª–∏ worksheet –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return []
            
        records = auth_service.worksheet.get_all_records()
        logger.info(f"üìã –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {len(records)}")
        authorized_users = []
        
        for record in records:
            status = record.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', '').strip().lower()
            telegram_id_str = record.get('Telegram ID', '')
            
            # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞: —Ä—É—Å—Å–∫–∏–π "–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω" –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π "authorized"
            is_authorized = status in ('–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 'authorized')
            
            if is_authorized and telegram_id_str:
                try:
                    telegram_id = int(telegram_id_str)
                    authorized_users.append(telegram_id)
                    logger.debug(f"‚úÖ –ù–∞–π–¥–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ID={telegram_id}, —Å—Ç–∞—Ç—É—Å='{record.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', '')}'")
                except (ValueError, TypeError) as e:
                    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å Telegram ID –≤ —á–∏—Å–ª–æ: '{telegram_id_str}' –¥–ª—è –∑–∞–ø–∏—Å–∏: {record.get('–§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞', 'N/A')}")
                    continue
            elif telegram_id_str:
                logger.debug(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (—Å—Ç–∞—Ç—É—Å='{record.get('–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', '')}'): ID={telegram_id_str}")
        
        logger.info(f"üìã –ù–∞–π–¥–µ–Ω–æ {len(authorized_users)} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ {len(records)} –∑–∞–ø–∏—Å–µ–π")
        if authorized_users:
            logger.info(f"üìã –°–ø–∏—Å–æ–∫ ID –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {authorized_users[:10]}")  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10
        return authorized_users
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}", exc_info=True)
        return []

@app.route('/')
def index():
    """Serve the authorization page"""
    return app.send_static_file('index.html')

@app.route('/menu.html')
def menu():
    """Serve the menu page"""
    return app.send_static_file('menu.html')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, debug=False)


================================================================================
FILE: ./–ò–ù–°–¢–†–£–ö–¶–ò–Ø_–ü–û_–£–°–¢–ê–ù–û–í–ö–ï.txt
SIZE: 4049 bytes
================================================================================

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  –ü–û–õ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –£–°–¢–ê–ù–û–í–ö–ï –°–ö–†–ò–ü–¢–ê –í GOOGLE –¢–ê–ë–õ–ò–¶–£
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–®–ê–ì 1: –û–¢–ö–†–´–¢–¨ GOOGLE APPS SCRIPT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É Google –¢–∞–±–ª–∏—Ü—É —Å –∞–∫—Ü–∏—è–º–∏
2. –í –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ: –†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script
3. –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script

–®–ê–ì 2: –í–°–¢–ê–í–ò–¢–¨ –°–ö–†–ò–ü–¢
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –≤—ã–¥–µ–ª–∏—Ç–µ –í–ï–°–¨ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (Ctrl+A –∏–ª–∏ Cmd+A)
2. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ (Delete)
3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª GOOGLE_APPS_SCRIPT_FULL.js –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –í–ï–°–¨ –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ (Ctrl+A, Ctrl+C)
5. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script (Ctrl+V)
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: Ctrl+S (–∏–ª–∏ Cmd+S –Ω–∞ Mac)

–®–ê–ì 3: –†–ê–ó–í–ï–†–ù–£–¢–¨ –ö–ê–ö –í–ï–ë-–ü–†–ò–õ–û–ñ–ï–ù–ò–ï
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" (Deploy) –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
2. –í—ã–±–µ—Ä–∏—Ç–µ "–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ" (New deployment)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∏ ‚öôÔ∏è —Ä—è–¥–æ–º —Å "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø"
4. –í—ã–±–µ—Ä–∏—Ç–µ "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" (Web app)
5. –í –ø–æ–ª–µ "–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø" –≤—ã–±–µ—Ä–∏—Ç–µ "–í—Å–µ" (Anyone)
6. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" (Deploy)

–®–ê–ì 4: –°–ö–û–ü–ò–†–û–í–ê–¢–¨ URL
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ —Å URL
2. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Copy" —Ä—è–¥–æ–º —Å URL
3. URL –±—É–¥–µ—Ç –≤–∏–¥–∞: https://script.google.com/macros/s/.../exec
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL

–®–ê–ì 5: –û–ë–ù–û–í–ò–¢–¨ menu.html (–£–ñ–ï –°–î–ï–õ–ê–ù–û!)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ URL —É–∂–µ –≤—Å—Ç–∞–≤–ª–µ–Ω –≤ menu.html –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
‚úÖ –§–∞–π–ª menu.html —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω!

–®–ê–ì 6: –ü–†–û–í–ï–†–ò–¢–¨ –†–ê–ë–û–¢–£
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  –í–°–Å –ì–û–¢–û–í–û! –ê–ö–¶–ò–ò –ë–£–î–£–¢ –ó–ê–ì–†–£–ñ–ê–¢–¨–°–Ø –ß–ï–†–ï–ó GOOGLE APPS SCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


================================================================================
FILE: ./–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï_CORS.md
SIZE: 2125 bytes
================================================================================

# üîß –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∞–∫—Ü–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ "Failed to fetch" –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫—Ü–∏–π. –≠—Ç–æ **CORS –æ—à–∏–±–∫–∞** –≤ Google Apps Script.

## –†–µ—à–µ–Ω–∏–µ (3 –º–∏–Ω—É—Ç—ã)

### –®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://script.google.com
2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç —Å –∞–∫—Ü–∏—è–º–∏

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞
1. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** ‚Üí **"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"**
2. –ù–∞–π–¥–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (—Ç–∏–ø: "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É **‚úèÔ∏è (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å)** —Å–ø—Ä–∞–≤–∞
4. –í –ø–æ–ª–µ **"–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø"** –≤—ã–±–µ—Ä–∏—Ç–µ **"–í—Å–µ"** (Anyone)
5. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É
1. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã
2. –û—Ç–∫—Ä–æ–π—Ç–µ URL —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
3. –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è **JSON**, –∞ –Ω–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
4. –û–±–Ω–æ–≤–∏—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram

## –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ

–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ:
1. "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"
2. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
3. "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
4. –¢–∏–ø: "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
5. **–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø: "–í—Å–µ"** ‚Üê –í–ê–ñ–ù–û!
6. "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"
7. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π URL –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –≤ `menu.html` (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è)

## –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ URL –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–µ—Ç CORS –æ—à–∏–±–æ–∫
- ‚úÖ –ê–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏


================================================================================
FILE: ./migrations/__init__.py
SIZE: 21 bytes
================================================================================

# Migrations package


================================================================================
FILE: ./migrations/migrate_appeals.py
SIZE: 11285 bytes
================================================================================

"""
–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∏–∑ Google Sheets –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Google Sheets –≤ SQLite –ë–î.
"""
import os
import sys
import logging
from datetime import datetime
from dotenv import load_dotenv

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

load_dotenv()

# –ò–º–ø–æ—Ä—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ .env
import gspread
from google.oauth2.service_account import Credentials
import json
from db.database import SessionLocal, init_db
from db.models import Appeal, AppealMessage

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def load_service_account():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ Service Account –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    sa_json = os.environ.get('GCP_SA_JSON')
    sa_file = os.environ.get('GCP_SA_FILE')
    
    if sa_json:
        return json.loads(sa_json)
    elif sa_file and os.path.exists(sa_file):
        with open(sa_file, 'r', encoding='utf-8') as f:
            return json.load(f)
    else:
        raise ValueError('Service account JSON not provided (GCP_SA_JSON or GCP_SA_FILE)')


def connect_to_sheets():
    """–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Google Sheets —Ç–∞–±–ª–∏—Ü–µ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
    try:
        sa_info = load_service_account()
        creds = Credentials.from_service_account_info(sa_info, scopes=[
            'https://www.googleapis.com/auth/spreadsheets',
            'https://www.googleapis.com/auth/drive'
        ])
        client = gspread.authorize(creds)
        
        sheet_id = os.environ.get('APPEALS_SHEET_ID')
        if not sheet_id:
            raise ValueError('APPEALS_SHEET_ID not provided')
        
        spreadsheet = client.open_by_key(sheet_id)
        sheet_name = os.environ.get('APPEALS_SHEET_NAME', '–æ–±—Ä–∞—â–µ–Ω–∏—è')
        
        try:
            worksheet = spreadsheet.worksheet(sheet_name)
        except Exception:
            worksheet = spreadsheet.sheet1
            logger.warning(f"–õ–∏—Å—Ç '{sheet_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç")
        
        logger.info(f"–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ç–∞–±–ª–∏—Ü–µ: {spreadsheet.title}, –ª–∏—Å—Ç: {worksheet.title}")
        return worksheet
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets: {e}")
        raise


def parse_appeals_text(text: str) -> list:
    """
    –ü–∞—Ä—Å–∏—Ç —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∏–∑ Google Sheets –≤ —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
    
    –§–æ—Ä–º–∞—Ç –≤ Google Sheets:
    2026-01-05 14:43:49: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç
    2026-01-05 14:44:12: ü§ñ –ò–ò: –û—Ç–≤–µ—Ç –ò–ò
    2026-01-05 14:45:30: üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢: –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
    """
    if not text or not text.strip():
        return []
    
    messages = []
    lines = text.split('\n')
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É
        if 'ü§ñ –ò–ò:' in line or '–ò–ò:' in line:
            message_type = 'ai'
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–∞—Ç—ã –∏ –ø—Ä–µ—Ñ–∏–∫—Å –ò–ò
            parts = line.split(':', 2)
            if len(parts) >= 3:
                message_text = parts[2].strip()
            else:
                message_text = line.replace('ü§ñ –ò–ò:', '').replace('–ò–ò:', '').strip()
        elif 'üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢:' in line or '–°–ü–ï–¶–ò–ê–õ–ò–°–¢:' in line:
            message_type = 'specialist'
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–∞—Ç—ã –∏ –ø—Ä–µ—Ñ–∏–∫—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            parts = line.split(':', 2)
            if len(parts) >= 3:
                message_text = parts[2].strip()
            else:
                message_text = line.replace('üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢:', '').replace('–°–ü–ï–¶–ò–ê–õ–ò–°–¢:', '').strip()
        elif '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:' in line:
            message_type = 'user'
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –¥–∞—Ç—ã –∏ "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:"
            parts = line.split(':', 2)
            if len(parts) >= 3:
                message_text = parts[2].strip()
            else:
                message_text = line.split('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', 1)[-1].strip()
        else:
            # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—á–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            message_type = 'user'
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –¥–∞—Ç—ã
            if ':' in line:
                parts = line.split(':', 1)
                message_text = parts[-1].strip() if len(parts) > 1 else line
            else:
                message_text = line
        
        if message_text:
            # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –¥–∞—Ç—É –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏
            created_at = None
            if len(line) >= 19 and line[4] == '-' and line[7] == '-':
                try:
                    date_str = line[:19]
                    created_at = datetime.strptime(date_str, '%Y-%m-%d %H:%M:%S')
                except ValueError:
                    created_at = datetime.utcnow()
            else:
                created_at = datetime.utcnow()
            
            messages.append({
                'type': message_type,
                'text': message_text,
                'created_at': created_at
            })
    
    return messages


def migrate_appeals():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏."""
    logger.info("=" * 60)
    logger.info("–ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∏–∑ Google Sheets –≤ –ë–î")
    logger.info("=" * 60)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
    try:
        init_db()
        logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    except Exception as e:
        logger.warning(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞: {e}")
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    try:
        worksheet = connect_to_sheets()
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google Sheets: {e}")
        return False
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    db = SessionLocal()
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ Google Sheets
        logger.info("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...")
        records = worksheet.get_all_records()
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(records)} –∑–∞–ø–∏—Å–µ–π –≤ Google Sheets")
        
        migrated_count = 0
        skipped_count = 0
        error_count = 0
        
        for i, record in enumerate(records, 1):
            try:
                telegram_id = record.get('telegram_id', '')
                if not telegram_id:
                    logger.warning(f"–ó–∞–ø–∏—Å—å {i}: –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–Ω–µ—Ç telegram_id)")
                    skipped_count += 1
                    continue
                
                telegram_id = int(telegram_id)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ë–î
                existing = db.query(Appeal).filter(
                    Appeal.telegram_id == telegram_id
                ).first()
                
                if existing:
                    logger.info(f"–ó–∞–ø–∏—Å—å {i}: –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è telegram_id {telegram_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                    skipped_count += 1
                    continue
                
                # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
                appeal = Appeal(
                    telegram_id=telegram_id,
                    partner_code=str(record.get('–∫–æ–¥', '') or ''),
                    phone=str(record.get('—Ç–µ–ª–µ—Ñ–æ–Ω', '') or ''),
                    fio=str(record.get('–§–ò–û', '') or ''),
                    status=str(record.get('—Å—Ç–∞—Ç—É—Å', '–Ω–æ–≤–æ–µ') or '–Ω–æ–≤–æ–µ').lower()
                )
                
                # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                updated_time = record.get('–≤—Ä–µ–º—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', '')
                if updated_time:
                    try:
                        appeal.created_at = datetime.strptime(updated_time, '%Y-%m-%d %H:%M:%S')
                        appeal.updated_at = appeal.created_at
                    except ValueError:
                        pass
                
                db.add(appeal)
                db.flush()  # –ü–æ–ª—É—á–∞–µ–º ID
                
                # –ü–∞—Ä—Å–∏–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
                appeals_text = record.get('—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π', '')
                if appeals_text:
                    messages = parse_appeals_text(appeals_text)
                    for msg_data in messages:
                        message = AppealMessage(
                            appeal_id=appeal.id,
                            message_type=msg_data['type'],
                            message_text=msg_data['text'],
                            created_at=msg_data['created_at']
                        )
                        db.add(message)
                
                # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                specialist_response = record.get('—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç', '')
                if specialist_response and specialist_response.strip():
                    # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    message = AppealMessage(
                        appeal_id=appeal.id,
                        message_type='specialist',
                        message_text=f"üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢: {specialist_response.strip()}"
                    )
                    db.add(message)
                
                db.commit()
                migrated_count += 1
                logger.info(f"–ó–∞–ø–∏—Å—å {i}: –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è telegram_id {telegram_id} (ID: {appeal.id})")
                
            except Exception as e:
                logger.error(f"–ó–∞–ø–∏—Å—å {i}: –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ - {e}", exc_info=True)
                db.rollback()
                error_count += 1
                continue
        
        logger.info("=" * 60)
        logger.info("–ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        logger.info(f"–£—Å–ø–µ—à–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ: {migrated_count}")
        logger.info(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {skipped_count}")
        logger.info(f"–û—à–∏–±–æ–∫: {error_count}")
        logger.info("=" * 60)
        
        return True
        
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {e}", exc_info=True)
        db.rollback()
        return False
    finally:
        db.close()


if __name__ == "__main__":
    success = migrate_appeals()
    sys.exit(0 if success else 1)


================================================================================
FILE: ./admin/README.md
SIZE: 2001 bytes
================================================================================

# –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ó–∞–º–µ–Ω–∞ Google Sheets —Ç–∞–±–ª–∏—Ü—ã.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ PythonAnywhere

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞–ø–∫—É `admin/` –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ PythonAnywhere:
   - Web ‚Üí Static files
   - URL: `/admin/`
   - Directory: `/home/yourusername/marketingbot/admin/`

3. –î–æ—Å—Ç—É–ø: `https://yourusername.pythonanywhere.com/admin/`

### 2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

**–î–ª—è MVP:**
- –õ–æ–≥–∏–Ω: `admin`
- –ü–∞—Ä–æ–ª—å: `admin`

‚ö†Ô∏è **–í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å!**

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ REST API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:
- `https://yourusername.pythonanywhere.com/api/appeals`

–ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ `API_BASE_URL` –≤ `app.js`:
```javascript
const API_BASE_URL = 'https://your-api-url.com/api';
```

## üì± –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å)
- ‚úÖ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É
- ‚úÖ –î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è
- ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:**

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ JWT —Ç–æ–∫–µ–Ω—ã
2. –î–æ–±–∞–≤–∏—Ç—å HTTPS
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –ø—Ä–∞–≤–∏–ª—å–Ω–æ
4. –î–æ–±–∞–≤–∏—Ç—å rate limiting
5. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## üé® –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

–í—Å–µ —Å—Ç–∏–ª–∏ –≤ `styles.css`, –ª–æ–≥–∏–∫–∞ –≤ `app.js`.

---

**–í–µ—Ä—Å–∏—è**: MVP 1.0


================================================================================
FILE: ./admin/app.js
SIZE: 14055 bytes
================================================================================

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
const API_BASE_URL = window.location.origin + '/api';
// –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
// const API_BASE_URL = 'http://localhost:8000/api';

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let currentAppealId = null;
let authToken = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω
    authToken = localStorage.getItem('authToken');
    
    if (authToken) {
        showMainScreen();
        loadAppeals();
    } else {
        showLoginScreen();
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupEventHandlers();
});

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function setupEventHandlers() {
    // –õ–æ–≥–∏–Ω
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // –í—ã—Ö–æ–¥
    document.getElementById('logoutBtn').addEventListener('click', handleLogout);
    
    // –§–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤
    document.getElementById('statusFilter').addEventListener('change', (e) => {
        loadAppeals(e.target.value);
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    document.getElementById('refreshBtn').addEventListener('click', () => {
        loadAppeals(document.getElementById('statusFilter').value);
    });
    
    // –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
    document.getElementById('backBtn').addEventListener('click', () => {
        showMainScreen();
        loadAppeals();
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
    document.getElementById('sendResponseBtn').addEventListener('click', sendResponse);
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    document.getElementById('updateStatusBtn').addEventListener('click', updateStatus);
}

// –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–æ–≤
function showLoginScreen() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('detailScreen').classList.add('hidden');
}

function showMainScreen() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.remove('hidden');
    document.getElementById('detailScreen').classList.add('hidden');
}

function showDetailScreen() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainScreen').classList.add('hidden');
    document.getElementById('detailScreen').classList.remove('hidden');
}

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é)
    // –î–ª—è MVP –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä–æ–≤–µ—Ä–∫—É
    if (username === 'admin' && password === 'admin') {
        authToken = 'demo_token_' + Date.now();
        localStorage.setItem('authToken', authToken);
        errorDiv.classList.remove('show');
        showMainScreen();
        loadAppeals();
    } else {
        errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
        errorDiv.classList.add('show');
    }
}

function handleLogout() {
    authToken = null;
    localStorage.removeItem('authToken');
    showLoginScreen();
    document.getElementById('loginForm').reset();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
async function loadAppeals(status = '') {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const appealsList = document.getElementById('appealsList');
    
    loadingIndicator.style.display = 'block';
    appealsList.innerHTML = '';
    
    try {
        const url = status 
            ? `${API_BASE_URL}/appeals?status=${status}`
            : `${API_BASE_URL}/appeals`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π');
        }
        
        const appeals = await response.json();
        
        if (appeals.length === 0) {
            appealsList.innerHTML = '<div class="appeal-card"><p style="text-align: center; color: #888;">–û–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p></div>';
        } else {
            appealsList.innerHTML = appeals.map(appeal => createAppealCard(appeal)).join('');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
            appeals.forEach(appeal => {
                document.getElementById(`appeal-${appeal.id}`).addEventListener('click', () => {
                    showAppealDetail(appeal.id);
                });
            });
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π:', error);
        appealsList.innerHTML = '<div class="appeal-card"><p style="text-align: center; color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p></div>';
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
function createAppealCard(appeal) {
    const statusClass = `status-${appeal.status}`;
    const statusText = getStatusText(appeal.status);
    const createdDate = new Date(appeal.created_at).toLocaleString('ru-RU');
    
    return `
        <div class="appeal-card" id="appeal-${appeal.id}">
            <div class="appeal-header">
                <span class="status-badge ${statusClass}">${statusText}</span>
                <span class="appeal-date">${createdDate}</span>
            </div>
            <div class="appeal-info">
                <div class="info-item">
                    <span class="info-label">–§–ò–û</span>
                    <span class="info-value">${appeal.fio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                    <span class="info-value">${appeal.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</span>
                    <span class="info-value">${appeal.partner_code || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Telegram ID</span>
                    <span class="info-value">${appeal.telegram_id}</span>
                </div>
            </div>
        </div>
    `;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
function getStatusText(status) {
    const statusMap = {
        '–Ω–æ–≤–æ–µ': '–ù–æ–≤–æ–µ',
        '–≤_—Ä–∞–±–æ—Ç–µ': '–í —Ä–∞–±–æ—Ç–µ',
        '–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É': '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–æ—Ç–≤–µ—Ç_–∏–∏': '–û—Ç–≤–µ—Ç –ò–ò',
        '—Ä–µ—à–µ–Ω–æ': '–†–µ—à–µ–Ω–æ'
    };
    return statusMap[status] || status;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
async function showAppealDetail(appealId) {
    currentAppealId = appealId;
    showDetailScreen();
    
    const detailDiv = document.getElementById('appealDetail');
    detailDiv.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
        const appealResponse = await fetch(`${API_BASE_URL}/appeals/${appealId}`);
        if (!appealResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è');
        const appeal = await appealResponse.json();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        const messagesResponse = await fetch(`${API_BASE_URL}/appeals/${appealId}/messages`);
        if (!messagesResponse.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
        const messages = await messagesResponse.json();
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏
        detailDiv.innerHTML = createAppealDetailHTML(appeal, messages);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –≤ —Å–µ–ª–µ–∫—Ç
        document.getElementById('statusSelect').value = appeal.status;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:', error);
        detailDiv.innerHTML = '<p style="color: #e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ HTML –¥–µ—Ç–∞–ª–µ–π –æ–±—Ä–∞—â–µ–Ω–∏—è
function createAppealDetailHTML(appeal, messages) {
    const statusClass = `status-${appeal.status}`;
    const statusText = getStatusText(appeal.status);
    const createdDate = new Date(appeal.created_at).toLocaleString('ru-RU');
    const updatedDate = new Date(appeal.updated_at).toLocaleString('ru-RU');
    
    const messagesHTML = messages.map(msg => {
        const messageClass = `message-${msg.message_type}`;
        const messageTypeText = {
            'user': 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
            'ai': 'ü§ñ –ò–ò',
            'specialist': 'üë®‚Äçüíº –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç'
        }[msg.message_type] || msg.message_type;
        
        const messageDate = new Date(msg.created_at).toLocaleString('ru-RU');
        
        return `
            <div class="message ${messageClass}">
                <div class="message-header">
                    <span>${messageTypeText}</span>
                    <span>${messageDate}</span>
                </div>
                <div class="message-text">${escapeHtml(msg.message_text)}</div>
            </div>
        `;
    }).join('');
    
    return `
        <div class="detail-header">
            <span class="status-badge ${statusClass}">${statusText}</span>
        </div>
        <div class="detail-info">
            <div class="info-item">
                <span class="info-label">ID –æ–±—Ä–∞—â–µ–Ω–∏—è</span>
                <span class="info-value">#${appeal.id}</span>
            </div>
            <div class="info-item">
                <span class="info-label">–§–ò–û</span>
                <span class="info-value">${appeal.fio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                <span class="info-value">${appeal.phone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞</span>
                <span class="info-value">${appeal.partner_code || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">Telegram ID</span>
                <span class="info-value">${appeal.telegram_id}</span>
            </div>
            <div class="info-item">
                <span class="info-label">–°–æ–∑–¥–∞–Ω–æ</span>
                <span class="info-value">${createdDate}</span>
            </div>
            <div class="info-item">
                <span class="info-label">–û–±–Ω–æ–≤–ª–µ–Ω–æ</span>
                <span class="info-value">${updatedDate}</span>
            </div>
        </div>
        <div class="messages-section">
            <h3 class="messages-title">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h3>
            ${messagesHTML || '<p style="color: #888;">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>'}
        </div>
    `;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞
async function sendResponse() {
    const responseText = document.getElementById('responseText').value.trim();
    
    if (!responseText) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞');
        return;
    }
    
    if (!currentAppealId) {
        alert('–û—à–∏–±–∫–∞: ID –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/appeals/${currentAppealId}/response`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                response_text: responseText,
                specialist_name: '–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç'
            })
        });
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
        }
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.getElementById('responseText').value = '';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
        showAppealDetail(currentAppealId);
        
        alert('–û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
    }
}

// –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
async function updateStatus() {
    const newStatus = document.getElementById('statusSelect').value;
    
    if (!currentAppealId) {
        alert('–û—à–∏–±–∫–∞: ID –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE_URL}/appeals/${currentAppealId}/status?status=${newStatus}`, {
            method: 'PATCH'
        });
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
        showAppealDetail(currentAppealId);
        
        alert('–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
    }
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


================================================================================
FILE: ./admin/index.html
SIZE: 3584 bytes
================================================================================

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –û–±—Ä–∞—â–µ–Ω–∏—è</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loginScreen" class="screen">
        <div class="login-container">
            <h1>üîê –í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">–õ–æ–≥–∏–Ω:</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <div id="mainScreen" class="screen hidden">
        <header class="header">
            <h1>üìã –û–±—Ä–∞—â–µ–Ω–∏—è</h1>
            <div class="header-actions">
                <select id="statusFilter" class="filter-select">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–Ω–æ–≤–æ–µ">–ù–æ–≤–æ–µ</option>
                    <option value="–≤_—Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É">–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É</option>
                    <option value="–æ—Ç–≤–µ—Ç_–∏–∏">–û—Ç–≤–µ—Ç –ò–ò</option>
                    <option value="—Ä–µ—à–µ–Ω–æ">–†–µ—à–µ–Ω–æ</option>
                </select>
                <button id="refreshBtn" class="btn btn-secondary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button id="logoutBtn" class="btn btn-danger">–í—ã–π—Ç–∏</button>
            </div>
        </header>

        <div class="content">
            <div id="loadingIndicator" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="appealsList" class="appeals-list"></div>
        </div>
    </div>

    <div id="detailScreen" class="screen hidden">
        <header class="header">
            <button id="backBtn" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</button>
            <h1>–î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h1>
        </header>

        <div class="content">
            <div id="appealDetail" class="appeal-detail"></div>
            
            <div class="response-section">
                <h3>–û—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</h3>
                <textarea id="responseText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç..."></textarea>
                <div class="response-actions">
                    <button id="sendResponseBtn" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
                    <select id="statusSelect" class="status-select">
                        <option value="–≤_—Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="—Ä–µ—à–µ–Ω–æ">–†–µ—à–µ–Ω–æ</option>
                        <option value="–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É">–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É</option>
                    </select>
                    <button id="updateStatusBtn" class="btn btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>


================================================================================
FILE: ./admin/styles.css
SIZE: 6234 bytes
================================================================================

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.screen {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.screen.hidden {
    display: none;
}

/* Login Screen */
.login-container {
    max-width: 400px;
    margin: 100px auto;
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.login-container h1 {
    text-align: center;
    margin-bottom: 30px;
    color: #667eea;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
}

.form-group input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
}

.error-message {
    color: #e74c3c;
    margin-top: 10px;
    text-align: center;
    display: none;
}

.error-message.show {
    display: block;
}

/* Header */
.header {
    background: white;
    padding: 20px 30px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.header h1 {
    color: #667eea;
    font-size: 24px;
}

.header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.filter-select, .status-select {
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
}

/* Content */
.content {
    flex: 1;
    padding: 30px;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

.loading {
    text-align: center;
    padding: 40px;
    color: white;
    font-size: 18px;
}

/* Appeals List */
.appeals-list {
    display: grid;
    gap: 20px;
}

.appeal-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    transition: all 0.3s;
}

.appeal-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

.appeal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-–Ω–æ–≤–æ–µ {
    background: #f3cccc;
    color: #8b0000;
}

.status-–≤_—Ä–∞–±–æ—Ç–µ {
    background: #fff2cc;
    color: #856404;
}

.status-–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É {
    background: #f3cccc;
    color: #8b0000;
}

.status-–æ—Ç–≤–µ—Ç_–∏–∏ {
    background: #ffffff;
    color: #333;
    border: 1px solid #ddd;
}

.status-—Ä–µ—à–µ–Ω–æ {
    background: #d9ead3;
    color: #155724;
}

.appeal-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.info-item {
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 12px;
    color: #888;
    margin-bottom: 4px;
}

.info-value {
    font-size: 14px;
    font-weight: 500;
    color: #333;
}

.appeal-date {
    font-size: 12px;
    color: #888;
}

/* Appeal Detail */
.appeal-detail {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    margin-bottom: 30px;
}

.detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.detail-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.messages-section {
    margin-top: 30px;
}

.messages-title {
    font-size: 18px;
    margin-bottom: 20px;
    color: #667eea;
}

.message {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border-left: 4px solid #667eea;
}

.message-user {
    background: #f8f9fa;
    border-left-color: #667eea;
}

.message-ai {
    background: #e3f2fd;
    border-left-color: #2196f3;
}

.message-specialist {
    background: #fff3e0;
    border-left-color: #ff9800;
}

.message-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 12px;
    color: #888;
}

.message-text {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
}

/* Response Section */
.response-section {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.response-section h3 {
    margin-bottom: 15px;
    color: #667eea;
}

.response-section textarea {
    width: 100%;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    resize: vertical;
    margin-bottom: 15px;
}

.response-section textarea:focus {
    outline: none;
    border-color: #667eea;
}

.response-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
}

/* Responsive */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        align-items: flex-start;
    }

    .header-actions {
        width: 100%;
    }

    .content {
        padding: 15px;
    }

    .appeal-info {
        grid-template-columns: 1fr;
    }
}


================================================================================
FILE: ./docs/ARCHITECTURE.md
SIZE: 13399 bytes
================================================================================

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ MarketingBot v3.2

## –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

MarketingBot v3.2 - —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ —Å–∏—Å—Ç–µ–º–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏. –°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞ –Ω–∞ PythonAnywhere –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏.

## üèóÔ∏è –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:
- **`bot.py`** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–µ—Ä–≤–∏—Å–æ–≤
- **`handlers.py`** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π (31KB)
- **`auth_service.py`** ‚Äî —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (13KB)
- **`sheets.py`** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets (7KB)
- **`appeals_service.py`** ‚Äî —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π (24KB)
- **`openai_service.py`** ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI (3KB)
- **`response_monitor.py`** ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ (8KB)
- **`promotions_api.py`** ‚Äî API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏ (10KB)
- **`promotions_notifier.py`** ‚Äî —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–∫—Ü–∏—è—Ö (7KB)
- **`webhook_handler.py`** ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ webhook –¥–ª—è Flask (7KB)

### WebApp (Mini App):
- **`index.html`** ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- **`menu.html`** ‚Äî –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å –∞–∫—Ü–∏—è–º–∏, —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏
- **`app.js`** ‚Äî JavaScript –¥–ª—è WebApp

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- **`.env`** ‚Äî –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **`requirements.txt`** ‚Äî –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** ‚Äî –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏** ‚Äî —á–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Äî –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** ‚Äî –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

## üîÑ –ü–æ—Ç–æ–∫–∏ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:
```bash
# –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫
python3 bot.py

# –° –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º
.venv/bin/python bot.py
```

### –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`
2. **–ë–æ—Ç** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `AuthService`
3. **–ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω**: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É —Å `index.html` (—Ñ–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
4. **–ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω**: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É —Å `menu.html` (–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)
5. **WebApp** —Å–æ–±–∏—Ä–∞–µ—Ç –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ + —Ç–µ–ª–µ—Ñ–æ–Ω
6. **–ë–æ—Ç** –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp API
7. **AuthService** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Google Sheets
8. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ** —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∫—ç—à–∞
9. **–û—Ç–≤–µ—Ç** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—É—Å–ø–µ—Ö/–æ—à–∏–±–∫–∞)

### –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **handlers.py** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
3. **openai_service.py** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò
4. **appeals_service.py** –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ –≤ Google Sheets
5. **response_monitor.py** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
6. **–ë–æ—Ç** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### –ü–æ—Ç–æ–∫ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É:
1. **–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏–∏
2. **handlers.py** –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã
3. **appeals_service.py** –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
4. **response_monitor.py** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
5. **–ë–æ—Ç** —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ –ø–µ—Ä–µ–¥–∞—á–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è" –≤ WebApp
2. **menu.html** –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp API
3. **promotions_api.py** –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
4. **WebApp** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
5. **promotions_notifier.py** –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö

### –ü–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ —É—Å–ª—É–≥–∞–º–∏:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã" –≤ WebApp
2. **menu.html** –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥ –≤ –≤–∏–¥–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
3. **JavaScript** —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ–º/—Å–∫—Ä—ã—Ç–∏–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π
4. **WebApp** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
5. **–ù–∞–≤–∏–≥–∞—Ü–∏—è** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ WebApp –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Telegram Bot  ‚îÇ    ‚îÇ   PythonAnywhere‚îÇ    ‚îÇ  Google Sheets  ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ   handlers  ‚îÇ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ   bot.py    ‚îÇ‚îÇ    ‚îÇ  ‚îÇ   Auth      ‚îÇ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ    ‚îÇ  ‚îÇ   Appeals   ‚îÇ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ  ‚îÇ Promotions  ‚îÇ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ  ‚îÇ   WebApp    ‚îÇ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚î§  ‚îÇ  services   ‚îÇ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚î§                 ‚îÇ
‚îÇ  ‚îÇ (index.html)‚îÇ‚îÇ    ‚îÇ  ‚îÇ             ‚îÇ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ  ‚îÇ (menu.html) ‚îÇ‚îÇ    ‚îÇ  ‚îÇ             ‚îÇ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã v3.2:

#### 1. **PythonAnywhere Integration**
- **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π HTTPS** –¥–ª—è webhook
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ** —á–µ—Ä–µ–∑ Git
- **–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Flask** –¥–ª—è webhook
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–æ 2000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### 2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**
- **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** —Å Google Sheets
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤**

#### 3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **Google Service Account** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Sheets
- **HTTPS** –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### Google Sheets - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| C | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ |
| D | –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | "–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω" / –ø—É—Å—Ç–æ |
| E | Telegram ID | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram |
| F | –î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ |

### Google Sheets - –û–±—Ä–∞—â–µ–Ω–∏—è:
| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –°–≤—è–∑—å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π |
| B | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ |
| C | –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ü–æ–ª–Ω–æ–µ –∏–º—è |
| D | Telegram ID | ID –≤ Telegram |
| E | –¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π | –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π |
| F | –°—Ç–∞—Ç—É—Å | "–ù–æ–≤–æ–µ", "–í —Ä–∞–±–æ—Ç–µ", "–†–µ—à–µ–Ω–æ" |
| G | –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ | –û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ |
| H | –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | Timestamp |

### Google Sheets - –ê–∫—Ü–∏–∏:
| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| A | –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ | –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ |
| B | –ù–∞–∑–≤–∞–Ω–∏–µ | –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫—Ü–∏–∏ |
| C | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ |
| D | –°—Ç–∞—Ç—É—Å | "–ê–∫—Ç–∏–≤–Ω–∞", "–û–∂–∏–¥–∞–µ—Ç", "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" |
| E | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ | –ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è |
| F | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è | –ö–æ–Ω–µ—Ü –¥–µ–π—Å—Ç–≤–∏—è |

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞—â–µ–Ω–∏—è

### 1. **–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
- `appeals_service.py` —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ Google Sheets
- –°—Ç–∞—Ç—É—Å: "–ù–æ–≤–æ–µ"

### 2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò**
- `openai_service.py` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç
- –û—Ç–≤–µ—Ç –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–ª–æ–Ω–∫—É E
- –°—Ç–∞—Ç—É—Å: "–û—Ç–≤–µ—Ç –ò–ò"

### 3. **–≠—Å–∫–∞–ª–∞—Ü–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É**
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
- –°—Ç–∞—Ç—É—Å: "–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
- `response_monitor.py` –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã

### 4. **–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞**
- –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –≤ Google Sheets
- `response_monitor.py` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –°—Ç–∞—Ç—É—Å: "–í —Ä–∞–±–æ—Ç–µ" –∏–ª–∏ "–†–µ—à–µ–Ω–æ"

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### PythonAnywhere Configuration:
```python
# webhook_handler.py
app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def webhook():
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Google Apps Script
    pass

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **–õ–æ–≥–∏** –≤ –∫–æ–Ω—Å–æ–ª–∏ PythonAnywhere
- **–ú–µ—Ç—Ä–∏–∫–∏** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ Google Sheets
- **–û—à–∏–±–∫–∏** –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –≤ –ª–æ–≥–∞—Ö

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–¢–µ–∫—É—â–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: –¥–æ 2000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ**: –¥–æ 5000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
- **–ë—É–¥—É—â–µ–µ**: –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –ø—Ä–∏ —Ä–æ—Å—Ç–µ

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env):
```env
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets
GCP_SA_JSON={"type":"service_account",...}
SHEET_ID=your_sheet_id
APPEALS_SHEET_ID=your_appeals_sheet_id
PROMOTIONS_SHEET_ID=your_promotions_sheet_id

# WebApp
WEB_APP_URL=https://your-domain.github.io/marketing/
WEBHOOK_URL=https://your-domain.pythonanywhere.com/webhook
```

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt):
```
requests>=2.32.0
python-dotenv>=1.0.0
gspread>=6.1.0
google-auth>=2.37.0
python-telegram-bot>=20.7
openai>=1.45.0
flask>=3.0.0
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: 5 –º–∏–Ω—É—Ç TTL
- **Google Sheets**: –∫—ç—à –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **WebApp**: –∫—ç—à –Ω–∞ 5 –º–∏–Ω—É—Ç

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å:
- **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** —Å –≤–Ω–µ—à–Ω–∏–º–∏ API
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** —Å–æ–æ–±—â–µ–Ω–∏–π
- **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** —Ä–µ—Å—É—Ä—Å–æ–≤

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ú–µ—Ç—Ä–∏–∫–∏** –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ê–ª–µ—Ä—Ç—ã** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

**–í–µ—Ä—Å–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:** v3.3  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ

================================================================================
FILE: ./docs/BOT_STABILITY_ISSUES.md
SIZE: 3559 bytes
================================================================================

# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Telegram –±–æ—Ç–∞

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### 1.1 –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–∏—Å—Ç–µ–º–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π Telegram –±–æ—Ç–∞ –Ω–∞ –±–∞–∑–µ `python-telegram-bot` (–≤–µ—Ä—Å–∏—è 20.7+), —Ä–µ–∞–ª–∏–∑—É—é—â–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω long polling –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –æ—Ç Telegram API. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–º –ø—Ä–∏–Ω—Ü–∏–ø–µ —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Telegram Bot Application                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  bot.py (Entry Point)                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤                            ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Signal handlers (SIGINT, SIGTERM)                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  - Graceful shutdown                                  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                          ‚îÇ                                   ‚îÇ
‚îÇ        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ        ‚îÇ                 ‚îÇ                 ‚îÇ               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ handlers  ‚îÇ   ‚îÇ   Services  ‚îÇ   ‚îÇ  Monitors  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   .py     ‚îÇ   ‚îÇ             ‚îÇ   ‚îÇ            ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ           ‚îÇ   ‚îÇ - Auth      ‚îÇ   ‚îÇ - Response ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ - /start  ‚îÇ   ‚îÇ - Appeals   ‚îÇ   ‚îÇ - Promo    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ - message ‚îÇ   ‚îÇ - OpenAI    ‚îÇ   ‚îÇ - Health   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ - webapp  ‚îÇ   ‚îÇ             ‚îÇ   ‚îÇ            ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                 ‚îÇ                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Google Sheets ‚îÇ  ‚îÇ  OpenAI API ‚îÇ  ‚îÇ Telegram API‚îÇ
‚îÇ   (gspread)   ‚îÇ  ‚îÇ  (httpx)    ‚îÇ  ‚îÇ  (polling)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```



================================================================================
FILE: ./docs/BOT_STABILITY_ISSUES.md.backup
SIZE: 11841 bytes
================================================================================

# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞—Ç–∏–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Telegram –±–æ—Ç–∞

## 1. –°–∏–º–ø—Ç–æ–º—ã

### 1.1 –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞
- –ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ —è–≤–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω
- Systemd —Å–µ—Ä–≤–∏—Å `marketingbot-bot.service` –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `failed` –∏–ª–∏ `inactive`
- –ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ **552 –æ—à–∏–±–∫–∏** –≤ –ª–æ–≥–∞—Ö

### 1.2 –û—à–∏–±–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö API
- –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –æ—à–∏–±–∫–∏ Google Sheets API —Å –∫–æ–¥–æ–º **503 (Service Unavailable)**
- –û—à–∏–±–∫–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö:
  - `promotions_api.py` - –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Ç–∞–±–ª–∏—Ü–µ –∞–∫—Ü–∏–π
  - `appeals_service.py` - –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ª–∏—Å—Ç–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–π
  - `auth_service.py` - –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### 1.3 –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- –§–æ–Ω–æ–≤—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (`ResponseMonitor`, `PromotionsNotifier`) –º–æ–≥—É—Ç –∑–∞–≤–µ—Ä—à–∞—Ç—å—Å—è —Å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫ –≤ —Ü–∏–∫–ª–∞—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## 2. –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 2.1 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ (Retry Logic)
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –≤—ã–∑–æ–≤—ã Google Sheets API –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `promotions_api.py:17-74` - —Ñ—É–Ω–∫—Ü–∏—è `_get_promotions_client_and_sheet()`
- `sheets.py:54-87` - —Ñ—É–Ω–∫—Ü–∏—è `_get_client_and_sheet()`
- `sheets.py:90-123` - —Ñ—É–Ω–∫—Ü–∏—è `_get_appeals_client_and_sheet()`
- `appeals_service.py:18-33` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `AppealsService`
- –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç—ã —Å Google Sheets API –≤ `gspread` –±–∏–±–ª–∏–æ—Ç–µ–∫–µ

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:** –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ HTTP 503 (Service Unavailable) –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ (429 Rate Limit, 500 Internal Server Error) –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–º—É –ø—Ä–æ–≤–∞–ª—É –æ–ø–µ—Ä–∞—Ü–∏–∏.

### 2.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ—à–∏–±–∫–∞—Ö Google Sheets API —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –ö–∞—Å–∫–∞–¥–Ω—ã–º –æ—Ç–∫–∞–∑–∞–º
- –ò—Å—á–µ—Ä–ø–∞–Ω–∏—é –∫–≤–æ—Ç API
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–µ service account

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:** –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –æ—à–∏–±–æ–∫.

### 2.3 –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö

#### 2.3.1 PromotionsNotifier
**–§–∞–π–ª:** `promotions_notifier.py`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏:**
- `start_monitoring()` (—Å—Ç—Ä–æ–∫–∏ 189-199): –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏–º–µ–µ—Ç –æ–±—â–∏–π `try-except`, –Ω–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `PromotionsNotConfiguredError`) —Ü–∏–∫–ª –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è
- `check_and_send_notifications()` (—Å—Ç—Ä–æ–∫–∏ 20-47): –æ—à–∏–±–∫–∏ Google Sheets API –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º
- `_get_promotions_client_and_sheet()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:** –ü—Ä–∏ –æ—à–∏–±–∫–µ `APIError: [503]: The service is currently unavailable` –≤ `promotions_api.py:73`, –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –≤–≤–µ—Ä—Ö –ø–æ —Å—Ç–µ–∫—É –∏ –º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ñ–æ–Ω–æ–≤—É—é –∑–∞–¥–∞—á—É.

#### 2.3.2 ResponseMonitor
**–§–∞–π–ª:** `response_monitor.py`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏:**
- `_monitoring_loop()` (—Å—Ç—Ä–æ–∫–∏ 61-78): —Ü–∏–∫–ª –∏–º–µ–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π, –Ω–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö Google Sheets API –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
- `_check_and_send_responses()` (—Å—Ç—Ä–æ–∫–∏ 80-97): –≤—ã–∑–æ–≤—ã `appeals_service` –º–µ—Ç–æ–¥–æ–≤ –Ω–µ –∏–º–µ—é—Ç retry –ª–æ–≥–∏–∫–∏
- –ú–µ—Ç–æ–¥—ã `appeals_service.check_for_responses()` –∏ `appeals_service.check_for_resolved_status()` –º–æ–≥—É—Ç –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å:** –û—à–∏–±–∫–∏ –≤ –º–µ—Ç–æ–¥–∞—Ö `AppealsService` –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.

### 2.4 –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ –±–æ—Ç–∞
**–§–∞–π–ª:** `bot.py`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏:**
- `main()` (—Å—Ç—Ä–æ–∫–∏ 101-207): –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –æ—à–∏–±–∫–∏ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ `sys.exit(1)` –±–µ–∑ graceful shutdown
- –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `post_init` callback, –Ω–æ –æ—à–∏–±–∫–∏ –≤ –Ω–∏—Ö –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π event loop
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ watchdog –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫

## 3. –í–ª–∏—è–Ω–∏–µ –Ω–∞ —Å–∏—Å—Ç–µ–º—É

### 3.1 –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ
- **–ü–æ—Ç–µ—Ä—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤:** `ResponseMonitor` –º–æ–∂–µ—Ç –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—Ç –æ—Ç–≤–µ—Ç—ã
- **–ü–æ—Ç–µ—Ä—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∞–∫—Ü–∏—è—Ö:** `PromotionsNotifier` –º–æ–∂–µ—Ç –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö
- **–ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞:** –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö –±–æ—Ç –º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞–±–æ—Ç—É

### 3.2 –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ systemd
- –ü–æ—Ç–µ—Ä—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### 3.3 –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ
- –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö (552 –æ—à–∏–±–∫–∏ –∑–∞ 7 –¥–Ω–µ–π)
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ service account –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö –±–µ–∑ backoff

## 4. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### 4.1 –¢–∏–ø—ã –æ—à–∏–±–æ–∫ Google Sheets API

#### 4.1.1 –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (—Ç—Ä–µ–±—É—é—Ç retry)
- **503 Service Unavailable:** —Å–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **429 Too Many Requests:** –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (rate limiting)
- **500 Internal Server Error:** –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ Google
- **502 Bad Gateway:** –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∫—Å–∏/—à–ª—é–∑–æ–º

#### 4.1.2 –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (–Ω–µ —Ç—Ä–µ–±—É—é—Ç retry)
- **401 Unauthorized:** –ø—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- **403 Forbidden:** –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- **404 Not Found:** —Ä–µ—Å—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω

### 4.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 4.2.1 –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥—ã `gspread` –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á—Ç–æ –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å event loop –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞—Ö.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- –í—Å–µ –≤—ã–∑–æ–≤—ã `worksheet.get_all_records()`
- –í—Å–µ –≤—ã–∑–æ–≤—ã `worksheet.update()`, `worksheet.append_row()`
- –í—Å–µ –≤—ã–∑–æ–≤—ã `spreadsheet.worksheet()`

#### 4.2.2 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤
**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã–∑–æ–≤—ã Google Sheets API –Ω–µ –∏–º–µ—é—Ç —è–≤–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–æ–≤, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–≤–∏—Å–∞–Ω–∏—é –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö.

#### 4.2.3 –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ backoff
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫:
- –ü–µ—Ä–µ–≥—Ä—É–∑–∫–µ API –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–∏—Å–∞
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–µ service account
- –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Ä–µ—Å—É—Ä—Å–æ–≤

## 5. –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 5.1 –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏
- `bot.py` - –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –±–æ—Ç–∞
- `promotions_api.py` - API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∞–∫—Ü–∏—è–º–∏
- `promotions_notifier.py` - —Å–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∞–∫—Ü–∏—è—Ö
- `response_monitor.py` - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
- `appeals_service.py` - —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
- `sheets.py` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
- `auth_service.py` - —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 5.2 –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- `gspread` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets API
- `google-auth` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Google
- `python-telegram-bot` - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Telegram Bot API

## 6. –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã

- **–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫:** 552 –æ—à–∏–±–∫–∏ –∑–∞ 7 –¥–Ω–µ–π (~79 –æ—à–∏–±–æ–∫/–¥–µ–Ω—å)
- **–¢–∏–ø—ã –æ—à–∏–±–æ–∫:** –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ 503 Service Unavailable
- **–í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:** —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –ø–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞

## 7. –¢—Ä–µ–±—É–µ–º—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 7.1 –ö—Ä–∏—Ç–∏—á–Ω—ã–µ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è retry –ª–æ–≥–∏–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff –¥–ª—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ Google Sheets API
2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Circuit Breaker –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—à–∏–±–æ–∫
3. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö (`PromotionsNotifier`, `ResponseMonitor`)
4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≤—ã–∑–æ–≤–æ–≤ Google Sheets API

### 7.2 –í–∞–∂–Ω—ã–µ (—Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
1. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è watchdog –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
2. –£–ª—É—á—à–µ–Ω–∏–µ graceful shutdown –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
4. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

### 7.3 –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
1. –ú–∏–≥—Ä–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `gspread` –Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏
2. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ API
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ health check endpoints –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞


================================================================================
FILE: ./docs/CHANGELOG.md
SIZE: 26260 bytes
================================================================================

# üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π MarketingBot

–í—Å–µ –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –≤ –¥–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ.

–§–æ—Ä–º–∞—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ [Keep a Changelog](https://keepachangelog.com/ru/1.0.0/),
–∏ —ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è [Semantic Versioning](https://semver.org/lang/ru/).

## [3.3.0] - 2025-10-10 - –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–°–õ–£–ì–ò –ò –°–ï–†–í–ò–°–´

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã" –≤ menu.html
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–∫–∫–æ—Ä–¥–µ–æ–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å 5 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ —É—Å–ª—É–≥
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –ò–∑–º–µ–Ω–µ–Ω–∞ —Å–µ—Ç–∫–∞ –º–µ–Ω—é —Å 2x2 –Ω–∞ 2x3 –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –î–æ–±–∞–≤–ª–µ–Ω—ã JavaScript —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –í—Å–µ –º–µ–Ω—é —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –∑–∞–≥–ª—É—à–∫–∏ –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç

### üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **–ù–û–í–´–ô –†–ê–ó–î–ï–õ –£–°–õ–£–ì**: –î–æ–±–∞–≤–ª–µ–Ω –∫–∞—Ç–∞–ª–æ–≥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- **–ê–ö–ö–û–†–î–ï–û–ù-–ò–ù–¢–ï–†–§–ï–ô–°**: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–µ—Å—è —Å–ø–∏—Å–∫–∏ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥
- **–ê–î–ê–ü–¢–ò–í–ù–ê–Ø –°–ï–¢–ö–ê**: –ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞–∫–µ—Ç–∞ –º–µ–Ω—é –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- **–ú–û–î–£–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**: –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–∫–∞–∑–æ–≤

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- **–†–∞–∑–¥–µ–ª "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã"** –≤ menu.html —Å 5 –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏:
  - üì± –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π (8 —É—Å–ª—É–≥)
  - ‚úçÔ∏è –¢–µ–∫—Å—Ç—ã –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥ (4 —É—Å–ª—É–≥–∏)
  - üé® –î–∏–∑–∞–π–Ω –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥ (5 —É—Å–ª—É–≥)
  - üìà –†–µ–∫–ª–∞–º–∞ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ (4 —É—Å–ª—É–≥–∏)
  - ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ (4 —É—Å–ª—É–≥–∏)
- **–ê–∫–∫–æ—Ä–¥–µ–æ–Ω-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å** —Å JavaScript —Ñ—É–Ω–∫—Ü–∏—è–º–∏
- **CSS —Å—Ç–∏–ª–∏** –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–π
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **Hover-—ç—Ñ—Ñ–µ–∫—Ç—ã** –∏ –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–º–æ–π** Telegram (—Å–≤–µ—Ç–ª–∞—è/—Ç–µ–º–Ω–∞—è)

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- **menu.html**: 
  - –ò–∑–º–µ–Ω–µ–Ω–∞ —Å–µ—Ç–∫–∞ —Å `grid-template-columns: 1fr 1fr` –Ω–∞ `1fr 1fr 1fr`
  - –î–æ–±–∞–≤–ª–µ–Ω 5-–π —ç–ª–µ–º–µ–Ω—Ç –º–µ–Ω—é "üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã"
  - –°–æ–∑–¥–∞–Ω–∞ —Å–µ–∫—Ü–∏—è `services-section` —Å –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º
  - –î–æ–±–∞–≤–ª–µ–Ω—ã CSS —Å—Ç–∏–ª–∏ –¥–ª—è `.services-accordion`, `.service-category` –∏ –¥—Ä.
- **JavaScript —Ñ—É–Ω–∫—Ü–∏–∏**:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `toggleServiceCategory(categoryId)` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–º
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤–æ–π
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
- **CSS —Å—Ç–∏–ª–∏**:
  - –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç–∏–ª–∏ –¥–ª—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ —É—Å–ª—É–≥
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã hover-—ç—Ñ—Ñ–µ–∫—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –º–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ –¥–æ 480px

### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ `showSection()` –∏ `showMainMenu()`
- **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å** - –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö —ç–∫—Ä–∞–Ω–æ–≤

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–ó–∞–≥–ª—É—à–∫–∏** - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ WebApp –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç
- **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - —É—Å–ª—É–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –±—É–¥—É—â–µ–π —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫–∞–∑–æ–≤

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–õ–µ–≥–∫–æ–≤–µ—Å–Ω–æ—Å—Ç—å** - —Ç–æ–ª—å–∫–æ HTML/CSS/JavaScript –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
- **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–æ—Ç–∞

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **FEATURES.md** - –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–¥—Ä–æ–±–Ω—ã–π —Ä–∞–∑–¥–µ–ª –æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥–∞—Ö
- **CHANGELOG.md** - –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è v3.3.0
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –æ–ø–∏—Å–∞–Ω—ã HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, CSS —Å—Ç–∏–ª–∏ –∏ JavaScript —Ñ—É–Ω–∫—Ü–∏–∏

---

## [3.2.0] - 2025-10-09 - –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê PYTHONANYWHERE –ò –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –ú–ò–ì–†–ê–¶–ò–Ø**: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ PythonAnywhere
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –í—Å–µ –æ—à–∏–±–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ (IndentationError) –≤ handlers.py
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä–µ—à–µ–Ω–æ"
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –£—Å–∏–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:"

### üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **–ú–ò–ì–†–ê–¶–ò–Ø –ù–ê PYTHONANYWHERE**: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- **WEBHOOK –ê–†–•–ò–¢–ï–ö–¢–£–†–ê**: –ó–∞–º–µ–Ω–∞ polling –Ω–∞ webhook –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–æ–∫ Conflict
- **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –°–¢–ê–¢–£–°–û–í**: –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò**: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (5 –º–∏–Ω—É—Ç TTL)

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- **PythonAnywhere –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** - –ø–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- **Webhook handler** - Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
- **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
- **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** - TTL 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏ –Ω–æ–≤—ã–µ –∞–∫—Ü–∏–∏
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏** - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- **handlers.py**: 
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –æ—à–∏–±–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ (IndentationError)
  - –£—Å–∏–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:"
- **response_monitor.py**:
  - –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
  - –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–µ—Ç—Å—è "–≤ —Ä–∞–±–æ—Ç–µ" –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **auth_service.py**:
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å TTL 5 –º–∏–Ω—É—Ç
  - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- **DEPLOYMENT.md**:
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ PythonAnywhere
  - –û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è PythonAnywhere

### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- **IndentationError** - –≤—Å–µ –æ—à–∏–±–∫–∏ –æ—Ç—Å—Ç—É–ø–æ–≤ –≤ handlers.py –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤** - —Ä–µ—à–µ–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –Ω–∞ PythonAnywhere
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤** - —É–±—Ä–∞–Ω–æ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π** - —É—Å–∏–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ handlers.py
- **–ü—Ä–æ–±–ª–µ–º—ã —Å Markdown** - —É–±—Ä–∞–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** - –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ .env
- **Google Service Account** - –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ JSON
- **HTTPS** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ PythonAnywhere

## [3.1.0] - 2025-10-03 - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –£–õ–£–ß–®–ï–ù–ò–Ø

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –ö—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ —É–¥–∞–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- **–£–°–ü–ï–®–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ WebApp (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è vs –º–µ–Ω—é)

### üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **–ò–°–ü–†–ê–í–õ–ï–ù–ê –°–ò–°–¢–ï–ú–ê –°–¢–ê–¢–£–°–û–í**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∑–∞–ª–∏–≤–∫–∏
- **–î–û–ë–ê–í–õ–ï–ù–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –≠–°–ö–ê–õ–ê–¶–ò–Ø**: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ñ—Ä–∞–∑–∞–º
- **–ò–°–ü–†–ê–í–õ–ï–ù–ê –õ–û–ì–ò–ö–ê WEBAPP**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –º–µ–Ω—é

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- **–§—É–Ω–∫—Ü–∏—è `_is_user_escalation_request()`** –≤ `handlers.py` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** –Ω–∞ "–≤ —Ä–∞–±–æ—Ç–µ" –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–£–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∑–∞–ª–∏–≤–∫–∏** –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
- **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ WebApp
- **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL** –¥–ª—è WebApp (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è vs –º–µ–Ω—é)

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- **handlers.py**: 
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
  - –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–µ–π
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è WebApp (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –º–µ–Ω—é)
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- **response_monitor.py**:
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä–µ—à–µ–Ω–æ"
  - –î–æ–±–∞–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –∫—Ä–∞—Å–Ω–æ–π –∑–∞–ª–∏–≤–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
  - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π

### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª—Å—è –Ω–∞ "—Ä–µ—à–µ–Ω–æ"** - –¥–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **–ö—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ –Ω–µ —É–¥–∞–ª—è–ª–∞—Å—å** - –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å–±—Ä–æ—Å —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –Ω–∞ –±–µ–ª—ã–π
- **–°—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–ª—Å—è –Ω–∞ "–≤ —Ä–∞–±–æ—Ç–µ"** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ñ—Ä–∞–∑–∞–º
- **–°–º–µ—à–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ WebApp** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è URL –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
- **–û—à–∏–±–∫–∏ "Chat not found"** - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö Telegram ID
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤** - —É–ª—É—á—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
- –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö Telegram ID –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è**: –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- **–£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## [3.0.0] - 2025-10-02 - –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø OPENAI –ò –°–ò–°–¢–ï–ú–ê –û–ë–†–ê–©–ï–ù–ò–ô

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**: OpenAI Assistant —Å Threads API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞
- **–£–°–ü–ï–®–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–µ –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–µ–π—Å—Ç–≤–∏–π

### üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **–ü–û–õ–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø OPENAI**: –î–æ–±–∞–≤–ª–µ–Ω OpenAIService —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Threads API
- **–°–ò–°–¢–ï–ú–ê –û–ë–†–ê–©–ï–ù–ò–ô**: –°–æ–∑–¥–∞–Ω AppealsService –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –≤ Google Sheets
- **–ú–û–ù–ò–¢–û–†–ò–ù–ì –û–¢–í–ï–¢–û–í**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω ResponseMonitor –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
- **–ö–≠–®–ò–†–û–í–ê–ù–ò–ï –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò**: –î–æ–±–∞–≤–ª–µ–Ω 24-—á–∞—Å–æ–≤–æ–π –∫—ç—à –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- **OpenAIService** (`openai_service.py`) - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI Assistant —á–µ—Ä–µ–∑ Threads API
- **AppealsService** (`appeals_service.py`) - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –≤ Google Sheets
- **ResponseMonitor** (`response_monitor.py`) - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ —Å APScheduler
- **–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ–±—Ä–∞—â–µ–Ω–∏–π** —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π:
  - `–Ω–æ–≤–æ–µ` - –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `–≤ —Ä–∞–±–æ—Ç–µ` - –ø–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É (#f4cccc)
  - `—Ä–µ—à–µ–Ω–æ` - —Ä–µ—à–µ–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º (#d9ead3)
- **–ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–µ –º–µ–Ω—é** —Å –æ–ø—Ü–∏—è–º–∏:
  - "üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
  - "ü§ñ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º"
- **–°–∏—Å—Ç–µ–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π** –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π** (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** —Å —Ñ–∞–π–ª–æ–º `auth_cache.json`
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ Google Sheets** –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
- **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- **handlers.py**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–≥–æ –º–µ–Ω—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenAI
- **auth_service.py**: –î–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞ 24 —á–∞—Å–∞
- **sheets.py**: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_get_appeals_client_and_sheet()` –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- **bot.py**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ ResponseMonitor
- **.env**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è OpenAI –∏ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π

### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- **–î–≤–æ–π–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ** - —É–±—Ä–∞–Ω—ã –ø—Ä–∏ –æ–±—ã—á–Ω–æ–º –æ–±—â–µ–Ω–∏–∏ —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã Telegram Bot API** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- **–û—à–∏–±–∫–∏ Google Sheets API** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `batch_update` –¥–ª—è –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
- **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ event loop** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ OpenAI –∑–∞–ø—Ä–æ—Å–æ–≤

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º
- Graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**: —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Google Sheets –Ω–∞ 95%
- **Batch –æ–ø–µ—Ä–∞—Ü–∏–∏**: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Google Sheets
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å OpenAI

---

## [2.0.0] - 2024-09-17 - –£–õ–¨–¢–†–ê-–£–ü–†–û–©–ï–ù–ò–ï
### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- **–£–°–ü–ï–®–ù–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø**: WebApp (Mini App) —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–£–°–ü–ï–®–ù–ê–Ø –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞

### üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- **–ü–û–õ–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–ê–Ø –†–ï–û–†–ì–ê–ù–ò–ó–ê–¶–ò–Ø**: –£–ø—Ä–æ—â–µ–Ω–∏–µ —Å 60+ —Ñ–∞–π–ª–æ–≤ –¥–æ 8 —Ñ–∞–π–ª–æ–≤
- **–ï–î–ò–ù–´–ô –ë–û–¢**: –í–µ—Å—å –∫–æ–¥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª `bot.py` (300 —Å—Ç—Ä–æ–∫)
- **–ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ò**: –°–æ–∫—Ä–∞—â–µ–Ω–æ —Å 20+ –¥–æ 4 –ø–∞–∫–µ—Ç–æ–≤

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π `bot.py` —Å–æ –≤—Å–µ–π –ª–æ–≥–∏–∫–æ–π –±–æ—Ç–∞
- –ü—Ä–æ—Å—Ç–æ–π `sheets.py` –¥–ª—è Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- `docker-compose.yml` –¥–ª—è –ª–µ–≥–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `Dockerfile` –ø–æ–¥ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è `DEPLOYMENT.md` –∏ `RELEASES.md`
- –ù–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã `TROUBLESHOOTING.md` –∏ `CHANGELOG.md`

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- **ARCHITECTURE.md**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –ø–æ–¥ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
- **INSTALLATION.md**: –û–±–Ω–æ–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
- **README.md**: –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- **RULES.md**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- **pyproject.toml**: –£–ø—Ä–æ—â–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- **.gitignore**: –£–ª—É—á—à–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### ‚ùå –£–¥–∞–ª–µ–Ω–æ
- **FastAPI —Å–µ—Ä–≤–µ—Ä**: –£–¥–∞–ª–µ–Ω `app/main.py` –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- **–ü–ª–∞–≥–∏–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**: –£–¥–∞–ª–µ–Ω–∞ –ø–∞–ø–∫–∞ `plugins/`
- **–£—Ç–∏–ª–∏—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: –£–¥–∞–ª–µ–Ω—ã `tools/` –∏ `scripts/`
- **–î—É–±–ª–∏—Ä—É—é—â–∏–µ —Ñ–∞–π–ª—ã**: `requirements.txt`, `launch_bot.py`
- **–£—Å—Ç–∞—Ä–µ–≤—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: 9 —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- **CI/CD —É–ø–æ–º–∏–Ω–∞–Ω–∏—è**: –£–±—Ä–∞–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ GitHub Actions

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è `.env` –∏ credentials —Ñ–∞–π–ª–æ–≤
- –û–±–Ω–æ–≤–ª–µ–Ω `.gitignore` —Å –ø–æ–ª–Ω–æ–π –∑–∞—â–∏—Ç–æ–π —Å–µ–∫—Ä–µ—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∞–≤–∏–ª–∞

### üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –º–µ–∂–¥—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –∫–æ–¥–æ–º
- –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ —Å—Å—ã–ª–∫–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è—Ö

---

## [1.0.0] - 2024-09-16 - –°–¢–ê–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- –û—Å–Ω–æ–≤–Ω–æ–π Telegram –±–æ—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–æ–º–∞–Ω–¥
- FastAPI –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets
- Telegram WebApp –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –ü–ª–∞–≥–∏–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏
- Docker –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å multi-stage build
- –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (22 —Ñ–∞–π–ª–∞)
- GitHub Actions CI/CD –ø–∞–π–ø–ª–∞–π–Ω
- Prometheus –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- –í–∞–ª–∏–¥–∞—Ü–∏—è Telegram Web App init_data
- –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ù–µ–ø—Ä–∏–≤–∏–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ Docker
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å Google Sheets
- –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Telegram –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ 80%

---

## [0.1.0] - 2024-09-15 - –ü–ï–†–í–ê–Ø –í–ï–†–°–ò–Ø

### ‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ
- –ë–∞–∑–æ–≤—ã–π Telegram –±–æ—Ç
- –ü—Ä–æ—Å—Ç–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- –ù–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets
- –ë–∞–∑–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

---

## –¢–∏–ø—ã –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **‚ûï –î–æ–±–∞–≤–ª–µ–Ω–æ** - –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ** - –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏  
- **üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- **‚ùå –£–¥–∞–ª–µ–Ω–æ** - —É–¥–∞–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
- **üöÄ –ö—Ä—É–ø–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - breaking changes

---

## –ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ

### v2.1.0 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- –£–ª—É—á—à–µ–Ω–∏—è WebApp –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### v2.2.0 (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö Google Sheets
- –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### v3.0.0 (–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤
- REST API –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –í–µ–±-–ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

---

## üöÄ –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–ª–∏–∑–∞

### üìã –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ —Ä–µ–ª–∏–∑–æ–º

**–ö–æ–¥:**
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç: `python3 -m pytest`
- [ ] –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä–µ–Ω –ª–∏–Ω—Ç–µ—Ä–∞–º–∏: `ruff check .` –∏ `mypy .`
- [ ] –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫: `python3 bot.py`

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:**
- [ ] `README.md` –æ–±–Ω–æ–≤–ª–µ–Ω.
- [ ] `CHANGELOG.md` —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
- [ ] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∞–∫—Ç—É–∞–ª—å–Ω—ã.

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω–æ —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ WebApp —Ä–∞–±–æ—Ç–∞–µ—Ç.
- [ ] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞.

### üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞

1.  **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞:**
    - –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –≤ `pyproject.toml`.
    - –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–∫—Ü–∏—é –Ω–æ–≤–æ–≥–æ —Ä–µ–ª–∏–∑–∞ –≤ `CHANGELOG.md`.
    - –°–¥–µ–ª–∞—Ç—å –∫–æ–º–º–∏—Ç: `git commit -m "üöÄ Prepare release vX.Y.Z"`

2.  **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞:**
    - `git tag -a vX.Y.Z -m "Release version X.Y.Z"`
    - `git push origin vX.Y.Z`

3.  **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
    - –°–ª–µ–¥–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `docs/DEPLOYMENT.md`.


================================================================================
FILE: ./docs/COMPREHENSIVE_STABILITY_FIX.md
SIZE: 14402 bytes
================================================================================

# üõ°Ô∏è –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ë–æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–∞–¥–∞–ª –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –ø—Ä–∏—á–∏–Ω:
1. –ö–æ–Ω—Ñ–ª–∏–∫—Ç event loop –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
2. –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ Telegram API
3. –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ç–∞–π–º–∞—É—Ç—ã
4. –û—à–∏–±–∫–∏ –≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö
5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

## –†–µ—à–µ–Ω–∏–µ: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∑–∞—â–∏—Ç–∞

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç event loop ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–≤–∞–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π event loop –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–æ —Å –æ—Å–Ω–æ–≤–Ω—ã–º.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `post_init` –∏ `post_stop` callbacks –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∑–∞–¥–∞—á –≤ –æ–¥–Ω–æ–º event loop.

```python
async def post_init(application: Application) -> None:
    # –í—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ —Ç–æ–º –∂–µ event loop
    asyncio.create_task(response_monitor.start_monitoring(...))
    asyncio.create_task(promotions_notifier.start_monitoring(...))
    asyncio.create_task(health_monitor.start_monitoring())
```

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ ‚úÖ

**–§–∞–π–ª:** `error_handler.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `safe_telegram_call()` - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ Telegram API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–∞–º–∏
- `safe_handler()` - –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∏–π –ø–∞–¥–µ–Ω–∏–µ –±–æ—Ç–∞

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö (exponential backoff)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ rate limits (RetryAfter)
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞ ‚úÖ

**–§–∞–π–ª:** `bot_health_monitor.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —á–µ—Ä–µ–∑ `getMe()` (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- –î–µ—Ç–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚úÖ

**–í `bot.py`:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö (–¥–æ 5 –ø–æ–ø—ã—Ç–æ–∫)
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- Graceful shutdown –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤

### 5. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ ‚úÖ

**–§–∞–π–ª—ã:** `response_monitor.py`, `promotions_notifier.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `asyncio.CancelledError` –≤–æ –≤—Å–µ—Ö —Ü–∏–∫–ª–∞—Ö
- –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å traceback

### 6. –ó–∞—â–∏—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ‚úÖ

**–í `bot.py`:**
- Try-except –¥–ª—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- Graceful degradation (–±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã)
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –≤—ã—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### 7. Graceful Shutdown ‚úÖ

**–§—É–Ω–∫—Ü–∏–∏:**
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ SIGINT –∏ SIGTERM
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
- –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ —á–µ—Ä–µ–∑ atexit

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—â–∏—Ç—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫    ‚îÇ
‚îÇ     (error_handler.py)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è              ‚îÇ
‚îÇ     (bot_health_monitor.py)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ   ‚îÇ
‚îÇ     (bot.py - retry logic)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ
              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ     –ó–∞—â–∏—Ç–∞ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á            ‚îÇ
‚îÇ     (response_monitor,              ‚îÇ
‚îÇ      promotions_notifier)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–¥–µ–Ω–∏–π

1. **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã —Å exponential backoff
2. **–û—à–∏–±–∫–∏ Telegram API:** –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –Ω–µ –ø—Ä–∏–≤–æ–¥—è—â–∏–π –∫ –ø–∞–¥–µ–Ω–∏—é
3. **–û—à–∏–±–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö:** –ò–∑–æ–ª—è—Ü–∏—è –æ—à–∏–±–æ–∫, –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É
4. **–û—à–∏–±–∫–∏ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ:** –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã event loop:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ post_init/post_stop

### ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:** –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
2. **Systemd –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫:** –ù–∞—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ systemd service
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è:** –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### ‚úÖ Graceful Shutdown

1. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ SIGINT/SIGTERM
2. **–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤:** –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤
3. **–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤:** –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞:**
   ```bash
   python3 bot.py
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:**
   - –û—Ç–∫–ª—é—á–∏—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–æ–≤—Ç–æ—Ä–∞—Ö

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ graceful shutdown:**
   - –ù–∞–∂–º–∏—Ç–µ `Ctrl+C`
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞:**
   ```bash
   # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
   cd /home/ubuntu/marketingbot
   git pull  # –∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã –≤—Ä—É—á–Ω—É—é
   ```

2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞:**
   ```bash
   sudo systemctl restart marketingbot-bot.service
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:**
   ```bash
   sudo systemctl status marketingbot-bot.service
   ```

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:**
   ```bash
   sudo journalctl -u marketingbot-bot.service -f
   ```

5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:**
   - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–æ—Ç–∞: `sudo systemctl stop marketingbot-bot.service`
   - –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: `sudo systemctl status marketingbot-bot.service`
   - –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:**
   ```bash
   sudo systemctl status marketingbot-bot.service | grep Active
   ```

2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤:**
   ```bash
   sudo journalctl -u marketingbot-bot.service | grep "–ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É" | wc -l
   ```

3. **–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:**
   ```bash
   sudo journalctl -u marketingbot-bot.service -p err --since "1 hour ago"
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:**
   ```bash
   sudo journalctl -u marketingbot-bot.service | grep "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞"
   ```

### –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–±–ª–µ–º

**–ü—Ä–æ–±–ª–µ–º–∞:** –ß–∞—Å—Ç—ã–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –æ—à–∏–±–æ–∫
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Telegram API, Google Sheets)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤ –∏ –∫–ª—é—á–µ–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –≤ BotHealthMonitor
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ Telegram API

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ systemd —Ä–∞–±–æ—Ç–∞—é—Ç

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

1. **`bot_health_monitor.py`** - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞
2. **`error_handler.py`** - –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
3. **`docs/COMPREHENSIVE_STABILITY_FIX.md`** - –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **`bot.py`** - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π
2. **`response_monitor.py`** - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
3. **`promotions_notifier.py`** - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
4. **`scripts/setup_yandex_systemd.sh`** - –û–±–Ω–æ–≤–ª–µ–Ω systemd service

## –ì–∞—Ä–∞–Ω—Ç–∏–∏

### ‚úÖ –ß—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

1. **–ë–æ—Ç –Ω–µ —É–ø–∞–¥–µ—Ç –∏–∑-–∑–∞:**
   - –°–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã)
   - –û—à–∏–±–æ–∫ Telegram API (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
   - –û—à–∏–±–æ–∫ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö (–∏–∑–æ–ª—è—Ü–∏—è)
   - –û—à–∏–±–æ–∫ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã)
   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ event loop (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**
   - –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
   - Systemd –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è –æ–±–Ω–∞—Ä—É–∂–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã

3. **Graceful Shutdown:**
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
   - –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

### ‚ö†Ô∏è –ß—Ç–æ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è

1. **–ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π:**
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏–ª–∏ –∫–ª—é—á–∏
   - –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Telegram, Google Sheets)
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞

2. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ:**
   - –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –ø—Ä–∏–≤–æ–¥—è—â–∏–µ –∫ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Ü–∏–∫–ª–∞–º
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

3. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–µ—Å—É—Ä—Å–∞–º–∏:**
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –ø–∞–º—è—Ç–∏ (–µ—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
   - –ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏:**
   ```bash
   sudo journalctl -u marketingbot-bot.service -f
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã:**
   - –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
   - –ü—Ä–∏ —á–∞—Å—Ç—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö
   - –ü—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

4. **–†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ:**
   - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
   - –ö–æ–¥ –±–æ—Ç–∞
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é systemd

## –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **2026-01-12** - –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç event loop
  - –î–æ–±–∞–≤–ª–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
  - –î–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è
  - –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
  - –î–æ–±–∞–≤–ª–µ–Ω graceful shutdown

---

**–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –±–æ—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ª—é–±—ã—Ö –æ—à–∏–±–∫–∞—Ö. –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º.


================================================================================
FILE: ./docs/DATABASE_SETUP.md
SIZE: 2828 bytes
================================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

## üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É Google Sheets –∏ –ë–î

–ë–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É –∫–∞–∫ —Å Google Sheets, —Ç–∞–∫ –∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–í —Ñ–∞–π–ª–µ `.env` –¥–æ–±–∞–≤—å—Ç–µ:

```bash
USE_DATABASE=true
DATABASE_URL=sqlite:///./db/appeals.db
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Google Sheets (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)

–í —Ñ–∞–π–ª–µ `.env` —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:

```bash
USE_DATABASE=false
# –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ USE_DATABASE
APPEALS_SHEET_ID=your_sheet_id
APPEALS_SHEET_NAME=–æ–±—Ä–∞—â–µ–Ω–∏—è
GCP_SA_JSON=...
```

## üì¶ –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ë–î

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
python3.10 init_db.py
```

–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç —Ñ–∞–π–ª `db/appeals.db` —Å–æ –≤—Å–µ–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏.

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –í .env
USE_DATABASE=true
DATABASE_URL=sqlite:///./db/appeals.db
```

### 3. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python3.10 bot.py
```

–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç, —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ë–î, –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ—ë –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ë–î —Å–æ–∑–¥–∞–Ω–∞:

```bash
ls -la db/appeals.db
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ë–î:

```bash
sqlite3 db/appeals.db ".tables"
sqlite3 db/appeals.db "SELECT * FROM appeals LIMIT 5;"
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

- `appeals` - –æ–±—Ä–∞—â–µ–Ω–∏—è
- `appeal_messages` - —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö
- `specialist_responses` - –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–§–∞–π–ª –ë–î –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ git** (—É–∂–µ –≤ `.gitignore`)
2. **–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Ä–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –∫–æ–ø–∏–∏ `db/appeals.db`
3. **–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è —Å Google Sheets –Ω–∞ –ë–î

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `USE_DATABASE=true` –≤ `.env`
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –ø–æ–∑–∂–µ)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î
4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞

---

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –ë–î Google Sheets –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∞–∫—Ü–∏–π.


================================================================================
FILE: ./docs/DEPLOYMENT.md
SIZE: 13575 bytes
================================================================================

# üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ MarketingBot v3.2

–í —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ —à–∞–≥–∏ ‚Äî –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ PythonAnywhere —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–µ–ø–ª–æ–µ–º WebApp –Ω–∞ GitHub Pages.

## üñ•Ô∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```bash
git clone <repository-url>
cd marketingbot
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv .venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Linux/Mac)
source .venv/bin/activate

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Windows)
.venv\Scripts\activate
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip
pip install -r requirements.txt
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
# –£–∫–∞–∂–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º TELEGRAM_TOKEN
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è v3.2:**
```bash
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI (–¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ–±—Ä–∞—â–µ–Ω–∏–π –∏ –∞–∫—Ü–∏–π)
SHEET_ID=authorization_sheet_id
APPEALS_SHEET_ID=appeals_sheet_id
PROMOTIONS_SHEET_ID=promotions_sheet_id
SHEET_NAME=authorization_sheet_name
APPEALS_SHEET_NAME=–æ–±—Ä–∞—â–µ–Ω–∏—è
GCP_SA_FILE=path_to_credentials.json

# WebApp (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –º–µ–Ω—é)
WEB_APP_URL=https://your-domain.github.io/marketing/
WEBHOOK_URL=https://your-domain.pythonanywhere.com/webhook
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞), B (–¢–µ–ª–µ—Ñ–æ–Ω), C (–§–ò–û), D (Telegram ID), E (–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏), F (–î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `SHEET_ID`

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞), B (–¢–µ–ª–µ—Ñ–æ–Ω), C (–§–ò–û), D (Telegram ID), E (–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π), F (–°—Ç–∞—Ç—É—Å), G (–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞), H (–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `APPEALS_SHEET_ID`

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ü–∏–π:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞), B (–ù–∞–∑–≤–∞–Ω–∏–µ), C (–û–ø–∏—Å–∞–Ω–∏–µ), D (–°—Ç–∞—Ç—É—Å), E (–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞), F (–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `PROMOTIONS_SHEET_ID`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Service Account:**
1. –°–æ–∑–¥–∞–π—Ç–µ Service Account –≤ Google Cloud Console
2. –°–∫–∞—á–∞–π—Ç–µ JSON –∫–ª—é—á –∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤ `GCP_SA_FILE`
3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º –¥–ª—è email –∏–∑ JSON –∫–ª—é—á–∞

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI Assistant

**–°–æ–∑–¥–∞–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ OpenAI Playground
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ `OPENAI_ASSISTANT_ID`

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebApp

**–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ WebApp:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
ls -la index.html menu.html app.js

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ URL –≤ .env
WEB_APP_URL=https://your-domain.com/
```

### 8. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫
python3 bot.py

# –ó–∞–ø—É—Å–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
python3 bot.py 2>&1 | tee bot.log

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
nohup python3 bot.py > bot.log 2>&1 &
```

## üåê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ WebApp –Ω–∞ GitHub Pages

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π WebApp

WebApp (Mini App) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ GitHub Pages –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É `main`.

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages:

1. **–í–∫–ª—é—á–∏—Ç–µ GitHub Pages –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**
   - Settings ‚Üí Pages
   - Source: GitHub Actions
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

2. **–§–∞–π–ª `.github/workflows/deploy.yml` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
   ```yaml
   name: Deploy to GitHub Pages
   
   on:
     push:
       branches: ["main"]
     workflow_dispatch:
   
   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - name: Checkout
           uses: actions/checkout@v4
         - name: Setup Pages
           uses: actions/configure-pages@v4
         - name: Prepare files for deployment
           run: |
             mkdir -p /tmp/deploy
             cp index.html /tmp/deploy/
             cp menu.html /tmp/deploy/
             cp app.js /tmp/deploy/
         - name: Upload artifact
           uses: actions/upload-pages-artifact@v3
           with:
             path: /tmp/deploy
         - name: Deploy to GitHub Pages
           uses: actions/deploy-pages@v4
   ```

3. **URL WebApp –±—É–¥–µ—Ç:**
   ```
   https://your-username.github.io/marketing/
   ```

4. **–û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `WEB_APP_URL` –≤ `.env`:**
   ```env
   WEB_APP_URL=https://your-username.github.io/marketing/
   ```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ WebApp —Ñ–∞–π–ª–æ–≤:
- **`index.html`** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- **`menu.html`** - –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å –∞–∫—Ü–∏—è–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏
- **`app.js`** - JavaScript –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram WebApp API

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebApp:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –±–æ—Ç—É
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ü–∏–π

---

## üê≥ Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–¥–ª—è Production)

Docker ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω .env —Ñ–∞–π–ª
cp .env.example .env
nano .env
```

### 2. –ó–∞–ø—É—Å–∫ —Å Docker Compose
```bash
# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

## ‚òÅÔ∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ PythonAnywhere (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï)

PythonAnywhere - –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è Python Telegram –±–æ—Ç–æ–≤ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º HTTPS –∏ –ø—Ä–æ—Å—Ç–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π.

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [pythonanywhere.com](https://www.pythonanywhere.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP)

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ PythonAnywhere
git clone https://github.com/synthosaicreativestudio-maker/marketing.git
cd marketing
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è Python 3.13 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
pip3 install --user -r requirements.txt

# –ò–ª–∏ –¥–ª—è Python 3.10
pip3.10 install --user -r requirements.txt
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
cp .env.example .env
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è PythonAnywhere:**
```bash
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets
SHEET_ID=authorization_sheet_id
APPEALS_SHEET_ID=appeals_sheet_id
PROMOTIONS_SHEET_ID=promotions_sheet_id
GCP_SA_JSON={"type": "service_account", ...}

# WebApp
WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/
WEBHOOK_URL=https://yourusername.pythonanywhere.com/webhook
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Web App
1. –í –ø–∞–Ω–µ–ª–∏ PythonAnywhere –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Web"
2. –ù–∞–∂–º–∏—Ç–µ "Add a new web app"
3. –í—ã–±–µ—Ä–∏—Ç–µ "Flask" –∏ Python 3.10
4. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å: `/home/yourusername/marketing/webhook_handler.py`
5. –ù–∞–∂–º–∏—Ç–µ "Reload"

### 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ PythonAnywhere
python3 bot.py
```

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "Tasks"
# –ö–æ–º–∞–Ω–¥–∞: python3 /home/yourusername/marketing/bot.py
# –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ —Å–±–æ—è—Ö)
```

## ‚òÅÔ∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–µ (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)

### Google Cloud Run
```bash
# –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞
gcloud builds submit --tag gcr.io/PROJECT_ID/marketingbot

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
gcloud run deploy marketingbot \
  --image gcr.io/PROJECT_ID/marketingbot \
  --platform managed \
  --region us-central1 \
  --set-env-vars TELEGRAM_TOKEN=your-token \
  --no-allow-unauthenticated
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ `gspread` –∏–ª–∏ `dotenv`:
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ `pip install -r requirements.txt`.

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `TELEGRAM_TOKEN` –≤ `.env`.
2.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.
3.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

### –û—à–∏–±–∫–∏ WebApp:
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `WEB_APP_URL` –≤ `.env` —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω.
2.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã `index.html` –∏ `menu.html` –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ URL.

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–±—Ä–∞—â–µ–Ω–∏–π:
1. **–°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Service Account –∫ —Ç–∞–±–ª–∏—Ü–µ –æ–±—Ä–∞—â–µ–Ω–∏–π
2. **–≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `_is_user_escalation_request()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–û—Ç–≤–µ—Ç—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É ResponseMonitor –≤ –ª–æ–≥–∞—Ö

### –ü—Ä–æ–±–ª–µ–º—ã —Å OpenAI:
1. **–û—à–∏–±–∫–∏ API**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `OPENAI_API_KEY` –∏ `OPENAI_ASSISTANT_ID`
2. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞ OpenAI
3. **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è OpenAI API (2-10 —Å–µ–∫—É–Ω–¥)

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:
1. **–ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –º–µ–Ω—é**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `WEB_APP_URL` –∏ —Ä–∞–±–æ—Ç—É —Ñ—É–Ω–∫—Ü–∏–∏ `get_spa_menu_url()`
2. **–ü–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. **–û—à–∏–±–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**: –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª `auth_cache.json` –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞

## üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ v3.1

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()

print('=== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MarketingBot v3.1 ===')
print(f'Telegram Token: {\"‚úì\" if os.getenv(\"TELEGRAM_TOKEN\") else \"‚úó\"}')
print(f'OpenAI API Key: {\"‚úì\" if os.getenv(\"OPENAI_API_KEY\") else \"‚úó\"}')
print(f'OpenAI Assistant ID: {\"‚úì\" if os.getenv(\"OPENAI_ASSISTANT_ID\") else \"‚úó\"}')
print(f'Sheets ID: {\"‚úì\" if os.getenv(\"SHEET_ID\") else \"‚úó\"}')
print(f'Appeals Sheets ID: {\"‚úì\" if os.getenv(\"APPEALS_SHEET_ID\") else \"‚úó\"}')
print(f'WebApp URL: {os.getenv(\"WEB_APP_URL\", \"‚úó\")}')
print(f'GCP SA File: {\"‚úì\" if os.getenv(\"GCP_SA_FILE\") else \"‚úó\"}')
"
```

### –¢–µ—Å—Ç –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
```bash
# –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏
python3 -c "
from handlers import _is_user_escalation_request
test_phrases = ['–∞ –≤—ã –º–Ω–µ –ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ?', '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '–ø—Ä–∏–≤–µ—Ç']
for phrase in test_phrases:
    result = _is_user_escalation_request(phrase)
    print(f'{phrase}: {\"–≠—Å–∫–∞–ª–∞—Ü–∏—è\" if result else \"–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\"}')
"

# –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL
python3 -c "
from handlers import get_web_app_url, get_spa_menu_url
print(f'Auth URL: {get_web_app_url()}')
print(f'Menu URL: {get_spa_menu_url()}')
"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f bot.log | grep -E "(—ç—Å–∫–∞–ª–∞—Ü–∏—è|—Å—Ç–∞—Ç—É—Å|–∑–∞–ª–∏–≤–∫–∞|WebApp)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã ResponseMonitor
grep -i "response_monitor" bot.log | tail -10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤
grep -i "—Å—Ç–∞—Ç—É—Å.*—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\|—Å—Ç–∞—Ç—É—Å.*–æ–±–Ω–æ–≤–ª–µ–Ω" bot.log | tail -10
```


================================================================================
FILE: ./docs/DEPLOYMENT_ARCHITECTURE.md
SIZE: 10826 bytes
================================================================================

# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–µ–ø–ª–æ—è: GitHub vs PythonAnywhere

## üìç –ì–¥–µ —á—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è

### üîµ GitHub (–•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–¥–∞)

**–ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è:**
- ‚úÖ –í–µ—Å—å –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–µ–∫—Ç–∞
- ‚úÖ –§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–∫—Ä–æ–º–µ `.env` - –æ–Ω –≤ `.gitignore`)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (git)

**–ß—Ç–æ –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è:**
- ‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (—Ñ–∞–π–ª—ã `.db`)
- ‚ùå –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ (`.env` —Ñ–∞–π–ª)
- ‚ùå –õ–æ–≥–∏ (`*.log`)
- ‚ùå –ö—ç—à (`__pycache__/`)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ GitHub:**
```
marketingbot/
‚îú‚îÄ‚îÄ bot.py
‚îú‚îÄ‚îÄ handlers.py
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îî‚îÄ‚îÄ database.py
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ ...
```

---

### üü¢ PythonAnywhere (–°–µ—Ä–≤–µ—Ä - –≥–¥–µ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–ß—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

#### 1. **–ë–æ—Ç (bot.py)**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å
- –†–∞–±–æ—Ç–∞–µ—Ç 24/7
- –ü—É—Ç—å: `/home/yourusername/marketing/bot.py`

#### 2. **REST API (FastAPI)**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Web App –≤ PythonAnywhere
- –î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `https://yourusername.pythonanywhere.com`
- –ü—É—Ç—å: `/home/yourusername/marketing/api/main.py`

#### 3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (SQLite)**
- –§–∞–π–ª: `/home/yourusername/marketing/db/appeals.db`
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
- **–í–ê–ñ–ù–û**: –≠—Ç–æ—Ç —Ñ–∞–π–ª –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ GitHub (–≤ `.gitignore`)

#### 4. **–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (HTML/JS)**
- –í–∞—Ä–∏–∞–Ω—Ç A: –ù–∞ PythonAnywhere (–≤ –ø–∞–ø–∫–µ `static/`)
- –í–∞—Ä–∏–∞–Ω—Ç B: –ù–∞ GitHub Pages (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)
- –í–∞—Ä–∏–∞–Ω—Ç C: –ù–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ö–æ—Å—Ç–∏–Ω–≥–µ

#### 5. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)**
- –§–∞–π–ª: `/home/yourusername/marketing/.env`
- –°–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏
- **–ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ GitHub**

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –¥–µ–ø–ª–æ—è

### –®–∞–≥ 1: –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)
```bash
# –ù–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
git add .
git commit -m "–î–æ–±–∞–≤–ª–µ–Ω–∞ –ë–î –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π"
git push origin main
```

### –®–∞–≥ 2: –î–µ–ø–ª–æ–π –Ω–∞ PythonAnywhere
```bash
# –ù–∞ PythonAnywhere —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
cd ~/marketing
git pull origin main
pip3.10 install --user -r requirements.txt
python3.10 init_db.py  # –°–æ–∑–¥–∞—Ç—å –ë–î, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
pkill -f "python.*bot.py"
nohup python3.10 bot.py > bot.log 2>&1 &
```

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Web App
- –í –ø–∞–Ω–µ–ª–∏ PythonAnywhere ‚Üí Web ‚Üí Reload

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ PythonAnywhere

```
/home/yourusername/marketing/
‚îú‚îÄ‚îÄ bot.py                    # –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç
‚îú‚îÄ‚îÄ handlers.py               # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îú‚îÄ‚îÄ .env                      # –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ (–ù–ï –≤ git)
‚îú‚îÄ‚îÄ bot.log                   # –õ–æ–≥–∏ –±–æ—Ç–∞ (–ù–ï –≤ git)
‚îÇ
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ appeals.db           # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite (–ù–ï –≤ git)
‚îÇ   ‚îú‚îÄ‚îÄ models.py            # –ú–æ–¥–µ–ª–∏ SQLAlchemy
‚îÇ   ‚îî‚îÄ‚îÄ database.py           # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ appeals.py       # API endpoints
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ appeals_db.py    # –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
‚îÇ
‚îú‚îÄ‚îÄ miniapp/                  # –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îî‚îÄ‚îÄ styles.css
‚îÇ
‚îî‚îÄ‚îÄ requirements.txt         # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –≥–¥–µ –∏ –∫–∞–∫

### SQLite (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- –§–∞–π–ª: `/home/yourusername/marketing/db/appeals.db`
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ `init_db.py`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ (–æ–¥–∏–Ω —Ñ–∞–π–ª)
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ PythonAnywhere

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- ‚ö†Ô∏è –ù–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –ª—É—á—à–µ PostgreSQL)

### PostgreSQL (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:**
- –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, ElephantSQL, Heroku Postgres)
- –ò–ª–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**
```bash
# –í .env
DATABASE_URL=postgresql://user:password@host:5432/dbname
```

---

## üåê –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: PythonAnywhere (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—á–∞–ª–∞)

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
/home/yourusername/marketing/miniapp/
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ app.js
‚îî‚îÄ‚îÄ styles.css
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ PythonAnywhere:**
1. Web ‚Üí Static files
2. –î–æ–±–∞–≤–∏—Ç—å mapping: `/miniapp/` ‚Üí `/home/yourusername/marketing/miniapp/`
3. URL: `https://yourusername.pythonanywhere.com/miniapp/index.html`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í—Å–µ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- ‚úÖ HTTPS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: GitHub Pages

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
- –û—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–ª–∏ –≤–µ—Ç–∫–∞ `gh-pages`
- URL: `https://yourusername.github.io/marketing-miniapp/`

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ
- ‚úÖ CDN –æ—Ç GitHub
- ‚úÖ –û—Ç–¥–µ–ª—å–Ω–æ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–¥–µ–ª—å–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥

- Netlify, Vercel, –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π —Ö–æ—Å—Ç–∏–Ω–≥

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–µ–∫—Ä–µ—Ç—ã

### –ß—Ç–æ –ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ GitHub:

1. **`.env` —Ñ–∞–π–ª** - —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å–µ–∫—Ä–µ—Ç—ã
   ```bash
   # –í .gitignore
   .env
   ```

2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - —Ñ–∞–π–ª—ã `.db`
   ```bash
   # –í .gitignore
   *.db
   db/*.db
   ```

3. **–õ–æ–≥–∏** - —Ñ–∞–π–ª—ã `.log`
   ```bash
   # –í .gitignore
   *.log
   ```

### –ì–¥–µ —Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞ PythonAnywhere:

1. **–í `.env` —Ñ–∞–π–ª–µ** (–ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
2. **–í –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è PythonAnywhere** (Web ‚Üí Environment variables)
3. **–í –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ** (–Ω–µ –≤ git)

---

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   GitHub        ‚îÇ
‚îÇ   (–ö–æ–¥)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ git pull
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ PythonAnywhere  ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ  bot.py   ‚îÇ  ‚îÇ ‚Üê Telegram Bot
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ        ‚îÇ        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ REST API  ‚îÇ  ‚îÇ ‚Üê FastAPI (Web App)
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ        ‚îÇ        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ   –ë–î      ‚îÇ  ‚îÇ ‚Üê SQLite (appeals.db)
‚îÇ  ‚îÇ (SQLite)  ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ miniapp/  ‚îÇ  ‚îÇ ‚Üê –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏  ‚îÇ
‚îÇ  (Telegram)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —á–µ–∫–ª–∏—Å—Ç –¥–µ–ø–ª–æ—è

### –ü–µ—Ä–≤—ã–π —Ä–∞–∑:

- [ ] –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ PythonAnywhere
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (`pip install -r requirements.txt`)
- [ ] –°–æ–∑–¥–∞—Ç—å `.env` —Ñ–∞–π–ª —Å —Å–µ–∫—Ä–µ—Ç–∞–º–∏
- [ ] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î (`python3.10 init_db.py`)
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (`python3.10 bot.py`)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Web App –¥–ª—è REST API
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Static files –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:

- [ ] `git pull origin main` –Ω–∞ PythonAnywhere
- [ ] `pip3.10 install --user -r requirements.txt` (–µ—Å–ª–∏ –Ω–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
- [ ] –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
- [ ] Reload Web App

---

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ù–∞ PythonAnywhere (–≤ `.env`):

```bash
# Telegram
TELEGRAM_TOKEN=your_token

# OpenAI
OPENAI_API_KEY=your_key
OPENAI_ASSISTANT_ID=your_id

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=sqlite:///./db/appeals.db
# –∏–ª–∏ –¥–ª—è PostgreSQL:
# DATABASE_URL=postgresql://user:pass@host:5432/db

# API
API_URL=https://yourusername.pythonanywhere.com
API_KEY=your_secret_key

# WebApp
WEB_APP_URL=https://yourusername.pythonanywhere.com/miniapp/
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ù–ï —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ git**
   - –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä—É—á–Ω—É—é
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `mysqldump` –∏–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç SQLite

2. **`.env` —Ñ–∞–π–ª –ù–ï –≤ git**
   - –°–æ–∑–¥–∞–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è PythonAnywhere

3. **–õ–æ–≥–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ `tail -f bot.log`
   - –ò–ª–∏ —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å PythonAnywhere

4. **–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ**
   - –ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ
   - –ì–ª–∞–≤–Ω–æ–µ - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö

---

## üîÑ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:

```bash
# SQLite
cp ~/marketing/db/appeals.db ~/backups/appeals_$(date +%Y%m%d).db

# –ò–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç –≤ SQL
sqlite3 ~/marketing/db/appeals.db .dump > ~/backups/appeals_$(date +%Y%m%d).sql
```

### –ö–æ–¥:

```bash
# –í—Å–µ —É–∂–µ –≤ GitHub - —ç—Ç–æ –∏ –µ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–¥–∞
```

---

**–ò—Ç–æ–≥–æ:**
- **GitHub** = —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∫–æ–¥–∞
- **PythonAnywhere** = —Å–µ—Ä–≤–µ—Ä, –≥–¥–µ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–±–æ—Ç, API, –ë–î, –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)


================================================================================
FILE: ./docs/DESIGN_PLAN.md
SIZE: 2416 bytes
================================================================================

# üé® –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏: Premium Redesign

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å "–í–∞—É-—ç—Ñ—Ñ–µ–∫—Ç" –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ WebApp. –ü–µ—Ä–µ—Ö–æ–¥ –æ—Ç —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞ –∫ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º—É (Glassmorphism).

## 1. –î–∏–∑–∞–π–Ω-–∫–æ–Ω—Ü–µ–ø—Ü–∏—è (Visual Style)
*   **–¢–µ–º–∞:** Dark Mode (–ì–ª—É–±–æ–∫–∏–π —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω).
*   **–°—Ç–∏–ª—å:** Glassmorphism (–ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —Ä–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ `backdrop-filter: blur`).
*   **–¶–≤–µ—Ç–∞:**
    *   –§–æ–Ω: –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π/–ß–µ—Ä–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç.
    *   –ê–∫—Ü–µ–Ω—Ç: –ù–µ–æ–Ω–æ–≤—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (`#8A2BE2`) –∏ –≥–æ–ª—É–±–æ–π (`#00BFFF`).
    *   –¢–µ–∫—Å—Ç: –ë–µ–ª—ã–π (—Å —Ä–∞–∑–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏–∏).
*   **–®—Ä–∏—Ñ—Ç—ã:** `Inter` –∏–ª–∏ `Outfit` (Google Fonts).

## 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Frontend)

### 2.1. CSS –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
*   –í–Ω–µ–¥—Ä–µ–Ω–∏–µ CSS Variables –¥–ª—è —Ü–≤–µ—Ç–æ–≤ –∏ –æ—Ç—Å—Ç—É–ø–æ–≤.
*   –°–±—Ä–æ—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –±—Ä–∞—É–∑–µ—Ä–∞ (Reset CSS).
*   –ù–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Å—Ç–µ–∫–ª–∞ (`.glass-card`, `.glass-button`).

### 2.2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
*   **Header:** –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –∞–≤–∞—Ç–∞—Ä–æ–º (–∑–∞–≥–ª—É—à–∫–æ–π).
*   **Navigation:** –ü–ª–∞–≤–∞—é—â–µ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é –∏–ª–∏ —Å—Ç–∏–ª—å–Ω—ã–µ —Ç–∞–±—ã.
*   **Promotions Cards:**
    *   –í–º–µ—Å—Ç–æ —Å–ø–∏—Å–∫–∞ ‚Äî –∫—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–π –æ–±–≤–æ–¥–∫–æ–π.
    *   –°—Ç–∞—Ç—É—Å –∞–∫—Ü–∏–∏ (–ê–∫—Ç–∏–≤–Ω–∞) –≤ –≤–∏–¥–µ —Å–≤–µ—Ç—è—â–µ–≥–æ—Å—è –±–µ–π–¥–∂–∞.
*   **Loading State:** Skeleton-–∞–Ω–∏–º–∞—Ü–∏—è (–º–µ—Ä—Ü–∞—é—â–∏–µ –±–ª–æ–∫–∏) –≤–º–µ—Å—Ç–æ —Å–ø–∏–Ω–Ω–µ—Ä–∞.

### 2.3. –ê–Ω–∏–º–∞—Ü–∏–∏
*   –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (`fade-in-up`).
*   –ú–∏–∫—Ä–æ-–∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫–∏ (`scale`).
*   –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–∞ —Ñ–æ–Ω–µ.

## 3. –ü–ª–∞–Ω —Ä–∞–±–æ—Ç
1.  [ ] –ü–æ–¥–∫–ª—é—á–∏—Ç—å Google Fonts.
2.  [ ] –ó–∞–º–µ–Ω–∏—Ç—å CSS –≤ `menu.html` –Ω–∞ –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏.
3.  [ ] –ü–µ—Ä–µ–≤–µ—Ä—Å—Ç–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–∫—Ü–∏–π.
4.  [ ] –î–æ–±–∞–≤–∏—Ç—å Skeleton Loader.
5.  [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (Mobile First).

---
**–°—Ç–∞—Ç—É—Å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–∞–∫–µ—Ç–∞.


================================================================================
FILE: ./docs/FEATURES.md
SIZE: 25953 bytes
================================================================================

# ‚ö° –§—É–Ω–∫—Ü–∏–∏ MarketingBot v3.2

## üéØ –û–±–∑–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π

MarketingBot v3.2 –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞:
- üîê **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ Google Sheets
- üë• **–≠—Å–∫–∞–ª–∞—Ü–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∂–∏–≤—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
- üéâ **–°–∏—Å—Ç–µ–º–∞ –∞–∫—Ü–∏–π** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∞–∫—Ü–∏–π –∏ —Å–æ–±—ã—Ç–∏–π
- ü§ñ **–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** - –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
- üìä **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏** - –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ —Ä–µ—à–µ–Ω–∏—è

---

## üîê –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤

### –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –∫ –±–æ—Ç—É —á–µ—Ä–µ–∑ Google Sheets. –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞.

### –ü–æ—Ç–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (Mini App ‚Üí –ë–æ—Ç ‚Üí Google Sheets)

#### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ `.env`:
  - `TELEGRAM_TOKEN`
  - `WEB_APP_URL` (HTTPS, GitHub Pages –ø–æ–¥—Ö–æ–¥–∏—Ç)
  - `SHEET_ID`
  - –û–¥–∏–Ω –∏–∑: `GCP_SA_FILE` (–∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å) –∏–ª–∏ `GCP_SA_JSON` (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ JSON)
  - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: `SHEET_NAME` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç)
- –¢–∞–±–ª–∏—Ü–∞ Google Sheets —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏:
  - A: `–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞`
  - C: `–¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞`
  - D: `–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏` (–∏–ª–∏ `–°—Ç–∞—Ç—É—Å`)
  - E: `Telegram ID`
  - F: `–î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏`

#### –®–∞–≥–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è

**1) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `/start`**
- –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç Reply‚Äë–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –∑–∞–ø—É—Å–∫–∞ Mini App
- –í–∞–∂–Ω–æ: –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Reply‚Äë–∫–Ω–æ–ø–∫—É ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ `Telegram.WebApp.sendData()`

**2) Mini App (WebView) –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ `WEB_APP_URL`**
- –§–∞–π–ª—ã: `index.html`, `app.js`
- –ü—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `Telegram.WebApp` –∏ `MainButton`
- –ü–æ–ª—è —Ñ–æ—Ä–º—ã:
  - –ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
  - –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ü–∏—Ñ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä `89827701055`)
- –ü—Ä–∏ –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö `MainButton` –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

**3) –ë–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ Mini App**
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å —Ñ–∏–ª—å—Ç—Ä–æ–º `filters.StatusUpdate.WEB_APP_DATA`
- –ë–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç JSON, –ª–æ–≥–∏—Ä—É–µ—Ç —Å—ã—Ä—å–µ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª—è `partner_code`, `partner_phone`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ¬´–ü—Ä–æ–≤–µ—Ä—è—é –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ‚Ä¶¬ª

**4) –ü–æ–∏—Å–∫ –≤ Google Sheets –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞**
- –ö–æ–¥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `AuthService` ‚Üí `sheets.py`
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏:
  - –ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ (—Ü–∏—Ñ—Ä—ã –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
  - –¢–µ–ª–µ—Ñ–æ–Ω –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –¥–æ —Ü–∏—Ñ—Ä; —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —Ü–∏—Ñ—Ä–∞–º
  - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä—É—Å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫
- –ü—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–∞–∫–µ—Ç–Ω–æ (–¥–∏–∞–ø–∞–∑–æ–Ω `D:F` –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π):
  - D: `–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω`
  - E: `Telegram ID`
  - F: –¥–∞—Ç–∞/–≤—Ä–µ–º—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: ¬´–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å.¬ª

**5) –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è**
- –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç: ¬´–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.¬ª
- –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –±–æ—Ç —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞ Mini App

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –¥–∞–Ω–Ω—ã–º
- –ö–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞: —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `111098`)
- –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω—ë—Ä–∞: –¥–æ–ø—É—Å—Ç–∏–º –ª—é–±–æ–π –≤–≤–æ–¥, –Ω–æ –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞
- –ó–∞–ø—É—Å–∫ Mini App —Å—Ç—Ä–æ–≥–æ —á–µ—Ä–µ–∑ Reply‚Äë–∫–Ω–æ–ø–∫—É (–Ω–µ inline) ‚Äî –∏–Ω–∞—á–µ `sendData()` –±—É–¥–µ—Ç –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ `filters.StatusUpdate.WEB_APP_DATA` –≤ –±–æ—Ç–µ
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ `tg.close()` (~300–º—Å) –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –≥–æ–Ω–∫–∏

---

## üë• –°–∏—Å—Ç–µ–º–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º

### –û–ø–∏—Å–∞–Ω–∏–µ
–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞. –ö–æ–≥–¥–∞ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Google Sheets.

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

#### 1. –î–µ—Ç–µ–∫—Ü–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏
AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–≤–æ–π –æ—Ç–≤–µ—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É. –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞:
- "–ü–µ—Ä–µ–¥–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞"
- "–°–≤—è–∂—É –≤–∞—Å —Å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º"
- "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è"
- –ò –¥—Ä—É–≥–∏–µ –ø–æ–¥–æ–±–Ω—ã–µ —Ñ—Ä–∞–∑—ã

–¢–æ —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –∫–∞–∫ —ç—Å–∫–∞–ª–∞—Ü–∏—é.

#### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞:
1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ "–≤ —Ä–∞–±–æ—Ç–µ" –≤ –∫–æ–ª–æ–Ω–∫–µ F
2. –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∑–∞–ª–∏–≤–∫—É —Ü–≤–µ—Ç–∞ #f4cccc (–∫—Ä–∞—Å–Ω–æ–≤–∞—Ç—ã–π –æ—Ç—Ç–µ–Ω–æ–∫)
3. –õ–æ–≥–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

#### 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã
–¢–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏:
- A: –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- B: —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞  
- C: –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- D: telegram_id
- E: —Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π
- **F: —Å—Ç–∞—Ç—É—Å** (–Ω–æ–≤–æ–µ, –≤ —Ä–∞–±–æ—Ç–µ, —Ä–µ—à–µ–Ω–æ, –∑–∞–∫—Ä—ã—Ç–æ)
- G: —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç
- H: –≤—Ä–µ–º—è_–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

#### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
- `handlers.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `_is_escalation_response()` –∏ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –≤ `chat_handler()`
- `appeals_service.py` - –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `set_status_escalated()`

#### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

**`_is_escalation_response(text: str) -> bool`**
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Ñ—Ä–∞–∑—ã —ç—Å–∫–∞–ª–∞—Ü–∏–∏.

**`set_status_escalated(telegram_id: int) -> bool`**
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–≤ —Ä–∞–±–æ—Ç–µ" —Å –∑–∞–ª–∏–≤–∫–æ–π #f4cccc –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
- `APPEALS_SHEET_ID` - ID —Ç–∞–±–ª–∏—Ü—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏
- `APPEALS_SHEET_NAME` - –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "–æ–±—Ä–∞—â–µ–Ω–∏—è")

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ Google Sheets:
1. –í—ã–¥–µ–ª–∏—Ç–µ –∫–æ–ª–æ–Ω–∫—É F (—Å—Ç–∞—Ç—É—Å)
2. –î–∞–Ω–Ω—ã–µ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –∑–Ω–∞—á–µ–Ω–∏–π: "–Ω–æ–≤–æ–µ", "–≤ —Ä–∞–±–æ—Ç–µ", "—Ä–µ—à–µ–Ω–æ", "–∑–∞–∫—Ä—ã—Ç–æ"
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É—Å–ª–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å = "–≤ —Ä–∞–±–æ—Ç–µ" ‚Üí —Ü–≤–µ—Ç #f4cccc
   - –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å = "–≤ —Ä–∞–±–æ—Ç–µ" ‚Üí –¥—Ä—É–≥–æ–π —Ü–≤–µ—Ç
   - –ò —Ç.–¥.

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ñ–∞–π–ª `bot.log` —Å —É—Ä–æ–≤–Ω–µ–º INFO:
- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏
- –£—Å–ø–µ—à–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

---

## üéâ –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ü–∏—è–º–∏

### –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ü–∏—è–º–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ê–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Google Sheets –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Telegram –±–æ—Ç–µ.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ü–∏–π

#### Google Sheets: "–ê–∫—Ü–∏–∏"
**URL:** `https://docs.google.com/spreadsheets/d/1V3-cPRq_SmbCbIzn1-CWSqD8pdpDqraq_GJ7LjMmwf8/edit?usp=sharing`

#### –ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:
| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|----------|---------|
| A | –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ | –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–∏ | 05.10.2025 |
| B | –ù–∞–∑–≤–∞–Ω–∏–µ | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ | "–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏" |
| C | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ | "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤" |
| D | **–°—Ç–∞—Ç—É—Å** | **–°—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏** | "–ê–∫—Ç–∏–≤–Ω–∞", "–û–∂–∏–¥–∞–µ—Ç", "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" |
| E | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞–∫—Ü–∏–∏ | 05.10.2025 |
| F | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–∫—Ü–∏–∏ | 31.10.2025 |
| G | –ö–æ–Ω—Ç–µ–Ω—Ç | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç | 123 |
| H | –î–µ–π—Å—Ç–≤–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ (–ø—É—Å—Ç–æ–µ) | - |
| I | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–ø—É—Å—Ç–æ–µ) | - |

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### 1. –°—Ç–∞—Ç—É—Å—ã –∞–∫—Ü–∏–π (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ —Ç–∞–±–ª–∏—Ü–µ)
- **"–ê–∫—Ç–∏–≤–Ω–∞"** - –∞–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- **"–û–∂–∏–¥–∞–µ—Ç"** - –∞–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞, –Ω–æ –µ—â–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞  
- **"–ó–∞–∫–æ–Ω—á–µ–Ω–∞"** - –∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞

#### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–∞–º
–ë–æ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∞—Ç—ã –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–∏:

- **–ê–∫—Ç–∏–≤–Ω–∞** (–∑–µ–ª–µ–Ω—ã–π) - —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞" + —Å–µ–≥–æ–¥–Ω—è –º–µ–∂–¥—É –¥–∞—Ç–æ–π –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
- **–û–∂–∏–¥–∞–µ—Ç** (–∂–µ–ª—Ç—ã–π) - —Å—Ç–∞—Ç—É—Å "–û–∂–∏–¥–∞–µ—Ç" –∏–ª–∏ —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞" –Ω–æ —Å–µ–≥–æ–¥–Ω—è —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞
- **–ó–∞–≤–µ—Ä—à–µ–Ω–∞** (—Å–µ—Ä—ã–π) - —Å—Ç–∞—Ç—É—Å "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" –∏–ª–∏ —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞" –Ω–æ —Å–µ–≥–æ–¥–Ω—è –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è

#### 3. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º **"–ê–∫—Ç–∏–≤–Ω–∞"**
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –∞–∫—Ç–∏–≤–Ω—ã–µ ‚Üí –æ–∂–∏–¥–∞—é—â–∏–µ ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
- –ö—Ä–∞—Å–∏–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –¥–∞—Ç–∞–º–∏

### –î–∏–∑–∞–π–Ω –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–∫—Ü–∏–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üî• –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏     ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è     ‚îÇ
‚îÇ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤. –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ    ‚îÇ
‚îÇ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞.                   ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ üìÖ 05.10.2025 - 31.10.2025     ‚îÇ
‚îÇ [–ê–∫—Ç–∏–≤–Ω–∞]                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### –§–∞–π–ª—ã —Å–∏—Å—Ç–µ–º—ã:
1. **`promotions_api.py`** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
2. **`handlers.py`** - –∫–æ–º–∞–Ω–¥–∞ `/promotions` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. **`menu.html`** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

#### –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è" –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
2. JavaScript –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Telegram WebApp
3. –î–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç –±–æ—Ç–∞ (–∫–æ–º–∞–Ω–¥–∞ `/promotions`)
4. –ê–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫—Ä–∞—Å–∏–≤—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏

### –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∞–∫—Ü–∏–∏:
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∞–∫—Ü–∏–π
2. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏:
   - **–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞:** –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   - **–ù–∞–∑–≤–∞–Ω–∏–µ:** –∫—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - **–û–ø–∏—Å–∞–Ω–∏–µ:** –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
   - **–°—Ç–∞—Ç—É—Å:** "–û–∂–∏–¥–∞–µ—Ç"
   - **–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì
   - **–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:** –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì

#### –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–∫—Ü–∏–∏:
1. –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å —Å "–û–∂–∏–¥–∞–µ—Ç" –Ω–∞ "–ê–∫—Ç–∏–≤–Ω–∞"
2. –ê–∫—Ü–∏—è —Å—Ä–∞–∑—É –ø–æ—è–≤–∏—Ç—Å—è –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

#### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–∫—Ü–∏–∏:
1. –ò–∑–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ "–ê–∫—Ç–∏–≤–Ω–∞"
2. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç, —á—Ç–æ –∞–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ø–æ –¥–∞—Ç–µ

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞–µ—Ç –±–æ—Ç:
- ‚ùå –ù–µ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚ùå –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∞–∫—Ü–∏—è—Ö
- ‚ùå –ù–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞—Ç–∞–º–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç –±–æ—Ç:
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ü–∏–∏ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- ‚úÖ –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–∞—Ç–∞–º
- ‚úÖ –ö—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∞–∫—Ü–∏–π
- ‚úÖ –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```env
PROMOTIONS_SHEET_ID=1V3-cPRq_SmbCbIzn1-CWSqD8pdpDqraq_GJ7LjMmwf8
GCP_SA_FILE=path/to/service-account.json
```

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ö–æ–º–∞–Ω–¥–∞ `/promotions` - –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–π –≤ JSON
- –û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è" - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
2. **–ù–∞–∂–∏–º–∞–µ—Ç** "–ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è"  
3. **–í–∏–¥–∏—Ç** —Å–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –∞–∫—Ü–∏–π
4. **–ß–∏—Ç–∞–µ—Ç** –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –¥–∞—Ç—ã
5. **–ü–æ–Ω–∏–º–∞–µ—Ç** —Å—Ç–∞—Ç—É—Å –∞–∫—Ü–∏–∏ (–∞–∫—Ç–∏–≤–Ω–∞/–æ–∂–∏–¥–∞–µ—Ç/–∑–∞–≤–µ—Ä—à–µ–Ω–∞)

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

#### –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:
- **AuthService** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∞–∫—Ü–∏–π
- **Google Sheets API** - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ü–∏–π
- **Telegram WebApp** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- **menu.html** - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –ê–∫—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω–æ–µ API
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –õ–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã –∞–∫—Ü–∏–π:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ü–∏–π
grep -i "promotions" bot.log | tail -10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ API
grep -i "promotions.*error" bot.log | tail -5
```

#### –ú–µ—Ç—Ä–∏–∫–∏:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–∫—Ü–∏–π
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets

---

## üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã

### –û–±–∑–æ—Ä
–°–∏—Å—Ç–µ–º–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –¥–æ—Å—Ç—É–ø –∫ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–æ—Ä–¥–µ–æ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ. –í—Å–µ —É—Å–ª—É–≥–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –≤–∏–¥–µ –∑–∞–≥–ª—É—à–µ–∫ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫–∞–∑–æ–≤.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞
- **5 –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π** —É—Å–ª—É–≥ –≤ –≤–∏–¥–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è —Å–ø–∏—Å–∫–æ–≤
- **–ê–∫–∫–æ—Ä–¥–µ–æ–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –æ—Ç–∫—Ä—ã—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ó–∞–≥–ª—É—à–∫–∏** - –Ω–∞–≤–∏–≥–∞—Ü–∏—è –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç
- **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω** –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–µ–º–æ–π** Telegram (—Å–≤–µ—Ç–ª–∞—è/—Ç–µ–º–Ω–∞—è)

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥

#### 1. üì± –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
- –ü–∞–∫–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –í–µ–¥–µ–Ω–∏–µ –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (–í–ö, Instagram, –î–∑–µ–Ω, YouTube)
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω–∞
- –§–æ—Ç–æ- –∏ –≤–∏–¥–µ–æ—Å—ä–µ–º–∫–∞ –ª—é–¥–µ–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
- –°—ä–µ–º–∫–∞ –∏ –º–æ–Ω—Ç–∞–∂ —Ä–∏–ª—Å
- –ü–æ–ª–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –º–æ–Ω—Ç–∞–∂ —Å—Ç–æ—Ä–∏—Å
- –£—Å–ª—É–≥–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∞ (–ø–æ—Ä—Ç—Ä–µ—Ç—ã, –ª–∞–≤—Å—Ç–æ—Ä–∏, —Å–µ–º–µ–π–Ω—ã–µ —Å—ä–µ–º–∫–∏)

#### 2. ‚úçÔ∏è –¢–µ–∫—Å—Ç—ã –∏ –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥
- –ù–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è —Å–æ—Ü—Å–µ—Ç–µ–π, –∑–∞–º–µ—Ç–∫–∏, –∞–Ω–æ–Ω—Å—ã
- –ò–Ω—Ç–µ—Ä–≤—å—é –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –≤–∏–¥–µ–æ
- –í–µ–¥–µ–Ω–∏–µ Telegram-–∫–∞–Ω–∞–ª–∞ –∏ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ –¥–ª—è –±–ª–æ–≥–∞
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤

#### 3. üé® –î–∏–∑–∞–π–Ω –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥
- –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω (–±—É–∫–ª–µ—Ç—ã, –∫–∞—Ç–∞–ª–æ–≥–∏, –ø–ª–∞–∫–∞—Ç—ã, –ª–∏—Ñ–ª–µ—Ç—ã)
- –í–µ–±-–±–∞–Ω–Ω–µ—Ä—ã –∏ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
- –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –¥–∏–∑–∞–π–Ω: –ª–æ–≥–æ—Ç–∏–ø—ã, –±—Ä–µ–Ω–¥–∏–Ω–≥
- –ò–Ω–∂–µ–Ω–µ—Ä–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞: —á–µ—Ä—Ç–µ–∂–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
- 3D-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏

#### 4. üìà –†–µ–∫–ª–∞–º–∞ –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞—Ä–≥–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã (–Ø–Ω–¥–µ–∫—Å –î–∏—Ä–µ–∫—Ç, –í–ö)
- –£—Å–ª—É–≥–∏ SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∏ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞
- –ü—Ä–æ–¥—é—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–æ–≤ –∫—É—Ä—Å–æ–≤
- SEO-–ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ

#### 5. ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ß–∞—Ç-–±–æ—Ç—ã –∏ —á–∞—Ç-–±–æ—Ç—ã —Å –ò–ò
- –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ –∏ —Å–∞–π—Ç–æ–≤
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å CRM –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

#### HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```html
<div class="services-accordion">
    <div class="service-category">
        <button class="service-category-header" onclick="toggleServiceCategory('category-id')">
            <span class="service-category-icon">üì±</span>
            <span class="service-category-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
            <span class="service-category-arrow">‚ñº</span>
        </button>
        <div class="service-category-content" id="category-id">
            <ul class="service-list">
                <li>–£—Å–ª—É–≥–∞ 1</li>
                <li>–£—Å–ª—É–≥–∞ 2</li>
            </ul>
        </div>
    </div>
</div>
```

#### JavaScript —Ñ—É–Ω–∫—Ü–∏–∏:
- **`toggleServiceCategory(categoryId)`** - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ** –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤–æ–π
- **–ê–Ω–∏–º–∞—Ü–∏–∏** –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏

#### CSS –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞** 2x3 –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ–Ω—é
- **Hover-—ç—Ñ—Ñ–µ–∫—Ç—ã** –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- **–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞** —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–º–µ Telegram
- **–ú–æ–±–∏–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** –¥–ª—è —ç–∫—Ä–∞–Ω–æ–≤ –¥–æ 480px

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

#### –ù–∞–≤–∏–≥–∞—Ü–∏—è:
1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
2. **–ù–∞–∂–∏–º–∞–µ—Ç** "üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã"
3. **–í–∏–¥–∏—Ç** 5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π —É—Å–ª—É–≥
4. **–ö–ª–∏–∫–∞–µ—Ç** –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Üí —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
5. **–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç** –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É—Å–ª—É–≥–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

#### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:
- **–ü–ª–∞–≤–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏** –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è
- **–í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã** (—Å—Ç—Ä–µ–ª–∫–∏) —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Hover-—ç—Ñ—Ñ–µ–∫—Ç—ã** –¥–ª—è –ª—É—á—à–µ–≥–æ UX
- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å** –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —ç–∫—Ä–∞–Ω–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π

#### –°–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏:
- **AuthService** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º —É—Å–ª—É–≥
- **menu.html** - –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
- **Telegram WebApp** - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- **–ë—É–¥—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- –£—Å–ª—É–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ WebApp –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
- –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –±—É–¥—É—â–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–∫–∞–∑–æ–≤

### –ë—É–¥—É—â–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

#### –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- **–°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–∞—Ç—å —É—Å–ª—É–≥–∏
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–ø–ª–∞—Ç–æ–π** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏** - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
- **–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–æ–≤** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:
- **–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- **–ï–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å** - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–µ

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π

### –°–≤—è–∑—å –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏—è–º–∏
1. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** ‚Üí **–í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞)
2. **–ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç** ‚Üí **–≠—Å–∫–∞–ª–∞—Ü–∏—è** (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ)
3. **–û–±—Ä–∞—â–µ–Ω–∏—è** ‚Üí **–≠—Å–∫–∞–ª–∞—Ü–∏—è** (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞–º–∏)
4. **–ê–∫—Ü–∏–∏** ‚Üí **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç** (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ WebApp)
5. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏** ‚Üí **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç** (–∫–∞—Ç–∞–ª–æ–≥ —É—Å–ª—É–≥)

### –û–±—â–∏–π –ø–æ—Ç–æ–∫ —Ä–∞–±–æ—Ç—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ Mini App
2. –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –±–æ—Ç—É –∏ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É
3. –ú–æ–∂–µ—Ç –æ–±—â–∞—Ç—å—Å—è —Å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
5. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è
6. –ò–∑—É—á–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–ï–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
- **–û–±—â–∏–µ Google Sheets** –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
- **–ï–¥–∏–Ω—ã–π WebApp** –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** –¥–ª—è –ª–µ–≥–∫–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** v3.3  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 10 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ


================================================================================
FILE: ./docs/IMPLEMENTATION_PLAN.md
SIZE: 2298 bytes
================================================================================

# üìã –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏: API –¥–ª—è WebApp

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É —Ä–µ–∞–ª—å–Ω—ã—Ö –∞–∫—Ü–∏–π –∏–∑ Google Sheets –≤ WebApp —á–µ—Ä–µ–∑ REST API.

## 1. Backend (Flask)
–§–∞–π–ª: `webhook_handler.py`

- [ ] **–ò–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–æ–≤:** –î–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç `PromotionsAPI` –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.
- [ ] **CORS Headers:** –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `after_request` –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (—á—Ç–æ–±—ã WebApp –º–æ–≥ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É).
- [ ] **Endpoint `/api/promotions`:**
    - –ú–µ—Ç–æ–¥: `GET`
    - –õ–æ–≥–∏–∫–∞: –í—ã–∑–æ–≤ `promotions_api.get_promotions_json()`.
    - –û—Ç–≤–µ—Ç: JSON —Å–æ —Å–ø–∏—Å–∫–æ–º –∞–∫—Ü–∏–π.
    - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫: –í–æ–∑–≤—Ä–∞—Ç 500 –ø—Ä–∏ —Å–±–æ–µ Google Sheets.

## 2. Frontend (WebApp)
–§–∞–π–ª: `menu.html`

- [ ] **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `API_BASE_URL` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, —Ç–∞–∫ –∫–∞–∫ WebApp –∏ API –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–º–µ–Ω–µ, –∏–ª–∏ –∞–¥—Ä–µ—Å PythonAnywhere).
- [ ] **–§—É–Ω–∫—Ü–∏—è `loadPromotions`:**
    - –£–¥–∞–ª–∏—Ç—å –ª–æ–≥–∏–∫—É `tg.sendData`.
    - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `fetch('/api/promotions')`.
    - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ (Loading state) –∏ –æ—à–∏–±–æ–∫.
- [ ] **–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç JSON –æ—Ç API —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–º, —á—Ç–æ –æ–∂–∏–¥–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è `displayPromotions`.

## 3. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
- [ ] –ó–∞–ø—É—Å—Ç–∏—Ç—å `webhook_handler.py` –ª–æ–∫–∞–ª—å–Ω–æ.
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: `curl http://localhost:5000/api/promotions`.
- [ ] –û—Ç–∫—Ä—ã—Ç—å `menu.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∞–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è (–¥–∞–∂–µ –±–µ–∑ Telegram).

## ‚ö†Ô∏è –†–∏—Å–∫–∏
- **Google Sheets API Limits:** –ß–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç —É–ø–µ—Ä–µ—Ç—å—Å—è –≤ –ª–∏–º–∏—Ç—ã Google.
    - *–ú–µ—Ä—ã:* –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `promotions_api.py` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Å—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å (TTL 5 –º–∏–Ω—É—Ç).

---
**–°—Ç–∞—Ç—É—Å:** –û–∂–∏–¥–∞–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.


================================================================================
FILE: ./docs/MIGRATION_IMPLEMENTATION.md
SIZE: 18653 bytes
================================================================================

# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å –ø–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å Google Sheets –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤.

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```
marketingbot/
‚îú‚îÄ‚îÄ api/                    # REST API
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py            # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ models.py           # SQLAlchemy –º–æ–¥–µ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ schemas.py          # Pydantic —Å—Ö–µ–º—ã
‚îÇ   ‚îú‚îÄ‚îÄ database.py         # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ appeals.py      # Endpoints –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ promotions.py   # Endpoints –¥–ª—è –∞–∫—Ü–∏–π
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stats.py        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ appeals_db.py   # –°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π (–ë–î)
‚îÇ       ‚îî‚îÄ‚îÄ promotions_db.py # –°–µ—Ä–≤–∏—Å –∞–∫—Ü–∏–π (–ë–î)
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ migrations/         # Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ database.db         # SQLite —Ñ–∞–π–ª (–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL)
‚îú‚îÄ‚îÄ migrations/             # –°–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ migrate_appeals.py
‚îÇ   ‚îî‚îÄ‚îÄ migrate_promotions.py
‚îú‚îÄ‚îÄ miniapp/               # –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ index.html
‚îÇ   ‚îú‚îÄ‚îÄ app.js
‚îÇ   ‚îú‚îÄ‚îÄ styles.css
‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ       ‚îú‚îÄ‚îÄ AppealsList.js
‚îÇ       ‚îú‚îÄ‚îÄ AppealDetail.js
‚îÇ       ‚îî‚îÄ‚îÄ PromotionsManager.js
‚îú‚îÄ‚îÄ bot.py                 # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–æ—Ç (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î)
‚îú‚îÄ‚îÄ requirements.txt       # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
‚îî‚îÄ‚îÄ .env                   # –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```

## üîß –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 1.1 –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install fastapi uvicorn sqlalchemy alembic pydantic
```

### 1.2 –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î

**–§–∞–π–ª: `api/models.py`**

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey, Index
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import relationship
from datetime import datetime

Base = declarative_base()

class Appeal(Base):
    __tablename__ = 'appeals'
    
    id = Column(Integer, primary_key=True)
    telegram_id = Column(Integer, nullable=False, index=True)
    partner_code = Column(String(50))
    phone = Column(String(20))
    fio = Column(String(200))
    status = Column(String(50), default='–Ω–æ–≤–æ–µ', index=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    messages = relationship("AppealMessage", back_populates="appeal", cascade="all, delete-orphan")
    responses = relationship("SpecialistResponse", back_populates="appeal", cascade="all, delete-orphan")

class AppealMessage(Base):
    __tablename__ = 'appeal_messages'
    
    id = Column(Integer, primary_key=True)
    appeal_id = Column(Integer, ForeignKey('appeals.id', ondelete='CASCADE'), nullable=False, index=True)
    message_type = Column(String(20), nullable=False)  # user, ai, specialist
    message_text = Column(Text, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)

class SpecialistResponse(Base):
    __tablename__ = 'specialist_responses'
    
    id = Column(Integer, primary_key=True)
    appeal_id = Column(Integer, ForeignKey('appeals.id', ondelete='CASCADE'), nullable=False, index=True)
    response_text = Column(Text, nullable=False)
    specialist_name = Column(String(100))
    sent_at = Column(DateTime, default=datetime.utcnow)
    
    appeal = relationship("Appeal", back_populates="responses")

class Promotion(Base):
    __tablename__ = 'promotions'
    
    id = Column(Integer, primary_key=True)
    title = Column(String(200), nullable=False)
    description = Column(Text)
    status = Column(String(50), default='–æ–∂–∏–¥–∞–µ—Ç', index=True)
    start_date = Column(DateTime)
    end_date = Column(DateTime)
    release_date = Column(DateTime)
    content = Column(Text)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
```

## üîå –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ REST API

### 2.1 FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

**–§–∞–π–ª: `api/main.py`**

```python
from fastapi import FastAPI, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from sqlalchemy.orm import Session
from api.database import get_db
from api.routers import appeals, promotions

app = FastAPI(title="MarketingBot API", version="1.0.0")

# CORS –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
app.include_router(appeals.router, prefix="/api/appeals", tags=["appeals"])
app.include_router(promotions.router, prefix="/api/promotions", tags=["promotions"])

@app.get("/")
async def root():
    return {"message": "MarketingBot API"}

@app.get("/health")
async def health():
    return {"status": "ok"}
```

### 2.2 Endpoints –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π

**–§–∞–π–ª: `api/routers/appeals.py`**

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from api.database import get_db
from api.models import Appeal, AppealMessage
from api.schemas import AppealCreate, AppealResponse, MessageCreate

router = APIRouter()

@router.get("/", response_model=List[AppealResponse])
def get_appeals(
    status: Optional[str] = None,
    telegram_id: Optional[int] = None,
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db)
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏"""
    query = db.query(Appeal)
    
    if status:
        query = query.filter(Appeal.status == status)
    if telegram_id:
        query = query.filter(Appeal.telegram_id == telegram_id)
    
    return query.offset(skip).limit(limit).all()

@router.get("/{appeal_id}", response_model=AppealResponse)
def get_appeal(appeal_id: int, db: Session = Depends(get_db)):
    """–ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="Appeal not found")
    return appeal

@router.post("/", response_model=AppealResponse)
def create_appeal(appeal: AppealCreate, db: Session = Depends(get_db)):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ"""
    db_appeal = Appeal(**appeal.dict())
    db.add(db_appeal)
    db.commit()
    db.refresh(db_appeal)
    return db_appeal

@router.put("/{appeal_id}/status")
def update_status(appeal_id: int, status: str, db: Session = Depends(get_db)):
    """–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="Appeal not found")
    
    appeal.status = status
    db.commit()
    return {"message": "Status updated"}

@router.post("/{appeal_id}/messages")
def add_message(appeal_id: int, message: MessageCreate, db: Session = Depends(get_db)):
    """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–µ"""
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="Appeal not found")
    
    db_message = AppealMessage(appeal_id=appeal_id, **message.dict())
    db.add(db_message)
    db.commit()
    return {"message": "Message added"}
```

## üîÑ –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –±–æ—Ç–∞

### 3.1 –ù–æ–≤—ã–π AppealsServiceDB

**–§–∞–π–ª: `api/services/appeals_db.py`**

```python
from sqlalchemy.orm import Session
from api.models import Appeal, AppealMessage, SpecialistResponse
from datetime import datetime
from typing import Optional, List, Dict

class AppealsServiceDB:
    def __init__(self, db: Session):
        self.db = db
    
    def create_appeal(self, telegram_id: int, partner_code: str, 
                     phone: str, fio: str, text: str) -> Appeal:
        """–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ"""
        # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
        appeal = self.db.query(Appeal).filter(
            Appeal.telegram_id == telegram_id
        ).first()
        
        if appeal:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
            appeal.updated_at = datetime.utcnow()
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
            appeal = Appeal(
                telegram_id=telegram_id,
                partner_code=partner_code,
                phone=phone,
                fio=fio,
                status='–Ω–æ–≤–æ–µ'
            )
            self.db.add(appeal)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = AppealMessage(
            appeal_id=appeal.id,
            message_type='user',
            message_text=text
        )
        self.db.add(message)
        self.db.commit()
        self.db.refresh(appeal)
        
        return appeal
    
    def get_appeal_status(self, telegram_id: int) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è"""
        appeal = self.db.query(Appeal).filter(
            Appeal.telegram_id == telegram_id
        ).first()
        return appeal.status if appeal else '–Ω–æ–≤–æ–µ'
    
    def set_status_in_work(self, telegram_id: int) -> bool:
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å '–í —Ä–∞–±–æ—Ç–µ'"""
        appeal = self.db.query(Appeal).filter(
            Appeal.telegram_id == telegram_id
        ).first()
        if appeal:
            appeal.status = '–≤_—Ä–∞–±–æ—Ç–µ'
            appeal.updated_at = datetime.utcnow()
            self.db.commit()
            return True
        return False
    
    def add_ai_response(self, telegram_id: int, response_text: str) -> bool:
        """–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ò–ò"""
        appeal = self.db.query(Appeal).filter(
            Appeal.telegram_id == telegram_id
        ).first()
        if appeal:
            message = AppealMessage(
                appeal_id=appeal.id,
                message_type='ai',
                message_text=response_text
            )
            appeal.status = '–æ—Ç–≤–µ—Ç_–∏–∏'
            appeal.updated_at = datetime.utcnow()
            self.db.add(message)
            self.db.commit()
            return True
        return False
```

## üì± –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### 4.1 HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–§–∞–π–ª: `miniapp/index.html`**

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç - MarketingBot</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <header>
            <h1>–û–±—Ä–∞—â–µ–Ω–∏—è</h1>
            <div class="filters">
                <select id="statusFilter">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="–Ω–æ–≤–æ–µ">–ù–æ–≤–æ–µ</option>
                    <option value="–≤_—Ä–∞–±–æ—Ç–µ">–í —Ä–∞–±–æ—Ç–µ</option>
                    <option value="—Ä–µ—à–µ–Ω–æ">–†–µ—à–µ–Ω–æ</option>
                </select>
            </div>
        </header>
        
        <div id="appealsList" class="appeals-list">
            <!-- –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π -->
        </div>
        
        <div id="appealDetail" class="appeal-detail" style="display: none;">
            <!-- –î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è -->
        </div>
    </div>
    
    <script src="app.js"></script>
</body>
</html>
```

### 4.2 JavaScript –ª–æ–≥–∏–∫–∞

**–§–∞–π–ª: `miniapp/app.js`**

```javascript
const API_URL = 'https://your-api-url.com/api';

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
async function loadAppeals(status = '') {
    const url = status 
        ? `${API_URL}/appeals?status=${status}`
        : `${API_URL}/appeals`;
    
    const response = await fetch(url);
    const appeals = await response.json();
    
    renderAppeals(appeals);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
function renderAppeals(appeals) {
    const list = document.getElementById('appealsList');
    list.innerHTML = appeals.map(appeal => `
        <div class="appeal-card" onclick="showAppealDetail(${appeal.id})">
            <div class="appeal-header">
                <span class="status status-${appeal.status}">${appeal.status}</span>
                <span class="date">${new Date(appeal.created_at).toLocaleDateString()}</span>
            </div>
            <div class="appeal-info">
                <strong>${appeal.fio || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</strong>
                <span>${appeal.phone || ''}</span>
            </div>
        </div>
    `).join('');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
async function showAppealDetail(appealId) {
    const response = await fetch(`${API_URL}/appeals/${appealId}`);
    const appeal = await response.json();
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    const messagesResponse = await fetch(`${API_URL}/appeals/${appealId}/messages`);
    const messages = await messagesResponse.json();
    
    renderAppealDetail(appeal, messages);
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
async function sendResponse(appealId, responseText) {
    await fetch(`${API_URL}/appeals/${appealId}/response`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ response_text: responseText })
    });
    
    loadAppeals();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
loadAppeals();

// –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
document.getElementById('statusFilter').addEventListener('change', (e) => {
    loadAppeals(e.target.value);
});
```

## üîÑ –®–∞–≥ 5: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

### 5.1 –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π

**–§–∞–π–ª: `migrations/migrate_appeals.py`**

```python
import gspread
from google.oauth2.service_account import Credentials
from sqlalchemy.orm import Session
from api.models import Appeal, AppealMessage
from api.database import SessionLocal
import os
import json

def migrate_appeals():
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    sa_json = os.environ.get('GCP_SA_JSON')
    sa_info = json.loads(sa_json)
    creds = Credentials.from_service_account_info(sa_info)
    client = gspread.authorize(creds)
    
    sheet_id = os.environ.get('APPEALS_SHEET_ID')
    spreadsheet = client.open_by_key(sheet_id)
    worksheet = spreadsheet.worksheet('–æ–±—Ä–∞—â–µ–Ω–∏—è')
    
    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    db = SessionLocal()
    
    try:
        records = worksheet.get_all_records()
        
        for record in records:
            telegram_id = int(record.get('telegram_id', 0))
            if not telegram_id:
                continue
            
            # –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–µ
            appeal = Appeal(
                telegram_id=telegram_id,
                partner_code=record.get('–∫–æ–¥', ''),
                phone=record.get('—Ç–µ–ª–µ—Ñ–æ–Ω', ''),
                fio=record.get('–§–ò–û', ''),
                status=record.get('—Å—Ç–∞—Ç—É—Å', '–Ω–æ–≤–æ–µ')
            )
            db.add(appeal)
            db.flush()
            
            # –ü–∞—Ä—Å–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ç–µ–∫—Å—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
            appeals_text = record.get('—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π', '')
            if appeals_text:
                # –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞)
                # ...
                pass
            
        db.commit()
        print(f"–ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(records)} –æ–±—Ä–∞—â–µ–Ω–∏–π")
    finally:
        db.close()

if __name__ == '__main__':
    migrate_appeals()
```

## üöÄ –®–∞–≥ 6: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ bot.py

### 6.1 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–æ–≤–æ–π –ë–î

```python
# bot.py (—á–∞—Å—Ç–∏—á–Ω–æ)
from api.database import SessionLocal
from api.services.appeals_db import AppealsServiceDB

# –í —Ñ—É–Ω–∫—Ü–∏–∏ main()
db = SessionLocal()
appeals_service = AppealsServiceDB(db)

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ handlers
def chat_handler(auth_service, openai_service, appeals_service):
    async def handle_chat(update, context):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º appeals_service –∫–∞–∫ –æ–±—ã—á–Ω–æ
        # –ù–æ —Ç–µ–ø–µ—Ä—å –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î
        pass
```

## üìù –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# .env
DATABASE_URL=sqlite:///./db/database.db
# –∏–ª–∏ –¥–ª—è PostgreSQL:
# DATABASE_URL=postgresql://user:password@localhost/marketingbot

API_URL=https://your-api-url.com
API_KEY=your-secret-api-key

# –°—Ç–∞—Ä—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏)
APPEALS_SHEET_ID=...
PROMOTIONS_SHEET_ID=...
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (FastAPI, SQLAlchemy, Alembic)
- [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (models.py)
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic)
- [ ] –°–æ–∑–¥–∞—Ç—å REST API (FastAPI)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è –∞–∫—Ü–∏–π
- [ ] –°–æ–∑–¥–∞—Ç—å AppealsServiceDB
- [ ] –°–æ–∑–¥–∞—Ç—å PromotionsServiceDB
- [ ] –û–±–Ω–æ–≤–∏—Ç—å bot.py
- [ ] –û–±–Ω–æ–≤–∏—Ç—å handlers.py
- [ ] –û–±–Ω–æ–≤–∏—Ç—å response_monitor.py
- [ ] –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (HTML/JS)
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging
- [ ] –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥**: –ù–∞—á–∞—Ç—å —Å —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –∏ –º–æ–¥–µ–ª–µ–π SQLAlchemy.


================================================================================
FILE: ./docs/MIGRATION_TO_DATABASE.md
SIZE: 12268 bytes
================================================================================

# –ú–∏–≥—Ä–∞—Ü–∏—è —Å Google Sheets –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–∫—Ü–∏–π —Å Google Sheets –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —Å REST API –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## üéØ –¶–µ–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

1. **–£–±—Ä–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Google Sheets API** –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π –∏ –∞–∫—Ü–∏–π
2. **–°–æ–∑–¥–∞—Ç—å REST API** –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
3. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** (–Ω–µ—Ç –ª–∏–º–∏—Ç–æ–≤ API Google)
4. **–£–ø—Ä–æ—Å—Ç–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏** —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
5. **–û–±–µ—Å–ø–µ—á–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** —Å–∏—Å—Ç–µ–º—ã

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: SQLite (–¥–ª—è –Ω–∞—á–∞–ª–∞, –ø—Ä–æ—â–µ)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram Bot   ‚îÇ
‚îÇ   (bot.py)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  REST API       ‚îÇ
‚îÇ  (Flask/FastAPI)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   SQLite DB     ‚îÇ
‚îÇ  (database.db)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mini App        ‚îÇ
‚îÇ  (Web Interface) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: PostgreSQL (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Telegram Bot   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  REST API        ‚îÇ
‚îÇ  (FastAPI)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PostgreSQL     ‚îÇ
‚îÇ  (Cloud DB)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mini App        ‚îÇ
‚îÇ  (React/Vue)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞: `appeals` (–û–±—Ä–∞—â–µ–Ω–∏—è)

```sql
CREATE TABLE appeals (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    telegram_id INTEGER NOT NULL,
    partner_code TEXT,
    phone TEXT,
    fio TEXT,
    status TEXT NOT NULL DEFAULT '–Ω–æ–≤–æ–µ',  -- –Ω–æ–≤–æ–µ, –≤_—Ä–∞–±–æ—Ç–µ, —Ä–µ—à–µ–Ω–æ, –ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_telegram_id (telegram_id),
    INDEX idx_status (status)
);
```

### –¢–∞–±–ª–∏—Ü–∞: `appeal_messages` (–°–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏)

```sql
CREATE TABLE appeal_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    appeal_id INTEGER NOT NULL,
    message_type TEXT NOT NULL,  -- user, ai, specialist
    message_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (appeal_id) REFERENCES appeals(id) ON DELETE CASCADE,
    INDEX idx_appeal_id (appeal_id)
);
```

### –¢–∞–±–ª–∏—Ü–∞: `specialist_responses` (–û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤)

```sql
CREATE TABLE specialist_responses (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    appeal_id INTEGER NOT NULL,
    response_text TEXT NOT NULL,
    specialist_name TEXT,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (appeal_id) REFERENCES appeals(id) ON DELETE CASCADE,
    INDEX idx_appeal_id (appeal_id)
);
```

### –¢–∞–±–ª–∏—Ü–∞: `promotions` (–ê–∫—Ü–∏–∏)

```sql
CREATE TABLE promotions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT '–æ–∂–∏–¥–∞–µ—Ç',  -- –∞–∫—Ç–∏–≤–Ω–∞, –æ–∂–∏–¥–∞–µ—Ç, –∑–∞–∫–æ–Ω—á–µ–Ω–∞
    start_date DATE,
    end_date DATE,
    release_date DATE,
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_status (status),
    INDEX idx_dates (start_date, end_date)
);
```

### –¢–∞–±–ª–∏—Ü–∞: `promotion_notifications` (–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∞–∫—Ü–∏—è—Ö)

```sql
CREATE TABLE promotion_notifications (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    promotion_id INTEGER NOT NULL,
    telegram_id INTEGER NOT NULL,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (promotion_id) REFERENCES promotions(id) ON DELETE CASCADE,
    UNIQUE(promotion_id, telegram_id),
    INDEX idx_telegram_id (telegram_id)
);
```

## üîå REST API Endpoints

### –û–±—Ä–∞—â–µ–Ω–∏—è (Appeals)

```
GET    /api/appeals                    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
GET    /api/appeals/{id}               # –î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è
GET    /api/appeals/user/{telegram_id} # –û–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
POST   /api/appeals                    # –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ
PUT    /api/appeals/{id}/status        # –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
POST   /api/appeals/{id}/messages      # –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
GET    /api/appeals/{id}/messages       # –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
POST   /api/appeals/{id}/response      # –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
```

### –ê–∫—Ü–∏–∏ (Promotions)

```
GET    /api/promotions                 # –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π
GET    /api/promotions/{id}            # –î–µ—Ç–∞–ª–∏ –∞–∫—Ü–∏–∏
POST   /api/promotions                  # –°–æ–∑–¥–∞—Ç—å –∞–∫—Ü–∏—é
PUT    /api/promotions/{id}             # –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ü–∏—é
DELETE /api/promotions/{id}             # –£–¥–∞–ª–∏—Ç—å –∞–∫—Ü–∏—é
GET    /api/promotions/active           # –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞–∫—Ü–∏–∏
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

```
GET    /api/stats/appeals               # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—è–º
GET    /api/stats/promotions            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–∫—Ü–∏—è–º
```

## üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend
- **FastAPI** –∏–ª–∏ **Flask** - REST API
- **SQLAlchemy** - ORM –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
- **SQLite** (–¥–ª—è –Ω–∞—á–∞–ª–∞) –∏–ª–∏ **PostgreSQL** (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
- **Alembic** - –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

### Frontend (Mini App)
- **React** –∏–ª–∏ **Vue.js** - —Ñ—Ä–µ–π–º–≤–æ—Ä–∫
- **Telegram WebApp SDK** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram
- **Axios/Fetch** - HTTP –∫–ª–∏–µ–Ω—Ç

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **PythonAnywhere** –∏–ª–∏ **Heroku** - —Ö–æ—Å—Ç–∏–Ω–≥
- **GitHub Actions** - CI/CD (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## üìù –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (1-2 –¥–Ω—è)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î (SQLAlchemy models)
2. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (Alembic)
3. ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
4. ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ë–î

### –≠—Ç–∞–ø 2: REST API (3-5 –¥–Ω–µ–π)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å FastAPI/Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoints –¥–ª—è –∞–∫—Ü–∏–π
4. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (JWT –∏–ª–∏ API –∫–ª—é—á–∏)
5. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

### –≠—Ç–∞–ø 3: –ú–∏–≥—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤ (2-3 –¥–Ω—è)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `AppealsServiceDB` (–∑–∞–º–µ–Ω–∞ `AppealsService`)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å `PromotionsServiceDB` (–∑–∞–º–µ–Ω–∞ `PromotionsService`)
3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `bot.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `handlers.py`
5. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `response_monitor.py`

### –≠—Ç–∞–ø 4: –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (3-5 –¥–Ω–µ–π)

1. ‚úÖ –°–æ–∑–¥–∞—Ç—å React/Vue –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å Telegram WebApp SDK
3. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
4. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–∫—Ü–∏—è–º–∏
5. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫

### –≠—Ç–∞–ø 5: –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (1 –¥–µ–Ω—å)

1. ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
2. ‚úÖ –ò–º–ø–æ—Ä—Ç –≤ –ë–î
3. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
4. ‚úÖ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ø–ª–æ–π (2-3 –¥–Ω—è)

1. ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging
2. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤
3. ‚úÖ –î–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets

### –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π

```python
# migrate_appeals.py
import sqlite3
import gspread
from datetime import datetime

def migrate_appeals():
    # 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    # 2. –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
    # 3. –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
    # 4. –í—Å—Ç–∞–≤–∫–∞ –≤ –ë–î
    pass
```

### –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –∞–∫—Ü–∏–π

```python
# migrate_promotions.py
def migrate_promotions():
    # 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets
    # 2. –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ü–∏–π
    # 3. –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
    # 4. –í—Å—Ç–∞–≤–∫–∞ –≤ –ë–î
    pass
```

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –î–ª—è REST API

1. **JWT —Ç–æ–∫–µ–Ω—ã** –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤
2. **API –∫–ª—é—á–∏** –¥–ª—è –±–æ—Ç–∞
3. **Rate limiting** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
4. **CORS** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –î–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. **Telegram WebApp.initData** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏
2. **HTTPS** –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–µ—Ä–µ

## üìà –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù–µ—Ç –ª–∏–º–∏—Ç–æ–≤ Google Sheets API
2. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
3. ‚úÖ **–ì–∏–±–∫–æ—Å—Ç—å**: –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –¥–∞–Ω–Ω—ã–º–∏
4. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
5. ‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –õ–µ–≥–∫–æ –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∏ –æ—Ç—á–µ—Ç—ã
6. ‚úÖ **–û—Ñ–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ü–æ–ª–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

### –†–∏—Å–∫ 2: –ü—Ä–æ—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞

### –†–∏—Å–∫ 3: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ staging, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install fastapi uvicorn sqlalchemy alembic
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ë–î

```bash
alembic init alembic
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

### 3. –ó–∞–ø—É—Å–∫ API

```bash
uvicorn api.main:app --host 0.0.0.0 --port 8000
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Telegram WebApp SDK](https://core.telegram.org/bots/webapps)

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –í—ã–±—Ä–∞—Ç—å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫ (FastAPI + SQLite –∏–ª–∏ PostgreSQL)
2. –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
3. –ù–∞—á–∞—Ç—å —Å –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π
4. –ó–∞—Ç–µ–º –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–∫—Ü–∏–∏
5. –°–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

---

**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞**: 2026-01-05  
**–ê–≤—Ç–æ—Ä**: Migration Plan


================================================================================
FILE: ./docs/PLAN_IMPROVEMENTS.md
SIZE: 11311 bytes
================================================================================

# –ü–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–∫–∏ MarketingBot

## üöÄ **–ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø**

### **1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –±–æ—Ç–∞**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —á—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã Telegram API.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å PID —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å graceful shutdown –≤ bot.py
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞/–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º

**–ö–æ–¥ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
```python
# –í bot.py –¥–æ–±–∞–≤–∏—Ç—å
import os
import signal

def signal_handler(sig, frame):
    print('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...')
    os._exit(0)

signal.signal(signal.SIGINT, signal_handler)
signal.signal(signal.SIGTERM, signal_handler)

# Graceful shutdown
try:
    application.run_polling()
except KeyboardInterrupt:
    print("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    application.stop()
    application.shutdown()
```

**–°–∫—Ä–∏–ø—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```bash
#!/bin/bash
# start_bot.sh
pkill -f "python.*bot"
sleep 2
ps aux | grep python | grep bot
python3 bot.py
```

### **2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ª–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–∏—Å—Ç–µ–º—ã –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –æ—à–∏–±–∫–∏.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (JSON)
- [ ] –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –æ—à–∏–±–∫–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤
- [ ] –î–æ–±–∞–≤–∏—Ç—å fallback –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
- [ ] –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ Telegram API

### **4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ Google Sheets
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- [ ] –î–æ–±–∞–≤–∏—Ç—å rate limiting –¥–ª—è API

### **5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã.

**–†–µ—à–µ–Ω–∏–µ:**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rate limiting –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –£–ª—É—á—à–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø**

### **6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**
- [ ] –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª (config.yaml)
- [ ] –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å hot reload –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å environment-specific –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### **7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã
- [ ] –°–æ–∑–¥–∞—Ç—å integration —Ç–µ—Å—Ç—ã
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å E2E —Ç–µ—Å—Ç—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**
- [ ] –û–±–Ω–æ–≤–∏—Ç—å API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –°–æ–∑–¥–∞—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –°–æ–∑–¥–∞—Ç—å troubleshooting guide

### **9. CI/CD**
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å rollback –º–µ—Ö–∞–Ω–∏–∑–º
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ—è

### **10. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º—É –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å load balancing
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å distributed caching
- [ ] –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ

## üìä **–ú–ï–¢–†–ò–ö–ò –ò –ú–û–ù–ò–¢–û–†–ò–ù–ì**

### **11. –ê–Ω–∞–ª–∏—Ç–∏–∫–∞**
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### **12. –ê–ª–µ—Ä—Ç—ã**
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å health checks

## üéØ **–ü–†–ò–û–†–ò–¢–ï–¢–´**

### **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –±–æ—Ç–∞
2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
4. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
6. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### **–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
9. CI/CD
10. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## üõí **–°–ò–°–¢–ï–ú–ê –ó–ê–ö–ê–ó–û–í –ò –û–ü–õ–ê–¢–´**

### **üìä –≠—Ç–∞–ø 1: Google Sheets –¥–ª—è –∑–∞–∫–∞–∑–æ–≤**

#### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã "–ó–∞–∫–∞–∑—ã":**
```
A: ID –∑–∞–∫–∞–∑–∞ (–∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç)
B: –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è
C: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
D: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
E: –¢–µ–ª–µ—Ñ–æ–Ω
F: Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
G: –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥–∏
H: –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥–∏
I: –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
J: –ë—é–¥–∂–µ—Ç (–º–∏–Ω-–º–∞–∫—Å)
K: –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
L: –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
M: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
N: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä
O: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
P: –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
Q: –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ
R: –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
S: –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
T: –î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã
```

#### **–°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–∞:**
- `–ù–æ–≤—ã–π` - —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω
- `–í –æ–±—Ä–∞–±–æ—Ç–∫–µ` - –º–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞–∑–Ω–∞—á–µ–Ω
- `–û–±—Å—É–∂–¥–µ–Ω–∏–µ` - —É—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π
- `–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω` - –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞
- `–í —Ä–∞–±–æ—Ç–µ` - —É—Å–ª—É–≥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
- `–ì–æ—Ç–æ–≤–æ` - —É—Å–ª—É–≥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- `–û—Ç–º–µ–Ω–µ–Ω` - –∑–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω
- `–ó–∞–≤–µ—Ä—à–µ–Ω` - –æ–ø–ª–∞—á–µ–Ω –∏ –∑–∞–∫—Ä—ã—Ç

### **üí≥ –≠—Ç–∞–ø 2: –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã**

#### **–í–∞—Ä–∏–∞–Ω—Ç—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:**
1. **–ÆKassa (–Ø–Ω–¥–µ–∫—Å.–ö–∞—Å—Å–∞)** - –ø–æ–ø—É–ª—è—Ä–Ω–∞—è –≤ –†–æ—Å—Å–∏–∏
2. **Robokassa** - –ø—Ä–æ—Å—Ç–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
3. **Tinkoff Pay** - –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
4. **–°–ë–ü (–°–∏—Å—Ç–µ–º–∞ –±—ã—Å—Ç—Ä—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π)** - —á–µ—Ä–µ–∑ –±–∞–Ω–∫–∏

#### **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:**
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã (Visa, MasterCard, –ú–ò–†)
- –°–ë–ü (QR-–∫–æ–¥)
- –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥

### **üîß –≠—Ç–∞–ø 3: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è**

#### **–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:**
- `orders_service.py` - —Ä–∞–±–æ—Ç–∞ —Å –∑–∞–∫–∞–∑–∞–º–∏
- `payment_service.py` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- `order_form.html` - —Ñ–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞
- `order_status.html` - —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞

#### **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö:**
- `menu.html` - –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ "–ú–æ–∏ –∑–∞–∫–∞–∑—ã", "–°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑"
- `handlers.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–∫–∞–∑–æ–≤
- `sheets.py` - —Ä–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π –∑–∞–∫–∞–∑–æ–≤

### **üì± –≠—Ç–∞–ø 4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**

#### **–ù–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª—ã –≤ –º–µ–Ω—é:**
- **üìù –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑** - —Ñ–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ —É—Å–ª—É–≥
- **üìã –ú–æ–∏ –∑–∞–∫–∞–∑—ã** - —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **üí≥ –û–ø–ª–∞—Ç–∞** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–ø–ª–∞—Ç—ã
- **üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞** - —Å–≤—è–∑—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏

#### **–§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞:**
1. –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥–∏
2. –í—ã–±–æ—Ä –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏
3. –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
4. –ë—é–¥–∂–µ—Ç (–¥–∏–∞–ø–∞–∑–æ–Ω)
5. –°—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
6. –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
7. –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### **‚öôÔ∏è –≠—Ç–∞–ø 5: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å**

#### **–§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏

#### **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
- –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä—É
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ ‚Üí –∫–ª–∏–µ–Ω—Ç—É
- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä—É
- –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ ‚Üí –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

### **üìà –≠—Ç–∞–ø 6: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã**

#### **–ú–µ—Ç—Ä–∏–∫–∏:**
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
- –ö–æ–Ω–≤–µ—Ä—Å–∏—è –∑–∞–∫–∞–∑–æ–≤ –≤ –æ–ø–ª–∞—Ç—É
- –°—Ä–µ–¥–Ω–∏–π —á–µ–∫
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —É—Å–ª—É–≥–∏

#### **–û—Ç—á–µ—Ç—ã:**
- –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ/–º–µ—Å—è—á–Ω—ã–µ –æ—Ç—á–µ—Ç—ã
- –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å
- –ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤

### **üîí –≠—Ç–∞–ø 7: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**

#### **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ó–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (152-–§–ó)
- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π (PCI DSS)
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **‚è±Ô∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞–º–∫–∏ —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫–∞–∑–æ–≤:**
- **–≠—Ç–∞–ø 1-2:** 2-3 –Ω–µ–¥–µ–ª–∏
- **–≠—Ç–∞–ø 3-4:** 3-4 –Ω–µ–¥–µ–ª–∏  
- **–≠—Ç–∞–ø 5-6:** 2-3 –Ω–µ–¥–µ–ª–∏
- **–≠—Ç–∞–ø 7:** 1-2 –Ω–µ–¥–µ–ª–∏

## üìù **–ó–ê–ú–ï–¢–ö–ò**

- –í—Å–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏
- –í–∞–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç–æ—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤ - –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Ü–µ–ª—å —Ä–∞–∑–≤–∏—Ç–∏—è

---
*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-10-09*
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-10-10*


================================================================================
FILE: ./docs/PROJECT_AUDIT.md
SIZE: 6021 bytes
================================================================================

# üïµÔ∏è‚Äç‚ôÇÔ∏è –û—Ç—á–µ—Ç –ø–æ –ê—É–¥–∏—Ç—É –ü—Ä–æ–µ–∫—Ç–∞ MarketingBot

**–î–∞—Ç–∞:** 20 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å:** –ß–µ—Ä–Ω–æ–≤–∏–∫
**–ê—É–¥–∏—Ç–æ—Ä:** Antigravity (Lead Developer)

---

## 1. –û–±—â–µ–µ –†–µ–∑—é–º–µ (Executive Summary)

–ü—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π MVP –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Google Sheets –∏ OpenAI. –ö–æ–¥–æ–≤–∞—è –±–∞–∑–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –Ω–∞ Python (python-telegram-bot) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞ Service Layer.

**–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:**
*   ‚úÖ **–ö–æ–¥:** –ß–∏—Å—Ç—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è.
*   ‚úÖ **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã (`Auth`, `Appeals`, `OpenAI`) –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≥—Ä–∞–º–æ—Ç–Ω–æ.
*   ‚ö†Ô∏è **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ WebApp:** –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –æ—à–∏–±–∫–∞** –≤ –º–µ—Ö–∞–Ω–∏–∑–º–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è WebApp.
*   ‚ö†Ô∏è **UI/UX:** –î–∏–∑–∞–π–Ω WebApp –±–∞–∑–æ–≤—ã–π, –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—è–≤–ª–µ–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é "Premium".

---

## 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ê—É–¥–∏—Ç (Technical Audit)

### 2.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ Backend
*   **–¢–∏–ø:** –ì–∏–±—Ä–∏–¥–Ω—ã–π (Polling –¥–ª—è –±–æ—Ç–∞ + Flask –¥–ª—è –≤–µ–±—Ö—É–∫–æ–≤ Google Sheets).
*   **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** Google Sheets. –≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (—á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `auth_service`).
*   **–ü—Ä–æ–±–ª–µ–º–∞ —Å WebApp (CRITICAL):**
    *   –í `menu.html` (—Å—Ç—Ä–æ–∫–∏ 830-877) —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `tg.sendData`.
    *   **–°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:** `sendData` ‚Äî —ç—Ç–æ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –∫–∞–Ω–∞–ª (WebApp -> Bot). –ë–æ—Ç **–Ω–µ –º–æ–∂–µ—Ç** –≤–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ –≤ –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ WebApp.
    *   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** WebApp –≤—Å–µ–≥–¥–∞ –ø–∞–¥–∞–µ—Ç –≤ —Ç–∞–π–º–∞—É—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–∑–∞–≥–ª—É—à–∫—É" (—Ñ–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ), —Ä–µ–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è.
    *   **–†–µ—à–µ–Ω–∏–µ:** –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å REST API (`GET /api/promotions`) –Ω–∞ –±–∞–∑–µ Flask —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –Ω–µ–º—É –∏–∑ WebApp —á–µ—Ä–µ–∑ `fetch()`.

### 2.2. Frontend (WebApp)
*   **–°—Ç–µ–∫:** Vanilla HTML/CSS/JS.
*   **–°—Ç—Ä—É–∫—Ç—É—Ä–∞:** SPA (Single Page Application) –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ `menu.html`.
*   **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –•–æ—Ä–æ—à–∞—è, —Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç —Ç—è–∂–µ–ª—ã—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤.
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è `initData` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö (—Ç–∞–∫ –∫–∞–∫ –Ω–µ—Ç API).

### 2.3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
*   **OpenAI:** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–µ—Ä–µ–∑ Assistants API.
*   **Google Sheets:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `gspread`. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## 3. UI/UX –ê—É–¥–∏—Ç (Visual Audit)

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
*   –î–∏–∑–∞–π–Ω —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ Telegram.
*   –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –∏ "–ø—Ä–µ–º–∏–∞–ª—å–Ω–æ—Å—Ç—å".
*   –ê–Ω–∏–º–∞—Ü–∏–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã (—Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã).

### –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ Redesign (Premium Style)
1.  **Glassmorphism:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –ø–ª–∞—à–∫–∏ —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º —Ñ–æ–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥–ª—É–±–∏–Ω—ã.
2.  **–¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞:** –ì–ª—É–±–æ–∫–∏–µ —Ç–µ–º–Ω—ã–µ —Ç–æ–Ω–∞ (Dark Mode) —Å —è—Ä–∫–∏–º–∏ –∞–∫—Ü–µ–Ω—Ç–Ω—ã–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π/–Ω–µ–æ–Ω–æ–≤—ã–π).
3.  **–¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞:** –ó–∞–º–µ–Ω–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ (Inter –∏–ª–∏ Manrope).
4.  **–ú–∏–∫—Ä–æ–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è:** –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏, –∑–∞–≥—Ä—É–∑–∫–µ (Skeleton loaders –≤–º–µ—Å—Ç–æ —Å–ø–∏–Ω–Ω–µ—Ä–æ–≤), –ø–æ—è–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤.

---

## 4. –ü–ª–∞–Ω –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (Roadmap)

–î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–µ–π –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

### üöë –≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Priority: Critical)
1.  **–°–æ–∑–¥–∞—Ç—å API Layer:**
    *   –†–∞—Å—à–∏—Ä–∏—Ç—å `webhook_handler.py` (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å `api_server.py`).
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:
        *   `GET /api/promotions` (–ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ü–∏–π).
        *   `GET /api/user` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏).
2.  **–ò—Å–ø—Ä–∞–≤–∏—Ç—å WebApp:**
    *   –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ª–æ–≥–∏–∫—É `loadPromotions` –≤ `menu.html` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `fetch` –∫ –Ω–∞—à–µ–º—É API.
    *   –£–±—Ä–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º `sendData` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

### üé® –≠—Ç–∞–ø 2: Premium Redesign (Priority: High)
1.  –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ–≤—É—é –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É (CSS Variables).
2.  –í–Ω–µ–¥—Ä–∏—Ç—å Glassmorphism –∏ –Ω–æ–≤—ã–µ UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.
3.  –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã.

### üöÄ –≠—Ç–∞–ø 3: –†–∞–∑–≤–∏—Ç–∏–µ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ (Priority: Medium)
1.  –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" –∏ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞".
2.  –£–ª—É—á—à–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

---

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è "WebApp ‚Äî –°–µ—Ä–≤–µ—Ä" –ø–µ—Ä–µ–¥ —Ç–µ–º, –∫–∞–∫ –ø—Ä–∏—Å—Ç—É–ø–∞—Ç—å –∫ –≤–∏–∑—É–∞–ª—å–Ω—ã–º —É–ª—É—á—à–µ–Ω–∏—è–º.


================================================================================
FILE: ./docs/PROJECT_RULES.md
SIZE: 3642 bytes
================================================================================

# üìú –ü—Ä–∞–≤–∏–ª–∞ –∏ –†–æ–ª–∏ –ü—Ä–æ–µ–∫—Ç–∞ MarketingBot

## üé≠ –†–æ–ª–∏ AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (Antigravity)

1.  **Lead Developer (–í—ã–¥–∞—é—â–∏–π—Å—è –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç):**
    *   –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è.
    *   –ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–µ—à–µ–Ω–∏–π.
    *   –¶–µ–ª—å: –°–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—ã–π, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã–π –ø—Ä–æ–¥—É–∫—Ç.

2.  **UX/UI Architect (–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –û–ø—ã—Ç–∞):**
    *   –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏.
    *   –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç—É–∏—Ç–∏–≤–Ω–æ –ø–æ–Ω—è—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.

3.  **Web Designer (–í–µ–±-–¥–∏–∑–∞–π–Ω–µ—Ä):**
    *   –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (WebApp).
    *   –°–æ–∑–¥–∞–Ω–∏–µ "Premium" –¥–∏–∑–∞–π–Ω–∞ (—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π, —ç—Å—Ç–µ—Ç–∏—á–Ω—ã–π, "wow-—ç—Ñ—Ñ–µ–∫—Ç").

4.  **Graphic Designer (–ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –î–∏–∑–∞–π–Ω–µ—Ä):**
    *   –†–∞–±–æ—Ç–∞ —Å –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏, –±–∞–Ω–Ω–µ—Ä–∞–º–∏ –∏ –º–µ–¥–∏–∞-–∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.

---

## üìã –§–æ—Ä–º–∞—Ç –†–∞–±–æ—Ç—ã –∏ –ü—Ä–∞–≤–∏–ª–∞

### 1. –û–±—â–∏–µ –ü—Ä–∏–Ω—Ü–∏–ø—ã
*   **–Ø–∑—ã–∫:** –û–±—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –Ω–∞ **–†—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ**.
*   **–°—Ç–∏–ª—å:** –ö—Ä–∞—Ç–∫–æ, —á–µ—Ç–∫–æ, –ø–æ –¥–µ–ª—É. –ë–µ–∑ –ª–∏—à–Ω–µ–π "–≤–æ–¥—ã".
*   **–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–µ–º–∏—É–º –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç –∑–∞ **3 –Ω–µ–¥–µ–ª–∏**.

### 2. –ê–ª–≥–æ—Ä–∏—Ç–º –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ó–∞–¥–∞—á
1.  **–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏:** –í—ã –æ–ø–∏—Å—ã–≤–∞–µ—Ç–µ —Ü–µ–ª—å –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É.
2.  **–ê–Ω–∞–ª–∏–∑ (Research):** –Ø –∏–∑—É—á–∞—é —Ç–µ–∫—É—â–∏–π –∫–æ–¥, —Ñ–∞–π–ª—ã –∏ –∏—â—É –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
3.  **–ü–ª–∞–Ω (Planning):** –Ø –ø—Ä–µ–¥–ª–∞–≥–∞—é –∫—Ä–∞—Ç–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π (—á–µ–∫-–ª–∏—Å—Ç).
4.  **–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (Execution):** –Ø —Ä–µ–∞–ª–∏–∑—É—é –ø–ª–∞–Ω –∞–≤—Ç–æ–Ω–æ–º–Ω–æ (–Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É –∫–æ–¥–∞, –Ω–æ —Å–ª–µ–¥—É—è —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–º—É –≤–µ–∫—Ç–æ—Ä—É).
5.  **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è (Quality Control):**
    *   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ `ruff check .` –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π.
    *   –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é —Ñ–∞–π–ª–æ–≤.

### 3. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
*   **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å:** –õ—é–±–æ–π –º–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –æ—Ç–∫–ª—é—á–∞—Ç—å—Å—è/–ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é, –Ω–µ –ª–æ–º–∞—è —è–¥—Ä–æ.
*   **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:** –°–Ω–∞—á–∞–ª–∞ **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**, –∑–∞—Ç–µ–º **–í–∏–∑—É–∞–ª**.
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –ù–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª.

### 4. –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ
*   **–ê–≤—Ç–æ–Ω–æ–º–Ω–æ—Å—Ç—å:** –Ø –¥–µ–π—Å—Ç–≤—É—é –∫–∞–∫ –ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π –ø–∞—Ä—Ç–Ω–µ—Ä, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å. –ü—Ä–µ–¥–ª–∞–≥–∞—é —Ä–µ—à–µ–Ω–∏—è, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∂–¥—É –∫–æ–º–∞–Ω–¥.
*   **–†–µ–≤—å—é:** –í—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –º–æ–π –∫–æ–¥ –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫, —Ç—Ä–µ–±—É—é—â–∏–π –≤–∞—à–µ–≥–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–∑–≥–ª—è–¥–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ).

---
*–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –º–æ–∂–µ—Ç –¥–æ–ø–æ–ª–Ω—è—Ç—å—Å—è.*


================================================================================
FILE: ./docs/README.md
SIZE: 4330 bytes
================================================================================

# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è MarketingBot

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é MarketingBot ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ Telegram-–±–æ—Ç–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ —Å –≤–µ–±-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Google Sheets.

## üìñ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

### üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](getting-started/INSTALLATION.md) ‚Äî –ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ
- [–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script](getting-started/QUICK_START_GOOGLE_APPS_SCRIPT.md) ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API –¥–ª—è –∞–∫—Ü–∏–π

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –¥–∏–∑–∞–π–Ω
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](ARCHITECTURE.md) ‚Äî –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
- [–ü–ª–∞–Ω –¥–∏–∑–∞–π–Ω–∞](DESIGN_PLAN.md) ‚Äî –î–∏–∑–∞–π–Ω-–¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–æ–µ–∫—Ç–∞
- [–§—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã](FEATURES.md) ‚Äî –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π

### üö¢ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Yandex Cloud](deployment/DEPLOYMENT_YANDEX.md) ‚Äî –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ
- [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ PythonAnywhere](deployment/DEPLOYMENT_PYTHONANYWHERE.md) ‚Äî –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è](DEPLOYMENT_ARCHITECTURE.md) ‚Äî –î–µ—Ç–∞–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

### üîß –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets](guides/GOOGLE_SHEETS.md) ‚Äî –†–∞–±–æ—Ç–∞ —Å Google Sheets
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script](guides/GOOGLE_APPS_SCRIPT_SETUP.md) ‚Äî API –¥–ª—è –∞–∫—Ü–∏–π
- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](DATABASE_SETUP.md) ‚Äî –†–∞–±–æ—Ç–∞ —Å SQLite
- [–ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö](MIGRATION_TO_DATABASE.md) ‚Äî –ü–µ—Ä–µ—Ö–æ–¥ —Å Google Sheets

### üì° API –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ API](reference/API_REFERENCE.md) ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è REST API
- [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Sheets](guides/GOOGLE_SHEETS.md) ‚Äî –î–µ—Ç–∞–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- [–û–±—â–µ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫](troubleshooting/TROUBLESHOOTING.md) ‚Äî –†–µ—à–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
- [–ü—Ä–æ–±–ª–µ–º—ã —Å –∞–∫—Ü–∏—è–º–∏](troubleshooting/PROMOTIONS_ISSUES.md) ‚Äî –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∞–∫—Ü–∏—è–º–∏
- [–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º](troubleshooting/DEPLOYMENT_ISSUES.md) ‚Äî –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](SECURITY.md) ‚Äî –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é](TESTING.md) ‚Äî –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

### üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- [Changelog](CHANGELOG.md) ‚Äî –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ–µ–∫—Ç–∞

## üó∫Ô∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
1. –ù–∞—á–Ω–∏—Ç–µ —Å [–£—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏](getting-started/INSTALLATION.md)
2. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã](ARCHITECTURE.md)
3. –ò–∑—É—á–∏—Ç–µ [–§—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã](FEATURES.md)

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](ARCHITECTURE.md)
2. [–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ API](reference/API_REFERENCE.md)
3. [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é](TESTING.md)

### –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
1. [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Yandex Cloud](deployment/DEPLOYMENT_YANDEX.md)
2. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Tunnel](deployment/CLOUDFLARE_TUNNEL_SETUP.md)
3. [–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](troubleshooting/TROUBLESHOOTING.md)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤—ã —Å—Ç–æ–ª–∫–Ω—É–ª–∏—Å—å —Å –ø—Ä–æ–±–ª–µ–º–æ–π, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –æ–ø–∏—Å–∞–Ω–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫](troubleshooting/TROUBLESHOOTING.md)
2. –ò–∑—É—á–∏—Ç–µ [Changelog](CHANGELOG.md) –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
3. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞


================================================================================
FILE: ./docs/REORGANIZATION_SUMMARY.md
SIZE: 5398 bytes
================================================================================

# –û—Ç—á–µ—Ç –æ —Ä–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

**–î–∞—Ç–∞:** 2026-01-07  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–°–æ–∑–¥–∞–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –∏–Ω–¥—É—Å—Ç—Ä–∏–∏:

```
docs/
‚îú‚îÄ‚îÄ README.md                    # –ì–ª–∞–≤–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ getting-started/             # –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
‚îÇ   ‚îú‚îÄ‚îÄ INSTALLATION.md
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_START_GOOGLE_APPS_SCRIPT.md
‚îÇ   ‚îú‚îÄ‚îÄ QUICK_START_CLOUDFLARE.md
‚îÇ   ‚îî‚îÄ‚îÄ SIMPLE_SETUP.md
‚îú‚îÄ‚îÄ deployment/                  # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT_YANDEX.md
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT_PYTHONANYWHERE.md
‚îÇ   ‚îî‚îÄ‚îÄ CLOUDFLARE_TUNNEL_SETUP.md
‚îú‚îÄ‚îÄ guides/                      # –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞
‚îÇ   ‚îú‚îÄ‚îÄ GOOGLE_APPS_SCRIPT_SETUP.md
‚îÇ   ‚îî‚îÄ‚îÄ GOOGLE_SHEETS.md
‚îú‚îÄ‚îÄ troubleshooting/             # –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
‚îÇ   ‚îú‚îÄ‚îÄ TROUBLESHOOTING.md
‚îÇ   ‚îú‚îÄ‚îÄ PROMOTIONS_ISSUES.md
‚îÇ   ‚îî‚îÄ‚îÄ DEPLOYMENT_ISSUES.md
‚îú‚îÄ‚îÄ reference/                   # –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
‚îÇ   ‚îî‚îÄ‚îÄ API_REFERENCE.md
‚îî‚îÄ‚îÄ [–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã]         # ARCHITECTURE.md, FEATURES.md, etc.
```

### 2. –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

- **–ü—Ä–æ–±–ª–µ–º—ã —Å –∞–∫—Ü–∏—è–º–∏:** –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã `–†–ï–®–ï–ù–ò–ï_–ü–†–û–ë–õ–ï–ú–´_–ê–ö–¶–ò–ô.md`, `DEBUG_PROMOTIONS.md`, `FIX_GOOGLE_APPS_SCRIPT.md` ‚Üí `docs/troubleshooting/PROMOTIONS_ISSUES.md`
- **–ü—Ä–æ–±–ª–µ–º—ã —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:** –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã `FIX_DNS_ISSUE.md`, `FIX_CLOUDFLARE_TUNNEL.md`, `FIX_WEBAPP_URL.md` ‚Üí `docs/troubleshooting/DEPLOYMENT_ISSUES.md`
- **–ü—Ä–æ–≤–µ—Ä–∫–∏:** –û–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤—Å–µ `CHECK_*`, `–ü–†–û–í–ï–†–ö–ê_*`, `–ò–¢–û–ì–û–í–ê–Ø_–ü–†–û–í–ï–†–ö–ê*` —Ñ–∞–π–ª—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã

### 3. –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

–£–¥–∞–ª–µ–Ω—ã/–ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `FIX_*.md` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
- `CHECK_*.md` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
- `DEBUG_*.md` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—Ç–ª–∞–¥–∫–∏
- `FINAL_*.md` - –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å–Ω—ã–µ —Ñ–∞–π–ª—ã
- `*_–ü–†–û–í–ï–†–ö–ê*.md` - –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏
- `APPLIED_FIXES_SUMMARY.md` - —É—Å—Ç–∞—Ä–µ–≤—à–∞—è —Å–≤–æ–¥–∫–∞
- `DEPLOY_FIXES.md` - —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- `menu_old.html` - —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞
- `*.log` - –ª–æ–≥–∏ (–¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ .gitignore)

### 4. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤

–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ `scripts/`:

```
scripts/
‚îú‚îÄ‚îÄ README.md                    # –û–ø–∏—Å–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤
‚îú‚îÄ‚îÄ deploy_yandex.sh             # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Yandex
‚îú‚îÄ‚îÄ setup_yandex_systemd.sh      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd
‚îú‚îÄ‚îÄ start_yandex_services.sh     # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
‚îú‚îÄ‚îÄ update_yandex_server.sh      # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞
‚îú‚îÄ‚îÄ ssh_yandex.sh                # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
‚îú‚îÄ‚îÄ install_cloudflare_tunnel.sh # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
‚îú‚îÄ‚îÄ setup_cloudflare_tunnel*.sh  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
‚îú‚îÄ‚îÄ start_bot_pythonanywhere.sh  # –ó–∞–ø—É—Å–∫ –Ω–∞ PythonAnywhere
‚îú‚îÄ‚îÄ update_bot_pythonanywhere.sh # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ PythonAnywhere
‚îî‚îÄ‚îÄ update_*.py                  # –£—Ç–∏–ª–∏—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
```

### 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .gitignore

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
- `FIX_*.md`
- `CHECK_*.md`
- `DEBUG_*.md`
- `FINAL_*.md`
- `*_–ü–†–û–í–ï–†–ö–ê*.md`
- –ò –¥—Ä—É–≥–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ README.md

- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –£–ª—É—á—à–µ–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∞** –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º  
‚úÖ **–î—É–±–ª–∏–∫–∞—Ç—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã** –∏ —É–¥–∞–ª–µ–Ω—ã  
‚úÖ **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã** –∏–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã  
‚úÖ **–°–∫—Ä–∏–ø—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω—ã** –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é  
‚úÖ **README –æ–±–Ω–æ–≤–ª–µ–Ω** —Å –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π  
‚úÖ **.gitignore –æ–±–Ω–æ–≤–ª–µ–Ω** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–º–º–∏—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

## –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–°–æ–∑–¥–∞–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π:** 5 (getting-started, deployment, guides, troubleshooting, reference)
- **–ü–µ—Ä–µ–º–µ—â–µ–Ω–æ —Ñ–∞–π–ª–æ–≤:** ~30
- **–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** ~15
- **–£–¥–∞–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:** ~20
- **–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–≤:** 12

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
2. –û–±–Ω–æ–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –≤ –∫–æ–¥–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
4. –û–±–Ω–æ–≤–∏—Ç—å CI/CD (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)


================================================================================
FILE: ./docs/SECURITY.md
SIZE: 1219 bytes
================================================================================

# SECURITY

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—é —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–°–≤—è–∂–∏—Ç–µ—Å—å —Å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∫–∞–Ω–∞–ª–∞–º. –î–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ ‚Äî email security@company.example.

–ï—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é —É—è–∑–≤–∏–º–æ—Å—Ç—å, —Å—Ä–∞–∑—É —Å–æ–æ–±—â–∏—Ç–µ –ø–æ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É –∫–∞–Ω–∞–ª—É –∏ –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω–æ.

## –°–µ–∫—Ä–µ—Ç—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ `credentials.json` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
- –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Google Sheets –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  - `GCP_SA_JSON` (—Å—Ç—Ä–æ–∫–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ service account JSON) –∏–ª–∏ `GCP_SA_FILE` (–ø—É—Ç—å –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ/—Å–µ—Ä–≤–µ—Ä–µ)
  - `SHEET_ID` –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ `SHEET_NAME`
- –¢–æ–∫–µ–Ω –±–æ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `TELEGRAM_TOKEN`.
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ, —á—Ç–æ `.gitignore` –∏—Å–∫–ª—é—á–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã (—Å–º. –∫–æ—Ä–Ω–µ–≤–æ–π `.gitignore`).


================================================================================
FILE: ./docs/TESTING.md
SIZE: 11929 bytes
================================================================================

# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MarketingBot v3.1

## –û–±–∑–æ—Ä —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

MarketingBot v3.1 –≤–∫–ª—é—á–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:
- **Unit tests**: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–æ–¥—É–ª–µ–π
- **Integration tests**: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **E2E tests**: —Å–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- **Manual tests**: —Ä—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

## –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è v3.1

### 1. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏

```python
# test_escalation.py
import pytest
from handlers import _is_user_escalation_request

def test_escalation_detection():
    """–¢–µ—Å—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Å–∫–∞–ª–∞—Ü–∏–∏"""
    
    # –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
    escalation_phrases = [
        "–∞ –≤—ã –º–Ω–µ –ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ?",
        "–Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–º–æ—á—å",
        "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω—É–∂–µ–Ω",
        "–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", 
        "—á–µ–ª–æ–≤–µ–∫ –Ω—É–∂–µ–Ω",
        "–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫ –Ω—É–∂–µ–Ω",
        "—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —á–µ–ª–æ–≤–µ–∫–æ–º",
        "–ø–æ–∑–≤–æ–Ω–∏—Ç—å —Ö–æ—á—É",
        "–ø—Ä–æ–±–ª–µ–º–∞ —É –º–µ–Ω—è",
        "–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è",
        "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç",
        "—Å–ª–æ–∂–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è",
        "–Ω–µ –ø–æ–Ω–∏–º–∞—é",
        "–æ–±—ä—è—Å–Ω–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ"
    ]
    
    for phrase in escalation_phrases:
        assert _is_user_escalation_request(phrase), f"–§—Ä–∞–∑–∞ '{phrase}' –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∫–∞–∫ —ç—Å–∫–∞–ª–∞—Ü–∏—è"
    
    # –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
    normal_phrases = [
        "–ø—Ä–∏–≤–µ—Ç",
        "–∫–∞–∫ –¥–µ–ª–∞",
        "—Å–ø–∞—Å–∏–±–æ",
        "–≤–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É",
        "—Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –ø—Ä–æ–¥—É–∫—Ç–µ"
    ]
    
    for phrase in normal_phrases:
        assert not _is_user_escalation_request(phrase), f"–§—Ä–∞–∑–∞ '{phrase}' –ù–ï –¥–æ–ª–∂–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å—Å—è –∫–∞–∫ —ç—Å–∫–∞–ª–∞—Ü–∏—è"

def test_escalation_case_insensitive():
    """–¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"""
    assert _is_user_escalation_request("–°–ü–ï–¶–ò–ê–õ–ò–°–¢ –ù–£–ñ–ï–ù")
    assert _is_user_escalation_request("–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ù—É–∂–µ–Ω")
    assert _is_user_escalation_request("—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω—É–∂–µ–Ω")
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

```python
# test_status_updates.py
import pytest
from appeals_service import AppealsService
from unittest.mock import Mock, patch

def test_status_update_to_in_work():
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ '–≤ —Ä–∞–±–æ—Ç–µ'"""
    appeals_service = AppealsService()
    
    with patch.object(appeals_service, 'set_status_in_work') as mock_set_status:
        mock_set_status.return_value = True
        
        result = appeals_service.set_status_in_work(123456789)
        
        assert result is True
        mock_set_status.assert_called_once_with(123456789)

def test_status_update_to_resolved():
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ '—Ä–µ—à–µ–Ω–æ'"""
    appeals_service = AppealsService()
    
    with patch.object(appeals_service.worksheet, 'batch_update') as mock_batch:
        mock_batch.return_value = {}
        
        # –°–∏–º—É–ª—è—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        appeals_service.worksheet.batch_update([{
            'range': 'F3',
            'values': [['—Ä–µ—à–µ–Ω–æ']]
        }])
        
        mock_batch.assert_called_once()

def test_background_color_removal():
    """–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è –∫—Ä–∞—Å–Ω–æ–π –∑–∞–ª–∏–≤–∫–∏"""
    appeals_service = AppealsService()
    
    with patch.object(appeals_service.worksheet, 'format') as mock_format:
        # –°–∏–º—É–ª—è—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ª–∏–≤–∫–∏
        appeals_service.worksheet.format('F3', {
            "backgroundColor": {
                "red": 1.0,
                "green": 1.0, 
                "blue": 1.0
            }
        })
        
        mock_format.assert_called_once()
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebApp URL –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```python
# test_webapp_urls.py
import pytest
from handlers import get_web_app_url, get_spa_menu_url
from unittest.mock import patch

def test_webapp_url_generation():
    """–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL –¥–ª—è WebApp"""
    
    with patch.dict('os.environ', {'WEB_APP_URL': 'https://example.com'}):
        auth_url = get_web_app_url()
        menu_url = get_spa_menu_url()
        
        assert auth_url == 'https://example.com/'
        assert menu_url == 'https://example.com/menu.html'

def test_webapp_url_without_trailing_slash():
    """–¢–µ—Å—Ç URL –±–µ–∑ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª–µ—à–∞"""
    
    with patch.dict('os.environ', {'WEB_APP_URL': 'https://example.com'}):
        auth_url = get_web_app_url()
        menu_url = get_spa_menu_url()
        
        assert auth_url == 'https://example.com/'
        assert menu_url == 'https://example.com/menu.html'

def test_webapp_url_with_trailing_slash():
    """–¢–µ—Å—Ç URL —Å –∑–∞–≤–µ—Ä—à–∞—é—â–∏–º —Å–ª–µ—à–µ–º"""
    
    with patch.dict('os.environ', {'WEB_APP_URL': 'https://example.com/'}):
        auth_url = get_web_app_url()
        menu_url = get_spa_menu_url()
        
        assert auth_url == 'https://example.com/'
        assert menu_url == 'https://example.com/menu.html'
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ResponseMonitor

```python
# test_response_monitor.py
import pytest
from response_monitor import ResponseMonitor
from unittest.mock import Mock, patch, AsyncMock

@pytest.mark.asyncio
async def test_response_sending():
    """–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤"""
    
    mock_bot = Mock()
    mock_appeals_service = Mock()
    mock_appeals_service.check_for_responses.return_value = [
        {
            'row': 3,
            'telegram_id': '123456789',
            'response': '–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
            'code': '111098',
            'fio': '–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
        }
    ]
    
    monitor = ResponseMonitor(mock_bot, mock_appeals_service)
    
    with patch.object(monitor, '_send_response', new_callable=AsyncMock) as mock_send:
        await monitor.check_responses()
        
        mock_send.assert_called_once()

@pytest.mark.asyncio
async def test_status_update_after_response():
    """–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞"""
    
    mock_bot = Mock()
    mock_appeals_service = Mock()
    mock_appeals_service.worksheet = Mock()
    
    monitor = ResponseMonitor(mock_bot, mock_appeals_service)
    
    response_data = {
        'row': 3,
        'telegram_id': '123456789',
        'response': '–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞'
    }
    
    with patch.object(monitor.appeals_service.worksheet, 'batch_update') as mock_batch:
        with patch.object(monitor.appeals_service.worksheet, 'format') as mock_format:
            await monitor._send_response(response_data)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
            mock_batch.assert_called()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ª–∏–≤–∫–∏
            mock_format.assert_called()
```

## –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏

```bash
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 bot.py

# –í Telegram –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
# "–∞ –≤—ã –º–Ω–µ –ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ?" - –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏—è
# "–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç" - –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏—è  
# "–ø—Ä–∏–≤–µ—Ç" - –ù–ï –¥–æ–ª–∂–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Å–∫–∞–ª–∞—Ü–∏—è
```

### 2. –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
# 2. –í Google Sheets –¥–æ–±–∞–≤—å—Ç–µ –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –≤ –∫–æ–ª–æ–Ω–∫—É G
# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
#    - –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏–ª—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
#    - –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ "—Ä–µ—à–µ–Ω–æ"
#    - –ö—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞ —É–¥–∞–ª–∏–ª–∞—Å—å
```

### 3. –¢–µ—Å—Ç WebApp –∫–Ω–æ–ø–æ–∫

```bash
# 1. –ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —á–µ—Ä–µ–∑ WebApp
# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–ú–µ–Ω—é" (–Ω–µ "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è")
# 3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é
# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è menu.html
```

## –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
pip install pytest pytest-asyncio

# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
pytest test_escalation.py

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
pytest -v

# –ó–∞–ø—É—Å–∫ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=.
```

## CI/CD —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
    - name: Run tests
      run: pytest
```

## –û—Ç—á–µ—Ç—ã –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞
pytest --html=report.html --self-contained-html

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è XML –æ—Ç—á–µ—Ç–∞ –¥–ª—è CI
pytest --junitxml=report.xml

# –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
pytest --cov=. --cov-report=html
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–µ—Å—Ç–æ–≤

```bash
# –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
pytest-watch

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º
pytest --profile

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
pytest --benchmark-only
```

Local helper scripts

There are three helper scripts in `scripts/` to help testing the WebApp auth flow locally:

- `scripts/generate_initdata.py` ‚Äî generate a signed Telegram WebApp `initData` (HMAC using SHA256(bot_token)).
- `scripts/test_auth_via_bot.py` ‚Äî convenience script that generates `initData` and POSTs to `http://127.0.0.1:8000/api/webapp/auth`.
- `scripts/send_webapp_button.py` ‚Äî sends an inline keyboard with a Web App button to a chat (requires `BOT_TOKEN` env var).

Examples:

```
# generate initData
python scripts/generate_initdata.py --bot-token $BOT_TOKEN --user-id 123456

# run local test (will POST to local server)
export BOT_TOKEN=...
python scripts/test_auth_via_bot.py --user-id 123456 --partner-code 111098 --phone "+7 982 770-1055"

# send webapp button (after running ngrok and replacing URL)
python scripts/send_webapp_button.py --chat-id 123456 --url https://abcd-12.ngrok.io/webapp/index.html
```

Note: these helpers require `requests` installed in your virtualenv.

Ngrok & webhook notes

If you want Telegram to open your local Web App and forward `initData` automatically, expose your local server with ngrok:

```
.venv312/bin/uvicorn app.main:app --reload --port 8000
ngrok http 8000
```

Then set the webhook (optional) or send an inline Web App button that points to the ngrok URL. You can set webhook with:

```
export BOT_TOKEN=...
python scripts/setup_webhook.py --url https://abcd-12.ngrok.io/
```

Or send a button directly (no webhook needed) using `scripts/send_webapp_button.py`.

Restart script note

The `scripts/restart_bot.sh` script now checks for `TELEGRAM_BOT_TOKEN` (used by the app) and will warn if it's missing. Ensure your `.env` or environment uses that variable name.


================================================================================
FILE: ./docs/tools/debug_telegram_auth.js
SIZE: 1299 bytes
================================================================================

// Debug script for Telegram Mini App authorization issues
// This script can be used with Context7 MCP to get accurate documentation

console.log("=== Telegram Mini App Authorization Debug Script ===");

// Simulate the data flow for debugging
const userId = "284355186"; // Example user ID
const partnerCode = "111098"; // Example partner code
const partnerPhone = "+7 (910) 123-45-55"; // Example phone

console.log("User ID:", userId);
console.log("Partner Code:", partnerCode);
console.log("Partner Phone:", partnerPhone);

// Simulate WebApp data
const webAppData = {
  partner_code: partnerCode,
  partner_phone: partnerPhone
};

console.log("WebApp Data:", JSON.stringify(webAppData));

// Simulate the sendData function
function simulateSendData() {
  console.log("Sending data via Telegram WebApp API...");
  console.log("Data sent:", JSON.stringify(webAppData));
  
  // This is where the issue might occur
  console.log("Checking if bot receives the data...");
  console.log("If bot doesn't receive data, possible causes:");
  console.log("1. Incorrect filter in bot handler");
  console.log("2. Network issues");
  console.log("3. Telegram WebApp API version compatibility");
  console.log("4. URL configuration issues");
}

simulateSendData();

console.log("=== End Debug Script ===");

================================================================================
FILE: ./docs/tools/fetch_sheets.py
SIZE: 3018 bytes
================================================================================

"""Safe helper to download and summarize Google Sheets referenced in the repo's env file.

Usage (locally):
  1. Put your Google service account JSON in the repo root as `credentials.json` (DO NOT commit it).
  2. Install dependencies: pip install -r scripts/requirements.txt
  3. Run: python scripts/fetch_sheets.py --sheet-url "<SHEET_URL>" --out summary.json

The script prints a short summary (sheet titles, number of worksheets, rows/cols counts and a small preview of each worksheet).
It does not modify any remote data.
"""
from __future__ import annotations

import argparse
import json
import os
import re
from typing import Any, Dict

import gspread
from google.oauth2.service_account import Credentials


def extract_spreadsheet_id(url: str) -> str:
    # Extracts spreadsheet ID from a Google Sheets URL
    m = re.search(r"/d/([a-zA-Z0-9-_]+)", url)
    if not m:
        raise ValueError("Could not extract spreadsheet ID from URL: %s" % url)
    return m.group(1)


def get_client(creds_path: str) -> gspread.Client:
    if not os.path.exists(creds_path):
        raise FileNotFoundError(f"Credentials file not found: {creds_path}")
    scopes = [
        "https://www.googleapis.com/auth/spreadsheets.readonly",
        "https://www.googleapis.com/auth/drive.readonly",
    ]
    creds = Credentials.from_service_account_file(creds_path, scopes=scopes)
    return gspread.authorize(creds)


def summarize_sheet(client: gspread.Client, sheet_url: str, max_preview_rows: int = 20) -> Dict[str, Any]:
    ss_id = extract_spreadsheet_id(sheet_url)
    ss = client.open_by_key(ss_id)
    summary: Dict[str, Any] = {
        "spreadsheet_id": ss_id,
        "title": ss.title,
        "worksheets": [],
    }
    for ws in ss.worksheets():
        rows = ws.row_count
        cols = ws.col_count
        values = ws.get_all_values()
        preview = values[:max_preview_rows]
        summary["worksheets"].append(
            {
                "title": ws.title,
                "rows": rows,
                "cols": cols,
                "data_rows": len(values),
                "preview": preview,
            }
        )
    return summary


def main() -> None:
    parser = argparse.ArgumentParser()
    parser.add_argument("--sheet-url", required=True, help="Google Sheet URL to summarize")
    parser.add_argument("--creds", default="credentials.json", help="Path to service account credentials JSON")
    parser.add_argument("--out", default=None, help="Optional output JSON file")
    args = parser.parse_args()

    client = get_client(args.creds)
    try:
        summ = summarize_sheet(client, args.sheet_url)
    except Exception as e:
        print("Error while fetching sheet:", e)
        raise

    if args.out:
        with open(args.out, "w", encoding="utf-8") as f:
            json.dump(summ, f, ensure_ascii=False, indent=2)
        print(f"Summary written to {args.out}")
    else:
        print(json.dumps(summ, ensure_ascii=False, indent=2))


if __name__ == "__main__":
    main()


================================================================================
FILE: ./docs/tools/telegram_webapp_debug.py
SIZE: 7071 bytes
================================================================================

#!/usr/bin/env python3
"""
Telegram WebApp Authorization Debug Script
This script uses Context7 MCP to get accurate documentation and debug authorization issues.
"""

import json
import logging
from typing import Dict, Any

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class TelegramWebAppDebugger:
    def __init__(self):
        self.debug_info = {}
    
    def simulate_webapp_data_flow(self, user_id: str, partner_code: str, partner_phone: str) -> Dict[str, Any]:
        """–°–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –æ—Ç WebApp –∫ –±–æ—Ç—É"""
        logger.info("=== –ù–∞—á–∞–ª–æ —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö WebApp ===")
        
        # –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ WebApp
        webapp_data = {
            "partner_code": partner_code,
            "partner_phone": partner_phone
        }
        
        logger.info(f"User ID: {user_id}")
        logger.info(f"Partner Code: {partner_code}")
        logger.info(f"Partner Phone: {partner_phone}")
        logger.info(f"WebApp Data: {json.dumps(webapp_data, ensure_ascii=False)}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
        validation_result = self.validate_webapp_data(webapp_data)
        logger.info(f"–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö: {validation_result}")
        
        # –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        send_result = self.simulate_send_data(webapp_data)
        logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏: {send_result}")
        
        # –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–º
        receive_result = self.simulate_receive_data(webapp_data, user_id)
        logger.info(f"–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω–∏—è: {receive_result}")
        
        self.debug_info = {
            "user_id": user_id,
            "webapp_data": webapp_data,
            "validation": validation_result,
            "send_result": send_result,
            "receive_result": receive_result
        }
        
        logger.info("=== –ö–æ–Ω–µ—Ü —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö WebApp ===")
        return self.debug_info
    
    def validate_webapp_data(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp"""
        result = {
            "valid": True,
            "errors": []
        }
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        if not data.get("partner_code"):
            result["valid"] = False
            result["errors"].append("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        if not data.get("partner_phone"):
            result["valid"] = False
            result["errors"].append("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞")
        
        return result
    
    def simulate_send_data(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """–°–∏–º—É–ª–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Telegram WebApp API"""
        result = {
            "success": True,
            "message": "–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ",
            "data_sent": json.dumps(data, ensure_ascii=False)
        }
        
        logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Telegram WebApp API...")
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {result['data_sent']}")
        
        return result
    
    def simulate_receive_data(self, data: Dict[str, Any], user_id: str) -> Dict[str, Any]:
        """–°–∏–º—É–ª–∏—Ä—É–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–º"""
        result = {
            "success": True,
            "message": "–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –±–æ—Ç–æ–º",
            "user_id": user_id,
            "received_data": data
        }
        
        logger.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–æ–º...")
        logger.info(f"User ID: {user_id}")
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {json.dumps(data, ensure_ascii=False)}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –±–æ—Ç–∞
        logger.info("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö...")
        logger.info("–§–∏–ª—å—Ç—Ä: filters.StatusUpdate.WEB_APP_DATA")
        
        return result
    
    def analyze_common_issues(self) -> Dict[str, Any]:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π"""
        issues = {
            "possible_causes": [
                "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞",
                "–ü—Ä–æ–±–ª–µ–º—ã —Å URL WebApp –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏",
                "–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π Telegram WebApp API",
                "–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º",
                "–û—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
                "–ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π JSON –¥–∞–Ω–Ω—ã—Ö –≤ –±–æ—Ç–µ"
            ],
            "solutions": [
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä filters.StatusUpdate.WEB_APP_DATA –≤ handlers.py",
                "–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ WEB_APP_URL –≤ .env —Ñ–∞–π–ª–µ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω",
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é Telegram WebApp API –≤ app.js",
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å URL",
                "–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ",
                "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É JSON –≤ web_app_data_handler"
            ]
        }
        
        logger.info("=== –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º ===")
        for i, cause in enumerate(issues["possible_causes"], 1):
            logger.info(f"{i}. {cause}")
        
        logger.info("\n=== –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è ===")
        for i, solution in enumerate(issues["solutions"], 1):
            logger.info(f"{i}. {solution}")
        
        return issues

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"""
    debugger = TelegramWebAppDebugger()
    
    # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    user_id = "284355186"
    partner_code = "111098"
    partner_phone = "+7 (910) 123-45-55"
    
    # –°–∏–º—É–ª—è—Ü–∏—è –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    debug_result = debugger.simulate_webapp_data_flow(user_id, partner_code, partner_phone)
    
    # –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º
    issues = debugger.analyze_common_issues()
    
    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    print("\n=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò ===")
    print(json.dumps(debug_result, ensure_ascii=False, indent=2))
    print("\n=== –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú ===")
    print(json.dumps(issues, ensure_ascii=False, indent=2))

if __name__ == "__main__":
    main()

================================================================================
FILE: ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md
SIZE: 9060 bytes
================================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Tunnel –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã SSL

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Cloudflare Tunnel –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ HTTPS URL –¥–ª—è –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ Yandex VM.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –î–æ–≤–µ—Ä–µ–Ω–Ω—ã–π SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞)
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (30-60 –º–∏–Ω—É—Ç)
- ‚úÖ –í—ã—Å–æ–∫–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å (Cloudflare –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. –ê–∫–∫–∞—É–Ω—Ç Cloudflare (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π): https://dash.cloudflare.com/sign-up
2. –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É Yandex VM —á–µ—Ä–µ–∑ SSH
3. Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ `localhost:8080`

## –®–∞–≥ 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Cloudflare

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://dash.cloudflare.com/sign-up
2. –°–æ–∑–¥–∞–π—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
3. –í–æ–π–¥–∏—Ç–µ –≤ Dashboard

## –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ Tunnel —á–µ—Ä–µ–∑ Dashboard

1. –í Cloudflare Dashboard –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Zero Trust** (–∏–ª–∏ **Networks**)
2. –í—ã–±–µ—Ä–∏—Ç–µ **Networks** ‚Üí **Tunnels**
3. –ù–∞–∂–º–∏—Ç–µ **Create a tunnel**
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç—É–Ω–Ω–µ–ª—è: **Cloudflared**
5. –í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ç—É–Ω–Ω–µ–ª—è: `marketingbot-tunnel`
6. –ù–∞–∂–º–∏—Ç–µ **Save tunnel**
7. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ Tunnel ID** (–æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø–æ–∑–∂–µ)
8. –ù–∞–∂–º–∏—Ç–µ **Next** –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Public Hostname

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Public Hostname

1. –í —Ä–∞–∑–¥–µ–ª–µ **Public Hostname** –Ω–∞–∂–º–∏—Ç–µ **Add a public hostname**
2. **Subdomain**: `marketingbot` (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ –∏–º—è)
3. **Domain**: –≤—ã–±–µ—Ä–∏—Ç–µ `trycloudflare.com` (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–æ–º–µ–Ω)
4. **Service Type**: `HTTP`
5. **URL**: `localhost:8080`
6. –ù–∞–∂–º–∏—Ç–µ **Save hostname**

**–í–∞–∂–Ω–æ:** –ó–∞–ø–∏—à–∏—Ç–µ –ø–æ–ª–Ω—ã–π URL —Ç—É–Ω–Ω–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://marketingbot-xxxxx.trycloudflare.com`)

## –®–∞–≥ 4: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç—É–Ω–Ω–µ–ª—è –Ω–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **Install connector**
2. –í—ã–±–µ—Ä–∏—Ç–µ **Linux** ‚Üí **amd64**
3. –°–∫–∞—á–∞–π—Ç–µ **credentials —Ñ–∞–π–ª** (JSON) - –æ–Ω –±—É–¥–µ—Ç –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è `<TUNNEL_ID>.json`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –Ω–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ

## –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH:

```bash
./ssh_yandex.sh
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
# –°–∫–∞—á–∞—Ç—å cloudflared
cd /tmp
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb

# –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –æ—à–∏–±–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
sudo apt-get install -f -y
```

## –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—É–Ω–Ω–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å:
   - Tunnel ID (–∏–∑ —à–∞–≥–∞ 2)
   - Credentials —Ñ–∞–π–ª (JSON) –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:

```bash
./setup_cloudflare_tunnel.sh
```

–°–∫—Ä–∏–ø—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏:
- Tunnel ID
- –ü—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É

### –í–∞—Ä–∏–∞–Ω—Ç B: –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

–ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é:

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
./ssh_yandex.sh

# –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo mkdir -p /etc/cloudflared

# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ credentials —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ)
scp -i ~/.ssh/ssh-key-1767684261599/ssh-key-1767684261599 <TUNNEL_ID>.json ubuntu@158.160.0.127:/tmp/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª
sudo mv /tmp/<TUNNEL_ID>.json /etc/cloudflared/
sudo chmod 600 /etc/cloudflared/<TUNNEL_ID>.json

# –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
sudo nano /etc/cloudflared/config.yml
```

–í—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–∑–∞–º–µ–Ω–∏—Ç–µ `<TUNNEL_ID>` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π ID):

```yaml
tunnel: <TUNNEL_ID>
credentials-file: /etc/cloudflared/<TUNNEL_ID>.json

ingress:
  - hostname: marketingbot-<TUNNEL_ID>.trycloudflare.com
    service: http://localhost:8080
  - service: http_status:404
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª (Ctrl+O, Enter, Ctrl+X).

## –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–∞

–°–æ–∑–¥–∞–π—Ç–µ systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è:

```bash
sudo nano /etc/systemd/system/cloudflared.service
```

–í—Å—Ç–∞–≤—å—Ç–µ:

```ini
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel --config /etc/cloudflared/config.yml run
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
sudo systemctl daemon-reload
sudo systemctl enable cloudflared
sudo systemctl start cloudflared
```

## –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç—É–Ω–Ω–µ–ª—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl status cloudflared

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo journalctl -u cloudflared -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å
curl https://marketingbot-<TUNNEL_ID>.trycloudflare.com/api/promotions
```

–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å JSON —Å –∞–∫—Ü–∏—è–º–∏.

## –®–∞–≥ 9: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ menu.html

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç—É–Ω–Ω–µ–ª—è –æ–±–Ω–æ–≤–∏—Ç–µ `menu.html`:

1. –û—Ç–∫—Ä–æ–π—Ç–µ `menu.html`
2. –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É —Å `API_BASE_URL`
3. –ó–∞–º–µ–Ω–∏—Ç–µ `<TUNNEL_ID>` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π Tunnel ID:

```javascript
API_BASE_URL = 'https://marketingbot-<–í–ê–®_TUNNEL_ID>.trycloudflare.com';
```

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏ –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

```bash
git add menu.html
git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω API_BASE_URL –¥–ª—è Cloudflare Tunnel"
git push origin main
```

## –®–∞–≥ 10: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ê–∫—Ü–∏–∏"
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ SSL
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ CORS –∏–ª–∏ SSL

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –¢—É–Ω–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
sudo journalctl -u cloudflared -n 50

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo cloudflared tunnel --config /etc/cloudflared/config.yml validate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials —Ñ–∞–π–ª
sudo cat /etc/cloudflared/<TUNNEL_ID>.json
```

### API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ —Ç—É–Ω–Ω–µ–ª—å

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ `localhost:8080`:
   ```bash
   curl http://localhost:8080/api/promotions
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
   ```bash
   sudo cat /etc/cloudflared/config.yml
   ```

3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:
   ```bash
   sudo systemctl restart cloudflared
   ```

### –û—à–∏–±–∫–∏ SSL –≤ –±—Ä–∞—É–∑–µ—Ä–µ

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL —Ç—É–Ω–Ω–µ–ª—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç—É–Ω–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç: `sudo systemctl status cloudflared`
- –û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞

## –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ URL (–≤–º–µ—Å—Ç–æ `trycloudflare.com`):

1. –ö—É–ø–∏—Ç–µ –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Cloudflare –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä)
2. –î–æ–±–∞–≤—å—Ç–µ –¥–æ–º–µ–Ω –≤ Cloudflare
3. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ç—É–Ω–Ω–µ–ª—è –∏–∑–º–µ–Ω–∏—Ç–µ Public Hostname –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
4. –û–±–Ω–æ–≤–∏—Ç–µ `API_BASE_URL` –≤ `menu.html`

## –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å
sudo systemctl stop cloudflared

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å
sudo systemctl start cloudflared

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç—É–Ω–Ω–µ–ª—å
sudo systemctl restart cloudflared

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u cloudflared -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status cloudflared
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)
- [Cloudflare Zero Trust Dashboard](https://one.dash.cloudflare.com/)


================================================================================
FILE: ./docs/archive/QUICK_START_CLOUDFLARE.md
SIZE: 2124 bytes
================================================================================

# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: Cloudflare Tunnel –¥–ª—è SSL

## –ß—Ç–æ —ç—Ç–æ —Ä–µ—à–∞–µ—Ç?

–ü—Ä–æ–±–ª–µ–º–∞: –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ GitHub Pages (HTTPS) –Ω–µ –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API –Ω–∞ Yandex VM –∏–∑-–∑–∞ —Å–∞–º–æ–ø–æ–¥–ø–∏—Å–∞–Ω–Ω–æ–≥–æ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.

–†–µ—à–µ–Ω–∏–µ: Cloudflare Tunnel –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π HTTPS URL –¥–ª—è –≤–∞—à–µ–≥–æ API.

## –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (5 —à–∞–≥–æ–≤)

### 1. –°–æ–∑–¥–∞–π—Ç–µ —Ç—É–Ω–Ω–µ–ª—å –≤ Cloudflare Dashboard

1. –ó–∞–π–¥–∏—Ç–µ –Ω–∞ https://dash.cloudflare.com (—Å–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
2. Zero Trust ‚Üí Networks ‚Üí Tunnels ‚Üí Create a tunnel
3. –í—ã–±–µ—Ä–∏—Ç–µ "Cloudflared", –∏–º—è: `marketingbot-tunnel`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ **Tunnel ID**
5. –î–æ–±–∞–≤—å—Ç–µ Public Hostname:
   - Subdomain: `marketingbot`
   - Domain: `trycloudflare.com`
   - Service: `http://localhost:8080`
6. –°–∫–∞—á–∞–π—Ç–µ **credentials —Ñ–∞–π–ª** (JSON)

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏

```bash
./setup_cloudflare_tunnel.sh
```

–í–≤–µ–¥–∏—Ç–µ:
- Tunnel ID (–∏–∑ —à–∞–≥–∞ 1)
- –ü—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É

### 3. –û–±–Ω–æ–≤–∏—Ç–µ menu.html

–û—Ç–∫—Ä–æ–π—Ç–µ `menu.html`, –Ω–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:

```javascript
API_BASE_URL = 'https://marketingbot-<TUNNEL_ID>.trycloudflare.com';
```

–ó–∞–º–µ–Ω–∏—Ç–µ `<TUNNEL_ID>` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π Tunnel ID.

### 4. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add menu.html
git commit -m "–ù–∞—Å—Ç—Ä–æ–µ–Ω Cloudflare Tunnel –¥–ª—è SSL"
git push origin main
```

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É

–û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ Telegram ‚Üí —Ä–∞–∑–¥–µ–ª "–ê–∫—Ü–∏–∏". –ê–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ SSL.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç—É–Ω–Ω–µ–ª—è

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:

```bash
./ssh_yandex.sh
sudo systemctl status cloudflared
curl https://marketingbot-<TUNNEL_ID>.trycloudflare.com/api/promotions
```

## –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. [docs/CLOUDFLARE_TUNNEL_SETUP.md](docs/CLOUDFLARE_TUNNEL_SETUP.md)


================================================================================
FILE: ./docs/troubleshooting/DEPLOYMENT_ISSUES.md
SIZE: 1892 bytes
================================================================================

# –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Cloudflare Tunnel –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ. –í—Å–µ –∞–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Google Apps Script.

## –ü—Ä–æ–±–ª–µ–º–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π WEB_APP_URL

### –°–∏–º–ø—Ç–æ–º—ã
- –ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –í –ª–æ–≥–∞—Ö –æ—à–∏–±–∫–∞ "WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL"

### –†–µ—à–µ–Ω–∏–µ

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ `.env`:
   ```bash
   grep WEB_APP_URL .env
   ```

2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ:
   ```
   WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/
   ```

3. –û–±–Ω–æ–≤–∏—Ç–µ `.env` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):
   ```bash
   sed -i 's|WEB_APP_URL=.*|WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/|' .env
   ```

4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   sudo systemctl restart marketingbot-bot.service
   sudo systemctl restart marketingbot-web.service
   ```

## –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub

```bash
cd /home/ubuntu/marketingbot
git fetch origin
git pull origin main
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```bash
sudo systemctl status marketingbot-bot.service
sudo systemctl status marketingbot-web.service
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
sudo systemctl restart marketingbot-bot.service
sudo systemctl restart marketingbot-web.service
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å

- [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Yandex Cloud](../deployment/DEPLOYMENT_YANDEX.md)
- [–û–±—â–µ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫](TROUBLESHOOTING.md)
- [–ü—Ä–æ–±–ª–µ–º—ã —Å –∞–∫—Ü–∏—è–º–∏](PROMOTIONS_ISSUES.md)

================================================================================
FILE: ./docs/troubleshooting/PROMOTIONS_ISSUES.md
SIZE: 7449 bytes
================================================================================

# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∞–∫—Ü–∏—è–º–∏

## –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞: "Failed to fetch" –∏–ª–∏ "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏"

**–°–∏–º–ø—Ç–æ–º—ã:**
- Mini App –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏"
- –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞ "Failed to fetch"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

#### 1. Google Apps Script –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ URL Google Apps Script –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è JSON –º–∞—Å—Å–∏–≤ —Å –∞–∫—Ü–∏—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º "Anyone"
- –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ Google Apps Script
- –°–º. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script](../guides/GOOGLE_APPS_SCRIPT_SETUP.md)

#### 2. CORS –ø—Ä–æ–±–ª–µ–º–∞ (—Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞)

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞ "Failed to fetch"
- Google Apps Script –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML –≤–º–µ—Å—Ç–æ JSON
- –û—à–∏–±–∫–∞ "TypeError: Failed to fetch" –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏

**–ü—Ä–∏—á–∏–Ω–∞:**
Google Apps Script –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–æ—Å—Ç—É–ø–∞.

**–†–µ—à–µ–Ω–∏–µ (–ø–æ—à–∞–≥–æ–≤–æ):**

1. **–û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://script.google.com
   - –ù–∞–π–¥–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç —Å –∞–∫—Ü–∏—è–º–∏

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**
   - –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"
   - –ù–∞–π–¥–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å —Ç–∏–ø–æ–º "–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")

3. **–û–±–Ω–æ–≤–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ—Å—Ç—É–ø–∞:**
   - –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è —Ä—è–¥–æ–º —Å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º
   - –í –ø–æ–ª–µ **"–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø"** –≤—ã–±–µ—Ä–∏—Ç–µ **"–í—Å–µ"** (Anyone)
   - **–í–ê–ñ–ù–û:** –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã CORS!

4. **–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é:**
   - –ù–∞–∂–º–∏—Ç–µ "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è"
   - –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–π URL (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è)

5. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã:**
   - Google Apps Script –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –≤—Ä–µ–º—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ URL —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
   - –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è JSON, –∞ –Ω–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ HTML - –¥–æ—Å—Ç—É–ø –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ:**
- –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
- –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–ª–∏ "–í—Å–µ" (Anyone) –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏

#### 3. –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–∫—Ü–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Google Sheets —Å –∞–∫—Ü–∏—è–º–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞" –≤ –∫–æ–ª–æ–Ω–∫–µ D

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤—å—Ç–µ –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–ª–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "–°—Ç–∞—Ç—É—Å" –∏–ª–∏ "D"

#### 4. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12)
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ü–∏–π
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google Apps Script

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Google Apps Script –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ JSON
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ `doGet()` –≤ Google Apps Script

## –û—Ç–ª–∞–¥–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ Mini App –≤ Telegram
2. –ù–∞–∂–º–∏—Ç–µ F12 (DevTools)
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É Console
4. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏:
   - `–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏ —Å: ...`
   - `–û—Ç–≤–µ—Ç –æ—Ç ...`
   - –õ—é–±—ã–µ –æ—à–∏–±–∫–∏

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Apps Script URL

–û—Ç–∫—Ä–æ–π—Ç–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** JSON –º–∞—Å—Å–∏–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä:
```json
[
  {
    "id": "test_—Ç–µ—Å—Ç_—Ñ—É–Ω–∫—Ü–∏–∏_–∞–∫—Ü–∏–∏_09.10.2025_11.10.2025",
    "title": "—Ç–µ—Å—Ç",
    "description": "—Ç–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∞–∫—Ü–∏–∏",
    "status": "–ê–∫—Ç–∏–≤–Ω–∞",
    "start_date": "09.10.2025",
    "end_date": "11.10.2025"
  }
]
```

**–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –≤ Google Apps Script
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Google Apps Script (–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Üí –ñ—É—Ä–Ω–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É Google Sheets

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É "–ê–∫—Ü–∏–∏"
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞" –≤ –∫–æ–ª–æ–Ω–∫–µ D
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã:
   - –ù–∞–∑–≤–∞–Ω–∏–µ (–∫–æ–ª–æ–Ω–∫–∞ B)
   - –û–ø–∏—Å–∞–Ω–∏–µ (–∫–æ–ª–æ–Ω–∫–∞ C)
   - –°—Ç–∞—Ç—É—Å = "–ê–∫—Ç–∏–≤–Ω–∞" (–∫–æ–ª–æ–Ω–∫–∞ D)

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Apps Script

1. –û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –∏–∑ `GOOGLE_APPS_SCRIPT_FULL.js` –≤—Å—Ç–∞–≤–ª–µ–Ω
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ (Ctrl+S)
4. –û–±–Ω–æ–≤–∏—Ç–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:
   - "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"
   - –ò–∫–æ–Ω–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è
   - "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è"
   - "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –û—à–∏–±–∫–∞: `TypeError: ContentService.createTextOutput(...).setMimeType(...).setHeader is not a function`

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ—Ç–æ–¥ `setHeader()` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ Google Apps Script API.

**–†–µ—à–µ–Ω–∏–µ:**
–£–¥–∞–ª–∏—Ç–µ –≤—Å–µ –≤—ã–∑–æ–≤—ã `.setHeader('Access-Control-Allow-Origin', '*')` –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `doGet`.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥:**
```javascript
return ContentService
  .createTextOutput(JSON.stringify(result))
  .setMimeType(ContentService.MimeType.JSON);
```

CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –¥–æ—Å—Ç—É–ø–∞ "Anyone" –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

## –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ URL Google Apps Script –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤ Mini App
3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –æ—à–∏–±–∫—É - –æ–±–Ω–æ–≤–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –≤ Google Apps Script
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –≤ Mini App (F12)
5. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ—Å—Ç—É–ø "Anyone" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ Google Apps Script

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–º–æ—â—å

- [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script](../guides/GOOGLE_APPS_SCRIPT_SETUP.md)
- [–û–±—â–µ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫](TROUBLESHOOTING.md)


================================================================================
FILE: ./docs/troubleshooting/TROUBLESHOOTING.md
SIZE: 17221 bytes
================================================================================

# üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫ MarketingBot v3.2

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è (PythonAnywhere)

### 1. –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ `/start`
- –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞ –≤ Telegram

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ–∫–µ–Ω–æ–º:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
python3 -c "from dotenv import load_dotenv; import os; load_dotenv(); print('Token:', 'OK' if os.getenv('TELEGRAM_TOKEN') else 'MISSING')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
curl "https://api.telegram.org/bot<YOUR_TOKEN>/getMe"
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å webhook (PythonAnywhere):
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
curl -X GET "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://yourusername.pythonanywhere.com/webhook"}'
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Telegram API
curl -I https://api.telegram.org

# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook –Ω–∞ PythonAnywhere
curl -I https://yourusername.pythonanywhere.com/webhook

# –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS
nslookup api.telegram.org
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å PythonAnywhere:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python
python3 --version

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip3 install --user -r requirements.txt

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π
python3 -c "import sys; print('Python path:', sys.path)"
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–æ—Ü–µ—Å—Å–æ–º:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pgrep -f "python.*bot.py"

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –Ω–∞ PythonAnywhere
python3 bot.py

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
nohup python3 bot.py > bot.log 2>&1 &

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
pkill -f "python.*bot.py"
python3 bot.py
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å webhook –Ω–∞ PythonAnywhere:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
curl -X GET "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"

# –£–¥–∞–ª–µ–Ω–∏–µ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/deleteWebhook"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://yourusername.pythonanywhere.com/webhook"}'
```

### 2. WebApp –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ö–Ω–æ–ø–∫–∞ "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è" –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- WebApp –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ WEBAPP_URL:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ URL WebApp
python3 -c "from handlers import get_web_app_url; print('WebApp URL:', get_web_app_url())"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤
curl -I https://synthosaicreativestudio-maker.github.io/marketing/index.html
curl -I https://synthosaicreativestudio-maker.github.io/marketing/menu.html
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
echo $WEBAPP_URL

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ URL
curl -I $WEBAPP_URL
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ WebApp:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤
ls -la index.html menu.html app.js

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
head -5 index.html
head -5 menu.html
head -5 app.js
```

#### –ü—Ä–æ–±–ª–µ–º—ã —Å HTTPS:
- WebApp —Ç—Ä–µ–±—É–µ—Ç HTTPS –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤ Telegram
- PythonAnywhere –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç HTTPS –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS
curl -I https://synthosaicreativestudio-maker.github.io/marketing/index.html

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
grep WEBAPP_URL .env
```

### 3. –û—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- "–ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –û—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –º–µ–Ω—é

**–†–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ Google Sheets:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets
python3 -c "from sheets import _load_service_account; print('Google Sheets connection OK')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ
python3 -c "from sheets import get_sheet_data; print('Sheet data:', get_sheet_data()[:3])"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Account
python3 -c "from sheets import _load_service_account; sa = _load_service_account(); print('Service Account:', sa.service_account_email)"
```

#### –ü—Ä–æ–±–ª–µ–º—ã —Å Google Sheets:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ service account
python3 -c "import json; print(json.loads(open('.env').read().split('GCP_SA_JSON=')[1].split('\n')[0])['client_email'])"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
python3 -c "from sheets import _load_service_account; sa = _load_service_account(); print('Service Account email:', sa.service_account_email)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
python3 -c "from sheets import get_sheet_data; data = get_sheet_data(); print('Authorization data:', data[:3] if data else 'No data')"
```

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ
python3 -c "from sheets import _get_client_and_sheet; client, sheet = _get_client_and_sheet(); print('Sheets OK')"
```

#### –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º:
```bash
# –°–±—Ä–æ—Å –∫–µ—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
rm -f auth_cache.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 bot.py
```

#### Fallback –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:
- –ï—Å–ª–∏ Google Sheets –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
- –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: –∫–æ–¥ `111098`, —Ç–µ–ª–µ—Ñ–æ–Ω —Å `1055`

### 4. –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–±—Ä–∞—â–µ–Ω–∏–π

**–°–∏–º–ø—Ç–æ–º—ã:**
- –û–±—Ä–∞—â–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è
- –°—Ç–∞—Ç—É—Å—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- –û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ AppealsService:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
python3 -c "from appeals_service import AppealsService; as = AppealsService(); print('Appeals service OK')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è
python3 -c "from appeals_service import AppealsService; as = AppealsService(); print('Test appeal:', as.create_appeal('TEST', '123', 'Test User', 123456789, 'Test message'))"
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ ResponseMonitor:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–æ–≤
python3 -c "from response_monitor import ResponseMonitor; rm = ResponseMonitor(); print('Response monitor OK')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
grep -i "appeal\|status\|response" bot.log | tail -10
```

#### –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ WebApp:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö WebApp
echo "WEB_APP_URL: $WEB_APP_URL"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL
python3 -c "from handlers import get_web_app_url, get_spa_menu_url; print('Auth URL:', get_web_app_url()); print('Menu URL:', get_spa_menu_url())"
```

### 5. –ü—Ä–æ–±–ª–µ–º—ã —Å OpenAI

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ò–ò –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
- –û—à–∏–±–∫–∏ API OpenAI
- –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

**–†–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ API –∫–ª—é—á–∞
python3 -c "import os; from dotenv import load_dotenv; load_dotenv(); print('OpenAI Key:', 'OK' if os.getenv('OPENAI_API_KEY') else 'MISSING')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Assistant ID
python3 -c "import os; from dotenv import load_dotenv; load_dotenv(); print('Assistant ID:', os.getenv('OPENAI_ASSISTANT_ID'))"
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ OpenAI
python3 -c "from openai_service import OpenAIService; oai = OpenAIService(); print('OpenAI service OK')"

# –¢–µ—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
python3 -c "from openai_service import OpenAIService; oai = OpenAIService(); print('Test response:', oai.get_response('Test message', 123456789))"
```

### 6. –ü—Ä–æ–±–ª–µ–º—ã —Å PythonAnywhere

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- –û—à–∏–±–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
- –ü—Ä–æ–±–ª–µ–º—ã —Å webhook

**–†–µ—à–µ–Ω–∏—è:**

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python
python3 --version

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip3 install --user -r requirements.txt

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π
python3 -c "import sys; print('Python path:', sys.path)"
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
curl -X GET "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"

# –£–¥–∞–ª–µ–Ω–∏–µ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/deleteWebhook"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://yourusername.pythonanywhere.com/webhook"}'
```

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã:
```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()

print('=== –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ MarketingBot v3.2 ===')
print(f'Telegram Token: {\"‚úì\" if os.getenv(\"TELEGRAM_TOKEN\") else \"‚úó\"}')
print(f'OpenAI API Key: {\"‚úì\" if os.getenv(\"OPENAI_API_KEY\") else \"‚úó\"}')
print(f'OpenAI Assistant ID: {\"‚úì\" if os.getenv(\"OPENAI_ASSISTANT_ID\") else \"‚úó\"}')
print(f'Sheets ID: {\"‚úì\" if os.getenv(\"SHEET_ID\") else \"‚úó\"}')
print(f'Appeals Sheets ID: {\"‚úì\" if os.getenv(\"APPEALS_SHEET_ID\") else \"‚úó\"}')
print(f'Promotions Sheets ID: {\"‚úì\" if os.getenv(\"PROMOTIONS_SHEET_ID\") else \"‚úó\"}')
print(f'WebApp URL: {os.getenv(\"WEB_APP_URL\", \"‚úó\")}')
print(f'Webhook URL: {os.getenv(\"WEBHOOK_URL\", \"‚úó\")}')
print(f'GCP SA JSON: {\"‚úì\" if os.getenv(\"GCP_SA_JSON\") else \"‚úó\"}')
"
```

### –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–π:
```bash
# –¢–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
python3 -c "from auth_service import AuthService; auth = AuthService(); print('Auth service test:', auth.get_user_auth_status(123456789))"

# –¢–µ—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π
python3 -c "from appeals_service import AppealsService; appeals = AppealsService(); print('Appeals service test:', appeals.create_appeal('TEST', '123', 'Test User', 123456789, 'Test message'))"

# –¢–µ—Å—Ç OpenAI
python3 -c "from openai_service import OpenAIService; openai = OpenAIService(); print('OpenAI service test:', openai.get_response('Test message', 123456789))"

# –¢–µ—Å—Ç –∞–∫—Ü–∏–π
python3 -c "from promotions_api import get_active_promotions; promotions = get_active_promotions(); print('Promotions test:', len(promotions), 'active promotions')"
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
# –í—Å–µ –ª–æ–≥–∏
tail -f bot.log

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
tail -f bot.log | grep -i "error\|exception\|traceback"

# –¢–æ–ª—å–∫–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
tail -f bot.log | grep -i "appeal\|status\|response"

# –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
tail -f bot.log | grep -i "auth\|authorization\|login"

# –¢–æ–ª—å–∫–æ –∞–∫—Ü–∏–∏
tail -f bot.log | grep -i "promotion\|–∞–∫—Ü–∏—è\|—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
```bash
# –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
grep "Response time" bot.log | tail -10

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π
grep "Appeal created" bot.log | wc -l

# –û—à–∏–±–∫–∏ API
grep "API error" bot.log | wc -l

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
grep "Authorization" bot.log | wc -l
```

## üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –º–µ—Ä—ã

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
pkill -f "python3 bot.py"

# –ó–∞–ø—É—Å–∫
python3 bot.py

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
nohup python3 bot.py > bot.log 2>&1 &
```

### –°–±—Ä–æ—Å –∫—ç—à–∞:
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
rm -f auth_cache.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 bot.py
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞:
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ .env
cp .env.backup .env

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
git checkout HEAD~1

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
python3 bot.py
```

### –°–±—Ä–æ—Å webhook:
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/deleteWebhook"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ webhook
curl -X POST "https://api.telegram.org/bot<TOKEN>/setWebhook" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://yourusername.pythonanywhere.com/webhook"}'
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é —ç—Ç–æ–≥–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** - –Ω–∞–π–¥–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –æ—à–∏–±–∫—É
2. **–°–æ–∑–¥–∞–π—Ç–µ issue** - –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É –∏ –ø—Ä–∏–ª–æ–∂–∏—Ç–µ –ª–æ–≥–∏
3. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É** - –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:
```bash
# –°–±–æ—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∏—Å—Ç–µ–º–µ
echo "=== System Info ==="
python3 --version
pip list | grep -E "(telegram|openai|gspread|flask)"
echo "=== Bot Status ==="
ps aux | grep "python3 bot.py"
echo "=== Recent Logs ==="
tail -20 bot.log
echo "=== Webhook Status ==="
curl -X GET "https://api.telegram.org/bot<TOKEN>/getWebhookInfo"
```

## üéØ –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã v3.2

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ "—Ä–µ—à–µ–Ω–æ"
**–°–∏–º–ø—Ç–æ–º—ã:**
- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ "—Ä–µ—à–µ–Ω–æ" –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å "–≤ —Ä–∞–±–æ—Ç–µ"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ response_monitor.py
grep -n "–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.*—Ä–µ—à–µ–Ω–æ" response_monitor.py

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —É–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
# –°—Ç–∞—Ç—É—Å –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è "–≤ —Ä–∞–±–æ—Ç–µ" –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
```

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏–π
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–≤–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ handlers.py
grep -n "reply_text" handlers.py

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —É–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã
```

### –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
**–°–∏–º–ø—Ç–æ–º—ã:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –º–æ–≥—É—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
- –û—à–∏–±–∫–∏ "–ü–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–±—Ä–æ—Å –∫–µ—à–∞
rm -f auth_cache.json

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 bot.py
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- [ ] Telegram Bot API —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Google Sheets –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] OpenAI API —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] WebApp –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS
- [ ] Webhook –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–±—Ä–∞—â–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è
- [ ] –°—Ç–∞—Ç—É—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è
- [ ] –û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- [ ] –ê–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ < 2 —Å–µ–∫—É–Ω–¥
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –î–ª—è PythonAnywhere:
1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Python 3.10** - –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫** - —á–µ—Ä–µ–∑ Tasks –≤ –ø–∞–Ω–µ–ª–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ bot.log
4. **–û–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - pip install --user -r requirements.txt

### –î–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
1. **–£–≤–µ–ª–∏—á—å—Ç–µ TTL –∫–µ—à–∞** - –¥–æ 10-15 –º–∏–Ω—É—Ç
2. **–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã** - –∫ Google Sheets
3. **–î–æ–±–∞–≤—å—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã** - –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

- **GitHub Issues**: [–°–æ–∑–¥–∞—Ç—å issue](https://github.com/synthosaicreativestudio-maker/marketing/issues)
- **Telegram**: @synthosaicreativestudio
- **Email**: support@synthosaicreativestudio.com

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** v3.2  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ


================================================================================
FILE: ./docs/getting-started/INSTALLATION.md
SIZE: 4453 bytes
================================================================================

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MarketingBot

–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ MarketingBot –Ω–∞ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ.

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.10 –∏–ª–∏ –≤—ã—à–µ
- Git
- –ê–∫–∫–∞—É–Ω—Ç Telegram (–¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞)
- Google Cloud –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets)
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) OpenAI API –∫–ª—é—á (–¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)

## –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/synthosaicreativestudio-maker/marketing.git
cd marketing
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv .venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Linux/Mac)
source .venv/bin/activate

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Windows)
.venv\Scripts\activate
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
nano .env  # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
```

### 5. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞:

```bash
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# WebApp URL (GitHub Pages –∏–ª–∏ –¥—Ä—É–≥–æ–π HTTPS URL)
WEB_APP_URL=https://your-username.github.io/marketing/

# Google Sheets
SHEET_ID=your_google_sheet_id
GCP_SA_JSON='{"type": "service_account", ...}'  # –∏–ª–∏ GCP_SA_FILE=/path/to/file.json

# OpenAI (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
OPENAI_API_KEY=your_openai_key
```

### 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞

```bash
python bot.py
```

## –ü–æ–¥—Ä–æ–±–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –±–æ—Ç–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ [@BotFather](https://t.me/BotFather)
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
3. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ `.env` –∫–∞–∫ `TELEGRAM_TOKEN`
4. –ü–æ–ª—É—á–∏—Ç–µ –≤–∞—à Telegram ID (—á–µ—Ä–µ–∑ [@userinfobot](https://t.me/userinfobot))
5. –î–æ–±–∞–≤—å—Ç–µ ID –≤ `.env` –∫–∞–∫ `ADMIN_TELEGRAM_ID`

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets

1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ [Google Cloud Console](https://console.cloud.google.com)
2. –í–∫–ª—é—á–∏—Ç–µ Google Sheets API
3. –°–æ–∑–¥–∞–π—Ç–µ Service Account
4. –°–∫–∞—á–∞–π—Ç–µ JSON –∫–ª—é—á
5. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ `.env` –∫–∞–∫ `GCP_SA_JSON` –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤ `GCP_SA_FILE`
6. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å Google Sheet —Å email –∏–∑ Service Account

–°–º. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets](../guides/GOOGLE_SHEETS.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebApp

1. –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ `index.html` –∏ `menu.html` –Ω–∞ HTTPS —Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GitHub Pages)
2. –£–∫–∞–∂–∏—Ç–µ URL –≤ `.env` –∫–∞–∫ `WEB_APP_URL`
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ `/`

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞ [OpenAI](https://platform.openai.com)
2. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ `.env` –∫–∞–∫ `OPENAI_API_KEY`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
   ```bash
   python bot.py
   ```
   –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω"

2. **WebApp –¥–æ—Å—Ç—É–ø–µ–Ω:**
   –û—Ç–∫—Ä–æ–π—Ç–µ `WEB_APP_URL` –≤ –±—Ä–∞—É–∑–µ—Ä–µ

3. **Google Sheets –ø–æ–¥–∫–ª—é—á–µ–Ω:**
   –ë–æ—Ç –¥–æ–ª–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ —á–∏—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script –¥–ª—è –∞–∫—Ü–∏–π](QUICK_START_GOOGLE_APPS_SCRIPT.md)
- [–ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Tunnel](QUICK_START_CLOUDFLARE.md)
- [–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ](../deployment/DEPLOYMENT_YANDEX.md)

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ, —Å–º.:
- [–û–±—â–µ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –Ω–µ–ø–æ–ª–∞–¥–æ–∫](../troubleshooting/TROUBLESHOOTING.md)
- [–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏](../troubleshooting/DEPLOYMENT_ISSUES.md)


================================================================================
FILE: ./docs/getting-started/QUICK_START_GOOGLE_APPS_SCRIPT.md
SIZE: 4613 bytes
================================================================================

# –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç: Google Apps Script –¥–ª—è –∞–∫—Ü–∏–π

## –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

‚úÖ –°–æ–∑–¥–∞–Ω Google Apps Script –∫–æ–¥ (`google_apps_script_promotions.js`)  
‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `menu.html` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Google Apps Script –∏ fallback –º–µ—Ö–∞–Ω–∏–∑–º–æ–º  
‚úÖ –°–æ–∑–¥–∞–Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (`docs/GOOGLE_APPS_SCRIPT_SETUP.md`)

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–µ–π—á–∞—Å (5-10 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Google –¢–∞–±–ª–∏—Ü—É —Å –∞–∫—Ü–∏—è–º–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É Google –¢–∞–±–ª–∏—Ü—É —Å –∞–∫—Ü–∏—è–º–∏
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–∏—Å—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ê–∫—Ü–∏–∏" (–∏–ª–∏ –∑–∞–ø–æ–º–Ω–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å Apps Script

1. –í –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ: **–†–∞—Å—à–∏—Ä–µ–Ω–∏—è** ‚Üí **Apps Script**
2. –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script
3. –£–¥–∞–ª–∏—Ç–µ –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `google_apps_script_promotions.js` –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ: **Ctrl+S** (–∏–ª–∏ **Cmd+S** –Ω–∞ Mac)

### –®–∞–≥ 3: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** (Deploy) –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
2. –í—ã–±–µ—Ä–∏—Ç–µ **"–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"** (New deployment)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∏ ‚öôÔ∏è —Ä—è–¥–æ–º —Å "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø"
4. –í—ã–±–µ—Ä–∏—Ç–µ **"–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"** (Web app)
5. –í –ø–æ–ª–µ **"–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø"** –≤—ã–±–µ—Ä–∏—Ç–µ **"–í—Å–µ"** (Anyone)
6. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** (Deploy)

### –®–∞–≥ 4: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL

1. –ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ —Å URL
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL (–æ–Ω –±—É–¥–µ—Ç –≤–∏–¥–∞: `https://script.google.com/macros/s/.../exec`)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å menu.html

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `menu.html`
2. –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É:
   ```javascript
   const GOOGLE_APPS_SCRIPT_URL = ''; // TODO: –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Google Apps Script URL –∑–¥–µ—Å—å
   ```
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à URL –º–µ–∂–¥—É –∫–∞–≤—ã—á–∫–∞–º–∏:
   ```javascript
   const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
   ```
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª

### –®–∞–≥ 6: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL Google Apps Script –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏
3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ JSON - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ

### –®–∞–≥ 7: –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

```bash
git add menu.html google_apps_script_promotions.js docs/GOOGLE_APPS_SCRIPT_SETUP.md QUICK_START_GOOGLE_APPS_SCRIPT.md
git commit -m "–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Google Apps Script –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π"
git push origin main
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **Mini App** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ Telegram
2. **JavaScript** –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ü–∏–∏:
   - –°–Ω–∞—á–∞–ª–∞ —Å **Google Apps Script** (–±—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ)
   - –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Å **Cloudflare Tunnel** (fallback)
   - –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Å **–ª–æ–∫–∞–ª—å–Ω–æ–≥–æ API** (–µ—Å–ª–∏ –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ)
3. **–ê–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è** –≤ Mini App

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É, –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è DNS
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å 99.9% (Google –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ HTTPS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏—Å—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ê–∫—Ü–∏–∏" (–∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
3. –û—Ç–∫—Ä–æ–π—Ç–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è JSON
4. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –≤ Mini App (F12) –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏

## –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–º. `docs/GOOGLE_APPS_SCRIPT_SETUP.md` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

---

**–í—Ä–µ–º—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** 5-10 –º–∏–Ω—É—Ç  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é


================================================================================
FILE: ./docs/getting-started/SIMPLE_SETUP.md
SIZE: 899 bytes
================================================================================

# –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script URL

## –û–¥–∏–Ω —à–∞–≥

1. –û—Ç–∫—Ä–æ–π—Ç–µ `menu.html` –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
2. –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É 773 (–∏–ª–∏ –Ω–∞–π–¥–∏—Ç–µ `GOOGLE_APPS_SCRIPT_URL`)
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à URL –º–µ–∂–¥—É –∫–∞–≤—ã—á–∫–∞–º–∏:

```javascript
const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/–í–ê–®_ID/exec';
```

–ì–¥–µ –≤–∑—è—Ç—å URL:
- –û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script
- –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" ‚Üí "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"
- –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä—è–¥–æ–º —Å URL
- –í—Å—Ç–∞–≤—å—Ç–µ –≤ menu.html

## –ì–æ—Ç–æ–≤–æ!

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google Apps Script.

–ï—Å–ª–∏ URL –Ω–µ —É–∫–∞–∑–∞–Ω, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Cloudflare Tunnel –∫–∞–∫ fallback.


================================================================================
FILE: ./docs/guides/GOOGLE_APPS_SCRIPT_SETUP.md
SIZE: 7076 bytes
================================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π

## –û–±–∑–æ—Ä

Google Apps Script –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ü–∏–π –∏–∑ Google Sheets. –≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—É —Å DNS –¥–ª—è Cloudflare Tunnel –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É, –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è DNS
- ‚úÖ –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Google - –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å 99.9%
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ –î–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
- ‚úÖ HTTPS –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å DNS (script.google.com –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)

## –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å Apps Script

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à—É Google –¢–∞–±–ª–∏—Ü—É —Å –∞–∫—Ü–∏—è–º–∏
2. –í –º–µ–Ω—é –≤—ã–±–µ—Ä–∏—Ç–µ: **–†–∞—Å—à–∏—Ä–µ–Ω–∏—è** ‚Üí **Apps Script**
3. –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script

## –®–∞–≥ 2: –í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥

1. –£–¥–∞–ª–∏—Ç–µ –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
2. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `google_apps_script_promotions.js` –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥
4. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç: **Ctrl+S** (–∏–ª–∏ **Cmd+S** –Ω–∞ Mac) –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–º—è –ª–∏—Å—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–ï—Å–ª–∏ –≤–∞—à –ª–∏—Å—Ç —Å –∞–∫—Ü–∏—è–º–∏ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ "–ê–∫—Ü–∏–∏", –∏–∑–º–µ–Ω–∏—Ç–µ –≤ –∫–æ–¥–µ:

```javascript
var sheet = spreadsheet.getSheetByName("–ê–∫—Ü–∏–∏"); // –ó–∞–º–µ–Ω–∏—Ç–µ "–ê–∫—Ü–∏–∏" –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ –ª–∏—Å—Ç–∞
```

## –®–∞–≥ 4: –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

1. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** (Deploy) –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
2. –í—ã–±–µ—Ä–∏—Ç–µ **"–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"** (New deployment)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —à–µ—Å—Ç–µ—Ä–µ–Ω–∫–∏ ‚öôÔ∏è —Ä—è–¥–æ–º —Å "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø"
4. –í—ã–±–µ—Ä–∏—Ç–µ **"–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"** (Web app)

## –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø

1. –í –ø–æ–ª–µ **"–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø"** (Who has access) –≤—ã–±–µ—Ä–∏—Ç–µ **"–í—Å–µ"** (Anyone)
   - –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–π –ø—É–±–ª–∏—á–Ω—ã–µ
   - –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –∏–∑ Mini App
2. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** (Deploy)

## –®–∞–≥ 6: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL

1. –ü–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø–æ—è–≤–∏—Ç—Å—è –æ–∫–Ω–æ —Å URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL (–æ–Ω –±—É–¥–µ—Ç –≤–∏–¥–∞: `https://script.google.com/macros/s/.../exec`)
3. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç URL - –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è `menu.html`

## –®–∞–≥ 7: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

–û—Ç–∫—Ä–æ–π—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å JSON —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–∫—Ü–∏—è–º–∏:

```json
[
  {
    "id": "–ê–∫—Ü–∏—è_1_...",
    "title": "–°–∫–∏–¥–∫–∞ 20% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏",
    "description": "–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
    "status": "–ê–∫—Ç–∏–≤–Ω–∞",
    "start_date": "05.10.2025",
    "end_date": "31.10.2025"
  }
]
```

## –®–∞–≥ 8: –û–±–Ω–æ–≤–∏—Ç—å menu.html

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `menu.html`
2. –ù–∞–π–¥–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `API_BASE_URL`
3. –ó–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à Google Apps Script URL:

```javascript
// –î–ª—è Google Apps Script –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π URL
API_BASE_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
```

–ò–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ fallback:

```javascript
const urlsToTry = [
    'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', // Google Apps Script
    `${API_BASE_URL}/api/promotions`, // Cloudflare Tunnel (fallback)
];
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

–°–∫—Ä–∏–ø—Ç –æ–∂–∏–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| A | –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ | –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ |
| B | –ù–∞–∑–≤–∞–Ω–∏–µ | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ |
| C | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ |
| D | –°—Ç–∞—Ç—É—Å | "–ê–∫—Ç–∏–≤–Ω–∞", "–û–∂–∏–¥–∞–µ—Ç", "–ó–∞–∫–æ–Ω—á–µ–Ω–∞" |
| E | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞–∫—Ü–∏–∏ |
| F | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–∫—Ü–∏–∏ |
| G | –ö–æ–Ω—Ç–µ–Ω—Ç | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –∫–∞–∫ —Ä—É—Å—Å–∫–∏–µ, —Ç–∞–∫ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è.

## –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

–ï—Å–ª–∏ –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ –∫–æ–¥ –≤ Apps Script:

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (Ctrl+S)
2. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** ‚Üí **"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"** (Manage deployments)
3. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚úèÔ∏è —Ä—è–¥–æ–º —Å –≤–∞—à–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º
4. –í—ã–±–µ—Ä–∏—Ç–µ **"–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è"** (New version)
5. –ù–∞–∂–º–∏—Ç–µ **"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"** (Deploy)

**–í–∞–∂–Ω–æ:** URL –Ω–µ –∏–∑–º–µ–Ω–∏—Ç—Å—è, –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

## –û—Ç–ª–∞–¥–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ Apps Script –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `testGetPromotions`
2. –ù–∞–∂–º–∏—Ç–µ **"–í—ã–ø–æ–ª–Ω–∏—Ç—å"** (Run)
3. –û—Ç–∫—Ä–æ–π—Ç–µ **"–ñ—É—Ä–Ω–∞–ª –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"** (Execution log) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—à–∏–±–æ–∫

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—É–±–ª–∏—á–Ω—ã–π, –Ω–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∞–∫—Ü–∏–∏)
- –°–∫—Ä–∏–ø—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–∫—Ü–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ê–∫—Ç–∏–≤–Ω–∞"
- –î–∞–Ω–Ω—ã–µ —á–∏—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ, –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è
- HTTPS –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–µ—Ä–µ–¥ Cloudflare Tunnel

- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ä–∞–∑—É, –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è DNS
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –∏ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- ‚úÖ –ü—Ä–æ—â–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å Google –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Fallback –º–µ—Ö–∞–Ω–∏–∑–º

–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±–æ–≤–∞—Ç—å Google Apps Script (–±—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ)
2. –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - fallback –Ω–∞ Cloudflare Tunnel
3. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞:** 6 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é


================================================================================
FILE: ./docs/guides/GOOGLE_SHEETS.md
SIZE: 13177 bytes
================================================================================

# üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets –¥–ª—è MarketingBot v3.2

## –û–±–∑–æ—Ä

MarketingBot v3.2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Google Sheets –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ–±—Ä–∞—â–µ–Ω–∏–π –∏ –∞–∫—Ü–∏–π. –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Google Sheets, –≤–∫–ª—é—á–∞—è Service Account –∏ Google Apps Script –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Cloud Platform

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –≤ GCP

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Google Cloud Console](https://console.cloud.google.com/)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –ó–∞–ø–æ–º–Ω–∏—Ç–µ Project ID

### 2. –í–∫–ª—é—á–µ–Ω–∏–µ Google Sheets API

1. –í Google Cloud Console –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **APIs & Services** ‚Üí **Library**
2. –ù–∞–π–¥–∏—Ç–µ "Google Sheets API"
3. –ù–∞–∂–º–∏—Ç–µ **Enable**

### 3. –°–æ–∑–¥–∞–Ω–∏–µ Service Account

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **IAM & Admin** ‚Üí **Service Accounts**
2. –ù–∞–∂–º–∏—Ç–µ **Create Service Account**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:
   - **Name**: `marketingbot-sa`
   - **Description**: `Service Account for MarketingBot`
4. –ù–∞–∂–º–∏—Ç–µ **Create and Continue**
5. –†–æ–ª—å: **Editor** (–∏–ª–∏ –±–æ–ª–µ–µ —É–∑–∫–∞—è ‚Äî —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø –∫ Sheets)
6. –ù–∞–∂–º–∏—Ç–µ **Done**

### 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON –∫–ª—é—á–∞

1. –ù–∞–π–¥–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π Service Account –≤ —Å–ø–∏—Å–∫–µ
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ email –∞–∫–∫–∞—É–Ω—Ç–∞
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Keys**
4. –ù–∞–∂–º–∏—Ç–µ **Add Key** ‚Üí **Create new key**
5. –í—ã–±–µ—Ä–∏—Ç–µ **JSON** –∏ –Ω–∞–∂–º–∏—Ç–µ **Create**
6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π JSON —Ñ–∞–π–ª

## üìã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

–°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏:

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|----------|---------|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä | 111098 |
| B | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ | 89827701055 |
| C | –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ü–æ–ª–Ω–æ–µ –∏–º—è | –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á |
| D | –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–∞ | –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω |
| E | Telegram ID | ID –≤ Telegram | 123456789 |
| F | –î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | 09.10.2025 15:30 |

**–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã** –∏–∑ URL: `https://docs.google.com/spreadsheets/d/<SHEET_ID>/edit`

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π

–°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏:

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|----------|---------|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –°–≤—è–∑—å —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π | 111098 |
| B | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | 89827701055 |
| C | –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | –ü–æ–ª–Ω–æ–µ –∏–º—è | –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á |
| D | Telegram ID | ID –≤ Telegram | 123456789 |
| E | –¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π | –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ü—Ä–∏–≤–µ—Ç! |
| F | –°—Ç–∞—Ç—É—Å | –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è | –ù–æ–≤–æ–µ, –í —Ä–∞–±–æ—Ç–µ, –†–µ—à–µ–Ω–æ |
| G | –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ | –û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ | –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! |
| H | –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | Timestamp | 09.10.2025 15:30 |

**–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã** –∏–∑ URL.

### 3. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ü–∏–π

–°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏:

| –ö–æ–ª–æ–Ω–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|---------|----------|----------|---------|
| A | –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ | –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | 05.10.2025 |
| B | –ù–∞–∑–≤–∞–Ω–∏–µ | –ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏ | –°–∫–∏–¥–∫–∞ 20% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ |
| C | –û–ø–∏—Å–∞–Ω–∏–µ | –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ | –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ |
| D | –°—Ç–∞—Ç—É—Å | –°—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | –ê–∫—Ç–∏–≤–Ω–∞, –û–∂–∏–¥–∞–µ—Ç, –ó–∞–∫–æ–Ω—á–µ–Ω–∞ |
| E | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ | –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –∞–∫—Ü–∏–∏ | 05.10.2025 |
| F | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è | –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–∫—Ü–∏–∏ | 31.10.2025 |
| G | –ö–æ–Ω—Ç–µ–Ω—Ç | –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç | 123 |
| H | –î–µ–π—Å—Ç–≤–∏–µ | –ö–Ω–æ–ø–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å |

**–°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã** –∏–∑ URL.

### 4. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ Service Account

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞–∂–¥—É—é —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
2. –ù–∞–∂–º–∏—Ç–µ **Share** (–ü–æ–¥–µ–ª–∏—Ç—å—Å—è)
3. –í—Å—Ç–∞–≤—å—Ç–µ email Service Account (–∏–∑ JSON —Ñ–∞–π–ª–∞)
4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: **Editor**
5. –ù–∞–∂–º–∏—Ç–µ **Send**

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç A: JSON –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –í —Ñ–∞–π–ª–µ .env
GCP_SA_JSON={"type":"service_account","project_id":"your-project",...}
SHEET_ID=your_authorization_sheet_id
APPEALS_SHEET_ID=your_appeals_sheet_id
PROMOTIONS_SHEET_ID=your_promotions_sheet_id
```

### –í–∞—Ä–∏–∞–Ω—Ç B: JSON —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫–µ

```bash
# –í —Ñ–∞–π–ª–µ .env
GCP_SA_FILE=/path/to/your/service-account.json
SHEET_ID=your_authorization_sheet_id
APPEALS_SHEET_ID=your_appeals_sheet_id
PROMOTIONS_SHEET_ID=your_promotions_sheet_id
```

## ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Apps Script –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

### 1. –û—Ç–∫—Ä—ã—Ç–∏–µ Apps Script

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –∞–∫—Ü–∏–π
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–†–∞—Å—à–∏—Ä–µ–Ω–∏—è** ‚Üí **Apps Script**

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–¥–∞

1. –£–¥–∞–ª–∏—Ç–µ –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ `docs/GOOGLE_APPS_SCRIPT_CODE.js`
3. –í—Å—Ç–∞–≤—å—Ç–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä Apps Script

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞:

```javascript
const CONFIG = {
  // URL –≤–∞—à–µ–≥–æ webhook —Å–µ—Ä–≤–µ—Ä–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω)
  WEBHOOK_URL: 'https://your-domain.pythonanywhere.com/webhook',
  
  // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  WEBHOOK_SECRET: 'your_secret_key_here',
  
  // ID –ª–∏—Å—Ç–∞ —Å –∞–∫—Ü–∏—è–º–∏
  SHEET_NAME: '–ê–∫—Ü–∏–∏',
  
  // –ù–æ–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–æ–∫ (A=1, B=2, C=3, D=4, E=5, F=6, G=7, H=8)
  COLUMNS: {
    RELEASE_DATE: 1,    // A - –î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞
    TITLE: 2,           // B - –ù–∞–∑–≤–∞–Ω–∏–µ
    DESCRIPTION: 3,     // C - –û–ø–∏—Å–∞–Ω–∏–µ
    STATUS: 4,          // D - –°—Ç–∞—Ç—É—Å
    START_DATE: 5,      // E - –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
    END_DATE: 6,        // F - –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
    CONTENT: 7,         // G - –ö–æ–Ω—Ç–µ–Ω—Ç
    ACTION: 8           // H - –î–µ–π—Å—Ç–≤–∏–µ
  }
};
```

### 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç (Ctrl+S)
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `setupTrigger` –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
3. –ù–∞–∂–º–∏—Ç–µ **–í—ã–ø–æ–ª–Ω–∏—Ç—å**
4. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `createPublishButtons`
5. –ù–∞–∂–º–∏—Ç–µ **–í—ã–ø–æ–ª–Ω–∏—Ç—å**

## üîÑ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### –ü–æ—Ç–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–π:

1. **–°–æ—Ç—Ä—É–¥–Ω–∏–∫** –∑–∞–ø–æ–ª–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ü–∏–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
2. **–í –∫–æ–ª–æ–Ω–∫–µ H** –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"
3. **–°–æ—Ç—Ä—É–¥–Ω–∏–∫** –Ω–∞–∂–∏–º–∞–µ—Ç "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"
4. **Google Apps Script** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å "–ê–∫—Ç–∏–≤–Ω–∞"
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞—Ç—É —Ä–µ–ª–∏–∑–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
   - –û—á–∏—â–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç
5. **–ë–æ—Ç** –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

### –ü–æ—Ç–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ü–∏–π:

1. **–°–æ—Ç—Ä—É–¥–Ω–∏–∫** –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∞–∫—Ü–∏–∏
2. **Google Apps Script** –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è** webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
4. **–ë–æ—Ç** —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### 1. –õ–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets
python3 -c "from sheets import _load_service_account; print('Google Sheets –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
python3 -c "from auth_service import AuthService; auth = AuthService(); print('AuthService —Ä–∞–±–æ—Ç–∞–µ—Ç!')"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ü–∏–π
python3 -c "from promotions_api import get_active_promotions; print('Promotions API —Ä–∞–±–æ—Ç–∞–µ—Ç!')"
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Apps Script

1. –í Apps Script –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `testPublishPromotion`
2. –ù–∞–∂–º–∏—Ç–µ **–í—ã–ø–æ–ª–Ω–∏—Ç—å**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ webhook —Å–µ—Ä–≤–µ—Ä:
   ```bash
   python3 webhook_handler.py
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ª–æ–≥–∞—Ö

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. **–ù–µ —Ö—Ä–∞–Ω–∏—Ç–µ JSON –∫–ª—é—á–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏**
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –¥–ª—è –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –ø—Ä–∞–≤–∞ Service Account** —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏** –¥–ª—è webhook
5. **–†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏** Service Account

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞:

```bash
# –í .env –¥–æ–±–∞–≤—å—Ç–µ
WEBHOOK_SECRET=your_very_secure_secret_key_here
```

## üêõ –û—Ç–ª–∞–¥–∫–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

#### 1. "Permission denied" –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ Sheets
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Service Account –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: Email –∏–∑ JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ç–∞–±–ª–∏—Ü—ã

#### 2. "Sheet not found" –æ—à–∏–±–∫–∞
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å SHEET_ID –≤ .env
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: ID –±–µ—Ä–µ—Ç—Å—è –∏–∑ URL —Ç–∞–±–ª–∏—Ü—ã

#### 3. Apps Script –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω –≤ Apps Script
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –¢—Ä–∏–≥–≥–µ—Ä—ã ‚Üí —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä onEdit

#### 4. Webhook –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
- **–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ POST –∑–∞–ø—Ä–æ—Å—ã

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```bash
# –õ–æ–≥–∏ Google Apps Script
# –í Apps Script: –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è ‚Üí –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

# –õ–æ–≥–∏ webhook —Å–µ—Ä–≤–µ—Ä–∞
tail -f webhook_handler.log

# –õ–æ–≥–∏ –±–æ—Ç–∞
tail -f bot.log
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–π** –≤ –¥–µ–Ω—å
2. **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞—â–µ–Ω–∏–π** –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
3. **–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –∞–∫—Ü–∏–π** (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã)
4. **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞** —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤
5. **–û—à–∏–±–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** —Å Google Sheets

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

```python
# –í –∫–æ–¥–µ –¥–æ–±–∞–≤—å—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
import logging

logger = logging.getLogger(__name__)

def log_metric(metric_name, value):
    logger.info(f"METRIC: {metric_name}={value}")
```

## üöÄ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
2. **–ë–∞—Ç—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Sheets
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
4. **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã** –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Google Sheets API

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:

```python
# –í auth_service.py —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 5 –º–∏–Ω—É—Ç
CACHE_TTL_MINUTES = 5
```

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** v3.2  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 9 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–æ

================================================================================
FILE: ./docs/guides/UPDATE_GOOGLE_APPS_SCRIPT_WEBHOOK.md
SIZE: 6838 bytes
================================================================================

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é Google Apps Script –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –í–∞–∂–Ω–æ

–î–ª—è —Ä–∞–±–æ—Ç—ã –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –≤ Google Apps Script.

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### 1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª —Å –∫–æ–¥–æ–º

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `GOOGLE_APPS_SCRIPT_FULL.js` –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
- –õ–æ–∫–∞–ª—å–Ω–æ: `/Users/verakoroleva/Desktop/marketingbot/GOOGLE_APPS_SCRIPT_FULL.js`
- –ù–∞ GitHub: `https://github.com/synthosaicreativestudio-maker/marketing/blob/main/GOOGLE_APPS_SCRIPT_FULL.js`

### 2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–µ—Å—å –∫–æ–¥

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ **–≤–µ—Å—å** –∫–æ–¥ –∏–∑ —Ñ–∞–π–ª–∞ `GOOGLE_APPS_SCRIPT_FULL.js` (Ctrl+A / Cmd+A, –∑–∞—Ç–µ–º Ctrl+C / Cmd+C).

### 3. –û—Ç–∫—Ä–æ–π—Ç–µ Google Apps Script

1. –û—Ç–∫—Ä–æ–π—Ç–µ Google Sheets —Å –∞–∫—Ü–∏—è–º–∏
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script** (Extensions ‚Üí Apps Script)

### 4. –í—Å—Ç–∞–≤—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥

1. –í—ã–¥–µ–ª–∏—Ç–µ –≤–µ—Å—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ (Ctrl+A / Cmd+A)
2. –£–¥–∞–ª–∏—Ç–µ –µ–≥–æ (Delete)
3. –í—Å—Ç–∞–≤—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ (Ctrl+V / Cmd+V)

### 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã:

```javascript
// Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const WEBHOOK_URL = 'http://158.160.0.127:8080/webhook/promotions';
const WEBHOOK_SECRET = 'default_secret'; // –î–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å WEBHOOK_SECRET –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```

**–í–∞–∂–Ω–æ:** `WEBHOOK_SECRET` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `WEBHOOK_SECRET` –≤ —Ñ–∞–π–ª–µ `.env` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 6. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç

–ù–∞–∂–º–∏—Ç–µ **Ctrl+S** (Windows/Linux) –∏–ª–∏ **Cmd+S** (Mac) –∏–ª–∏ –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–¥–∏—Å–∫–µ—Ç–∞).

### 7. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω

–í –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" (Saved) –∏–ª–∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook endpoint

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
```
http://158.160.0.127:8080/webhook/promotions
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å—Å—è JSON —Å–æ–æ–±—â–µ–Ω–∏–µ:
```json
{
  "status": "webhook_active",
  "message": "Webhook endpoint –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–π",
  "method": "POST",
  "url": "/webhook/promotions",
  "note": "–≠—Ç–æ—Ç endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å POST –∑–∞–ø—Ä–æ—Å–∞–º–∏..."
}
```

### 2. –¢–µ—Å—Ç–æ–≤–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∞–∫—Ü–∏–∏

1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∞–∫—Ü–∏—é –≤ Google Sheets
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
   - **–ù–∞–∑–≤–∞–Ω–∏–µ**
   - **–û–ø–∏—Å–∞–Ω–∏–µ**
   - **–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞**
   - **–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è**
3. –í —Å—Ç–æ–ª–±—Ü–µ **"–î–µ–π—Å—Ç–≤–∏–µ"** –≤—ã–±–µ—Ä–∏—Ç–µ **"–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å"**
4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** –≤ Telegram —á–∞—Ç

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

**–í Google Apps Script:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–í–∏–¥ ‚Üí –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** (View ‚Üí Execution log)
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –∞–∫—Ü–∏–∏
3. –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:
   ```
   Webhook response code: 200
   Webhook response: {"status":"success"}
   ‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –¥–ª—è –∞–∫—Ü–∏–∏: [–Ω–∞–∑–≤–∞–Ω–∏–µ –∞–∫—Ü–∏–∏]
   ```

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
ssh ubuntu@158.160.0.127
journalctl -u marketingbot-web.service -f
```

–î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:
```
–ü–æ–ª—É—á–µ–Ω webhook –æ—Ç Google Sheets: {...}
```

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ –µ—â–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥ –≤ Google Apps Script:**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `sendWebhookNotification()` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `handlePublish()` –≤—ã–∑—ã–≤–∞–µ—Ç `sendWebhookNotification(promotionData)`
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã `WEBHOOK_URL` –∏ `WEBHOOK_SECRET` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Google Apps Script:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ **–í–∏–¥ ‚Üí –õ–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**
   - –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –∞–∫—Ü–∏–∏
   - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏, –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ WEBHOOK_SECRET:**
   - –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: `grep WEBHOOK_SECRET /home/ubuntu/marketingbot/.env`
   - –í Google Apps Script: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `'default_secret'`
   - –ó–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã **—Å–æ–≤–ø–∞–¥–∞—Ç—å**

### –û—à–∏–±–∫–∞ "Could not fetch" –≤ Google Apps Script

Google Apps Script –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º IP –∞–¥—Ä–µ—Å–∞–º.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Cloudflare Tunnel –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É

### Webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 401 (Unauthorized)

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–≤–µ—Ä–Ω—ã–π `WEBHOOK_SECRET`.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `WEBHOOK_SECRET` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   ```bash
   grep WEBHOOK_SECRET /home/ubuntu/marketingbot/.env
   ```
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Google Apps Script –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ –∂–µ –∑–Ω–∞—á–µ–Ω–∏–µ
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å webhook:
   ```bash
   sudo systemctl restart marketingbot-web.service
   ```

### Webhook –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É 500 (Internal Server Error)

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞:
   ```bash
   journalctl -u marketingbot-web.service -n 50
   ```
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω:
   ```bash
   sudo systemctl status marketingbot-web.service
   ```
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:
   ```bash
   sudo systemctl status marketingbot.service
   ```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –≤ Google Apps Script, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ** –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∞–∫—Ü–∏–∏, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ 15 –º–∏–Ω—É—Ç.

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ï—Å–ª–∏ –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ `WEBHOOK_SECRET` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –∏ –≤ Google Apps Script.


================================================================================
FILE: ./docs/deployment/DEPLOYMENT_PYTHONANYWHERE.md
SIZE: 2106 bytes
================================================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Web App –Ω–∞ PythonAnywhere –¥–ª—è REST API

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ Web App (–µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)

1. –í –ø–∞–Ω–µ–ª–∏ PythonAnywhere –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Web**
2. –ù–∞–∂–º–∏—Ç–µ **"Add a new web app"**
3. –í—ã–±–µ—Ä–∏—Ç–µ **Python 3.10**
4. –í—ã–±–µ—Ä–∏—Ç–µ **Manual configuration**
5. –ù–∞–∂–º–∏—Ç–µ **Next**

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WSGI —Ñ–∞–π–ª–∞

1. –í —Ä–∞–∑–¥–µ–ª–µ **Code** –Ω–∞–π–¥–∏—Ç–µ **WSGI configuration file**
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. –ó–∞–º–µ–Ω–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–∞:

```python
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
path = '/home/SynthosAI/marketing'
if path not in sys.path:
    sys.path.insert(0, path)

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
os.environ.setdefault('DATABASE_URL', 'sqlite:///./db/appeals.db')

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
from api.main import app

# –î–ª—è PythonAnywhere WSGI
application = app
```

4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Static files –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏

1. –í —Ä–∞–∑–¥–µ–ª–µ **Static files** –Ω–∞–∂–º–∏—Ç–µ **Add a new mapping**
2. URL: `/admin/`
3. Directory: `/home/SynthosAI/marketing/admin/`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

1. –ù–∞–∂–º–∏—Ç–µ –∑–µ–ª–µ–Ω—É—é –∫–Ω–æ–ø–∫—É **"Reload SynthosAI.pythonanywhere.com"**

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:
- API: `https://SynthosAI.pythonanywhere.com/docs`
- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: `https://SynthosAI.pythonanywhere.com/admin/`

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Web App

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å Web App (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è webhook_handler.py), –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å FastAPI –≤ —Ç–æ—Ç –∂–µ WSGI —Ñ–∞–π–ª –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint.

---

**–í–∞–∂–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç–µ `/home/SynthosAI/marketing` –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É!


================================================================================
FILE: ./docs/deployment/DEPLOYMENT_YANDEX.md
SIZE: 13575 bytes
================================================================================

# üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ MarketingBot v3.2

–í —ç—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –æ–ø–∏—Å–∞–Ω—ã –≤—Å–µ —à–∞–≥–∏ ‚Äî –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ PythonAnywhere —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –¥–µ–ø–ª–æ–µ–º WebApp –Ω–∞ GitHub Pages.

## üñ•Ô∏è –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
```bash
git clone <repository-url>
cd marketingbot
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv .venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Linux/Mac)
source .venv/bin/activate

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è (Windows)
.venv\Scripts\activate
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ pip
pip install -r requirements.txt
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
cp .env.example .env

# –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
# –£–∫–∞–∂–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º TELEGRAM_TOKEN
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è v3.2:**
```bash
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI (–¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞)
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ–±—Ä–∞—â–µ–Ω–∏–π –∏ –∞–∫—Ü–∏–π)
SHEET_ID=authorization_sheet_id
APPEALS_SHEET_ID=appeals_sheet_id
PROMOTIONS_SHEET_ID=promotions_sheet_id
SHEET_NAME=authorization_sheet_name
APPEALS_SHEET_NAME=–æ–±—Ä–∞—â–µ–Ω–∏—è
GCP_SA_FILE=path_to_credentials.json

# WebApp (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –º–µ–Ω—é)
WEB_APP_URL=https://your-domain.github.io/marketing/
WEBHOOK_URL=https://your-domain.pythonanywhere.com/webhook
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞), B (–¢–µ–ª–µ—Ñ–æ–Ω), C (–§–ò–û), D (Telegram ID), E (–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏), F (–î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `SHEET_ID`

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞), B (–¢–µ–ª–µ—Ñ–æ–Ω), C (–§–ò–û), D (Telegram ID), E (–¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π), F (–°—Ç–∞—Ç—É—Å), G (–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞), H (–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `APPEALS_SHEET_ID`

**–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∞–∫—Ü–∏–π:**
1. –°–æ–∑–¥–∞–π—Ç–µ Google Sheet —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: A (–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞), B (–ù–∞–∑–≤–∞–Ω–∏–µ), C (–û–ø–∏—Å–∞–Ω–∏–µ), D (–°—Ç–∞—Ç—É—Å), E (–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞), F (–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è)
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ `PROMOTIONS_SHEET_ID`

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Service Account:**
1. –°–æ–∑–¥–∞–π—Ç–µ Service Account –≤ Google Cloud Console
2. –°–∫–∞—á–∞–π—Ç–µ JSON –∫–ª—é—á –∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –≤ `GCP_SA_FILE`
3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º –¥–ª—è email –∏–∑ JSON –∫–ª—é—á–∞

### 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI Assistant

**–°–æ–∑–¥–∞–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:**
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ OpenAI Playground
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞
3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ `OPENAI_ASSISTANT_ID`

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ WebApp

**–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ WebApp:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
ls -la index.html menu.html app.js

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ URL –≤ .env
WEB_APP_URL=https://your-domain.com/
```

### 8. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫
python3 bot.py

# –ó–∞–ø—É—Å–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
python3 bot.py 2>&1 | tee bot.log

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ
nohup python3 bot.py > bot.log 2>&1 &
```

## üåê –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ WebApp –Ω–∞ GitHub Pages

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π WebApp

WebApp (Mini App) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ GitHub Pages –ø—Ä–∏ –∫–∞–∂–¥–æ–º push –≤ –≤–µ—Ç–∫—É `main`.

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Pages:

1. **–í–∫–ª—é—á–∏—Ç–µ GitHub Pages –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**
   - Settings ‚Üí Pages
   - Source: GitHub Actions
   - –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

2. **–§–∞–π–ª `.github/workflows/deploy.yml` —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
   ```yaml
   name: Deploy to GitHub Pages
   
   on:
     push:
       branches: ["main"]
     workflow_dispatch:
   
   jobs:
     deploy:
       runs-on: ubuntu-latest
       steps:
         - name: Checkout
           uses: actions/checkout@v4
         - name: Setup Pages
           uses: actions/configure-pages@v4
         - name: Prepare files for deployment
           run: |
             mkdir -p /tmp/deploy
             cp index.html /tmp/deploy/
             cp menu.html /tmp/deploy/
             cp app.js /tmp/deploy/
         - name: Upload artifact
           uses: actions/upload-pages-artifact@v3
           with:
             path: /tmp/deploy
         - name: Deploy to GitHub Pages
           uses: actions/deploy-pages@v4
   ```

3. **URL WebApp –±—É–¥–µ—Ç:**
   ```
   https://your-username.github.io/marketing/
   ```

4. **–û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `WEB_APP_URL` –≤ `.env`:**
   ```env
   WEB_APP_URL=https://your-username.github.io/marketing/
   ```

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ WebApp —Ñ–∞–π–ª–æ–≤:
- **`index.html`** - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤
- **`menu.html`** - –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç —Å –∞–∫—Ü–∏—è–º–∏ –∏ —Å–æ–±—ã—Ç–∏—è–º–∏
- **`app.js`** - JavaScript –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram WebApp API

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebApp:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start` –±–æ—Ç—É
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç"
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ü–∏–π

---

## üê≥ Docker —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (–¥–ª—è Production)

Docker ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω .env —Ñ–∞–π–ª
cp .env.example .env
nano .env
```

### 2. –ó–∞–ø—É—Å–∫ —Å Docker Compose
```bash
# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

## ‚òÅÔ∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ PythonAnywhere (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–û–ï)

PythonAnywhere - –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –¥–ª—è Python Telegram –±–æ—Ç–æ–≤ —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º HTTPS –∏ –ø—Ä–æ—Å—Ç–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π.

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [pythonanywhere.com](https://www.pythonanywhere.com)
2. –í—ã–±–µ—Ä–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ç–∞—Ä–∏—Ñ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è MVP)

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ PythonAnywhere
git clone https://github.com/synthosaicreativestudio-maker/marketing.git
cd marketing
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–ª—è Python 3.13 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
pip3 install --user -r requirements.txt

# –ò–ª–∏ –¥–ª—è Python 3.10
pip3.10 install --user -r requirements.txt
```

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞
cp .env.example .env
nano .env
```

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è PythonAnywhere:**
```bash
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets
SHEET_ID=authorization_sheet_id
APPEALS_SHEET_ID=appeals_sheet_id
PROMOTIONS_SHEET_ID=promotions_sheet_id
GCP_SA_JSON={"type": "service_account", ...}

# WebApp
WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/
WEBHOOK_URL=https://yourusername.pythonanywhere.com/webhook
```

### 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Web App
1. –í –ø–∞–Ω–µ–ª–∏ PythonAnywhere –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Web"
2. –ù–∞–∂–º–∏—Ç–µ "Add a new web app"
3. –í—ã–±–µ—Ä–∏—Ç–µ "Flask" –∏ Python 3.10
4. –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å: `/home/yourusername/marketing/webhook_handler.py`
5. –ù–∞–∂–º–∏—Ç–µ "Reload"

### 6. –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
```bash
# –í –∫–æ–Ω—Å–æ–ª–∏ PythonAnywhere
python3 bot.py
```

### 7. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ "Tasks"
# –ö–æ–º–∞–Ω–¥–∞: python3 /home/yourusername/marketing/bot.py
# –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏ —Å–±–æ—è—Ö)
```

## ‚òÅÔ∏è –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–µ (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)

### Google Cloud Run
```bash
# –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞
gcloud builds submit --tag gcr.io/PROJECT_ID/marketingbot

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
gcloud run deploy marketingbot \
  --image gcr.io/PROJECT_ID/marketingbot \
  --platform managed \
  --region us-central1 \
  --set-env-vars TELEGRAM_TOKEN=your-token \
  --no-allow-unauthenticated
```

## üö® –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ `gspread` –∏–ª–∏ `dotenv`:
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ `pip install -r requirements.txt`.

### –ë–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `TELEGRAM_TOKEN` –≤ `.env`.
2.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.
3.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.

### –û—à–∏–±–∫–∏ WebApp:
1.  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `WEB_APP_URL` –≤ `.env` —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω.
2.  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã `index.html` –∏ `menu.html` –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ URL.

### –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–∏—Å—Ç–µ–º–æ–π –æ–±—Ä–∞—â–µ–Ω–∏–π:
1. **–°—Ç–∞—Ç—É—Å –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ Service Account –∫ —Ç–∞–±–ª–∏—Ü–µ –æ–±—Ä–∞—â–µ–Ω–∏–π
2. **–≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `_is_user_escalation_request()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **–û—Ç–≤–µ—Ç—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É ResponseMonitor –≤ –ª–æ–≥–∞—Ö

### –ü—Ä–æ–±–ª–µ–º—ã —Å OpenAI:
1. **–û—à–∏–±–∫–∏ API**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `OPENAI_API_KEY` –∏ `OPENAI_ASSISTANT_ID`
2. **–ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å –∞–∫–∫–∞—É–Ω—Ç–∞ OpenAI
3. **–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã**: –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è OpenAI API (2-10 —Å–µ–∫—É–Ω–¥)

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π:
1. **–ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ –º–µ–Ω—é**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å `WEB_APP_URL` –∏ —Ä–∞–±–æ—Ç—É —Ñ—É–Ω–∫—Ü–∏–∏ `get_spa_menu_url()`
2. **–ü–∞—Ä—Ç–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω**: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
3. **–û—à–∏–±–∫–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è**: –£–¥–∞–ª–∏—Ç–µ —Ñ–∞–π–ª `auth_cache.json` –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫—ç—à–∞

## üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ v3.1

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
python3 -c "
import os
from dotenv import load_dotenv
load_dotenv()

print('=== –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MarketingBot v3.1 ===')
print(f'Telegram Token: {\"‚úì\" if os.getenv(\"TELEGRAM_TOKEN\") else \"‚úó\"}')
print(f'OpenAI API Key: {\"‚úì\" if os.getenv(\"OPENAI_API_KEY\") else \"‚úó\"}')
print(f'OpenAI Assistant ID: {\"‚úì\" if os.getenv(\"OPENAI_ASSISTANT_ID\") else \"‚úó\"}')
print(f'Sheets ID: {\"‚úì\" if os.getenv(\"SHEET_ID\") else \"‚úó\"}')
print(f'Appeals Sheets ID: {\"‚úì\" if os.getenv(\"APPEALS_SHEET_ID\") else \"‚úó\"}')
print(f'WebApp URL: {os.getenv(\"WEB_APP_URL\", \"‚úó\")}')
print(f'GCP SA File: {\"‚úì\" if os.getenv(\"GCP_SA_FILE\") else \"‚úó\"}')
"
```

### –¢–µ—Å—Ç –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
```bash
# –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —ç—Å–∫–∞–ª–∞—Ü–∏–∏
python3 -c "
from handlers import _is_user_escalation_request
test_phrases = ['–∞ –≤—ã –º–Ω–µ –ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ?', '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '–ø—Ä–∏–≤–µ—Ç']
for phrase in test_phrases:
    result = _is_user_escalation_request(phrase)
    print(f'{phrase}: {\"–≠—Å–∫–∞–ª–∞—Ü–∏—è\" if result else \"–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\"}')
"

# –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ URL
python3 -c "
from handlers import get_web_app_url, get_spa_menu_url
print(f'Auth URL: {get_web_app_url()}')
print(f'Menu URL: {get_spa_menu_url()}')
"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã:
```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail -f bot.log | grep -E "(—ç—Å–∫–∞–ª–∞—Ü–∏—è|—Å—Ç–∞—Ç—É—Å|–∑–∞–ª–∏–≤–∫–∞|WebApp)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã ResponseMonitor
grep -i "response_monitor" bot.log | tail -10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–æ–≤
grep -i "—Å—Ç–∞—Ç—É—Å.*—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\|—Å—Ç–∞—Ç—É—Å.*–æ–±–Ω–æ–≤–ª–µ–Ω" bot.log | tail -10
```


================================================================================
FILE: ./docs/reference/API_REFERENCE.md
SIZE: 18944 bytes
================================================================================

# API Reference - MarketingBot v3.0

## –û–±–∑–æ—Ä API

MarketingBot v3.0 –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∞–±–æ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å OpenAI Assistant.

## AuthService

### –ú–µ—Ç–æ–¥—ã

#### `get_user_auth_status(telegram_id: int) -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, False –∏–Ω–∞—á–µ

**–ü—Ä–∏–º–µ—Ä**:
```python
auth_service = AuthService()
is_authorized = auth_service.get_user_auth_status(123456789)
```

#### `find_and_update_user(partner_code: str, partner_phone: str, telegram_id: int) -> bool`
–ò—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∫–æ–¥—É –∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É, –æ–±–Ω–æ–≤–ª—è–µ—Ç Telegram ID.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `partner_code` (str): –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- `partner_phone` (str): –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –∏ –æ–±–Ω–æ–≤–ª–µ–Ω

**–ü—Ä–∏–º–µ—Ä**:
```python
success = auth_service.find_and_update_user("12345", "89123456789", 123456789)
```

#### `force_check_auth_status(telegram_id: int) -> bool`
–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∫—ç—à.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω

## OpenAIService

### –ú–µ—Ç–æ–¥—ã

#### `is_enabled() -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∫–ª—é—á–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å OpenAI.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω

#### `ask(user_id: int, message: str) -> str`
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É –∏ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `user_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `message` (str): –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `str`: –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

**–ü—Ä–∏–º–µ—Ä**:
```python
openai_service = OpenAIService()
response = openai_service.ask(123456789, "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?")
```

#### `get_or_create_thread(user_id: int) -> str`
–ü–æ–ª—É—á–∞–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞–µ—Ç Thread –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `user_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `str`: ID Thread

## AppealsService

### –ú–µ—Ç–æ–¥—ã

#### `is_available() -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω

#### `create_appeal(code: str, phone: str, fio: str, telegram_id: int, text: str) -> bool`
–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `code` (str): –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- `phone` (str): –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- `fio` (str): –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `text` (str): –¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ

**–ü—Ä–∏–º–µ—Ä**:
```python
appeals_service = AppealsService()
success = appeals_service.create_appeal(
    code="12345",
    phone="89123456789",
    fio="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á",
    telegram_id=123456789,
    text="–£ –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –æ–±—ä–µ–∫—Ç–∞"
)
```

#### `set_status_in_work(telegram_id: int) -> bool`
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è "–≤ —Ä–∞–±–æ—Ç–µ".

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

#### `get_appeal_status(telegram_id: int) -> str`
–ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `str`: –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è (–Ω–æ–≤–æ–µ/–≤ —Ä–∞–±–æ—Ç–µ/—Ä–µ—à–µ–Ω–æ)

#### `check_for_responses() -> List[Dict]`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `List[Dict]`: –°–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞**:
```python
{
    'row': int,           # –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
    'telegram_id': str,   # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    'response': str,      # –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
    'code': str,          # –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
    'fio': str            # –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞
}
```

#### `clear_response(row: int) -> bool`
–û—á–∏—â–∞–µ—Ç —è—á–µ–π–∫—É —Å –æ—Ç–≤–µ—Ç–æ–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `row` (int): –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ —è—á–µ–π–∫–∞ –æ—á–∏—â–µ–Ω–∞

#### `add_specialist_response(telegram_id: int, response_text: str) -> bool`
–î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∫ –æ–±—Ä–∞—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `response_text` (str): –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω

#### `has_records() -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏

#### `get_user_appeals(telegram_id: int) -> List[Dict]`
–ü–æ–ª—É—á–∞–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `List[Dict]`: –°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## ResponseMonitor

### –ú–µ—Ç–æ–¥—ã

#### `start()`
–ó–∞–ø—É—Å–∫–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤.

#### `stop()`
–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤.

#### `send_test_response(telegram_id: int, test_message: str)`
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `telegram_id` (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `test_message` (str): –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

## Handlers

### –§—É–Ω–∫—Ü–∏–∏

#### `create_main_menu_keyboard() -> ReplyKeyboardMarkup`
–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–µ –º–µ–Ω—é —Å –æ–ø—Ü–∏—è–º–∏.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `ReplyKeyboardMarkup`: –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏

**–ö–Ω–æ–ø–∫–∏**:
- "üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
- "ü§ñ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º"

## WebApp (menu.html)

### JavaScript —Ñ—É–Ω–∫—Ü–∏–∏

#### `toggleServiceCategory(categoryId: string) -> void`
–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ –≤ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–µ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `categoryId` (string): ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
- –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Å—Ç—Ä–µ–ª–∫–∏)
- –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è/–∑–∞–∫—Ä—ã—Ç–∏—è

**–ü—Ä–∏–º–µ—Ä**:
```javascript
// –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π"
toggleServiceCategory('social-content');

// –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–î–∏–∑–∞–π–Ω –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥"
toggleServiceCategory('design');
```

#### `showSection(sectionId: string) -> void`
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—É—é —Å–µ–∫—Ü–∏—é –≤ WebApp.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `sectionId` (string): ID —Å–µ–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–µ–∫—Ü–∏–∏**:
- `'promotions'` - –ê–∫—Ü–∏–∏ –∏ —Å–æ–±—ã—Ç–∏—è
- `'tools'` - –ü–æ–ª–µ–∑–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- `'analytics'` - –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù
- `'knowledge'` - –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
- `'services'` - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã

#### `showMainMenu() -> void`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –≥–ª–∞–≤–Ω–æ–º—É –º–µ–Ω—é WebApp.

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- –°–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ —Å–µ–∫—Ü–∏–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å 5 —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
- –°–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ Telegram

### HTML —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

#### –°–µ–∫—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª—É–≥:
```html
<div id="services-section" class="content-section">
    <button class="back-button" onclick="showMainMenu()">
        ‚Üê –ù–∞–∑–∞–¥ –∫ –º–µ–Ω—é
    </button>
    <h2 class="section-title">üéØ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã</h2>
    <div class="section-content">
        <div class="services-accordion">
            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å–ª—É–≥ -->
        </div>
    </div>
</div>
```

#### –ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥:
```html
<div class="service-category">
    <button class="service-category-header" onclick="toggleServiceCategory('category-id')">
        <span class="service-category-icon">üì±</span>
        <span class="service-category-title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</span>
        <span class="service-category-arrow">‚ñº</span>
    </button>
    <div class="service-category-content" id="category-id">
        <ul class="service-list">
            <li>–£—Å–ª—É–≥–∞ 1</li>
            <li>–£—Å–ª—É–≥–∞ 2</li>
        </ul>
    </div>
</div>
```

### CSS –∫–ª–∞—Å—Å—ã

#### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:
- `.services-accordion` - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
- `.service-category` - –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ª—É–≥
- `.service-category-header` - –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∫–Ω–æ–ø–∫–∞)
- `.service-category-content` - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `.service-list` - —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

#### –°–æ—Å—Ç–æ—è–Ω–∏—è:
- `.service-category-header.active` - –∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
- `.service-category-content.active` - –æ—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
- `.service-category-arrow` - —Å—Ç—Ä–µ–ª–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram WebApp

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
```javascript
let tg = window.Telegram.WebApp;
tg.ready();
tg.expand();
```

#### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º—ã:
```javascript
function updateTheme() {
    const root = document.documentElement;
    root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
    root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
    // ... –¥—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
}
```

#### –ù–∞–≤–∏–≥–∞—Ü–∏—è:
```javascript
// –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ —Å–µ–∫—Ü–∏—é
function showBackButton() {
    tg.BackButton.show();
}

// –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
function hideBackButton() {
    tg.BackButton.hide();
}
```

#### `_is_user_escalation_request(text: str) -> bool`
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å –µ–≥–æ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ñ—Ä–∞–∑–∞–º.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `text` (str): –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞

**–ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã**:
- "–ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ", "–Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–º–æ—á—å"
- "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω—É–∂–µ–Ω", "–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç"
- "—á–µ–ª–æ–≤–µ–∫ –Ω—É–∂–µ–Ω", "–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫"
- "—Å–æ–µ–¥–∏–Ω–∏—Ç–µ", "–ø–æ–∑–≤–æ–Ω–∏—Ç—å", "–∑–≤–æ–Ω–æ–∫"
- "–ø—Ä–æ–±–ª–µ–º–∞", "–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è", "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
- "—Å–ª–æ–∂–Ω–æ", "–Ω–µ –ø–æ–Ω–∏–º–∞—é", "–æ–±—ä—è—Å–Ω–∏—Ç–µ"

**–ü—Ä–∏–º–µ—Ä**:
```python
if _is_user_escalation_request("–∞ –≤—ã –º–Ω–µ –ø–æ–º–æ—á—å –Ω–µ –º–æ–∂–µ—Ç–µ?"):
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —ç—Å–∫–∞–ª–∞—Ü–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É
    appeals_service.set_status_in_work(user.id)
```

#### `_should_show_specialist_button(text: str) -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `text` (str): –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `bool`: True –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

#### `start_command_handler(auth_service: AuthService)`
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start.

#### `web_app_data_handler(auth_service: AuthService)`
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ WebApp.

#### `chat_handler(auth_service: AuthService, openai_service: OpenAIService, appeals_service: AppealsService)`
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

#### `appeals_command_handler(auth_service: AuthService, appeals_service: AppealsService)`
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /appeals.

#### `callback_query_handler(auth_service: AuthService, appeals_service: AppealsService)`
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback queries (–∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏).

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### Telegram
- `TELEGRAM_TOKEN`: –¢–æ–∫–µ–Ω –±–æ—Ç–∞
- `ADMIN_TELEGRAM_ID`: ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

#### OpenAI
- `OPENAI_API_KEY`: API –∫–ª—é—á OpenAI
- `OPENAI_ASSISTANT_ID`: ID –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

#### Google Sheets
- `SHEET_ID`: ID —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `APPEALS_SHEET_ID`: ID —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π
- `SHEET_NAME`: –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `APPEALS_SHEET_NAME`: –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
- `GCP_SA_FILE`: –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É Service Account

#### WebApp
- `WEB_APP_URL`: –ë–∞–∑–æ–≤—ã–π URL WebApp (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –º–µ–Ω—é)
- `WEB_APP_MENU_URL`: URL WebApp –º–µ–Ω—é (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ WEB_APP_URL + "menu.html")

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

#### –¢–∞–±–ª–∏—Ü–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
| –ö–æ–ª–æ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø |
|---------|----------|-----|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String |
| B | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String |
| C | –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String |
| D | Telegram ID | String |
| E | –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | String |
| F | –î–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | DateTime |

#### –¢–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π
| –ö–æ–ª–æ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–∏–ø | –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è |
|---------|----------|-----|-------------------|
| A | –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String | - |
| B | –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String | - |
| C | –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ | String | - |
| D | Telegram ID | String | - |
| E | –¢–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π | Multi-line String | - |
| F | –°—Ç–∞—Ç—É—Å | Enum | –ë–µ–∑ —Ü–≤–µ—Ç–∞ / #f4cccc (–∫—Ä–∞—Å–Ω–∞—è) / #d9ead3 (–∑–µ–ª–µ–Ω–∞—è) / –±–µ–ª—ã–π (–ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏) |
| G | –û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ | String | - |
| H | –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | DateTime | - |

**–°—Ç–∞—Ç—É—Å—ã –æ–±—Ä–∞—â–µ–Ω–∏–π**:
- `–Ω–æ–≤–æ–µ` - –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ (–±–µ–∑ –∑–∞–ª–∏–≤–∫–∏)
- `–≤ —Ä–∞–±–æ—Ç–µ` - –ø–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É (#f4cccc - –∫—Ä–∞—Å–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞)
- `—Ä–µ—à–µ–Ω–æ` - —Ä–µ—à–µ–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º (#d9ead3 - –∑–µ–ª–µ–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞)
- –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ - —Å—Ç–∞—Ç—É—Å "—Ä–µ—à–µ–Ω–æ" + –±–µ–ª–∞—è –∑–∞–ª–∏–≤–∫–∞

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –∏—Å–∫–ª—é—á–µ–Ω–∏–π

#### `SheetsNotConfiguredError`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google Sheets.

#### `telegram.error.Conflict`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ —Å –¥—Ä—É–≥–∏–º–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞–º–∏ –±–æ—Ç–∞.

#### `openai.OpenAIError`
–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö OpenAI API.

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
try:
    result = service.method()
except SpecificError as e:
    logger.error(f"Error: {e}")
    return fallback_value
except Exception as e:
    logger.error(f"Unexpected error: {e}")
    return None
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

- `DEBUG`: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- `INFO`: –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ
- `WARNING`: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `ERROR`: –û—à–∏–±–∫–∏
- `CRITICAL`: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```python
logger.info(f"CHAT_HANDLER: –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.id}: {text}")
logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}", exc_info=True)
logger.warning(f"AppealsService –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
from auth_service import AuthService
from openai_service import OpenAIService
from appeals_service import AppealsService

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
auth_service = AuthService()
openai_service = OpenAIService()
appeals_service = AppealsService()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if auth_service.get_user_auth_status(123456789):
    # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è
    appeals_service.create_appeal(
        code="12345",
        phone="89123456789",
        fio="–ò–≤–∞–Ω–æ–≤ –ò.–ò.",
        telegram_id=123456789,
        text="–í–æ–ø—Ä–æ—Å –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"
    )
    
    # –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É
    response = openai_service.ask(123456789, "–ü—Ä–∏–≤–µ—Ç!")
    print(response)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤

```python
from response_monitor import ResponseMonitor

# –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∞
monitor = ResponseMonitor(bot, appeals_service)

# –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
await monitor.start()

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
await monitor.stop()
```

### –†–∞–±–æ—Ç–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω—ã–º –º–µ–Ω—é

```python
from handlers import create_main_menu_keyboard

# –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—é
keyboard = create_main_menu_keyboard()

# –û—Ç–ø—Ä–∞–≤–∫–∞ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
await update.message.reply_text(
    "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
    reply_markup=keyboard
)
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

API MarketingBot v3.0 –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –±–æ—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –∏ —Å–∏—Å—Ç–µ–º–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏. –í—Å–µ –º–µ—Ç–æ–¥—ã –∏–º–µ—é—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.


================================================================================
FILE: ./scripts/README.md
SIZE: 1646 bytes
================================================================================

# –°–∫—Ä–∏–ø—Ç—ã MarketingBot

–≠—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º.

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Yandex Cloud

- `deploy_yandex.sh` - –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ Yandex VM
- `setup_yandex_systemd.sh` - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–µ—Ä–≤–∏—Å–æ–≤
- `start_yandex_services.sh` - –ó–∞–ø—É—Å–∫/–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
- `update_yandex_server.sh` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- `ssh_yandex.sh` - –£–¥–æ–±–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ PythonAnywhere

- `start_bot_pythonanywhere.sh` - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
- `update_bot_pythonanywhere.sh` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞
- `update_pythonanywhere.sh` - –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Tunnel

- `install_cloudflare_tunnel.sh` - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç—É–Ω–Ω–µ–ª—è
- `setup_cloudflare_tunnel.sh` - –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- `setup_cloudflare_tunnel_simple.sh` - –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

## –£—Ç–∏–ª–∏—Ç—ã

- `update_gas_url.py` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL Google Apps Script –≤ menu.html
- `update_google_apps_script_url.sh` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL —á–µ—Ä–µ–∑ shell
- `update_sheet_id.py` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ID Google Sheet
- `update_env.py` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏:

```bash
chmod +x scripts/*.sh
```

–ó–∞–ø—É—Å–∫:

```bash
./scripts/deploy_yandex.sh
```


================================================================================
FILE: ./scripts/check_bot_status.sh
SIZE: 4647 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å systemd —Å–µ—Ä–≤–∏—Å–∞, –ø—Ä–æ—Ü–µ—Å—Å—ã, –ª–æ–≥–∏ –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"
REMOTE_DIR="/home/ubuntu/marketingbot"

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ MarketingBot –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo ""

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<'EOF'
set -e

REMOTE_DIR="/home/ubuntu/marketingbot"

echo "=== 1. –°—Ç–∞—Ç—É—Å systemd —Å–µ—Ä–≤–∏—Å–∞ ==="
echo ""
sudo systemctl status marketingbot-bot.service --no-pager -l || echo "‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω"
echo ""

echo "=== 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞ ==="
echo ""
BOT_PROCESSES=$(ps aux | grep -E "python.*bot\.py" | grep -v grep || true)
BOT_COUNT=$(echo "$BOT_PROCESSES" | wc -l | tr -d ' ')

if [ "$BOT_COUNT" -eq 0 ]; then
    echo "‚ùå –ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
elif [ "$BOT_COUNT" -eq 1 ]; then
    echo "‚úÖ –ù–∞–π–¥–µ–Ω 1 –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞:"
    echo "$BOT_PROCESSES"
else
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω–æ $BOT_COUNT –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞ (–≤–æ–∑–º–æ–∂–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç):"
    echo "$BOT_PROCESSES"
fi
echo ""

echo "=== 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ PID —Ñ–∞–π–ª–æ–≤ ==="
echo ""
if [ -f "${REMOTE_DIR}/bot.pid" ]; then
    PID=$(cat "${REMOTE_DIR}/bot.pid")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "‚úÖ PID —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ—Ü–µ—Å—Å —Å PID $PID –∑–∞–ø—É—â–µ–Ω"
    else
        echo "‚ö†Ô∏è  PID —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω (–∑–∞–≤–∏—Å—à–∏–π PID —Ñ–∞–π–ª)"
    fi
else
    echo "‚ÑπÔ∏è  PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi
echo ""

echo "=== 4. –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫) ==="
echo ""
sudo journalctl -u marketingbot-bot.service -n 50 --no-pager || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
echo ""

echo "=== 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫) ==="
echo ""
ERRORS=$(sudo journalctl -u marketingbot-bot.service -n 100 --no-pager | grep -iE "(error|exception|failed|conflict|timeout)" || echo "–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
if [ -n "$ERRORS" ] && [ "$ERRORS" != "–û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" ]; then
    echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
    echo "$ERRORS" | tail -20
else
    echo "‚úÖ –û—à–∏–±–æ–∫ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi
echo ""

echo "=== 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ Telegram API ==="
echo ""
CONFLICTS=$(sudo journalctl -u marketingbot-bot.service -n 200 --no-pager | grep -iE "conflict|409|another.*instance" || echo "–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
if [ -n "$CONFLICTS" ] && [ "$CONFLICTS" != "–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" ]; then
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞–π–¥–µ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã Telegram API:"
    echo "$CONFLICTS" | tail -10
else
    echo "‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ Telegram API –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
fi
echo ""

echo "=== 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Telegram API ==="
echo ""
if curl -s --max-time 5 https://api.telegram.org > /dev/null; then
    echo "‚úÖ Telegram API –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ö†Ô∏è  Telegram API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç"
fi
echo ""

echo "=== 8. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ ==="
echo ""
if [ "$BOT_COUNT" -gt 0 ]; then
    echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞:"
    ps aux | grep -E "python.*bot\.py" | grep -v grep | awk '{print "  PID: "$2", CPU: "$3"%, MEM: "$4"%, TIME: "$10}'
else
    echo "–ü—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi
echo ""

echo "=== –†–µ–∑—é–º–µ ==="
echo ""
if [ "$BOT_COUNT" -eq 0 ]; then
    echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"
elif [ "$BOT_COUNT" -gt 1 ]; then
    echo "‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç: –∑–∞–ø—É—â–µ–Ω–æ $BOT_COUNT –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞"
    echo "   –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ"
else
    SERVICE_STATUS=$(systemctl is-active marketingbot-bot.service 2>/dev/null || echo "unknown")
    if [ "$SERVICE_STATUS" = "active" ]; then
        echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (1 –ø—Ä–æ—Ü–µ—Å—Å, systemd –∞–∫—Ç–∏–≤–µ–Ω)"
    else
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω, –Ω–æ systemd —Å–µ—Ä–≤–∏—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω"
    fi
fi
echo ""

EOF

echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"


================================================================================
FILE: ./scripts/deploy_yandex.sh
SIZE: 1575 bytes
================================================================================

#!/usr/bin/env bash

# –î–µ–ø–ª–æ–π –ø—Ä–æ–µ–∫—Ç–∞ MarketingBot –Ω–∞ –í–ú Yandex Cloud.
# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –õ–û–ö–ê–õ–¨–ù–û, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH –∏
# –∫–ª–æ–Ω–∏—Ä—É–µ—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ /home/ubuntu/marketingbot.

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599}"
REMOTE_DIR="/home/ubuntu/marketingbot"
REPO_URL="https://github.com/synthosaicreativestudio-maker/marketing.git"

echo "==> –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ ${VM_USER}@${VM_HOST} –∏ —Ä–∞–∑–º–µ—â–∞—é/–æ–±–Ω–æ–≤–ª—è—é –ø—Ä–æ–µ–∫—Ç –≤ ${REMOTE_DIR}"

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<EOF
set -e

echo "==> –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ git –∏ Python"
sudo apt-get update -y
sudo apt-get install -y git python3 python3-venv python3-pip

echo "==> –†–∞–∑–º–µ—â–∞—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
if [ ! -d "${REMOTE_DIR}" ]; then
  git clone "${REPO_URL}" "${REMOTE_DIR}"
else
  cd "${REMOTE_DIR}"
  git pull origin main
fi

cd "${REMOTE_DIR}"

echo "==> –°–æ–∑–¥–∞—é/–æ–±–Ω–æ–≤–ª—è—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ"
if [ ! -d ".venv" ]; then
  python3 -m venv .venv
fi
. .venv/bin/activate

echo "==> –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
pip install --upgrade pip
pip install -r requirements.txt

echo "==> –î–µ–ø–ª–æ–π –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å .env –∏ systemd/nginx –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –∏ –≤–µ–±—Ö—É–∫–∞."
EOF

echo "==> –ì–æ—Ç–æ–≤–æ. –ü—Ä–æ–µ–∫—Ç —Ä–∞–∑–º–µ—â–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ –í–ú."



================================================================================
FILE: ./scripts/install_cloudflare_tunnel.sh
SIZE: 3370 bytes
================================================================================

#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Cloudflare Tunnel –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Yandex VM
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ cloudflare_tunnel_token.txt

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"
TOKEN_FILE="cloudflare_tunnel_token.txt"

echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Cloudflare Tunnel –Ω–∞ ${VM_USER}@${VM_HOST}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ —Å —Ç–æ–∫–µ–Ω–æ–º
if [ ! -f "$TOKEN_FILE" ]; then
    echo "‚ùå –§–∞–π–ª $TOKEN_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ —Ñ–∞–π–ª–∞
TOKEN=$(grep "^CLOUDFLARE_TUNNEL_TOKEN=" "$TOKEN_FILE" | cut -d'=' -f2)

if [ -z "$TOKEN" ]; then
    echo "‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ $TOKEN_FILE"
    exit 1
fi

echo "‚úÖ –¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω"
echo ""

echo "==> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared..."

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<EOF
set -e

TOKEN="$TOKEN"

echo "==> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è cloudflared..."
if command -v cloudflared &> /dev/null; then
    echo "‚úÖ cloudflared —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    cloudflared --version
else
    echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared..."
    sudo mkdir -p --mode=0755 /usr/share/keyrings
    curl -fsSL https://pkg.cloudflare.com/cloudflare-public-v2.gpg | sudo tee /usr/share/keyrings/cloudflare-public-v2.gpg >/dev/null
    
    echo 'deb [signed-by=/usr/share/keyrings/cloudflare-public-v2.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list
    
    sudo apt-get update && sudo apt-get install -y cloudflared
    echo "‚úÖ cloudflared —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    cloudflared --version
fi

echo ""
echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Cloudflare Tunnel —Å–µ—Ä–≤–∏—Å–∞..."
sudo cloudflared service install "\$TOKEN"

echo ""
echo "==> –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl daemon-reload
sudo systemctl enable cloudflared
sudo systemctl start cloudflared

echo ""
echo "==> –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

echo ""
echo "==> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl status cloudflared --no-pager -l | head -20 || true

echo ""
echo "==> –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ URL —Ç—É–Ω–Ω–µ–ª—è –∏–∑ –ª–æ–≥–æ–≤..."
TUNNEL_URL=\$(sudo journalctl -u cloudflared -n 50 --no-pager | grep -oP 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' | head -1 || echo "")

if [ -z "\$TUNNEL_URL" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å URL —Ç—É–Ω–Ω–µ–ª—è"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -u cloudflared -f"
else
    echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω!"
    echo "   URL: \$TUNNEL_URL"
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API:"
    curl -s "\$TUNNEL_URL/api/promotions" | head -5 || echo "API –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
EOF

echo ""
echo "‚úÖ Cloudflare Tunnel —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL —Ç—É–Ω–Ω–µ–ª—è –≤—ã—à–µ"
echo "   2. –û–±–Ω–æ–≤–∏—Ç–µ menu.html —Å —Ä–µ–∞–ª—å–Ω—ã–º Tunnel URL"
echo "   3. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"


================================================================================
FILE: ./scripts/setup_cloudflare_tunnel.sh
SIZE: 5916 bytes
================================================================================

#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Cloudflare Tunnel –Ω–∞ Yandex VM
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É SSL –¥–ª—è –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–π HTTPS URL

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"

echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Tunnel –Ω–∞ ${VM_USER}@${VM_HOST}"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –ü–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞:"
echo "   1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ Cloudflare (–±–µ—Å–ø–ª–∞—Ç–Ω–æ): https://dash.cloudflare.com/sign-up"
echo "   2. –°–æ–∑–¥–∞–π—Ç–µ Tunnel —á–µ—Ä–µ–∑ Dashboard: Zero Trust > Networks > Tunnels > Create a tunnel"
echo "   3. –í—ã–±–µ—Ä–∏—Ç–µ 'Cloudflared' –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ Tunnel ID"
echo "   4. –°–∫–∞—á–∞–π—Ç–µ credentials —Ñ–∞–π–ª (JSON)"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 1
fi

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ Tunnel ID (–∏–∑ Cloudflare Dashboard):"
read TUNNEL_ID

if [ -z "$TUNNEL_ID" ]; then
    echo "‚ùå Tunnel ID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É (JSON) –Ω–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:"
read CREDENTIALS_FILE

if [ ! -f "$CREDENTIALS_FILE" ]; then
    echo "‚ùå –§–∞–π–ª $CREDENTIALS_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi

echo ""
echo "==> –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared..."

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<EOF
set -e

echo "==> –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è cloudflared..."
if command -v cloudflared &> /dev/null; then
    echo "‚úÖ cloudflared —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    cloudflared --version
else
    echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared..."
    cd /tmp
    wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
    sudo dpkg -i cloudflared-linux-amd64.deb || sudo apt-get install -f -y
    rm -f cloudflared-linux-amd64.deb
    echo "‚úÖ cloudflared —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    cloudflared --version
fi

echo ""
echo "==> –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
sudo mkdir -p /etc/cloudflared

echo ""
echo "==> –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞..."
EOF

# –ö–æ–ø–∏—Ä—É–µ–º credentials —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp -i "$SSH_KEY" "$CREDENTIALS_FILE" "${VM_USER}@${VM_HOST}:/tmp/${TUNNEL_ID}.json"

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<EOF
set -e

TUNNEL_ID="$TUNNEL_ID"

echo "==> –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ credentials —Ñ–∞–π–ª–∞..."
sudo mv "/tmp/\${TUNNEL_ID}.json" "/etc/cloudflared/\${TUNNEL_ID}.json"
sudo chmod 600 "/etc/cloudflared/\${TUNNEL_ID}.json"

echo ""
echo "==> –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞..."
sudo tee /etc/cloudflared/config.yml > /dev/null <<CONFIG
tunnel: \${TUNNEL_ID}
credentials-file: /etc/cloudflared/\${TUNNEL_ID}.json

ingress:
  - hostname: marketingbot-\${TUNNEL_ID}.trycloudflare.com
    service: http://localhost:8080
  - service: http_status:404
CONFIG

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞"

echo ""
echo "==> –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞..."
sudo tee /etc/systemd/system/cloudflared.service > /dev/null <<'SERVICE'
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel --config /etc/cloudflared/config.yml run
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
SERVICE

echo "‚úÖ Systemd —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞–Ω"

echo ""
echo "==> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl daemon-reload
sudo systemctl enable cloudflared
sudo systemctl restart cloudflared

echo ""
echo "==> –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Ç—É–Ω–Ω–µ–ª—è (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

echo ""
echo "==> –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl status cloudflared --no-pager -l || true

echo ""
echo "==> –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ URL —Ç—É–Ω–Ω–µ–ª—è –∏–∑ –ª–æ–≥–æ–≤..."
TUNNEL_URL=\$(sudo journalctl -u cloudflared -n 100 --no-pager | grep -oP 'https://[a-zA-Z0-9-]+\.trycloudflare\.com' | head -1 || echo "")

if [ -z "\$TUNNEL_URL" ]; then
    echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å URL —Ç—É–Ω–Ω–µ–ª—è"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: sudo journalctl -u cloudflared -f"
    TUNNEL_URL="https://marketingbot-\${TUNNEL_ID}.trycloudflare.com"
fi

echo ""
echo "‚úÖ Cloudflare Tunnel –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω!"
echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—É–Ω–Ω–µ–ª–µ:"
echo "   Tunnel ID: \${TUNNEL_ID}"
echo "   URL: \$TUNNEL_URL"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API:"
echo "   curl \$TUNNEL_URL/api/promotions"
echo ""
echo "‚ö†Ô∏è  –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–∏—Ç–µ API_BASE_URL –≤ menu.html –Ω–∞ —ç—Ç–æ—Ç URL:"
echo "   \$TUNNEL_URL"
EOF

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL —Ç—É–Ω–Ω–µ–ª—è –≤—ã—à–µ"
echo "   2. –û–±–Ω–æ–≤–∏—Ç–µ menu.html —Å –Ω–æ–≤—ã–º API_BASE_URL (–∑–∞–º–µ–Ω–∏—Ç–µ <TUNNEL_ID> –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID)"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo ""
echo "üí° –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ —Ç—É–Ω–Ω–µ–ª—è:"
echo "   ssh -i $SSH_KEY ${VM_USER}@${VM_HOST} 'sudo journalctl -u cloudflared -f'"

echo ""
echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL —Ç—É–Ω–Ω–µ–ª—è –≤—ã—à–µ"
echo "   2. –û–±–Ω–æ–≤–∏—Ç–µ menu.html —Å –Ω–æ–≤—ã–º API_BASE_URL"
echo "   3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"


================================================================================
FILE: ./scripts/setup_cloudflare_tunnel_simple.sh
SIZE: 3531 bytes
================================================================================

#!/usr/bin/env bash

# –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Cloudflare Tunnel
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ —Ç—É–Ω–Ω–µ–ª—å —É–∂–µ —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ Dashboard
# –∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cloudflared –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"

echo "==> –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Cloudflare Tunnel"
echo ""
echo "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç, —á—Ç–æ –≤—ã —É–∂–µ:"
echo "  1. –°–æ–∑–¥–∞–ª–∏ —Ç—É–Ω–Ω–µ–ª—å —á–µ—Ä–µ–∑ Cloudflare Dashboard"
echo "  2. –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ Public Hostname (marketingbot-xxx.trycloudflare.com ‚Üí localhost:8080)"
echo "  3. –°–∫–∞—á–∞–ª–∏ credentials —Ñ–∞–π–ª (JSON)"
echo ""
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    exit 1
fi

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ Tunnel ID:"
read TUNNEL_ID

if [ -z "$TUNNEL_ID" ]; then
    echo "‚ùå Tunnel ID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

echo ""
echo "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É (JSON):"
read CREDENTIALS_FILE

if [ ! -f "$CREDENTIALS_FILE" ]; then
    echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $CREDENTIALS_FILE"
    exit 1
fi

echo ""
echo "==> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<EOF
set -e

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared
if ! command -v cloudflared &> /dev/null; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ cloudflared..."
    cd /tmp
    wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
    sudo dpkg -i cloudflared-linux-amd64.deb || sudo apt-get install -f -y
    rm -f cloudflared-linux-amd64.deb
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
sudo mkdir -p /etc/cloudflared

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials
sudo cp /tmp/${TUNNEL_ID}.json /etc/cloudflared/ 2>/dev/null || true
sudo chmod 600 /etc/cloudflared/${TUNNEL_ID}.json

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo tee /etc/cloudflared/config.yml > /dev/null <<CONFIG
tunnel: ${TUNNEL_ID}
credentials-file: /etc/cloudflared/${TUNNEL_ID}.json

ingress:
  - hostname: marketingbot-${TUNNEL_ID}.trycloudflare.com
    service: http://localhost:8080
  - service: http_status:404
CONFIG

# –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
sudo tee /etc/systemd/system/cloudflared.service > /dev/null <<SERVICE
[Unit]
Description=Cloudflare Tunnel
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/cloudflared tunnel --config /etc/cloudflared/config.yml run
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
SERVICE

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl daemon-reload
sudo systemctl enable cloudflared
sudo systemctl restart cloudflared

echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

echo ""
echo "–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
sudo systemctl status cloudflared --no-pager -l | head -20 || true

echo ""
echo "‚úÖ –¢—É–Ω–Ω–µ–ª—å –∑–∞–ø—É—â–µ–Ω!"
echo "URL: https://marketingbot-${TUNNEL_ID}.trycloudflare.com"
EOF

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞
scp -i "$SSH_KEY" "$CREDENTIALS_FILE" "${VM_USER}@${VM_HOST}:/tmp/${TUNNEL_ID}.json"

echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "URL —Ç—É–Ω–Ω–µ–ª—è: https://marketingbot-${TUNNEL_ID}.trycloudflare.com"
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞:"
echo "  curl https://marketingbot-${TUNNEL_ID}.trycloudflare.com/api/promotions"


================================================================================
FILE: ./scripts/setup_yandex_systemd.sh
SIZE: 3827 bytes
================================================================================

#!/usr/bin/env bash

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd-—Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è MarketingBot –Ω–∞ –í–ú Yandex Cloud.
# –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—ë—Ç –¥–≤–∞ —Å–µ—Ä–≤–∏—Å–∞:
#  - marketingbot-bot.service      ‚Äî Telegram-–±–æ—Ç (polling), –∑–∞–ø—É—Å–∫–∞–µ—Ç bot.py
#  - marketingbot-web.service      ‚Äî Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ webhook_handler.py (API + —Å—Ç–∞—Ç–∏–∫–∞ –¥–ª—è –º–∏–Ω–∏-–∞–ø–ø–∞)
#
# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
#  - –ø—Ä–æ–µ–∫—Ç —É–∂–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ /home/ubuntu/marketingbot (deploy_yandex.sh)
#  - —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª /home/ubuntu/marketingbot/.env —Å –Ω—É–∂–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"
REMOTE_DIR="/home/ubuntu/marketingbot"

echo "==> –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é systemd-—Å–µ—Ä–≤–∏—Å—ã –Ω–∞ ${VM_USER}@${VM_HOST}"

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<'EOF'
set -e

REMOTE_DIR="/home/ubuntu/marketingbot"
VENV_DIR="${REMOTE_DIR}/.venv"
PYTHON="${VENV_DIR}/bin/python"

if [ ! -d "${REMOTE_DIR}" ]; then
  echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ ${REMOTE_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ deploy_yandex.sh"
  exit 1
fi

if [ ! -d "${VENV_DIR}" ]; then
  echo "‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ ${VENV_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ deploy_yandex.sh"
  exit 1
fi

if [ ! -f "${REMOTE_DIR}/.env" ]; then
  echo "‚ö†Ô∏è  –§–∞–π–ª ${REMOTE_DIR}/.env –Ω–µ –Ω–∞–π–¥–µ–Ω."
  echo "    –Ø —Å–æ–∑–¥–∞–º –ø—É—Å—Ç–æ–π —à–∞–±–ª–æ–Ω .env ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–µ—Ä–≤–∏—Å–æ–≤."
  cat > "${REMOTE_DIR}/.env" <<EENV
# –ü—Ä–∏–º–µ—Ä .env –¥–ª—è MarketingBot
TELEGRAM_TOKEN=–í–ê–®_TELEGRAM_TOKEN
OPENAI_API_KEY=–í–ê–®_OPENAI_API_KEY
OPENAI_ASSISTANT_ID=–í–ê–®_ASSISTANT_ID
GOOGLE_SERVICE_ACCOUNT_JSON=credentials.json
SPREADSHEET_ID=–í–ê–®_SPREADSHEET_ID
APPEALS_SHEET_NAME=–æ–±—Ä–∞—â–µ–Ω–∏—è
PROMOTIONS_SHEET_ID=ID_–¢–ê–ë–õ–ò–¶–´_–ê–ö–¶–ò–ô
WEB_APP_URL=http://158.160.0.127/
ADMIN_TELEGRAM_ID=0
WEBHOOK_SECRET=–∑–∞–º–µ–Ω–∏—Ç–µ_–Ω–∞_—Å–ª—É—á–∞–π–Ω—ã–π_—Å–µ–∫—Ä–µ—Ç
EENV
fi

echo "==> –°–æ–∑–¥–∞—é systemd unit –¥–ª—è –±–æ—Ç–∞: /etc/systemd/system/marketingbot-bot.service"
sudo tee /etc/systemd/system/marketingbot-bot.service >/dev/null <<ESVC
[Unit]
Description=MarketingBot Telegram bot
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=${REMOTE_DIR}
EnvironmentFile=${REMOTE_DIR}/.env
ExecStart=${PYTHON} bot.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
ESVC

echo "==> –°–æ–∑–¥–∞—é systemd unit –¥–ª—è Flask –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: /etc/systemd/system/marketingbot-web.service"
sudo tee /etc/systemd/system/marketingbot-web.service >/dev/null <<ESVC2
[Unit]
Description=MarketingBot Flask web app (webhook_handler.py)
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=${REMOTE_DIR}
EnvironmentFile=${REMOTE_DIR}/.env
ExecStart=${PYTHON} webhook_handler.py
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
ESVC2

echo "==> –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é systemd –∏ –≤–∫–ª—é—á–∞—é —Å–µ—Ä–≤–∏—Å—ã –≤ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ (–±–µ–∑ —Å—Ç–∞—Ä—Ç–∞)"
sudo systemctl daemon-reload
sudo systemctl enable marketingbot-bot.service
sudo systemctl enable marketingbot-web.service

echo "==> –ì–æ—Ç–æ–≤–æ."
echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª ${REMOTE_DIR}/.env, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "  sudo systemctl start marketingbot-bot.service"
echo "  sudo systemctl start marketingbot-web.service"
echo "–ò –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å:"
echo "  sudo systemctl status marketingbot-bot.service"
echo "  sudo systemctl status marketingbot-web.service"
EOF

echo "==> –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd –Ω–∞ –í–ú –∑–∞–≤–µ—Ä—à–µ–Ω–∞."



================================================================================
FILE: ./scripts/ssh_yandex.sh
SIZE: 389 bytes
================================================================================

#!/usr/bin/env bash

# –£–¥–æ–±–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –í–ú Yandex Cloud
# –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –ª–µ–∂–∏—Ç –ø–æ –ø—É—Ç–∏ ~/.ssh/ssh-key-1767684261599

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}"



================================================================================
FILE: ./scripts/start_bot_pythonanywhere.sh
SIZE: 2191 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –Ω–∞ PythonAnywhere
echo "üöÄ –ó–∞–ø—É—Å–∫ MarketingBot –Ω–∞ PythonAnywhere..."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="$HOME/marketing"
cd "$PROJECT_DIR" || exit 1

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env
if [ ! -f .env ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é Python
if command -v python3.10 &> /dev/null; then
    PYTHON_CMD="python3.10"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
else
    echo "‚ùå –û—à–∏–±–∫–∞: Python –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

echo "üì¶ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: $PYTHON_CMD"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å, –µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω
echo "‚èπÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f "python.*bot.py" 2>/dev/null && echo "–°—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "–ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

# –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
sleep 2

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! $PYTHON_CMD -c "import telegram" 2>/dev/null; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    pip3.10 install --user -r requirements.txt || pip3 install --user -r requirements.txt
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup $PYTHON_CMD bot.py > bot.log 2>&1 &

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
if pgrep -f "python.*bot.py" > /dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo ""
    echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "  –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f bot.log"
    echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞: ps aux | grep python | grep bot"
    echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞: pkill -f 'python.*bot.py'"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -20 bot.log"
    exit 1
fi


================================================================================
FILE: ./scripts/start_yandex_services.sh
SIZE: 862 bytes
================================================================================

#!/usr/bin/env bash

# –£–¥–æ–±–Ω—ã–π –∑–∞–ø—É—Å–∫/–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ MarketingBot –Ω–∞ –í–ú Yandex Cloud.

set -e

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"

ssh -t -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" <<'EOF'
set -e

echo "==> –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã marketingbot-bot –∏ marketingbot-web"
sudo systemctl start marketingbot-bot.service
sudo systemctl start marketingbot-web.service

echo "==> –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
sudo systemctl --no-pager status marketingbot-bot.service || true
sudo systemctl --no-pager status marketingbot-web.service || true

echo "==> –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏):"
sudo journalctl -u marketingbot-bot.service -n 50 --no-pager || true
sudo journalctl -u marketingbot-web.service -n 50 --no-pager || true
EOF



================================================================================
FILE: ./scripts/update_bot_pythonanywhere.sh
SIZE: 2075 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ –Ω–∞ PythonAnywhere
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MarketingBot –Ω–∞ PythonAnywhere..."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="$HOME/marketing"
cd "$PROJECT_DIR" || exit 1

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–æ—Ç
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –±–æ—Ç–∞..."
pkill -f "python.*bot.py" 2>/dev/null && echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "‚ÑπÔ∏è –ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

# –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
sleep 2

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git pull origin main

if [ $? -eq 0 ]; then
    echo "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –∏–∑ GitHub"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å)
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if command -v python3.10 &> /dev/null; then
    PYTHON_CMD="python3.10"
elif command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
else
    echo "‚ùå –û—à–∏–±–∫–∞: Python –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –±–æ—Ç
echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞..."
nohup $PYTHON_CMD bot.py > bot.log 2>&1 &

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
if pgrep -f "python.*bot.py" > /dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo ""
    echo "üìã –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "  –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f bot.log"
    echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞: ps aux | grep python | grep bot"
    echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞: pkill -f 'python.*bot.py'"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ë–æ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -20 bot.log"
    exit 1
fi


================================================================================
FILE: ./scripts/update_env.py
SIZE: 2376 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.
"""

import os

def update_env_file():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç .env —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏."""
    
    # –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π .env —Ñ–∞–π–ª
    env_file = '.env'
    env_vars = {}
    
    if os.path.exists(env_file):
        with open(env_file, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#') and '=' in line:
                    key, value = line.split('=', 1)
                    env_vars[key] = value
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    env_vars['WEB_APP_MENU_URL'] = 'https://synthosaicreativestudio-maker.github.io/marketing/menu.html'
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π .env —Ñ–∞–π–ª
    with open(env_file, 'w', encoding='utf-8') as f:
        f.write("# Telegram Bot Configuration\n")
        f.write(f"TELEGRAM_TOKEN=\"{env_vars.get('TELEGRAM_TOKEN', '')}\"\n")
        f.write(f"ADMIN_TELEGRAM_ID={env_vars.get('ADMIN_TELEGRAM_ID', '')}\n\n")
        
        f.write("# OpenAI Configuration\n")
        f.write(f"OPENAI_API_KEY=\"{env_vars.get('OPENAI_API_KEY', '')}\"\n")
        f.write(f"OPENAI_ASSISTANT_ID=\"{env_vars.get('OPENAI_ASSISTANT_ID', '')}\"\n\n")
        
        f.write("# Google Sheets Configuration\n")
        f.write(f"SHEET_URL=\"{env_vars.get('SHEET_URL', '')}\"\n")
        f.write(f"TICKETS_SHEET_URL=\"{env_vars.get('TICKETS_SHEET_URL', '')}\"\n")
        f.write(f"WEB_APP_URL=\"{env_vars.get('WEB_APP_URL', '')}\"\n")
        f.write(f"WEB_APP_MENU_URL=\"{env_vars.get('WEB_APP_MENU_URL', '')}\"\n")
        f.write(f"SHEET_ID={env_vars.get('SHEET_ID', '')}\n\n")
        
        f.write("# Google Cloud Platform Service Account\n")
        f.write(f"GCP_SA_FILE={env_vars.get('GCP_SA_FILE', '')}\n")
        f.write(f"SHEET_NAME={env_vars.get('SHEET_NAME', '')}\n\n")
        
        f.write("# Appeals sheet configuration\n")
        f.write(f"APPEALS_SHEET_ID={env_vars.get('APPEALS_SHEET_ID', '')}\n")
        f.write(f"APPEALS_SHEET_NAME={env_vars.get('APPEALS_SHEET_NAME', '')}\n")
    
    print("‚úÖ .env —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω —Å –Ω–æ–≤–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π WEB_APP_MENU_URL")

if __name__ == "__main__":
    update_env_file()


================================================================================
FILE: ./scripts/update_gas_url.py
SIZE: 3153 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Google Apps Script URL –≤ menu.html
"""

import re
import sys

def update_google_apps_script_url(url):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç Google Apps Script URL –≤ menu.html"""
    
    if not url:
        print("‚ùå URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
        return False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ URL –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
    if not url.startswith('https://script.google.com/macros/s/'):
        print("‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: URL –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ Google Apps Script URL")
        response = input("–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): ")
        if response.lower() != 'y':
            return False
    
    try:
        # –ß–∏—Ç–∞–µ–º menu.html
        with open('menu.html', 'r', encoding='utf-8') as f:
            content = f.read()
        
        # –ò—â–µ–º –∏ –∑–∞–º–µ–Ω—è–µ–º URL
        # –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞: const GOOGLE_APPS_SCRIPT_URL = ''; –∏–ª–∏ const GOOGLE_APPS_SCRIPT_URL = '...';
        pattern = r"const GOOGLE_APPS_SCRIPT_URL = ['\"].*?['\"];"
        replacement = f"const GOOGLE_APPS_SCRIPT_URL = '{url}';"
        
        if re.search(pattern, content):
            new_content = re.sub(pattern, replacement, content)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
            with open('menu.html', 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            print(f"‚úÖ menu.html –æ–±–Ω–æ–≤–ª–µ–Ω —Å URL: {url}")
            return True
        else:
            print("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å GOOGLE_APPS_SCRIPT_URL –≤ menu.html")
            return False
            
    except FileNotFoundError:
        print("‚ùå –§–∞–π–ª menu.html –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return False
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return False

if __name__ == '__main__':
    if len(sys.argv) > 1:
        # URL –ø–µ—Ä–µ–¥–∞–Ω –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        url = sys.argv[1]
    else:
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º URL –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ
        print("=== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Google Apps Script URL –≤ menu.html ===")
        print("")
        print("–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Google Apps Script URL (–∏–∑ –æ–∫–Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è):")
        print("–ü—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/AKfycbzQ8pDvdc6ZriqchBvto6prPk00OwTsHiUx_GAZhkCtXQjtCfM5-KZO4uH7zIUC.../exec")
        print("")
        url = input("URL: ").strip()
    
    if update_google_apps_script_url(url):
        print("")
        print("–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print("1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ menu.html - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –≤—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ")
        print("2. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:")
        print("   git add menu.html")
        print("   git commit -m '–û–±–Ω–æ–≤–ª–µ–Ω Google Apps Script URL'")
        print("   git push")
        print("3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ: –æ—Ç–∫—Ä–æ–π—Ç–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è JSON —Å –∞–∫—Ü–∏—è–º–∏")


================================================================================
FILE: ./scripts/update_google_apps_script_url.sh
SIZE: 1694 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Google Apps Script URL –≤ menu.html

echo "=== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Google Apps Script URL –≤ menu.html ==="
echo ""
echo "–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à Google Apps Script URL (–∏–∑ –æ–∫–Ω–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è):"
echo "–ü—Ä–∏–º–µ—Ä: https://script.google.com/macros/s/AKfycbzQ8pDvdc6ZriqchBvto6prPk00OwTsHiUx_GAZhkCtXQjtCfM5-KZO4uH7zIUC.../exec"
echo ""
read -p "URL: " GOOGLE_APPS_SCRIPT_URL

if [ -z "$GOOGLE_APPS_SCRIPT_URL" ]; then
    echo "‚ùå URL –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    exit 1
fi

# –û–±–Ω–æ–≤–ª—è–µ–º menu.html
if [ -f "menu.html" ]; then
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º sed –¥–ª—è –∑–∞–º–µ–Ω—ã URL (—ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
    ESCAPED_URL=$(echo "$GOOGLE_APPS_SCRIPT_URL" | sed 's/[[\.*^$()+?{|]/\\&/g')
    
    # –ó–∞–º–µ–Ω—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ TODO –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL
    sed -i.bak "s|const GOOGLE_APPS_SCRIPT_URL = '';.*|const GOOGLE_APPS_SCRIPT_URL = '$GOOGLE_APPS_SCRIPT_URL';|g" menu.html
    
    echo "‚úÖ menu.html –æ–±–Ω–æ–≤–ª–µ–Ω —Å URL: $GOOGLE_APPS_SCRIPT_URL"
    echo ""
    echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ menu.html - —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –≤—Å—Ç–∞–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
    echo "2. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: git add menu.html && git commit -m '–û–±–Ω–æ–≤–ª–µ–Ω Google Apps Script URL' && git push"
    echo "3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ: –æ—Ç–∫—Ä–æ–π—Ç–µ URL –≤ –±—Ä–∞—É–∑–µ—Ä–µ - –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è JSON —Å –∞–∫—Ü–∏—è–º–∏"
else
    echo "‚ùå –§–∞–π–ª menu.html –Ω–µ –Ω–∞–π–¥–µ–Ω"
    exit 1
fi


================================================================================
FILE: ./scripts/update_pythonanywhere.sh
SIZE: 996 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ PythonAnywhere
echo "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MarketingBot –Ω–∞ PythonAnywhere..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd ~/marketing

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –±–æ—Ç
echo "‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –±–æ—Ç–∞..."
pkill -f "python.*bot" || echo "–ë–æ—Ç –Ω–µ –±—ã–ª –∑–∞–ø—É—â–µ–Ω"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git pull origin main

# –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip3.10 install --user -r requirements.txt

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞..."
nohup python3.10 bot.py > bot.log 2>&1 &

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f bot.log"
echo "üîç –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–∞: ps aux | grep python"


================================================================================
FILE: ./scripts/update_server_from_local.sh
SIZE: 1470 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ Yandex VM —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞
echo "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MarketingBot –Ω–∞ Yandex VM —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞..."

VM_USER="ubuntu"
VM_HOST="158.160.0.127"
SSH_KEY="${SSH_KEY_PATH:-$HOME/.ssh/ssh-key-1767684261599/ssh-key-1767684261599}"
REMOTE_DIR="/home/ubuntu/marketingbot"

echo "==> –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ ${VM_USER}@${VM_HOST} –∏ –æ–±–Ω–æ–≤–ª—è—é –ø—Ä–æ–µ–∫—Ç..."

ssh -i "$SSH_KEY" "${VM_USER}@${VM_HOST}" bash <<'EOF'
set -e

REMOTE_DIR="/home/ubuntu/marketingbot"

if [ ! -d "${REMOTE_DIR}" ]; then
  echo "‚ùå –ö–∞—Ç–∞–ª–æ–≥ ${REMOTE_DIR} –Ω–µ –Ω–∞–π–¥–µ–Ω"
  exit 1
fi

cd "${REMOTE_DIR}"

echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git pull origin main

echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sudo systemctl restart marketingbot-bot.service
sudo systemctl restart marketingbot-web.service

echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
sudo systemctl status marketingbot-bot.service --no-pager -l | head -20
sudo systemctl status marketingbot-web.service --no-pager -l | head -20

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìã –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "   sudo journalctl -u marketingbot-bot.service -f"
echo "   sudo journalctl -u marketingbot-web.service -f"
EOF

echo "==> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ."


================================================================================
FILE: ./scripts/update_sheet_id.py
SIZE: 1365 bytes
================================================================================

#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è SHEET_ID –≤ .env —Ñ–∞–π–ª–µ.
"""

import os

def update_sheet_id():
    """–û–±–Ω–æ–≤–ª—è–µ—Ç SHEET_ID –≤ .env —Ñ–∞–π–ª–µ."""
    env_file = '.env'
    new_sheet_id = '15XxSIpD_gMZaSOIrqDVCNI2EqBzphEGiG0ZNJ3HR8hI'
    
    if not os.path.exists(env_file):
        print(f"‚ùå –§–∞–π–ª {env_file} –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    # –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
    with open(env_file, 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    # –û–±–Ω–æ–≤–ª—è–µ–º SHEET_ID
    updated = False
    for i, line in enumerate(lines):
        if line.startswith('SHEET_ID='):
            old_value = line.strip().split('=', 1)[1]
            lines[i] = f'SHEET_ID={new_sheet_id}\n'
            print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω SHEET_ID: {old_value} -> {new_sheet_id}")
            updated = True
            break
    
    if not updated:
        # –î–æ–±–∞–≤–ª—è–µ–º SHEET_ID –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        lines.append(f'SHEET_ID={new_sheet_id}\n')
        print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω SHEET_ID: {new_sheet_id}")
    
    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    with open(env_file, 'w', encoding='utf-8') as f:
        f.writelines(lines)
    
    print(f"‚úÖ –§–∞–π–ª {env_file} –æ–±–Ω–æ–≤–ª–µ–Ω")

if __name__ == "__main__":
    update_sheet_id()


================================================================================
FILE: ./scripts/update_yandex_server.sh
SIZE: 1428 bytes
================================================================================

#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ—Ç–∞ –Ω–∞ Yandex VM
echo "üöÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MarketingBot –Ω–∞ Yandex VM..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /home/ubuntu/marketingbot

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ GitHub
echo "üì• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ GitHub..."
git fetch origin
git pull origin main

# –ü—Ä–æ–≤–µ—Ä—è–µ–º WEB_APP_URL –≤ .env
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ WEB_APP_URL..."
if grep -q "WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/" .env; then
    echo "‚úÖ WEB_APP_URL –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π"
else
    echo "‚ö†Ô∏è  WEB_APP_URL –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª .env"
    echo "–û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: WEB_APP_URL=https://synthosaicreativestudio-maker.github.io/marketing/"
fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sudo systemctl restart marketingbot-bot.service
sudo systemctl restart marketingbot-web.service

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
sudo systemctl status marketingbot-bot.service --no-pager -l
sudo systemctl status marketingbot-web.service --no-pager -l

echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
echo "   sudo journalctl -u marketingbot-bot.service -f"
echo "   sudo journalctl -u marketingbot-web.service -f"


================================================================================
FILE: ./db/__init__.py
SIZE: 19 bytes
================================================================================

# Database package


================================================================================
FILE: ./db/database.py
SIZE: 1739 bytes
================================================================================

"""
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç SQLite –¥–ª—è –Ω–∞—á–∞–ª–∞, –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ PostgreSQL.
"""
import os
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from dotenv import load_dotenv

load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º URL –ë–î –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///./db/appeals.db")

# –°–æ–∑–¥–∞–µ–º engine
if DATABASE_URL.startswith("sqlite"):
    # –î–ª—è SQLite –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ foreign keys
    engine = create_engine(
        DATABASE_URL,
        connect_args={"check_same_thread": False}  # –î–ª—è SQLite
    )
else:
    engine = create_engine(DATABASE_URL)

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

# –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –º–æ–¥–µ–ª–µ–π
Base = declarative_base()

def get_db():
    """
    Dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –ë–î.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ FastAPI endpoints.
    """
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_db():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.
    """
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –≤ Base
    from db.models import Appeal, AppealMessage, SpecialistResponse
    
    # –°–æ–∑–¥–∞–µ–º –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
    Base.metadata.create_all(bind=engine)
    print("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")


================================================================================
FILE: ./db/models.py
SIZE: 4053 bytes
================================================================================

"""
SQLAlchemy –º–æ–¥–µ–ª–∏ –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏–π.
–ò–¥–µ–Ω—Ç–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫ Google Sheets —Ç–∞–±–ª–∏—Ü–µ –æ–±—Ä–∞—â–µ–Ω–∏–π.
"""
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey, Index
from sqlalchemy.orm import relationship
from datetime import datetime
from db.database import Base


class Appeal(Base):
    """
    –¢–∞–±–ª–∏—Ü–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π.
    –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Google Sheets —Ç–∞–±–ª–∏—Ü—ã –æ–±—Ä–∞—â–µ–Ω–∏–π.
    """
    __tablename__ = 'appeals'
    
    id = Column(Integer, primary_key=True, index=True)
    # –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫–æ–ª–æ–Ω–∫–∏ A-D –≤ Google Sheets)
    partner_code = Column(String(50), nullable=True)  # –ö–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–∫–æ–ª–æ–Ω–∫–∞ A)
    phone = Column(String(20), nullable=True)  # –¢–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–∫–æ–ª–æ–Ω–∫–∞ B)
    fio = Column(String(200), nullable=True)  # –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (–∫–æ–ª–æ–Ω–∫–∞ C)
    telegram_id = Column(Integer, nullable=False, index=True)  # Telegram ID (–∫–æ–ª–æ–Ω–∫–∞ D)
    
    # –°—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è (–∫–æ–ª–æ–Ω–∫–∞ F)
    status = Column(String(50), default='–Ω–æ–≤–æ–µ', nullable=False, index=True)
    # –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: '–Ω–æ–≤–æ–µ', '–≤_—Ä–∞–±–æ—Ç–µ', '–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É', '–æ—Ç–≤–µ—Ç_–∏–∏', '—Ä–µ—à–µ–Ω–æ'
    
    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
    
    # –°–≤—è–∑–∏ —Å –¥—Ä—É–≥–∏–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
    messages = relationship("AppealMessage", back_populates="appeal", cascade="all, delete-orphan", order_by="AppealMessage.created_at")
    responses = relationship("SpecialistResponse", back_populates="appeal", cascade="all, delete-orphan", order_by="SpecialistResponse.sent_at")
    
    def __repr__(self):
        return f"<Appeal(id={self.id}, telegram_id={self.telegram_id}, status={self.status})>"


class AppealMessage(Base):
    """
    –°–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏ (–∏—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞).
    –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–µ E (—Ç–µ–∫—Å—Ç_–æ–±—Ä–∞—â–µ–Ω–∏–π) –≤ Google Sheets, –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ.
    """
    __tablename__ = 'appeal_messages'
    
    id = Column(Integer, primary_key=True, index=True)
    appeal_id = Column(Integer, ForeignKey('appeals.id', ondelete='CASCADE'), nullable=False, index=True)
    
    # –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: 'user', 'ai', 'specialist'
    message_type = Column(String(20), nullable=False)
    
    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    message_text = Column(Text, nullable=False)
    
    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # –°–≤—è–∑—å —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
    appeal = relationship("Appeal", back_populates="messages")
    
    def __repr__(self):
        return f"<AppealMessage(id={self.id}, appeal_id={self.appeal_id}, type={self.message_type})>"


class SpecialistResponse(Base):
    """
    –û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.
    –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–µ G (—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç_–æ—Ç–≤–µ—Ç) –≤ Google Sheets.
    """
    __tablename__ = 'specialist_responses'
    
    id = Column(Integer, primary_key=True, index=True)
    appeal_id = Column(Integer, ForeignKey('appeals.id', ondelete='CASCADE'), nullable=False, index=True)
    
    # –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
    response_text = Column(Text, nullable=False)
    
    # –ò–º—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    specialist_name = Column(String(100), nullable=True)
    
    # –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
    sent_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    
    # –°–≤—è–∑—å —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
    appeal = relationship("Appeal", back_populates="responses")
    
    def __repr__(self):
        return f"<SpecialistResponse(id={self.id}, appeal_id={self.appeal_id})>"


================================================================================
FILE: ./api/__init__.py
SIZE: 14 bytes
================================================================================

# API package


================================================================================
FILE: ./api/main.py
SIZE: 1411 bytes
================================================================================

"""
FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è REST API.
–û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å.
"""
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from api.routers import appeals
import os
from dotenv import load_dotenv

load_dotenv()

# –°–æ–∑–¥–∞–µ–º FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
app = FastAPI(
    title="MarketingBot API",
    description="REST API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é",
    version="1.0.0"
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
# –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
allowed_origins = os.getenv("ALLOWED_ORIGINS", "*").split(",")

app.add_middleware(
    CORSMiddleware,
    allow_origins=allowed_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–æ–≤
app.include_router(appeals.router, prefix="/api/appeals", tags=["appeals"])


@app.get("/")
async def root():
    """–ö–æ—Ä–Ω–µ–≤–æ–π endpoint"""
    return {
        "message": "MarketingBot API",
        "version": "1.0.0",
        "docs": "/docs"
    }


@app.get("/health")
async def health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è API"""
    return {"status": "ok"}


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)


================================================================================
FILE: ./api/schemas.py
SIZE: 2690 bytes
================================================================================

"""
Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö API.
"""
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime


# ========== Appeals (–û–±—Ä–∞—â–µ–Ω–∏—è) ==========

class AppealBase(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    partner_code: Optional[str] = None
    phone: Optional[str] = None
    fio: Optional[str] = None
    telegram_id: int
    status: str = "–Ω–æ–≤–æ–µ"


class AppealCreate(AppealBase):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    pass


class AppealResponse(AppealBase):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º"""
    id: int
    created_at: datetime
    updated_at: datetime
    
    class Config:
        from_attributes = True


class AppealUpdate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è"""
    status: Optional[str] = None
    partner_code: Optional[str] = None
    phone: Optional[str] = None
    fio: Optional[str] = None


# ========== Messages (–°–æ–æ–±—â–µ–Ω–∏—è) ==========

class MessageBase(BaseModel):
    """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    message_type: str = Field(..., description="–¢–∏–ø: user, ai, specialist")
    message_text: str


class MessageCreate(MessageBase):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
    pass


class MessageResponse(MessageBase):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º"""
    id: int
    appeal_id: int
    created_at: datetime
    
    class Config:
        from_attributes = True


# ========== Specialist Responses (–û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤) ==========

class SpecialistResponseCreate(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞"""
    response_text: str
    specialist_name: Optional[str] = None


class SpecialistResponseResponse(BaseModel):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å –æ—Ç–≤–µ—Ç–æ–º —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞"""
    id: int
    appeal_id: int
    response_text: str
    specialist_name: Optional[str] = None
    sent_at: datetime
    
    class Config:
        from_attributes = True


# ========== Auth (–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è) ==========

class AdminLogin(BaseModel):
    """–°—Ö–µ–º–∞ –¥–ª—è –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    username: str
    password: str


class AdminResponse(BaseModel):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    id: int
    username: str
    role: str
    
    class Config:
        from_attributes = True


class TokenResponse(BaseModel):
    """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º"""
    access_token: str
    token_type: str = "bearer"


================================================================================
FILE: ./api/routers/__init__.py
SIZE: 22 bytes
================================================================================

# API routers package


================================================================================
FILE: ./api/routers/appeals.py
SIZE: 7241 bytes
================================================================================

"""
API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏.
"""
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from db.database import get_db
from db.models import Appeal, AppealMessage, SpecialistResponse
from api.schemas import (
    AppealCreate, AppealResponse, AppealUpdate,
    MessageCreate, MessageResponse,
    SpecialistResponseCreate, SpecialistResponseResponse
)
from datetime import datetime

router = APIRouter()


@router.get("/", response_model=List[AppealResponse])
def get_appeals(
    status: Optional[str] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É"),
    telegram_id: Optional[int] = Query(None, description="–§–∏–ª—å—Ç—Ä –ø–æ Telegram ID"),
    skip: int = Query(0, ge=0),
    limit: int = Query(100, ge=1, le=1000),
    db: Session = Depends(get_db)
):
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
    
    - **status**: –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É (–Ω–æ–≤–æ–µ, –≤_—Ä–∞–±–æ—Ç–µ, –ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, –æ—Ç–≤–µ—Ç_–∏–∏, —Ä–µ—à–µ–Ω–æ)
    - **telegram_id**: –§–∏–ª—å—Ç—Ä –ø–æ Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    - **skip**: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
    - **limit**: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–¥–æ 1000)
    """
    query = db.query(Appeal)
    
    if status:
        query = query.filter(Appeal.status == status)
    if telegram_id:
        query = query.filter(Appeal.telegram_id == telegram_id)
    
    # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
    query = query.order_by(Appeal.created_at.desc())
    
    appeals = query.offset(skip).limit(limit).all()
    return appeals


@router.get("/{appeal_id}", response_model=AppealResponse)
def get_appeal(appeal_id: int, db: Session = Depends(get_db)):
    """
    –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ ID.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    return appeal


@router.post("/", response_model=AppealResponse)
def create_appeal(appeal: AppealCreate, db: Session = Depends(get_db)):
    """
    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ.
    """
    db_appeal = Appeal(**appeal.dict())
    db.add(db_appeal)
    db.commit()
    db.refresh(db_appeal)
    return db_appeal


@router.put("/{appeal_id}", response_model=AppealResponse)
def update_appeal(
    appeal_id: int,
    appeal_update: AppealUpdate,
    db: Session = Depends(get_db)
):
    """
    –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –ø–æ–ª—è
    update_data = appeal_update.dict(exclude_unset=True)
    for field, value in update_data.items():
        setattr(appeal, field, value)
    
    appeal.updated_at = datetime.utcnow()
    db.commit()
    db.refresh(appeal)
    return appeal


@router.patch("/{appeal_id}/status")
def update_status(
    appeal_id: int,
    status: str = Query(..., description="–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å"),
    db: Session = Depends(get_db)
):
    """
    –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    appeal.status = status
    appeal.updated_at = datetime.utcnow()
    db.commit()
    return {"message": "–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω", "status": status}


# ========== Messages (–°–æ–æ–±—â–µ–Ω–∏—è) ==========

@router.get("/{appeal_id}/messages", response_model=List[MessageResponse])
def get_appeal_messages(appeal_id: int, db: Session = Depends(get_db)):
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    messages = db.query(AppealMessage).filter(
        AppealMessage.appeal_id == appeal_id
    ).order_by(AppealMessage.created_at.asc()).all()
    
    return messages


@router.post("/{appeal_id}/messages", response_model=MessageResponse)
def add_message(
    appeal_id: int,
    message: MessageCreate,
    db: Session = Depends(get_db)
):
    """
    –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ–±—Ä–∞—â–µ–Ω–∏–µ.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    db_message = AppealMessage(
        appeal_id=appeal_id,
        **message.dict()
    )
    db.add(db_message)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è
    appeal.updated_at = datetime.utcnow()
    
    db.commit()
    db.refresh(db_message)
    return db_message


# ========== Specialist Responses (–û—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤) ==========

@router.post("/{appeal_id}/response", response_model=SpecialistResponseResponse)
def add_specialist_response(
    appeal_id: int,
    response: SpecialistResponseCreate,
    db: Session = Depends(get_db)
):
    """
    –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∫ –æ–±—Ä–∞—â–µ–Ω–∏—é.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    # –°–æ–∑–¥–∞–µ–º –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
    db_response = SpecialistResponse(
        appeal_id=appeal_id,
        **response.dict()
    )
    db.add(db_response)
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
    db_message = AppealMessage(
        appeal_id=appeal_id,
        message_type="specialist",
        message_text=f"üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢: {response.response_text}"
    )
    db.add(db_message)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–≤_—Ä–∞–±–æ—Ç–µ" –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
    if appeal.status not in ["–≤_—Ä–∞–±–æ—Ç–µ", "—Ä–µ—à–µ–Ω–æ"]:
        appeal.status = "–≤_—Ä–∞–±–æ—Ç–µ"
    
    appeal.updated_at = datetime.utcnow()
    
    db.commit()
    db.refresh(db_response)
    return db_response


@router.get("/{appeal_id}/responses", response_model=List[SpecialistResponseResponse])
def get_appeal_responses(appeal_id: int, db: Session = Depends(get_db)):
    """
    –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é.
    """
    appeal = db.query(Appeal).filter(Appeal.id == appeal_id).first()
    if not appeal:
        raise HTTPException(status_code=404, detail="–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
    
    responses = db.query(SpecialistResponse).filter(
        SpecialistResponse.appeal_id == appeal_id
    ).order_by(SpecialistResponse.sent_at.desc()).all()
    
    return responses


================================================================================
FILE: ./api/services/__init__.py
SIZE: 23 bytes
================================================================================

# API services package


================================================================================
FILE: ./api/services/appeals_db.py
SIZE: 22271 bytes
================================================================================

"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
–ó–∞–º–µ–Ω–∞ –¥–ª—è AppealsService (Google Sheets).
–ò–¥–µ–Ω—Ç–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º.
"""
import logging
from datetime import datetime, timedelta
from typing import Optional, List, Dict
from sqlalchemy.orm import Session
from db.models import Appeal, AppealMessage, SpecialistResponse

logger = logging.getLogger(__name__)


class AppealsServiceDB:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞—â–µ–Ω–∏—è–º–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
    –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–æ–≥ AppealsService, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î –≤–º–µ—Å—Ç–æ Google Sheets.
    """
    
    def __init__(self, db: Session):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞.
        
        Args:
            db: SQLAlchemy —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        """
        self.db = db
    
    def is_available(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π."""
        try:
            # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            self.db.execute("SELECT 1")
            return True
        except Exception as e:
            logger.error(f"–°–µ—Ä–≤–∏—Å –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {e}")
            return False
    
    def create_appeal(self, code: str, phone: str, fio: str, telegram_id: int, text: str) -> bool:
        """
        –°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–µ.
        
        Args:
            code: –∫–æ–¥ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            phone: —Ç–µ–ª–µ—Ñ–æ–Ω –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            fio: –§–ò–û –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            text: —Ç–µ–∫—Å—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è telegram_id={telegram_id}, code={code}, phone={phone}, fio={fio}")
            
            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ {appeal.id} –¥–ª—è telegram_id {telegram_id}")
                appeal.partner_code = code or appeal.partner_code
                appeal.phone = phone or appeal.phone
                appeal.fio = fio or appeal.fio
                appeal.updated_at = datetime.utcnow()
            else:
                # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ
                logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è telegram_id {telegram_id}")
                appeal = Appeal(
                    telegram_id=telegram_id,
                    partner_code=code,
                    phone=phone,
                    fio=fio,
                    status='–Ω–æ–≤–æ–µ'
                )
                self.db.add(appeal)
                self.db.flush()  # –ü–æ–ª—É—á–∞–µ–º ID
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            message = AppealMessage(
                appeal_id=appeal.id,
                message_type='user',
                message_text=text
            )
            self.db.add(message)
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (>30 –¥–Ω–µ–π)
            self._cleanup_old_messages(appeal.id)
            
            self.db.commit()
            logger.info(f"–û–±—Ä–∞—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
            return True
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}", exc_info=True)
            self.db.rollback()
            return False
    
    def _cleanup_old_messages(self, appeal_id: int):
        """–û—á–∏—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π."""
        try:
            cutoff_date = datetime.utcnow() - timedelta(days=30)
            old_messages = self.db.query(AppealMessage).filter(
                AppealMessage.appeal_id == appeal_id,
                AppealMessage.created_at < cutoff_date
            ).all()
            
            for msg in old_messages:
                self.db.delete(msg)
            
            if old_messages:
                logger.info(f"–£–¥–∞–ª–µ–Ω–æ {len(old_messages)} —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è {appeal_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {e}")
    
    def get_appeal_status(self, telegram_id: int) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            str: —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –∏–ª–∏ '–Ω–æ–≤–æ–µ' –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                status = appeal.status
                logger.info(f"–ù–∞–π–¥–µ–Ω —Å—Ç–∞—Ç—É—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}: {status}")
                return status
            else:
                logger.info(f"–°—Ç–∞—Ç—É—Å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º '–Ω–æ–≤–æ–µ'")
                return '–Ω–æ–≤–æ–µ'
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è: {e}")
            return '–Ω–æ–≤–æ–µ'
    
    def set_status_in_work(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–í —Ä–∞–±–æ—Ç–µ'.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                appeal.status = '–≤_—Ä–∞–±–æ—Ç–µ'
                appeal.updated_at = datetime.utcnow()
                self.db.commit()
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–í —Ä–∞–±–æ—Ç–µ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ '–í —Ä–∞–±–æ—Ç–µ': {e}")
            self.db.rollback()
            return False
    
    def set_status_escalated(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É'.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                appeal.status = '–ø–µ—Ä–µ–¥–∞–Ω–æ_—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É'
                appeal.updated_at = datetime.utcnow()
                self.db.commit()
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ '–ü–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É': {e}")
            self.db.rollback()
            return False
    
    def set_status_resolved(self, telegram_id: int) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞—â–µ–Ω–∏—è –Ω–∞ '–†–µ—à–µ–Ω–æ'.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                appeal.status = '—Ä–µ—à–µ–Ω–æ'
                appeal.updated_at = datetime.utcnow()
                self.db.commit()
                logger.info(f"–°—Ç–∞—Ç—É—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω '–†–µ—à–µ–Ω–æ' –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞ '–†–µ—à–µ–Ω–æ': {e}")
            self.db.rollback()
            return False
    
    def add_ai_response(self, telegram_id: int, response_text: str) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            response_text: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –ò–ò
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ò–ò
                message = AppealMessage(
                    appeal_id=appeal.id,
                    message_type='ai',
                    message_text=response_text
                )
                self.db.add(message)
                
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                appeal.status = '–æ—Ç–≤–µ—Ç_–∏–∏'
                appeal.updated_at = datetime.utcnow()
                
                self.db.commit()
                logger.info(f"–û—Ç–≤–µ—Ç –ò–ò –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò: {e}")
            self.db.rollback()
            return False
    
    def add_user_message(self, telegram_id: int, message_text: str) -> bool:
        """
        –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –ø—Ä–∏ —Ä–µ–∂–∏–º–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            message_text: —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            
        Returns:
            bool: True –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                message = AppealMessage(
                    appeal_id=appeal.id,
                    message_type='user',
                    message_text=message_text
                )
                self.db.add(message)
                appeal.updated_at = datetime.utcnow()
                self.db.commit()
                logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–°—Ç—Ä–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (telegram_id={telegram_id})")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            self.db.rollback()
            return False
    
    def add_specialist_response(self, telegram_id: int, response_text: str) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –æ–±—Ä–∞—â–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            response_text: —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ
        """
        try:
            appeal = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).first()
            
            if appeal:
                # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
                message = AppealMessage(
                    appeal_id=appeal.id,
                    message_type='specialist',
                    message_text=f"üë®‚Äçüíº –°–ü–ï–¶–ò–ê–õ–ò–°–¢: {response_text}"
                )
                self.db.add(message)
                
                # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞
                specialist_response = SpecialistResponse(
                    appeal_id=appeal.id,
                    response_text=response_text
                )
                self.db.add(specialist_response)
                
                appeal.updated_at = datetime.utcnow()
                self.db.commit()
                logger.info(f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id} (ID: {appeal.id})")
                return True
            else:
                logger.warning(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
                return False
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞: {e}")
            self.db.rollback()
            return False
    
    def check_for_responses(self) -> List[Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.
        –í –ë–î –æ—Ç–≤–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ API, –Ω–æ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –æ—Å—Ç–∞–≤–ª–µ–Ω –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        —Å ResponseMonitor (–∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –ë–î –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏).
        
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        """
        try:
            # –ò—â–µ–º –æ—Ç–≤–µ—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
            # –í –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —ç—Ç–æ –º–æ–∂–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ sent_to_user
            # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, —Ç–∞–∫ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ API
            # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ is_sent –≤ SpecialistResponse
            return []
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤: {e}")
            return []
    
    def clear_response(self, row: int) -> bool:
        """
        –û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
        –í –ë–î —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –æ—Ç–≤–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ.
        –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
        
        Args:
            row: –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ë–î)
            
        Returns:
            bool: True
        """
        # –í –ë–î –æ—Ç–≤–µ—Ç—ã –Ω–µ –Ω—É–∂–Ω–æ –æ—á–∏—â–∞—Ç—å, –æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
        return True
    
    def has_records(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.
        
        Returns:
            bool: True –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏
        """
        try:
            count = self.db.query(Appeal).count()
            return count > 0
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∏—Å–µ–π: {e}")
            return False
    
    def get_user_appeals(self, telegram_id: int) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        
        Args:
            telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
            
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        """
        try:
            appeals = self.db.query(Appeal).filter(
                Appeal.telegram_id == telegram_id
            ).all()
            
            result = []
            for appeal in appeals:
                result.append({
                    'id': appeal.id,
                    'telegram_id': appeal.telegram_id,
                    'partner_code': appeal.partner_code,
                    'phone': appeal.phone,
                    'fio': appeal.fio,
                    'status': appeal.status,
                    'created_at': appeal.created_at.isoformat() if appeal.created_at else None,
                    'updated_at': appeal.updated_at.isoformat() if appeal.updated_at else None
                })
            
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(result)} –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {telegram_id}")
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            return []
    
    def get_all_appeals(self, status: Optional[str] = None) -> List[Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É—è –ø–æ —Å—Ç–∞—Ç—É—Å—É.
        
        Args:
            status: —Å—Ç–∞—Ç—É—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π
        """
        try:
            query = self.db.query(Appeal)
            
            if status:
                query = query.filter(Appeal.status == status)
            
            appeals = query.all()
            
            result = []
            for appeal in appeals:
                result.append({
                    'id': appeal.id,
                    'telegram_id': appeal.telegram_id,
                    'partner_code': appeal.partner_code,
                    'phone': appeal.phone,
                    'fio': appeal.fio,
                    'status': appeal.status,
                    'created_at': appeal.created_at.isoformat() if appeal.created_at else None,
                    'updated_at': appeal.updated_at.isoformat() if appeal.updated_at else None
                })
            
            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(result)} –æ–±—Ä–∞—â–µ–Ω–∏–π" + (f" —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{status}'" if status else ""))
            return result
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π: {e}")
            return []
    
    def check_for_resolved_status(self) -> List[Dict]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '–†–µ—à–µ–Ω–æ', –æ –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ —É–≤–µ–¥–æ–º–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
        –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å ResponseMonitor.
        
        Returns:
            List[Dict]: —Å–ø–∏—Å–æ–∫ —Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        """
        try:
            appeals = self.db.query(Appeal).filter(
                Appeal.status == '—Ä–µ—à–µ–Ω–æ'
            ).all()
            
            resolved_appeals = []
            for appeal in appeals:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–∞—Ä–∫–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                last_message = self.db.query(AppealMessage).filter(
                    AppealMessage.appeal_id == appeal.id
                ).order_by(AppealMessage.created_at.desc()).first()
                
                if last_message and "‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–æ" not in last_message.message_text:
                    resolved_appeals.append({
                        'row': appeal.id,
                        'telegram_id': appeal.telegram_id,
                        'appeals_text': ''  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ë–î
                    })
            
            if resolved_appeals:
                logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(resolved_appeals)} —Ä–µ—à–µ–Ω–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
            
            return resolved_appeals
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—à–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤: {e}")
            return []


================================================================================
FILE: ./handlers/utils.py
SIZE: 9513 bytes
================================================================================

import os
import logging
from urllib.parse import urlparse
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

logger = logging.getLogger(__name__)

def _validate_url(url: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∞–ª–∏–¥–Ω—ã–º URL."""
    if not url:
        return False
    try:
        result = urlparse(url)
        return all([result.scheme, result.netloc])
    except Exception:
        return False

def get_web_app_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL WebApp –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ .env)."""
    base_url = os.getenv("WEB_APP_URL") or ""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = base_url + "index.html"
    logger.debug(f"Generated WebApp URL: {url}")
    return url

def get_spa_menu_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL SPA –º–µ–Ω—é –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    base_url = os.getenv("WEB_APP_URL") or ""
    # –í–µ—Ä—Å–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞ WebApp
    cache_bust = "v=20260107-4"
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = f"{base_url}menu.html?{cache_bust}"
    logger.debug(f"Generated SPA Menu URL: {url}")
    return url

def create_specialist_button() -> InlineKeyboardMarkup:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    keyboard = [[InlineKeyboardButton("üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", callback_data="contact_specialist")]]
    return InlineKeyboardMarkup(keyboard)

def _is_user_escalation_request(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
    """
    import re
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: —É–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    text_normalized = re.sub(r'[^\w\s]', '', text.lower())
    
    # –ü—Ä—è–º—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (30 —Ñ—Ä–∞–∑)
    escalation_phrases = [
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Ö–æ—á—É –∫ —á–µ–ª–æ–≤–µ–∫—É',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫',
        '—Ä–µ–∞–ª—å–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–¥–∞–π—Ç–µ –º–Ω–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫',
        '—Ö–æ—á—É –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–Ω—É–∂–µ–Ω –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
        '—Ö–æ—á—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–¥–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–π –≤–æ–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ—é –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–¥–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    for phrase in escalation_phrases:
        if phrase in text_normalized:
            return True
    
    return False

def _is_ai_asking_for_escalation(ai_response: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ò–ò –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    if not ai_response:
        return False
        
    response_lower = ai_response.lower()
    
    # –§—Ä–∞–∑—ã, –∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    escalation_questions = [
        '–Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    for phrase in escalation_questions:
        if phrase in response_lower:
            return True
    
    return False

def _is_escalation_confirmation(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    text_lower = text.lower()
    
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    confirmation_phrases = [
        '–¥–∞',
        '–¥–∞, –Ω—É–∂–Ω–æ',
        '–¥–∞, –ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '–¥–∞, —Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '–¥–∞, —Å–≤—è–∂–∏—Ç–µ',
        '–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–¥–∞, –∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞, –¥–∞–≤–∞–π—Ç–µ',
        '–¥–∞, —Ö–æ—Ä–æ—à–æ',
        '–¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω',
        '–Ω—É–∂–Ω–æ',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '—Å–≤—è–∂–∏—Ç–µ',
        '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞–≤–∞–π—Ç–µ',
        '—Ö–æ—Ä–æ—à–æ',
        '—Å–æ–≥–ª–∞—Å–µ–Ω',
        '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—Ä–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    for phrase in confirmation_phrases:
        if phrase in text_lower:
            return True
    
    return False

def _should_show_specialist_button(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å –µ–≥–æ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º/–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
    """
    text_lower = text.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
    specialist_keywords = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–º—É —á–µ–ª–æ–≤–µ–∫—É', '–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–º–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞', '–º–µ–Ω–µ–¥–∂–µ—Ä—É', '–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º',
        '–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä—É', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
        '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å', '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ', '—Å–æ–µ–¥–∏–Ω–∏', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
        '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '—á–µ–ª–æ–≤–µ–∫', '—á–µ–ª–æ–≤–µ–∫–∞', '—á–µ–ª–æ–≤–µ–∫—É', '—á–µ–ª–æ–≤–µ–∫–æ–º',
        '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç–µ', '–∑–≤–æ–Ω–æ–∫', '–∑–≤–æ–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '—Å–≤—è–∑–∞—Ç—å—Å—è —Å', '—Å–≤—è–∑–∞—Ç—å', '—Å–≤—è–∑–∞—Ç—å —Å',
        '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '–ø–æ–¥–¥–µ—Ä–∂–∫—É', '–ø–æ–¥–¥–µ—Ä–∂–∫–µ', '–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',
        '–ø–æ–º–æ—â—å', '–ø–æ–º–æ—â–∏', '–ø–æ–º–æ—á—å', '–ø–æ–º–æ—â—å—é',
        '–Ω–µ –º–æ–≥—É', '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
        '–ø—Ä–æ–±–ª–µ–º–∞', '–ø—Ä–æ–±–ª–µ–º—ã', '–ø—Ä–æ–±–ª–µ–º—É', '–ø—Ä–æ–±–ª–µ–º–æ–π',
        '—Å–ª–æ–∂–Ω–æ', '—Å–ª–æ–∂–Ω—ã–π', '—Å–ª–æ–∂–Ω–∞—è', '—Å–ª–æ–∂–Ω–æ–µ',
        '–Ω–µ –ø–æ–Ω–∏–º–∞—é', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ', '–Ω–µ —è—Å–Ω–æ',
        '–æ–±—ä—è—Å–Ω–∏—Ç–µ', '–æ–±—ä—è—Å–Ω–∏', '–æ–±—ä—è—Å–Ω–∏—Ç—å',
        '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–ø–æ–¥—Ä–æ–±–Ω–æ', '–ø–æ–¥—Ä–æ–±–Ω—ã–π',
        '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '–¥–µ—Ç–∞–ª—å–Ω–æ'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for keyword in specialist_keywords:
        if keyword in text_lower:
            return True
    
    return False


================================================================================
=== STATISTICS ===
================================================================================

Total files processed: 105
Total size: 0.82 MB


================================================================================
=== SECURITY WARNINGS ===
================================================================================

‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –í —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:

  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./analyze_new_sheet.py: ...vice_account import Credentials                    ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./analyze_new_sheet.py: ...            creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./collect_code.py: ...TE[_\s]*KEY',     r'CREDENTIALS', ]  # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ ....
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./menu.html: ...                    credentials: 'omit', // –ù–µ –æ—Ç–ø—Ä...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./promotions_api.py: ...vice_account import Credentials                  # ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./promotions_api.py: ...            creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./sheets_gateway.py: ...vice_account import Credentials                  sa...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./sheets_gateway.py: ...            creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./sheets_gateway.py: ...vice_account import Credentials                  sa...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./sheets_gateway.py: ...            creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./migrations/migrate_appeals.py: ...vice_account import Credentials import json from db...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./migrations/migrate_appeals.py: ...t()         creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/CHANGELOG.md: ...—Ä–∞–≤–∏–ª–∞ –¥–ª—è `.env` –∏ credentials —Ñ–∞–π–ª–æ–≤ - –û–±–Ω–æ–≤–ª–µ–Ω `...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/DEPLOYMENT.md: ...GCP_SA_FILE=path_to_credentials.json  # WebApp (–¥–ª—è...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/MIGRATION_IMPLEMENTATION.md: ...—ã–µ –¥–æ–º–µ–Ω—ã     allow_credentials=True,     allow_met...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/MIGRATION_IMPLEMENTATION.md: ...vice_account import Credentials from sqlalchemy.orm...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/MIGRATION_IMPLEMENTATION.md: ...a_json)     creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/SECURITY.md: ...–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ `credentials.json` –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ...n the repo root as `credentials.json` (DO NOT commi...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ...vice_account import Credentials   def extract_sprea...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ...FileNotFoundError(f"Credentials file not found: {cr...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ...,     ]     creds = Credentials.from_service_accoun...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ..."--creds", default="credentials.json", help="Path t...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/tools/fetch_sheets.py: ... to service account credentials JSON")     parser.a...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...# –®–∞–≥ 4: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞  1. –í –Ω–∞—Å—Ç—Ä–æ–π...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...d64** 3. –°–∫–∞—á–∞–π—Ç–µ **credentials —Ñ–∞–π–ª** (JSON) - –æ–Ω ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...ID (–∏–∑ —à–∞–≥–∞ 2)    - Credentials —Ñ–∞–π–ª (JSON) –Ω–∞ –ª–æ–∫–∞...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ... Tunnel ID - –ü—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É  ### –í–∞—Ä–∏–∞–Ω—Ç ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...lared  # –°–∫–æ–ø–∏—Ä—É–π—Ç–µ credentials —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä # (–≤...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...tunnel: <TUNNEL_ID> credentials-file: /etc/cloudfla...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/CLOUDFLARE_TUNNEL_SETUP.md: ...lidate  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials —Ñ–∞–π–ª sudo cat /etc/...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/QUICK_START_CLOUDFLARE.md: ...8080` 6. –°–∫–∞—á–∞–π—Ç–µ **credentials —Ñ–∞–π–ª** (JSON)  ### ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/archive/QUICK_START_CLOUDFLARE.md: ...–∏–∑ —à–∞–≥–∞ 1) - –ü—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É  ### 3. –û–±–Ω–æ–≤...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/guides/GOOGLE_SHEETS.md: ...–æ–ø–∞—Å–Ω–æ—Å—Ç–∏   WEBHOOK_SECRET: 'your_secret_key_here',      // ID –ª–∏—Å—Ç–∞ ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/guides/GOOGLE_SHEETS.md: ...nv –¥–æ–±–∞–≤—å—Ç–µ WEBHOOK_SECRET=your_very_secure_secret_key_here ```  ## üêõ –û—Ç–ª–∞–¥–∫–∞ –∏...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./docs/deployment/DEPLOYMENT_YANDEX.md: ...GCP_SA_FILE=path_to_credentials.json  # WebApp (–¥–ª—è...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...cho "   4. –°–∫–∞—á–∞–π—Ç–µ credentials —Ñ–∞–π–ª (JSON)" echo "...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...cho "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É (JSON) –Ω–∞ –≤–∞—à...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:" read CREDENTIALS_FILE  if [ ! -f "$C...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...S_FILE  if [ ! -f "$CREDENTIALS_FILE" ]; then     e...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...n     echo "‚ùå –§–∞–π–ª $CREDENTIALS_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω"    ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...ho "==> –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞..." EOF  # –ö–æ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ....." EOF  # –ö–æ–ø–∏—Ä—É–µ–º credentials —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä scp ...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...scp -i "$SSH_KEY" "$CREDENTIALS_FILE" "${VM_USER}@$...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...ho "==> –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ credentials —Ñ–∞–π–ª–∞..." sudo mv "...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel.sh: ...nnel: \${TUNNEL_ID} credentials-file: /etc/cloudfla...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ... echo "  3. –°–∫–∞—á–∞–ª–∏ credentials —Ñ–∞–π–ª (JSON)" echo "...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...cho "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ credentials —Ñ–∞–π–ª—É (JSON):" read...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...—Ñ–∞–π–ª—É (JSON):" read CREDENTIALS_FILE  if [ ! -f "$C...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...S_FILE  if [ ! -f "$CREDENTIALS_FILE" ]; then     e...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ..."‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $CREDENTIALS_FILE"     exit 1 fi...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...ared  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials sudo cp /tmp/${TUNN...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...unnel: ${TUNNEL_ID} credentials-file: /etc/cloudfla...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ... EOF  # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ credentials —Ñ–∞–π–ª–∞ scp -i "$SSH_...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_cloudflare_tunnel_simple.sh: ...scp -i "$SSH_KEY" "$CREDENTIALS_FILE" "${VM_USER}@$...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./scripts/setup_yandex_systemd.sh: ...ERVICE_ACCOUNT_JSON=credentials.json SPREADSHEET_ID...
  ‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–µ–∫—Ä–µ—Ç –≤ ./api/main.py: ..._origins,     allow_credentials=True,     allow_met...

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–∏ —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π!
