# üìë –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ê—É–¥–∏—Ç: –°–∏—Å—Ç–µ–º–∞ –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ–≥–æ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞ (Gemini 3 Pro)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–¥—ã –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –ª–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Gemini 3.

> [!IMPORTANT]
> –í—Å–µ API-–∫–ª—é—á–∏, —Ç–æ–∫–µ–Ω—ã –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã (–∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `–°–ö–†–´–¢–û`).

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ò–ò (Gemini 3 Pro)
**–§–∞–π–ª:** [gemini_service.py](file:///Users/verakoroleva/Desktop/marketingbot/gemini_service.py)

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
*   **–ò–Ω—ä–µ–∫—Ü–∏—è –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ (Context Injection):** –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–¥–∞—á—É —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –∫–∞–∫ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç `user` —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º –æ—Ç `model`. –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ Gemini 3 Pro "–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–æ–ª—å" –¥–æ –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞.
*   **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ò—Å—Ç–æ—Ä–∏–µ–π:** –ú–µ—Ç–æ–¥ `_add_to_history` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–ø–µ—Ä–≤—ã–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è) –∏ –æ–±—Ä–µ–∑–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –¥–∏–∞–ª–æ–≥ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ (10 —Å–æ–æ–±—â–µ–Ω–∏–π).
*   **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –û—Ç–∫–ª—é—á–µ–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã `safety_settings` (`BLOCK_NONE`) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ª–æ–∂–Ω–æ–π —Ü–µ–Ω–∑—É—Ä—ã –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É.

### –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–æ):
```python
# –ò–ù–™–ï–ö–¶–ò–Ø –ö–û–ù–¢–ï–ö–°–¢–ê –í GEMINI 3
def _get_or_create_history(self, user_id: int):
    if user_id not in self.user_histories:
        self.user_histories[user_id] = [
            types.Content(role="user", parts=[types.Part(text=self.system_instruction)]),
            types.Content(role="model", parts=[types.Part(text="–ü–æ–Ω—è–ª, —è ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–≠—Ç–∞–∂–∏¬ª...")])
        ]
    return self.user_histories[user_id]
```

---

## 2. –õ–æ–≥–∏–∫–∞ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ RAG (–ò–Ω–¥–µ–∫—Å–∞—Ç–æ—Ä)
**–§–∞–π–ª:** [GOOGLE_APPS_SCRIPT_FULL.js](file:///Users/verakoroleva/Desktop/marketingbot/GOOGLE_APPS_SCRIPT_FULL.js)

### –ê–Ω–∞–ª–∏–∑:
*   **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å—Å—ã–ª–æ–∫:** –°–∫—Ä–∏–ø—Ç –≤ Google Sheets –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–∞–π–ª—ã Google Drive –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ –ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏ `https://lh3.googleusercontent.com/d/[ID]`.
*   **–ü—Ä–æ–±–ª–µ–º–∞ Base64:** –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ `data:image/...` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. Telegram API –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç–∞–∫–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç –ª–∏–±–æ URL, –ª–∏–±–æ FileID.

---

## 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –°–æ–æ–±—â–µ–Ω–∏–π
**–§–∞–π–ª:** [handlers.py](file:///Users/verakoroleva/Desktop/marketingbot/handlers.py)

*   **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:** –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ `auth_service` –ø–µ—Ä–µ–¥ –ª—é–±—ã–º –≤—ã–∑–æ–≤–æ–º –ò–ò.
*   **–ò–Ω–¥–∏–∫–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `send_chat_action(action="typing")` –¥–ª—è UX –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç Gemini 3 (–∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å 3-7 —Å–µ–∫—É–Ω–¥ –∏–∑-–∑–∞ –≥–ª—É–±–æ–∫–æ–≥–æ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –º–æ–¥–µ–ª–∏).

---

## 4. –õ–æ–≥–∏ –°–µ—Ä–≤–µ—Ä–∞ (Debug Dump)

### ‚úÖ –£—Å–ø–µ—Ö (–†–∞–±–æ—Ç–∞ Gemini 3 Pro):
```text
Jan 18 09:15:10 - ai_service - INFO - GeminiService is ready
Jan 18 09:15:50 - gemini_service - INFO - Sending request to Gemini for user 284355186 (history: 3 messages)
Jan 18 09:15:55 - gemini_service - INFO - Received response from Gemini for user 284355186: 450 chars
```

### ‚ùå –û—à–∏–±–∫–∞ (Base64 –≤ –ê–∫—Ü–∏—è—Ö):
```text
Jan 18 09:15:24 - promotions_notifier - WARNING - –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 284355186: 
Wrong remote file identifier specified: wrong character in the string
```

---
**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** Antigravity AI
**–î–∞—Ç–∞:** 18 —è–Ω–≤–∞—Ä—è 2026 –≥.
