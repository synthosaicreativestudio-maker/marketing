/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
 * –í–µ—Ä—Å–∏—è 3.0.8 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeError: SpreadsheetApp.getSheetByName is not a function)
 *
 * –ò–∑–º–µ–Ω–µ–Ω–∏—è:
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName is not a function –≤ setAdditionalHeaders,
 *    –ø—É—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SPREADSHEET.getSheetByName() –≤–º–µ—Å—Ç–æ SpreadsheetApp.getSheetByName().
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ SyntaxError: Unexpected token ')' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ buildReportSummaries.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ 'SPREADSheetApp' –Ω–∞ 'SpreadsheetApp' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ setAdditionalHeaders.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ ReferenceError: allObjectsPlusAnalytics is not defined –≤ findCompetitorsForAllObjects
 *    –ø—É—Ç–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è dataMap –∏–∑ objectRow (—Å—Ç–æ–ª–±—Ü—ã A:O).
 *  - [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ª–∏—Å—Ç–∞ "3. 56. –∞–≤–∏—Ç–æ" –≤ —Å—Ç–æ–ª–±—Ü—ã P-Q –Ω–∞ –ª–∏—Å—Ç–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ".
 *  - [–õ–û–ì–ò–ö–ê] –ó–∞–º–µ–Ω–µ–Ω "–ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, %" –Ω–∞ "–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏" (A+, A, B, C, C-).
 *  - [–§–£–ù–ö–¶–ò–Ø] –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è getLiquidityType –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 *  - [–û–¢–ß–ï–¢] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–¢–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏".
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–¥–∞, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 *  - [–ê–†–•–ò–¢–ï–ö–¢–£–†–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –ª–∏–Ω–µ–π–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å–∞–º—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è.
 *  - [–õ–û–ì–ò–ö–ê] –£–ª—É—á—à–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø—É —Ä–µ–º–æ–Ω—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ formatCompetitorRow –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 */

// ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ==================

const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const SETTINGS_SHEET_NAME = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
const IS_DEBUG = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

const STALE_LISTING_MONTHS = 6;
const TRIM_PERCENTAGE = 0.1;

const SHEETS = {
  MAIN_ANALYTICS: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ',
  COMPETITORS: '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  ADDRESS_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É',
  ACTIVE_GROUP: '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ',
  AVITO: '3. 56. –∞–≤–∏—Ç–æ', CIAN: '5. 56. —Ü–∏–∞–Ω', DOMCLICK: '6. 56. –¥–æ–º–∫–ª–∏–∫',
  ACTIVE_COMPETITORS: '2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ',
  SOLD_COMPETITORS: '1. 2. –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  // –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
  SINGLE_OBJECT_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É',
  SINGLE_OBJECT_ANALYSIS: '–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞',
  SINGLE_COMPETITORS: '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
};

// ================== –ö–ê–õ–ò–ë–†–û–í–ê–ù–ù–´–ï –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–´ –ö–ê–ß–ï–°–¢–í–ê (v1.0) ==================
// –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ 13,490 —Å–¥–µ–ª–æ–∫
const QUALITY_COEFFICIENTS = {
  // –†–µ–º–æ–Ω—Ç
  REPAIR_DESIGNER: 0.12,    // –î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç: +12%
  REPAIR_EURO: 0.08,        // –ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç: +8%
  REPAIR_MODERN: 0.06,      // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç: +6%
  REPAIR_COSMETIC: 0,       // –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π: 0%
  REPAIR_NEEDS_WORK: -0.12, // –¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞: -12%
  REPAIR_OLD: -0.15,        // –°—Ç–∞—Ä—ã–π/—É–±–∏—Ç—ã–π: -15%
  
  // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
  BUILDING_NEW: 0.06,       // –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (< 5 –ª–µ—Ç): +6%
  BUILDING_MODERN: 0.03,    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π (5-15 –ª–µ—Ç): +3%
  BUILDING_NORMAL: 0,       // –û–±—ã—á–Ω—ã–π (15-40 –ª–µ—Ç): 0%
  BUILDING_OLD: -0.04,      // –°—Ç–∞—Ä—ã–π (> 40 –ª–µ—Ç, –ø–æ—Å–ª–µ 1980): -4%
  BUILDING_VERY_OLD: -0.08, // –û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–π (–¥–æ 1980): -8%
  
  // –≠—Ç–∞–∂
  FLOOR_FIRST: -0.05,       // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂: -5%
  FLOOR_LAST: -0.03,        // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂: -3%
  FLOOR_MIDDLE: 0.02,       // –°—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏: +2%
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
  HAS_PROF_PHOTO: 0.02,     // –ü—Ä–æ—Ñ. —Ñ–æ—Ç–æ: +2%
  HAS_GOOD_DESC: 0.01,      // –û–ø–∏—Å–∞–Ω–∏–µ > 400 —Å–∏–º–≤–æ–ª–æ–≤: +1%
  HAS_FLOOR_PLAN: 0.01      // –ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: +1%
};

// ================== –°–ï–ó–û–ù–ù–´–ï –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–´ (–¢—é–º–µ–Ω—å, v1.0) ==================
// –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (1 = –±–∞–∑–æ–≤—ã–π, >1 = –¥–æ–ª—å—à–µ, <1 = –±—ã—Å—Ç—Ä–µ–µ)
const SEASONAL_COEFFICIENTS = {
  1: 1.20,  // –Ø–Ω–≤–∞—Ä—å: +20% –∫ —Å—Ä–æ–∫—É (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
  2: 1.10,  // –§–µ–≤—Ä–∞–ª—å: +10%
  3: 0.95,  // –ú–∞—Ä—Ç: -5% (–Ω–∞—á–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  4: 0.85,  // –ê–ø—Ä–µ–ª—å: -15% (–≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å)
  5: 0.80,  // –ú–∞–π: -20% (–ø–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  6: 0.85,  // –ò—é–Ω—å: -15%
  7: 0.95,  // –ò—é–ª—å: -5% (–æ—Ç–ø—É—Å–∫–∞)
  8: 0.90,  // –ê–≤–≥—É—Å—Ç: -10%
  9: 0.85,  // –°–µ–Ω—Ç—è–±—Ä—å: -15% (–≤–æ–∑–≤—Ä–∞—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  10: 0.90, // –û–∫—Ç—è–±—Ä—å: -10%
  11: 1.00, // –ù–æ—è–±—Ä—å: –±–∞–∑–æ–≤—ã–π
  12: 1.15  // –î–µ–∫–∞–±—Ä—å: +15% (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
};

// ================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==================

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Google –¢–∞–±–ª–∏—Ü –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
 */
function onOpen() { try { SpreadsheetApp.getUi().createMenu('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑')
    .addItem('‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏', 'startAllFunctions')
    .addItem('üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Å—Ç—ã', 'formatSheets')
    .addSeparator()
    .addItem('üîß –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã', 'setupNewSheets')
    .addItem('üìã –°–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤', 'createCriteriaSheet')
    .addSeparator()
    .addSubMenu(SpreadsheetApp.getUi().createMenu('üîë API –ö–ª—é—á–∏ Gemini')
      .addItem('üîπ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á–∏', 'setDefaultApiKeys')
      .addSeparator()
      .addItem('üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª—é—á–µ–π', 'checkApiKeys'))
    .addSeparator()
    .addItem('‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã', 'installTriggers')
    .addToUi(); } catch (e) { Logger.log(`–û—à–∏–±–∫–∞ –≤ onOpen: ${e.stack}`); } }

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç startAllFunctions –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00 –∏ 14:00.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç onEditTrigger –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞.
 */
function installTriggers() { try {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 –∏ 14:00
    [6, 14].forEach(h => ScriptApp.newTrigger('startAllFunctions').timeBased().everyDays(1).atHour(h).nearMinute(0).inTimezone('Asia/Yekaterinburg').create());
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.newTrigger('onEditTrigger').forSpreadsheet(SPREADSHEET).onEdit().create();
    SpreadsheetApp.getUi().alert('–í—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
    Logger.log('–¢—Ä–∏–≥–≥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã/–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
} catch (e) { Logger.log(`–û—à–∏–±–∫–∞ –≤ installTriggers: ${e.stack}`); SpreadsheetApp.getUi().alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.'); } }

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–µ–∫—É—â–∏—Ö API-–∫–ª—é—á–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 */
function checkApiKeys() {
  const ui = SpreadsheetApp.getUi();
  const keys = getGeminiKeyPool();
  
  const mask = (key) => {
    if (!key) return '‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù';
    if (key.length < 10) return '‚ö†Ô∏è –û—à–∏–±–∫–∞ (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)';
    return `${key.substring(0, 6)}...${key.substring(key.length - 4)}`;
  };
  
  let msg = `–°—Ç–∞—Ç—É—Å API-–∫–ª—é—á–µ–π Gemini (${keys.length} —à—Ç.):\n\n`;
  if (keys.length > 0) {
    keys.forEach((k, i) => {
      msg += `${i+1}. ${mask(k)}\n`;
    });
    msg += '\nüîÑ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç –∫–ª—é—á, –µ—Å–ª–∏ –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è –∫–≤–æ—Ç—ã.';
  } else {
    msg = '‚ùå –ö–ª—é—á–∏ Gemini –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –Ω–∞ –ª–∏—Å—Ç–µ "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", –Ω–∏ –≤ —Å–≤–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞.';
  }
  
  ui.alert('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API-–∫–ª—é—á–µ–π', msg, ui.ButtonSet.OK);
}

/**
 * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫, —Å–æ–∑–¥–∞–≤–∞—è –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 */

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª—é—á–∏ Gemini (–º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
 */
function setDefaultApiKeys() {
  const ui = SpreadsheetApp.getUi();
  
  const response = ui.prompt('üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API-–∫–ª—é—á–µ–π Gemini', 
    '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ API-–∫–ª—é—á–∏ Google Gemini (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ –∑–∞–ø—è—Ç–æ–π):', ui.ButtonSet.OK_CANCEL);
  
  if (response.getSelectedButton() == ui.Button.OK) {
    const rawKeys = response.getResponseText().trim();
    if (rawKeys.length > 10) {
      PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEYS', rawKeys);
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ä–æ—Ç–∞—Ü–∏–∏
      PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', '0');
      ui.alert('‚úÖ –ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    } else {
      ui.alert('‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–ª—é—á–µ–π.');
    }
  }
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞—é—â–∞—è –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
 * –û–°–¢–ê–í–õ–ï–ù–ê –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö.
 */
function startAllFunctions() {
  if (IS_DEBUG) Logger.log('–ó–∞–ø—É—Å–∫ startAllFunctions...');
  try {
    clearSheets(); // –û—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤
    copyFromActiveGroup(); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã
    copyFromSource(SHEETS.AVITO, 'P', ['–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ê–≤–∏—Ç–æ –≤ P-Q
    copyFromSource(SHEETS.CIAN, 'R', ['—Ü–∏–∞–Ω', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¶–∏–∞–Ω –≤ R-S
    copyFromSource(SHEETS.DOMCLICK, 'T', ['–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –î–æ–º–∫–ª–∏–∫ –≤ T-U
    setAdditionalHeaders(); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–Ω–∞—á–Ω–µ—Ç—Å—è —Å V)
    findCompetitorsForAllObjects(); // –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    if (IS_DEBUG) Logger.log('‚úÖ startAllFunctions —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.');
  } catch (e) { Logger.log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ startAllFunctions: ${e}\n${e.stack}`); setDashesOnError(); }
}

// ================== –§–£–ù–ö–¶–ò–ò –ü–û–î–ì–û–¢–û–í–ö–ò –î–ê–ù–ù–´–• ==================

/**
 * –û—á–∏—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤.
 */
function clearSheets() {
  const sheetsToClear = [ { name: SHEETS.MAIN_ANALYTICS, range: 'A6:AZ' }, { name: SHEETS.COMPETITORS, range: 'A2:N' }];
  sheetsToClear.forEach(s => { const sh = SPREADSHEET.getSheetByName(s.name); if (sh) sh.getRange(s.range).clearContent(); });
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A2').setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞'); 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–∞ '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ' –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 */
function copyFromActiveGroup() {
    const sourceSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_GROUP); 
    const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sourceSheet || !targetSheet) return;
    
    const sourceRange = sourceSheet.getRange('A2:O' + sourceSheet.getLastRow()); 
    if (sourceRange.isBlank()) return;
    
    const sourceData = sourceRange.getValues();
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π "–ò—Ç–æ–≥–æ"
    const dataToCopy = sourceData.filter(row => row.some(cell => cell.toString().trim() !== '') && String(row[0]).toLowerCase().trim() !== '–∏—Ç–æ–≥–æ');
    
    if (dataToCopy.length === 0) { 
      if(targetSheet.getMaxRows() >= 6) targetSheet.getRange('A6:O6').setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
      return; 
    }
    
    const headers = [ ['‚Ññ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–ö–æ–¥', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç'] ];
    targetSheet.getRange('A5:O5').setValues(headers); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    targetSheet.getRange(6, 1, dataToCopy.length, dataToCopy[0].length).setValues(dataToCopy); // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ê–≤–∏—Ç–æ, –¶–∏–∞–Ω, –î–æ–º–∫–ª–∏–∫)
 * –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 * @param {string} sourceSheetName –ò–º—è –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞.
 * @param {string} startColumn –ë—É–∫–≤–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {string[]} headers –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤.
 */
function copyFromSource(sourceSheetName, startColumn, headers) {
  const sourceSheet = SPREADSHEET.getSheetByName(sourceSheetName);
  const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const endColumn = String.fromCharCode(startColumn.charCodeAt(0) + 1); // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, V -> W)
  
  if (!sourceSheet || !targetSheet) return;
  
  targetSheet.getRange(`${startColumn}5:${endColumn}5`).setValues([headers]); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  
  const lastSourceRow = sourceSheet.getLastRow();
  const lastTargetRow = targetSheet.getLastRow();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  if (lastSourceRow < 2 || lastTargetRow < 6) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ: –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞, –¶–µ–Ω–∞, –¶–µ–Ω–∞ –∑–∞ –º¬≤ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –æ–Ω–∏ –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö B, C, D)
  const sourceData = sourceSheet.getRange('B2:D' + lastSourceRow).getValues();
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥—ã –æ–±—ä–µ–∫—Ç–æ–≤ —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  const targetCodes = targetSheet.getRange('F6:F' + lastTargetRow).getValues().flat();
  
  // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞
  const sourceMap = new Map(sourceData.map(row => [String(row[0]).trim(), [row[1] || '-', row[2] || '-']]));
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—è –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞
  const outputData = targetCodes.map(code => sourceMap.get(String(code).trim()) || ['-', '-']);
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  if (outputData.length > 0) {
    targetSheet.getRange(6, startColumn.charCodeAt(0) - 64, outputData.length, 2).setValues(outputData); // startColumn.charCodeAt(0) - 64 –¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ (A=1, B=2...)
  }
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ.
 */
function setAdditionalHeaders() {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName –Ω–∞ SPREADSHEET.getSheetByName
    const sheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sheet) return;
    
    const headers = [[
        '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', 
        '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞', '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.'
    ]];
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Å—Ç–æ–ª–±—Ü–∞ V, –ø–æ—Å–ª–µ P-Q (Avito), R-S (Cian), T-U (Domclick)
    sheet.getRange('V5:AQ5').setValues(headers); 
}

// ================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
 * –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 */
function findCompetitorsForAllObjects() {
  if (IS_DEBUG) Logger.log('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è findCompetitorsForAllObjects...');
  
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  
  if (!analyticsSheet || !activeSheet || !soldSheet || !competitorsSheet) { 
    setDashesOnError(); // –ï—Å–ª–∏ –ª–∏—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ
    return; 
  }
  
  const lastRow = analyticsSheet.getLastRow();
  if (lastRow < 6) return; // –ï—Å–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü—ã A:O)
  const objectsData = analyticsSheet.getRange('A6:O' + lastRow).getValues();
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const activeData = activeSheet.getRange('A2:M' + activeSheet.getLastRow()).getValues();
  const soldData = soldSheet.getRange('A2:N' + soldSheet.getLastRow()).getValues();

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–∏–∑ —è—á–µ–µ–∫ C1 –∏ C2 –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)
  const startDate = new Date(analyticsSheet.getRange('C1').getValue() || '2024-01-01'); 
  const endDate = new Date(analyticsSheet.getRange('C2').getValue() || new Date());
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
  const months = Math.max(1, (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30.4375));
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ä–∞–π–æ–Ω–∞–º
  const activeByDistrict = groupDataByDistrict(activeData);
  const soldByDistrict = groupDataByDistrict(soldData);
  
  const districtCache = {}; // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º
  
  let analyticsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Å—Ç–∞
  let competitorsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const competitorHeaders = ['–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ A:O –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è dataMap
  const objectHeaders = analyticsSheet.getRange('A5:O5').getValues()[0];

  // –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  objectsData.forEach((objectRow, index) => {
    try {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
      const district = objectRow[1], type = objectRow[2], rooms = Number(objectRow[3]), area = Number(objectRow[4]), code = String(objectRow[5]), price = Number(objectRow[7]);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!district || !code || !area || area <= 0 || !price || price <= 0) { 
        analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
        return; 
      }
      
      const repair = objectRow[6], buildYear = Number(objectRow[10]) || null;
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω—É –µ—â–µ –Ω–µ—Ç –≤ –∫—ç—à–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
      if (!districtCache[district]) {
        districtCache[district] = processDistrictData({ 
          type, rooms, area, repair, buildYear, 
          activeCandidates: activeByDistrict[district] || [], 
          soldCandidates: soldByDistrict[district] || [], 
          startDate, endDate, months 
        });
      }
      const cache = districtCache[district]; // –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–π–æ–Ω—É

      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º dataMap –∏–∑ objectRow (A:O) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
      // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ReferenceError, —Ç–∞–∫ –∫–∞–∫ allObjectsPlusAnalytics –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å.
      const dataMap = {};
      objectHeaders.forEach((h, i) => dataMap[h] = objectRow[i]);

      // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –æ–±—ä–µ–∫—Ç–∞
      const metrics = calculateObjectMetrics({ price, activeCompetitors: cache.activeCompetitors, avgActivePriceTrimmed: cache.avgActivePriceTrimmed, avgSoldPriceMedian: cache.avgSoldPriceMedian });
      // –†–∞—Å—á–µ—Ç —Ü–µ–Ω–æ–≤–æ–π –≤–∏–ª–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
      const priceFork = calculatePriceFork({ price, objectData: objectRow, activePrices: cache.activePrices, avgSalesPerMonth: cache.avgSalesPerMonth, avgSoldPriceMedian: cache.avgSoldPriceMedian, dataMap: dataMap });
      const timeOnMarketForecasts = calculateTimeOnMarket({ 
        soldCompetitors: cache.soldCompetitors, 
        avgPrice: cache.avgSoldPriceMedian, 
        rank: metrics.rankByPrice, 
        avgSalesPerMonth: cache.avgSalesPerMonth,
        avgNewObjectsPerMonth: cache.avgNewObjectsPerMonth, // [B3] –î–ª—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞
        price: price,                                         // [B4] –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–∏ –¥–µ—à–µ–≤–ª–µ
        activePrices: cache.activePrices                      // [B4] –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–∏ –¥–µ—à–µ–≤–ª–µ
      });

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
      analyticsOutput.push([
        cache.activeCompetitors.length, 
        cache.soldCompetitors.length, 
        cache.avgSalesPerMonth, 
        cache.avgNewObjectsPerMonth, // –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
        determineLiquidityType(cache.activeCompetitors.length, cache.soldCompetitors.length, cache.avgSalesPerMonth), // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
        getMarketAssessment(cache.liquidityIndex, cache.avgSalesPerMonth), // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å
        cache.competitionTrend,
        metrics.rankByPrice, cache.priceTrendPerMonth, metrics.activeRatioPercent, metrics.soldRatioPercent,
        cache.avgActivePriceTrimmed, price, metrics.priceDiffPercentActive,
        cache.avgSoldPriceMedian, price, metrics.priceDiffPercentSold,
        priceFork.aggressive, timeOnMarketForecasts.fast, priceFork.market, timeOnMarketForecasts.market
      ]);

      // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–∏—Å—Ç–∞ "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∫–∞–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
      const ourObjectAsCompetitor = [
          district, type, rooms, area, price, Math.floor(price/area), // –†–∞–π–æ–Ω, –¢–∏–ø, –ö–æ–º–Ω–∞—Ç—ã, –ü–ª–æ—â–∞–¥—å, –¶–µ–Ω–∞, –¶–µ–Ω–∞ –∑–∞ –º¬≤ (price/area)
          '-', // –°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π (placeholder)
          objectRow[14], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç–æ–ª–±–µ—Ü O)
          repair, // –†–µ–º–æ–Ω—Ç
          '–ù–∞—à –æ–±—ä–µ–∫—Ç', // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞ (placeholder)
          `${objectRow[8]}/${objectRow[9]}`, // –≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å
          buildYear // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
      ];
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞—à –æ–±—ä–µ–∫—Ç) –ø–æ —Ü–µ–Ω–µ
      const activeSorted = [...cache.activeCompetitors, ourObjectAsCompetitor].sort((a, b) => (a[4] || Infinity) - (b[4] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ –æ–±—â–∏–π –≤—ã–≤–æ–¥
      competitorsOutput.push([`–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...activeSorted, []);
      
      const soldSorted = [...cache.soldCompetitors].sort((a, b) => (a[4] || Infinity) - (b[4] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if(soldSorted.length > 0) competitorsOutput.push([`–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...soldSorted, []);
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
      competitorsOutput.push([]);

    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ ${index + 6}: ${e.stack}`);
      analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    }
  });

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  if (analyticsOutput.length > 0) {
    analyticsSheet.getRange(6, 22, analyticsOutput.length, 22).setValues(analyticsOutput);
  }
  
  // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (competitorsOutput.length > 0) {
    competitorsSheet.getRange('A2:N' + competitorsSheet.getMaxRows()).clearContent();
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (—É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç 12 —Å—Ç–æ–ª–±—Ü–æ–≤)
    const formattedCompetitors = formatForBatchWrite(competitorsOutput, 12);
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç
    competitorsSheet.getRange(2, 1, formattedCompetitors.length, formattedCompetitors[0].length).setValues(formattedCompetitors);
  }
}

// ================== –£–õ–£–ß–®–ï–ù–ù–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –≤ —Å—Ç–æ–ª–±—Ü–µ —Ä–∞–π–æ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 1).
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object<string, Array<Array<any>>>} –û–±—ä–µ–∫—Ç —Å –≥—Ä—É–ø–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º.
 */
function groupDataByDistrict(data) { 
  const grouped = {}; 
  data.forEach(row => { 
    const district = row[1] || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; // –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–∏–Ω–¥–µ–∫—Å 1)
    if (!grouped[district]) grouped[district] = []; 
    grouped[district].push(row); 
  }); 
  return grouped; 
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function processDistrictData(params) {
    const { type, rooms, area, repair, buildYear, activeCandidates, soldCandidates, startDate, endDate, months } = params;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏"
    const staleDate = new Date(endDate.getTime() - STALE_LISTING_MONTHS * 30.4375 * 24 * 60 * 60 * 1000).getTime();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ (—Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ)
    const freshActiveCandidates = activeCandidates.filter(row => { 
        try { return new Date(row[0]).getTime() >= staleDate; } catch(e) { return false; }
    });
    
    // --- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–º–æ–Ω—Ç—É ---
    const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
    const objectRepairLower = repair ? repair.toLowerCase() : '';
    const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Ç–∏–ø, –∫–æ–º–Ω–∞—Ç—ã, –ø–ª–æ—â–∞–¥—å, –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏, —Ä–µ–º–æ–Ω—Ç)
    const processedActiveCandidates = freshActiveCandidates.filter(row => {
        try {
            const rowDate = new Date(row[0]).getTime();
            const rowBuildYear = Number(row[10]) || null;
            const rowRooms = Number(row[3]);
            const rowArea = Number(row[4]);
            const competitorRepair = row[6]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü 6 - —ç—Ç–æ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (row[2] !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
    const processedSoldCandidates = soldCandidates.filter(row => {
        try {
            const rowDate = new Date(row[0]).getTime(); // –î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            const rowBuildYear = Number(row[10]) || null;
            const rowRooms = Number(row[3]);
            const rowArea = Number(row[4]);
            const competitorRepair = row[6]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü 6 - —ç—Ç–æ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (row[2] !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    const activeCompetitors = processedActiveCandidates.map(row => formatCompetitorRow(row, false));
    const soldCompetitors = processedSoldCandidates.map(row => formatCompetitorRow(row, true));

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ —Ü–µ–Ω –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–∏—Ö
    const activePrices = activeCompetitors.map(c => c[4]).filter(p => p > 0); // –¶–µ–Ω–∞
    const soldPrices = soldCompetitors.map(c => c[4]).filter(p => p > 0); // –¶–µ–Ω–∞

    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
    const avgSalesPerMonth = soldCompetitors.length > 0 ? parseFloat((soldCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–±—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
    const avgNewObjectsPerMonth = activeCompetitors.length > 0 ? parseFloat((activeCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (—á–∏—Å–ª–æ–≤–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è getLiquidityType –∏ getMarketAssessment)
    let liquidityIndex = 0;
    if (activeCompetitors.length > 0 && avgSalesPerMonth > 0) {
        liquidityIndex = Math.round((avgSalesPerMonth / activeCompetitors.length) * 100);
    }
    
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ —Ü–µ–Ω—ã –∑–∞ –º¬≤ (–¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏ –∏ —Ü–µ–Ω–∞ –∑–∞ –º¬≤)
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[5] - —Ü–µ–Ω–∞ –∑–∞ –º¬≤
    const priceTrendData = soldCompetitors.map(c => [ new Date(c[0]).getTime() / (1000*60*60*24), c[5] ]).filter(p => p[0] && p[1]);
    const trend = calculateLinearRegression(priceTrendData); // –†–∞—Å—á–µ—Ç –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    const priceTrendPerMonth = trend ? Math.round(trend.slope * 30.4375) : 0; // –ü–µ—Ä–µ—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –º–µ—Å—è—Ü
    
    // –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
    const competitionTrend = calculateCompetitionTrend(freshActiveCandidates, startDate, endDate); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ–∂–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    return { 
        activeCompetitors, 
        soldCompetitors, 
        activePrices, 
        competitionTrend, 
        avgActivePriceTrimmed: calculateTrimmedMean(activePrices, TRIM_PERCENTAGE), // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º
        avgSoldPriceMedian: calculateMedian(soldPrices), // –ú–µ–¥–∏–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
        avgSalesPerMonth, 
        liquidityIndex: liquidityIndex, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å 0)
        priceTrendPerMonth: priceTrendPerMonth || '-', // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –∏–ª–∏ —Ç–∏—Ä–µ
        avgNewObjectsPerMonth // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É –ø—Ä–∏–±—ã—Ç–∏—è
    };
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è filterCompetitors, —Ç.–∫. –µ–µ –ª–æ–≥–∏–∫–∞ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ processDistrictData

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º.
 * @param {Array<any>} row –°—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞.
 * @param {boolean} isSold –§–ª–∞–≥, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã–º.
 * @returns {Array<any>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatCompetitorRow(row, isSold) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –∏ –ø–ª–æ—â–∞–¥—å
    const price = Number(row[7]) || 0; // –¶–µ–Ω–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 7)
    const area = Number(row[4]) || 0; // –ü–ª–æ—â–∞–¥—å (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 4)
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤
    const pricePerM2 = area > 0 ? Math.floor(price / area) : 0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º price/area –∫–∞–∫ –≤ ourObjectAsCompetitor

    let timeOnMarket = '-';
    if(isSold) {
        try {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –≤ –¥–Ω—è—Ö
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[12] - –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö)
            const saleDate = new Date(row[0]), pubDate = new Date(row[12]);
            if(!isNaN(saleDate.getTime()) && !isNaN(pubDate.getTime())){
                timeOnMarket = Math.round((saleDate - pubDate) / (1000 * 60 * 60 * 24));
            }
        } catch(e) { timeOnMarket = '-'; } // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏—Ä–µ
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏ —Ä–µ–º–æ–Ω—Ç, —É—á–∏—Ç—ã–≤–∞—è, –ø—Ä–æ–¥–∞–Ω–æ –ª–∏ –æ–±—ä–µ–∫—Ç
    const link = row[5] || '-'; // –°—Å—ã–ª–∫–∞ (ID –æ–±—ä–µ–∫—Ç–∞) –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ F (–∏–Ω–¥–µ–∫—Å 5)
    const repair = row[6] || '-'; // –†–µ–º–æ–Ω—Ç: –æ–±—â–∏–π —Å—Ç–æ–ª–±–µ—Ü 6
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞ (—Å–ø–µ–∫—É–ª—è—Ç–∏–≤–Ω–æ, –ø–æ–∫–∞ –±–µ—Ä–µ–º —Ç–∏—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Äî —á–µ–∫-–ª–∏—Å—Ç—ã —Ñ–æ—Ç–æ/–æ–ø–∏—Å–∞–Ω–∏—è)
    const houseCondition = '-'; 

    // –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∏–Ω–∞–º–∏–∫–∏ (–æ–±—ã—á–Ω–æ —Å—Ç–æ–ª–±–µ—Ü A –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö, M –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö)
    const pubDateValue = isSold ? row[12] : row[0];

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–∫–∞–º (14 —Å—Ç–æ–ª–±—Ü–æ–≤)
    return [
        row[5] || '-', // 0: '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞' (—Å—Ç–æ–ª–±–µ—Ü F)
        row[1], // 1: '–†–∞–π–æ–Ω'
        row[2], // 2: '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞'
        Number(row[3]), // 3: '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç'
        area, // 4: '–ü–ª–æ—â–∞–¥—å'
        price, // 5: '–¶–µ–Ω–∞'
        pricePerM2, // 6: '–¶–µ–Ω–∞ –∑–∞ –º¬≤'
        timeOnMarket, // 7: '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π'
        link, // 8: '–°—Å—ã–ª–∫–∞'
        repair, // 9: '–†–µ–º–æ–Ω—Ç'
        houseCondition, // 10: '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞'
        `${row[8]}/${row[9]}`, // 11: '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å'
        Number(row[10]) || '-', // 12: '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
        pubDateValue // 13: –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (—Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ)
    ];
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function calculateObjectMetrics(params) {
    const { price, activeCompetitors, avgActivePriceTrimmed, avgSoldPriceMedian } = params;
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å —Ü–µ–Ω–æ–π —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    const allActivePrices = [...activeCompetitors.map(c => c[4]), price].filter(p => p > 0).sort((a, b) => a - b);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const rankByPrice = 1 + allActivePrices.filter(p => p < price).length;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
    const formatRatio = (ratio) => `${ratio > 0 ? '+' : ''}${ratio.toFixed(1)}%`;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ–±—ä–µ–∫—Ç–∞ –∫ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeRatioPercent = avgActivePriceTrimmed > 0 ? formatRatio(((price / avgActivePriceTrimmed - 1) * 100)) : '-';
    const soldRatioPercent = avgSoldPriceMedian > 0 ? formatRatio(((price / avgSoldPriceMedian - 1) * 100)) : '-';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω
    const priceDiffPercentActive = (avgActivePriceTrimmed > 0) ? `${Math.round((price - avgActivePriceTrimmed) / avgActivePriceTrimmed * 100)}%` : '-';
    const priceDiffPercentSold = (avgSoldPriceMedian > 0) ? `${Math.round((price - avgSoldPriceMedian) / avgSoldPriceMedian * 100)}%` : '-';
    
    return { rankByPrice: rankByPrice || '-', activeRatioPercent, soldRatioPercent, priceDiffPercentActive, priceDiffPercentSold };
}

/**
 * –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeOnMarket(params) {
    const { soldCompetitors, avgPrice, rank, avgSalesPerMonth, avgNewObjectsPerMonth, price, activePrices } = params;
    const defaultResult = { fast: '-', market: '-', optimistic: '-', dynamicMonths: '-', degradationInfo: '' };
    const toMonths = (days) => (days / 30.4375).toFixed(1);
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (!rank || rank <= 0 || !avgSalesPerMonth || avgSalesPerMonth <= 0) {
        return defaultResult;
    }
    
    // === –£–õ–£–ß–®–ï–ù–ò–ï B3: –†–∞—Å—á—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞ ===
    const dynamicResult = calculateDynamicTimeOnMarket({
        rank: rank,
        demand: avgSalesPerMonth,
        arrival: avgNewObjectsPerMonth || 0,
        price: price,
        activePrices: activePrices || []
    });
    
    // === –£–õ–£–ß–®–ï–ù–ò–ï B2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–Ω–æ–≥–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ ===
    const currentMonth = new Date().getMonth() + 1; // 1-12
    const seasonalCoef = SEASONAL_COEFFICIENTS[currentMonth] || 1.0;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const timeOnMarketData = soldCompetitors.map(c => ({tom: c[6], price: c[4]})).filter(c => typeof c.tom === 'number' && c.tom >= 0);
    
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
    if (timeOnMarketData.length < 2 || !avgPrice) {
        const baseTerm = dynamicResult.months * seasonalCoef;
        return { 
            fast: (baseTerm * 0.7).toFixed(1), 
            market: baseTerm.toFixed(1), 
            optimistic: (baseTerm * 1.5).toFixed(1),
            dynamicMonths: dynamicResult.months.toFixed(1),
            degradationInfo: dynamicResult.info
        };
    }
    
    // –°–µ–≥–º–µ–Ω—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ–Ω–æ–≤—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const cheap = [], market = [], expensive = [];
    timeOnMarketData.forEach(c => { 
        if (c.price < avgPrice * 0.9) cheap.push(c.tom);
        else if (c.price > avgPrice * 1.1) expensive.push(c.tom);
        else market.push(c.tom);
    });
    
    const getMedianTom = (segment) => segment.length > 0 ? parseFloat(toMonths(calculateMedian(segment))) : null;
    
    let fastTom = getMedianTom(cheap), marketTom = getMedianTom(market), optimisticTom = getMedianTom(expensive);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –Ω–∞ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é
    const degradationMultiplier = dynamicResult.months > 0 ? dynamicResult.months / (rank / avgSalesPerMonth) : 1;
    
    const applyCorrections = (value) => {
        if (!value) return null;
        return (value * seasonalCoef * degradationMultiplier).toFixed(1);
    };
    
    return { 
        fast: applyCorrections(fastTom) || applyCorrections(marketTom) || '-', 
        market: applyCorrections(marketTom) || applyCorrections(optimisticTom) || '-', 
        optimistic: applyCorrections(optimisticTom) || applyCorrections(marketTom) || '-',
        dynamicMonths: dynamicResult.months.toFixed(1),
        degradationInfo: dynamicResult.info
    };
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω–æ–≤—É—é –≤–∏–ª–∫—É (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é, —Ä—ã–Ω–æ—á–Ω—É—é, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é) –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏.
 */
function calculatePriceFork(params) {
    const { price, objectData, activePrices, avgSalesPerMonth, avgSoldPriceMedian, dataMap } = params;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
    const qualityScore = calculateQualityScore(dataMap);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É: –º–µ–¥–∏–∞–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    let marketPrice = avgSoldPriceMedian > 0 ? avgSoldPriceMedian : calculateTrimmedMean(activePrices, TRIM_PERCENTAGE);
    marketPrice = marketPrice > 0 ? marketPrice : Math.floor(price * 0.95); // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –±–µ—Ä–µ–º 95% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    marketPrice = Math.floor(marketPrice * qualityScore); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é —Ü–µ–Ω—É
    let aggressivePrice = 0;
    if(activePrices.length > 0 && avgSalesPerMonth > 0) { 
        const sortedPrices = [...activePrices].sort((a,b)=>a-b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
        // –ë–µ—Ä–µ–º —Ü–µ–Ω—É, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ä–µ–¥–Ω–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
        const targetIndex = Math.min(Math.floor(avgSalesPerMonth)-1, sortedPrices.length - 1); 
        if(targetIndex >= 0) aggressivePrice = sortedPrices[targetIndex]; 
    }
    aggressivePrice = aggressivePrice > 0 ? aggressivePrice : Math.floor(price * 0.9); // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –±–µ—Ä–µ–º 90% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    aggressivePrice = Math.floor(aggressivePrice * qualityScore * 0.97); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é —Ü–µ–Ω—É
    const trimmedAvgActive = calculateTrimmedMean(activePrices, TRIM_PERCENTAGE); 
    let optimisticPrice = trimmedAvgActive > 0 ? trimmedAvgActive : marketPrice * 1.05; // –ë–µ—Ä–µ–º —Å—Ä–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ 105% –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π
    optimisticPrice = Math.floor(optimisticPrice * qualityScore * 1.03); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å

    // –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ 100 000, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è <= —Ä—ã–Ω–æ—á–Ω–∞—è, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è >= —Ä—ã–Ω–æ—á–Ω–∞—è
    const finalMarketPrice = Math.max(100000, marketPrice);
    const finalAggressivePrice = Math.min(finalMarketPrice, Math.max(100000, aggressivePrice));
    const finalOptimisticPrice = Math.max(finalMarketPrice, Math.max(100000, optimisticPrice));
    
    return { aggressive: finalAggressivePrice, market: finalMarketPrice, optimistic: finalOptimisticPrice };
}



/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ —Å–ø—Ä–æ—Å–∞.
 * @param {number|string} liquidityIndex –ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} avgSalesPerMonth –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä—ã–Ω–∫–∞.
 */
function getMarketAssessment(liquidityIndex, avgSalesPerMonth) {
  if (typeof liquidityIndex !== 'number') return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –Ω–µ —á–∏—Å–ª–æ
  if (liquidityIndex > 25 && avgSalesPerMonth > 3) return '–ì–æ—Ä—è—á–∏–π —Ä—ã–Ω–æ–∫ (–≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å)'; // –í—ã—Å–æ–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ —Å–ø—Ä–æ—Å
  if (liquidityIndex >= 15 && avgSalesPerMonth > 1.5) return '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫'; // –°—Ä–µ–¥–Ω—è—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ —Å–ø—Ä–æ—Å
  return '–•–æ–ª–æ–¥–Ω—ã–π —Ä—ã–Ω–æ–∫ (–Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å)'; // –ù–∏–∑–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏–ª–∏ —Å–ø—Ä–æ—Å
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Array<Array<any>>} candidates –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
 * @param {Date} startDate –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Date} endDate –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @returns {string} –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
 */
function calculateCompetitionTrend(candidates, startDate, endDate) {
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2); // –°–µ—Ä–µ–¥–∏–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = candidates.filter(r => new Date(r[0]) < midPoint).length;
  const secondHalfCount = candidates.filter(r => new Date(r[0]) >= midPoint).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return '+100% (—Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç)'; // –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –Ω–µ –±—ã–ª–æ, –∞ –≤–æ –≤—Ç–æ—Ä–æ–π –µ—Å—Ç—å
  if (firstHalfCount === 0 || secondHalfCount === 0) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–π –∏–∑ –ø–æ–ª–æ–≤–∏–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  
  const trend = ((secondHalfCount / firstHalfCount) - 1) * 100; // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  
  if (Math.abs(trend) < 10) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 10%
  return `${trend > 0 ? '—Ä–æ—Å—Ç' : '—Å–Ω–∏–∂–µ–Ω–∏–µ'} –Ω–∞ ${Math.abs(trend.toFixed(0))}%`; // –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞
}



// ================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° GEMINI –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê ==================

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ó–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –ª–∏—Å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∞–¥—Ä–µ—Å–æ–≤.
 * @param {GoogleAppsScript.Events.SheetsOnEdit} e –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */




// ================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° AI (GEMINI + OPENAI FALLBACK) ==================

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ AI —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π Gemini.
 * @param {string} prompt –ü—Ä–æ–º–ø—Ç –¥–ª—è AI.
 * @param {string} summaryText –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ.
 * @returns {string} –û—Ç–≤–µ—Ç –æ—Ç AI –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function callAI(prompt, summaryText) {
  Logger.log('üöÄ –ó–∞–ø—É—Å–∫ callAI c —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π...');
  
  const keyPool = getGeminiKeyPool();
  if (keyPool.length === 0) return '‚ùå API-–∫–ª—é—á–∏ Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –º–µ–Ω—é.';

  const models = ['gemini-2.0-flash-lite', 'gemini-2.0-flash'];
  let lastError = '';

  // –ü—Ä–æ–±—É–µ–º –∫–∞–∂–¥—ã–π –∫–ª—é—á –∏–∑ –ø—É–ª–∞
  for (let i = 0; i < keyPool.length; i++) {
    const apiKey = getGeminiApiKey(); // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª—é—á
    
    for (const model of models) {
      Logger.log(`üîπ –ü–æ–ø—ã—Ç–∫–∞: –ö–ª—é—á #${i+1}, –ú–æ–¥–µ–ª—å ${model}...`);
      const result = callGeminiFlash(prompt, summaryText, model, apiKey);
      
      if (!result.startsWith('‚ùå')) {
        return result;
      }
      
      lastError = result;
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏ –ò–õ–ò –µ—Å–ª–∏ API –Ω–µ –≤–∫–ª—é—á–µ–Ω (disabled/not been used), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª—é—á
      const isSwitchError = result.includes('quota') || result.includes('limit') || 
                            result.includes('429') || result.includes('disabled') || 
                            result.includes('not been used');
      
      if (!isSwitchError) {
        continue;
      }
      
      Logger.log(`‚ö†Ô∏è –ö–≤–æ—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è –∫–ª—é—á–∞ #${i+1}. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π...`);
      rotateGeminiApiKey(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
      break; // –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞ –º–æ–¥–µ–ª–µ–π, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∫–ª—é—á—É
    }
  }
  
  return `‚ùå –ò—Å—á–µ—Ä–ø–∞–Ω—ã –∫–≤–æ—Ç—ã –í–°–ï–• –∫–ª—é—á–µ–π Gemini. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–ª—é—á–µ–π.\n–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${lastError}`;
}

/**
 * –í—ã–∑—ã–≤–∞–µ—Ç Gemini Flash API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
 * @param {string} prompt –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini.
 * @param {string} summaryText –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ.
 * @param {string} model –ú–æ–¥–µ–ª—å Gemini (gemini-2.0-flash-lite –∏–ª–∏ gemini-2.0-flash).
 * @returns {string} –û—Ç–≤–µ—Ç –æ—Ç Gemini –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function callGeminiFlash(prompt, summaryText, model, forcedKey) {
  const apiKey = forcedKey || getGeminiApiKey();
  if (!apiKey) return '‚ùå API-–∫–ª—é—á Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
  
  model = model || 'gemini-2.0-flash-lite';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  
  const fullPrompt = `${prompt}\n\n–í–æ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ:\n${summaryText}\n\nSystem Instruction: –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –¥–µ–ª–æ–≤–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. –ü–µ—Ä–µ–ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤ –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Ü–∏—Ñ—Ä—ã –∏ —Å—É—Ç—å.`;
  
  const payload = {
    "contents": [{
      "parts": [{ "text": fullPrompt }]
    }],
    "generationConfig": {
      "temperature": 0.7,
      "maxOutputTokens": 4096,
      "topP": 0.8
    },
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ]
  };
  
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseText = response.getContentText();
    Logger.log(`Gemini ${model} Raw Response: ${responseText.substring(0, 500)}...`);
    
    const json = JSON.parse(responseText);
    
    if (json.error) {
      return `‚ùå –û—à–∏–±–∫–∞ Gemini ${model}: ${json.error.message}`;
    }
    
    if (json.candidates && json.candidates[0] && json.candidates[0].content && 
        json.candidates[0].content.parts && json.candidates[0].content.parts[0].text) {
      return cleanText(json.candidates[0].content.parts[0].text);
    }
    
    return `‚ùå Gemini ${model}: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç`;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ Gemini ${model}: ${e.stack}`);
    return `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ Gemini ${model}`;
  }
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è callOpenAI –∑–∞ –Ω–µ–Ω–∞–¥–æ–±–Ω–æ—Å—Ç—å—é

/**
 * [v1.0] –í—ã–∑—ã–≤–∞–µ—Ç Gemini –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞ —Å JSON-–≤—ã–≤–æ–¥–æ–º.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É fallback: —Å–Ω–∞—á–∞–ª–∞ Lite, –∑–∞—Ç–µ–º –æ—Å–Ω–æ–≤–Ω—É—é Flash.
 * @param {Object} analyticsData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} marketContext –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
 * @returns {Object} { success: boolean, ... }
 */
function callGeminiAnalyst(analyticsData, marketContext) {
  const keyPool = getGeminiKeyPool();
  if (keyPool.length === 0) return { success: false, error: 'API-–∫–ª—é—á–∏ Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã' };
  
  const models = ['gemini-3-flash-preview', 'gemini-2.0-flash'];
  let lastError = '';

  for (let i = 0; i < keyPool.length; i++) {
    const apiKey = getGeminiApiKey();
    
    for (const model of models) {
      try {
        Logger.log(`üîπ –ê–Ω–∞–ª–∏–∑: –ö–ª—é—á #${i+1}, –ú–æ–¥–µ–ª—å ${model}...`);
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const result = executeGeminiRequest(url, analyticsData, marketContext);
        
        if (result.success) return result;
        
        lastError = result.error;
        const isSwitchError = lastError.includes('quota') || lastError.includes('limit') || 
                              lastError.includes('429') || lastError.includes('disabled') || 
                              lastError.includes('not been used');

        if (!isSwitchError) {
          continue; 
        }
        
        Logger.log(`‚ö†Ô∏è –ö–≤–æ—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è –∫–ª—é—á–∞ #${i+1}. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å...`);
        rotateGeminiApiKey();
        break; // –ö —Å–ª–µ–¥—É—é—â–µ–º—É –∫–ª—é—á—É
      } catch (e) {
        lastError = e.message;
        continue;
      }
    }
  }

  return { success: false, error: '–ò—Å—á–µ—Ä–ø–∞–Ω—ã –∫–≤–æ—Ç—ã –í–°–ï–• –∫–ª—é—á–µ–π Gemini', rawContent: `–û—à–∏–±–∫–∞: ${lastError}` };
}

/**
 * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É).
 */
function executeGeminiRequest(url, analyticsData, marketContext) {
  const macro = marketContext || getMacroContext();
  const systemPrompt = `–¢–´ ‚Äî –í–ï–î–£–©–ò–ô –ê–ù–ê–õ–ò–¢–ò–ö –ò –î–û–í–ï–†–ï–ù–ù–´–ô –ö–û–ù–°–£–õ–¨–¢–ê–ù–¢ –ü–û –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–≥–∏–π, –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑.

–ì–õ–ê–í–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –õ–µ–∫—Å–∏–∫–∞: –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–æ–≥–æ –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å. –ó–ê–ü–†–ï–©–ï–ù–´ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏ –æ—Ü–µ–Ω–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞: ¬´—Å–∫—É–¥–Ω—ã–π¬ª, ¬´–ø–ª–∞—á–µ–≤–Ω—ã–π¬ª, ¬´–¥—Ä–∞–º–∞¬ª, ¬´–±–æ–ª–µ–≤–∞—è —Ç–æ—á–∫–∞¬ª, ¬´–≤–æ–¥–∞¬ª, ¬´—É–∂–∞—Å–Ω–æ¬ª.
2. –¢–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è: –ò—Å–ø–æ–ª—å–∑—É–π ¬´–æ–±—ä–µ–∫—Ç–æ–≤¬ª –≤–º–µ—Å—Ç–æ ¬´–µ–¥–∏–Ω–∏—Ü¬ª, ¬´—Å–¥–µ–ª–∫–∏¬ª –≤–º–µ—Å—Ç–æ ¬´–ø—Ä–æ–¥–∞–∂–∏¬ª (–∫–æ–≥–¥–∞ —Ä–µ—á—å –æ —Ñ–∞–∫—Ç–µ –ø—Ä–æ–¥–∞–∂–∏), ¬´—Ä—ã–Ω–æ—á–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª –≤–º–µ—Å—Ç–æ ¬´—Å–ø—Ä–æ—Å¬ª.
3. –¢–æ—á–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö: –ù–ï —É–ø–æ–º–∏–Ω–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –∏–ø–æ—Ç–µ–∫–∏ –∏–ª–∏ –¶–ë, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω—ã –≤ –ú–ê–ö–†–û–§–ê–ö–¢–û–†–ê–• –∫–∞–∫ —á–∏—Å–ª–∞. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –≥–æ–≤–æ—Ä–∏ –æ ¬´–≤—ã—Å–æ–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞–µ–º–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞¬ª –∏–ª–∏ ¬´–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–∏ —Å–ø—Ä–æ—Å–∞¬ª.
4. –õ–æ–≥–∏–∫–∞ ¬´–ü—Ä–∏—Ç–æ–∫ vs –°–¥–µ–ª–∫–∏¬ª: –ï—Å–ª–∏ –ò–Ω–¥–µ–∫—Å –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–Ω–∏—è (inventoryIndex) > 100%, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –Ω–æ–≤—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∑–∞—Ö–æ–¥–∏—Ç –±–æ–ª—å—à–µ, —á–µ–º —Ä—ã–Ω–æ–∫ —É—Å–ø–µ–≤–∞–µ—Ç "–ø–æ–≥–ª–æ—â–∞—Ç—å". –≠—Ç–æ –≤–µ–¥–µ—Ç –∫ —Ä–æ—Å—Ç—É —Å—Ä–æ–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ —Å –∫–∞–∂–¥—ã–º –º–µ—Å—è—Ü–µ–º.
5. –í—ã–≥–æ–¥–∞: –û–±—ä—è—Å–Ω–∏ ¬´—Ü–µ–Ω—É –æ–∂–∏–¥–∞–Ω–∏—è¬ª. –ü–æ—á–µ–º—É –ø—Ä–æ–¥–∞–∂–∞ —Å–µ–≥–æ–¥–Ω—è –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ –≤—ã–≥–æ–¥–Ω–µ–µ, —á–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —É—Å–ª–æ–≤–∏—è—Ö —Ä–∞—Å—Ç—É—â–µ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∏ –∏–Ω—Ñ–ª—è—Ü–∏–∏.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê:
1. –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏: (–ö—Ç–æ –¥–∏–∫—Ç—É–µ—Ç —É—Å–ª–æ–≤–∏—è, –±–∞–ª–∞–Ω—Å –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫).
2. –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞: (–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –∏ —Ü–µ–Ω–∞–º–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–¥–µ–ª–æ–∫. –ü–æ—á–µ–º—É –º—ã –Ω–∞ —Ç–µ–∫—É—â–µ–º –º–µ—Å—Ç–µ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ?).
3. –°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: (–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞. –ö–∞–∫–æ–π —Ä–∞–Ω–≥ –æ–Ω–∞ –¥–∞—Å—Ç –∏ –ø–æ—á–µ–º—É —ç—Ç–æ —É—Å–∫–æ—Ä–∏—Ç —Å–¥–µ–ª–∫—É).
4. –ü—Ä–æ–≥–Ω–æ–∑ –∏ —Ä–∏—Å–∫–∏ –æ–∂–∏–¥–∞–Ω–∏—è: (–°–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–π–º–µ—Ç –ø—Ä–æ–¥–∞–∂–∞ –∏ —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –Ω–µ –∑–∞–Ω—è—Ç—å –ª–∏–¥–µ—Ä—Å–∫—É—é –ø–æ–∑–∏—Ü–∏—é —Å–µ–π—á–∞—Å).

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï: –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown (#, *, -, –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç). –¢–æ–ª—å–∫–æ –ø—Ä—è–º–æ–π —Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫.`;

  const macroText = [];
  if (macro.keyRate) macroText.push(`–¶–ë ${macro.keyRate}%`);
  if (macro.mortgageRate) macroText.push(`–ò–ø–æ—Ç–µ–∫–∞ ${macro.mortgageRate}%`);
  macroText.push(`–¢—Ä–µ–Ω–¥: ${macro.marketTrend}`);

  const userPrompt = `–î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:\n${JSON.stringify(analyticsData, null, 2)}\n–ú–ê–ö–†–û–§–ê–ö–¢–û–†–´: ${macroText.join(', ')}.`;

  const payload = {
    "contents": [{ "parts": [{ "text": systemPrompt }, { "text": userPrompt }] }],
    "generationConfig": {
      "temperature": 0.3,
      "maxOutputTokens": 2048
    },
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ]
  };

  const options = { 
    method: 'post', 
    contentType: 'application/json', 
    payload: JSON.stringify(payload), 
    muteHttpExceptions: true 
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseText = response.getContentText();
    Logger.log(`Gemini Analyst Raw Response: ${responseText.substring(0, 500)}...`);
    const json = JSON.parse(responseText);
    
    if (json.error) {
      Logger.log(`–û—à–∏–±–∫–∞ API Gemini Analyst: ${json.error.message}`);
      return { success: false, error: json.error.message, rawContent: `–û—à–∏–±–∫–∞ API: ${json.error.message}` };
    }
    
    if (json.candidates && json.candidates[0] && json.candidates[0].content && json.candidates[0].content.parts) {
      let aiText = json.candidates[0].content.parts[0].text;
      
      // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ Markdown (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      aiText = aiText.replace(/[#*`]/g, '').trim();
      
      return { success: true, text: aiText };
    }
    return { success: false, error: '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini', rawContent: '–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç' };
  } catch (e) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ executeGeminiRequest: ${e.stack}`);
    return { success: false, error: e.message, rawContent: `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}` };
  }
}

/**
 * [v1.0] –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
 * @param {Object} aiData –î–∞–Ω–Ω—ã–µ –æ—Ç –ò–ò.
 * @param {Object} originalData –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */
function validateAIResponse(aiData, originalData) {
  const validated = { ...aiData };
  const originalPrice = originalData.price || originalData.ourPrice || 0;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã: –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫–ª–æ–Ω—è—Ç—å—Å—è –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 30% –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π
  if (validated.pricing && validated.pricing.recommendedPrice) {
    const recPrice = validated.pricing.recommendedPrice;
    const deviation = Math.abs(recPrice - originalPrice) / originalPrice;
    
    if (deviation > 0.3 && originalPrice > 0) {
      validated.pricing.warning = `–ò–ò —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª —Ü–µ–Ω—É ${recPrice}, —á—Ç–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –Ω–∞ ${(deviation * 100).toFixed(0)}% –æ—Ç —Ç–µ–∫—É—â–µ–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞.`;
      validated.pricing.originalRecommendation = recPrice;
      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–æ ¬±30%
      validated.pricing.recommendedPrice = recPrice > originalPrice 
        ? Math.floor(originalPrice * 1.30) 
        : Math.floor(originalPrice * 0.70);
    }
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–æ–∫–∞: –Ω–µ –±–æ–ª–µ–µ 36 –º–µ—Å—è—Ü–µ–≤
  if (validated.timeline && validated.timeline.expectedMonths) {
    if (validated.timeline.expectedMonths > 36) {
      validated.timeline.warning = `–ò–ò –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–ª ${validated.timeline.expectedMonths} –º–µ—Å, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 36 (–º–∞–∫—Å–∏–º—É–º).`;
      validated.timeline.expectedMonths = 36;
    }
    if (validated.timeline.expectedMonths < 0.5) {
      validated.timeline.warning = `–ò–ò –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–ª ${validated.timeline.expectedMonths} –º–µ—Å, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 0.5 (–º–∏–Ω–∏–º—É–º).`;
      validated.timeline.expectedMonths = 0.5;
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  validated.validated = true;
  validated.validationTimestamp = new Date().toISOString();
  
  return validated;
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini.
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ—ë –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ GAS, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏ –∏ –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.
 */
function testGeminiApiConnection() {
  const testData = {
    object: { district: "–¶–µ–Ω—Ç—Ä", rooms: 2, area: 50, price: 8500000 },
    market: { demand: 2.5, active: 15, rank: 3, avgActivePrice: 175000 },
    forecast: { marketPrice: 8200000, marketMonths: 3 }
  };
  
  const macro = { keyRate: 21, mortgageRate: 28, marketTrend: "—Å—Ç–∞–≥–Ω–∞—Ü–∏—è" };
  
  Logger.log("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ API Gemini...");
  try {
    const result = callGeminiAnalyst(testData, macro);
    if (result.success) {
      Logger.log("‚úÖ –¢–ï–°–¢ –£–°–ü–ï–®–ï–ù!");
      Logger.log("–û—Ç–≤–µ—Ç –ò–ò: " + JSON.stringify(result, null, 2));
    } else {
      Logger.log("‚ùå –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù: " + result.error);
      if (result.rawContent) Logger.log("–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: " + result.rawContent);
    }
  } catch (e) {
    Logger.log("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ–π —Ç–µ—Å—Ç–∞: " + e.stack);
  }
}

/**
 * [v1.1] –ü–æ–ª—É—á–∞–µ—Ç –º–∞–∫—Ä–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å—á–∏—Ç–∞—Ç—å —Å –ª–∏—Å—Ç–∞ '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
 * –µ—Å–ª–∏ –ª–∏—Å—Ç–∞ –Ω–µ—Ç ‚Äî –±–µ—Ä–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
 * @returns {Object} –ú–∞–∫—Ä–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç.
 */
function getMacroContext() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SETTINGS_SHEET_NAME);
    
    if (sheet) {
      const data = sheet.getRange('B2:B6').getValues();
      const normalizePerc = (val) => {
        const n = parseFloat(val);
        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ 0.16 (–∫–∞–∫ 16%), –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 16 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–∏–º–≤–æ–ª–æ–º %
        return (n > 0 && n < 1) ? Math.round(n * 100) : n;
      };
      
      return {
        keyRate: normalizePerc(data[0][0]) || 21,
        mortgageRate: normalizePerc(data[1][0]) || 28,
        familyMortgage: String(data[2][0]).toLowerCase().includes('–¥–∞') || data[2][0] === true,
        marketTrend: String(data[3][0]) || '—Å—Ç–∞–≥–Ω–∞—Ü–∏—è',
        region: String(data[4][0]) || '–¢—é–º–µ–Ω—å'
      };
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –ª–∏—Å—Ç–∞: ' + e.message);
  }
  
  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ, –µ—Å–ª–∏ –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—É—Å—Ç)
  return {
    keyRate: null,            // –ù–µ –≤—ã–≤–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    mortgageRate: null,       // –ù–µ –≤—ã–≤–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    familyMortgage: true,     
    marketTrend: '—Å—Ç–∞–≥–Ω–∞—Ü–∏—è', 
    region: ''          
  };
}

// ================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø API –ö–õ–Æ–ß–ê–ú–ò (ROTATION) ==================

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –ø—É–ª –∫–ª—é—á–µ–π Gemini –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞.
 */
function getGeminiKeyPool() {
  let keysStr = '';
  
  // 1. –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å —Å –ª–∏—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  try {
    const sheet = SPREADSHEET.getSheetByName(SETTINGS_SHEET_NAME);
    if (sheet) {
      keysStr = String(sheet.getRange('B7').getValue() || '').trim();
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–ª—é—á–µ–π —Å –ª–∏—Å—Ç–∞: ' + e.message);
  }
  
  // 2. –ï—Å–ª–∏ –Ω–∞ –ª–∏—Å—Ç–µ –ø—É—Å—Ç–æ, –±–µ—Ä–µ–º –∏–∑ —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞
  if (!keysStr) {
    keysStr = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEYS') || '';
  }
  
  // 3. –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –ø—É—Å—Ç–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª—é—á
  if (!keysStr) {
    const oldKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    return oldKey ? [oldKey] : [];
  }
  
  return keysStr.split(/[\s,;]+/).map(k => k.trim()).filter(k => k && k.length > 5);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π API-–∫–ª—é—á Gemini –∏–∑ –ø—É–ª–∞.
 */
function getGeminiApiKey() {
  const pool = getGeminiKeyPool();
  if (pool.length === 0) return null;
  
  let index = parseInt(PropertiesService.getScriptProperties().getProperty('GEMINI_KEY_INDEX') || '0');
  if (index >= pool.length) {
    index = 0;
    PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', '0');
  }
  return pool[index];
}

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á –≤ –ø—É–ª–µ.
 */
function rotateGeminiApiKey() {
  const pool = getGeminiKeyPool();
  if (pool.length <= 1) return;
  
  let index = parseInt(PropertiesService.getScriptProperties().getProperty('GEMINI_KEY_INDEX') || '0');
  index = (index + 1) % pool.length;
  PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', index.toString());
  Logger.log(`üîÑ API –∫–ª—é—á –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –∏–Ω–¥–µ–∫—Å ${index}`);
}

/**
 * –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ markdown.
 * @param {string} text –¢–µ–∫—Å—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {string} –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
 */
function cleanText(text) {
  return text.replace(/^[#*-\s\d\.]+/gm, '').replace(/\*{1,2}(.*?)\*{1,2}/g, '$1');
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∏—Ä–µ ('-') –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.
 */
function setDashesOnError() { 
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  if (analyticsSheet && analyticsSheet.getLastRow() >= 6) analyticsSheet.getRange('A6:AQ' + analyticsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  if (competitorsSheet && competitorsSheet.getLastRow() >= 2) competitorsSheet.getRange('A2:M' + competitorsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    addressSheet.getRange('A4').setValue('–ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê'); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  } 
}

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –ª–∏—Å—Ç—É —Å –æ—Ç—á–µ—Ç–æ–º.
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet –õ–∏—Å—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–±—â–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ä–∞–±–æ—á–∏–º –ª–∏—Å—Ç–∞–º.
 */
function formatSheets() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS); 
    if (analyticsSheet) { 
        analyticsSheet.getRange('A6:AQ1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        analyticsSheet.getRange('V6:AQ1000').setHorizontalAlignment('center'); // –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        analyticsSheet.getRange('A5:AQ5').setBackground('#D3D3D3').setFontWeight('bold').setFontSize(9); // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É
    const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
    if (addressSheet) { 
        addressSheet.getRange('A2').setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞').setFontSize(9).setFontWeight('bold'); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        addressSheet.getRange('B2').setHorizontalAlignment('center').setBackground('#4ee1f6').setBorder(true, true, true, true, false, false).setFontSize(9); // –Ø—á–µ–π–∫–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        formatReportSheet(addressSheet); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS); 
    if (competitorsSheet) { 
        competitorsSheet.getRange('A2:N1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö –≤ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥.
 * @param {number|string} months –°—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {string} –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä–æ–∫.
 */

// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ==================

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ç–∏—Ä–µ.
 * @param {number} length –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏.
 * @returns {Array<string>} –ú–∞—Å—Å–∏–≤ –∏–∑ —Ç–∏—Ä–µ.
 */
function createDashRow(length) { return new Array(length).fill('-'); }

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateAverage(arr) { 
  if (!arr || arr.length === 0) return 0; 
  return Math.floor(arr.reduce((a, b) => a + b, 0) / arr.length); 
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateMedian(arr) { 
  if (!arr || arr.length === 0) return 0; 
  const sorted = [...arr].sort((a, b) => a - b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0 ? sorted[mid] : Math.floor((sorted[mid - 1] + sorted[mid]) / 2); // –°—Ä–µ–¥–Ω–µ–µ –¥–≤—É—Ö —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —á–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (—Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @param {number} percent –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Å–µ–∫–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∞—è.
 * @returns {number} –£—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ.
 */
function calculateTrimmedMean(arr, percent) { 
  if (!arr || arr.length === 0) return 0; 
  const sorted = [...arr].sort((a,b) => a-b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const trimCount = Math.floor(sorted.length * percent); // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è
  const trimmedArr = sorted.slice(trimCount, sorted.length - trimCount); // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  return trimmedArr.length > 0 ? calculateAverage(trimmedArr) : calculateAverage(arr); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ —É—Å–µ—á–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞, –µ—Å–ª–∏ —É—Å–µ—á–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ (–Ω–∞–∫–ª–æ–Ω –∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ).
 * @param {Array<Array<number>>} data –ú–∞—Å—Å–∏–≤ –ø–∞—Ä [x, y].
 * @returns {{slope: number, intercept: number}|null} –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –∏–ª–∏ null.
 */
function calculateLinearRegression(data) { 
  if(!data || data.length < 2) return null; 
  
  let sum_x = 0, sum_y = 0, sum_xy = 0, sum_xx = 0;
  const n = data.length;
  
  // –°—É–º–º–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
  data.forEach(([x, y]) => { 
    sum_x += x; 
    sum_y += y; 
    sum_xy += x * y; 
    sum_xx += x * x; 
  }); 
  
  const denominator = (n * sum_xx - sum_x * sum_x);
  if (denominator === 0) return null; // –ò–∑–±–µ–≥–∞–µ–º –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
  
  const slope = (n * sum_xy - sum_x * sum_y) / denominator; // –ù–∞–∫–ª–æ–Ω
  const intercept = (sum_y - slope * sum_x) / n; // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
  
  return { slope, intercept }; 
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ Google –¢–∞–±–ª–∏—Ü—ã.
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤, –¥–æ–±–∞–≤–ª—è—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} columns –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 * @returns {Array<Array<any>>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatForBatchWrite(data, columns) { 
  return data.map(row => { 
    const newRow = [...row]; // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ, —á–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
    while (newRow.length < columns) newRow.push(''); 
    return newRow.slice(0, columns); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤
  }); 
}

// ================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–æ–≤.
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
 */
function setupNewSheets() {
  try {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É"
    setupSingleObjectAnalyticsSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    setupAnalysisObjectSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    setupCompetitorsAnalysisSheet();
    
    SpreadsheetApp.getUi().alert('‚úÖ –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!');
    Logger.log('–ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ setupNewSheets: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–æ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤: ' + e.message);
  }
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
 */
function setupAnalysisObjectSheet() {
  const sheet = SPREADSHEET.getSheetByName('–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ (A2:AQ2)
  const headers = [
    '–î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', 
    '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', 
    '–§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞', '–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?', '–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?', '–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?',
    '–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞', '—Ü–∏–∞–Ω', '–¥–∞—Ç–∞', '–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞',
    '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', 
    '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞', 
    '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', 
    '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %', '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', 
    '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:AP2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:AP2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:AP1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
  sheet.getRange('V3:AP1000').setHorizontalAlignment('center');
  
  Logger.log('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
 */
function setupCompetitorsAnalysisSheet() {
  const sheet = SPREADSHEET.getSheetByName('–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ª–∏—Å—Ç–µ)
  const headers = [
    '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', 
    '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:M2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:M2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:M1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  Logger.log('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ –∫–æ–¥–∞.
 */
function setupSingleObjectAnalyticsSheet() {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ A2 - –∑–∞–≥–æ–ª–æ–≤–æ–∫
  sheet.getRange('A2')
    .setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞')
    .setFontSize(9)
    .setFontWeight('bold')
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ B2 - –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
  sheet.getRange('B2')
    .setHorizontalAlignment('center')
    .setBackground('#4ee1f6')
    .setBorder(true, true, true, true, false, false)
    .setFontSize(9)
    .setVerticalAlignment('middle');
  
  // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å 4 —Å—Ç—Ä–æ–∫–∏)
  sheet.getRange('A4:B50').clearContent().clearFormat();
  
  Logger.log('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É –≤ –ª–∏—Å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.
 * @returns {Array|null} –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
 */
function findObjectByCode(code) {
  try {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!code || typeof code !== 'string') {
      Logger.log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    const cleanCode = String(code).trim();
    if (cleanCode === '') {
      Logger.log('–ü—É—Å—Ç–æ–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–∏—Å—Ç–∞ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"
    const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
    if (!activeSheet) {
      Logger.log('–õ–∏—Å—Ç "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return null;
    }
    
    const lastRow = activeSheet.getLastRow();
    if (lastRow < 3) {
      Logger.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"');
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å —Å—Ç—Ä–æ–∫–∏ 3, —Ç–∞–∫ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ 2 - –∑–∞–≥–æ–ª–æ–≤–∫–∏)
    const data = activeSheet.getRange('A3:O' + lastRow).getValues();
    
    // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞ (—Å—Ç–æ–ª–±–µ—Ü F, –∏–Ω–¥–µ–∫—Å 5)
    const foundRow = data.find(row => {
      const rowCode = String(row[5]).trim(); // –°—Ç–æ–ª–±–µ—Ü F (–∏–Ω–¥–µ–∫—Å 5)
      Logger.log(`–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–¥: "${cleanCode}" —Å "${rowCode}"`);
      return rowCode === cleanCode;
    });
    
    if (foundRow) {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö`);
      return foundRow;
    } else {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö`);
      return null;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ findObjectByCode: ${e.stack}`);
    return null;
  }
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {boolean} –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞.
 */
function validateCode(code) {
  if (!code || typeof code !== 'string') return false;
  const cleanCode = String(code).trim();
  return cleanCode !== '' && cleanCode.length > 0;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –º–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏.
 */
function buildSingleObjectCompetitorsArray(objectData) {
  try {
    Logger.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    const district = objectData[1]; // –†–∞–π–æ–Ω
    const type = objectData[2]; // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    const rooms = Number(objectData[3]); // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    const area = Number(objectData[4]); // –ü–ª–æ—â–∞–¥—å
    const repair = objectData[6]; // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    const buildYear = Number(objectData[10]); // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    
    Logger.log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}, —Ä–µ–º–æ–Ω—Ç=${repair}, –≥–æ–¥=${buildYear}`);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeData = getActiveCompetitorsData();
    const soldData = getSoldCompetitorsData();
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: ${activeData.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: ${soldData.length}`);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏)
    const activeCompetitors = filterCompetitorsByCriteria(activeData, {
      district, type, rooms, area, repair, buildYear
    }, true); // true = –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    const soldCompetitors = filterCompetitorsByCriteria(soldData, {
      district, type, rooms, area, repair, buildYear
    }, false); // false = –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    Logger.log(`–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${activeCompetitors.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${soldCompetitors.length}`);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
    const formattedActive = activeCompetitors.map(row => formatCompetitorRow(row, false));
    const formattedSold = soldCompetitors.map(row => formatCompetitorRow(row, true));
    
    Logger.log(`–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${formattedActive.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${formattedSold.length}`);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    fillCompetitorsSheet(formattedActive, formattedSold, objectData[5], objectData); // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–∞–∫–∂–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞
    
    Logger.log('–ú–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    
    return {
      activeCompetitors: formattedActive,
      soldCompetitors: formattedSold
    };
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ buildSingleObjectCompetitorsArray: ${e.stack}`);
    return { activeCompetitors: [], soldCompetitors: [] };
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getActiveCompetitorsData() {
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  if (!activeSheet || activeSheet.getLastRow() < 3) return [];
  return activeSheet.getRange('A3:O' + activeSheet.getLastRow()).getValues();
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getSoldCompetitorsData() {
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  if (!soldSheet || soldSheet.getLastRow() < 3) return [];
  return soldSheet.getRange('A3:O' + soldSheet.getLastRow()).getValues();
}

/**
 * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} data –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 * @param {boolean} isActiveData –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 * @returns {Array} –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */
function filterCompetitorsByCriteria(data, criteria, isActiveData = true) {
  const { district, type, rooms, area, repair, buildYear } = criteria;
  
  Logger.log(`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}`);
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  const now = new Date();
  const startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1); // 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
  const endDate = now;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏" (6 –º–µ—Å—è—Ü–µ–≤)
  const staleDate = new Date();
  staleDate.setMonth(staleDate.getMonth() - 6);
  
  Logger.log(`–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: staleDate=${staleDate.toLocaleDateString()}, startDate=${startDate.toLocaleDateString()}, endDate=${endDate.toLocaleDateString()}`);
  
  let filteredCount = 0;
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
  const result = data.filter((row, index) => {
    try {
      const rowDate = new Date(row[0]);
      const rowDistrict = row[1];
      const rowType = row[2];
      const rowRooms = Number(row[3]);
      const rowArea = Number(row[4]);
      const rowRepair = row[6];
      const rowBuildYear = Number(row[10]) || null;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      if (index < 3) {
        Logger.log(`–°—Ç—Ä–æ–∫–∞ ${index}: —Ä–∞–π–æ–Ω="${rowDistrict}", —Ç–∏–ø="${rowType}", –∫–æ–º–Ω–∞—Ç=${rowRooms}, –ø–ª–æ—â–∞–¥—å=${rowArea}, —Ä–µ–º–æ–Ω—Ç="${rowRepair}", –≥–æ–¥=${rowBuildYear}`);
      }
      
      // 1. –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –§–ò–õ–¨–¢–† (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π!)
      if (rowDistrict !== district) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–∞–π–æ–Ω—É: "${rowDistrict}" !== "${district}"`);
        return false;
      }
      
      // 2. –¢–ò–ü –û–ë–™–ï–ö–¢–ê (—Å—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
      if (rowType !== type) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ç–∏–ø—É: "${rowType}" !== "${type}"`);
        return false;
      }
      
      // 3. –í–†–ï–ú–ï–ù–ù–û–ô –§–ò–õ–¨–¢–†
      if (isActiveData) {
        // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö: –Ω–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < staleDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–∞–∫—Ç–∏–≤–Ω—ã–µ): ${rowDate.toLocaleDateString()} < ${staleDate.toLocaleDateString()}`);
          return false;
        }
      } else {
        // –î–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < startDate.getTime() || rowDate.getTime() > endDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ): ${rowDate.toLocaleDateString()} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`);
          return false;
        }
      }
      
      // 4. –ö–û–õ–ò–ß–ï–°–¢–í–û –ö–û–ú–ù–ê–¢ (–¥–æ–ø—É—Å–∫ +/- 1)
      const allowedRooms = [rooms, rooms + 1, rooms - 1].filter(r => r >= 0);
      if (!allowedRooms.includes(rowRooms)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º: ${rowRooms} –Ω–µ –≤ ${allowedRooms}`);
        return false;
      }
      
      // 5. –ü–õ–û–©–ê–î–¨ (–¥–æ–ø—É—Å–∫ +/- 20%)
      const minArea = area * 0.8;
      const maxArea = area * 1.2;
      if (rowArea < minArea || rowArea > maxArea) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –ø–ª–æ—â–∞–¥–∏: ${rowArea} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${minArea}-${maxArea}`);
        return false;
      }
      
      // 6. –ì–û–î –ü–û–°–¢–†–û–ô–ö–ò (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
      if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≥–æ–¥—É: ${rowBuildYear} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${buildYear - 10}-${buildYear + 10}`);
        return false;
      }
      
      // 7. –¢–ò–ü –†–ï–ú–û–ù–¢–ê (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞)
      const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
      const objectRepairLower = repair ? repair.toLowerCase() : '';
      const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));
      
      if (isObjectGoodRepair) {
        // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, –∏—â–µ–º —Ç–æ–ª—å–∫–æ —Å —Ö–æ—Ä–æ—à–∏–º
        const competitorRepairLower = rowRepair ? rowRepair.toLowerCase() : '';
        if (!goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–µ–º–æ–Ω—Ç—É: "${rowRepair}" –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞`);
          return false;
        }
      }
      // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç - —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
      
      if (index < 3) Logger.log(`  ‚úÖ –°—Ç—Ä–æ–∫–∞ ${index} –ø—Ä–æ—à–ª–∞ –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã!`);
      filteredCount++;
      return true;
    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏ ${index}: ${e.message}`);
      return false;
    }
  });
  
  Logger.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${filteredCount} –∏–∑ ${data.length} ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤`);
  
  return result;
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 */
function fillCompetitorsSheet(activeCompetitors, soldCompetitors, objectCode, objectData) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
  sheet.getRange('A2:M' + Math.max(sheet.getMaxRows(), 100)).clearContent().clearFormat();
  
  let output = [];
  const headers = ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // 1. –í—Å–µ–≥–¥–∞ –ø–∏—à–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –≤ Row 2
  sheet.getRange('A2:M2').setValues([headers]);
  sheet.getRange('A2:M2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');

  // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≤–æ–¥–∞ (–Ω–∞—á–∏–Ω–∞—è —Å Row 3)
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (activeCompetitors.length > 0) {
    output.push([`–ê–ö–¢–ò–í–ù–´–ï –ö–û–ù–ö–£–†–ï–ù–¢–´ (–í–∞—à –æ–±—ä–µ–∫—Ç: ${objectCode})`]);
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –Ω–∞—à–∏–º –æ–±—ä–µ–∫—Ç–æ–º + –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
    const allActiveObjects = [...activeCompetitors];
    if (objectData) {
      const ourObjectAsCompetitor = formatCompetitorRow(objectData, false);
      allActiveObjects.push(ourObjectAsCompetitor);
    }
    
    const sortedActiveCompetitors = allActiveObjects.sort((a, b) => (Number(a[5]) || 0) - (Number(b[5]) || 0));
    output.push(...sortedActiveCompetitors);
    output.push(['']); // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (soldCompetitors.length > 0) {
    output.push([`–ü–†–û–î–ê–ù–ù–´–ï –ö–û–ù–ö–£–†–ï–ù–¢–´`]);
    
    const sortedSoldCompetitors = [...soldCompetitors].sort((a, b) => (Number(a[5]) || 0) - (Number(b[5]) || 0));
    output.push(...sortedSoldCompetitors);
  }
  
  // 3. –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞—è —Å Row 3
  if (output.length > 0) {
    const formattedData = formatForBatchWrite(output, 13);
    sheet.getRange(3, 1, formattedData.length, 13).setValues(formattedData);
    
    // 4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤
    let currentRow = 3;
    for (let i = 0; i < output.length; i++) {
        const range = sheet.getRange(currentRow, 1, 1, 13);
        if (output[i].length === 1 && output[i][0] && String(output[i][0]).includes('–ö–û–ù–ö–£–†–ï–ù–¢–´')) {
            range.merge()
                 .setBackground('#1a73e8')
                 .setFontColor('white')
                 .setFontWeight('bold')
                 .setHorizontalAlignment('center');
        } else if (output[i][0] === objectCode) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            range.setBackground('#e8f0fe').setFontWeight('bold');
        }
        currentRow++;
    }
  }
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 */
function analyzeSingleObject(objectData, competitorsData) {
  try {
    const { activeCompetitors, soldCompetitors } = competitorsData;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã
    const advertisingData = getAdvertisingData(objectData[5]); // objectData[5] - –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞
    
    // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
    const metrics = calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞
    fillAnalysisObjectSheet(objectData, advertisingData, metrics);
    
    return metrics;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObject: ${e.stack}`);
    return null;
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingData(objectCode) {
  const avitoData = getAdvertisingPlatformData(SHEETS.AVITO, objectCode);
  const cianData = getAdvertisingPlatformData(SHEETS.CIAN, objectCode);
  const domclickData = getAdvertisingPlatformData(SHEETS.DOMCLICK, objectCode);
  
  return {
    avito: avitoData,
    cian: cianData,
    domclick: domclickData
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} sheetName –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingPlatformData(sheetName, objectCode) {
  const sheet = SPREADSHEET.getSheetByName(sheetName);
  if (!sheet || sheet.getLastRow() < 3) {
    return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
  }
  
  const data = sheet.getRange('A3:D' + sheet.getLastRow()).getValues();
  const foundRow = data.find(row => String(row[1]).trim() === String(objectCode).trim());
  
  if (foundRow) {
    return {
      status: foundRow[2] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      date: foundRow[3] || null
    };
  }
  
  return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–ø–æ–ª–Ω–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @returns {Object} –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData) {
  const objectPrice = Number(objectData[7]) || 0;
  const objectArea = Number(objectData[4]) || 1;
  const objectPricePerM2 = objectArea > 0 ? objectPrice / objectArea : 0;
  
  // –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
  const competitorsInDistrict = activeCompetitors.length;
  const totalSales = soldCompetitors.length;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  // (—Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –Ω–µ—Ç –ª–∏—Å—Ç–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ" —Å —è—á–µ–π–∫–∞–º–∏ C1-C2)
  const periodMonths = 6;
  Logger.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${periodMonths} –º–µ—Å—è—Ü–µ–≤`);
  
  // –°–ø—Ä–æ—Å (–æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü)
  const demandPerMonth = totalSales / periodMonths;
  
  // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
  const liquidityType = determineLiquidityType(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
  const marketAssessment = assessMarket(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
  const competitionTrend = calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths);
  
  // –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ
  const objectRank = calculateObjectRank(objectData, activeCompetitors);
  
  // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤
  const priceTrendPerM2 = calculatePriceTrendPerM2(soldCompetitors);
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º
  const marketRatios = calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors);
  
  // –ü—Ä–æ–≥–Ω–æ–∑—ã
  const forecasts = calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors);
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
  const avgNewObjectsPerMonth = competitorsInDistrict / periodMonths;
  const arrivalToDemandRatio = demandPerMonth > 0 ? ((avgNewObjectsPerMonth / demandPerMonth) * 100) : 0;
  const weightedRecommendedPrice = calculateWeightedRecommendedPrice(marketRatios, forecasts);
  
  return {
    competitorsInDistrict,
    totalSales,
    demandPerMonth,
    liquidityType,
    marketAssessment,
    competitionTrend,
    objectRank,
    priceTrendPerM2,
    marketRatios,
    forecasts,
    avgNewObjectsPerMonth,
    arrivalToDemandRatio,
    weightedRecommendedPrice
  };
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @param {Object} metrics –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function fillAnalysisObjectSheet(objectData, advertisingData, metrics) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
  sheet.getRange('A3:AP1000').clearContent();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
  const rowData = [
    objectData[0], // –î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
    objectData[1], // –†–∞–π–æ–Ω
    objectData[2], // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    objectData[3], // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    objectData[4], // –ü–ª–æ—â–∞–¥—å
    objectData[5], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç
    objectData[6], // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    objectData[7], // –¶–µ–Ω–∞
    objectData[8], // –≠—Ç–∞–∂
    objectData[9], // –ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π
    objectData[10], // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    objectData[11], // –§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞
    objectData[12], // –ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?
    objectData[13], // –û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?
    objectData[14], // –ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?
    advertisingData.avito.status, // –∞–≤–∏—Ç–æ
    advertisingData.avito.date, // –¥–∞—Ç–∞ –∞–≤–∏—Ç–æ
    advertisingData.cian.status, // —Ü–∏–∞–Ω
    advertisingData.cian.date, // –¥–∞—Ç–∞ —Ü–∏–∞–Ω
    advertisingData.domclick.status, // –¥–æ–º–∫–ª–∏–∫
    advertisingData.domclick.date, // –¥–∞—Ç–∞ –¥–æ–º–∫–ª–∏–∫
    metrics.competitorsInDistrict, // –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ
    metrics.totalSales, // –ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ
    metrics.demandPerMonth, // —Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å
    metrics.avgNewObjectsPerMonth, // –ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å
    metrics.liquidityType, // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    metrics.marketAssessment, // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
    metrics.competitionTrend, // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %
    metrics.objectRank, // –º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    metrics.priceTrendPerM2.trend + ' ' + metrics.priceTrendPerM2.indicator + (metrics.priceTrendPerM2.reliable ? '' : ' (?)'), // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å
    metrics.marketRatios.activeRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %
    metrics.marketRatios.soldRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.marketRatios.avgActivePrice, // —Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.activeRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %
    metrics.marketRatios.avgSoldPrice, // —Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.soldRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.forecasts.quickPrice, // –¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)
    metrics.forecasts.quickMonths, // –°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.
    metrics.forecasts.marketPrice, // –¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)
    metrics.forecasts.marketMonths // –°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.
  ];
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É 3
  sheet.getRange('A3:AP3').setValues([rowData]);
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
 */
function analyzeSingleObjectByCode(objectCode) {
  try {
    Logger.log(`–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å –∫–æ–¥–æ–º: ${objectCode}`);
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!validateCode(objectCode)) {
      Logger.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 2. –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      Logger.log('‚ùå –û–±—ä–µ–∫—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö');
      return false;
    }
    
    // 3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData);
    
    // 3.1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const criteria = {
      district: objectData[1],
      type: objectData[2],
      rooms: Number(objectData[3]),
      area: Number(objectData[4]),
      repair: objectData[6],
      buildYear: Number(objectData[10])
    };
    writeCompetitorCriteria(objectData, criteria);
    
    // 4. –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞
    const analysisResults = analyzeSingleObject(objectData, competitorsData);
    
    if (!analysisResults) {
      Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    const reportGenerated = generateSingleObjectReport(objectData, analysisResults, competitorsData);
    
    if (reportGenerated) {
      Logger.log('–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      return true;
    } else {
      Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
      return false;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObjectByCode: ${e.stack}`);
    Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ' + e.message);
    return false;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –æ–¥–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} analysisResults –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
 */
function generateSingleObjectReport(objectData, analysisResults, competitorsData) {
  try {
    const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (!sheet) return false;
    
    // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞ —Å –∑–∞–ø–∞—Å–æ–º (—á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —è—á–µ–µ–∫)
    sheet.getRange('A4:B200').clearContent().clearFormat();
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
    const reportData = createSingleObjectReportData(objectData, analysisResults, competitorsData);
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
    const values = reportData.map(row => [row[0], row[1]]);
    sheet.getRange(4, 1, values.length, 2).setValues(values);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    reportData.forEach((row, index) => {
      const rowNumber = 4 + index;
      const range = sheet.getRange(rowNumber, 1, 1, 2);
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ (—Å–∏–Ω–∏–π —Ñ–æ–Ω) - –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–±–µ—Ü –ø—É—Å—Ç–æ–π –∏ —ç—Ç–æ –Ω–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
      if (row[0] && row[1] === '' && !row[0].includes('---')) {
        range.merge()
          .setFontWeight('bold')
          .setBackground('#1a73e8')
          .setFontColor('white')
          .setFontSize(10)
          .setVerticalAlignment('middle');
      } 
      // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
      else if (row[0] && row[0].includes('---')) {
        range.merge()
          .setBackground('#f8f9fa')
          .setFontColor('#9aa0a6')
          .setFontSize(8)
          .setHorizontalAlignment('center');
      } 
      // –û–±—ã—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      else if (row[0]) {
        sheet.getRange(rowNumber, 1).setFontWeight('bold').setFontColor('#3c4043').setFontSize(9);
        sheet.getRange(rowNumber, 2).setFontColor('#202124').setFontSize(9).setHorizontalAlignment('right');
        
        if (row[0].includes('‚ö°') || row[0].includes('üè†')) {
          sheet.getRange(rowNumber, 2).setFontWeight('bold').setFontColor('#1a73e8').setFontSize(10);
        }
      }
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
    if (reportData.length > 0) {
      sheet.getRange(4, 1, reportData.length, 2).setBorder(true, true, true, true, true, true, '#e8eaed', SpreadsheetApp.BorderStyle.SOLID);
    }
    
    SpreadsheetApp.flush();
    
    // –í–´–ó–´–í–ê–ï–ú –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ö–°–¢–ê
    try {
      // –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ï –ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –ù–ê –°–¢–†–û–ö–ï 34
      const aiRowBase = 34;
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ò–ò
      sheet.getRange(aiRowBase, 1, 1, 2).merge()
        .setValue('ü§ñ –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î –ê–ù–ê–õ–ò–¢–ò–ö–ê')
        .setFontWeight('bold')
        .setBackground('#202124')
        .setFontColor('white')
        .setFontSize(10)
        .setHorizontalAlignment('center')
        .setVerticalAlignment('middle');

      // –¢–µ–ª–æ –±–ª–æ–∫–∞
      const aiBodyRange = sheet.getRange(aiRowBase + 1, 1, 15, 2).merge();
      aiBodyRange.setValue('‚è≥ –ò–¥–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è...')
        .setFontSize(9)
        .setWrap(true)
        .setVerticalAlignment('top')
        .setBackground('#ffffff');
      
      sheet.setRowHeight(aiRowBase + 1, 400);
      SpreadsheetApp.flush();

      const aiAnalysis = createSingleObjectReportText(objectData, analysisResults, competitorsData);
      aiBodyRange.setValue(aiAnalysis);
      
    } catch (err) {
      Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –ò–ò-–±–ª–æ–∫–∞: ' + err.message);
    }
    
    Logger.log('–û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
    return true;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ generateSingleObjectReport: ${e.stack}`);
    return false;
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
 */
/**
 * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
 */
function createSingleObjectReportText(objectData, analysisResults, competitorsData) {
  const macro = getMacroContext();
  
  try {
    const analyticsData = {
      object: {
        district: objectData[1], rooms: objectData[3], area: objectData[4],
        price: Number(objectData[7]), pricePerSqm: Math.round(Number(objectData[7]) / Number(objectData[4]))
      },
      market: {
        demand: analysisResults.demandPerMonth, // –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
        activeCount: competitorsData.activeCompetitors.length,
        soldCount: competitorsData.soldCompetitors.length,
        rank: analysisResults.objectRank,
        avgActivePrice: analysisResults.marketRatios.avgActivePrice,
        avgSoldPrice: analysisResults.marketRatios.avgSoldPrice,
        arrivalRate: analysisResults.avgNewObjectsPerMonth, // –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
        inventoryIndex: analysisResults.arrivalToDemandRatio, // % –ø—Ä–∏—Ç–æ–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–∞–º
        liquidity: analysisResults.liquidityType
      },
      forecast: analysisResults.forecasts
    };

    const aiResult = callGeminiAnalyst(analyticsData, macro);
  
    if (aiResult.success) {
      return aiResult.text;
    } 
    
    return `–ê–ù–ê–õ–ò–ó: –û–±—ä–µ–∫—Ç –≤ —Ä–∞–π–æ–Ω–µ ${objectData[1]} —Å —Ü–µ–Ω–æ–π ${Number(objectData[7]).toLocaleString()} ‚ÇΩ. ` +
           `–¢–µ–∫—É—â–∏–π —Å–ø—Ä–æ—Å ${analysisResults.demandPerMonth.toFixed(1)} –æ–±/–º–µ—Å. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ ${analysisResults.forecasts.marketPrice.toLocaleString()} ‚ÇΩ.`;
    
  } catch (error) {
    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.";
  }
}

/**
 * [v3.0] –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ (—Ä–æ–≤–Ω–æ 30 —Å—Ç—Ä–æ–∫ –ø–æ–ª–µ–∑–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö).
 */
function createSingleObjectReportData(objectData, analysisResults, competitorsData) {
  const { activeCompetitors } = competitorsData;
  const forecasts = analysisResults.forecasts;
  
  const reportData = [
    ['üè¢ –í–ê–® –û–ë–™–ï–ö–¢', ''],
    ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
    ['–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ', objectData[1]],
    ['–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', `${objectData[3]}-–∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞, ${objectData[4]} –º¬≤`],
    ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', `${objectData[10]} –≥.`],
    ['–°–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–µ–º–æ–Ω—Ç)', objectData[6]],
    ['–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', `${Number(objectData[7]).toLocaleString()} ‚ÇΩ`],
    ['–¶–µ–Ω–∞ –∑–∞ –∫–≤. –º–µ—Ç—Ä', `${Math.round(Number(objectData[7])/Number(objectData[4])).toLocaleString()} ‚ÇΩ/–º¬≤`],
    ['--------------------------------', '---'],
    ['üìä –°–û–°–¢–û–Ø–ù–ò–ï –†–´–ù–ö–ê', ''],
    ['–¢–µ–∫—É—â–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å', analysisResults.marketAssessment],
    ['–¢–µ–º–ø –ø—Ä–æ–¥–∞–∂ –≤ —Ä–∞–π–æ–Ω–µ', `${analysisResults.demandPerMonth.toFixed(1)} –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å.`],
    ['–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', `${activeCompetitors.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π`],
    ['–ü—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö (–º–µ—Å)', `+${analysisResults.avgNewObjectsPerMonth.toFixed(1)}`],
    ['–ò–Ω–¥–µ–∫—Å –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–Ω–∏—è', `${analysisResults.arrivalToDemandRatio.toFixed(0)}%`],
    ['–ö–ª–∞—Å—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', `–ì—Ä–µ–π–¥ ${analysisResults.liquidityType}`],
    ['--------------------------------', '---'],
    ['üìç –ö–û–ù–ö–£–†–ï–ù–¢–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø', ''],
    ['–†–µ–π—Ç–∏–Ω–≥ –ø–æ —Ü–µ–Ω–µ', `${analysisResults.objectRank}-–µ –º–µ—Å—Ç–æ –∏–∑ ${activeCompetitors.length}`],
    ['‚ÜîÔ∏è vs –ê–∫—Ç–∏–≤–Ω—ã–µ', `${analysisResults.marketRatios.activeRatio < 0 ? '–¥–µ—à–µ–≤–ª–µ –Ω–∞ ' : '–¥–æ—Ä–æ–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.activeRatio).toFixed(1)}%`],
    ['üìâ vs –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ', `${analysisResults.marketRatios.soldRatio < 0 ? '–¥–µ—à–µ–≤–ª–µ –Ω–∞ ' : '–¥–æ—Ä–æ–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.soldRatio).toFixed(1)}%`],
    ['–°—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', `${Math.round(analysisResults.marketRatios.avgActivePrice * Number(objectData[4])).toLocaleString()} ‚ÇΩ`],
    ['–°—Ä. —Ü–µ–Ω–∞ —Å–¥–µ–ª–æ–∫', `${Math.round(analysisResults.marketRatios.avgSoldPrice * Number(objectData[4])).toLocaleString()} ‚ÇΩ`],
    ['--------------------------------', '---'],
    ['üí∞ –¶–ï–ù–û–í–´–ï –°–¢–†–ê–¢–ï–ì–ò–ò', ''],
    ['‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ (1-2 –º–µ—Å)', `${analysisResults.forecasts.quickPrice.toLocaleString()} ‚ÇΩ`],
    ['üè† –†—ã–Ω–æ—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ (3-4 –º–µ—Å)', `${analysisResults.forecasts.marketPrice.toLocaleString()} ‚ÇΩ`],
    ['–û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏', `${forecasts.currentMonths || forecasts.marketMonths} –º–µ—Å.`],
    ['--------------------------------', '---']
  ];
  
  return reportData;
}

/**
 * –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (9, null, undefined, 0).
 * @param {*} value –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {*} –û—á–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null.
 */
function cleanDataValue(value) {
  if (value === null || value === undefined || value === '' || value === 0 || value === '9' || value === 9) {
    return null;
  }
  return value;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (–æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç 10% –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
 * @param {Array} prices –ú–∞—Å—Å–∏–≤ —Ü–µ–Ω.
 * @returns {number} –£—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ.
 */
function calculateTrimmedMean(prices) {
  if (prices.length === 0) return 0;
  if (prices.length < 3) return prices.reduce((sum, price) => sum + price, 0) / prices.length;
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã
  const sortedPrices = [...prices].sort((a, b) => a - b);
  
  // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è (20% —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
  const trimCount = Math.floor(sortedPrices.length * 0.2);
  
  // –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—Ä–∞–π–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const trimmedPrices = sortedPrices.slice(trimCount, sortedPrices.length - trimCount);
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ
  return trimmedPrices.reduce((sum, price) => sum + price, 0) / trimmedPrices.length;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ–¥–∏–∞–Ω—É.
 * @param {Array} prices –ú–∞—Å—Å–∏–≤ —Ü–µ–Ω.
 * @returns {number} –ú–µ–¥–∏–∞–Ω–∞.
 */
function calculateMedian(prices) {
  if (prices.length === 0) return 0;
  if (prices.length === 1) return prices[0];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã
  const sortedPrices = [...prices].sort((a, b) => a - b);
  
  const middle = Math.floor(sortedPrices.length / 2);
  
  if (sortedPrices.length % 2 === 0) {
    // –ß–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ –¥–≤—É—Ö —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö
    return (sortedPrices[middle - 1] + sortedPrices[middle]) / 2;
  } else {
    // –ù–µ—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - –±–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
    return sortedPrices[middle];
  }
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {Object} forecasts –ü—Ä–æ–≥–Ω–æ–∑—ã.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateWeightedRecommendedPrice(marketRatios, forecasts) {
  const activePrice = marketRatios.avgActivePrice || 0;
  const soldPrice = marketRatios.avgSoldPrice || 0;
  const marketPrice = forecasts.marketPrice || 0;
  
  if (activePrice > 0 && soldPrice > 0 && marketPrice > 0) {
    return (activePrice + soldPrice + marketPrice) / 3;
  }
  
  return marketPrice || 0;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 */
function calculateDemandPerMonth(soldCompetitors) {
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  const periodMonths = 6;
  
  return soldCompetitors.length / periodMonths;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 */
function determineLiquidityType(competitors, sales, demand) {
  if (competitors === 0) return 'C-';
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: (–°–ø—Ä–æ—Å / –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) * 100%
  const liquidityIndex = (demand / competitors) * 100;
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
  if (liquidityIndex > 25 && demand >= 3) return 'A+'; // –ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 20) return 'A'; // –í—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 10) return 'B'; // –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
  if (liquidityIndex >= 5) return 'C'; // –ù–∏–∑–∫–∏–π
  return 'C-'; // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ–∫.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞.
 */
function assessMarket(competitors, sales, demand) {
  if (competitors === 0) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  
  const liquidityIndex = demand / (competitors / 12);
  
  if (liquidityIndex >= 2) return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å';
  if (liquidityIndex >= 1.5) return '–í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å';
  if (liquidityIndex >= 1) return '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫';
  if (liquidityIndex >= 0.5) return '–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å';
  return '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å';
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ %.
 */
function calculateCompetitionTrend(activeCompetitors, soldCompetitors) {
  // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
  const activeCount = activeCompetitors.length;
  const soldCount = soldCompetitors.length;
  
  if (soldCount === 0) return 0;
  
  return ((activeCount - soldCount) / soldCount) * 100;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} periodMonths –ü–µ—Ä–∏–æ–¥ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {number} –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ %.
 */
function calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths) {
  if (activeCompetitors.length === 0) return 0;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
  const endDate = new Date();
  const startDate = new Date(endDate.getTime() - (periodMonths * 30.44 * 24 * 60 * 60 * 1000));
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2);
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = activeCompetitors.filter(row => {
    const rowDate = new Date(row[0]); // –î–∞—Ç–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ A
    return rowDate >= startDate && rowDate < midPoint;
  }).length;
  
  const secondHalfCount = activeCompetitors.filter(row => {
    const rowDate = new Date(row[0]); // –î–∞—Ç–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ A
    return rowDate >= midPoint && rowDate <= endDate;
  }).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return 100; // –†–µ–∑–∫–∏–π —Ä–æ—Å—Ç
  if (firstHalfCount === 0 || secondHalfCount === 0) return 0; // –°—Ç–∞–±–∏–ª—å–Ω–æ
  
  const trend = ((secondHalfCount - firstHalfCount) / firstHalfCount) * 100;
  return Math.round(trend);
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞.
 */
/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–º–ø –ø—Ä–∏—Ö–æ–¥–∞ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (arrival) –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü.
 */
function calculateRealArrivalRate(activeCompetitors) {
  if (!activeCompetitors || activeCompetitors.length === 0) return 0;
  
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  // –°—á–∏—Ç–∞–µ–º –æ–±—ä–µ–∫—Ç—ã, –≤—ã—à–µ–¥—à–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ c[13]
  const recentObjects = activeCompetitors.filter(c => {
    const pubDate = new Date(c[13]); 
    return !isNaN(pubDate.getTime()) && pubDate >= thirtyDaysAgo;
  });
  
  return recentObjects.length;
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–Ω–æ–≤–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} ourPrice –ù–∞—à–∞ —Ü–µ–Ω–∞.
 * @returns {number} –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–∞–≤–ª–µ–Ω–∏—è (0-1), –≥–¥–µ 1 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ.
 */
function calculateRecentPricingTrend(activeCompetitors, ourPricePerM2) {
  if (!activeCompetitors || activeCompetitors.length === 0 || !ourPricePerM2) return 0.5;
  
  const now = new Date();
  const fortyFiveDaysAgo = new Date(now.getTime() - (45 * 24 * 60 * 60 * 1000));
  
  // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ "–Ω–æ–≤–∏—á–∫–æ–≤" (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 45 –¥–Ω–µ–π)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ c[13]
  const newcomers = activeCompetitors.filter(c => {
    const pubDate = new Date(c[13]);
    return !isNaN(pubDate.getTime()) && pubDate >= fortyFiveDaysAgo;
  });
  
  if (newcomers.length === 0) return 0.5;
  
  // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –∏–∑ –Ω–∏—Ö –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å (–ø–æ —Ü–µ–Ω–µ –∑–∞ –º2)
  const cheaperNewcomers = newcomers.filter(c => {
    const priceM2 = Number(c[6]); // –¶–µ–Ω–∞ –∑–∞ –º2 —Ç–µ–ø–µ—Ä—å –≤ –∏–Ω–¥–µ–∫—Å–µ 6
    return priceM2 > 0 && priceM2 < ourPricePerM2;
  });
  
  return cheaperNewcomers.length / newcomers.length;
}

function calculateObjectRank(objectData, activeCompetitors) {
  const ourPriceM2 = Math.round(Number(objectData[7]) / Number(objectData[4])) || 0;
  
  if (activeCompetitors.length === 0) return 1;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤ (–∏–Ω–¥–µ–∫—Å 6) –¥–ª—è –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
  const competitorPricesM2 = activeCompetitors.map(c => Number(c[6]) || 0).filter(p => p > 0);
  
  const hasOurObject = competitorPricesM2.some(price => Math.abs(price - ourPriceM2) < 10);
  
  const allPricesM2 = hasOurObject 
    ? competitorPricesM2 
    : [...competitorPricesM2, ourPriceM2];
  
  allPricesM2.sort((a, b) => a - b);
  const rank = 1 + allPricesM2.filter(p => p < ourPriceM2).length;
  
  return rank;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –≤ —Ä—É–±/–º–µ—Å.
 */
function calculatePriceTrendPerM2(soldCompetitors) {
  const defaultResult = { trend: 0, r2: 0, indicator: '‚û°Ô∏è', reliable: false };
  
  if (soldCompetitors.length < 2) return defaultResult;
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
  const dataPoints = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[7]);
      const area = cleanDataValue(row[4]);
      const date = new Date(row[0]);
      
      if (price && area && area > 0 && !isNaN(date.getTime())) {
        return {
          x: date.getTime(), // –í—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
          y: Number(price) / Number(area) // –¶–µ–Ω–∞ –∑–∞ –º¬≤
        };
      }
      return null;
    })
    .filter(point => point !== null);
  
  if (dataPoints.length < 2) return defaultResult;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é
  const regression = calculateLinearRegression(dataPoints);
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–∫–ª–æ–Ω –≤ —Ä—É–±/–º–µ—Å (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –≤ –º–µ—Å—è—Ü)
  const millisecondsPerMonth = 1000 * 60 * 60 * 24 * 30.4375;
  const trend = regression.slope * millisecondsPerMonth;
  const r2 = regression.r2;
  
  // R¬≤ >= 0.3 —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–º —Ç—Ä–µ–Ω–¥–æ–º
  const reliable = r2 >= 0.3;
  
  // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–π)
  let indicator = '‚û°Ô∏è'; // —Å—Ç–∞–±–∏–ª—å–Ω–æ
  if (reliable) {
    if (trend > 500) indicator = '‚ÜóÔ∏è'; // —Ä–æ—Å—Ç > 500 —Ä—É–±/–º¬≤/–º–µ—Å
    else if (trend < -500) indicator = '‚ÜòÔ∏è'; // —Å–Ω–∏–∂–µ–Ω–∏–µ
  }
  
  return { trend: Math.round(trend), r2: Math.round(r2 * 100) / 100, indicator, reliable };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é –¥–ª—è –º–∞—Å—Å–∏–≤–∞ —Ç–æ—á–µ–∫.
 * @param {Array} points –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ {x, y}.
 * @returns {Object} {slope, intercept, r2}.
 */
function calculateLinearRegression(points) {
  const n = points.length;
  const sumX = points.reduce((sum, p) => sum + p.x, 0);
  const sumY = points.reduce((sum, p) => sum + p.y, 0);
  const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
  const sumXX = points.reduce((sum, p) => sum + p.x * p.x, 0);
  const sumYY = points.reduce((sum, p) => sum + p.y * p.y, 0);
  
  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  
  // –í—ã—á–∏—Å–ª—è–µ–º R¬≤
  const yMean = sumY / n;
  const ssRes = points.reduce((sum, p) => sum + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
  const ssTot = points.reduce((sum, p) => sum + Math.pow(p.y - yMean, 2), 0);
  const r2 = ssTot > 0 ? 1 - (ssRes / ssTot) : 0;
  
  return { slope, intercept, r2 };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 */
function calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors) {
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç 20% –∫—Ä–∞–π–Ω–∏—Ö)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: —Å—Ç–æ–ª–±–µ—Ü 5 = —Ü–µ–Ω–∞, —Å—Ç–æ–ª–±–µ—Ü 4 = –ø–ª–æ—â–∞–¥—å
  const activePricesPerM2 = activeCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgActivePricePerM2 = activePricesPerM2.length > 0 ? calculateTrimmedMean(activePricesPerM2) : 0;
  
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–º–µ–¥–∏–∞–Ω–∞)
  const soldPricesPerM2 = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgSoldPricePerM2 = soldPricesPerM2.length > 0 ? calculateMedian(soldPricesPerM2) : 0;
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö —Å –∑–Ω–∞–∫–æ–º)
  // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –≤—ã—à–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –Ω–∏–∂–µ
  const activeRatio = avgActivePricePerM2 > 0 ? ((objectPricePerM2 - avgActivePricePerM2) / avgActivePricePerM2) * 100 : 0;
  const soldRatio = avgSoldPricePerM2 > 0 ? ((objectPricePerM2 - avgSoldPricePerM2) / avgSoldPricePerM2) * 100 : 0;
  
  return {
    avgActivePrice: avgActivePricePerM2,
    avgSoldPrice: avgSoldPricePerM2,
    activeRatio,
    soldRatio
  };
}

/**
 * [v1.0] –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ —Å –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏.
 * –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ 13,490 —Å–¥–µ–ª–æ–∫.
 * @param {Array|Object} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ (–º–∞—Å—Å–∏–≤ –∏–ª–∏ dataMap).
 * @returns {number} –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ (1.0 = —Å—Ä–µ–¥–Ω–∏–π, >1.0 = –ª—É—á—à–µ, <1.0 = —Ö—É–∂–µ).
 */
function calculateQualityScore(objectData) {
  let score = 1.0; // –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
  try {
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –º–∞—Å—Å–∏–≤–∞, —Ç–∞–∫ –∏ –æ–±—ä–µ–∫—Ç–∞ dataMap
    const repair = (Array.isArray(objectData) ? objectData[6] : objectData['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞'] || '').toLowerCase();
    const buildYear = Number(Array.isArray(objectData) ? objectData[10] : objectData['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏']) || 0;
    const floor = Number(Array.isArray(objectData) ? objectData[8] : objectData['–≠—Ç–∞–∂']) || 0;
    const totalFloors = Number(Array.isArray(objectData) ? objectData[9] : objectData['–≠—Ç–∞–∂–Ω–æ—Å—Ç—å']) || 0;
    const currentYear = new Date().getFullYear();
    
    // === –†–ï–ú–û–ù–¢ (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (repair.includes('–¥–∏–∑–∞–π–Ω') || repair.includes('–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫')) {
      score += QUALITY_COEFFICIENTS.REPAIR_DESIGNER;
    } else if (repair.includes('–µ–≤—Ä–æ')) {
      score += QUALITY_COEFFICIENTS.REPAIR_EURO;
    } else if (repair.includes('—Å–æ–≤—Ä–µ–º–µ–Ω–Ω')) {
      score += QUALITY_COEFFICIENTS.REPAIR_MODERN;
    } else if (repair.includes('—Ç—Ä–µ–±—É–µ—Ç') || repair.includes('–±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞') || repair.includes('—á–µ—Ä–Ω–æ–≤–∞—è')) {
      score += QUALITY_COEFFICIENTS.REPAIR_NEEDS_WORK;
    } else if (repair.includes('—Å—Ç–∞—Ä—ã–π') || repair.includes('—É–±–∏—Ç')) {
      score += QUALITY_COEFFICIENTS.REPAIR_OLD;
    }
    // –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç: 0%
    
    // === –ì–û–î –ü–û–°–¢–†–û–ô–ö–ò (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (buildYear > 0) {
      const age = currentYear - buildYear;
      if (age <= 5) {
        score += QUALITY_COEFFICIENTS.BUILDING_NEW;       // –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞
      } else if (age <= 15) {
        score += QUALITY_COEFFICIENTS.BUILDING_MODERN;    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π
      } else if (age <= 40) {
        score += QUALITY_COEFFICIENTS.BUILDING_NORMAL;    // –û–±—ã—á–Ω—ã–π
      } else if (buildYear >= 1980) {
        score += QUALITY_COEFFICIENTS.BUILDING_OLD;       // –°—Ç–∞—Ä—ã–π (–ø–æ—Å–ª–µ 1980)
      } else {
        score += QUALITY_COEFFICIENTS.BUILDING_VERY_OLD;  // –û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–π (–¥–æ 1980)
      }
    }
    
    // === –≠–¢–ê–ñ (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (floor === 1) {
      score += QUALITY_COEFFICIENTS.FLOOR_FIRST;            // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂
    } else if (totalFloors > 2 && floor === totalFloors) {
      score += QUALITY_COEFFICIENTS.FLOOR_LAST;             // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂
    } else if (totalFloors > 3 && floor > 1 && floor < totalFloors) {
      score += QUALITY_COEFFICIENTS.FLOOR_MIDDLE;           // –°—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏
    }
    
    // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ê–ö–¢–û–†–´ ===
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ
    const hasPhoto = Array.isArray(objectData) ? objectData[12] : (objectData['–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ'] || objectData['–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?'] || '');
    if (hasPhoto && (String(hasPhoto).toLowerCase().includes('–¥–∞') || hasPhoto === '1' || hasPhoto === true)) {
      score += QUALITY_COEFFICIENTS.HAS_PROF_PHOTO;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –æ–ø–∏—Å–∞–Ω–∏—è
    const hasDesc = Array.isArray(objectData) ? objectData[13] : (objectData['–æ–ø–∏—Å–∞–Ω–∏–µ'] || objectData['–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?'] || '');
    if (hasDesc && (String(hasDesc).toLowerCase().includes('–¥–∞') || hasDesc === '1' || hasDesc === true)) {
      score += QUALITY_COEFFICIENTS.HAS_GOOD_DESC;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
    const hasFloorPlan = Array.isArray(objectData) ? objectData[14] : (objectData['–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞'] || objectData['–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?'] || '');
    if (hasFloorPlan && (String(hasFloorPlan).toLowerCase().includes('–¥–∞') || hasFloorPlan === '1' || hasFloorPlan === true)) {
      score += QUALITY_COEFFICIENTS.HAS_FLOOR_PLAN;
    }
    
  } catch(e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ calculateQualityScore: ${e.message}`);
  }
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç 0.70 –¥–æ 1.30
  return Math.max(0.70, Math.min(1.30, score));
}

/**
 * [v1.0] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ —Å —É—á—ë—Ç–æ–º –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞.
 * –£—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ—è–≤–ª–µ–Ω–∏–µ –±–æ–ª–µ–µ –¥–µ—à—ë–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —É—Ö—É–¥—à–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞.
 * @returns {Object} { months: number, info: string }
 */
function calculateDynamicTimeOnMarket(params) {
  const { rank, demand, arrival, price, activePrices, pricePressure } = params;
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–±—ã—Ç–∏—è –∏–ª–∏ —Å–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É–ª—É
  if (arrival <= 0 || demand <= 0) {
    return { months: rank / demand, info: '–ë–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–∏–±—ã—Ç–∏–∏)' };
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ–ª—é –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—à–µ–π —Ü–µ–Ω—ã
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π pricePressure (–∞–Ω–∞–ª–∏–∑ –Ω–æ–≤–∏—á–∫–æ–≤), –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  const priceBelowRatio = pricePressure !== undefined ? pricePressure : calculatePriceBelowRatio(price, activePrices, arrival);
  
  // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ = –ü—Ä–∏–±—ã—Ç–∏–µ * –î–æ–ª—è_–¥–µ—à–µ–≤–ª–µ_–Ω–∞—Å
  const rankLossPerMonth = arrival * priceBelowRatio;
  
  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å = –°–ø—Ä–æ—Å - –°–∫–æ—Ä–æ—Å—Ç—å_–ø–æ—Ç–µ—Ä–∏
  const effectiveDemand = demand - rankLossPerMonth;
  
  // –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π, —Ä—ã–Ω–æ–∫ –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è
  if (effectiveDemand <= 0) {
    // –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å —É—Ö—É–¥—à–∞—é—â–∏–º—Å—è —Ä–∞–Ω–≥–æ–º
    let currentRank = rank;
    let monthsPassed = 0;
    const maxMonths = 36; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
    
    while (currentRank > 0 && monthsPassed < maxMonths) {
      currentRank -= demand; // –ó–∞ –º–µ—Å—è—Ü –ø—Ä–æ–¥–∞—ë—Ç—Å—è demand –æ–±—ä–µ–∫—Ç–æ–≤
      currentRank += rankLossPerMonth; // –ù–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–æ–≤—ã–µ –¥–µ—à–µ–≤–ª–µ
      monthsPassed++;
      
      if (currentRank <= 0) break;
    }
    
    return { 
      months: monthsPassed, 
      info: `–†—ã–Ω–æ–∫ –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è (${(priceBelowRatio * 100).toFixed(0)}% –Ω–æ–≤—ã—Ö –¥–µ—à–µ–≤–ª–µ)` 
    };
  }
  
  // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –≤–æ–∑–º–æ–∂–Ω–∞
  const months = rank / effectiveDemand;
  
  return { 
    months: months, 
    info: `–≠—Ñ—Ñ. —Å–ø—Ä–æ—Å: ${effectiveDemand.toFixed(2)}/–º–µ—Å (–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è: ${(rankLossPerMonth).toFixed(2)}/–º–µ—Å)` 
  };
}

/**
 * [v1.0] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ–ª—é –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—à–µ–π —Ü–µ–Ω—ã.
 * @param {number} ourPrice –ù–∞—à–∞ —Ü–µ–Ω–∞.
 * @param {Array<number>} activePrices –¶–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} newObjectsCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @returns {number} –î–æ–ª—è –æ—Ç 0 –¥–æ 1.
 */
function calculatePriceBelowRatio(ourPrice, activePrices, newObjectsCount) {
  if (!ourPrice || ourPrice <= 0) return 0.5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 50%
  
  // –≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è
  const sortedPrices = activePrices.filter(p => p > 0).sort((a, b) => a - b);
  const totalActive = sortedPrices.length;
  
  if (totalActive === 0) return 0.5; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî 50%
  
  // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞—à–µ–π —Ü–µ–Ω—ã
  const cheaperCount = sortedPrices.filter(p => p < ourPrice).length;
  const empiricalRatio = cheaperCount / totalActive; // –î–æ–ª—è –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ >= 10, –¥–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–º
  if (newObjectsCount >= 10) {
    return empiricalRatio;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö 5-9, –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º 60% –¥–∞–Ω–Ω—ã–µ + 40% —ç–º–ø–∏—Ä–∏–∫–∞ (–ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
  if (newObjectsCount >= 5) {
    const baseRatio = 0.5; // –ë–∞–∑–æ–≤–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ 50%
    return 0.6 * empiricalRatio + 0.4 * baseRatio;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö < 5, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –∫–∞–∫ –æ—Å–Ω–æ–≤—É
  return empiricalRatio;
}

/**
 * [v1.0] –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤–æ–π–Ω–æ–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–Ω—ã: –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ –∏ –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ.
 * –†–∞–∑–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
 * - –ò–Ω–≤–µ—Å—Ç–æ—Ä—ã: —Ü–µ–Ω–∞ –∑–∞ –º¬≤ (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
 * - –°–µ–º—å–∏: –æ–±—â–∞—è —Ü–µ–Ω–∞ (–±—é–¥–∂–µ—Ç)
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞.
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –ø–æ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
 */
function calculateDualPriceAnalysis(params) {
  const { price, area, activeCompetitors, soldCompetitors } = params;
  
  if (!price || !area || area <= 0) {
    return { 
      byTotal: { rank: '-', percentile: '-', avgDiff: '-' },
      byPricePerSqm: { rank: '-', percentile: '-', avgDiff: '-' },
      recommendation: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'
    };
  }
  
  const pricePerSqm = Math.floor(price / area);
  
  // === –ê–Ω–∞–ª–∏–∑ –ø–æ –û–ë–©–ï–ô –¶–ï–ù–ï ===
  const activeTotalPrices = activeCompetitors
    .map(c => c[5] || c[4]) // –¶–µ–Ω–∞
    .filter(p => typeof p === 'number' && p > 0);
  
  const sortedActiveTotals = [...activeTotalPrices].sort((a, b) => a - b);
  const rankByTotal = sortedActiveTotals.filter(p => p < price).length + 1;
  const percentileByTotal = sortedActiveTotals.length > 0 
    ? Math.round((rankByTotal / sortedActiveTotals.length) * 100) 
    : 0;
  const avgActiveTotal = activeTotalPrices.length > 0 
    ? Math.floor(activeTotalPrices.reduce((a, b) => a + b, 0) / activeTotalPrices.length)
    : 0;
  const diffFromAvgTotal = avgActiveTotal > 0 
    ? Math.round((price - avgActiveTotal) / avgActiveTotal * 100) 
    : 0;
  
  // === –ê–Ω–∞–ª–∏–∑ –ø–æ –¶–ï–ù–ï –ó–ê –ú¬≤ ===
  const activePricesPerSqm = activeCompetitors
    .map(c => {
      const cPrice = c[5] || c[4];
      const cArea = c[4] || c[3];
      return (cPrice && cArea && cArea > 0) ? Math.floor(cPrice / cArea) : null;
    })
    .filter(p => p !== null && p > 0);
  
  const sortedActivePpsm = [...activePricesPerSqm].sort((a, b) => a - b);
  const rankByPpsm = sortedActivePpsm.filter(p => p < pricePerSqm).length + 1;
  const percentileByPpsm = sortedActivePpsm.length > 0 
    ? Math.round((rankByPpsm / sortedActivePpsm.length) * 100) 
    : 0;
  const avgActivePpsm = activePricesPerSqm.length > 0 
    ? Math.floor(activePricesPerSqm.reduce((a, b) => a + b, 0) / activePricesPerSqm.length)
    : 0;
  const diffFromAvgPpsm = avgActivePpsm > 0 
    ? Math.round((pricePerSqm - avgActivePpsm) / avgActivePpsm * 100) 
    : 0;
  
  // === –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é ===
  let recommendation = '';
  
  // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ –ª—É—á—à–µ, —á–µ–º –ø–æ –º¬≤ ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–µ–º–µ–π
  if (percentileByTotal < percentileByPpsm - 10) {
    recommendation = '–û–±—ä–µ–∫—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–µ–Ω –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ (—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: —Å–µ–º—å–∏ —Å –±—é–¥–∂–µ—Ç–æ–º)';
  } 
  // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø–æ –º¬≤ –ª—É—á—à–µ ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
  else if (percentileByPpsm < percentileByTotal - 10) {
    recommendation = '–û–±—ä–µ–∫—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–µ–Ω –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ (—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã)';
  }
  // –ü–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω—ã
  else {
    recommendation = '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –æ–±–µ–∏–º –º–µ—Ç—Ä–∏–∫–∞–º';
  }
  
  return {
    byTotal: {
      rank: rankByTotal,
      totalActive: sortedActiveTotals.length,
      percentile: percentileByTotal,
      avgDiff: `${diffFromAvgTotal > 0 ? '+' : ''}${diffFromAvgTotal}%`,
      avgPrice: avgActiveTotal
    },
    byPricePerSqm: {
      rank: rankByPpsm,
      totalActive: sortedActivePpsm.length,
      percentile: percentileByPpsm,
      avgDiff: `${diffFromAvgPpsm > 0 ? '+' : ''}${diffFromAvgPpsm}%`,
      avgPricePerSqm: avgActivePpsm
    },
    ourPrice: price,
    ourPricePerSqm: pricePerSqm,
    recommendation: recommendation
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors) {
  const qualityScore = calculateQualityScore(objectData);
  const hasSoldData = soldCompetitors.length > 0;
  const hasActiveData = activeCompetitors.length > 0;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  const marketSituation = assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, objectData[1]);
  
  // –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
  let baseSoldPrice, baseActivePrice, baseMarketPrice;
  const objectArea = Number(objectData[4]) || 1; // –ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞
  
  if (hasSoldData) {
    baseSoldPrice = marketRatios.avgSoldPrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    baseSoldPrice = calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation);
  }
  
  if (hasActiveData) {
    baseActivePrice = marketRatios.avgActivePrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∫–∞–∫ –±–∞–∑—É
    baseActivePrice = objectPrice;
  }
  
  // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
  baseMarketPrice = baseSoldPrice || baseActivePrice || objectPrice;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞
  const forecasts = calculateForecastsByPosition(
    objectPrice, 
    baseSoldPrice, 
    baseActivePrice, 
    baseMarketPrice,
    qualityScore,
    marketSituation,
    activeCompetitors,
    soldCompetitors,
    demandPerMonth,
    objectData // [+] [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ReferenceError]
  );
  
  // –£–õ–£–ß–®–ï–ù–ù–´–ô [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ B4]: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –ø—Ä–∏—Ç–æ–∫–∞ –∏ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è
  const avgNewObjectsPerMonth = calculateRealArrivalRate(activeCompetitors);
  const activePrices = activeCompetitors.map(c => c[4]).filter(p => p > 0);
  const pricePressure = calculateRecentPricingTrend(activeCompetitors, objectPricePerM2);
  
  // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  Logger.log(`[DYNAMICS] Arrival: ${avgNewObjectsPerMonth}/–º–µ—Å, Price Pressure: ${(pricePressure * 100).toFixed(1)}%`);

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
  const timeForecasts = calculateTimeForecasts(
    {...forecasts, position: calculateObjectPosition(objectPricePerM2, activeCompetitors)}, 
    demandPerMonth, 
    marketSituation,
    activeCompetitors.length,
    soldCompetitors.length,
    objectData,
    avgNewObjectsPerMonth,
    objectPricePerM2,
    activePrices,
    pricePressure
  );
  
  return {
    ...forecasts,
    ...timeForecasts,
    qualityScore,
    marketSituation
  };
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.
 * @param {boolean} hasSoldData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö.
 * @param {boolean} hasActiveData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {string} district –†–∞–π–æ–Ω.
 * @returns {Object} –û–ø–∏—Å–∞–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 */
function assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, district) {
  if (!hasSoldData && !hasActiveData) {
    return {
      type: 'NO_DATA',
      description: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑ —Å–æ—Å–µ–¥–Ω–∏—Ö —Ä–∞–π–æ–Ω–æ–≤'
    };
  }
  
  if (!hasSoldData && hasActiveData) {
    return {
      type: 'NO_SALES',
      description: '–ù–µ—Ç –ø—Ä–æ–¥–∞–∂ –≤ —Ä–∞–π–æ–Ω–µ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      riskLevel: 'MEDIUM',
      recommendation: '–†—ã–Ω–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –≤–æ–∑–º–æ–∂–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  if (hasSoldData && !hasActiveData) {
    return {
      type: 'NO_ACTIVE',
      description: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'LOW',
      recommendation: '–ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–º–∏–∞–ª—å–Ω—É—é —Ü–µ–Ω—É'
    };
  }
  
  if (demandPerMonth < 0.5) {
    return {
      type: 'LOW_DEMAND',
      description: '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  return {
    type: 'NORMAL',
    description: '–û–±—ã—á–Ω–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è',
    riskLevel: 'LOW',
    recommendation: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–µ–Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã'
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation) {
  // –ë–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
  const typeMultipliers = {
    '–ö–≤–∞—Ä—Ç–∏—Ä–∞': 1.0,
    '–°—Ç—É–¥–∏—è': 0.85,
    '–î–æ–º': 1.2,
    '–¢–∞—É–Ω—Ö–∞—É—Å': 1.1
  };
  
  const objectType = objectData[2] || '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
  const baseMultiplier = typeMultipliers[objectType] || 1.0;
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  let situationMultiplier = 1.0;
  switch (marketSituation.type) {
    case 'NO_DATA':
      situationMultiplier = 0.9; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 10% –∏–∑-–∑–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏
      break;
    case 'LOW_DEMAND':
      situationMultiplier = 0.85; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 15% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Å–ø—Ä–æ—Å–∞
      break;
    case 'NO_ACTIVE':
      situationMultiplier = 1.05; // –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ 5% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
      break;
  }
  
  return objectPrice * baseMultiplier * situationMultiplier;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} baseSoldPrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {number} baseActivePrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} baseMarketPrice –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞.
 * @param {number} qualityScore –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {Object} –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateForecastsByPosition(objectPrice, baseSoldPrice, baseActivePrice, baseMarketPrice, qualityScore, marketSituation, activeCompetitors, soldCompetitors, demandPerMonth, objectData) {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const position = calculateObjectPosition(objectPrice, activeCompetitors);
  const totalCompetitors = activeCompetitors.length;
  
  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏
  let positionMultiplier = 1.0;
  if (totalCompetitors > 0) {
    const positionRatio = position / (totalCompetitors + 1);
    if (positionRatio <= 0.2) {
      // –í —Ç–æ–ø-20% - –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 1.05;
    } else if (positionRatio >= 0.8) {
      // –í –Ω–∏–∂–Ω–∏—Ö 20% - —Å–∫–∏–¥–æ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 0.95;
    }
  }
  
  // –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤)
  let basePrice;
  if (baseSoldPrice > 0) {
    basePrice = baseSoldPrice * qualityScore * positionMultiplier;
  } else if (baseActivePrice > 0) {
    basePrice = baseActivePrice * qualityScore * positionMultiplier;
  } else {
    basePrice = objectPrice * qualityScore * positionMultiplier;
  }
  
  // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ - —Å–∞–º–∞—è –Ω–∏–∑–∫–∞—è —Ü–µ–Ω–∞ (—Å–∫–∏–¥–∫–∞ 10-15%)
  let quickPrice = basePrice * 0.87; // 13% —Å–∫–∏–¥–∫–∞ –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã
  
  // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
  let marketPrice = basePrice;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø—Ä–æ—Å–∞
  if (activeCompetitors.length > 0 && demandPerMonth > 0) {
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ü–µ–Ω–µ
    const sortedActivePrices = activeCompetitors
      .map(row => Number(row[5]) || 0)
      .filter(p => p > 0)
      .sort((a, b) => a - b);
    
    if (sortedActivePrices.length > 0) {
      // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø –ø–æ —Å–ø—Ä–æ—Å—É
      const demandPosition = Math.min(Math.ceil(demandPerMonth), sortedActivePrices.length);
      const competitivePrice = sortedActivePrices[demandPosition - 1] * 0.98;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏
      quickPrice = Math.min(quickPrice, competitivePrice);
    }
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ø–µ—Ä–µ–¥–∞–µ–º PPSM)
  const area = Number(objectData[4]) || 1;
  const quickPosition = calculateObjectPosition(quickPrice / area, activeCompetitors);
  const marketPosition = calculateObjectPosition(marketPrice / area, activeCompetitors);

  return {
    quickPrice: Math.round(quickPrice),
    marketPrice: Math.round(marketPrice),
    position: calculateObjectPosition(objectPrice / area, activeCompetitors),
    quickPosition,
    marketPosition,
    positionMultiplier
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ calculateObjectRank).
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞ –∑–∞ –º¬≤.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –ü–æ–∑–∏—Ü–∏—è (1 = —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π).
 */
function calculateObjectPosition(objectPricePerM2, activeCompetitors) {
  if (activeCompetitors.length === 0) return 1;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤ (–∏–Ω–¥–µ–∫—Å 6) –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–π
  const competitorPrices = activeCompetitors.map(c => Number(c[6]) || 0).filter(p => p > 0);
  
  const hasOurObject = competitorPrices.some(price => Math.abs(price - objectPricePerM2) < 10);
  
  const allPrices = hasOurObject 
    ? competitorPrices 
    : [...competitorPrices, objectPricePerM2];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
  allPrices.sort((a, b) => a - b);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é: —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å + 1
  const position = 1 + allPrices.filter(p => p < objectPricePerM2).length;
  
  return position;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤ –ø—Ä–æ–¥–∞–∂–∏.
 * @param {Object} forecasts –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeForecasts(forecasts, demandPerMonth, marketSituation, activeCount, soldCount, objectData, arrival, price, activePrices, pricePressure) {
  // –°–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: —è–Ω–≤–∞—Ä—å/–∞–≤–≥—É—Å—Ç –¥–æ–ª—å—à–µ, –≤–µ—Å–Ω–∞/–ª–µ—Ç–æ –±—ã—Å—Ç—Ä–µ–µ
  const currentMonth = new Date().getMonth() + 1;
  const seasonalCoef = SEASONAL_COEFFICIENTS[currentMonth] || 1.0;
  
  // –§–∞–∫—Ç–æ—Ä –∫–æ–º–Ω–∞—Ç–Ω–æ—Å—Ç–∏
  const rooms = objectData ? Number(objectData[3]) || 2 : 2;
  const roomsFactor = rooms <= 1 ? 1.07 : (rooms >= 3 ? 0.93 : 1.0);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏ —Å–ø—Ä–æ—Å–∞
  let quickMonths, marketMonths, currentMonths;
  
  if (demandPerMonth > 0) {
    // [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ B3] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –¥–ª—è —Ä—ã–Ω–æ—á–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    const marketRank = forecasts.marketPosition || forecasts.position || 1;
    const marketResult = calculateDynamicTimeOnMarket({
      rank: marketRank,
      demand: demandPerMonth,
      arrival: arrival || 0,
      price: price || 0,
      activePrices: activePrices || [],
      pricePressure: pricePressure
    });
    
    // [–ù–û–í–û–ï] –†–∞—Å—á—ë—Ç –¥–ª—è –¢–ï–ö–£–©–ï–ô –ø–æ–∑–∏—Ü–∏–∏ (—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ —Å–µ–π—á–∞—Å)
    const currentRank = forecasts.position || marketRank;
    const currentResult = calculateDynamicTimeOnMarket({
      rank: currentRank,
      demand: demandPerMonth,
      arrival: arrival || 0,
      price: price || 0,
      activePrices: activePrices || [],
      pricePressure: pricePressure
    });
    
    quickMonths = Math.round(marketResult.months * 0.5 * seasonalCoef * roomsFactor * 10) / 10;
    marketMonths = Math.round(marketResult.months * seasonalCoef * roomsFactor * 10) / 10;
    currentMonths = Math.round(currentResult.months * seasonalCoef * roomsFactor * 10) / 10;
    
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    quickMonths = Math.max(1, quickMonths);
    marketMonths = Math.max(quickMonths + 0.5, marketMonths);
    currentMonths = Math.max(1, currentMonths); // Ensure currentMonths is at least 1
  } else {
    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –ª–æ–≥–∏–∫—É
    const baseMonths = calculateAlternativeTime(activeCount, soldCount, marketSituation);
    quickMonths = Math.ceil(baseMonths * 0.7 * seasonalCoef * roomsFactor);
    marketMonths = Math.ceil(baseMonths * 1.0 * seasonalCoef * roomsFactor);
  }
  
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ - 1 –º–µ—Å—è—Ü, –º–∞–∫—Å–∏–º—É–º 24 –º–µ—Å—è—Ü–∞
  quickMonths = Math.max(1, Math.min(24, quickMonths));
  marketMonths = Math.max(1, Math.min(24, marketMonths));
  
  return {
    quickMonths,
    marketMonths,
    currentMonths,
    seasonalCoef,
    roomsFactor
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ë–∞–∑–æ–≤—ã–π —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 */
function calculateAlternativeTime(activeCount, soldCount, marketSituation) {
  if (marketSituation.type === 'NO_ACTIVE') {
    return 3; // –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'LOW_DEMAND') {
    return 12; // –ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å - –¥–æ–ª–≥–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'NO_DATA') {
    return 8; // –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å - —Å—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫
  }
  
  // –û–±—ã—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
  if (activeCount > 0) {
    return Math.max(2, Math.min(8, activeCount * 0.5)); // 0.5 –º–µ—Å—è—Ü–∞ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
  }
  
  return 6; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 */
function createCriteriaSheet() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–∏—Å—Ç
    let sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    
    if (!sheet) {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
      sheet = SPREADSHEET.insertSheet('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω');
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–†–∞–π–æ–Ω', ''],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ü–ª–æ—â–∞–¥—å', ''],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', ''],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', '']
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‚úÖ –õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
    Logger.log('–õ–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ createCriteriaSheet: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ' + e.message);
  }
}

/**
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–∞ –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 */
function writeCompetitorCriteria(objectData, criteria) {
  try {
    const sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (!sheet) {
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
      ['–†–∞–π–æ–Ω', objectData[1]],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', objectData[2]],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', objectData[3]],
      ['–ü–ª–æ—â–∞–¥—å', objectData[4]],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', objectData[6]],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', objectData[10]],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 0.8)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 1.2)],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear - 10],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear + 10],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', Math.max(0, criteria.rooms - 1)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', criteria.rooms + 1],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', new Date().toLocaleString('ru-RU')]
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    Logger.log('–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ª–∏—Å—Ç');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ writeCompetitorCriteria: ${e.stack}`);
  }
}

/**
 * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 */
function clearAnalysisData() {
  try {
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" (–æ—Ç—á–µ—Ç)
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (analyticsSheet) {
      analyticsSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    const analysisSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
    if (analysisSheet) {
      analysisSheet.getRange('A3:AQ1000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
    if (competitorsSheet) {
      // [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ]: –û—á–∏—â–∞–µ–º –¥–æ —Å—Ç–æ–ª–±—Ü–∞ M (13) –∏ —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏
      competitorsSheet.getRange('A2:M2000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"
    const criteriaSheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (criteriaSheet) {
      criteriaSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    Logger.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—á–∏—â–µ–Ω—ã');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞: ${e.stack}`);
  }
}

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —è—á–µ–π–∫–∏ B2 –≤ –ª–∏—Å—Ç–µ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É".
 * @param {Event} e –°–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
function onEditTrigger(e) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –Ω—É–∂–Ω–æ–º –ª–∏—Å—Ç–µ –∏ —è—á–µ–π–∫–µ
    if (e.range.getSheet().getName() === SHEETS.SINGLE_OBJECT_ANALYTICS && 
        e.range.getA1Notation() === 'B2') {
      
      const objectCode = e.value;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –Ω–µ –ø—É—Å—Ç–æ–π
      if (objectCode && String(objectCode).trim() !== '') {
        Logger.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analyzeSingleObjectByCode(String(objectCode).trim());
      } else {
        // –ï—Å–ª–∏ –∫–æ–¥ –ø—É—Å—Ç–æ–π –∏–ª–∏ —É–¥–∞–ª–µ–Ω - –æ—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        Logger.log('–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ —É–¥–∞–ª–µ–Ω, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞');
        clearAnalysisData();
      }
    }
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ onEditTrigger: ${error.stack}`);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram –±–æ—Ç–∞ (Webhook).
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function doPost(e) {
  try {
    return processBotRequest(e);
  } catch (error) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ doPost: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –±–æ—Ç–∞.
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function processBotRequest(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No data' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const contents = JSON.parse(e.postData.contents);
    const objectCode = contents.objectCode;
    
    if (!objectCode) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No object code' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç –±–æ—Ç–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞
    const analysisText = getAnalysisTextForBot(objectCode.toString().trim());
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: 'success', 
      text: analysisText 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ processBotRequest: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –±–æ—Ç–∞ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {string} –¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 */
function getAnalysisTextForBot(objectCode) {
  try {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      return `‚ùå –û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–¥–∞.`;
    }
    
    // 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData);
    if (competitorsData.activeCompetitors.length === 0 && competitorsData.soldCompetitors.length === 0) {
      return `‚ö†Ô∏è –î–ª—è –æ–±—ä–µ–∫—Ç–∞ ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –ê–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.`;
    }
    
    // 3. –ê–Ω–∞–ª–∏–∑ (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ª–∏—Å—Ç, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É)
    const advertisingData = getAdvertisingData(objectCode);
    const result = calculateSingleObjectMetrics(objectData, competitorsData.activeCompetitors, competitorsData.soldCompetitors, advertisingData);
    
    // 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ò–ò –æ—Ç—á–µ—Ç–∞)
    // –û–Ω–∞ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Gemini
    const reportText = createSingleObjectReportText(objectData, result, competitorsData);
    
    return reportText;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ getAnalysisTextForBot: ${e.stack}`);
    return `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ${e.message}`;
  }
}

// ================== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–¢–†–£–ö–¢–£–†–´ –¢–ê–ë–õ–ò–¶–´ ==================

/**
 * –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã.
 * –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–∞—Ö, –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∏ –ø—Ä–∏–º–µ—Ä–∞—Ö –¥–∞–Ω–Ω—ã—Ö.
 * –ó–∞–ø—É—Å–∫: –≤ Google Apps Script –≤—ã–±—Ä–∞—Ç—å diagnoseSpreadsheetStructure –∏ –Ω–∞–∂–∞—Ç—å –ó–∞–ø—É—Å–∫.
 */
function diagnoseSpreadsheetStructure() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–¢–†–£–ö–¢–£–†–´ –¢–ê–ë–õ–ò–¶–´: ' + ss.getName());
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–∞—Ç–∞: ' + new Date().toLocaleString('ru-RU'));
  Logger.log('–í—Å–µ–≥–æ –ª–∏—Å—Ç–æ–≤: ' + sheets.length);
  Logger.log('');
  
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–∏—Å—Ç—ã –≤ –≥—Ä—É–ø–ø–µ "3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ"
  const skipSheets = ['3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ'];
  
  sheets.forEach((sheet, index) => {
    const sheetName = sheet.getName();
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã
    if (skipSheets.some(skip => sheetName.includes(skip))) {
      Logger.log(`[${index + 1}] –ü–†–û–ü–£–°–ö: "${sheetName}"`);
      Logger.log('');
      return;
    }
    
    Logger.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    Logger.log(`[${index + 1}] –õ–ò–°–¢: "${sheetName}"`);
    Logger.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    
    Logger.log(`–†–∞–∑–º–µ—Ä: ${lastRow} —Å—Ç—Ä–æ–∫ x ${lastCol} —Å—Ç–æ–ª–±—Ü–æ–≤`);
    
    if (lastRow === 0 || lastCol === 0) {
      Logger.log('‚ö†Ô∏è –õ–∏—Å—Ç –ø—É—Å—Ç–æ–π');
      Logger.log('');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
    const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    Logger.log('');
    Logger.log('–ó–ê–ì–û–õ–û–í–ö–ò (—Å—Ç—Ä–æ–∫–∞ 1):');
    headers.forEach((header, colIndex) => {
      const colLetter = columnToLetter(colIndex + 1);
      Logger.log(`  [${colLetter}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
    });
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∞ 2, –µ—Å–ª–∏ –µ—Å—Ç—å)
    if (lastRow >= 2) {
      const exampleRow = sheet.getRange(2, 1, 1, lastCol).getValues()[0];
      Logger.log('');
      Logger.log('–ü–†–ò–ú–ï–† –î–ê–ù–ù–´–• (—Å—Ç—Ä–æ–∫–∞ 2):');
      exampleRow.forEach((value, colIndex) => {
        const colLetter = columnToLetter(colIndex + 1);
        const displayValue = String(value).substring(0, 50); // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        Logger.log(`  [${colLetter}]: "${displayValue}${String(value).length > 50 ? '...' : ''}"`);
      });
    }
    
    // –ò—â–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å —Å—Å—ã–ª–∫–∞–º–∏
    Logger.log('');
    Logger.log('–ê–ù–ê–õ–ò–ó –°–¢–û–õ–ë–¶–û–í:');
    headers.forEach((header, colIndex) => {
      const headerLower = String(header).toLowerCase();
      if (headerLower.includes('—Å—Å—ã–ª–∫') || headerLower.includes('link') || headerLower.includes('url')) {
        Logger.log(`  üìé –°–°–´–õ–ö–ê –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
      if (headerLower.includes('–∫–æ–¥') || headerLower.includes('code') || headerLower.includes('id')) {
        Logger.log(`  üîë –ö–û–î –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
      if (headerLower.includes('—Ä–∏—ç–ª—Ç–æ—Ä') || headerLower.includes('–∞–≥–µ–Ω—Ç') || headerLower.includes('–º–µ–Ω–µ–¥–∂–µ—Ä')) {
        Logger.log(`  üë§ –†–ò–≠–õ–¢–û–† –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
    });
    
    Logger.log('');
  });
  
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê');
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ –≤ –±—É–∫–≤—É (1 -> A, 2 -> B, ... 27 -> AA).
 */
function columnToLetter(column) {
  let letter = '';
  while (column > 0) {
    let temp = (column - 1) % 26;
    letter = String.fromCharCode(temp + 65) + letter;
    column = Math.floor((column - temp - 1) / 26);
  }
  return letter;
}