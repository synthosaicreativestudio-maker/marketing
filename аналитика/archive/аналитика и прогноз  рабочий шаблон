/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
 * –í–µ—Ä—Å–∏—è 3.0.8 (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeError: SpreadsheetApp.getSheetByName is not a function)
 *
 * –ò–∑–º–µ–Ω–µ–Ω–∏—è:
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName is not a function –≤ setAdditionalHeaders,
 *    –ø—É—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SPREADSHEET.getSheetByName() –≤–º–µ—Å—Ç–æ SpreadsheetApp.getSheetByName().
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ SyntaxError: Unexpected token ')' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ buildReportSummaries.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ 'SPREADSheetApp' –Ω–∞ 'SpreadsheetApp' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ setAdditionalHeaders.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ ReferenceError: allObjectsPlusAnalytics is not defined –≤ findCompetitorsForAllObjects
 *    –ø—É—Ç–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è dataMap –∏–∑ objectRow (—Å—Ç–æ–ª–±—Ü—ã A:O).
 *  - [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ª–∏—Å—Ç–∞ "3. 56. –∞–≤–∏—Ç–æ" –≤ —Å—Ç–æ–ª–±—Ü—ã P-Q –Ω–∞ –ª–∏—Å—Ç–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ".
 *  - [–õ–û–ì–ò–ö–ê] –ó–∞–º–µ–Ω–µ–Ω "–ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, %" –Ω–∞ "–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏" (A+, A, B, C, C-).
 *  - [–§–£–ù–ö–¶–ò–Ø] –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è getLiquidityType –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 *  - [–û–¢–ß–ï–¢] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–¢–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏".
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–¥–∞, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 *  - [–ê–†–•–ò–¢–ï–ö–¢–£–†–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –ª–∏–Ω–µ–π–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å–∞–º—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è.
 *  - [–õ–û–ì–ò–ö–ê] –£–ª—É—á—à–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø—É —Ä–µ–º–æ–Ω—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ formatCompetitorRow –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 */

// ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ==================

const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const IS_DEBUG = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

const STALE_LISTING_MONTHS = 6;
const TRIM_PERCENTAGE = 0.1;

const SHEETS = {
  MAIN_ANALYTICS: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ',
  COMPETITORS: '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  ADDRESS_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É',
  ACTIVE_GROUP: '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ',
  AVITO: '3. 56. –∞–≤–∏—Ç–æ', CIAN: '5. 56. —Ü–∏–∞–Ω', DOMCLICK: '6. 56. –¥–æ–º–∫–ª–∏–∫',
  ACTIVE_COMPETITORS: '2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ',
  SOLD_COMPETITORS: '1. 2. –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  // –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
  SINGLE_OBJECT_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É',
  SINGLE_OBJECT_ANALYSIS: '–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞',
  SINGLE_COMPETITORS: '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
};


// ================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==================

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Google –¢–∞–±–ª–∏—Ü –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
 */
function onOpen() { try { SpreadsheetApp.getUi().createMenu('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑')
    .addItem('‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏', 'startAllFunctions')
    .addItem('üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Å—Ç—ã', 'formatSheets')
    .addSeparator()
    .addItem('üîß –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã', 'setupNewSheets')
    .addItem('üìã –°–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤', 'createCriteriaSheet')
    .addSeparator()
    .addItem('üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á Gemini', 'setApiKey')
    .addItem('ü§ñ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å API –∫–ª—é—á –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏', 'setDefaultApiKey')
    .addItem('üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å API', 'showApiStatus')
    .addItem('‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/–ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã', 'installTriggers')
    .addToUi(); } catch (e) { Logger.log(`–û—à–∏–±–∫–∞ –≤ onOpen: ${e.stack}`); } }

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç startAllFunctions –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00 –∏ 14:00.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç onEditTrigger –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞.
 */
function installTriggers() { try {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 –∏ 14:00
    [6, 14].forEach(h => ScriptApp.newTrigger('startAllFunctions').timeBased().everyDays(1).atHour(h).nearMinute(0).inTimezone('Asia/Yekaterinburg').create());
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.newTrigger('onEditTrigger').forSpreadsheet(SPREADSHEET).onEdit().create();
    SpreadsheetApp.getUi().alert('–í—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
    Logger.log('–¢—Ä–∏–≥–≥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã/–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
} catch (e) { Logger.log(`–û—à–∏–±–∫–∞ –≤ installTriggers: ${e.stack}`); SpreadsheetApp.getUi().alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.'); } }

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞—é—â–∞—è –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
 * –û–°–¢–ê–í–õ–ï–ù–ê –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö.
 */
function startAllFunctions() {
  if (IS_DEBUG) Logger.log('–ó–∞–ø—É—Å–∫ startAllFunctions...');
  try {
    clearSheets(); // –û—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤
    copyFromActiveGroup(); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã
    copyFromSource(SHEETS.AVITO, 'P', ['–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ê–≤–∏—Ç–æ –≤ P-Q
    copyFromSource(SHEETS.CIAN, 'R', ['—Ü–∏–∞–Ω', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¶–∏–∞–Ω –≤ R-S
    copyFromSource(SHEETS.DOMCLICK, 'T', ['–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –î–æ–º–∫–ª–∏–∫ –≤ T-U
    setAdditionalHeaders(); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–Ω–∞—á–Ω–µ—Ç—Å—è —Å V)
    findCompetitorsForAllObjects(); // –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    if (IS_DEBUG) Logger.log('‚úÖ startAllFunctions —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.');
  } catch (e) { Logger.log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ startAllFunctions: ${e}\n${e.stack}`); setDashesOnError(); }
}

// ================== –§–£–ù–ö–¶–ò–ò –ü–û–î–ì–û–¢–û–í–ö–ò –î–ê–ù–ù–´–• ==================

/**
 * –û—á–∏—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤.
 */
function clearSheets() {
  const sheetsToClear = [ { name: SHEETS.MAIN_ANALYTICS, range: 'A6:AZ' }, { name: SHEETS.COMPETITORS, range: 'A2:N' }];
  sheetsToClear.forEach(s => { const sh = SPREADSHEET.getSheetByName(s.name); if (sh) sh.getRange(s.range).clearContent(); });
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A2').setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞'); 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–∞ '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ' –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 */
function copyFromActiveGroup() {
    const sourceSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_GROUP); 
    const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sourceSheet || !targetSheet) return;
    
    const sourceRange = sourceSheet.getRange('A2:O' + sourceSheet.getLastRow()); 
    if (sourceRange.isBlank()) return;
    
    const sourceData = sourceRange.getValues();
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π "–ò—Ç–æ–≥–æ"
    const dataToCopy = sourceData.filter(row => row.some(cell => cell.toString().trim() !== '') && String(row[0]).toLowerCase().trim() !== '–∏—Ç–æ–≥–æ');
    
    if (dataToCopy.length === 0) { 
      if(targetSheet.getMaxRows() >= 6) targetSheet.getRange('A6:O6').setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
      return; 
    }
    
    const headers = [ ['‚Ññ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–ö–æ–¥', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç'] ];
    targetSheet.getRange('A5:O5').setValues(headers); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    targetSheet.getRange(6, 1, dataToCopy.length, dataToCopy[0].length).setValues(dataToCopy); // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ê–≤–∏—Ç–æ, –¶–∏–∞–Ω, –î–æ–º–∫–ª–∏–∫)
 * –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 * @param {string} sourceSheetName –ò–º—è –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞.
 * @param {string} startColumn –ë—É–∫–≤–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {string[]} headers –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤.
 */
function copyFromSource(sourceSheetName, startColumn, headers) {
  const sourceSheet = SPREADSHEET.getSheetByName(sourceSheetName);
  const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const endColumn = String.fromCharCode(startColumn.charCodeAt(0) + 1); // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, V -> W)
  
  if (!sourceSheet || !targetSheet) return;
  
  targetSheet.getRange(`${startColumn}5:${endColumn}5`).setValues([headers]); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  
  const lastSourceRow = sourceSheet.getLastRow();
  const lastTargetRow = targetSheet.getLastRow();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  if (lastSourceRow < 2 || lastTargetRow < 6) return;
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ: –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞, –¶–µ–Ω–∞, –¶–µ–Ω–∞ –∑–∞ –º¬≤ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –æ–Ω–∏ –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö B, C, D)
  const sourceData = sourceSheet.getRange('B2:D' + lastSourceRow).getValues();
  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥—ã –æ–±—ä–µ–∫—Ç–æ–≤ —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  const targetCodes = targetSheet.getRange('F6:F' + lastTargetRow).getValues().flat();
  
  // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞
  const sourceMap = new Map(sourceData.map(row => [String(row[0]).trim(), [row[1] || '-', row[2] || '-']]));
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—è –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞
  const outputData = targetCodes.map(code => sourceMap.get(String(code).trim()) || ['-', '-']);
  
  // –í—Å—Ç–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  if (outputData.length > 0) {
    targetSheet.getRange(6, startColumn.charCodeAt(0) - 64, outputData.length, 2).setValues(outputData); // startColumn.charCodeAt(0) - 64 –¥–∞–µ—Ç –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ (A=1, B=2...)
  }
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ.
 */
function setAdditionalHeaders() {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName –Ω–∞ SPREADSHEET.getSheetByName
    const sheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sheet) return;
    
    const headers = [[
        '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', 
        '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞', '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.'
    ]];
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Å—Ç–æ–ª–±—Ü–∞ V, –ø–æ—Å–ª–µ P-Q (Avito), R-S (Cian), T-U (Domclick)
    sheet.getRange('V5:AQ5').setValues(headers); 
}

// ================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
 * –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 */
function findCompetitorsForAllObjects() {
  if (IS_DEBUG) Logger.log('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è findCompetitorsForAllObjects...');
  
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  
  if (!analyticsSheet || !activeSheet || !soldSheet || !competitorsSheet) { 
    setDashesOnError(); // –ï—Å–ª–∏ –ª–∏—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ
    return; 
  }
  
  const lastRow = analyticsSheet.getLastRow();
  if (lastRow < 6) return; // –ï—Å–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü—ã A:O)
  const objectsData = analyticsSheet.getRange('A6:O' + lastRow).getValues();
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const activeData = activeSheet.getRange('A2:M' + activeSheet.getLastRow()).getValues();
  const soldData = soldSheet.getRange('A2:N' + soldSheet.getLastRow()).getValues();

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–∏–∑ —è—á–µ–µ–∫ C1 –∏ C2 –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞)
  const startDate = new Date(analyticsSheet.getRange('C1').getValue() || '2024-01-01'); 
  const endDate = new Date(analyticsSheet.getRange('C2').getValue() || new Date());
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
  const months = Math.max(1, (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30.4375));
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ä–∞–π–æ–Ω–∞–º
  const activeByDistrict = groupDataByDistrict(activeData);
  const soldByDistrict = groupDataByDistrict(soldData);
  
  const districtCache = {}; // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º
  
  let analyticsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Å—Ç–∞
  let competitorsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const competitorHeaders = ['–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ A:O –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è dataMap
  const objectHeaders = analyticsSheet.getRange('A5:O5').getValues()[0];

  // –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  objectsData.forEach((objectRow, index) => {
    try {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
      const district = objectRow[1], type = objectRow[2], rooms = Number(objectRow[3]), area = Number(objectRow[4]), code = String(objectRow[5]), price = Number(objectRow[7]);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!district || !code || !area || area <= 0 || !price || price <= 0) { 
        analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
        return; 
      }
      
      const repair = objectRow[6], buildYear = Number(objectRow[10]) || null;
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω—É –µ—â–µ –Ω–µ—Ç –≤ –∫—ç—à–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
      if (!districtCache[district]) {
        districtCache[district] = processDistrictData({ 
          type, rooms, area, repair, buildYear, 
          activeCandidates: activeByDistrict[district] || [], 
          soldCandidates: soldByDistrict[district] || [], 
          startDate, endDate, months 
        });
      }
      const cache = districtCache[district]; // –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–π–æ–Ω—É

      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º dataMap –∏–∑ objectRow (A:O) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
      // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ReferenceError, —Ç–∞–∫ –∫–∞–∫ allObjectsPlusAnalytics –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å.
      const dataMap = {};
      objectHeaders.forEach((h, i) => dataMap[h] = objectRow[i]);

      // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –æ–±—ä–µ–∫—Ç–∞
      const metrics = calculateObjectMetrics({ price, activeCompetitors: cache.activeCompetitors, avgActivePriceTrimmed: cache.avgActivePriceTrimmed, avgSoldPriceMedian: cache.avgSoldPriceMedian });
      // –†–∞—Å—á–µ—Ç —Ü–µ–Ω–æ–≤–æ–π –≤–∏–ª–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
      const priceFork = calculatePriceFork({ price, objectData: objectRow, activePrices: cache.activePrices, avgSalesPerMonth: cache.avgSalesPerMonth, avgSoldPriceMedian: cache.avgSoldPriceMedian, dataMap: dataMap });
      const timeOnMarketForecasts = calculateTimeOnMarket({ soldCompetitors: cache.soldCompetitors, avgPrice: cache.avgSoldPriceMedian, rank: metrics.rankByPrice, avgSalesPerMonth: cache.avgSalesPerMonth });

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
      analyticsOutput.push([
        cache.activeCompetitors.length, 
        cache.soldCompetitors.length, 
        cache.avgSalesPerMonth, 
        cache.avgNewObjectsPerMonth, // –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
        determineLiquidityType(cache.activeCompetitors.length, cache.soldCompetitors.length, cache.avgSalesPerMonth), // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
        getMarketAssessment(cache.liquidityIndex, cache.avgSalesPerMonth), // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å
        cache.competitionTrend,
        metrics.rankByPrice, cache.priceTrendPerMonth, metrics.activeRatioPercent, metrics.soldRatioPercent,
        cache.avgActivePriceTrimmed, price, metrics.priceDiffPercentActive,
        cache.avgSoldPriceMedian, price, metrics.priceDiffPercentSold,
        priceFork.aggressive, timeOnMarketForecasts.fast, priceFork.market, timeOnMarketForecasts.market
      ]);

      // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–∏—Å—Ç–∞ "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∫–∞–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
      const ourObjectAsCompetitor = [
          district, type, rooms, area, price, Math.floor(price/area), // –†–∞–π–æ–Ω, –¢–∏–ø, –ö–æ–º–Ω–∞—Ç—ã, –ü–ª–æ—â–∞–¥—å, –¶–µ–Ω–∞, –¶–µ–Ω–∞ –∑–∞ –º¬≤ (price/area)
          '-', // –°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π (placeholder)
          objectRow[14], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç–æ–ª–±–µ—Ü O)
          repair, // –†–µ–º–æ–Ω—Ç
          '–ù–∞—à –æ–±—ä–µ–∫—Ç', // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞ (placeholder)
          `${objectRow[8]}/${objectRow[9]}`, // –≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å
          buildYear // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
      ];
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞—à –æ–±—ä–µ–∫—Ç) –ø–æ —Ü–µ–Ω–µ
      const activeSorted = [...cache.activeCompetitors, ourObjectAsCompetitor].sort((a, b) => (a[4] || Infinity) - (b[4] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ –æ–±—â–∏–π –≤—ã–≤–æ–¥
      competitorsOutput.push([`–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...activeSorted, []);
      
      const soldSorted = [...cache.soldCompetitors].sort((a, b) => (a[4] || Infinity) - (b[4] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if(soldSorted.length > 0) competitorsOutput.push([`–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...soldSorted, []);
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
      competitorsOutput.push([]);

    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ ${index + 6}: ${e.stack}`);
      analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    }
  });

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  if (analyticsOutput.length > 0) {
    analyticsSheet.getRange(6, 22, analyticsOutput.length, 22).setValues(analyticsOutput);
  }
  
  // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (competitorsOutput.length > 0) {
    competitorsSheet.getRange('A2:N' + competitorsSheet.getMaxRows()).clearContent();
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (—É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç 12 —Å—Ç–æ–ª–±—Ü–æ–≤)
    const formattedCompetitors = formatForBatchWrite(competitorsOutput, 12);
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç
    competitorsSheet.getRange(2, 1, formattedCompetitors.length, formattedCompetitors[0].length).setValues(formattedCompetitors);
  }
}

// ================== –£–õ–£–ß–®–ï–ù–ù–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –≤ —Å—Ç–æ–ª–±—Ü–µ —Ä–∞–π–æ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 1).
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object<string, Array<Array<any>>>} –û–±—ä–µ–∫—Ç —Å –≥—Ä—É–ø–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º.
 */
function groupDataByDistrict(data) { 
  const grouped = {}; 
  data.forEach(row => { 
    const district = row[1] || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; // –ë–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –≤—Ç–æ—Ä–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–∏–Ω–¥–µ–∫—Å 1)
    if (!grouped[district]) grouped[district] = []; 
    grouped[district].push(row); 
  }); 
  return grouped; 
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function processDistrictData(params) {
    const { type, rooms, area, repair, buildYear, activeCandidates, soldCandidates, startDate, endDate, months } = params;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏"
    const staleDate = new Date(endDate.getTime() - STALE_LISTING_MONTHS * 30.4375 * 24 * 60 * 60 * 1000).getTime();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ (—Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ)
    const freshActiveCandidates = activeCandidates.filter(row => { 
        try { return new Date(row[0]).getTime() >= staleDate; } catch(e) { return false; }
    });
    
    // --- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–º–æ–Ω—Ç—É ---
    const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
    const objectRepairLower = repair ? repair.toLowerCase() : '';
    const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Ç–∏–ø, –∫–æ–º–Ω–∞—Ç—ã, –ø–ª–æ—â–∞–¥—å, –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏, —Ä–µ–º–æ–Ω—Ç)
    const processedActiveCandidates = freshActiveCandidates.filter(row => {
        try {
            const rowDate = new Date(row[0]).getTime();
            const rowBuildYear = Number(row[10]) || null;
            const rowRooms = Number(row[3]);
            const rowArea = Number(row[4]);
            const competitorRepair = row[6]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü 6 - —ç—Ç–æ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (row[2] !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
    const processedSoldCandidates = soldCandidates.filter(row => {
        try {
            const rowDate = new Date(row[0]).getTime(); // –î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            const rowBuildYear = Number(row[10]) || null;
            const rowRooms = Number(row[3]);
            const rowArea = Number(row[4]);
            const competitorRepair = row[6]; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü 6 - —ç—Ç–æ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (row[2] !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    const activeCompetitors = processedActiveCandidates.map(row => formatCompetitorRow(row, false));
    const soldCompetitors = processedSoldCandidates.map(row => formatCompetitorRow(row, true));

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ —Ü–µ–Ω –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–∏—Ö
    const activePrices = activeCompetitors.map(c => c[4]).filter(p => p > 0); // –¶–µ–Ω–∞
    const soldPrices = soldCompetitors.map(c => c[4]).filter(p => p > 0); // –¶–µ–Ω–∞

    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
    const avgSalesPerMonth = soldCompetitors.length > 0 ? parseFloat((soldCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–±—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
    const avgNewObjectsPerMonth = activeCompetitors.length > 0 ? parseFloat((activeCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (—á–∏—Å–ª–æ–≤–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è getLiquidityType –∏ getMarketAssessment)
    let liquidityIndex = 0;
    if (activeCompetitors.length > 0 && avgSalesPerMonth > 0) {
        liquidityIndex = Math.round((avgSalesPerMonth / activeCompetitors.length) * 100);
    }
    
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ —Ü–µ–Ω—ã –∑–∞ –º¬≤ (–¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏ –∏ —Ü–µ–Ω–∞ –∑–∞ –º¬≤)
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[5] - —Ü–µ–Ω–∞ –∑–∞ –º¬≤
    const priceTrendData = soldCompetitors.map(c => [ new Date(c[0]).getTime() / (1000*60*60*24), c[5] ]).filter(p => p[0] && p[1]);
    const trend = calculateLinearRegression(priceTrendData); // –†–∞—Å—á–µ—Ç –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    const priceTrendPerMonth = trend ? Math.round(trend.slope * 30.4375) : 0; // –ü–µ—Ä–µ—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –º–µ—Å—è—Ü
    
    // –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
    const competitionTrend = calculateCompetitionTrend(freshActiveCandidates, startDate, endDate); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ–∂–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    return { 
        activeCompetitors, 
        soldCompetitors, 
        activePrices, 
        competitionTrend, 
        avgActivePriceTrimmed: calculateTrimmedMean(activePrices, TRIM_PERCENTAGE), // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º
        avgSoldPriceMedian: calculateMedian(soldPrices), // –ú–µ–¥–∏–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
        avgSalesPerMonth, 
        liquidityIndex: liquidityIndex, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å 0)
        priceTrendPerMonth: priceTrendPerMonth || '-', // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –∏–ª–∏ —Ç–∏—Ä–µ
        avgNewObjectsPerMonth // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É –ø—Ä–∏–±—ã—Ç–∏—è
    };
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è filterCompetitors, —Ç.–∫. –µ–µ –ª–æ–≥–∏–∫–∞ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ processDistrictData

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º.
 * @param {Array<any>} row –°—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞.
 * @param {boolean} isSold –§–ª–∞–≥, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã–º.
 * @returns {Array<any>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatCompetitorRow(row, isSold) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –∏ –ø–ª–æ—â–∞–¥—å
    const price = Number(row[7]) || 0; // –¶–µ–Ω–∞ (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 7)
    const area = Number(row[4]) || 0; // –ü–ª–æ—â–∞–¥—å (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 4)
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤
    const pricePerM2 = area > 0 ? Math.floor(price / area) : 0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º price/area –∫–∞–∫ –≤ ourObjectAsCompetitor

    let timeOnMarket = '-';
    if(isSold) {
        try {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –≤ –¥–Ω—è—Ö
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[12] - –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö)
            const saleDate = new Date(row[0]), pubDate = new Date(row[12]);
            if(!isNaN(saleDate.getTime()) && !isNaN(pubDate.getTime())){
                timeOnMarket = Math.round((saleDate - pubDate) / (1000 * 60 * 60 * 24));
            }
        } catch(e) { timeOnMarket = '-'; } // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏—Ä–µ
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏ —Ä–µ–º–æ–Ω—Ç, —É—á–∏—Ç—ã–≤–∞—è, –ø—Ä–æ–¥–∞–Ω–æ –ª–∏ –æ–±—ä–µ–∫—Ç
    const link = row[isSold ? 12 : 11] || '-'; // –°—Å—ã–ª–∫–∞: —Å—Ç–æ–ª–±–µ—Ü 11 –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö, 12 –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
    const repair = row[6] || '-'; // –†–µ–º–æ–Ω—Ç: –æ–±—â–∏–π —Å—Ç–æ–ª–±–µ—Ü 6
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞: —Å–ø–µ–∫—É–ª—è—Ç–∏–≤–Ω–æ, –±–µ—Ä–µ–º —Å—Ç–æ–ª–±–µ—Ü 12 –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö, 13 –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
    const houseCondition = row[isSold ? 13 : 12] || '-'; 

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–∫–∞–º (13 —Å—Ç–æ–ª–±—Ü–æ–≤)
    return [
        row[5] || '-', // '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞' (—Å—Ç–æ–ª–±–µ—Ü F)
        row[1], // '–†–∞–π–æ–Ω'
        row[2], // '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞'
        Number(row[3]), // '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç'
        area, // '–ü–ª–æ—â–∞–¥—å'
        price, // '–¶–µ–Ω–∞'
        pricePerM2, // '–¶–µ–Ω–∞ –∑–∞ –º¬≤'
        timeOnMarket, // '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π'
        link, // '–°—Å—ã–ª–∫–∞'
        repair, // '–†–µ–º–æ–Ω—Ç'
        houseCondition, // '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞'
        `${row[8]}/${row[9]}`, // '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å' (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã 8 –∏ 9)
        Number(row[10]) || '-' // '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏' (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 10)
    ];
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function calculateObjectMetrics(params) {
    const { price, activeCompetitors, avgActivePriceTrimmed, avgSoldPriceMedian } = params;
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å —Ü–µ–Ω–æ–π —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    const allActivePrices = [...activeCompetitors.map(c => c[4]), price].filter(p => p > 0).sort((a, b) => a - b);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const rankByPrice = 1 + allActivePrices.filter(p => p < price).length;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
    const formatRatio = (ratio) => `${ratio > 0 ? '+' : ''}${ratio.toFixed(1)}%`;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ–±—ä–µ–∫—Ç–∞ –∫ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeRatioPercent = avgActivePriceTrimmed > 0 ? formatRatio(((price / avgActivePriceTrimmed - 1) * 100)) : '-';
    const soldRatioPercent = avgSoldPriceMedian > 0 ? formatRatio(((price / avgSoldPriceMedian - 1) * 100)) : '-';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω
    const priceDiffPercentActive = (avgActivePriceTrimmed > 0) ? `${Math.round((price - avgActivePriceTrimmed) / avgActivePriceTrimmed * 100)}%` : '-';
    const priceDiffPercentSold = (avgSoldPriceMedian > 0) ? `${Math.round((price - avgSoldPriceMedian) / avgSoldPriceMedian * 100)}%` : '-';
    
    return { rankByPrice: rankByPrice || '-', activeRatioPercent, soldRatioPercent, priceDiffPercentActive, priceDiffPercentSold };
}

/**
 * –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeOnMarket(params) {
    const { soldCompetitors, avgPrice, rank, avgSalesPerMonth } = params;
    const defaultResult = { fast: '-', market: '-', optimistic: '-' }; // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const toMonths = (days) => (days / 30.4375).toFixed(1); // –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü—ã

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –∏ —Ü–µ–Ω—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const timeOnMarketData = soldCompetitors.map(c => ({tom: c[6], price: c[4]})).filter(c => typeof c.tom === 'number' && c.tom >= 0);
    
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—é
    if(timeOnMarketData.length < 2 || !avgPrice) {
      if (avgSalesPerMonth > 0 && rank > 0) {
        // –ê–ø–ø—Ä–æ–∫—Å–∏–º–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–Ω–≥–∞ –∏ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
        const baseTerm = rank / avgSalesPerMonth;
        return { fast: (baseTerm * 0.7).toFixed(1), market: baseTerm.toFixed(1), optimistic: (baseTerm * 1.5).toFixed(1) };
      }
      return defaultResult; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    }
    
    // –°–µ–≥–º–µ–Ω—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ–Ω–æ–≤—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–¥–µ—à–µ–≤—ã–µ, —Ä—ã–Ω–æ—á–Ω—ã–µ, –¥–æ—Ä–æ–≥–∏–µ)
    const cheap = [], market = [], expensive = [];
    timeOnMarketData.forEach(c => { 
        if (c.price < avgPrice * 0.9) cheap.push(c.tom); // –î–µ—à–µ–≤–ª–µ 90% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
        else if (c.price > avgPrice * 1.1) expensive.push(c.tom); // –î–æ—Ä–æ–∂–µ 110% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã
        else market.push(c.tom); // –í –ø—Ä–µ–¥–µ–ª–∞—Ö 90-110%
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –º–µ–¥–∏–∞–Ω–Ω–æ–≥–æ —Å—Ä–æ–∫–∞ –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞
    const getMedianTom = (segment) => segment.length > 0 ? toMonths(calculateMedian(segment)) : null;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –º–µ–¥–∏–∞–Ω–Ω—ã–µ —Å—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
    let fastTom = getMedianTom(cheap), marketTom = getMedianTom(market), optimisticTom = getMedianTom(expensive);
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ—Ç–¥–∞–≤–∞—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º —Å–µ–≥–º–µ–Ω—Ç–∞–º
    return { 
        fast: fastTom || marketTom || optimisticTom || '-', 
        market: marketTom || optimisticTom || fastTom || '-', 
        optimistic: optimisticTom || marketTom || fastTom || '-' 
    };
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω–æ–≤—É—é –≤–∏–ª–∫—É (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é, —Ä—ã–Ω–æ—á–Ω—É—é, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é) –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏.
 */
function calculatePriceFork(params) {
    const { price, objectData, activePrices, avgSalesPerMonth, avgSoldPriceMedian, dataMap } = params;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
    const qualityScore = calculateQualityScore(dataMap);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–Ω–æ—á–Ω—É—é —Ü–µ–Ω—É: –º–µ–¥–∏–∞–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    let marketPrice = avgSoldPriceMedian > 0 ? avgSoldPriceMedian : calculateTrimmedMean(activePrices, TRIM_PERCENTAGE);
    marketPrice = marketPrice > 0 ? marketPrice : Math.floor(price * 0.95); // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –±–µ—Ä–µ–º 95% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    marketPrice = Math.floor(marketPrice * qualityScore); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é —Ü–µ–Ω—É
    let aggressivePrice = 0;
    if(activePrices.length > 0 && avgSalesPerMonth > 0) { 
        const sortedPrices = [...activePrices].sort((a,b)=>a-b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
        // –ë–µ—Ä–µ–º —Ü–µ–Ω—É, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ä–µ–¥–Ω–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
        const targetIndex = Math.min(Math.floor(avgSalesPerMonth)-1, sortedPrices.length - 1); 
        if(targetIndex >= 0) aggressivePrice = sortedPrices[targetIndex]; 
    }
    aggressivePrice = aggressivePrice > 0 ? aggressivePrice : Math.floor(price * 0.9); // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –±–µ—Ä–µ–º 90% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    aggressivePrice = Math.floor(aggressivePrice * qualityScore * 0.97); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é —Ü–µ–Ω—É
    const trimmedAvgActive = calculateTrimmedMean(activePrices, TRIM_PERCENTAGE); 
    let optimisticPrice = trimmedAvgActive > 0 ? trimmedAvgActive : marketPrice * 1.05; // –ë–µ—Ä–µ–º —Å—Ä–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ 105% –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π
    optimisticPrice = Math.floor(optimisticPrice * qualityScore * 1.03); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å

    // –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ 100 000, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è <= —Ä—ã–Ω–æ—á–Ω–∞—è, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è >= —Ä—ã–Ω–æ—á–Ω–∞—è
    const finalMarketPrice = Math.max(100000, marketPrice);
    const finalAggressivePrice = Math.min(finalMarketPrice, Math.max(100000, aggressivePrice));
    const finalOptimisticPrice = Math.max(finalMarketPrice, Math.max(100000, optimisticPrice));
    
    return { aggressive: finalAggressivePrice, market: finalMarketPrice, optimistic: finalOptimisticPrice };
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.
 * @param {Object} dataMap –ö–∞—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞.
 * @returns {number} –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ (–æ—Ç 0.75 –¥–æ 1.15).
 */
function calculateQualityScore(dataMap) {
    let score = 1.0; // –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
    try {
        const repair = dataMap['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞'] || '';
        const buildYear = Number(dataMap['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏']);
        const floor = Number(dataMap['–≠—Ç–∞–∂']);
        const totalFloors = Number(dataMap['–≠—Ç–∞–∂–Ω–æ—Å—Ç—å']);

        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞
        if (repair.includes('–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π') || repair.includes('–ï–≤—Ä–æ') || repair.includes('–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π')) score += 0.10; 
        if (repair.includes('–¢—Ä–µ–±—É–µ—Ç') || repair.includes('–°—Ç–∞—Ä—ã–π')) score -= 0.15;
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
        if (buildYear > new Date().getFullYear() - 5) score += 0.05; // –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞
        if (buildYear < 1980) score -= 0.05; // –°—Ç–∞—Ä—ã–π —Ñ–æ–Ω–¥
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ü–µ–Ω–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–∂–∞
        if (floor === 1) score -= 0.05; // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂
        if (totalFloors > 2 && floor === totalFloors) score -= 0.03; // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂ (–µ—Å–ª–∏ –¥–æ–º –Ω–µ –º–Ω–æ–≥–æ—ç—Ç–∞–∂–Ω—ã–π)
    } catch(e) {/* –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∫–∞–∫–∏–µ-—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç */}
    return score;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ —Å–ø—Ä–æ—Å–∞.
 * @param {number|string} liquidityIndex –ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} avgSalesPerMonth –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä—ã–Ω–∫–∞.
 */
function getMarketAssessment(liquidityIndex, avgSalesPerMonth) {
  if (typeof liquidityIndex !== 'number') return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –Ω–µ —á–∏—Å–ª–æ
  if (liquidityIndex > 25 && avgSalesPerMonth > 3) return '–ì–æ—Ä—è—á–∏–π —Ä—ã–Ω–æ–∫ (–≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å)'; // –í—ã—Å–æ–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ —Å–ø—Ä–æ—Å
  if (liquidityIndex >= 15 && avgSalesPerMonth > 1.5) return '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫'; // –°—Ä–µ–¥–Ω—è—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏ —Å–ø—Ä–æ—Å
  return '–•–æ–ª–æ–¥–Ω—ã–π —Ä—ã–Ω–æ–∫ (–Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å)'; // –ù–∏–∑–∫–∞—è –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –∏–ª–∏ —Å–ø—Ä–æ—Å
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Array<Array<any>>} candidates –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
 * @param {Date} startDate –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Date} endDate –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @returns {string} –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
 */
function calculateCompetitionTrend(candidates, startDate, endDate) {
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2); // –°–µ—Ä–µ–¥–∏–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = candidates.filter(r => new Date(r[0]) < midPoint).length;
  const secondHalfCount = candidates.filter(r => new Date(r[0]) >= midPoint).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return '+100% (—Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç)'; // –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –Ω–µ –±—ã–ª–æ, –∞ –≤–æ –≤—Ç–æ—Ä–æ–π –µ—Å—Ç—å
  if (firstHalfCount === 0 || secondHalfCount === 0) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–π –∏–∑ –ø–æ–ª–æ–≤–∏–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  
  const trend = ((secondHalfCount / firstHalfCount) - 1) * 100; // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  
  if (Math.abs(trend) < 10) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 10%
  return `${trend > 0 ? '—Ä–æ—Å—Ç' : '—Å–Ω–∏–∂–µ–Ω–∏–µ'} –Ω–∞ ${Math.abs(trend.toFixed(0))}%`; // –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞
}



// ================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° GEMINI –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê ==================

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ó–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –ª–∏—Å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∞–¥—Ä–µ—Å–æ–≤.
 * @param {GoogleAppsScript.Events.SheetsOnEdit} e –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */




/**
 * –í—ã–∑—ã–≤–∞–µ—Ç Google Gemini API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
 * @param {string} prompt –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini.
 * @param {string} summaryText –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ.
 * @returns {string} –û—Ç–≤–µ—Ç –æ—Ç Gemini –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function callGemini(prompt, summaryText) {
  const apiKey = getGeminiApiKey(); 
  if (!apiKey) return 'API-–∫–ª—é—á Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –º–µ–Ω—é.';
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å gemini-3-pro-preview –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const model = 'gemini-3-pro-preview'; 
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  
  const fullPrompt = `${prompt}\n\n–í–æ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ:\n${summaryText}\n\nSystem Instruction: –¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –¥–µ–ª–æ–≤–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. –ü–µ—Ä–µ–ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤ –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ —Ü–∏—Ñ—Ä—ã –∏ —Å—É—Ç—å.`;
  
  const payload = {
    "contents": [{
      "parts": [{
        "text": fullPrompt
      }]
    }],
    "generationConfig": {
      "temperature": 0.7,
      "maxOutputTokens": 8192,
      "topP": 0.8
    },
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ]
  };
  
  const options = { 
    method: 'post', 
    contentType: 'application/json', 
    payload: JSON.stringify(payload), 
    muteHttpExceptions: true 
  };
  
  const maxRetries = 3;
  const baseDelay = 1000;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = UrlFetchApp.fetch(url, options);
      const responseText = response.getContentText();
      Logger.log(`Gemini Raw Response (Attempt ${attempt}): ${responseText}`); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç
      
      const json = JSON.parse(responseText);
      
      if (json.error) {
        Logger.log(`–û—à–∏–±–∫–∞ API Gemini (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}): ${json.error.message}`);
        if (attempt < maxRetries) {
          Utilities.sleep(baseDelay * Math.pow(2, attempt - 1));
          continue;
        }
        return `‚ùå –û—à–∏–±–∫–∞ API Gemini: ${json.error.message}`;
      }
      
      if (json.candidates && json.candidates[0] && json.candidates[0].content && json.candidates[0].content.parts && json.candidates[0].content.parts[0].text) {
        return cleanText(json.candidates[0].content.parts[0].text);
      }
      
      return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç Gemini (–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ('Gemini Raw Response').";
      
      return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—Ç Gemini (–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç).";
      
    } catch (e) {
      Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ callGemini: ${e.stack}`);
      if (attempt < maxRetries) {
        Utilities.sleep(baseDelay * Math.pow(2, attempt - 1));
        continue;
      }
      return '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini.';
    }
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç API-–∫–ª—é—á Gemini –∏–∑ —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞.
 * @returns {string} API-–∫–ª—é—á.
 */
function getGeminiApiKey() {
  return PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY') || PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY'); // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞
}

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å API Gemini –≤ –¥–∏–∞–ª–æ–≥–æ–≤–æ–º –æ–∫–Ω–µ.
 */
function showApiStatus() {
  const ui = SpreadsheetApp.getUi();
  const apiKey = getGeminiApiKey();
  if (!apiKey) {
    ui.alert('–°—Ç–∞—Ç—É—Å API', '–ö–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', ui.ButtonSet.OK);
    return;
  }
  ui.alert('–°—Ç–∞—Ç—É—Å API', '–ö–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞)', ui.ButtonSet.OK);
}

/**
 * –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, markdown, –≤–µ–¥—É—â–∏–µ —Ü–∏—Ñ—Ä—ã/—Ç–∏—Ä–µ).
 * @param {string} text –¢–µ–∫—Å—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {string} –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
 */
function cleanText(text) { 
  // –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –≤–µ–¥—É—â–∏–µ —Å–∏–º–≤–æ–ª—ã markdown, –ø—Ä–æ–±–µ–ª—ã, —Ü–∏—Ñ—Ä—ã –∏ —Ç–æ—á–∫–∏
  return text.replace(/^[#*-\s\d\.]+/gm, '').replace(/\*{1,2}(.*?)\*{1,2}/g, '$1'); // –£–¥–∞–ª—è–µ–º markdown * –∏ **
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è API-–∫–ª—é—á Gemini –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ.
 */
function setApiKey() { 
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ API-–∫–ª—é—á–∞ Gemini', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à API-–∫–ª—é—á Google Gemini:', ui.ButtonSet.OK_CANCEL);
  
  if (response.getSelectedButton() == ui.Button.OK) { // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª OK
    const apiKey = response.getResponseText().trim();
    if (apiKey && apiKey.length > 10) { // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–ª—é—á–∞
      PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEY', apiKey); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á
      ui.alert('API-–∫–ª—é—á Gemini —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
    } else { 
      ui.alert('–û—à–∏–±–∫–∞', '–ö–ª—é—á –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.', ui.ButtonSet.OK); 
    } 
  } 
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π API-–∫–ª—é—á Gemini.
 */
function setDefaultApiKey() {
  try {
    const defaultApiKey = 'YOUR_OPENAI_API_KEY_HERE'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à API –∫–ª—é—á OpenAI
    PropertiesService.getScriptProperties().setProperty('OPENAI_API_KEY', defaultApiKey);
    SpreadsheetApp.getUi().alert('‚úÖ API-–∫–ª—é—á OpenAI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!');
    Logger.log('API-–∫–ª—é—á OpenAI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏');
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ API-–∫–ª—é—á–∞: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ API-–∫–ª—é—á–∞: ' + e.message);
  } 
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π API-–∫–ª—é—á Gemini.
 * @returns {string|null} API-–∫–ª—é—á –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
 */
function getOpenAIApiKey() { 
  return PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY'); 
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∏—Ä–µ ('-') –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.
 */
function setDashesOnError() { 
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  if (analyticsSheet && analyticsSheet.getLastRow() >= 6) analyticsSheet.getRange('A6:AQ' + analyticsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  if (competitorsSheet && competitorsSheet.getLastRow() >= 2) competitorsSheet.getRange('A2:M' + competitorsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    addressSheet.getRange('A4').setValue('–ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê'); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  } 
}

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –ª–∏—Å—Ç—É —Å –æ—Ç—á–µ—Ç–æ–º.
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet –õ–∏—Å—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–±—â–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ä–∞–±–æ—á–∏–º –ª–∏—Å—Ç–∞–º.
 */
function formatSheets() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS); 
    if (analyticsSheet) { 
        analyticsSheet.getRange('A6:AQ1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        analyticsSheet.getRange('V6:AQ1000').setHorizontalAlignment('center'); // –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        analyticsSheet.getRange('A5:AQ5').setBackground('#D3D3D3').setFontWeight('bold').setFontSize(9); // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É
    const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
    if (addressSheet) { 
        addressSheet.getRange('A2').setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞').setFontSize(9).setFontWeight('bold'); // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        addressSheet.getRange('B2').setHorizontalAlignment('center').setBackground('#4ee1f6').setBorder(true, true, true, true, false, false).setFontSize(9); // –Ø—á–µ–π–∫–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        formatReportSheet(addressSheet); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS); 
    if (competitorsSheet) { 
        competitorsSheet.getRange('A2:N1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö –≤ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥.
 * @param {number|string} months –°—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {string} –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä–æ–∫.
 */

// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ==================

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ç–∏—Ä–µ.
 * @param {number} length –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏.
 * @returns {Array<string>} –ú–∞—Å—Å–∏–≤ –∏–∑ —Ç–∏—Ä–µ.
 */
function createDashRow(length) { return new Array(length).fill('-'); }

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateAverage(arr) { 
  if (!arr || arr.length === 0) return 0; 
  return Math.floor(arr.reduce((a, b) => a + b, 0) / arr.length); 
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateMedian(arr) { 
  if (!arr || arr.length === 0) return 0; 
  const sorted = [...arr].sort((a, b) => a - b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0 ? sorted[mid] : Math.floor((sorted[mid - 1] + sorted[mid]) / 2); // –°—Ä–µ–¥–Ω–µ–µ –¥–≤—É—Ö —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —á–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (—Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @param {number} percent –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Å–µ–∫–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∞—è.
 * @returns {number} –£—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ.
 */
function calculateTrimmedMean(arr, percent) { 
  if (!arr || arr.length === 0) return 0; 
  const sorted = [...arr].sort((a,b) => a-b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const trimCount = Math.floor(sorted.length * percent); // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è
  const trimmedArr = sorted.slice(trimCount, sorted.length - trimCount); // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  return trimmedArr.length > 0 ? calculateAverage(trimmedArr) : calculateAverage(arr); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ —É—Å–µ—á–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞, –µ—Å–ª–∏ —É—Å–µ—á–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ (–Ω–∞–∫–ª–æ–Ω –∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ).
 * @param {Array<Array<number>>} data –ú–∞—Å—Å–∏–≤ –ø–∞—Ä [x, y].
 * @returns {{slope: number, intercept: number}|null} –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –∏–ª–∏ null.
 */
function calculateLinearRegression(data) { 
  if(!data || data.length < 2) return null; 
  
  let sum_x = 0, sum_y = 0, sum_xy = 0, sum_xx = 0;
  const n = data.length;
  
  // –°—É–º–º–∏—Ä—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
  data.forEach(([x, y]) => { 
    sum_x += x; 
    sum_y += y; 
    sum_xy += x * y; 
    sum_xx += x * x; 
  }); 
  
  const denominator = (n * sum_xx - sum_x * sum_x);
  if (denominator === 0) return null; // –ò–∑–±–µ–≥–∞–µ–º –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
  
  const slope = (n * sum_xy - sum_x * sum_y) / denominator; // –ù–∞–∫–ª–æ–Ω
  const intercept = (sum_y - slope * sum_x) / n; // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
  
  return { slope, intercept }; 
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ Google –¢–∞–±–ª–∏—Ü—ã.
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤, –¥–æ–±–∞–≤–ª—è—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} columns –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 * @returns {Array<Array<any>>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatForBatchWrite(data, columns) { 
  return data.map(row => { 
    const newRow = [...row]; // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ, —á–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
    while (newRow.length < columns) newRow.push(''); 
    return newRow.slice(0, columns); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤
  }); 
}

// ================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–æ–≤.
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
 */
function setupNewSheets() {
  try {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É"
    setupSingleObjectAnalyticsSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    setupAnalysisObjectSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    setupCompetitorsAnalysisSheet();
    
    SpreadsheetApp.getUi().alert('‚úÖ –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!');
    Logger.log('–ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ setupNewSheets: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–æ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤: ' + e.message);
  }
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
 */
function setupAnalysisObjectSheet() {
  const sheet = SPREADSHEET.getSheetByName('–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ (A2:AQ2)
  const headers = [
    '–î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', 
    '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', 
    '–§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞', '–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?', '–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?', '–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?',
    '–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞', '—Ü–∏–∞–Ω', '–¥–∞—Ç–∞', '–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞',
    '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', 
    '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞', 
    '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', 
    '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %', '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', 
    '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:AP2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:AP2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:AP1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
  sheet.getRange('V3:AP1000').setHorizontalAlignment('center');
  
  Logger.log('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
 */
function setupCompetitorsAnalysisSheet() {
  const sheet = SPREADSHEET.getSheetByName('–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ª–∏—Å—Ç–µ)
  const headers = [
    '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', 
    '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:M2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:M2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:M1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  Logger.log('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ –∫–æ–¥–∞.
 */
function setupSingleObjectAnalyticsSheet() {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ A2 - –∑–∞–≥–æ–ª–æ–≤–æ–∫
  sheet.getRange('A2')
    .setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞')
    .setFontSize(9)
    .setFontWeight('bold')
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ B2 - –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
  sheet.getRange('B2')
    .setHorizontalAlignment('center')
    .setBackground('#4ee1f6')
    .setBorder(true, true, true, true, false, false)
    .setFontSize(9)
    .setVerticalAlignment('middle');
  
  // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å 4 —Å—Ç—Ä–æ–∫–∏)
  sheet.getRange('A4:B50').clearContent().clearFormat();
  
  Logger.log('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É –≤ –ª–∏—Å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.
 * @returns {Array|null} –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
 */
function findObjectByCode(code) {
  try {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!code || typeof code !== 'string') {
      Logger.log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    const cleanCode = String(code).trim();
    if (cleanCode === '') {
      Logger.log('–ü—É—Å—Ç–æ–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–∏—Å—Ç–∞ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"
    const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
    if (!activeSheet) {
      Logger.log('–õ–∏—Å—Ç "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return null;
    }
    
    const lastRow = activeSheet.getLastRow();
    if (lastRow < 3) {
      Logger.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"');
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å —Å—Ç—Ä–æ–∫–∏ 3, —Ç–∞–∫ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞ 2 - –∑–∞–≥–æ–ª–æ–≤–∫–∏)
    const data = activeSheet.getRange('A3:O' + lastRow).getValues();
    
    // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞ (—Å—Ç–æ–ª–±–µ—Ü F, –∏–Ω–¥–µ–∫—Å 5)
    const foundRow = data.find(row => {
      const rowCode = String(row[5]).trim(); // –°—Ç–æ–ª–±–µ—Ü F (–∏–Ω–¥–µ–∫—Å 5)
      Logger.log(`–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–¥: "${cleanCode}" —Å "${rowCode}"`);
      return rowCode === cleanCode;
    });
    
    if (foundRow) {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö`);
      return foundRow;
    } else {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö`);
      return null;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ findObjectByCode: ${e.stack}`);
    return null;
  }
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {boolean} –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞.
 */
function validateCode(code) {
  if (!code || typeof code !== 'string') return false;
  const cleanCode = String(code).trim();
  return cleanCode !== '' && cleanCode.length > 0;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –º–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏.
 */
function buildSingleObjectCompetitorsArray(objectData) {
  try {
    Logger.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    const district = objectData[1]; // –†–∞–π–æ–Ω
    const type = objectData[2]; // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    const rooms = Number(objectData[3]); // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    const area = Number(objectData[4]); // –ü–ª–æ—â–∞–¥—å
    const repair = objectData[6]; // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    const buildYear = Number(objectData[10]); // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    
    Logger.log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}, —Ä–µ–º–æ–Ω—Ç=${repair}, –≥–æ–¥=${buildYear}`);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeData = getActiveCompetitorsData();
    const soldData = getSoldCompetitorsData();
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: ${activeData.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: ${soldData.length}`);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏)
    const activeCompetitors = filterCompetitorsByCriteria(activeData, {
      district, type, rooms, area, repair, buildYear
    }, true); // true = –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    const soldCompetitors = filterCompetitorsByCriteria(soldData, {
      district, type, rooms, area, repair, buildYear
    }, false); // false = –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    Logger.log(`–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${activeCompetitors.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${soldCompetitors.length}`);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
    const formattedActive = activeCompetitors.map(row => formatCompetitorRow(row, false));
    const formattedSold = soldCompetitors.map(row => formatCompetitorRow(row, true));
    
    Logger.log(`–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${formattedActive.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${formattedSold.length}`);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    fillCompetitorsSheet(formattedActive, formattedSold, objectData[5], objectData); // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–∞–∫–∂–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞
    
    Logger.log('–ú–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    
    return {
      activeCompetitors: formattedActive,
      soldCompetitors: formattedSold
    };
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ buildSingleObjectCompetitorsArray: ${e.stack}`);
    return { activeCompetitors: [], soldCompetitors: [] };
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getActiveCompetitorsData() {
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  if (!activeSheet || activeSheet.getLastRow() < 3) return [];
  return activeSheet.getRange('A3:O' + activeSheet.getLastRow()).getValues();
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getSoldCompetitorsData() {
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  if (!soldSheet || soldSheet.getLastRow() < 3) return [];
  return soldSheet.getRange('A3:O' + soldSheet.getLastRow()).getValues();
}

/**
 * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} data –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 * @param {boolean} isActiveData –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 * @returns {Array} –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */
function filterCompetitorsByCriteria(data, criteria, isActiveData = true) {
  const { district, type, rooms, area, repair, buildYear } = criteria;
  
  Logger.log(`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}`);
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  const now = new Date();
  const startDate = new Date(now.getFullYear(), now.getMonth() - 6, 1); // 6 –º–µ—Å—è—Ü–µ–≤ –Ω–∞–∑–∞–¥
  const endDate = now;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏" (6 –º–µ—Å—è—Ü–µ–≤)
  const staleDate = new Date();
  staleDate.setMonth(staleDate.getMonth() - 6);
  
  Logger.log(`–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: staleDate=${staleDate.toLocaleDateString()}, startDate=${startDate.toLocaleDateString()}, endDate=${endDate.toLocaleDateString()}`);
  
  let filteredCount = 0;
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
  const result = data.filter((row, index) => {
    try {
      const rowDate = new Date(row[0]);
      const rowDistrict = row[1];
      const rowType = row[2];
      const rowRooms = Number(row[3]);
      const rowArea = Number(row[4]);
      const rowRepair = row[6];
      const rowBuildYear = Number(row[10]) || null;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      if (index < 3) {
        Logger.log(`–°—Ç—Ä–æ–∫–∞ ${index}: —Ä–∞–π–æ–Ω="${rowDistrict}", —Ç–∏–ø="${rowType}", –∫–æ–º–Ω–∞—Ç=${rowRooms}, –ø–ª–æ—â–∞–¥—å=${rowArea}, —Ä–µ–º–æ–Ω—Ç="${rowRepair}", –≥–æ–¥=${rowBuildYear}`);
      }
      
      // 1. –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –§–ò–õ–¨–¢–† (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π!)
      if (rowDistrict !== district) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–∞–π–æ–Ω—É: "${rowDistrict}" !== "${district}"`);
        return false;
      }
      
      // 2. –¢–ò–ü –û–ë–™–ï–ö–¢–ê (—Å—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
      if (rowType !== type) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ç–∏–ø—É: "${rowType}" !== "${type}"`);
        return false;
      }
      
      // 3. –í–†–ï–ú–ï–ù–ù–û–ô –§–ò–õ–¨–¢–†
      if (isActiveData) {
        // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö: –Ω–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < staleDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–∞–∫—Ç–∏–≤–Ω—ã–µ): ${rowDate.toLocaleDateString()} < ${staleDate.toLocaleDateString()}`);
          return false;
        }
      } else {
        // –î–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < startDate.getTime() || rowDate.getTime() > endDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ): ${rowDate.toLocaleDateString()} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`);
          return false;
        }
      }
      
      // 4. –ö–û–õ–ò–ß–ï–°–¢–í–û –ö–û–ú–ù–ê–¢ (–¥–æ–ø—É—Å–∫ +/- 1)
      const allowedRooms = [rooms, rooms + 1, rooms - 1].filter(r => r >= 0);
      if (!allowedRooms.includes(rowRooms)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º: ${rowRooms} –Ω–µ –≤ ${allowedRooms}`);
        return false;
      }
      
      // 5. –ü–õ–û–©–ê–î–¨ (–¥–æ–ø—É—Å–∫ +/- 20%)
      const minArea = area * 0.8;
      const maxArea = area * 1.2;
      if (rowArea < minArea || rowArea > maxArea) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –ø–ª–æ—â–∞–¥–∏: ${rowArea} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${minArea}-${maxArea}`);
        return false;
      }
      
      // 6. –ì–û–î –ü–û–°–¢–†–û–ô–ö–ò (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
      if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≥–æ–¥—É: ${rowBuildYear} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${buildYear - 10}-${buildYear + 10}`);
        return false;
      }
      
      // 7. –¢–ò–ü –†–ï–ú–û–ù–¢–ê (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞)
      const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
      const objectRepairLower = repair ? repair.toLowerCase() : '';
      const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));
      
      if (isObjectGoodRepair) {
        // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, –∏—â–µ–º —Ç–æ–ª—å–∫–æ —Å —Ö–æ—Ä–æ—à–∏–º
        const competitorRepairLower = rowRepair ? rowRepair.toLowerCase() : '';
        if (!goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–µ–º–æ–Ω—Ç—É: "${rowRepair}" –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞`);
          return false;
        }
      }
      // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç - —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
      
      if (index < 3) Logger.log(`  ‚úÖ –°—Ç—Ä–æ–∫–∞ ${index} –ø—Ä–æ—à–ª–∞ –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã!`);
      filteredCount++;
      return true;
    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏ ${index}: ${e.message}`);
      return false;
    }
  });
  
  Logger.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${filteredCount} –∏–∑ ${data.length} ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤`);
  
  return result;
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 */
function fillCompetitorsSheet(activeCompetitors, soldCompetitors, objectCode, objectData) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
  sheet.getRange('A2:M' + sheet.getMaxRows()).clearContent().clearFormat();
  
  let output = [];
  const headers = ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ)
  if (activeCompetitors.length > 0) {
    output.push([`–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${objectCode})`]);
    output.push(headers);
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –Ω–∞—à–∏–º –æ–±—ä–µ–∫—Ç–æ–º + –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
    const allActiveObjects = [...activeCompetitors];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—à –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤
    if (objectData) {
      const ourObjectAsCompetitor = formatCompetitorRow(objectData, false);
      allActiveObjects.push(ourObjectAsCompetitor);
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã (–≤–∫–ª—é—á–∞—è –Ω–∞—à) –ø–æ —Ü–µ–Ω–µ (—Å—Ç–æ–ª–±–µ—Ü 5 - —Ü–µ–Ω–∞)
    const sortedActiveCompetitors = allActiveObjects.sort((a, b) => {
      const priceA = Number(a[5]) || 0; // –¶–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ 5
      const priceB = Number(b[5]) || 0; // –¶–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ 5
      return priceA - priceB; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç –º–µ–Ω—å—à–µ–π –∫ –±–æ–ª—å—à–µ–π
    });
    
    output.push(...sortedActiveCompetitors);
    output.push([]); // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ)
  if (soldCompetitors.length > 0) {
    output.push([`–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${objectCode})`]);
    output.push(headers);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ü–µ–Ω–µ (—Å—Ç–æ–ª–±–µ—Ü 5 - —Ü–µ–Ω–∞)
    const sortedSoldCompetitors = [...soldCompetitors].sort((a, b) => {
      const priceA = Number(a[5]) || 0; // –¶–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ 5
      const priceB = Number(b[5]) || 0; // –¶–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ 5
      return priceA - priceB; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç –º–µ–Ω—å—à–µ–π –∫ –±–æ–ª—å—à–µ–π
    });
    
    output.push(...sortedSoldCompetitors);
    output.push([]); // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
  }
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  if (output.length > 0) {
    const formattedData = formatForBatchWrite(output, 13);
    sheet.getRange(2, 1, formattedData.length, formattedData[0].length).setValues(formattedData);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
    let currentRow = 2;
    for (let i = 0; i < output.length; i++) {
      if (output[i].length === 1 && output[i][0].includes('–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã')) {
        // –≠—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞
        sheet.getRange(currentRow, 1, 1, 13)
          .setFontWeight('bold')
          .setBackground('#E6F3FF')
          .setFontSize(10)
          .setHorizontalAlignment('center')
          .setVerticalAlignment('middle');
      } else if (output[i].length === 13 && output[i][0] === '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞') {
        // –≠—Ç–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤
        sheet.getRange(currentRow, 1, 1, 13)
          .setFontWeight('bold')
          .setBackground('#D3D3D3')
          .setFontSize(9)
          .setHorizontalAlignment('center')
          .setVerticalAlignment('middle');
      }
      currentRow++;
    }
  }
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 */
function analyzeSingleObject(objectData, competitorsData) {
  try {
    const { activeCompetitors, soldCompetitors } = competitorsData;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã
    const advertisingData = getAdvertisingData(objectData[5]); // objectData[5] - –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞
    
    // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
    const metrics = calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞
    fillAnalysisObjectSheet(objectData, advertisingData, metrics);
    
    return metrics;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObject: ${e.stack}`);
    return null;
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingData(objectCode) {
  const avitoData = getAdvertisingPlatformData(SHEETS.AVITO, objectCode);
  const cianData = getAdvertisingPlatformData(SHEETS.CIAN, objectCode);
  const domclickData = getAdvertisingPlatformData(SHEETS.DOMCLICK, objectCode);
  
  return {
    avito: avitoData,
    cian: cianData,
    domclick: domclickData
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} sheetName –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingPlatformData(sheetName, objectCode) {
  const sheet = SPREADSHEET.getSheetByName(sheetName);
  if (!sheet || sheet.getLastRow() < 3) {
    return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
  }
  
  const data = sheet.getRange('A3:D' + sheet.getLastRow()).getValues();
  const foundRow = data.find(row => String(row[1]).trim() === String(objectCode).trim());
  
  if (foundRow) {
    return {
      status: foundRow[2] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      date: foundRow[3] || null
    };
  }
  
  return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–ø–æ–ª–Ω–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @returns {Object} –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData) {
  const objectPrice = Number(objectData[7]) || 0;
  const objectArea = Number(objectData[4]) || 1;
  const objectPricePerM2 = objectArea > 0 ? objectPrice / objectArea : 0;
  
  // –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
  const competitorsInDistrict = activeCompetitors.length;
  const totalSales = soldCompetitors.length;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  // (—Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –Ω–µ—Ç –ª–∏—Å—Ç–∞ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ" —Å —è—á–µ–π–∫–∞–º–∏ C1-C2)
  const periodMonths = 6;
  Logger.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${periodMonths} –º–µ—Å—è—Ü–µ–≤`);
  
  // –°–ø—Ä–æ—Å (–æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü)
  const demandPerMonth = totalSales / periodMonths;
  
  // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
  const liquidityType = determineLiquidityType(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
  const marketAssessment = assessMarket(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
  const competitionTrend = calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths);
  
  // –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ
  const objectRank = calculateObjectRank(objectData, activeCompetitors);
  
  // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤
  const priceTrendPerM2 = calculatePriceTrendPerM2(soldCompetitors);
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º
  const marketRatios = calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors);
  
  // –ü—Ä–æ–≥–Ω–æ–∑—ã
  const forecasts = calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors);
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
  const avgNewObjectsPerMonth = competitorsInDistrict / periodMonths;
  const arrivalToDemandRatio = demandPerMonth > 0 ? ((avgNewObjectsPerMonth / demandPerMonth) * 100) : 0;
  const weightedRecommendedPrice = calculateWeightedRecommendedPrice(marketRatios, forecasts);
  
  return {
    competitorsInDistrict,
    totalSales,
    demandPerMonth,
    liquidityType,
    marketAssessment,
    competitionTrend,
    objectRank,
    priceTrendPerM2,
    marketRatios,
    forecasts,
    avgNewObjectsPerMonth,
    arrivalToDemandRatio,
    weightedRecommendedPrice
  };
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @param {Object} metrics –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function fillAnalysisObjectSheet(objectData, advertisingData, metrics) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
  sheet.getRange('A3:AP1000').clearContent();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
  const rowData = [
    objectData[0], // –î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
    objectData[1], // –†–∞–π–æ–Ω
    objectData[2], // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    objectData[3], // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    objectData[4], // –ü–ª–æ—â–∞–¥—å
    objectData[5], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç
    objectData[6], // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    objectData[7], // –¶–µ–Ω–∞
    objectData[8], // –≠—Ç–∞–∂
    objectData[9], // –ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π
    objectData[10], // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    objectData[11], // –§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞
    objectData[12], // –ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?
    objectData[13], // –û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?
    objectData[14], // –ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?
    advertisingData.avito.status, // –∞–≤–∏—Ç–æ
    advertisingData.avito.date, // –¥–∞—Ç–∞ –∞–≤–∏—Ç–æ
    advertisingData.cian.status, // —Ü–∏–∞–Ω
    advertisingData.cian.date, // –¥–∞—Ç–∞ —Ü–∏–∞–Ω
    advertisingData.domclick.status, // –¥–æ–º–∫–ª–∏–∫
    advertisingData.domclick.date, // –¥–∞—Ç–∞ –¥–æ–º–∫–ª–∏–∫
    metrics.competitorsInDistrict, // –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ
    metrics.totalSales, // –ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ
    metrics.demandPerMonth, // —Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å
    metrics.avgNewObjectsPerMonth, // –ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å
    metrics.liquidityType, // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    metrics.marketAssessment, // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
    metrics.competitionTrend, // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %
    metrics.objectRank, // –º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    metrics.priceTrendPerM2, // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å
    metrics.marketRatios.activeRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %
    metrics.marketRatios.soldRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.marketRatios.avgActivePrice, // —Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.activeRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %
    metrics.marketRatios.avgSoldPrice, // —Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.soldRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.forecasts.quickPrice, // –¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)
    metrics.forecasts.quickMonths, // –°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.
    metrics.forecasts.marketPrice, // –¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)
    metrics.forecasts.marketMonths // –°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.
  ];
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É 3
  sheet.getRange('A3:AP3').setValues([rowData]);
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
 */
function analyzeSingleObjectByCode(objectCode) {
  try {
    Logger.log(`–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å –∫–æ–¥–æ–º: ${objectCode}`);
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!validateCode(objectCode)) {
      Logger.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 2. –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      Logger.log('‚ùå –û–±—ä–µ–∫—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö');
      return false;
    }
    
    // 3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData);
    
    // 3.1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const criteria = {
      district: objectData[1],
      type: objectData[2],
      rooms: Number(objectData[3]),
      area: Number(objectData[4]),
      repair: objectData[6],
      buildYear: Number(objectData[10])
    };
    writeCompetitorCriteria(objectData, criteria);
    
    // 4. –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞
    const analysisResults = analyzeSingleObject(objectData, competitorsData);
    
    if (!analysisResults) {
      Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    const reportGenerated = generateSingleObjectReport(objectData, analysisResults, competitorsData);
    
    if (reportGenerated) {
      Logger.log('–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      return true;
    } else {
      Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
      return false;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObjectByCode: ${e.stack}`);
    Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ' + e.message);
    return false;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –æ–¥–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} analysisResults –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
 */
function generateSingleObjectReport(objectData, analysisResults, competitorsData) {
  try {
    const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (!sheet) return false;
    
    // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    sheet.getRange('A4:B50').clearContent().clearFormat();
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
    const reportData = createSingleObjectReportData(objectData, analysisResults, competitorsData);
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
    reportData.forEach((row, index) => {
      const rowNumber = 4 + index;
      sheet.getRange(`A${rowNumber}`).setValue(row[0]);
      sheet.getRange(`B${rowNumber}`).setValue(row[1]);
      
      // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
      if (row[0] && (row[0].includes('–ü–ê–†–ê–ú–ï–¢–†–´') || row[0].includes('–û–¶–ï–ù–ö–ê') || row[0].includes('–ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï') || row[0].includes('–¶–ï–ù–û–í–ê–Ø'))) {
        sheet.getRange(`A${rowNumber}:B${rowNumber}`)
          .setFontWeight('bold')
          .setBackground('#E6F3FF')
          .setFontSize(10);
      } else if (row[0] && row[0].includes(':')) {
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞
        sheet.getRange(`A${rowNumber}`).setFontWeight('bold');
        sheet.getRange(`B${rowNumber}`).setFontSize(9);
      } else {
        sheet.getRange(`A${rowNumber}:B${rowNumber}`).setFontSize(9);
      }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ò–ò –∞–Ω–∞–ª–∏–∑ –≤ –∫–æ–Ω–µ—Ü
    const aiAnalysis = createSingleObjectReportText(objectData, analysisResults, competitorsData);
    const aiRowNumber = 4 + reportData.length + 1;
    sheet.getRange(`A${aiRowNumber}`).setValue('–ê–ù–ê–õ–ò–ó –ò–ò –ê–°–°–ò–°–¢–ï–ù–¢–ê');
    sheet.getRange(`A${aiRowNumber}`).setFontWeight('bold').setBackground('#E6F3FF').setFontSize(10);
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
    const aiContentRow = aiRowNumber + 1;
    sheet.getRange(`A${aiContentRow}:B${aiContentRow}`).merge();
    sheet.getRange(`A${aiContentRow}`).setValue(aiAnalysis);
    sheet.getRange(`A${aiContentRow}`).setFontSize(9).setWrap(true);
    
    Logger.log('–û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
    return true;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ generateSingleObjectReport: ${e.stack}`);
    return false;
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –ø–æ –æ–±—ä–µ–∫—Ç—É.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} analysisResults –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –ú–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫ –æ—Ç—á–µ—Ç–∞.
 */
function createSingleObjectReportData(objectData, analysisResults, competitorsData) {
  const { activeCompetitors, soldCompetitors } = competitorsData;
  
  // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–∞
  const reportData = [
    ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', ''],
    ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
    ['–†–∞–π–æ–Ω', objectData[1]],
    ['–û–±—ä–µ–∫—Ç', `${objectData[3]}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞, ${objectData[4]} –º¬≤`],
    ['–î–æ–º', `${objectData[10]} –≥. –ø–æ—Å—Ç—Ä–æ–π–∫–∏`],
    ['–†–µ–º–æ–Ω—Ç', objectData[6]],
    ['–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞', `${Number(objectData[7]).toLocaleString()} —Ä—É–±. (${Math.round(Number(objectData[7])/Number(objectData[4])).toLocaleString()} —Ä—É–±/–º¬≤)`],
    ['', ''],
    ['–û–¶–ï–ù–ö–ê –†–´–ù–ö–ê', ''],
    ['–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞', analysisResults.marketAssessment],
    ['–°–ø—Ä–æ—Å', `${analysisResults.demandPerMonth.toFixed(1)} –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å`],
    ['–ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è', `${activeCompetitors.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö (+${analysisResults.avgNewObjectsPerMonth.toFixed(1)} –Ω–æ–≤—ã—Ö/–º–µ—Å, ${analysisResults.arrivalToDemandRatio.toFixed(0)}% –æ—Ç —Å–ø—Ä–æ—Å–∞)`],
    ['–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', analysisResults.liquidityType],
    ['', ''],
    ['–ü–û–ó–ò–¶–ò–û–ù–ò–†–û–í–ê–ù–ò–ï –û–ë–™–ï–ö–¢–ê', ''],
    ['–†–∞–Ω–≥ –ø–æ —Ü–µ–Ω–µ', `${analysisResults.objectRank} –∏–∑ ${activeCompetitors.length}`],
    ['–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏', `${analysisResults.marketRatios.activeRatio > 0 ? '–≤—ã—à–µ –Ω–∞ ' : '–Ω–∏–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.activeRatio).toFixed(1)}%`],
    ['–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏', `${analysisResults.marketRatios.soldRatio > 0 ? '–≤—ã—à–µ –Ω–∞ ' : '–Ω–∏–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.soldRatio).toFixed(1)}%`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', `${Math.round(analysisResults.marketRatios.avgActivePrice * Number(objectData[4])).toLocaleString()} —Ä—É–±. (${Math.round(analysisResults.marketRatios.avgActivePrice).toLocaleString()} —Ä—É–±/–º¬≤)`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', `${Math.round(analysisResults.marketRatios.avgSoldPrice * Number(objectData[4])).toLocaleString()} —Ä—É–±. (${Math.round(analysisResults.marketRatios.avgSoldPrice).toLocaleString()} —Ä—É–±/–º¬≤)`],
    ['', ''],
    ['–¶–ï–ù–û–í–ê–Ø –°–¢–†–ê–¢–ï–ì–ò–Ø –ò –ü–†–û–ì–ù–û–ó', ''],
    ['–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', `${analysisResults.forecasts.quickPrice.toLocaleString()} —Ä—É–±.`],
    ['–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è)', `${analysisResults.forecasts.quickMonths} –º–µ—Å.`],
    ['–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', `${analysisResults.forecasts.marketPrice.toLocaleString()} —Ä—É–±.`],
    ['–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è)', `${analysisResults.forecasts.marketMonths} –º–µ—Å.`]
  ];
  
  return reportData;
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} analysisResults –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {string} –¢–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞.
 */
function createSingleObjectReportText(objectData, analysisResults, competitorsData) {
  const { activeCompetitors, soldCompetitors } = competitorsData;
  
  // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è –ò–ò
  const geminiSummary = `–û–ë–™–ï–ö–¢: ${objectData[3]}-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ ${objectData[4]} –º¬≤ –≤ —Ä–∞–π–æ–Ω–µ "${objectData[1]}".
–û–¶–ï–ù–ö–ê –†–´–ù–ö–ê: ${analysisResults.marketAssessment}. –°–ø—Ä–æ—Å —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${analysisResults.demandPerMonth.toFixed(1)} –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å. –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏: ${analysisResults.liquidityType}. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è ${activeCompetitors.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
–ü–û–ó–ò–¶–ò–Ø –û–ë–™–ï–ö–¢–ê: –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ ${Number(objectData[7]).toLocaleString()} —Ä—É–±. –Ω–∞ ${(analysisResults.marketRatios.activeRatio || 0).toFixed(1)}% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –Ω–∞ ${(analysisResults.marketRatios.soldRatio || 0).toFixed(1)}% –æ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
–¶–ï–ù–û–í–´–ï –°–¶–ï–ù–ê–†–ò–ò:
1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞: —Ü–µ–Ω–∞ ~${analysisResults.forecasts.quickPrice.toLocaleString()} —Ä—É–±., –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ä–æ–∫–∞ ${analysisResults.forecasts.quickMonths} –º–µ—Å.
2. –†—ã–Ω–æ—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: —Ü–µ–Ω–∞ ~${analysisResults.forecasts.marketPrice.toLocaleString()} —Ä—É–±., –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ä–æ–∫–∞ ${analysisResults.forecasts.marketMonths} –º–µ—Å.`;
  
  // –í—ã–∑—ã–≤–∞–µ–º –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
  const prompt = '–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –¥–µ–ª–æ–≤–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏.\n\n–¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω —Å—É—Ö–æ–π, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç-—Ä–µ–∑—é–º–µ –ø–æ –æ—Ü–µ–Ω–∫–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–∞–Ω–∞–ª–∏–∑ –≤ —Å–µ–∫—Ü–∏–∏ \'–ê–ù–ê–õ–ò–ó –ò–ò –ê–°–°–ò–°–¢–ï–ù–¢–ê\').\n\n–¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞: –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —ç—Ç–æ—Ç —Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞—É—á–Ω–æ–≥–æ/—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è –≤ –≥–ª–∞–¥–∫–∏–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥–µ–ª–æ–≤–æ–π —Ç–µ–∫—Å—Ç, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –ø—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∫–ª–∏–µ–Ω—Ç—É.\n\n–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ç–µ–∫—Å—Ç—É:\n\n–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–π —Å—É—Ç–∏, –≤—Å–µ—Ö —á–∏—Å–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤—Å–µ—Ö –≤—ã–≤–æ–¥–æ–≤ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞. –ù–∏–∫–∞–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è –≤ —Å–µ–∫—Ü–∏–∏ \'–ê–ù–ê–õ–ò–ó –ò–ò –ê–°–°–ò–°–¢–ï–ù–¢–ê\' (–≤–∫–ª—é—á–∞—è —Ü–∏—Ñ—Ä—ã –ø–æ —Å–ø—Ä–æ—Å—É, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —Ü–µ–Ω—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º), –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ—Ç–µ—Ä—è–Ω–∞.\n\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É—é—â–µ–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –Ω–∏–∂–µ:\n\n–ö—Ä–∞—Ç–∫–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞.\n\n–ü–æ–∑–∏—Ü–∏—è –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ —ç—Ç–æ–º —Ä—ã–Ω–∫–µ.\n\n–¶–µ–Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏.\n\n–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –¥–æ–¥—É–º—ã–≤–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –ï—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–∫–æ–º—É-–ª–∏–±–æ –∞—Å–ø–µ–∫—Ç—É, —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç—Ä–∞–∂–µ–Ω–æ –≤ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–æ–π.\n\n–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–ø–ª–æ—à–Ω—ã–º, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ª—é–±–æ–π Markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ (—Ç–∞–∫–æ–π –∫–∞–∫ —Ä–µ—à–µ—Ç–∫–∏ #, –∑–≤–µ–∑–¥–æ—á–∫–∏ *, –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫—É—Ä—Å–∏–≤ –∏ —Ç.–¥.). –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ø–ª–æ—à–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º —É—Å–ª–æ–≤–∏–µ–º.\n\n–¶–µ–ª–µ–≤–æ–π —Å—Ç–∏–ª—å: –î–µ–ª–æ–≤–∞—è –ø—Ä–æ–∑–∞, –ø–æ–Ω—è—Ç–Ω–∞—è –Ω–µ—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, –≤–Ω—É—à–∞—é—â–∞—è –¥–æ–≤–µ—Ä–∏–µ, —á–µ—Ç–∫–∞—è –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–∞—è. –ò–∑–±–µ–≥–∞–π –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω.';
  
  /* original callOpenAI was here, now replaced by callGemini */
  const geminiResponse = callGemini(prompt, geminiSummary);
  
  return geminiResponse;
}

/**
 * –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (9, null, undefined, 0).
 * @param {*} value –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {*} –û—á–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null.
 */
function cleanDataValue(value) {
  if (value === null || value === undefined || value === '' || value === 0 || value === '9' || value === 9) {
    return null;
  }
  return value;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (–æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç 10% –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
 * @param {Array} prices –ú–∞—Å—Å–∏–≤ —Ü–µ–Ω.
 * @returns {number} –£—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ.
 */
function calculateTrimmedMean(prices) {
  if (prices.length === 0) return 0;
  if (prices.length < 3) return prices.reduce((sum, price) => sum + price, 0) / prices.length;
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã
  const sortedPrices = [...prices].sort((a, b) => a - b);
  
  // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è (20% —Å –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
  const trimCount = Math.floor(sortedPrices.length * 0.2);
  
  // –û—Ç–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—Ä–∞–π–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const trimmedPrices = sortedPrices.slice(trimCount, sortedPrices.length - trimCount);
  
  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ
  return trimmedPrices.reduce((sum, price) => sum + price, 0) / trimmedPrices.length;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ–¥–∏–∞–Ω—É.
 * @param {Array} prices –ú–∞—Å—Å–∏–≤ —Ü–µ–Ω.
 * @returns {number} –ú–µ–¥–∏–∞–Ω–∞.
 */
function calculateMedian(prices) {
  if (prices.length === 0) return 0;
  if (prices.length === 1) return prices[0];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—ã
  const sortedPrices = [...prices].sort((a, b) => a - b);
  
  const middle = Math.floor(sortedPrices.length / 2);
  
  if (sortedPrices.length % 2 === 0) {
    // –ß–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - –±–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ –¥–≤—É—Ö —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö
    return (sortedPrices[middle - 1] + sortedPrices[middle]) / 2;
  } else {
    // –ù–µ—á–µ—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - –±–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π
    return sortedPrices[middle];
  }
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {Object} forecasts –ü—Ä–æ–≥–Ω–æ–∑—ã.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateWeightedRecommendedPrice(marketRatios, forecasts) {
  const activePrice = marketRatios.avgActivePrice || 0;
  const soldPrice = marketRatios.avgSoldPrice || 0;
  const marketPrice = forecasts.marketPrice || 0;
  
  if (activePrice > 0 && soldPrice > 0 && marketPrice > 0) {
    return (activePrice + soldPrice + marketPrice) / 3;
  }
  
  return marketPrice || 0;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 */
function calculateDemandPerMonth(soldCompetitors) {
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  const periodMonths = 6;
  
  return soldCompetitors.length / periodMonths;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 */
function determineLiquidityType(competitors, sales, demand) {
  if (competitors === 0) return 'C-';
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: (–°–ø—Ä–æ—Å / –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) * 100%
  const liquidityIndex = (demand / competitors) * 100;
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
  if (liquidityIndex > 25 && demand >= 3) return 'A+'; // –ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 20) return 'A'; // –í—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 10) return 'B'; // –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
  if (liquidityIndex >= 5) return 'C'; // –ù–∏–∑–∫–∏–π
  return 'C-'; // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ–∫.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞.
 */
function assessMarket(competitors, sales, demand) {
  if (competitors === 0) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  
  const liquidityIndex = demand / (competitors / 12);
  
  if (liquidityIndex >= 2) return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å';
  if (liquidityIndex >= 1.5) return '–í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å';
  if (liquidityIndex >= 1) return '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫';
  if (liquidityIndex >= 0.5) return '–ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å';
  return '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å';
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ %.
 */
function calculateCompetitionTrend(activeCompetitors, soldCompetitors) {
  // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è - –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
  const activeCount = activeCompetitors.length;
  const soldCount = soldCompetitors.length;
  
  if (soldCount === 0) return 0;
  
  return ((activeCount - soldCount) / soldCount) * 100;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} periodMonths –ü–µ—Ä–∏–æ–¥ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {number} –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ %.
 */
function calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths) {
  if (activeCompetitors.length === 0) return 0;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
  const endDate = new Date();
  const startDate = new Date(endDate.getTime() - (periodMonths * 30.44 * 24 * 60 * 60 * 1000));
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2);
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = activeCompetitors.filter(row => {
    const rowDate = new Date(row[0]); // –î–∞—Ç–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ A
    return rowDate >= startDate && rowDate < midPoint;
  }).length;
  
  const secondHalfCount = activeCompetitors.filter(row => {
    const rowDate = new Date(row[0]); // –î–∞—Ç–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ A
    return rowDate >= midPoint && rowDate <= endDate;
  }).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return 100; // –†–µ–∑–∫–∏–π —Ä–æ—Å—Ç
  if (firstHalfCount === 0 || secondHalfCount === 0) return 0; // –°—Ç–∞–±–∏–ª—å–Ω–æ
  
  const trend = ((secondHalfCount - firstHalfCount) / firstHalfCount) * 100;
  return Math.round(trend);
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞.
 */
function calculateObjectRank(objectData, activeCompetitors) {
  const objectPrice = Number(objectData[7]) || 0; // –¶–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (—Å—Ç–æ–ª–±–µ—Ü H, –∏–Ω–¥–µ–∫—Å 7)
  
  if (activeCompetitors.length === 0) return 1;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —Ü–µ–Ω (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã + –Ω–∞—à –æ–±—ä–µ–∫—Ç)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Ü–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ 5 (–∏–Ω–¥–µ–∫—Å 5)
  const competitorPrices = activeCompetitors.map(c => Number(c[5]) || 0).filter(p => p > 0);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—à –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const hasOurObject = competitorPrices.some(price => price === objectPrice);
  
  // –ï—Å–ª–∏ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
  const allActivePrices = hasOurObject 
    ? competitorPrices 
    : [...competitorPrices, objectPrice];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
  allActivePrices.sort((a, b) => a - b);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–Ω–≥: —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å + 1
  const rankByPrice = 1 + allActivePrices.filter(p => p < objectPrice).length;
  
  return rankByPrice;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –≤ —Ä—É–±/–º–µ—Å.
 */
function calculatePriceTrendPerM2(soldCompetitors) {
  if (soldCompetitors.length < 2) return 0;
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
  const dataPoints = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[7]);
      const area = cleanDataValue(row[4]);
      const date = new Date(row[0]);
      
      if (price && area && area > 0 && !isNaN(date.getTime())) {
        return {
          x: date.getTime(), // –í—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
          y: Number(price) / Number(area) // –¶–µ–Ω–∞ –∑–∞ –º¬≤
        };
      }
      return null;
    })
    .filter(point => point !== null);
  
  if (dataPoints.length < 2) return 0;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é
  const regression = calculateLinearRegression(dataPoints);
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–∫–ª–æ–Ω –≤ —Ä—É–±/–º–µ—Å (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –≤ –º–µ—Å—è—Ü)
  const millisecondsPerMonth = 1000 * 60 * 60 * 24 * 30.4375;
  return regression.slope * millisecondsPerMonth;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é –¥–ª—è –º–∞—Å—Å–∏–≤–∞ —Ç–æ—á–µ–∫.
 * @param {Array} points –ú–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫ {x, y}.
 * @returns {Object} {slope, intercept, r2}.
 */
function calculateLinearRegression(points) {
  const n = points.length;
  const sumX = points.reduce((sum, p) => sum + p.x, 0);
  const sumY = points.reduce((sum, p) => sum + p.y, 0);
  const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
  const sumXX = points.reduce((sum, p) => sum + p.x * p.x, 0);
  const sumYY = points.reduce((sum, p) => sum + p.y * p.y, 0);
  
  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  
  // –í—ã—á–∏—Å–ª—è–µ–º R¬≤
  const yMean = sumY / n;
  const ssRes = points.reduce((sum, p) => sum + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
  const ssTot = points.reduce((sum, p) => sum + Math.pow(p.y - yMean, 2), 0);
  const r2 = ssTot > 0 ? 1 - (ssRes / ssTot) : 0;
  
  return { slope, intercept, r2 };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 */
function calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors) {
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç 20% –∫—Ä–∞–π–Ω–∏—Ö)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: —Å—Ç–æ–ª–±–µ—Ü 5 = —Ü–µ–Ω–∞, —Å—Ç–æ–ª–±–µ—Ü 4 = –ø–ª–æ—â–∞–¥—å
  const activePricesPerM2 = activeCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgActivePricePerM2 = activePricesPerM2.length > 0 ? calculateTrimmedMean(activePricesPerM2) : 0;
  
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–º–µ–¥–∏–∞–Ω–∞)
  const soldPricesPerM2 = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgSoldPricePerM2 = soldPricesPerM2.length > 0 ? calculateMedian(soldPricesPerM2) : 0;
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö —Å –∑–Ω–∞–∫–æ–º)
  // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –≤—ã—à–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –Ω–∏–∂–µ
  const activeRatio = avgActivePricePerM2 > 0 ? ((objectPricePerM2 - avgActivePricePerM2) / avgActivePricePerM2) * 100 : 0;
  const soldRatio = avgSoldPricePerM2 > 0 ? ((objectPricePerM2 - avgSoldPricePerM2) / avgSoldPricePerM2) * 100 : 0;
  
  return {
    avgActivePrice: avgActivePricePerM2,
    avgSoldPrice: avgSoldPricePerM2,
    activeRatio,
    soldRatio
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {number} –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ (1.0 = —Å—Ä–µ–¥–Ω–∏–π, >1.0 = –ª—É—á—à–µ, <1.0 = —Ö—É–∂–µ).
 */
function calculateQualityScore(objectData) {
  let score = 1.0;
  
  // –†–µ–º–æ–Ω—Ç
  const repair = String(objectData[6] || '').toLowerCase();
  if (repair.includes('–¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç') || repair.includes('–µ–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç') || repair.includes('—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π')) {
    score += 0.1; // +10% –∑–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç
  } else if (repair.includes('—Ç—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞') || repair.includes('–±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞')) {
    score -= 0.1; // -10% –∑–∞ –ø–ª–æ—Ö–æ–π —Ä–µ–º–æ–Ω—Ç
  }
  
  // –≠—Ç–∞–∂
  const floor = Number(objectData[8]) || 0;
  const totalFloors = Number(objectData[9]) || 0;
  if (floor === 1) {
    score -= 0.05; // -5% –∑–∞ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–∂
  } else if (floor === totalFloors) {
    score -= 0.03; // -3% –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂
  } else if (floor >= 3 && floor <= totalFloors - 2) {
    score += 0.02; // +2% –∑–∞ —Å—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏
  }
  
  // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
  const buildYear = Number(objectData[10]) || 0;
  const currentYear = new Date().getFullYear();
  const age = currentYear - buildYear;
  
  if (age <= 5) {
    score += 0.05; // +5% –∑–∞ –Ω–æ–≤—ã–π –¥–æ–º
  } else if (age <= 15) {
    score += 0.02; // +2% –∑–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–æ–≤—ã–π –¥–æ–º
  } else if (age > 30) {
    score -= 0.05; // -5% –∑–∞ —Å—Ç–∞—Ä—ã–π –¥–æ–º
  }
  
  // –ü–ª–æ—â–∞–¥—å (–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å –¥–∞–µ—Ç –±–æ–Ω—É—Å)
  const area = Number(objectData[4]) || 0;
  const rooms = Number(objectData[3]) || 0;
  if (rooms > 0) {
    const areaPerRoom = area / rooms;
    if (areaPerRoom >= 20 && areaPerRoom <= 35) {
      score += 0.03; // +3% –∑–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é –ø–ª–æ—â–∞–¥—å –Ω–∞ –∫–æ–º–Ω–∞—Ç—É
    } else if (areaPerRoom < 15) {
      score -= 0.05; // -5% –∑–∞ —Ç–µ—Å–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É
    }
  }
  
  return Math.max(0.7, Math.min(1.3, score)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω 0.7-1.3
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors) {
  const qualityScore = calculateQualityScore(objectData);
  const hasSoldData = soldCompetitors.length > 0;
  const hasActiveData = activeCompetitors.length > 0;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  const marketSituation = assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, objectData[1]);
  
  // –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
  let baseSoldPrice, baseActivePrice, baseMarketPrice;
  const objectArea = Number(objectData[4]) || 1; // –ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞
  
  if (hasSoldData) {
    baseSoldPrice = marketRatios.avgSoldPrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    baseSoldPrice = calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation);
  }
  
  if (hasActiveData) {
    baseActivePrice = marketRatios.avgActivePrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∫–∞–∫ –±–∞–∑—É
    baseActivePrice = objectPrice;
  }
  
  // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
  baseMarketPrice = baseSoldPrice || baseActivePrice || objectPrice;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞
  const forecasts = calculateForecastsByPosition(
    objectPrice, 
    baseSoldPrice, 
    baseActivePrice, 
    baseMarketPrice,
    qualityScore,
    marketSituation,
    activeCompetitors,
    soldCompetitors,
    demandPerMonth
  );
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
  const timeForecasts = calculateTimeForecasts(
    {...forecasts, position: calculateObjectPosition(objectPrice, activeCompetitors)}, 
    demandPerMonth, 
    marketSituation,
    activeCompetitors.length,
    soldCompetitors.length
  );
  
  return {
    ...forecasts,
    ...timeForecasts,
    qualityScore,
    marketSituation
  };
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.
 * @param {boolean} hasSoldData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö.
 * @param {boolean} hasActiveData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {string} district –†–∞–π–æ–Ω.
 * @returns {Object} –û–ø–∏—Å–∞–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 */
function assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, district) {
  if (!hasSoldData && !hasActiveData) {
    return {
      type: 'NO_DATA',
      description: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑ —Å–æ—Å–µ–¥–Ω–∏—Ö —Ä–∞–π–æ–Ω–æ–≤'
    };
  }
  
  if (!hasSoldData && hasActiveData) {
    return {
      type: 'NO_SALES',
      description: '–ù–µ—Ç –ø—Ä–æ–¥–∞–∂ –≤ —Ä–∞–π–æ–Ω–µ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      riskLevel: 'MEDIUM',
      recommendation: '–†—ã–Ω–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –≤–æ–∑–º–æ–∂–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  if (hasSoldData && !hasActiveData) {
    return {
      type: 'NO_ACTIVE',
      description: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'LOW',
      recommendation: '–ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–º–∏–∞–ª—å–Ω—É—é —Ü–µ–Ω—É'
    };
  }
  
  if (demandPerMonth < 0.5) {
    return {
      type: 'LOW_DEMAND',
      description: '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  return {
    type: 'NORMAL',
    description: '–û–±—ã—á–Ω–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è',
    riskLevel: 'LOW',
    recommendation: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–µ–Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã'
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation) {
  // –ë–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
  const typeMultipliers = {
    '–ö–≤–∞—Ä—Ç–∏—Ä–∞': 1.0,
    '–°—Ç—É–¥–∏—è': 0.85,
    '–î–æ–º': 1.2,
    '–¢–∞—É–Ω—Ö–∞—É—Å': 1.1
  };
  
  const objectType = objectData[2] || '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
  const baseMultiplier = typeMultipliers[objectType] || 1.0;
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  let situationMultiplier = 1.0;
  switch (marketSituation.type) {
    case 'NO_DATA':
      situationMultiplier = 0.9; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 10% –∏–∑-–∑–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏
      break;
    case 'LOW_DEMAND':
      situationMultiplier = 0.85; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 15% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Å–ø—Ä–æ—Å–∞
      break;
    case 'NO_ACTIVE':
      situationMultiplier = 1.05; // –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ 5% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
      break;
  }
  
  return objectPrice * baseMultiplier * situationMultiplier;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} baseSoldPrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {number} baseActivePrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} baseMarketPrice –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞.
 * @param {number} qualityScore –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {Object} –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateForecastsByPosition(objectPrice, baseSoldPrice, baseActivePrice, baseMarketPrice, qualityScore, marketSituation, activeCompetitors, soldCompetitors, demandPerMonth) {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const position = calculateObjectPosition(objectPrice, activeCompetitors);
  const totalCompetitors = activeCompetitors.length;
  
  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏
  let positionMultiplier = 1.0;
  if (totalCompetitors > 0) {
    const positionRatio = position / (totalCompetitors + 1);
    if (positionRatio <= 0.2) {
      // –í —Ç–æ–ø-20% - –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 1.05;
    } else if (positionRatio >= 0.8) {
      // –í –Ω–∏–∂–Ω–∏—Ö 20% - —Å–∫–∏–¥–æ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 0.95;
    }
  }
  
  // –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤)
  let basePrice;
  if (baseSoldPrice > 0) {
    basePrice = baseSoldPrice * qualityScore * positionMultiplier;
  } else if (baseActivePrice > 0) {
    basePrice = baseActivePrice * qualityScore * positionMultiplier;
  } else {
    basePrice = objectPrice * qualityScore * positionMultiplier;
  }
  
  // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ - —Å–∞–º–∞—è –Ω–∏–∑–∫–∞—è —Ü–µ–Ω–∞ (—Å–∫–∏–¥–∫–∞ 10-15%)
  let quickPrice = basePrice * 0.87; // 13% —Å–∫–∏–¥–∫–∞ –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω—ã
  
  // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ - –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
  let marketPrice = basePrice;
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø—Ä–æ—Å–∞
  if (activeCompetitors.length > 0 && demandPerMonth > 0) {
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ü–µ–Ω–µ
    const sortedActivePrices = activeCompetitors
      .map(row => Number(row[5]) || 0)
      .filter(p => p > 0)
      .sort((a, b) => a - b);
    
    if (sortedActivePrices.length > 0) {
      // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—É, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º –ø–æ–ø–∞—Å—Ç—å –≤ —Ç–æ–ø –ø–æ —Å–ø—Ä–æ—Å—É
      const demandPosition = Math.min(Math.ceil(demandPerMonth), sortedActivePrices.length);
      const competitivePrice = sortedActivePrices[demandPosition - 1] * 0.98;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é —Ü–µ–Ω—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏
      quickPrice = Math.min(quickPrice, competitivePrice);
    }
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
  const quickPosition = calculateObjectPosition(quickPrice, activeCompetitors);
  const marketPosition = calculateObjectPosition(marketPrice, activeCompetitors);

  return {
    quickPrice: Math.round(quickPrice),
    marketPrice: Math.round(marketPrice),
    position,
    quickPosition,
    marketPosition,
    positionMultiplier
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ calculateObjectRank).
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –ü–æ–∑–∏—Ü–∏—è (1 = —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π).
 */
function calculateObjectPosition(objectPrice, activeCompetitors) {
  if (activeCompetitors.length === 0) return 1;
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö —Ü–µ–Ω (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã + –Ω–∞—à –æ–±—ä–µ–∫—Ç)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Ü–µ–Ω–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–æ–ª–±—Ü–µ 5 (–∏–Ω–¥–µ–∫—Å 5)
  const competitorPrices = activeCompetitors.map(c => Number(c[5]) || 0).filter(p => p > 0);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –Ω–∞—à –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const hasOurObject = competitorPrices.some(price => price === objectPrice);
  
  // –ï—Å–ª–∏ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
  const allActivePrices = hasOurObject 
    ? competitorPrices 
    : [...competitorPrices, objectPrice];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
  allActivePrices.sort((a, b) => a - b);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é: —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å + 1
  const position = 1 + allActivePrices.filter(p => p < objectPrice).length;
  
  return position;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤ –ø—Ä–æ–¥–∞–∂–∏.
 * @param {Object} forecasts –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeForecasts(forecasts, demandPerMonth, marketSituation, activeCount, soldCount) {
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–Ω–≥–∞ –æ–±—ä–µ–∫—Ç–∞ –∏ —Å–ø—Ä–æ—Å–∞
  let quickMonths, marketMonths;
  
  if (demandPerMonth > 0) {
    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞: —Ä–∞–Ω–≥ –ø–æ –Ω–æ–≤–æ–π —Ü–µ–Ω–µ / —Å–ø—Ä–æ—Å
    // –î–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º calculated rank –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ —ç–≤—Ä–∏—Å—Ç–∏–∫—É
    const quickRank = forecasts.quickPosition || forecasts.position || 1;
    quickMonths = Math.ceil(quickRank / demandPerMonth);
    
    // –†—ã–Ω–æ—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞: —Ä–∞–Ω–≥ –ø–æ —Ä—ã–Ω–æ—á–Ω–æ–π —Ü–µ–Ω–µ / —Å–ø—Ä–æ—Å
    const marketRank = forecasts.marketPosition || forecasts.position || 1;
    marketMonths = Math.ceil(marketRank / demandPerMonth);
  } else {
    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –ª–æ–≥–∏–∫—É
    const baseMonths = calculateAlternativeTime(activeCount, soldCount, marketSituation);
    quickMonths = Math.ceil(baseMonths * 0.7);
    marketMonths = Math.ceil(baseMonths * 1.0);
  }
  
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ - 1 –º–µ—Å—è—Ü
  quickMonths = Math.max(1, quickMonths);
  marketMonths = Math.max(1, marketMonths);
  
  return {
    quickMonths,
    marketMonths
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ë–∞–∑–æ–≤—ã–π —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 */
function calculateAlternativeTime(activeCount, soldCount, marketSituation) {
  if (marketSituation.type === 'NO_ACTIVE') {
    return 3; // –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'LOW_DEMAND') {
    return 12; // –ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å - –¥–æ–ª–≥–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'NO_DATA') {
    return 8; // –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å - —Å—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫
  }
  
  // –û–±—ã—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
  if (activeCount > 0) {
    return Math.max(2, Math.min(8, activeCount * 0.5)); // 0.5 –º–µ—Å—è—Ü–∞ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
  }
  
  return 6; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 */
function createCriteriaSheet() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–∏—Å—Ç
    let sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    
    if (!sheet) {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
      sheet = SPREADSHEET.insertSheet('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω');
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–†–∞–π–æ–Ω', ''],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ü–ª–æ—â–∞–¥—å', ''],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', ''],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', '']
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‚úÖ –õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
    Logger.log('–õ–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ createCriteriaSheet: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ' + e.message);
  }
}

/**
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–∞ –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 */
function writeCompetitorCriteria(objectData, criteria) {
  try {
    const sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (!sheet) {
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
      ['–†–∞–π–æ–Ω', objectData[1]],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', objectData[2]],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', objectData[3]],
      ['–ü–ª–æ—â–∞–¥—å', objectData[4]],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', objectData[6]],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', objectData[10]],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 0.8)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 1.2)],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear - 10],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear + 10],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', Math.max(0, criteria.rooms - 1)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', criteria.rooms + 1],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', new Date().toLocaleString('ru-RU')]
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    Logger.log('–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ª–∏—Å—Ç');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ writeCompetitorCriteria: ${e.stack}`);
  }
}

/**
 * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 */
function clearAnalysisData() {
  try {
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" (–æ—Ç—á–µ—Ç)
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (analyticsSheet) {
      analyticsSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    const analysisSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
    if (analysisSheet) {
      analysisSheet.getRange('A3:AQ1000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
    if (competitorsSheet) {
      competitorsSheet.getRange('A3:L1000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"
    const criteriaSheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (criteriaSheet) {
      criteriaSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    Logger.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—á–∏—â–µ–Ω—ã');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞: ${e.stack}`);
  }
}

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —è—á–µ–π–∫–∏ B2 –≤ –ª–∏—Å—Ç–µ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É".
 * @param {Event} e –°–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
function onEditTrigger(e) {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –Ω—É–∂–Ω–æ–º –ª–∏—Å—Ç–µ –∏ —è—á–µ–π–∫–µ
    if (e.range.getSheet().getName() === SHEETS.SINGLE_OBJECT_ANALYTICS && 
        e.range.getA1Notation() === 'B2') {
      
      const objectCode = e.value;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –Ω–µ –ø—É—Å—Ç–æ–π
      if (objectCode && String(objectCode).trim() !== '') {
        Logger.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analyzeSingleObjectByCode(String(objectCode).trim());
      } else {
        // –ï—Å–ª–∏ –∫–æ–¥ –ø—É—Å—Ç–æ–π –∏–ª–∏ —É–¥–∞–ª–µ–Ω - –æ—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        Logger.log('–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ —É–¥–∞–ª–µ–Ω, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞');
        clearAnalysisData();
      }
    }
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ onEditTrigger: ${error.stack}`);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram –±–æ—Ç–∞ (Webhook).
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function doPost(e) {
  try {
    return processBotRequest(e);
  } catch (error) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ doPost: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –±–æ—Ç–∞.
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function processBotRequest(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No data' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const contents = JSON.parse(e.postData.contents);
    const objectCode = contents.objectCode;
    
    if (!objectCode) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No object code' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç –±–æ—Ç–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞
    const analysisText = getAnalysisTextForBot(objectCode.toString().trim());
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: 'success', 
      text: analysisText 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ processBotRequest: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –±–æ—Ç–∞ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {string} –¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 */
function getAnalysisTextForBot(objectCode) {
  try {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      return `‚ùå –û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–¥–∞.`;
    }
    
    // 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData);
    if (competitorsData.activeCompetitors.length === 0 && competitorsData.soldCompetitors.length === 0) {
      return `‚ö†Ô∏è –î–ª—è –æ–±—ä–µ–∫—Ç–∞ ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –ê–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.`;
    }
    
    // 3. –ê–Ω–∞–ª–∏–∑ (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ª–∏—Å—Ç, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É)
    const advertisingData = getAdvertisingData(objectCode);
    const result = calculateSingleObjectMetrics(objectData, competitorsData.activeCompetitors, competitorsData.soldCompetitors, advertisingData);
    
    // 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ò–ò –æ—Ç—á–µ—Ç–∞)
    // –û–Ω–∞ –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Gemini
    const reportText = createSingleObjectReportText(objectData, result, competitorsData);
    
    return reportText;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ getAnalysisTextForBot: ${e.stack}`);
    return `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ${e.message}`;
  }
}