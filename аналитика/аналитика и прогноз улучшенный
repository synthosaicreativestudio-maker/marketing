/**
 * –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
 * –í–µ—Ä—Å–∏—è 3.1.0 (–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–æ–≤ –∏ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å)
 *
 * –ò–∑–º–µ–Ω–µ–Ω–∏—è:
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName is not a function –≤ setAdditionalHeaders,
 *    –ø—É—Ç–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SPREADSHEET.getSheetByName() –≤–º–µ—Å—Ç–æ SpreadsheetApp.getSheetByName().
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ SyntaxError: Unexpected token ')' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ buildReportSummaries.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–ø–µ—á–∞—Ç–∫–∞ 'SPREADSheetApp' –Ω–∞ 'SpreadsheetApp' –≤ —Ñ—É–Ω–∫—Ü–∏–∏ setAdditionalHeaders.
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ ReferenceError: allObjectsPlusAnalytics is not defined –≤ findCompetitorsForAllObjects
 *    –ø—É—Ç–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è dataMap –∏–∑ objectRow (—Å—Ç–æ–ª–±—Ü—ã A:O).
 *  - [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –ª–∏—Å—Ç–∞ "3. 56. –∞–≤–∏—Ç–æ" –≤ —Å—Ç–æ–ª–±—Ü—ã P-Q –Ω–∞ –ª–∏—Å—Ç–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ".
 *  - [–õ–û–ì–ò–ö–ê] –ó–∞–º–µ–Ω–µ–Ω "–ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏, %" –Ω–∞ "–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏" (A+, A, B, C, C-).
 *  - [–§–£–ù–ö–¶–ò–Ø] –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è getLiquidityType –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 *  - [–û–¢–ß–ï–¢] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–¢–∏–ø–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏".
 *  - [–ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –∫–æ–¥–∞, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞ –≤—ã–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 *  - [–ê–†–•–ò–¢–ï–ö–¢–£–†–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –ª–∏–Ω–µ–π–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å–∞–º—ã–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è.
 *  - [–õ–û–ì–ò–ö–ê] –£–ª—É—á—à–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø—É —Ä–µ–º–æ–Ω—Ç–∞.
 *  - [–õ–û–ì–ò–ö–ê] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ formatCompetitorRow –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 *  - [TODO] –í–µ—Ä–Ω—É—Ç—å –≤ –æ—Ç—á–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ "—Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏ –∫ —Ü–µ–Ω–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è" –∏ "—Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ + —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏"
 *    –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª–µ–π –≤ –ª–∏—Å—Ç—ã –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 */

// ================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ==================

const SPREADSHEET = SpreadsheetApp.getActiveSpreadsheet();
const SETTINGS_SHEET_NAME = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
const IS_DEBUG = true; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤ false –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
const ANALYSIS_SETTINGS = {
  PERIOD_MONTHS_CELL: 'B8', // ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏!B8: "–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞, –º–µ—Å"
  DEFAULT_PERIOD_MONTHS: 6
};
// –¶–µ–ª–µ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã –¥–ª—è —Ü–µ–Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (–≤ –º–µ—Å—è—Ü–∞—Ö) –∏ undercut –¥–ª—è –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ —Ü–µ–ª–µ–≤–æ–π —Ä–∞–Ω–≥
const STRATEGY_TARGET_MONTHS = { QUICK: 1, MARKET: 3 }; // –û–∫–Ω–æ –Ω–∞ 1 –∏ 3 –º–µ—Å—è—Ü–∞
const STRATEGY_UNDERCUT = { QUICK: 0.98, MARKET: 1.0 }; // 2% –∑–∞–ø–∞—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏
const BATCH_SIZE = 50; // –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –∞–Ω–∞–ª–∏–∑–µ
const HEADER_CACHE_TTL = 6 * 60 * 60; // 6 —á–∞—Å–æ–≤

const STALE_LISTING_MONTHS = 6;
const TRIM_PERCENTAGE = 0.1;

const SHEETS = {
  MAIN_ANALYTICS: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤—Å–µ—Ö –û–ù –≤ –≥—Ä—É–ø–ø–µ',
  COMPETITORS: '–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  ADDRESS_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É',
  ACTIVE_GROUP: '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ',
  AVITO: '3. 56. –∞–≤–∏—Ç–æ', CIAN: '5. 56. —Ü–∏–∞–Ω', DOMCLICK: '6. 56. –¥–æ–º–∫–ª–∏–∫',
  ACTIVE_COMPETITORS: '2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ',
  SOLD_COMPETITORS: '1. 2. –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ',
  // –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
  SINGLE_OBJECT_ANALYTICS: '–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É',
  SINGLE_OBJECT_ANALYSIS: '–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞',
  SINGLE_COMPETITORS: '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞',
};

// ================== –ö–ê–õ–ò–ë–†–û–í–ê–ù–ù–´–ï –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–´ –ö–ê–ß–ï–°–¢–í–ê (v1.0) ==================
// –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ 13,490 —Å–¥–µ–ª–æ–∫
const QUALITY_COEFFICIENTS = {
  // –†–µ–º–æ–Ω—Ç
  REPAIR_DESIGNER: 0.12,    // –î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç: +12%
  REPAIR_EURO: 0.08,        // –ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç: +8%
  REPAIR_MODERN: 0.06,      // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç: +6%
  REPAIR_COSMETIC: 0,       // –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π: 0%
  REPAIR_NEEDS_WORK: -0.12, // –¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞: -12%
  REPAIR_OLD: -0.15,        // –°—Ç–∞—Ä—ã–π/—É–±–∏—Ç—ã–π: -15%
  
  // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
  BUILDING_NEW: 0.06,       // –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞ (< 5 –ª–µ—Ç): +6%
  BUILDING_MODERN: 0.03,    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π (5-15 –ª–µ—Ç): +3%
  BUILDING_NORMAL: 0,       // –û–±—ã—á–Ω—ã–π (15-40 –ª–µ—Ç): 0%
  BUILDING_OLD: -0.04,      // –°—Ç–∞—Ä—ã–π (> 40 –ª–µ—Ç, –ø–æ—Å–ª–µ 1980): -4%
  BUILDING_VERY_OLD: -0.08, // –û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–π (–¥–æ 1980): -8%
  
  // –≠—Ç–∞–∂
  FLOOR_FIRST: -0.05,       // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂: -5%
  FLOOR_LAST: -0.03,        // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂: -3%
  FLOOR_MIDDLE: 0.02,       // –°—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏: +2%
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
  HAS_PROF_PHOTO: 0.02,     // –ü—Ä–æ—Ñ. —Ñ–æ—Ç–æ: +2%
  HAS_GOOD_DESC: 0.01,      // –û–ø–∏—Å–∞–Ω–∏–µ > 400 —Å–∏–º–≤–æ–ª–æ–≤: +1%
  HAS_FLOOR_PLAN: 0.01      // –ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞: +1%
};

// ================== –°–ï–ó–û–ù–ù–´–ï –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–´ (–¢—é–º–µ–Ω—å, v1.0) ==================
// –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤–ª–∏—è–Ω–∏—è –Ω–∞ —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (1 = –±–∞–∑–æ–≤—ã–π, >1 = –¥–æ–ª—å—à–µ, <1 = –±—ã—Å—Ç—Ä–µ–µ)
const SEASONAL_COEFFICIENTS = {
  1: 1.20,  // –Ø–Ω–≤–∞—Ä—å: +20% –∫ —Å—Ä–æ–∫—É (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
  2: 1.10,  // –§–µ–≤—Ä–∞–ª—å: +10%
  3: 0.95,  // –ú–∞—Ä—Ç: -5% (–Ω–∞—á–∞–ª–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  4: 0.85,  // –ê–ø—Ä–µ–ª—å: -15% (–≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å)
  5: 0.80,  // –ú–∞–π: -20% (–ø–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  6: 0.85,  // –ò—é–Ω—å: -15%
  7: 0.95,  // –ò—é–ª—å: -5% (–æ—Ç–ø—É—Å–∫–∞)
  8: 0.90,  // –ê–≤–≥—É—Å—Ç: -10%
  9: 0.85,  // –°–µ–Ω—Ç—è–±—Ä—å: -15% (–≤–æ–∑–≤—Ä–∞—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  10: 0.90, // –û–∫—Ç—è–±—Ä—å: -10%
  11: 1.00, // –ù–æ—è–±—Ä—å: –±–∞–∑–æ–≤—ã–π
  12: 1.15  // –î–µ–∫–∞–±—Ä—å: +15% (–ø—Ä–∞–∑–¥–Ω–∏–∫–∏)
};

// ================== –°–õ–û–í–ê–†–¨ –ü–û–õ–ï–ô (–ï–î–ò–ù–û–ï –°–û–ü–û–°–¢–ê–í–õ–ï–ù–ò–ï –ö–û–õ–û–ù–û–ö) ==================
const FIELD_ALIASES = {
  date: ['–¥–∞—Ç–∞', '–¥–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏', '–¥–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ', '–¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏', '–¥–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏'],
  publishDate: ['–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', '–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è'],
  district: ['—Ä–∞–π–æ–Ω'],
  objectType: ['—Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞', '—Ç–∏–ø'],
  rooms: ['–∫–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–∫–æ–º–Ω–∞—Ç'],
  area: ['–ø–ª–æ—â–∞–¥—å', '–ø–ª.'],
  code: ['–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–∫–æ–¥', 'id', '–Ω–æ–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞', '—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', 'id –æ–±—ä–µ–∫—Ç–∞'],
  repair: ['—Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '—Ä–µ–º–æ–Ω—Ç'],
  price: ['—Ü–µ–Ω–∞', '—Å—Ç–æ–∏–º–æ—Å—Ç—å', 'price'],
  profPhoto: ['–Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', '–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', '—Ñ–æ—Ç–æ'],
  description400: ['–æ–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400', '–æ–ø–∏—Å–∞–Ω–∏–µ > 400', '–æ–ø–∏—Å–∞–Ω–∏–µ'],
  layout: ['–µ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞'],
  floor: ['—ç—Ç–∞–∂'],
  floors: ['—ç—Ç–∞–∂–Ω–æ—Å—Ç—å', '–∫–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π', '—ç—Ç–∞–∂–µ–π'],
  buildYear: ['–≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–≥–æ–¥'],
  link: ['—Å—Å—ã–ª–∫–∞', '—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', 'url', 'link'],
  status: ['—Å—Ç–∞—Ç—É—Å', '—Å—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è', '—Å—Ç–∞—Ç—É—Å –≤—ã–≥—Ä—É–∑–∫–∏'],
  houseCondition: ['—Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞'],
  realtor: ['—Ä–∏—ç–ª—Ç–æ—Ä', '–∞–≥–µ–Ω—Ç', '–º–µ–Ω–µ–¥–∂–µ—Ä']
};

// ================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==================

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Google –¢–∞–±–ª–∏—Ü –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏.
 */
function onOpen() { try { SpreadsheetApp.getUi().createMenu('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑')
    .addItem('‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏', 'startAllFunctions')
    .addItem('üé® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –ª–∏—Å—Ç—ã', 'formatSheets')
    .addSeparator()
    .addItem('üîß –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã', 'setupNewSheets')
    .addItem('üìã –°–æ–∑–¥–∞—Ç—å –ª–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤', 'createCriteriaSheet')
    .addSeparator()
    .addSubMenu(SpreadsheetApp.getUi().createMenu('üîë API –ö–ª—é—á–∏ Gemini')
      .addItem('üîπ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á–∏', 'setDefaultApiKeys')
      .addSeparator()
      .addItem('üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–ª—é—á–µ–π', 'checkApiKeys'))
    .addSeparator()
    .addSubMenu(SpreadsheetApp.getUi().createMenu('üì¨ –û—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤')
      .addItem('‚ñ∂Ô∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –≤—Ä—É—á–Ω—É—é', 'processQueue')
      .addItem('‚è∞ –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫—É (1 –º–∏–Ω)', 'installQueueTrigger')
      .addItem('‚èπÔ∏è –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫—É', 'removeQueueTrigger'))
    .addSeparator()
    .addItem('‚è∞ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã', 'installTriggers')
    .addToUi(); } catch (e) { Logger.log(`–û—à–∏–±–∫–∞ –≤ onOpen: ${e.stack}`); } }

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç startAllFunctions –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00 –∏ 14:00.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç onEditTrigger –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞.
 */
function installTriggers() { try {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.getProjectTriggers().forEach(t => ScriptApp.deleteTrigger(t));
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 6:00 –∏ 14:00
    [6, 14].forEach(h => ScriptApp.newTrigger('startAllFunctions').timeBased().everyDays(1).atHour(h).nearMinute(0).inTimezone('Asia/Yekaterinburg').create());
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Å–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    ScriptApp.newTrigger('onEditTrigger').forSpreadsheet(SPREADSHEET).onEdit().create();
    
    // –í–∫–ª—é—á–∞–µ–º –æ—á–µ—Ä–µ–¥—å –±–æ—Ç–∞
    installQueueTrigger();

    Logger.log('–¢—Ä–∏–≥–≥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã/–ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.');
    try {
      SPREADSHEET.toast('‚úÖ –í—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –±–æ—Ç–∞) —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.', '–°–∏—Å—Ç–µ–º–∞');
    } catch (e) {}
} catch (e) { 
    Logger.log(`–û—à–∏–±–∫–∞ –≤ installTriggers: ${e.stack}`); 
    try {
      SPREADSHEET.toast('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.', '–û—à–∏–±–∫–∞');
    } catch (err) {}
} }

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Ç–µ–∫—É—â–∏—Ö API-–∫–ª—é—á–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 */
function checkApiKeys() {
  const ui = SpreadsheetApp.getUi();
  const keys = getGeminiKeyPool();
  
  const mask = (key) => {
    if (!key) return '‚ùå –ù–ï –£–°–¢–ê–ù–û–í–õ–ï–ù';
    if (key.length < 10) return '‚ö†Ô∏è –û—à–∏–±–∫–∞ (—Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π)';
    return `${key.substring(0, 6)}...${key.substring(key.length - 4)}`;
  };
  
  let msg = `–°—Ç–∞—Ç—É—Å API-–∫–ª—é—á–µ–π Gemini (${keys.length} —à—Ç.):\n\n`;
  if (keys.length > 0) {
    keys.forEach((k, i) => {
      msg += `${i+1}. ${mask(k)}\n`;
    });
    msg += '\nüîÑ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç –∫–ª—é—á, –µ—Å–ª–∏ –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è –∫–≤–æ—Ç—ã.';
  } else {
    msg = '‚ùå –ö–ª—é—á–∏ Gemini –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –Ω–∞ –ª–∏—Å—Ç–µ "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", –Ω–∏ –≤ —Å–≤–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞.';
  }
  
  ui.alert('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ API-–∫–ª—é—á–µ–π', msg, ui.ButtonSet.OK);
}

/**
 * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫, —Å–æ–∑–¥–∞–≤–∞—è –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 */

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª—é—á–∏ Gemini (–º–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
 */
function setDefaultApiKeys() {
  const ui = SpreadsheetApp.getUi();
  
  const response = ui.prompt('üîπ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ API-–∫–ª—é—á–µ–π Gemini', 
    '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–∏ API-–∫–ª—é—á–∏ Google Gemini (–µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ –∑–∞–ø—è—Ç–æ–π):', ui.ButtonSet.OK_CANCEL);
  
  if (response.getSelectedButton() == ui.Button.OK) {
    const rawKeys = response.getResponseText().trim();
    if (rawKeys.length > 10) {
      PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEYS', rawKeys);
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ä–æ—Ç–∞—Ü–∏–∏
      PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', '0');
      ui.alert('‚úÖ –ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    } else {
      ui.alert('‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–ª—é—á–µ–π.');
    }
  }
}

/**
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞—é—â–∞—è –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
 * –û–°–¢–ê–í–õ–ï–ù–ê –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö.
 */
function startAllFunctions() {
  if (IS_DEBUG) Logger.log('–ó–∞–ø—É—Å–∫ startAllFunctions...');
  const lock = LockService.getDocumentLock();
  if (!lock.tryLock(30000)) {
    Logger.log('‚ö†Ô∏è startAllFunctions: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.');
    return;
  }
  try {
    resetBatchState();
    clearSheets(); // –û—á–∏—Å—Ç–∫–∞ —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤
    copyFromActiveGroup(); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∞–∫—Ç–∏–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã
    copyFromSource(SHEETS.AVITO, 'P', ['–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –ê–≤–∏—Ç–æ –≤ P-Q
    copyFromSource(SHEETS.CIAN, 'R', ['—Ü–∏–∞–Ω', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –¶–∏–∞–Ω –≤ R-S
    copyFromSource(SHEETS.DOMCLICK, 'T', ['–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞']); // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –î–æ–º–∫–ª–∏–∫ –≤ T-U
    setAdditionalHeaders(); // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–Ω–∞—á–Ω–µ—Ç—Å—è —Å V)
    findCompetitorsForAllObjects(); // –û—Å–Ω–æ–≤–Ω–æ–π –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    if (IS_DEBUG) Logger.log('‚úÖ startAllFunctions —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.');
  } catch (e) {
    Logger.log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ startAllFunctions: ${e}\n${e.stack}`);
    setDashesOnError();
  } finally {
    lock.releaseLock();
  }
}

// ================== –§–£–ù–ö–¶–ò–ò –ü–û–î–ì–û–¢–û–í–ö–ò –î–ê–ù–ù–´–• ==================

/**
 * –û—á–∏—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –ª–∏—Å—Ç–æ–≤.
 */
function clearSheets() {
  const sheetsToClear = [ { name: SHEETS.MAIN_ANALYTICS, range: 'A6:AZ' }, { name: SHEETS.COMPETITORS, range: 'A2:N' }];
  sheetsToClear.forEach(s => { const sh = SPREADSHEET.getSheetByName(s.name); if (sh) sh.getRange(s.range).clearContent(); });
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A2').setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞'); 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
  }
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ª–∏—Å—Ç–∞ '4. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ' –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 */
function copyFromActiveGroup() {
    const sourceSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_GROUP); 
    const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sourceSheet || !targetSheet) return;
    
    const sourceRange = sourceSheet.getRange('A2:O' + sourceSheet.getLastRow()); 
    if (sourceRange.isBlank()) return;
    
    const sourceData = sourceRange.getValues();
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π "–ò—Ç–æ–≥–æ"
    const dataToCopy = sourceData.filter(row => row.some(cell => cell.toString().trim() !== '') && String(row[0]).toLowerCase().trim() !== '–∏—Ç–æ–≥–æ');
    
    if (dataToCopy.length === 0) { 
      if(targetSheet.getMaxRows() >= 6) targetSheet.getRange('A6:O6').setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
      return; 
    }
    
    const headers = [ ['‚Ññ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–ö–æ–¥', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', '–æ–ø–∏—Å–∞–Ω–∏–µ', '–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç'] ];
    targetSheet.getRange('A5:O5').setValues(headers); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    targetSheet.getRange(6, 1, dataToCopy.length, dataToCopy[0].length).setValues(dataToCopy); // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
}

/**
 * –ö–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ê–≤–∏—Ç–æ, –¶–∏–∞–Ω, –î–æ–º–∫–ª–∏–∫)
 * –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 * @param {string} sourceSheetName –ò–º—è –ª–∏—Å—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞.
 * @param {string} startColumn –ë—É–∫–≤–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {string[]} headers –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤.
 */
function copyFromSource(sourceSheetName, startColumn, headers) {
  const sourceSheet = SPREADSHEET.getSheetByName(sourceSheetName);
  const targetSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const endColumn = String.fromCharCode(startColumn.charCodeAt(0) + 1); // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, V -> W)
  
  if (!sourceSheet || !targetSheet) return;
  
  targetSheet.getRange(`${startColumn}5:${endColumn}5`).setValues([headers]); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  
  const lastSourceRow = sourceSheet.getLastRow();
  const lastTargetRow = targetSheet.getLastRow();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
  if (lastSourceRow < 2 || lastTargetRow < 6) return;

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –∏–º–µ–Ω–∞–º
  const headerRow = detectHeaderRow(sourceSheet, 10);
  const headerValues = sourceSheet.getRange(headerRow, 1, 1, sourceSheet.getLastColumn()).getValues()[0];
  const headerMap = buildHeaderIndexMap(headerValues);

  let codeCol = getColumnIndexByField(headerMap, 'code', ['—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç']);
  if (!codeCol) codeCol = getColumnIndexByKeywords(headerMap, ['–∫–æ–¥', 'id', '–Ω–æ–º–µ—Ä', '–æ–±—ä–µ–∫—Ç']);
  if (!codeCol) codeCol = 2; // fallback: B
  const statusCol = getColumnIndexByField(headerMap, 'status', [
    sheetName.replace(/\d+\.\s*/g, '').trim()
  ]) || 3; // fallback: C
  const dateCol = getColumnIndexByField(headerMap, 'publishDate', [
    '–¥–∞—Ç–∞', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
    '–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'date'
  ]) || 4; // fallback: D

  const dataStartRow = headerRow + 1;
  if (dataStartRow > lastSourceRow) return;

  const sourceData = sourceSheet.getRange(dataStartRow, 1, lastSourceRow - dataStartRow + 1, sourceSheet.getLastColumn()).getValues();
  const targetCodes = targetSheet.getRange('F6:F' + lastTargetRow).getValues().flat();

  const sourceMap = new Map(
    sourceData.map(row => [
      String(row[codeCol - 1]).trim(),
      [row[statusCol - 1] || '-', row[dateCol - 1] || '-']
    ])
  );

  const outputData = targetCodes.map(code => sourceMap.get(String(code).trim()) || ['-', '-']);
  if (outputData.length > 0) {
    targetSheet.getRange(6, startColumn.charCodeAt(0) - 64, outputData.length, 2).setValues(outputData);
  }
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ.
 */
function setAdditionalHeaders() {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ TypeError: SpreadsheetApp.getSheetByName –Ω–∞ SPREADSHEET.getSheetByName
    const sheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
    if (!sheet) return;
    
    const headers = [[
        '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', 
        '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –ø–æ —Ü–µ–Ω–µ –º¬≤', '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %',
        '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %',
        '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.', '–ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –º–µ—Å.'
    ]];
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —Å—Ç–æ–ª–±—Ü–∞ V, –ø–æ—Å–ª–µ P-Q (Avito), R-S (Cian), T-U (Domclick)
    sheet.getRange('V5:AQ5').setValues(headers); 
}

// ================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏
 * –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ".
 */
function findCompetitorsForAllObjects() {
  if (IS_DEBUG) Logger.log('–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è findCompetitorsForAllObjects...');
  
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  
  if (!analyticsSheet || !activeSheet || !soldSheet || !competitorsSheet) { 
    setDashesOnError(); // –ï—Å–ª–∏ –ª–∏—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ
    return; 
  }
  
  const lastRow = analyticsSheet.getLastRow();
  if (lastRow < 6) return; // –ï—Å–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º –ª–∏—Å—Ç–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—Ü—ã A:O)
  const objectsData = analyticsSheet.getRange('A6:O' + lastRow).getValues();
  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏)
  const activeDataResult = readSheetDataWithHeader(activeSheet);
  const soldDataResult = readSheetDataWithHeader(soldSheet);
  const activeData = activeDataResult.rows;
  const soldData = soldDataResult.rows;
  const activeHeaderMap = activeDataResult.headerMap;
  const soldHeaderMap = soldDataResult.headerMap;

  // –û–∫–Ω–æ –∞–Ω–∞–ª–∏–∑–∞ (–µ–¥–∏–Ω–æ–µ)
  const { startDate, endDate, months } = getAnalysisWindow(analyticsSheet);
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ —Ä–∞–π–æ–Ω–∞–º
  const activeByDistrict = groupDataByDistrict(activeData, activeHeaderMap);
  const soldByDistrict = groupDataByDistrict(soldData, soldHeaderMap);
  
  const districtCache = {}; // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º
  
  let analyticsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –ª–∏—Å—Ç–∞
  let competitorsOutput = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  const competitorHeaders = ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ A:O –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –¥–ª—è dataMap
  const objectHeaders = analyticsSheet.getRange('A5:O5').getValues()[0];

  // –ë–∞—Ç—á–∏–Ω–≥ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
  const batchOffset = getBatchOffset();
  const batchObjects = objectsData.slice(batchOffset, batchOffset + BATCH_SIZE);

  // –ò—Ç–µ—Ä–∏—Ä—É–µ–º—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É –æ–±—ä–µ–∫—Ç—É —Ç–µ–∫—É—â–µ–≥–æ –±–∞—Ç—á–∞
  batchObjects.forEach((objectRow, index) => {
    try {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
      const district = objectRow[1], type = objectRow[2], rooms = Number(objectRow[3]), area = Number(objectRow[4]), code = String(objectRow[5]), price = Number(objectRow[7]);
      const pricePerM2 = area > 0 ? Math.floor(price / area) : 0;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!district || !code || !area || area <= 0 || !price || price <= 0) { 
        analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
        return; 
      }
      
      const repair = objectRow[6], buildYear = Number(objectRow[10]) || null;
      
      // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω—É –µ—â–µ –Ω–µ—Ç –≤ –∫—ç—à–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Ö
      if (!districtCache[district]) {
        districtCache[district] = processDistrictData({ 
          type, rooms, area, repair, buildYear, 
          activeCandidates: activeByDistrict[district] || [], 
          soldCandidates: soldByDistrict[district] || [], 
          startDate, endDate, months,
          activeHeaderMap, soldHeaderMap
        });
      }
      const cache = districtCache[district]; // –ü–æ–ª—É—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–π–æ–Ω—É

      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º dataMap –∏–∑ objectRow (A:O) –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
      // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç ReferenceError, —Ç–∞–∫ –∫–∞–∫ allObjectsPlusAnalytics –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–¥–µ—Å—å.
      const dataMap = {};
      objectHeaders.forEach((h, i) => dataMap[h] = objectRow[i]);

      // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –æ–±—ä–µ–∫—Ç–∞
      const metrics = calculateObjectMetrics({ price, pricePerM2, activeCompetitors: cache.activeCompetitors, avgActivePriceTrimmed: cache.avgActivePriceTrimmed, avgSoldPriceMedian: cache.avgSoldPriceMedian, avgSalesPerMonth: cache.avgSalesPerMonth });
      // –†–∞—Å—á–µ—Ç —Ü–µ–Ω–æ–≤–æ–π –≤–∏–ª–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
      const priceFork = calculatePriceFork({ 
        price, 
        objectData: objectRow, 
        activePrices: cache.activePrices, 
        activeCompetitors: cache.activeCompetitors,
        avgSalesPerMonth: cache.avgSalesPerMonth, 
        avgSoldPriceMedian: cache.avgSoldPriceMedian,
        avgNewObjectsPerMonth: cache.avgNewObjectsPerMonth,
        dataMap: dataMap 
      });
      const timeOnMarketForecasts = calculateTimeOnMarket({ 
        soldCompetitors: cache.soldCompetitors, 
        avgPrice: cache.avgSoldPriceMedian, 
        rank: metrics.rankByPrice, 
        avgSalesPerMonth: cache.avgSalesPerMonth,
        avgNewObjectsPerMonth: cache.avgNewObjectsPerMonth, // [B3] –î–ª—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞
        price: price,                                         // [B4] –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–∏ –¥–µ—à–µ–≤–ª–µ
        activePrices: cache.activePrices                      // [B4] –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ–ª–∏ –¥–µ—à–µ–≤–ª–µ
      });

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞
      analyticsOutput.push([
        cache.activeCompetitors.length, 
        cache.soldCompetitors.length, 
        cache.avgSalesPerMonth, 
        cache.avgNewObjectsPerMonth, // –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
        determineLiquidityType(cache.activeCompetitors.length, cache.soldCompetitors.length, cache.avgSalesPerMonth), // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
        getMarketAssessment(cache.liquidityIndex, cache.avgSalesPerMonth), // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å
        cache.competitionTrend,
        metrics.rankByPrice, cache.priceTrendPerMonth, metrics.activeRatioPercent, metrics.soldRatioPercent,
        cache.avgActivePriceTrimmed, price, metrics.priceDiffPercentActive,
        cache.avgSoldPriceMedian, price, metrics.priceDiffPercentSold,
        priceFork.aggressive, timeOnMarketForecasts.fast, priceFork.market, timeOnMarketForecasts.market,
        metrics.inventoryMonths
      ]);

      // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª–∏—Å—Ç–∞ "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
      // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∫–∞–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
      const ourObjectAsCompetitor = [
          code,
          district, type, rooms, area, price, pricePerM2, // –ö–æ–¥, –†–∞–π–æ–Ω, –¢–∏–ø, –ö–æ–º–Ω–∞—Ç—ã, –ü–ª–æ—â–∞–¥—å, –¶–µ–Ω–∞, –¶–µ–Ω–∞ –∑–∞ –º¬≤
          '-', // –°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π (placeholder)
          objectRow[14], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç (–ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ —Å—Ç–æ–ª–±–µ—Ü O)
          repair, // –†–µ–º–æ–Ω—Ç
          '–ù–∞—à –æ–±—ä–µ–∫—Ç', // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞ (placeholder)
          `${objectRow[8]}/${objectRow[9]}`, // –≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å
          buildYear // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
      ];
      
      const normalizeOutputRow = (row) => (row.length > 13 ? row.slice(0, 13) : row);
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –Ω–∞—à –æ–±—ä–µ–∫—Ç) –ø–æ —Ü–µ–Ω–µ
      const activeSorted = [...cache.activeCompetitors.map(normalizeOutputRow), ourObjectAsCompetitor]
        .sort((a, b) => (a[5] || Infinity) - (b[5] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ –æ–±—â–∏–π –≤—ã–≤–æ–¥
      competitorsOutput.push([`–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...activeSorted, []);
      
      const soldSorted = [...cache.soldCompetitors.map(normalizeOutputRow)]
        .sort((a, b) => (a[5] || Infinity) - (b[5] || Infinity));
      // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if(soldSorted.length > 0) competitorsOutput.push([`–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–û–ù –∫–æ–¥: ${code})`], competitorHeaders, ...soldSorted, []);
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
      competitorsOutput.push([]);

    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–±—ä–µ–∫—Ç–∞ –≤ —Å—Ç—Ä–æ–∫–µ ${index + 6}: ${e.stack}`);
      analyticsOutput.push(createDashRow(22)); // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∏—Ä–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    }
  });

  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  if (analyticsOutput.length > 0) {
    analyticsSheet.getRange(6 + batchOffset, 22, analyticsOutput.length, 22).setValues(analyticsOutput);
  }
  
  // --- –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –ª–∏—Å—Ç "–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ" ---
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (competitorsOutput.length > 0) {
    if (batchOffset === 0) {
      competitorsSheet.getRange('A2:N' + competitorsSheet.getMaxRows()).clearContent();
    }
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (—É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç 13 —Å—Ç–æ–ª–±—Ü–æ–≤)
    const formattedCompetitors = formatForBatchWrite(competitorsOutput, 13);
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ –ª–∏—Å—Ç
    const startRow = Math.max(2, competitorsSheet.getLastRow() + 1);
    competitorsSheet.getRange(startRow, 1, formattedCompetitors.length, formattedCompetitors[0].length).setValues(formattedCompetitors);
  }

  // –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–∞—Ç—á–∞ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
  const nextOffset = batchOffset + batchObjects.length;
  if (nextOffset < objectsData.length) {
    scheduleNextBatch(nextOffset);
  } else {
    resetBatchState();
  }
}

// ================== –ë–ê–¢–ß–ò–ù–ì –î–õ–Ø –ú–ê–°–°–û–í–û–ì–û –ê–ù–ê–õ–ò–ó–ê ==================

function getBatchOffset() {
  return parseInt(PropertiesService.getScriptProperties().getProperty('ANALYSIS_BATCH_OFFSET') || '0');
}

function setBatchOffset(offset) {
  PropertiesService.getScriptProperties().setProperty('ANALYSIS_BATCH_OFFSET', String(offset || 0));
}

function clearBatchTriggers() {
  ScriptApp.getProjectTriggers()
    .filter(t => t.getHandlerFunction && t.getHandlerFunction() === 'continueBatchProcessing')
    .forEach(t => ScriptApp.deleteTrigger(t));
}

function resetBatchState() {
  setBatchOffset(0);
  clearBatchTriggers();
}

function scheduleNextBatch(nextOffset) {
  setBatchOffset(nextOffset);
  clearBatchTriggers();
  ScriptApp.newTrigger('continueBatchProcessing')
    .timeBased()
    .after(60 * 1000) // 1 –º–∏–Ω—É—Ç–∞
    .create();
  Logger.log(`üîÑ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω —Å–ª–µ–¥—É—é—â–∏–π –±–∞—Ç—á. –°—Ç–∞—Ä—Ç —Å –ø–æ–∑–∏—Ü–∏–∏ ${nextOffset}`);
}

function continueBatchProcessing() {
  findCompetitorsForAllObjects();
}

// ================== –£–õ–£–ß–®–ï–ù–ù–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –≤ —Å—Ç–æ–ª–±—Ü–µ —Ä–∞–π–æ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 1).
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object<string, Array<Array<any>>>} –û–±—ä–µ–∫—Ç —Å –≥—Ä—É–ø–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–∞–π–æ–Ω–∞–º.
 */
function groupDataByDistrict(data, headerMap) { 
  const grouped = {}; 
  data.forEach(row => { 
    const district = getRowField(row, headerMap, 'district', 1) || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    if (!grouped[district]) grouped[district] = []; 
    grouped[district].push(row); 
  }); 
  return grouped; 
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ä–∞–π–æ–Ω–∞, —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function processDistrictData(params) {
    const { type, rooms, area, repair, buildYear, activeCandidates, soldCandidates, startDate, endDate, months, activeHeaderMap, soldHeaderMap } = params;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏"
    const staleDate = new Date(endDate.getTime() - STALE_LISTING_MONTHS * 30.4375 * 24 * 60 * 60 * 1000).getTime();
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –¥–∞—Ç–µ (—Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ)
    const freshActiveCandidates = activeCandidates.filter(row => { 
        try { 
          const dateValue = getRowField(row, activeHeaderMap, 'date', 0);
          const dateObj = parseDateSafe(dateValue);
          return dateObj ? dateObj.getTime() >= staleDate : false; 
        } catch(e) { return false; }
    });
    
    // --- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–º–æ–Ω—Ç—É ---
    const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
    const objectRepairLower = repair ? repair.toLowerCase() : '';
    const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));

    // –§–∏–ª—å—Ç—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Ç–∏–ø, –∫–æ–º–Ω–∞—Ç—ã, –ø–ª–æ—â–∞–¥—å, –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏, —Ä–µ–º–æ–Ω—Ç)
    const processedActiveCandidates = freshActiveCandidates.filter(row => {
        try {
            const rowDateObj = parseDateSafe(getRowField(row, activeHeaderMap, 'date', 0));
            if (!rowDateObj) return false;
            const rowDate = rowDateObj.getTime();
            const rowBuildYear = Number(getRowField(row, activeHeaderMap, 'buildYear', 10)) || null;
            const rowRooms = Number(getRowField(row, activeHeaderMap, 'rooms', 3));
            const rowArea = Number(getRowField(row, activeHeaderMap, 'area', 4));
            const competitorRepair = getRowField(row, activeHeaderMap, 'repair', 6); // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (getRowField(row, activeHeaderMap, 'objectType', 2) !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
    const processedSoldCandidates = soldCandidates.filter(row => {
        try {
            const rowDateObj = parseDateSafe(getRowField(row, soldHeaderMap, 'date', 0));
            if (!rowDateObj) return false;
            const rowDate = rowDateObj.getTime(); // –î–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏/–ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            const rowBuildYear = Number(getRowField(row, soldHeaderMap, 'buildYear', 10)) || null;
            const rowRooms = Number(getRowField(row, soldHeaderMap, 'rooms', 3));
            const rowArea = Number(getRowField(row, soldHeaderMap, 'area', 4));
            const competitorRepair = getRowField(row, soldHeaderMap, 'repair', 6); // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
            const competitorRepairLower = competitorRepair ? competitorRepair.toLowerCase() : '';

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã (—É–∂–µ —É—á—Ç–µ–Ω–∞ –≤ freshActiveCandidates, –Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            if (rowDate < startDate.getTime() || rowDate > endDate.getTime()) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –æ–±—ä–µ–∫—Ç–∞
            if (getRowField(row, soldHeaderMap, 'objectType', 2) !== type) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–º–Ω–∞—Ç (–¥–æ–ø—É—Å–∫ +/- 1)
            if (![rooms, rooms + 1, rooms - 1].filter(r => r >= 0).includes(rowRooms)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–æ—â–∞–¥–∏ (–¥–æ–ø—É—Å–∫ +/- 20%)
            if (rowArea < area * 0.8 || rowArea > area * 1.2) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ–¥–∞ –ø–æ—Å—Ç—Ä–æ–π–∫–∏ (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
            if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) return false;
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–º–æ–Ω—Ç–∞: –µ—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ç–æ –∏ —É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ä–æ—à–∏–π
            if (isObjectGoodRepair && !goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) return false;

            return true; // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã
        } catch (e) { return false; } // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
    });

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    const activeCompetitors = processedActiveCandidates.map(row => formatCompetitorRow(row, false, activeHeaderMap));
    const soldCompetitors = processedSoldCandidates.map(row => formatCompetitorRow(row, true, soldHeaderMap));

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–∫–∏ —Ü–µ–Ω –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ä–µ–¥–Ω–∏—Ö
    const activePrices = activeCompetitors.map(c => c[5]).filter(p => p > 0); // –¶–µ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 5)
    const soldPrices = soldCompetitors.map(c => c[5]).filter(p => p > 0); // –¶–µ–Ω–∞ (–∏–Ω–¥–µ–∫—Å 5)

    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü
    const avgSalesPerMonth = soldCompetitors.length > 0 ? parseFloat((soldCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–±—ã—Ç–∏—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
    const avgNewObjectsPerMonth = activeCompetitors.length > 0 ? parseFloat((activeCompetitors.length / months).toFixed(2)) : 0;
    
    // –†–∞—Å—á–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (—á–∏—Å–ª–æ–≤–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è getLiquidityType –∏ getMarketAssessment)
    let liquidityIndex = 0;
    if (activeCompetitors.length > 0 && avgSalesPerMonth > 0) {
        liquidityIndex = Math.round((avgSalesPerMonth / activeCompetitors.length) * 100);
    }
    
    // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ —Ü–µ–Ω—ã –∑–∞ –º¬≤ (–¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏ –∏ —Ü–µ–Ω–∞ –∑–∞ –º¬≤)
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[5] - —Ü–µ–Ω–∞ –∑–∞ –º¬≤
    const priceTrendData = soldCompetitors
      .map(c => {
        const d = parseDateSafe(c[13]);
        return [ d ? d.getTime() / (1000 * 60 * 60 * 24) : null, c[6] ];
      })
      .filter(p => p[0] !== null && p[1]); // –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ + —Ü–µ–Ω–∞ –∑–∞ –º¬≤
    const trend = calculateLinearRegression(priceTrendData); // –†–∞—Å—á–µ—Ç –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
    const priceTrendPerMonth = trend ? Math.round(trend.slope * 30.4375) : 0; // –ü–µ—Ä–µ—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –Ω–∞ –º–µ—Å—è—Ü
    
    // –†–∞—Å—á–µ—Ç —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
    const competitionTrend = calculateCompetitionTrend(freshActiveCandidates, startDate, endDate, activeHeaderMap); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ–∂–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
    return { 
        activeCompetitors, 
        soldCompetitors, 
        activePrices, 
        competitionTrend, 
        avgActivePriceTrimmed: calculateTrimmedMean(activePrices, TRIM_PERCENTAGE), // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º
        avgSoldPriceMedian: calculateMedian(soldPrices), // –ú–µ–¥–∏–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
        avgSalesPerMonth, 
        liquidityIndex: liquidityIndex, // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ–≤–æ–π –∏–Ω–¥–µ–∫—Å (–º–æ–∂–µ—Ç –±—ã—Ç—å 0)
        priceTrendPerMonth: priceTrendPerMonth || '-', // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –∏–ª–∏ —Ç–∏—Ä–µ
        avgNewObjectsPerMonth // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É –ø—Ä–∏–±—ã—Ç–∏—è
    };
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è filterCompetitors, —Ç.–∫. –µ–µ –ª–æ–≥–∏–∫–∞ –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä–æ–≤–∞–Ω–∞ –≤ processDistrictData

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º.
 * @param {Array<any>} row –°—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞.
 * @param {boolean} isSold –§–ª–∞–≥, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã–º.
 * @returns {Array<any>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatCompetitorRow(row, isSold, headerMap) {
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –∏ –ø–ª–æ—â–∞–¥—å
    const price = Number(getRowField(row, headerMap, 'price', 7)) || 0;
    const area = Number(getRowField(row, headerMap, 'area', 4)) || 0;
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤
    const pricePerM2 = area > 0 ? Math.floor(price / area) : 0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º price/area –∫–∞–∫ –≤ ourObjectAsCompetitor

    let timeOnMarket = '-';
    if (isSold) {
        try {
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –≤ –¥–Ω—è—Ö
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º: row[0] - –¥–∞—Ç–∞ –ø—Ä–æ–¥–∞–∂–∏, row[12] - –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö)
            const saleDate = parseDateSafe(getRowField(row, headerMap, 'date', 0));
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—É—é –¥–∞—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            let pubDate = parseDateSafe(getRowField(row, headerMap, 'publishDate', 12));
            // –ï—Å–ª–∏ –µ—ë –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞—Ç—É –ø—Ä–æ–¥–∞–∂–∏ (—Å—Ä–æ–∫ –±—É–¥–µ—Ç 0)
            if (!pubDate) pubDate = saleDate;

            if (saleDate && pubDate) {
                timeOnMarket = Math.round((saleDate - pubDate) / (1000 * 60 * 60 * 24));
            }
        } catch (e) { timeOnMarket = '-'; } // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏—Ä–µ
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏ —Ä–µ–º–æ–Ω—Ç, —É—á–∏—Ç—ã–≤–∞—è, –ø—Ä–æ–¥–∞–Ω–æ –ª–∏ –æ–±—ä–µ–∫—Ç
    const link = getRowField(row, headerMap, 'link', 11) || '-';
    const repair = getRowField(row, headerMap, 'repair', 6) || '-';
    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞ (—Å–ø–µ–∫—É–ª—è—Ç–∏–≤–Ω–æ, –ø–æ–∫–∞ –±–µ—Ä–µ–º —Ç–∏—Ä–µ, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ ‚Äî —á–µ–∫-–ª–∏—Å—Ç—ã —Ñ–æ—Ç–æ/–æ–ø–∏—Å–∞–Ω–∏—è)
    const houseCondition = getRowField(row, headerMap, 'houseCondition', null) || '-'; 

    // –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∏–Ω–∞–º–∏–∫–∏ (–æ–±—ã—á–Ω–æ —Å—Ç–æ–ª–±–µ—Ü A –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö, M –¥–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö)
    const pubDateRaw = isSold
      ? (getRowField(row, headerMap, 'publishDate', 11) || getRowField(row, headerMap, 'date', 0))
      : getRowField(row, headerMap, 'date', 0);
    const pubDateValue = parseDateSafe(pubDateRaw) || pubDateRaw;

    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–∫–∞–º (14 —Å—Ç–æ–ª–±—Ü–æ–≤)
    return [
        getRowField(row, headerMap, 'code', 5) || '-', // 0: '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞'
        getRowField(row, headerMap, 'district', 1), // 1: '–†–∞–π–æ–Ω'
        getRowField(row, headerMap, 'objectType', 2), // 2: '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞'
        Number(getRowField(row, headerMap, 'rooms', 3)), // 3: '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç'
        area, // 4: '–ü–ª–æ—â–∞–¥—å'
        price, // 5: '–¶–µ–Ω–∞'
        pricePerM2, // 6: '–¶–µ–Ω–∞ –∑–∞ –º¬≤'
        timeOnMarket, // 7: '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π'
        link, // 8: '–°—Å—ã–ª–∫–∞'
        repair, // 9: '–†–µ–º–æ–Ω—Ç'
        houseCondition, // 10: '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞'
        `${getRowField(row, headerMap, 'floor', 8)}/${getRowField(row, headerMap, 'floors', 9)}`, // 11: '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å'
        Number(getRowField(row, headerMap, 'buildYear', 10)) || '-', // 12: '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
        pubDateValue // 13: –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (—Å–ª—É–∂–µ–±–Ω–æ–µ –ø–æ–ª–µ)
    ];
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ä—ã–Ω–∫–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏.
 */
function calculateObjectMetrics(params) {
    const { price, pricePerM2, activeCompetitors, avgActivePriceTrimmed, avgSoldPriceMedian, avgSalesPerMonth } = params;
    
    // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ü–µ–Ω—ã –∑–∞ –º¬≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ —Å —Ü–µ–Ω–æ–π –º¬≤ —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    const allActivePricesPerM2 = [...activeCompetitors.map(c => c[6]), pricePerM2].filter(p => p > 0).sort((a, b) => a - b);
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const rankByPrice = 1 + allActivePricesPerM2.filter(p => p < pricePerM2).length;
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ
    const formatRatio = (ratio) => `${ratio > 0 ? '+' : ''}${ratio.toFixed(1)}%`;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ–±—ä–µ–∫—Ç–∞ –∫ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeRatioPercent = avgActivePriceTrimmed > 0 ? formatRatio(((price / avgActivePriceTrimmed - 1) * 100)) : '-';
    const soldRatioPercent = avgSoldPriceMedian > 0 ? formatRatio(((price / avgSoldPriceMedian - 1) * 100)) : '-';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ä–µ–¥–Ω–∏—Ö —Ü–µ–Ω
    const priceDiffPercentActive = (avgActivePriceTrimmed > 0) ? `${Math.round((price - avgActivePriceTrimmed) / avgActivePriceTrimmed * 100)}%` : '-';
    const priceDiffPercentSold = (avgSoldPriceMedian > 0) ? `${Math.round((price - avgSoldPriceMedian) / avgSoldPriceMedian * 100)}%` : '-';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (Months of Inventory)
    const inventoryMonths = (avgSalesPerMonth > 0) ? parseFloat((activeCompetitors.length / avgSalesPerMonth).toFixed(1)) : '-';
    
    return { rankByPrice: rankByPrice || '-', activeRatioPercent, soldRatioPercent, priceDiffPercentActive, priceDiffPercentSold, inventoryMonths };
}

/**
 * –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ—Ç —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeOnMarket(params) {
    const { soldCompetitors, avgPrice, rank, avgSalesPerMonth, avgNewObjectsPerMonth, price, activePrices } = params;
    const defaultResult = { fast: '-', market: '-', optimistic: '-', dynamicMonths: '-', degradationInfo: '' };
    const toMonths = (days) => (days / 30.4375).toFixed(1);
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if (!rank || rank <= 0 || !avgSalesPerMonth || avgSalesPerMonth <= 0) {
        return defaultResult;
    }
    
    // === –£–õ–£–ß–®–ï–ù–ò–ï B3: –†–∞—Å—á—ë—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞ ===
    const dynamicResult = calculateDynamicTimeOnMarket({
        rank: rank,
        demand: avgSalesPerMonth,
        arrival: avgNewObjectsPerMonth || 0,
        price: price,
        activePrices: activePrices || []
    });
    
    // –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∞ –∏–∑ —Ä–∞—Å—á–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º 1.0)
    const seasonalCoef = 1.0;
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const timeOnMarketData = soldCompetitors
      .map(c => ({ tom: c[7], price: c[5] }))
      .filter(c => typeof c.tom === 'number' && c.tom >= 0);
    
    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
    if (timeOnMarketData.length < 2 || !avgPrice) {
        const baseTerm = dynamicResult.months * seasonalCoef;
        return { 
            fast: (baseTerm * 0.7).toFixed(1), 
            market: baseTerm.toFixed(1), 
            optimistic: (baseTerm * 1.5).toFixed(1),
            dynamicMonths: dynamicResult.months.toFixed(1),
            degradationInfo: dynamicResult.info
        };
    }
    
    // –°–µ–≥–º–µ–Ω—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ —Ü–µ–Ω–æ–≤—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const cheap = [], market = [], expensive = [];
    timeOnMarketData.forEach(c => { 
        if (c.price < avgPrice * 0.9) cheap.push(c.tom);
        else if (c.price > avgPrice * 1.1) expensive.push(c.tom);
        else market.push(c.tom);
    });
    
    const getMedianTom = (segment) => segment.length > 0 ? parseFloat(toMonths(calculateMedian(segment))) : null;
    
    let fastTom = getMedianTom(cheap), marketTom = getMedianTom(market), optimisticTom = getMedianTom(expensive);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–µ–∑–æ–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫—É –Ω–∞ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é
    const degradationMultiplier = dynamicResult.months > 0 ? dynamicResult.months / (rank / avgSalesPerMonth) : 1;
    
    const applyCorrections = (value) => {
        if (!value) return null;
        return (value * seasonalCoef * degradationMultiplier).toFixed(1);
    };
    
    return { 
        fast: applyCorrections(fastTom) || applyCorrections(marketTom) || '-', 
        market: applyCorrections(marketTom) || applyCorrections(optimisticTom) || '-', 
        optimistic: applyCorrections(optimisticTom) || applyCorrections(marketTom) || '-',
        dynamicMonths: dynamicResult.months.toFixed(1),
        degradationInfo: dynamicResult.info
    };
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω–æ–≤—É—é –≤–∏–ª–∫—É (–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é, —Ä—ã–Ω–æ—á–Ω—É—é, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—É—é) –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏.
 */
function calculatePriceFork(params) {
    const { price, objectData, activePrices, activeCompetitors, avgSalesPerMonth, avgSoldPriceMedian, avgNewObjectsPerMonth, dataMap } = params;
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Ü–µ–Ω–∫—É –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
    const qualityScore = calculateQualityScore(dataMap);
    const area = Number(objectData[4]) || 1;
    
    // –¶–µ–ª–µ–≤—ã–µ —Ä–∞–Ω–≥–∏ –ø–æ —Å–ø—Ä–æ—Å—É (1 –º–µ—Å –∏ 4 –º–µ—Å) + —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø–æ —Ä–∞–Ω–≥—É
    const sortedPricesPerM2 = (activeCompetitors || [])
      .map(c => Number(c[6]) || 0)
      .filter(p => p > 0)
      .sort((a, b) => a - b);
    const objectPricePerM2 = area > 0 ? (price / area) : price;
    const priceBelowRatio = calculatePriceBelowRatio(objectPricePerM2, sortedPricesPerM2, avgNewObjectsPerMonth || 0);
    const effectiveDemand = Math.max(0.1, (avgSalesPerMonth || 0) - (avgNewObjectsPerMonth || 0) * priceBelowRatio);
    const quickTargetRank = getTargetRankByDemand(avgSalesPerMonth || 0, STRATEGY_TARGET_MONTHS.QUICK, sortedPricesPerM2.length);
    const marketTargetRank = getTargetRankByDemand(effectiveDemand, STRATEGY_TARGET_MONTHS.MARKET, sortedPricesPerM2.length);
    const quickPpsm = getAvgPricePerM2ByTopRank(sortedPricesPerM2, quickTargetRank, STRATEGY_UNDERCUT.QUICK);
    const marketPpsm = getAvgPricePerM2ByTopRank(sortedPricesPerM2, marketTargetRank, STRATEGY_UNDERCUT.MARKET);

    // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞: –ø–æ —Ü–µ–ª–µ–≤–æ–º—É —Ä–∞–Ω–≥—É (—Ç–æ–ø –Ω–∞ 4 –º–µ—Å—è—Ü–∞), –∏–Ω–∞—á–µ –º–µ–¥–∏–∞–Ω–∞/—É—Å–µ—á—ë–Ω–Ω–∞—è
    let marketPrice = (marketPpsm && area > 0) ? (marketPpsm * area) : (avgSoldPriceMedian > 0 ? avgSoldPriceMedian : calculateTrimmedMean(activePrices, TRIM_PERCENTAGE));
    marketPrice = marketPrice > 0 ? marketPrice : Math.floor(price * 0.95); // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –±–µ—Ä–µ–º 95% –æ—Ç —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
    if (!marketPpsm) {
      marketPrice = Math.floor(marketPrice * qualityScore); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ fallback
    }

    // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ü–µ–Ω–∞: –ø–æ —Ü–µ–ª–µ–≤–æ–º—É —Ä–∞–Ω–≥—É (—Ç–æ–ø –Ω–∞ 1 –º–µ—Å—è—Ü), –∏–Ω–∞—á–µ 90% –æ—Ç —Ç–µ–∫—É—â–µ–π
    let aggressivePrice = (quickPpsm && area > 0) ? (quickPpsm * area) : Math.floor(price * 0.9);
    if (!quickPpsm) {
      aggressivePrice = Math.floor(aggressivePrice * qualityScore * 0.97); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ fallback
    }

    // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è —Ü–µ–Ω–∞
    const trimmedAvgActive = calculateTrimmedMean(activePrices, TRIM_PERCENTAGE); 
    let optimisticPrice = trimmedAvgActive > 0 ? trimmedAvgActive : marketPrice * 1.05; // –ë–µ—Ä–µ–º —Å—Ä–µ–¥–Ω—é—é –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–ª–∏ 105% –æ—Ç —Ä—ã–Ω–æ—á–Ω–æ–π
    optimisticPrice = Math.floor(optimisticPrice * qualityScore * 1.03); // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–æ –∫–∞—á–µ—Å—Ç–≤—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –º–Ω–æ–∂–∏—Ç–µ–ª—å

    // –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ —Ü–µ–Ω: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ 100 000, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è <= —Ä—ã–Ω–æ—á–Ω–∞—è, –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–∞—è >= —Ä—ã–Ω–æ—á–Ω–∞—è
    const finalMarketPrice = Math.max(100000, marketPrice);
    const finalAggressivePrice = Math.min(finalMarketPrice, Math.max(100000, aggressivePrice));
    const finalOptimisticPrice = Math.max(finalMarketPrice, Math.max(100000, optimisticPrice));
    
    return { aggressive: finalAggressivePrice, market: finalMarketPrice, optimistic: finalOptimisticPrice };
}



/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä—ã–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–Ω–¥–µ–∫—Å–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ —Å–ø—Ä–æ—Å–∞.
 * @param {number|string} liquidityIndex –ò–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} avgSalesPerMonth –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂ –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä—ã–Ω–∫–∞.
 */
function getMarketAssessment(liquidityIndex, avgSalesPerMonth) {
  if (typeof liquidityIndex !== 'number') return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; // –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –Ω–µ —á–∏—Å–ª–æ
  
  if (liquidityIndex > 25 && avgSalesPerMonth > 3) {
    return 'üî• –ì–æ—Ä—è—á–∏–π —Ä—ã–Ω–æ–∫ (–≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å). –ö–≤–∞—Ä—Ç–∏—Ä—ã —É–ª–µ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–æ, –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –±–æ–ª—å—à–µ, —á–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.'; 
  }
  if (liquidityIndex >= 15 && avgSalesPerMonth > 1.5) {
    return '‚öñÔ∏è –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫. –°–ø—Ä–æ—Å –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —É—Ä–∞–≤–Ω–æ–≤–µ—à–µ–Ω—ã, —Å–¥–µ–ª–∫–∏ –∏–¥—É—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø–æ —Ä—ã–Ω–æ—á–Ω—ã–º —Ü–µ–Ω–∞–º.';
  }
  
  // –î–ª—è —Ö–æ–ª–æ–¥–Ω–æ–≥–æ —Ä—ã–Ω–∫–∞ —É—Ç–æ—á–Ω—è–µ–º –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
  let reason = '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –º–Ω–æ–≥–æ, –∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –º–∞–ª–æ, –æ–±—ä–µ–∫—Ç—ã –¥–æ–ª–≥–æ –≤–∏—Å—è—Ç –≤ –ø—Ä–æ–¥–∞–∂–µ.';
  if (avgSalesPerMonth < 1) {
    reason = '–ö—Ä–∞–π–Ω–µ –Ω–∏–∑–∫–æ–µ —á–∏—Å–ª–æ —Å–¥–µ–ª–æ–∫ –≤ –º–µ—Å—è—Ü, —Ä—ã–Ω–æ–∫ –ø–æ—á—Ç–∏ —Å—Ç–æ–∏—Ç.';
  }
  
  return `‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π —Ä—ã–Ω–æ–∫ (–Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å). ${reason}`;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, —Å—Ä–∞–≤–Ω–∏–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Array<Array<any>>} candidates –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.
 * @param {Date} startDate –ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @param {Date} endDate –ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –ø–µ—Ä–∏–æ–¥–∞.
 * @returns {string} –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏.
 */
function calculateCompetitionTrend(candidates, startDate, endDate, headerMap) {
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2); // –°–µ—Ä–µ–¥–∏–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = candidates.filter(r => {
    const d = parseDateSafe(getRowField(r, headerMap, 'date', 0));
    return d && d < midPoint;
  }).length;
  const secondHalfCount = candidates.filter(r => {
    const d = parseDateSafe(getRowField(r, headerMap, 'date', 0));
    return d && d >= midPoint;
  }).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return '+100% (—Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç)'; // –ï—Å–ª–∏ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –Ω–µ –±—ã–ª–æ, –∞ –≤–æ –≤—Ç–æ—Ä–æ–π –µ—Å—Ç—å
  if (firstHalfCount === 0 || secondHalfCount === 0) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –≤ –æ–¥–Ω–æ–π –∏–∑ –ø–æ–ª–æ–≤–∏–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
  
  const trend = ((secondHalfCount / firstHalfCount) - 1) * 100; // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
  
  if (Math.abs(trend) < 10) return '—Å—Ç–∞–±–∏–ª—å–Ω–∞'; // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–µ–Ω—å—à–µ 10%
  return `${trend > 0 ? '—Ä–æ—Å—Ç' : '—Å–Ω–∏–∂–µ–Ω–∏–µ'} –Ω–∞ ${Math.abs(trend.toFixed(0))}%`; // –û–ø–∏—Å–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–∞
}



// ================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° GEMINI –ò –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê ==================

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –ó–∞–ø—É—Å–∫–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á–µ—Ç–∞, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –Ω–∞ –ª–∏—Å—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∞–¥—Ä–µ—Å–æ–≤.
 * @param {GoogleAppsScript.Events.SheetsOnEdit} e –û–±—ä–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */




// ================== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° AI (GEMINI + OPENAI FALLBACK) ==================

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ AI —Å —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π Gemini.
 * @param {string} prompt –ü—Ä–æ–º–ø—Ç –¥–ª—è AI.
 * @param {string} summaryText –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ.
 * @returns {string} –û—Ç–≤–µ—Ç –æ—Ç AI –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function callAI(prompt, summaryText) {
  Logger.log('üöÄ –ó–∞–ø—É—Å–∫ callAI c —Ä–æ—Ç–∞—Ü–∏–µ–π –∫–ª—é—á–µ–π...');
  
  const keyPool = getGeminiKeyPool();
  if (keyPool.length === 0) return '‚ùå API-–∫–ª—é—á–∏ Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –∏—Ö —á–µ—Ä–µ–∑ –º–µ–Ω—é.';

  const models = ['gemini-3-flash-preview'];
  let lastError = '';

  // –ü—Ä–æ–±—É–µ–º –∫–∞–∂–¥—ã–π –∫–ª—é—á –∏–∑ –ø—É–ª–∞
  for (let i = 0; i < keyPool.length; i++) {
    const apiKey = getGeminiApiKey(); // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª—é—á
    
    for (const model of models) {
      Logger.log(`üîπ –ü–æ–ø—ã—Ç–∫–∞: –ö–ª—é—á #${i+1}, –ú–æ–¥–µ–ª—å ${model}...`);
      const result = callGeminiFlash(prompt, summaryText, model, apiKey);
      
      if (!result.startsWith('‚ùå')) {
        return result;
      }
      
      lastError = result;
      // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –ª–∏–º–∏—Ç–∞–º–∏ –ò–õ–ò –µ—Å–ª–∏ API –Ω–µ –≤–∫–ª—é—á–µ–Ω (disabled/not been used), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª—é—á
      const isSwitchError = result.includes('quota') || result.includes('limit') || 
                            result.includes('429') || result.includes('disabled') || 
                            result.includes('not been used');
      
      if (!isSwitchError) {
        continue;
      }
      
      Logger.log(`‚ö†Ô∏è –ö–≤–æ—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è –∫–ª—é—á–∞ #${i+1}. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π...`);
      rotateGeminiApiKey(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
      break; // –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞ –º–æ–¥–µ–ª–µ–π, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∫–ª—é—á—É
    }
  }
  
  return `‚ùå –ò—Å—á–µ—Ä–ø–∞–Ω—ã –∫–≤–æ—Ç—ã –í–°–ï–• –∫–ª—é—á–µ–π Gemini. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–ª—é—á–µ–π.\n–ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: ${lastError}`;
}

/**
 * –í—ã–∑—ã–≤–∞–µ—Ç Gemini Flash API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
 * @param {string} prompt –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini.
 * @param {string} summaryText –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ.
 * @param {string} model –ú–æ–¥–µ–ª—å Gemini (gemini-2.0-flash-lite –∏–ª–∏ gemini-2.0-flash).
 * @returns {string} –û—Ç–≤–µ—Ç –æ—Ç Gemini –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ.
 */
function callGeminiFlash(prompt, summaryText, model, forcedKey) {
  const apiKey = forcedKey || getGeminiApiKey();
  if (!apiKey) return '‚ùå API-–∫–ª—é—á Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.';
  
  model = model || 'gemini-3-flash-preview';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
  
  const unifiedPrompt = `–¢—ã ‚Äî –∞–Ω–∞–ª–∏—Ç–∏–∫ —Ä—ã–Ω–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏. –¢–µ–±–µ –¥–∞–Ω–æ —Å—É—Ö–æ–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ –ø–æ –æ–±—ä–µ–∫—Ç—É –∏ —Ä—ã–Ω–∫—É.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –µ–≥–æ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã–º–∏ –∏ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Ñ–∞–∫—Ç—ã.

–ü—Ä–∞–≤–∏–ª–∞:
1) –ù–∏–∫–∞–∫–∏—Ö –≤—ã–¥—É–º–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã –∏–∑ —Ä–µ–∑—é–º–µ.
2) –°–æ—Ö—Ä–∞–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ —á–∏—Å–ª–∞: —Ü–µ–Ω–∞, —Å–ø—Ä–æ—Å/–∞–∫—Ç–∏–≤–Ω—ã–µ/–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å, —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã, —Å—Ä–æ–∫–∏.
2.1) –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ—è—Å–Ω–∏, —á—Ç–æ —Å—Ä–æ–∫ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (—Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤).
3) –°—Ç–∏–ª—å: –ø—Ä–æ—Å—Ç–æ–π, –¥–µ–ª–æ–≤–æ–π, –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ï—Å–ª–∏ —Ç–µ—Ä–º–∏–Ω –Ω–µ–∏–∑–±–µ–∂–µ–Ω ‚Äî –∫–æ—Ä–æ—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏ –µ–≥–æ.
4) –§–æ—Ä–º–∞—Ç: —Å–ø–ª–æ—à–Ω–æ–π —Ç–µ–∫—Å—Ç, –±–µ–∑ Markdown, –±–µ–∑ —Å–ø–∏—Å–∫–æ–≤, –±–µ–∑ —Å–º–∞–π–ª–æ–≤.
5) –î–ª–∏–Ω–∞: 5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, 700‚Äì900 —Å–∏–º–≤–æ–ª–æ–≤.
6) –í –Ω–∞—á–∞–ª–µ ‚Äî 1‚Äì2 —Ñ—Ä–∞–∑—ã —Å –≥–ª–∞–≤–Ω—ã–º –≤—ã–≤–æ–¥–æ–º. –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã "–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—Å:".
7) –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ä–µ–∫–ª–∞–º–µ –Ω–µ—Ç ‚Äî —Å–∫–∞–∂–∏ —ç—Ç–æ –ø—Ä—è–º–æ.\n\n–ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –ø—Ä–æ–¥–∞–∂:
–ò—Å–ø–æ–ª—å–∑—É–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ PAS (Problem-Agitation-Solution):
1. Problem: –ö–∞–∫—É—é –≥–ª–∞–≤–Ω—É—é —Ç—Ä—É–¥–Ω–æ—Å—Ç—å —Å–µ–π—á–∞—Å –≤–∏–¥–∏—Ç —Ä—ã–Ω–æ–∫ –≤ —ç—Ç–æ–º –æ–±—ä–µ–∫—Ç–µ/—Ü–µ–Ω–µ?
2. Agitation: –ß—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å—ë –∫–∞–∫ –µ—Å—Ç—å (–ø–æ—Ç–µ—Ä—è –≤—Ä–µ–º–µ–Ω–∏, –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ)?
3. Solution: –ö–∞–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤ –¥–∞–Ω–Ω—ã—Ö) —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã–≥–æ–¥–Ω–æ.
4. –í—ã–≤–æ–¥: –ò—Ç–æ–≥–æ–≤–æ–µ –Ω–∞–ø—É—Ç—Å—Ç–≤–∏–µ.`;

  const basePrompt = (prompt && String(prompt).trim()) ? prompt : unifiedPrompt;
  const fullPrompt = `${basePrompt}\n\n–í–æ—Ç –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑—é–º–µ:\n${summaryText}`;
  
  const payload = {
    "contents": [{
      "parts": [{ "text": fullPrompt }]
    }],
    "generationConfig": {
      "temperature": 0.3,
      "maxOutputTokens": 4096,
      "topP": 0.8
    },
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ]
  };
  
  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseText = response.getContentText();
    Logger.log(`Gemini ${model} Raw Response: ${responseText.substring(0, 500)}...`);
    
    const json = JSON.parse(responseText);
    
    if (json.error) {
      return `‚ùå –û—à–∏–±–∫–∞ Gemini ${model}: ${json.error.message}`;
    }
    
    if (json.candidates && json.candidates[0] && json.candidates[0].content && 
        json.candidates[0].content.parts && json.candidates[0].content.parts[0].text) {
      return cleanText(json.candidates[0].content.parts[0].text);
    }
    
    return `‚ùå Gemini ${model}: –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç`;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ Gemini ${model}: ${e.stack}`);
    return `‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ Gemini ${model}`;
  }
}

// –£–¥–∞–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è callOpenAI –∑–∞ –Ω–µ–Ω–∞–¥–æ–±–Ω–æ—Å—Ç—å—é

/**
 * [v1.0] –í—ã–∑—ã–≤–∞–µ—Ç Gemini –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ AI-–∞–Ω–∞–ª–∏–∑–∞ —Å JSON-–≤—ã–≤–æ–¥–æ–º.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É fallback: —Å–Ω–∞—á–∞–ª–∞ Lite, –∑–∞—Ç–µ–º –æ—Å–Ω–æ–≤–Ω—É—é Flash.
 * @param {Object} analyticsData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} marketContext –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
 * @returns {Object} { success: boolean, ... }
 */
function callGeminiAnalyst(analyticsData, marketContext) {
  const keyPool = getGeminiKeyPool();
  if (keyPool.length === 0) return { success: false, error: 'API-–∫–ª—é—á–∏ Gemini –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã' };
  
  const models = ['gemini-3-flash-preview'];
  let lastError = '';

  for (let i = 0; i < keyPool.length; i++) {
    const apiKey = getGeminiApiKey();
    
    for (const model of models) {
      try {
        Logger.log(`üîπ –ê–Ω–∞–ª–∏–∑: –ö–ª—é—á #${i+1}, –ú–æ–¥–µ–ª—å ${model}...`);
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const result = executeGeminiRequest(url, analyticsData, marketContext);
        
        if (result.success) return result;
        
        lastError = result.error;
        const isSwitchError = lastError.includes('quota') || lastError.includes('limit') || 
                              lastError.includes('429') || lastError.includes('disabled') || 
                              lastError.includes('not been used');

        if (!isSwitchError) {
          continue; 
        }
        
        Logger.log(`‚ö†Ô∏è –ö–≤–æ—Ç—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã –¥–ª—è –∫–ª—é—á–∞ #${i+1}. –ü–µ—Ä–µ–∫–ª—é—á–∞—é—Å—å...`);
        rotateGeminiApiKey();
        break; // –ö —Å–ª–µ–¥—É—é—â–µ–º—É –∫–ª—é—á—É
      } catch (e) {
        lastError = e.message;
        continue;
      }
    }
  }

  return { success: false, error: '–ò—Å—á–µ—Ä–ø–∞–Ω—ã –∫–≤–æ—Ç—ã –í–°–ï–• –∫–ª—é—á–µ–π Gemini', rawContent: `–û—à–∏–±–∫–∞: ${lastError}` };
}

/**
 * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ Gemini (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É).
 */
function executeGeminiRequest(url, analyticsData, marketContext) {
  const macro = marketContext || getMacroContext();
  const systemPrompt = `–¢–´ ‚Äî –°–¢–ê–†–®–ò–ô –ü–ê–†–¢–ù–ï–† –ö–û–ù–°–ê–õ–¢–ò–ù–ì–û–í–û–ì–û –ê–ì–ï–ù–¢–°–¢–í–ê –ü–û –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞—Ç—å –≥–ª—É–±–æ–∫–∏–π —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∏ –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. 
–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî "—Ä–∞–¥–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Å—Ç–Ω–æ—Å—Ç—å": –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –±–µ–∑ –≤–æ–¥—ã –∏ –ª–µ—Å—Ç–∏.

–ì–õ–ê–í–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º –¥–µ–ª–æ–≤—ã–º —è–∑—ã–∫–æ–º. –ò–∑–±–µ–≥–∞–π —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —à—Ç–∞–º–ø–æ–≤ ("—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ", "—Å–ø–µ—à–∏—Ç–µ –∫—É–ø–∏—Ç—å" ‚Äî –ó–ê–ü–†–ï–©–ï–ù–û).
2. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ JSON.
3. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: —Ü–µ–Ω–∞, —Å–ø—Ä–æ—Å, –ø—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤, —Ä–∞–Ω–≥ –≤ —Ä–∞–π–æ–Ω–µ.
4. –ü—Ä–æ–≥–Ω–æ–∑ —Å—Ä–æ–∫–∞ ‚Äî —ç—Ç–æ –¥–∏–Ω–∞–º–∏–∫–∞. –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –ø—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–ø—Ä–∏–±—ã—Ç–∏–µ) –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é –ª–æ—Ç–∞, –µ—Å–ª–∏ –Ω–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å.

–°–¢–†–£–ö–¢–£–†–ê –í–´–í–û–î–ê (PAS + –°—Ç—Ä–∞—Ç–µ–≥–∏—è):
1. –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—Å (1-2 —Ñ—Ä–∞–∑—ã): –ì–ª–∞–≤–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥.
2. –ü—Ä–æ–±–ª–µ–º–∞ (Problem): –ö–∞–∫–∞—è –ø—Ä–µ–≥—Ä–∞–¥–∞ –º–µ—à–∞–µ—Ç –ø—Ä–æ–¥–∞–∂–µ –ø–æ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ?
3. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (Agitation): –ß—Ç–æ –±—É–¥–µ—Ç —Å –ø–æ–∑–∏—Ü–∏–µ–π –æ–±—ä–µ–∫—Ç–∞ —á–µ—Ä–µ–∑ 2-3 –º–µ—Å—è—Ü–∞ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º –ø—Ä–∏—Ç–æ–∫–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ –∫–∞–∫ –µ—Å—Ç—å.
4. –ü–ª–∞–Ω –ø–æ–±–µ–¥—ã (Solution): –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —Ü–µ–Ω–µ –∏–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.

–§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï: –ë–µ–∑ Markdown. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫. –î–ª–∏–Ω–∞: 700‚Äì900 —Å–∏–º–≤–æ–ª–æ–≤.`;

  const macroText = [];
  if (macro.keyRate) macroText.push(`–¶–ë ${macro.keyRate}%`);
  if (macro.mortgageRate) macroText.push(`–ò–ø–æ—Ç–µ–∫–∞ ${macro.mortgageRate}%`);
  macroText.push(`–¢—Ä–µ–Ω–¥: ${macro.marketTrend}`);

  const userPrompt = `–î–ê–ù–ù–´–ï –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê:\n${JSON.stringify(analyticsData, null, 2)}\n–ú–ê–ö–†–û–§–ê–ö–¢–û–†–´: ${macroText.join(', ')}.\n\n–ü—Ä–æ–≤–µ—Ä—å –¥–ª–∏–Ω—É: 5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ 700‚Äì900 —Å–∏–º–≤–æ–ª–æ–≤.`;

  const payload = {
    "contents": [{ "parts": [{ "text": systemPrompt }, { "text": userPrompt }] }],
    "generationConfig": {
      "temperature": 0.25,
      "maxOutputTokens": 2500
    },
    "safetySettings": [
      { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
      { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" }
    ]
  };

  const options = { 
    method: 'post', 
    contentType: 'application/json', 
    payload: JSON.stringify(payload), 
    muteHttpExceptions: true 
  };

  try {
    const response = UrlFetchApp.fetch(url, options);
    const responseText = response.getContentText();
    Logger.log(`Gemini Analyst Raw Response: ${responseText.substring(0, 500)}...`);
    const json = JSON.parse(responseText);
    
    if (json.error) {
      Logger.log(`–û—à–∏–±–∫–∞ API Gemini Analyst: ${json.error.message}`);
      return { success: false, error: json.error.message, rawContent: `–û—à–∏–±–∫–∞ API: ${json.error.message}` };
    }
    
    if (json.candidates && json.candidates[0] && json.candidates[0].content && json.candidates[0].content.parts) {
      let aiText = json.candidates[0].content.parts[0].text;
      
      // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ Markdown (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      aiText = aiText.replace(/[#*`]/g, '').trim();
      
      return { success: true, text: aiText };
    }
    return { success: false, error: '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Gemini', rawContent: '–ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç' };
  } catch (e) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ executeGeminiRequest: ${e.stack}`);
    return { success: false, error: e.message, rawContent: `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${e.message}` };
  }
}

/**
 * [v1.0] –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
 * @param {Object} aiData –î–∞–Ω–Ω—ã–µ –æ—Ç –ò–ò.
 * @param {Object} originalData –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */
function validateAIResponse(aiData, originalData) {
  const validated = { ...aiData };
  const originalPrice = originalData.price || originalData.ourPrice || 0;
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã: –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ—Ç–∫–ª–æ–Ω—è—Ç—å—Å—è –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 30% –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–π
  if (validated.pricing && validated.pricing.recommendedPrice) {
    const recPrice = validated.pricing.recommendedPrice;
    const deviation = Math.abs(recPrice - originalPrice) / originalPrice;
    
    if (deviation > 0.3 && originalPrice > 0) {
      validated.pricing.warning = `–ò–ò —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª —Ü–µ–Ω—É ${recPrice}, —á—Ç–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –Ω–∞ ${(deviation * 100).toFixed(0)}% –æ—Ç —Ç–µ–∫—É—â–µ–π. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞.`;
      validated.pricing.originalRecommendation = recPrice;
      // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–æ ¬±30%
      validated.pricing.recommendedPrice = recPrice > originalPrice 
        ? Math.floor(originalPrice * 1.30) 
        : Math.floor(originalPrice * 0.70);
    }
  }
  
  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ä–æ–∫–∞: –Ω–µ –±–æ–ª–µ–µ 36 –º–µ—Å—è—Ü–µ–≤
  if (validated.timeline && validated.timeline.expectedMonths) {
    if (validated.timeline.expectedMonths > 36) {
      validated.timeline.warning = `–ò–ò –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–ª ${validated.timeline.expectedMonths} –º–µ—Å, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 36 (–º–∞–∫—Å–∏–º—É–º).`;
      validated.timeline.expectedMonths = 36;
    }
    if (validated.timeline.expectedMonths < 0.5) {
      validated.timeline.warning = `–ò–ò –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–ª ${validated.timeline.expectedMonths} –º–µ—Å, —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ –¥–æ 0.5 (–º–∏–Ω–∏–º—É–º).`;
      validated.timeline.expectedMonths = 0.5;
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  validated.validated = true;
  validated.validationTimestamp = new Date().toISOString();
  
  return validated;
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Gemini.
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ—ë –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ GAS, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–ª—é—á–∏ –∏ –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏.
 */
function testGeminiApiConnection() {
  const testData = {
    object: { district: "–¶–µ–Ω—Ç—Ä", rooms: 2, area: 50, price: 8500000 },
    market: { demand: 2.5, active: 15, rank: 3, avgActivePrice: 175000 },
    forecast: { marketPrice: 8200000, marketMonths: 3 }
  };
  
  const macro = { keyRate: 21, mortgageRate: 28, marketTrend: "—Å—Ç–∞–≥–Ω–∞—Ü–∏—è" };
  
  Logger.log("üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ API Gemini...");
  try {
    const result = callGeminiAnalyst(testData, macro);
    if (result.success) {
      Logger.log("‚úÖ –¢–ï–°–¢ –£–°–ü–ï–®–ï–ù!");
      Logger.log("–û—Ç–≤–µ—Ç –ò–ò: " + JSON.stringify(result, null, 2));
    } else {
      Logger.log("‚ùå –¢–ï–°–¢ –ü–†–û–í–ê–õ–ï–ù: " + result.error);
      if (result.rawContent) Logger.log("–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: " + result.rawContent);
    }
  } catch (e) {
    Logger.log("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ–π —Ç–µ—Å—Ç–∞: " + e.stack);
  }
}

/**
 * [v1.1] –ü–æ–ª—É—á–∞–µ—Ç –º–∞–∫—Ä–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç. –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Å—á–∏—Ç–∞—Ç—å —Å –ª–∏—Å—Ç–∞ '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
 * –µ—Å–ª–∏ –ª–∏—Å—Ç–∞ –Ω–µ—Ç ‚Äî –±–µ—Ä–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
 * @returns {Object} –ú–∞–∫—Ä–æ–∫–æ–Ω—Ç–µ–∫—Å—Ç.
 */
function getMacroContext() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SETTINGS_SHEET_NAME);
    
    if (sheet) {
      const data = sheet.getRange('B2:B6').getValues();
      const normalizePerc = (val) => {
        const n = parseFloat(val);
        // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–∞–±–ª–∏—Ü–µ 0.16 (–∫–∞–∫ 16%), –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ 16 –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Å–∏–º–≤–æ–ª–æ–º %
        return (n > 0 && n < 1) ? Math.round(n * 100) : n;
      };
      
      return {
        keyRate: normalizePerc(data[0][0]) || 21,
        mortgageRate: normalizePerc(data[1][0]) || 28,
        familyMortgage: String(data[2][0]).toLowerCase().includes('–¥–∞') || data[2][0] === true,
        marketTrend: String(data[3][0]) || '—Å—Ç–∞–≥–Ω–∞—Ü–∏—è',
        region: String(data[4][0]) || '–¢—é–º–µ–Ω—å'
      };
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –ª–∏—Å—Ç–∞: ' + e.message);
  }
  
  // –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ, –µ—Å–ª–∏ –ª–∏—Å—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—É—Å—Ç)
  return {
    keyRate: null,            // –ù–µ –≤—ã–≤–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    mortgageRate: null,       // –ù–µ –≤—ã–≤–æ–¥–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
    familyMortgage: true,     
    marketTrend: '—Å—Ç–∞–≥–Ω–∞—Ü–∏—è', 
    region: ''          
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –æ–∫–Ω–æ –∞–Ω–∞–ª–∏–∑–∞ (–¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞).
 * –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
 * 1) –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω sheetOverride –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã C1/C2 ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö.
 * 2) ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏!B8 (–ü–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞, –º–µ—Å).
 * 3) –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (DEFAULT_PERIOD_MONTHS).
 */
function getAnalysisWindow(sheetOverride) {
  const today = new Date();

  try {
    if (sheetOverride) {
      const startCandidate = sheetOverride.getRange('C1').getValue();
      const endCandidate = sheetOverride.getRange('C2').getValue();
      const startDate = startCandidate ? new Date(startCandidate) : null;
      const endDate = endCandidate ? new Date(endCandidate) : today;
      if (startDate && !isNaN(startDate.getTime()) && endDate && !isNaN(endDate.getTime())) {
        const months = Math.max(1, (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 30.4375));
        return { startDate, endDate, months };
      }
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è C1/C2: ' + e.message);
  }

  let months = ANALYSIS_SETTINGS.DEFAULT_PERIOD_MONTHS;
  try {
    const settingsSheet = SPREADSHEET.getSheetByName(SETTINGS_SHEET_NAME);
    if (settingsSheet) {
      const raw = settingsSheet.getRange(ANALYSIS_SETTINGS.PERIOD_MONTHS_CELL).getValue();
      const parsed = parseFloat(raw);
      if (!isNaN(parsed) && parsed > 0) months = parsed;
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞ –∞–Ω–∞–ª–∏–∑–∞ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + e.message);
  }

  const startDate = new Date(today.getTime() - months * 30.4375 * 24 * 60 * 60 * 1000);
  const endDate = today;
  return { startDate, endDate, months };
}

// ================== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø API –ö–õ–Æ–ß–ê–ú–ò (ROTATION) ==================

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –ø—É–ª –∫–ª—é—á–µ–π Gemini –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞.
 */
function getGeminiKeyPool() {
  let keysStr = '';
  
  // 1. –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å —Å –ª–∏—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  try {
    const sheet = SPREADSHEET.getSheetByName(SETTINGS_SHEET_NAME);
    if (sheet) {
      keysStr = String(sheet.getRange('B7').getValue() || '').trim();
    }
  } catch (e) {
    Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∫–ª—é—á–µ–π —Å –ª–∏—Å—Ç–∞: ' + e.message);
  }
  
  // 2. –ï—Å–ª–∏ –Ω–∞ –ª–∏—Å—Ç–µ –ø—É—Å—Ç–æ, –±–µ—Ä–µ–º –∏–∑ —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞
  if (!keysStr) {
    keysStr = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEYS') || '';
  }
  
  // 3. –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –ø—É—Å—Ç–æ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª—é—á
  if (!keysStr) {
    const oldKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    return oldKey ? [oldKey] : [];
  }
  
  return keysStr.split(/[\s,;]+/).map(k => k.trim()).filter(k => k && k.length > 5);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π API-–∫–ª—é—á Gemini –∏–∑ –ø—É–ª–∞.
 */
function getGeminiApiKey() {
  const pool = getGeminiKeyPool();
  if (pool.length === 0) return null;
  
  let index = parseInt(PropertiesService.getScriptProperties().getProperty('GEMINI_KEY_INDEX') || '0');
  if (index >= pool.length) {
    index = 0;
    PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', '0');
  }
  return pool[index];
}

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á –≤ –ø—É–ª–µ.
 */
function rotateGeminiApiKey() {
  const pool = getGeminiKeyPool();
  if (pool.length <= 1) return;
  
  let index = parseInt(PropertiesService.getScriptProperties().getProperty('GEMINI_KEY_INDEX') || '0');
  index = (index + 1) % pool.length;
  PropertiesService.getScriptProperties().setProperty('GEMINI_KEY_INDEX', index.toString());
  Logger.log(`üîÑ API –∫–ª—é—á –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –∏–Ω–¥–µ–∫—Å ${index}`);
}

/**
 * –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ markdown.
 * @param {string} text –¢–µ–∫—Å—Ç –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {string} –û—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
 */
function cleanText(text) {
  return text.replace(/^[#*-\s\d\.]+/gm, '').replace(/\*{1,2}(.*?)\*{1,2}/g, '$1');
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –æ–±–ª–∞—Å—Ç–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∏—Ä–µ ('-') –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.
 */
function setDashesOnError() { 
  const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS);
  if (analyticsSheet && analyticsSheet.getLastRow() >= 6) analyticsSheet.getRange('A6:AQ' + analyticsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ª–∏—Å—Ç
  
  const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS);
  if (competitorsSheet && competitorsSheet.getLastRow() >= 2) competitorsSheet.getRange('A2:M' + competitorsSheet.getLastRow()).setValue('-'); // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  
  const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
  if (addressSheet) { 
    addressSheet.getRange('A4:B50').clearContent().clearFormat(); // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    addressSheet.getRange('A4').setValue('–ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê'); // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  } 
}

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ –ª–∏—Å—Ç—É —Å –æ—Ç—á–µ—Ç–æ–º.
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet –õ–∏—Å—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */

/**
 * –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–±—â–µ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ä–∞–±–æ—á–∏–º –ª–∏—Å—Ç–∞–º.
 */
function formatSheets() {
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.MAIN_ANALYTICS); 
    if (analyticsSheet) { 
        analyticsSheet.getRange('A6:AQ1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        analyticsSheet.getRange('V6:AQ1000').setHorizontalAlignment('center'); // –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        analyticsSheet.getRange('A5:AQ5').setBackground('#D3D3D3').setFontWeight('bold').setFontSize(9); // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ –∞–¥—Ä–µ—Å—É/–∫–æ–¥—É
    const addressSheet = SPREADSHEET.getSheetByName(SHEETS.ADDRESS_ANALYTICS); 
    if (addressSheet) { 
        addressSheet.getRange('B2').setHorizontalAlignment('center').setBackground('#4ee1f6').setBorder(true, true, true, true, false, false).setFontSize(9); // –Ø—á–µ–π–∫–∞ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        formatReportSheet(addressSheet); // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞
    }
    
    // –õ–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞ (–æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç—á–µ—Ç)
    const reportSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (reportSheet) {
      formatReportSheet(reportSheet);
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.COMPETITORS); 
    if (competitorsSheet) { 
        competitorsSheet.getRange('A2:N1000').setFontSize(9).setHorizontalAlignment('left').setVerticalAlignment('middle'); // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    }
}

/**
 * [v1.0] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –æ—Ç—á–µ—Ç–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≤—ã—Å–æ—Ç–æ–π.
 */
function formatReportSheet(sheet) {
  if (!sheet) return;
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ –ë (–∑–Ω–∞—á–µ–Ω–∏—è)
  sheet.getRange('B4:B150').setWrap(true).setVerticalAlignment('middle');
  sheet.getRange('A4:A150').setVerticalAlignment('middle');
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫ –¥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ–ø–æ–¥–±–æ—Ä–æ–º
  // sheet.setRowHeights(4, 150, 21); // –£–±—Ä–∞–ª, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –º–æ–∂–µ—Ç —Å–±–∏—Ç—å —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –≤—ã—Å–æ—Ç—ã –ò–ò
  
  // –ê–≤—Ç–æ–ø–æ–¥–±–æ—Ä –≤—ã—Å–æ—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ù–ï –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–• —è—á–µ–µ–∫)
  sheet.autoResizeRows(4, 150);
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã—Å–æ—Ç—ã –¥–ª—è –û–ë–™–ï–î–ò–ù–ï–ù–ù–´–• —è—á–µ–µ–∫ (—Å–∏–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
  // autoResizeRows —á–∞—Å—Ç–æ —Å—Ö–ª–æ–ø—ã–≤–∞–µ—Ç –º–µ—Ä–∂-—è—á–µ–π–∫–∏ –¥–æ –º–∏–Ω–∏–º—É–º–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–º –ø—Ä–∏—è—Ç–Ω—ã–π –≤–∏–¥
  const values = sheet.getRange('A4:B150').getValues();
  for (let i = 0; i < values.length; i++) {
    const rowNum = 4 + i;
    const title = String(values[i][0] || '');
    const val = String(values[i][1] || '');
    
    // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Ñ–æ–Ω –º—ã –ø—Ä–æ–≤–µ—Ä–∏–º —á–µ—Ä–µ–∑ getBackground –≤ –∏–¥–µ–∞–ª–µ, –Ω–æ —Ç—É—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É)
    if (title && val === '' && !title.includes('---')) {
      sheet.setRowHeight(rowNum, 25); // –ö–æ–º—Ñ–æ—Ä—Ç–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
    }
  }
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö –≤ –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥.
 * @param {number|string} months –°—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {string} –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ä–æ–∫.
 */

// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ê–¢–ï–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –§–£–ù–ö–¶–ò–ò ==================

/**
 * –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä–æ–∫—É, –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ç–∏—Ä–µ.
 * @param {number} length –î–ª–∏–Ω–∞ —Å—Ç—Ä–æ–∫–∏.
 * @returns {Array<string>} –ú–∞—Å—Å–∏–≤ –∏–∑ —Ç–∏—Ä–µ.
 */
function createDashRow(length) { return new Array(length).fill('-'); }

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateAverage(arr) { 
  if (!arr || arr.length === 0) return 0; 
  return Math.floor(arr.reduce((a, b) => a + b, 0) / arr.length); 
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ —á–∏—Å–µ–ª.
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @returns {number} –ú–µ–¥–∏–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
 */
function calculateMedian(arr) { 
  if (!arr || arr.length === 0) return 0; 
  const sorted = [...arr].sort((a, b) => a - b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 !== 0 ? sorted[mid] : Math.floor((sorted[mid - 1] + sorted[mid]) / 2); // –°—Ä–µ–¥–Ω–µ–µ –¥–≤—É—Ö —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —á–µ—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ (—Å –æ—Ç—Å–µ—á–µ–Ω–∏–µ–º –∫—Ä–∞–π–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π).
 * @param {Array<number>} arr –ú–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª.
 * @param {number} percent –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç—Å–µ–∫–∞–µ–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∞—è.
 * @returns {number} –£—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ.
 */
function calculateTrimmedMean(arr, percent) { 
  if (!arr || arr.length === 0) return 0; 
  const safePercent = (typeof percent === 'number') ? percent : (typeof TRIM_PERCENTAGE === 'number' ? TRIM_PERCENTAGE : 0.2);
  const sorted = [...arr].sort((a,b) => a-b); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤
  const trimCount = Math.floor(sorted.length * safePercent); // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç—Å–µ—á–µ–Ω–∏—è
  const trimmedArr = sorted.slice(trimCount, sorted.length - trimCount); // –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
  return trimmedArr.length > 0 ? calculateAverage(trimmedArr) : calculateAverage(arr); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ —É—Å–µ—á–µ–Ω–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞, –µ—Å–ª–∏ —É—Å–µ—á–µ–Ω–∏–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ (–Ω–∞–∫–ª–æ–Ω –∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ).
 * @param {Array<Array<number>>} data –ú–∞—Å—Å–∏–≤ –ø–∞—Ä [x, y].
 * @returns {{slope: number, intercept: number}|null} –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –∏–ª–∏ null.
 */
function calculateLinearRegression(data) { 
  if (!data || data.length < 2) return null; 
  
  // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–≤—É—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤: [x, y] –∏ {x, y}
  const points = data.map(p => Array.isArray(p) ? ({ x: p[0], y: p[1] }) : p);
  
  let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0, sumYY = 0;
  const n = points.length;
  
  points.forEach(p => { 
    sumX += p.x; 
    sumY += p.y; 
    sumXY += p.x * p.y; 
    sumXX += p.x * p.x; 
    sumYY += p.y * p.y; 
  }); 
  
  const denominator = (n * sumXX - sumX * sumX);
  if (denominator === 0) return null; // –ò–∑–±–µ–≥–∞–µ–º –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
  
  const slope = (n * sumXY - sumX * sumY) / denominator; // –ù–∞–∫–ª–æ–Ω
  const intercept = (sumY - slope * sumX) / n; // –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
  
  // R¬≤
  const yMean = sumY / n;
  const ssRes = points.reduce((sum, p) => sum + Math.pow(p.y - (slope * p.x + intercept), 2), 0);
  const ssTot = points.reduce((sum, p) => sum + Math.pow(p.y - yMean, 2), 0);
  const r2 = ssTot > 0 ? 1 - (ssRes / ssTot) : 0;
  
  return { slope, intercept, r2 }; 
}

/**
 * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ Google –¢–∞–±–ª–∏—Ü—ã.
 * –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç –∑–∞–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤, –¥–æ–±–∞–≤–ª—è—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
 * @param {Array<Array<any>>} data –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} columns –û–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤.
 * @returns {Array<Array<any>>} –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.
 */
function formatForBatchWrite(data, columns) { 
  return data.map(row => { 
    const newRow = [...row]; // –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ, —á–µ–º –æ–∂–∏–¥–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤
    while (newRow.length < columns) newRow.push(''); 
    return newRow.slice(0, columns); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω—É–∂–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç–æ–ª–±—Ü–æ–≤
  }); 
}

// ================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–û–ì–û –ê–ù–ê–õ–ò–ó–ê ==================

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –ª–∏—Å—Ç—ã –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–æ–≤.
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.
 */
function setupNewSheets() {
  try {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É"
    setupSingleObjectAnalyticsSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    setupAnalysisObjectSheet();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏—Å—Ç–∞ "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    setupCompetitorsAnalysisSheet();
    
    SpreadsheetApp.getUi().alert('‚úÖ –ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!');
    Logger.log('–ù–æ–≤—ã–µ –ª–∏—Å—Ç—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ setupNewSheets: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –Ω–æ–≤—ã—Ö –ª–∏—Å—Ç–æ–≤: ' + e.message);
  }
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
 */
function setupAnalysisObjectSheet() {
  const sheet = SPREADSHEET.getSheetByName('–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ (A2:AP2)
  const headers = [
    '–î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', 
    '–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–¶–µ–Ω–∞', '–≠—Ç–∞–∂', '–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', 
    '–§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞', '–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?', '–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?', '–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?',
    '–∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞', '—Ü–∏–∞–Ω', '–¥–∞—Ç–∞', '–¥–æ–º–∫–ª–∏–∫', '–¥–∞—Ç–∞',
    '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ', '–ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ', '—Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å', '–ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å', '–¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏', 
    '–û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞', '–¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %', '–º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –ø–æ —Ü–µ–Ω–µ –º¬≤', 
    '–¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å', '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %', 
    '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '—Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %', '—Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', '—Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù', 
    '—Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %', '–¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)', '–°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.', 
    '–¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)', '–°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:AQ2').clearContent();
  sheet.getRange('A2:AP2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:AP2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:AQ1000').clearContent();
  sheet.getRange('A3:AP1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç—Ä–∏–∫
  sheet.getRange('V3:AP1000').setHorizontalAlignment('center');
  
  Logger.log('–õ–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏.
 */
function setupCompetitorsAnalysisSheet() {
  const sheet = SPREADSHEET.getSheetByName('–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –ª–∏—Å—Ç–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∫–∞–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º –ª–∏—Å—Ç–µ)
  const headers = [
    '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', 
    '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
  ];
  
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
  sheet.getRange('A2:M2').setValues([headers]);
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
  sheet.getRange('A2:M2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  sheet.getRange('A3:M1000')
    .setFontSize(9)
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  Logger.log('–õ–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" —Å –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ –∫–æ–¥–∞.
 */
function setupSingleObjectAnalyticsSheet() {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
  if (!sheet) {
    throw new Error('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ A2 - –∑–∞–≥–æ–ª–æ–≤–æ–∫
  sheet.getRange('A2')
    .setValue('–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞')
    .setFontSize(9)
    .setFontWeight('bold')
    .setHorizontalAlignment('left')
    .setVerticalAlignment('middle');
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —è—á–µ–π–∫–∏ B2 - –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
  sheet.getRange('B2')
    .setHorizontalAlignment('center')
    .setBackground('#4ee1f6')
    .setBorder(true, true, true, true, false, false)
    .setFontSize(9)
    .setVerticalAlignment('middle');
  
  // –û—á–∏—Å—Ç–∫–∞ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç—á–µ—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å 4 —Å—Ç—Ä–æ–∫–∏)
  sheet.getRange('A4:B50').clearContent().clearFormat();
  
  Logger.log('–õ–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
}

/**
 * –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É –≤ –ª–∏—Å—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.
 * @returns {Array|null} –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
 */
function findObjectByCode(code) {
  try {
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!code || typeof code !== 'string') {
      Logger.log('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    const cleanCode = String(code).trim();
    if (cleanCode === '') {
      Logger.log('–ü—É—Å—Ç–æ–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–∏—Å—Ç–∞ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"
    const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
    if (!activeSheet) {
      Logger.log('–õ–∏—Å—Ç "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return null;
    }
    
    const lastRow = activeSheet.getLastRow();
    if (lastRow < 3) {
      Logger.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ"');
      return null;
    }
    
    // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–ª–∏–ø–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)
    CacheService.getScriptCache().remove(`HEADERMAP_${activeSheet.getName()}`);
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    const dataResult = readSheetDataWithHeader(activeSheet);
    const data = dataResult.rows;
    const headerMap = dataResult.headerMap;
    let codeCol = getColumnIndexByField(headerMap, 'code');
    
    // [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–û–õ–õ–ò–ó–ò–ò]: –ï—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞—Å—å –∫–∞–∫ "–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞" –∏–ª–∏ "–†–∞–π–æ–Ω", —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ—ë
    if (codeCol) {
      const headerKey = Object.keys(headerMap).find(k => headerMap[k] === codeCol) || '';
      if (headerKey.includes('—Ç–∏–ø') || headerKey.includes('—Ä–∞–π–æ–Ω')) {
        if (IS_DEBUG) Logger.log(`‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ "${headerKey}" –æ—à–∏–±–æ—á–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞ –∑–∞ –∫–æ–¥. –°–±—Ä–∞—Å—ã–≤–∞–µ–º...`);
        codeCol = null;
      }
    }
    
    if (!codeCol) {
      codeCol = getColumnIndexByHeader(headerMap, ['–∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–∫–æ–¥', 'id']);
    }
    if (!codeCol) {
      codeCol = getColumnIndexByKeywords(headerMap, ['–∫–æ–¥', 'id', '–Ω–æ–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞']);
    }
    
    // –ï—Å–ª–∏ –≤—Å—ë –µ—â–µ –Ω–µ –Ω–∞—à–ª–∏, –Ω–æ –µ—Å—Ç—å "–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç" (–∫–∞–∫ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∏—Ä—É–µ–º –µ—ë
    if (!codeCol) {
      codeCol = getColumnIndexByHeader(headerMap, ['—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç']);
    }
    
    if (!codeCol) codeCol = 6; // Fallback –Ω–∞ –∫–æ–ª–æ–Ω–∫—É F
    
    // –ü–æ–∏—Å–∫ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞
    let foundRow = null;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–ª–æ–Ω–∫–∏ –∫–æ–¥–∞
    if (data.length > 0) {
      const firstRowCode = data[0][codeCol - 1];
      const isLikelyNotCode = /^[–ê-–Ø–∞-—è–Å—ëA-Za-z\s]+$/.test(String(firstRowCode));
      if (isLikelyNotCode && codeCol === 6) {
         Logger.log(`‚ö†Ô∏è –ö–æ–ª–æ–Ω–∫–∞ ${codeCol} —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–∫—Å—Ç ("${firstRowCode}"), –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ –Ω–µ –∫–æ–¥. –ò—â–µ–º –∑–∞–Ω–æ–≤–æ...`);
         // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫–∞—Ç—å –ø–æ –∞–ª–∏–∞—Å–∞–º –∏–Ω–∞—á–µ
         const altCodeCol = getColumnIndexByHeader(headerMap, FIELD_ALIASES.code);
         if (altCodeCol) codeCol = altCodeCol;
      }
    }

    foundRow = data.find(row => {
      const rowCode = row[codeCol - 1];
      return codesEqual(rowCode, cleanCode);
    });
    
    // [–î–û–ü–û–õ–ù–ï–ù–ò–ï]: –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ - –∏—â–µ–º –ø–æ –≤—Å–µ–º (fallback)
    if (!foundRow) {
      if (IS_DEBUG) Logger.log(`–û–±—ä–µ–∫—Ç ${cleanCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–ª–æ–Ω–∫–µ ${codeCol}. –ü—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –∫–æ–ª–æ–Ω–∫–∞–º...`);
      foundRow = data.find(row => {
        const foundIdx = row.findIndex(cell => codesEqual(cell, cleanCode));
        if (foundIdx !== -1) {
          Logger.log(`üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –û–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–ª–æ–Ω–∫–µ ${foundIdx + 1}, –∞ –Ω–µ –≤ ${codeCol}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏.`);
          return true;
        }
        return false;
      });
    }

    if (foundRow) {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö`);
      return foundRow;
    } else {
      Logger.log(`–û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${cleanCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ${data.length} —Å—Ç—Ä–æ–∫, –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏)`);
      return null;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ findObjectByCode: ${e.stack}`);
    return null;
  }
}

/**
 * –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} code –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {boolean} –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–¥–∞.
 */
function validateCode(code) {
  if (!code || typeof code !== 'string') return false;
  const cleanCode = String(code).trim();
  return cleanCode !== '' && cleanCode.length > 0;
}

/**
 * –°—Ç—Ä–æ–∏—Ç –º–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏.
 */
function buildSingleObjectCompetitorsArray(objectData, objectCode) {
  try {
    Logger.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...');
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞
    const district = objectData[1]; // –†–∞–π–æ–Ω
    const type = objectData[2]; // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    const rooms = Number(objectData[3]); // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    const area = Number(objectData[4]); // –ü–ª–æ—â–∞–¥—å
    const repair = objectData[6]; // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    const buildYear = Number(objectData[10]); // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    
    Logger.log(`–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}, —Ä–µ–º–æ–Ω—Ç=${repair}, –≥–æ–¥=${buildYear}`);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const activeDataResult = getActiveCompetitorsData();
    const activeData = activeDataResult.rows || [];
    const activeHeaderMap = activeDataResult.headerMap || {};
    const soldDataResult = getSoldCompetitorsData();
    const soldData = soldDataResult.rows || [];
    const soldHeaderMap = soldDataResult.headerMap || {};
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤: ${activeData.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: ${soldData.length}`);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–ª–∞–≥–∞–º–∏)
    const activeCompetitors = filterCompetitorsByCriteria(activeData, {
      district, type, rooms, area, repair, buildYear
    }, true, activeHeaderMap); // true = –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    const soldCompetitors = filterCompetitorsByCriteria(soldData, {
      district, type, rooms, area, repair, buildYear
    }, false, soldHeaderMap); // false = –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    
    Logger.log(`–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${activeCompetitors.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${soldCompetitors.length}`);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–≤–æ–¥–∞
    const formattedActive = activeCompetitors.map(row => formatCompetitorRow(row, false, activeHeaderMap));
    const formattedSold = soldCompetitors.map(row => formatCompetitorRow(row, true, soldHeaderMap));
    
    Logger.log(`–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ: –∞–∫—Ç–∏–≤–Ω—ã—Ö=${formattedActive.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö=${formattedSold.length}`);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    fillCompetitorsSheet(formattedActive, formattedSold, objectCode || objectData[5], objectData, activeHeaderMap); 
    
    Logger.log('–ú–∞—Å—Å–∏–≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    
    return {
      activeCompetitors: formattedActive,
      soldCompetitors: formattedSold,
      soldRaw: soldCompetitors,
      soldHeaderMap: soldHeaderMap
    };
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ buildSingleObjectCompetitorsArray: ${e.stack}`);
    return { activeCompetitors: [], soldCompetitors: [], soldRaw: [], soldHeaderMap: null };
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getActiveCompetitorsData() {
  const activeSheet = SPREADSHEET.getSheetByName(SHEETS.ACTIVE_COMPETITORS);
  if (!activeSheet || activeSheet.getLastRow() < 3) return { rows: [], headerMap: {} };
  return readSheetDataWithHeader(activeSheet);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Array} –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 */
function getSoldCompetitorsData() {
  const soldSheet = SPREADSHEET.getSheetByName(SHEETS.SOLD_COMPETITORS);
  if (!soldSheet || soldSheet.getLastRow() < 2) return { rows: [], headerMap: {} };
  return readSheetDataWithHeader(soldSheet);
}

/**
 * –§–∏–ª—å—Ç—Ä—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} data –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 * @param {boolean} isActiveData –ê–∫—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 * @returns {Array} –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */
function filterCompetitorsByCriteria(data, criteria, isActiveData = true, headerMap) {
  const { district, type, rooms, area, repair, buildYear } = criteria;
  
  Logger.log(`–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º: —Ä–∞–π–æ–Ω=${district}, —Ç–∏–ø=${type}, –∫–æ–º–Ω–∞—Ç=${rooms}, –ø–ª–æ—â–∞–¥—å=${area}`);
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ 6 –º–µ—Å—è—Ü–µ–≤
  const { startDate, endDate } = getAnalysisWindow();
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É, —Å—Ç–∞—Ä—à–µ –∫–æ—Ç–æ—Ä–æ–π –æ–±—ä–µ–∫—Ç—ã —Å—á–∏—Ç–∞—é—Ç—Å—è "—É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏" (6 –º–µ—Å—è—Ü–µ–≤)
  const staleDate = startDate;
  
  Logger.log(`–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã: staleDate=${staleDate.toLocaleDateString()}, startDate=${startDate.toLocaleDateString()}, endDate=${endDate.toLocaleDateString()}`);
  
  let filteredCount = 0;
  
  // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Å–µ–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
  const result = data.filter((row, index) => {
    try {
      const rowDateObj = parseDateSafe(getRowField(row, headerMap, 'date', 0));
      if (!rowDateObj) return false;
      const rowDate = rowDateObj;
      const rowDistrict = getRowField(row, headerMap, 'district', 1);
      const rowType = getRowField(row, headerMap, 'objectType', 2);
      const rowRooms = Number(getRowField(row, headerMap, 'rooms', 3));
      const rowArea = Number(getRowField(row, headerMap, 'area', 4));
      const rowRepair = getRowField(row, headerMap, 'repair', 6);
      const rowBuildYear = Number(getRowField(row, headerMap, 'buildYear', 10)) || null;
      
      // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      if (index < 3) {
        Logger.log(`–°—Ç—Ä–æ–∫–∞ ${index}: —Ä–∞–π–æ–Ω="${rowDistrict}", —Ç–∏–ø="${rowType}", –∫–æ–º–Ω–∞—Ç=${rowRooms}, –ø–ª–æ—â–∞–¥—å=${rowArea}, —Ä–µ–º–æ–Ω—Ç="${rowRepair}", –≥–æ–¥=${rowBuildYear}`);
      }
      
      // 1. –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –§–ò–õ–¨–¢–† (—Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π!)
      if (rowDistrict !== district) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–∞–π–æ–Ω—É: "${rowDistrict}" !== "${district}"`);
        return false;
      }
      
      // 2. –¢–ò–ü –û–ë–™–ï–ö–¢–ê (—Å—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
      if (rowType !== type) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ç–∏–ø—É: "${rowType}" !== "${type}"`);
        return false;
      }
      
      // 3. –í–†–ï–ú–ï–ù–ù–û–ô –§–ò–õ–¨–¢–†
      if (isActiveData) {
        // –î–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö: –Ω–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < staleDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–∞–∫—Ç–∏–≤–Ω—ã–µ): ${rowDate.toLocaleDateString()} < ${staleDate.toLocaleDateString()}`);
          return false;
        }
      } else {
        // –î–ª—è –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö: –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤
        if (rowDate.getTime() < startDate.getTime() || rowDate.getTime() > endDate.getTime()) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ): ${rowDate.toLocaleDateString()} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`);
          return false;
        }
      }
      
      // 4. –ö–û–õ–ò–ß–ï–°–¢–í–û –ö–û–ú–ù–ê–¢ (–¥–æ–ø—É—Å–∫ +/- 1)
      const allowedRooms = [rooms, rooms + 1, rooms - 1].filter(r => r >= 0);
      if (!allowedRooms.includes(rowRooms)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º: ${rowRooms} –Ω–µ –≤ ${allowedRooms}`);
        return false;
      }
      
      // 5. –ü–õ–û–©–ê–î–¨ (–¥–æ–ø—É—Å–∫ +/- 20%)
      const minArea = area * 0.8;
      const maxArea = area * 1.2;
      if (rowArea < minArea || rowArea > maxArea) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –ø–ª–æ—â–∞–¥–∏: ${rowArea} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${minArea}-${maxArea}`);
        return false;
      }
      
      // 6. –ì–û–î –ü–û–°–¢–†–û–ô–ö–ò (–¥–æ–ø—É—Å–∫ +/- 10 –ª–µ—Ç)
      if (buildYear && rowBuildYear && (rowBuildYear < buildYear - 10 || rowBuildYear > buildYear + 10)) {
        if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ –≥–æ–¥—É: ${rowBuildYear} –Ω–µ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ ${buildYear - 10}-${buildYear + 10}`);
        return false;
      }
      
      // 7. –¢–ò–ü –†–ï–ú–û–ù–¢–ê (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞)
      const goodRepairs = ['–†–µ–º–æ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω –ø—Ä–æ–µ–∫—Ç—É', '–ï–≤—Ä–æ—Ä–µ–º–æ–Ω—Ç', '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç'];
      const objectRepairLower = repair ? repair.toLowerCase() : '';
      const isObjectGoodRepair = goodRepairs.some(gr => objectRepairLower.includes(gr.toLowerCase()));
      
      if (isObjectGoodRepair) {
        // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, –∏—â–µ–º —Ç–æ–ª—å–∫–æ —Å —Ö–æ—Ä–æ—à–∏–º
        const competitorRepairLower = rowRepair ? rowRepair.toLowerCase() : '';
        if (!goodRepairs.some(gr => competitorRepairLower.includes(gr.toLowerCase()))) {
          if (index < 3) Logger.log(`  ‚ùå –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø–æ —Ä–µ–º–æ–Ω—Ç—É: "${rowRepair}" –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ö–æ—Ä–æ—à–µ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞`);
          return false;
        }
      }
      // –ï—Å–ª–∏ —É –æ–±—ä–µ–∫—Ç–∞ –æ–±—ã—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç - —Ñ–∏–ª—å—Ç—Ä –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
      
      if (index < 3) Logger.log(`  ‚úÖ –°—Ç—Ä–æ–∫–∞ ${index} –ø—Ä–æ—à–ª–∞ –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã!`);
      filteredCount++;
      return true;
    } catch (e) {
      Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–æ–∫–∏ ${index}: ${e.message}`);
      return false;
    }
  });
  
  Logger.log(`–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ ${filteredCount} –∏–∑ ${data.length} ${isActiveData ? '–∞–∫—Ç–∏–≤–Ω—ã—Ö' : '–ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö'} –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤`);
  
  return result;
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 */
function fillCompetitorsSheet(activeCompetitors, soldCompetitors, objectCode, objectData, headerMap) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≤–∫–ª—é—á–∞—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
  sheet.getRange('A2:M' + Math.max(sheet.getMaxRows(), 100)).clearContent().clearFormat();
  
  let output = [];
  const headers = ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', '–†–∞–π–æ–Ω', '–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç', '–ü–ª–æ—â–∞–¥—å', '–¶–µ–Ω–∞', '–¶–µ–Ω–∞ –∑–∞ –º¬≤', '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π', '–°—Å—ã–ª–∫–∞', '–†–µ–º–æ–Ω—Ç', '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞', '–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å', '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'];
  
  // 1. –í—Å–µ–≥–¥–∞ –ø–∏—à–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã –≤ Row 2
  sheet.getRange('A2:M2').setValues([headers]);
  sheet.getRange('A2:M2')
    .setBackground('#D3D3D3')
    .setFontWeight('bold')
    .setFontSize(9)
    .setHorizontalAlignment('center')
    .setVerticalAlignment('middle');

  // 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≤–æ–¥–∞ (–Ω–∞—á–∏–Ω–∞—è —Å Row 3)
  // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (activeCompetitors.length > 0) {
    output.push([`–ê–ö–¢–ò–í–ù–´–ï –ö–û–ù–ö–£–†–ï–ù–¢–´ (–í–∞—à –æ–±—ä–µ–∫—Ç: ${objectCode})`]);
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —Å –Ω–∞—à–∏–º –æ–±—ä–µ–∫—Ç–æ–º + –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏
    const allActiveObjects = [...activeCompetitors];
    if (objectData) {
      const ourObjectAsCompetitor = formatCompetitorRow(objectData, false, headerMap);
      allActiveObjects.push(ourObjectAsCompetitor);
    }
    
    const sortedActiveCompetitors = allActiveObjects.sort((a, b) => (Number(a[5]) || 0) - (Number(b[5]) || 0));
    output.push(...sortedActiveCompetitors);
    output.push(['']); // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
  if (soldCompetitors.length > 0) {
    output.push([`–ü–†–û–î–ê–ù–ù–´–ï –ö–û–ù–ö–£–†–ï–ù–¢–´`]);
    
    const sortedSoldCompetitors = [...soldCompetitors].sort((a, b) => (Number(a[5]) || 0) - (Number(b[5]) || 0));
    output.push(...sortedSoldCompetitors);
  }
  
  // 3. –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∏–Ω–∞—è —Å Row 3
  if (output.length > 0) {
    const formattedData = formatForBatchWrite(output, 13);
    sheet.getRange(3, 1, formattedData.length, 13).setValues(formattedData);
    
    // 4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ä–∞–∑–¥–µ–ª–æ–≤
    let currentRow = 3;
    for (let i = 0; i < output.length; i++) {
        const range = sheet.getRange(currentRow, 1, 1, 13);
        if (output[i].length === 1 && output[i][0] && String(output[i][0]).includes('–ö–û–ù–ö–£–†–ï–ù–¢–´')) {
            range.merge()
                 .setBackground('#1a73e8')
                 .setFontColor('white')
                 .setFontWeight('bold')
                 .setHorizontalAlignment('center');
        } else if (output[i][0] === objectCode) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–∞—à–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            range.setBackground('#e8f0fe').setFontWeight('bold');
        }
        currentRow++;
    }
  }
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 */
function analyzeSingleObject(objectData, competitorsData, objectCode) {
  try {
    const { activeCompetitors, soldCompetitors, soldRaw, soldHeaderMap } = competitorsData;
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã
    const advertisingData = getAdvertisingData(objectCode || objectData[5]); // objectData[5] - –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞
    
    // –í—ã—á–∏—Å–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
    const metrics = calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData, soldRaw, soldHeaderMap);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞
    fillAnalysisObjectSheet(objectData, advertisingData, metrics);
    
    return metrics;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObject: ${e.stack}`);
    return null;
  }
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã –¥–ª—è –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingData(objectCode) {
  const avitoData = getAdvertisingPlatformData(SHEETS.AVITO, objectCode, 'avito');
  const cianData = getAdvertisingPlatformData(SHEETS.CIAN, objectCode, 'cian');
  const domclickData = getAdvertisingPlatformData(SHEETS.DOMCLICK, objectCode, 'domclick');
  
  return {
    avito: avitoData,
    cian: cianData,
    domclick: domclickData
  };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} sheetName –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –ø–ª–æ—â–∞–¥–∫–∏.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {Object} –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 */
function getAdvertisingPlatformData(sheetName, objectCode) {
  const sheet = SPREADSHEET.getSheetByName(sheetName);
  if (!sheet || sheet.getLastRow() < 3) {
    return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
  }

  const headerRow = detectHeaderRow(sheet, 10);
  const headerValues = sheet.getRange(headerRow, 1, 1, sheet.getLastColumn()).getValues()[0];
  const headerMap = buildHeaderIndexMap(headerValues);

  const codeCol = getColumnIndexByField(headerMap, 'code', ['—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', '—Å—Å—ã–ª–∫–∞', 'url', '–∫–æ–¥']) || 2; // fallback: B
  const statusCol = getColumnIndexByField(headerMap, 'status', [
    sheetName.replace(/\d+\.\s*/g, '').trim(), '—Å—Ç–∞—Ç—É—Å', '—Å—Ç–∞—Ç—É—Å –æ–±—ä—è–≤–ª–µ–Ω–∏—è'
  ]) || 3; // fallback: C
  const dateCol = getColumnIndexByField(headerMap, 'publishDate', [
    '–¥–∞—Ç–∞', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è',
    '–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'date', '–¥–∞—Ç–∞ –∞–≤–∏—Ç–æ', '–¥–∞—Ç–∞ —Ü–∏–∞–Ω', '–¥–∞—Ç–∞ –¥–æ–º–∫–ª–∏–∫'
  ]) || 4; // fallback: D

  const dataStartRow = headerRow + 1;
  if (dataStartRow > sheet.getLastRow()) return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };

  const data = sheet.getRange(dataStartRow, 1, sheet.getLastRow() - dataStartRow + 1, sheet.getLastColumn()).getValues();
  const foundRow = data.find(row => codesEqual(row[codeCol - 1], objectCode));

  if (foundRow) {
    return {
      status: foundRow[statusCol - 1] || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
      date: foundRow[dateCol - 1] || null
    };
  }

  return { status: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', date: null };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (–ø–æ–ª–Ω–∞—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è).
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @returns {Object} –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function calculateSingleObjectMetrics(objectData, activeCompetitors, soldCompetitors, advertisingData, soldRaw, soldHeaderMap) {
  const objectPrice = Number(objectData[7]) || 0;
  const objectArea = Number(objectData[4]) || 1;
  const objectPricePerM2 = objectArea > 0 ? objectPrice / objectArea : 0;
  
  // –ë–∞–∑–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
  const competitorsInDistrict = activeCompetitors.length;
  const totalSales = soldCompetitors.length;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏–∑–∞
  const { months: periodMonths } = getAnalysisWindow();
  Logger.log(`–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–∏–æ–¥ –∞–Ω–∞–ª–∏–∑–∞: ${periodMonths} –º–µ—Å—è—Ü–µ–≤`);
  
  // –°–ø—Ä–æ—Å (–æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü)
  const demandPerMonth = totalSales / periodMonths;

  // –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (Months of Supply) –∏ –±–∞–ª–∞–Ω—Å —Ä—ã–Ω–∫–∞
  const inventoryMonthsValue = demandPerMonth > 0 ? (competitorsInDistrict / demandPerMonth) : null;
  const inventoryMonths = inventoryMonthsValue ? inventoryMonthsValue.toFixed(1) : '-';
  const marketBalance = getMarketBalanceByInventory(inventoryMonthsValue);
  
  // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
  const liquidityType = determineLiquidityType(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
  const marketAssessment = assessMarket(competitorsInDistrict, totalSales, demandPerMonth);
  
  // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ (—Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞)
  const competitionTrend = calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths);
  
  // –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ —Ü–µ–Ω–µ
  const objectRank = calculateObjectRank(objectData, activeCompetitors);
  
  // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤
  const priceTrendPerM2 = calculatePriceTrendPerM2(soldCompetitors);
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º
  const marketRatios = calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors);
  
  // –ü—Ä–æ–≥–Ω–æ–∑—ã
  const forecasts = calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors);

  // –°—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ (DOM) –ø–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º
  const medianDomDays = calculateMedianDaysOnMarket(soldCompetitors);
  const medianDomMonths = medianDomDays ? (medianDomDays / 30.4375).toFixed(1) : '-';

  // Close-to-List Ratio (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ü–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
  const closeToListRatio = calculateCloseToListRatio(soldRaw || [], soldHeaderMap);
  
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
  const avgNewObjectsPerMonth = competitorsInDistrict / periodMonths;
  const arrivalToDemandRatio = demandPerMonth > 0 ? ((avgNewObjectsPerMonth / demandPerMonth) * 100) : 0;
  const weightedRecommendedPrice = calculateWeightedRecommendedPrice(marketRatios, forecasts);
  
  const viewsData = getViewsData(objectData[5]);
  const advertisingSummary = buildAdvertisingSummary(advertisingData, viewsData);

  return {
    competitorsInDistrict,
    totalSales,
    demandPerMonth,
    liquidityType,
    marketAssessment,
    marketBalance,
    competitionTrend,
    objectRank,
    priceTrendPerM2,
    marketRatios,
    forecasts,
    medianDomDays,
    medianDomMonths,
    closeToListRatio,
    avgNewObjectsPerMonth,
    arrivalToDemandRatio,
    weightedRecommendedPrice,
    advertisingSummary,
    inventoryMonths,
    inventoryMonthsValue
  };
}

/**
 * –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã–º–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} advertisingData –î–∞–Ω–Ω—ã–µ —Ä–µ–∫–ª–∞–º—ã.
 * @param {Object} metrics –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏.
 */
function fillAnalysisObjectSheet(objectData, advertisingData, metrics) {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
  if (!sheet) return;
  
  // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
  sheet.getRange('A3:AQ1000').clearContent();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
  const rowData = [
    objectData[0], // –î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ
    objectData[1], // –†–∞–π–æ–Ω
    objectData[2], // –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞
    objectData[3], // –ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç
    objectData[4], // –ü–ª–æ—â–∞–¥—å
    objectData[5], // –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç
    objectData[6], // –¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞
    objectData[7], // –¶–µ–Ω–∞
    objectData[8], // –≠—Ç–∞–∂
    objectData[9], // –ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π
    objectData[10], // –ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏
    objectData[11], // –§–ò–û —Ä–∏—ç–ª—Ç–æ—Ä–∞
    objectData[12], // –ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?
    objectData[13], // –û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?
    objectData[14], // –ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?
    advertisingData.avito.status, // –∞–≤–∏—Ç–æ
    advertisingData.avito.date, // –¥–∞—Ç–∞ –∞–≤–∏—Ç–æ
    advertisingData.cian.status, // —Ü–∏–∞–Ω
    advertisingData.cian.date, // –¥–∞—Ç–∞ —Ü–∏–∞–Ω
    advertisingData.domclick.status, // –¥–æ–º–∫–ª–∏–∫
    advertisingData.domclick.date, // –¥–∞—Ç–∞ –¥–æ–º–∫–ª–∏–∫
    metrics.competitorsInDistrict, // –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –≤ —Ä-–Ω–µ
    metrics.totalSales, // –ø—Ä–æ–¥–∞–∂–∏ –≤—Å–µ–≥–æ
    metrics.demandPerMonth, // —Å–ø—Ä–æ—Å, –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å
    metrics.avgNewObjectsPerMonth, // –ü—Ä–∏–±—ã—Ç–∏–µ, –æ–±/–º–µ—Å
    metrics.liquidityType, // –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏
    metrics.marketAssessment, // –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞
    metrics.competitionTrend, // –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏, %
    metrics.objectRank, // –º–µ—Å—Ç–æ/—Ä–∞–Ω–≥ –ø–æ —Ü–µ–Ω–µ –º¬≤
    metrics.priceTrendPerM2.trend + ' ' + metrics.priceTrendPerM2.indicator + (metrics.priceTrendPerM2.reliable ? '' : ' (?)'), // –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤, —Ä—É–±/–º–µ—Å
    metrics.marketRatios.activeRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö, %
    metrics.marketRatios.soldRatio, // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å —Ä—ã–Ω–∫–æ–º –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.marketRatios.avgActivePrice, // —Å—Ä. —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.activeRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏, %
    metrics.marketRatios.avgSoldPrice, // —Å—Ä. —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö
    objectData[7], // —Ü–µ–Ω–∞ –Ω–∞—à–µ–≥–æ –û–ù
    metrics.marketRatios.soldRatio, // —Ä–∞–∑–Ω–∏—Ü–∞ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö, %
    metrics.forecasts.quickPrice, // –¶–µ–Ω–∞ (–±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞)
    metrics.forecasts.quickMonths, // –°—Ä–æ–∫ (–±—ã—Å—Ç—Ä–∞—è), –º–µ—Å.
    metrics.forecasts.marketPrice, // –¶–µ–Ω–∞ (—Ä—ã–Ω–æ—á–Ω–∞—è)
    metrics.forecasts.marketMonths // –°—Ä–æ–∫ (—Ä—ã–Ω–æ—á–Ω–∞—è), –º–µ—Å.
  ];
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É 3
  sheet.getRange('A3:AP3').setValues([rowData]);
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫—Ä–∞—Ç–∫–∏–π –±–ª–æ–∫ –ø–æ —Ä–µ–∫–ª–∞–º–µ/–æ—Ö–≤–∞—Ç—É –¥–ª—è –æ—Ç—á–µ—Ç–∞.
 */
function buildAdvertisingSummary(adData, viewsData) {
  const fmtValue = (status, date) => {
    const d = parseDateSafe(date);
    const dateText = d ? `, ${Utilities.formatDate(d, 'Asia/Yekaterinburg', 'dd.MM.yyyy')}` : '';
    return `${status || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}${dateText}`;
  };
  const rows = [
    ['–ê–≤–∏—Ç–æ', fmtValue(adData.avito.status, adData.avito.date)],
    ['–¶–∏–∞–Ω', fmtValue(adData.cian.status, adData.cian.date)],
    ['–î–æ–º–∫–ª–∏–∫', fmtValue(adData.domclick.status, adData.domclick.date)]
  ];
  if (viewsData && viewsData.summary) {
    rows.push(['–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', viewsData.summary]);
  } else {
    rows.push(['–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö']);
  }
  return rows;
}

/**
 * –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≥—Ä–µ–π–¥ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ —Ç–µ–∫—Å—Ç.
 */
function formatLiquidityForClient(liquidityType) {
  switch (String(liquidityType || '').toUpperCase()) {
    case 'A+': return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è';
    case 'A': return '–í—ã—Å–æ–∫–∞—è';
    case 'B': return '–°—Ä–µ–¥–Ω—è—è';
    case 'C': return '–ù–∏–∑–∫–∞—è';
    case 'C-': return '–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è';
    default: return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  }
}

/**
 * –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –ø–æ –æ–±—ä–µ–∫—Ç—É –∏–∑ –ª–∏—Å—Ç–∞ "7. 92. –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –Ω–∞ –ø–ª–æ—â–∞–¥–∫–∞—Ö".
 * –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–¥–∞/—Å—Å—ã–ª–∫–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç null.
 */
function getViewsData(objectCode) {
  const sheet = SPREADSHEET.getSheetByName('7. 92. –ø—Ä–æ—Å–º–æ—Ç—Ä—ã –Ω–∞ –ø–ª–æ—â–∞–¥–∫–∞—Ö');
  if (!sheet || sheet.getLastRow() < 2) return null;

  const headerRow = detectHeaderRow(sheet, 10);
  const headerValues1 = sheet.getRange(headerRow, 1, 1, sheet.getLastColumn()).getValues()[0];
  const headerValues2 = (headerRow + 1 <= sheet.getLastRow()) 
    ? sheet.getRange(headerRow + 1, 1, 1, sheet.getLastColumn()).getValues()[0] 
    : [];
  
  // –°–æ–∑–¥–∞–µ–º –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–∞—Ä—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∏–∑ –¥–≤—É—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤)
  const headerMap = buildHeaderIndexMap(headerValues1);
  headerValues2.forEach((val, i) => {
    const key = String(val).trim().toLowerCase();
    if (key && !headerMap[key]) headerMap[key] = i + 1;
  });

  let codeCol = getColumnIndexByField(headerMap, 'code', ['—Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç', '—Å—Å—ã–ª–∫–∞', '—Å—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç']);
  if (!codeCol) codeCol = getColumnIndexByKeywords(headerMap, ['–∫–æ–¥', 'id', '–Ω–æ–º–µ—Ä', '–æ–±—ä–µ–∫—Ç']);
  
  if (!codeCol) return null;

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö
  let dataStartRow = headerRow + 1;
  // –ï—Å–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ –Ω–∞—à–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∑–Ω–∞—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∏–∂–µ
  if (headerValues2.some(v => {
    const s = String(v).toLowerCase();
    return s.includes('—Å—Å—ã–ª–∫–∞') || s.includes('–æ–±—ä–µ–∫—Ç') || s.includes('–∫–æ–¥');
  })) {
    dataStartRow = headerRow + 2;
  }
  
  if (dataStartRow > sheet.getLastRow()) return null;

  const data = sheet.getRange(dataStartRow, 1, sheet.getLastRow() - dataStartRow + 1, sheet.getLastColumn()).getValues();
  const row = data.find(r => codesEqual(r[codeCol - 1], objectCode));
  if (!row) return null;

  const avitoCol = getColumnIndexByHeader(headerMap, ['–∞–≤–∏—Ç–æ', 'avito', '–ø–ª–æ—â–∞–¥–∫–∞ (–≥—Ä—É–ø –∞–≤–∏—Ç–æ)']);
  const cianCol = getColumnIndexByHeader(headerMap, ['—Ü–∏–∞–Ω', 'cian']);
  const domclickCol = getColumnIndexByHeader(headerMap, ['–¥–æ–º–∫–ª–∏–∫', '–¥–æ–º–∫', '–¥–æ–º –∫–ª–∏–∫', 'domclick']);
  const etagiCol = getColumnIndexByHeader(headerMap, ['—ç—Ç–∞–∂–∏', 'etagi']);
  const yandexCol = getColumnIndexByHeader(headerMap, ['—è–Ω–¥–µ–∫—Å', 'yandex']);
  const totalCol = getColumnIndexByHeader(headerMap, ['–∏—Ç–æ–≥–æ', 'total', '–≤—Å–µ–≥–æ']);

  const parts = [];
  if (avitoCol && row[avitoCol - 1]) parts.push(`–ê–≤–∏—Ç–æ ${row[avitoCol - 1]}`);
  if (cianCol && row[cianCol - 1]) parts.push(`–¶–∏–∞–Ω ${row[cianCol - 1]}`);
  if (domclickCol && row[domclickCol - 1]) parts.push(`–î–æ–º–∫–ª–∏–∫ ${row[domclickCol - 1]}`);
  if (etagiCol && row[etagiCol - 1]) parts.push(`–≠—Ç–∞–∂–∏ ${row[etagiCol - 1]}`);
  if (yandexCol && row[yandexCol - 1]) parts.push(`–Ø–Ω–¥–µ–∫—Å ${row[yandexCol - 1]}`);
  
  // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–ª–æ—â–∞–¥–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –ò—Ç–æ–≥–æ –≤ —Å–∫–æ–±–∫–∞—Ö, –∏–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ò—Ç–æ–≥–æ
  if (totalCol && row[totalCol - 1]) {
    if (parts.length > 0) {
      return { summary: `${parts.join(', ')} (–í—Å–µ–≥–æ: ${row[totalCol - 1]})` };
    } else {
      return { summary: `–í—Å–µ–≥–æ: ${row[totalCol - 1]}` };
    }
  }

  return parts.length ? { summary: parts.join(', ') } : null;
}

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–æ–¥—É.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
 */
function analyzeSingleObjectByCode(objectCode) {
  try {
    Logger.log(`–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ —Å –∫–æ–¥–æ–º: ${objectCode}`);
    
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
    if (!validateCode(objectCode)) {
      Logger.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 2. –ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      Logger.log('‚ùå –û–±—ä–µ–∫—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö');
      return false;
    }
    
    // 3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData, objectCode);
    
    // 3.1. –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const criteria = {
      district: objectData[1],
      type: objectData[2],
      rooms: Number(objectData[3]),
      area: Number(objectData[4]),
      repair: objectData[6],
      buildYear: Number(objectData[10])
    };
    writeCompetitorCriteria(objectData, criteria);
    
    // 4. –ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞
    const analysisResults = analyzeSingleObject(objectData, competitorsData, objectCode);
    
    if (!analysisResults) {
      Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞');
      return false;
    }
    
    // 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    const reportGenerated = generateSingleObjectReport(objectData, analysisResults, competitorsData);
    
    if (reportGenerated) {
      Logger.log('–ê–Ω–∞–ª–∏–∑ –æ–±—ä–µ–∫—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      return true;
    } else {
      Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
      return false;
    }
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ analyzeSingleObjectByCode: ${e.stack}`);
    Logger.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ' + e.message);
    return false;
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á–µ—Ç –ø–æ –æ–¥–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} analysisResults –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Object} competitorsData –î–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {boolean} –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
 */
function generateSingleObjectReport(objectData, analysisResults, competitorsData) {
  try {
    const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (!sheet) return false;
    
    // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞
    // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å –æ—Ç—á–µ—Ç–∞ —Å –∑–∞–ø–∞—Å–æ–º (—á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —è—á–µ–µ–∫)
    sheet.getRange('A4:B260').clearContent().clearFormat();
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞
    const reportData = createSingleObjectReportData(objectData, analysisResults, competitorsData);
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –ø–∞–∫–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
    const values = reportData.map(row => [row[0], row[1]]);
    sheet.getRange(4, 1, values.length, 2).setValues(values);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
    reportData.forEach((row, index) => {
      const rowNumber = 4 + index;
      const range = sheet.getRange(rowNumber, 1, 1, 2);
      
      // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ (—Å–∏–Ω–∏–π —Ñ–æ–Ω) - –µ—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —Å—Ç–æ–ª–±–µ—Ü –ø—É—Å—Ç–æ–π –∏ —ç—Ç–æ –Ω–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
      if (row[0] && row[1] === '' && !row[0].includes('---')) {
        range.merge()
          .setFontWeight('bold')
          .setBackground('#1a73e8')
          .setFontColor('white')
          .setFontSize(10)
          .setVerticalAlignment('middle');
      } 
      // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
      else if (row[0] && row[0].includes('---')) {
        range.merge()
          .setBackground('#f8f9fa')
          .setFontColor('#9aa0a6')
          .setFontSize(8)
          .setHorizontalAlignment('center');
      } 
      // –û–±—ã—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      else if (row[0]) {
        sheet.getRange(rowNumber, 1).setFontWeight('bold').setFontColor('#3c4043').setFontSize(9);
        const valRange = sheet.getRange(rowNumber, 2);
        valRange.setFontColor('#202124').setFontSize(9).setHorizontalAlignment('right').setWrap(true);
        
        if (row[0].includes('‚ö°') || row[0].includes('üè†')) {
          valRange.setFontWeight('bold').setFontColor('#1a73e8').setFontSize(10);
        }
        
        if (row[0].includes('–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–Ω–≥')) {
          valRange.setHorizontalAlignment('left'); 
        }
      }
    });

    // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –∫–æ –≤—Å–µ–º—É –æ—Ç—á–µ—Ç—É
    formatReportSheet(sheet);

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
    if (reportData.length > 0) {
      sheet.getRange(4, 1, reportData.length, 2).setBorder(true, true, true, true, true, true, '#e8eaed', SpreadsheetApp.BorderStyle.SOLID);
    }
    
    SpreadsheetApp.flush();
    
    // –í–´–ó–´–í–ê–ï–ú –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ö–°–¢–ê
    try {
      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –º–∏–Ω–∏–º—É–º —Å—Ç—Ä–æ–∫–∞ 35 (A35:B35), –Ω–æ —Å–¥–≤–∏–≥–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ —Ä–æ—Å—Ç–µ –æ—Ç—á–µ—Ç–∞
      const aiRowBase = Math.max(35, 4 + reportData.length + 2);
      
      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ò–ò
      sheet.getRange(aiRowBase, 1, 1, 2).merge()
        .setValue('ü§ñ –ò–¢–û–ì–û–í–´–ô –í–´–í–û–î –ê–ù–ê–õ–ò–¢–ò–ö–ê')
        .setFontWeight('bold')
        .setBackground('#202124')
        .setFontColor('white')
        .setFontSize(10)
        .setHorizontalAlignment('center')
        .setVerticalAlignment('middle');

      // –¢–µ–ª–æ –±–ª–æ–∫–∞: –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É (A:B)
      const aiBodyRange = sheet.getRange(aiRowBase + 1, 1, 1, 2).merge();
      aiBodyRange.setValue('‚è≥ –ò–¥–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –∑–∞–∫–ª—é—á–µ–Ω–∏—è...')
        .setFontSize(9)
        .setWrap(true)
        .setVerticalAlignment('top')
        .setBackground('#ffffff');
      
      // –ù–∞—á–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
      sheet.setRowHeight(aiRowBase + 1, 60);
      SpreadsheetApp.flush();

      const aiAnalysis = createSingleObjectReportText(objectData, analysisResults, competitorsData);
      aiBodyRange.setValue(aiAnalysis);

      // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ–¥ –æ–±—ä–µ–º —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è –æ–¥–Ω–æ–π –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏)
      sheet.autoResizeRows(aiRowBase + 1, 1);
      
      // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç–∞ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ, autoResize –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –º–µ—Ä–∂-—è—á–µ–µ–∫ –≤ GAS, 
      // –ø–æ—ç—Ç–æ–º—É –¥–æ–±–∞–≤–∏–º –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å –ø–æ —Ä–∞—Å—á–µ—Ç—É
      const charsPerLine = 100;
      const lineHeight = 16;
      const approxLines = Math.max(3, Math.ceil(String(aiAnalysis || '').length / charsPerLine));
      const calculatedHeight = approxLines * lineHeight + 20;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–∫—Å–∏–º—É–º –∏–∑ –∞–≤—Ç–æ –∏ —Ä–∞—Å—á–µ—Ç–∞
      const currentRowHeight = sheet.getRowHeight(aiRowBase + 1);
      sheet.setRowHeight(aiRowBase + 1, Math.max(currentRowHeight, calculatedHeight));
      
    } catch (err) {
      Logger.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –ò–ò-–±–ª–æ–∫–∞: ' + err.message);
    }
    
    Logger.log('–û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω');
    return true;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ generateSingleObjectReport: ${e.stack}`);
    return false;
  }
}

/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è AI (—á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç –±—ã–ª —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–º –∏ –¥–ª–∏–Ω–Ω–µ–µ).
 */
function buildSummaryTextForAI(objectData, analysisResults, competitorsData) {
  const price = Number(objectData[7]) || 0;
  const area = Number(objectData[4]) || 0;
  const pricePerM2 = area > 0 ? Math.round(price / area) : 0;
  const ads = analysisResults.advertisingSummary || [];

  const parts = [
    '–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—Å: –Ω–∏–∂–µ ‚Äî –∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ —Ä—ã–Ω–∫–µ, –ø–æ–∑–∏—Ü–∏–∏ –∏ —Ü–µ–Ω–µ.',
    `–û–±—ä–µ–∫—Ç: —Ä–∞–π–æ–Ω ${objectData[1]}, ${objectData[3]} –∫–æ–º–Ω., ${area} –º¬≤, —Ü–µ–Ω–∞ ${price.toLocaleString()} ‚ÇΩ, ${pricePerM2.toLocaleString()} ‚ÇΩ/–º¬≤.`,
    `–†—ã–Ω–æ–∫: —Å–ø—Ä–æ—Å ${analysisResults.demandPerMonth.toFixed(1)} –æ–±/–º–µ—Å, –∞–∫—Ç–∏–≤–Ω—ã—Ö ${competitorsData.activeCompetitors.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö ${competitorsData.soldCompetitors.length}, –ø—Ä–∏—Ç–æ–∫ ${analysisResults.avgNewObjectsPerMonth.toFixed(1)} –æ–±/–º–µ—Å, –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–Ω–∏–µ ${analysisResults.arrivalToDemandRatio.toFixed(0)}%, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ${analysisResults.liquidityType}.`,
    `–ü–æ–∑–∏—Ü–∏—è: —Ä–∞–Ω–≥ –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ ${analysisResults.objectRank} –∏–∑ ${competitorsData.activeCompetitors.length}, —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ ${analysisResults.marketRatios.activeRatio.toFixed(1)}%, —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏ ${analysisResults.marketRatios.soldRatio.toFixed(1)}%.`,
    `–¶–µ–Ω—ã: —Å—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω—ã—Ö ${Math.round(analysisResults.marketRatios.avgActivePrice).toLocaleString()} ‚ÇΩ/–º¬≤, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö ${Math.round(analysisResults.marketRatios.avgSoldPrice).toLocaleString()} ‚ÇΩ/–º¬≤.`,
    `–°—Ç—Ä–∞—Ç–µ–≥–∏–∏: –±—ã—Å—Ç—Ä–∞—è —Ü–µ–Ω–∞ ${analysisResults.forecasts.quickPrice.toLocaleString()} ‚ÇΩ (—Å—Ä–æ–∫ ${analysisResults.forecasts.quickMonths} –º–µ—Å), —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ ${analysisResults.forecasts.marketPrice.toLocaleString()} ‚ÇΩ (—Å—Ä–æ–∫ ${analysisResults.forecasts.marketMonths} –º–µ—Å), —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ ${price.toLocaleString()} ‚ÇΩ (–ø—Ä–æ–≥–Ω–æ–∑ ${analysisResults.forecasts.currentMonths || analysisResults.forecasts.marketMonths} –º–µ—Å).`,
    '–°—Ä–æ–∫ –ø—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –ø—Ä–∏ —Ç–µ–∫—É—â–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (—Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤).',
    `–°–∫–æ—Ä–æ—Å—Ç—å —Å–¥–µ–ª–æ–∫: –º–µ–¥–∏–∞–Ω–∞ ${analysisResults.medianDomDays ? `${analysisResults.medianDomDays} –¥–Ω. (${analysisResults.medianDomMonths} –º–µ—Å.)` : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}, —Å–¥–µ–ª–∫–∏ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è –Ω–∞ ${analysisResults.closeToListRatio ? `${analysisResults.closeToListRatio.medianPct.toFixed(1)}%` : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'} –æ—Ç —Ü–µ–Ω—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.`,
    `–ù–∞–ª–∏—á–∏–µ —Ä–µ–∫–ª–∞–º—ã –Ω–∞ –ø–ª–æ—â–∞–¥–∫–∞—Ö: ${ads.map(r => Array.isArray(r) ? `${r[0]} ${r[1]}` : String(r)).join('; ')}`,
    `–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ö–≤–∞—Ç—ã (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã): ${viewsData && viewsData.summary ? viewsData.summary : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}`
  ];

  return parts.join(' ');
}

/**
 * –°—á–∏—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–¥–∫—É –∏–∑ –ª–∏—Å—Ç–∞ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" (A4:B52) –¥–ª—è –ò–ò.
 */
function getReportSummaryFromSheet() {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
  if (!sheet) return '';
  
  // –ë–µ—Ä–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —Å –∑–∞–ø–∞—Å–æ–º, —Å—Ç–æ–ø-–º–∞—Ä–∫–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–∞–Ω—å—à–µ
  const values = sheet.getRange('A4:B100').getValues();
  const lines = [];
  
  for (let i = 0; i < values.length; i++) {
    const left = String(values[i][0] || '').trim();
    const right = String(values[i][1] || '').trim();
    
    // –°–¢–û–ü-–ú–ê–†–ö–ï–†: –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ò–ò, –ø—Ä–µ–∫—Ä–∞—â–∞–µ–º —á—Ç–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ "–∫—É—Å–∞—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è"
    if (left.includes('–ò–¢–û–ì–û–í–´–ô –í–´–í–û–î –ê–ù–ê–õ–ò–¢–ò–ö–ê')) {
      break;
    }
    
    if (!left && !right) continue;
    
    if (right) {
      lines.push(`${left}: ${right}`);
    } else {
      lines.push(left);
    }
  }
  
  return lines.join('\n');
}

/**
 * –°–æ–∑–¥–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–∫—Ç—É —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
 */
function createSingleObjectReportText(objectData, analysisResults, competitorsData) {
  const macro = getMacroContext();
  
  try {
    // 1) –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –ò–ò: –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" (A4:B52)
    const sheetSummary = getReportSummaryFromSheet();
    if (sheetSummary) {
      const sheetPrompt = `–¢–´ ‚Äî –°–¢–ê–†–®–ò–ô –≠–ö–°–ü–ï–†–¢-–ê–ù–ê–õ–ò–¢–ò–ö. –ù–∞–ø–∏—à–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω 5‚Äì7 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π (700‚Äì900 —Å–∏–º–≤).
–°—Ç–∏–ª—å: –¥–µ–ª–æ–≤–æ–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π. –ò–∑–±–µ–≥–∞–π –≤–æ–¥—ã –∏ –±–∞–Ω–∞–ª—å–Ω–æ—Å—Ç–µ–π.
–í –Ω–∞—á–∞–ª–µ ‚Äî —Ñ—Ä–∞–∑–∞ "–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—Å: " –∏ –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Å–∞–π—Ç.
–í–ê–ñ–ù–û –ø–æ —Ç–µ—Ä–º–∏–Ω–∞–º:
1. –£–ø–æ–º—è–Ω–∏ –ø—Ä–∏—Ç–æ–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–ø—Ä–∏–±—ã—Ç–∏–µ) –∏ —Ç–æ, —á—Ç–æ –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ä–æ–∫–∞ ‚Äî –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô (–ø–æ–∑–∏—Ü–∏—è –ø–∞–¥–∞–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º).
2. –†–∞–∑–ª–∏—á–∞–π –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∫–ª–∞–º—ã (–ê–≤–∏—Ç–æ/–¶–∏–∞–Ω: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö) –∏ –æ—Ö–≤–∞—Ç—ã (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã).
3. –°–æ–±–ª—é–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É PAS (–ü—Ä–æ–±–ª–µ–º–∞, –û–±–æ—Å—Ç—Ä–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π, –ü–ª–∞–Ω –ø–æ–±–µ–¥—ã).`;
      const fromSheet = callGeminiFlash(sheetPrompt, sheetSummary, 'gemini-3-flash-preview');
      if (fromSheet && !fromSheet.startsWith('‚ùå') && fromSheet.length >= 600) {
        return fromSheet;
      }
    }

    const currentPrice = Number(objectData[7]) || 0;
    const marketPrice = Number(analysisResults.forecasts.marketPrice) || 0;
    const quickPrice = Number(analysisResults.forecasts.quickPrice) || 0;
    const priceDiffAbs = marketPrice - currentPrice;
    const priceDiffPct = currentPrice > 0 ? ((marketPrice / currentPrice - 1) * 100) : 0;

    const analyticsData = {
      object: {
        district: objectData[1], rooms: objectData[3], area: objectData[4],
        price: currentPrice, pricePerSqm: Math.round(currentPrice / Number(objectData[4]))
      },
      market: {
        demand: analysisResults.demandPerMonth, // –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
        activeCount: competitorsData.activeCompetitors.length,
        soldCount: competitorsData.soldCompetitors.length,
        rank: analysisResults.objectRank,
        avgActivePrice: analysisResults.marketRatios.avgActivePrice,
        avgSoldPrice: analysisResults.marketRatios.avgSoldPrice,
        arrivalRate: analysisResults.avgNewObjectsPerMonth, // –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü
        inventoryIndex: analysisResults.arrivalToDemandRatio, // % –ø—Ä–∏—Ç–æ–∫–∞ –∫ –ø—Ä–æ–¥–∞–∂–∞–º
        liquidity: analysisResults.liquidityType,
        priceDiffAbs,
        priceDiffPct
      },
      forecast: {
        ...analysisResults.forecasts,
        currentPrice,
        marketPrice,
        quickPrice
      }
    };

    const aiResult = callGeminiAnalyst(analyticsData, macro);
    const minLen = 700;
    if (aiResult.success && aiResult.text && aiResult.text.length >= minLen) {
      return aiResult.text;
    }

    // Fallback: –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–º–ø—Ç + —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Ä–µ–∑—é–º–µ
    const summaryText = buildSummaryTextForAI(objectData, analysisResults, competitorsData);
    const fallbackPrompt = `–¢–´ ‚Äî –≠–ö–°–ü–ï–†–¢-–°–¢–†–ê–¢–ï–ì. –ù–∞–ø–∏—à–∏ –≤—ã–≤–æ–¥ 700‚Äì900 —Å–∏–º–≤–æ–ª–æ–≤.
–°—Ç–∏–ª—å: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä. –ë–µ–∑ Markdown. –ù–∞—á–Ω–∏ —Å "–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –≤–∞—Å:".
–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: 
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑ —Å—Ä–æ–∫–∞ (—É—á–µ—Ç –ø—Ä–∏—Ç–æ–∫–∞ –Ω–æ–≤—ã—Ö –ª–æ—Ç–æ–≤).
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º—ã –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ PAS (–ü—Ä–æ–±–ª–µ–º–∞ -> –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –æ–∂–∏–¥–∞–Ω–∏—è -> –†–µ—à–µ–Ω–∏–µ).`;
    const flashText = callGeminiFlash(fallbackPrompt, summaryText, 'gemini-3-flash-preview');
    if (flashText && !flashText.startsWith('‚ùå') && flashText.length >= 600) {
      return flashText;
    }
    
    return `–ê–ù–ê–õ–ò–ó –†–´–ù–ö–ê –ò –û–ë–™–ï–ö–¢–ê. –†–∞–π–æ–Ω: ${objectData[1]}, —Ü–µ–Ω–∞ ${Number(objectData[7]).toLocaleString()} ‚ÇΩ, –ø–ª–æ—â–∞–¥—å ${objectData[4]} –º¬≤. ` +
           `–°–ø—Ä–æ—Å –≤ —Ä–∞–π–æ–Ω–µ ${analysisResults.demandPerMonth.toFixed(1)} –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å, –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ ${competitorsData.activeCompetitors.length}, –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö ${competitorsData.soldCompetitors.length}. ` +
           `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ ${analysisResults.forecasts.marketPrice.toLocaleString()} ‚ÇΩ, –±—ã—Å—Ç—Ä–∞—è —Ü–µ–Ω–∞ ${analysisResults.forecasts.quickPrice.toLocaleString()} ‚ÇΩ. ` +
           `–û–∂–∏–¥–∞–µ–º—ã–π —Å—Ä–æ–∫: –±—ã—Å—Ç—Ä–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è ${analysisResults.forecasts.quickMonths} –º–µ—Å, —Ä—ã–Ω–æ—á–Ω–∞—è ${analysisResults.forecasts.marketMonths} –º–µ—Å.`;
    
  } catch (error) {
    return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.";
  }
}

/**
 * [v3.1] –°–æ–∑–¥–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –º–µ—Ç—Ä–∏–∫).
 */
function createSingleObjectReportData(objectData, analysisResults, competitorsData) {
  const { activeCompetitors } = competitorsData;
  const totalActive = activeCompetitors.length;
  const fmtRank = (r) => (totalActive > 0 && r) ? `${r} –∏–∑ ${totalActive}` : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  const fmtTarget = (r) => (r ? String(r) : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
  const forecasts = analysisResults.forecasts;
  const adLines = analysisResults.advertisingSummary || [];
  const domText = analysisResults.medianDomDays
    ? `${analysisResults.medianDomDays} –¥–Ω–µ–π (${analysisResults.medianDomMonths} –º–µ—Å.)`
    : '–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ (–Ω–µ—Ç –¥–∞—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)';
  const closeToListText = analysisResults.closeToListRatio
    ? `${analysisResults.closeToListRatio.medianPct.toFixed(1)}% (n=${analysisResults.closeToListRatio.count})`
    : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  const domCloseText = analysisResults.medianDomDays
    ? `–°—Ä–æ–∫ ${analysisResults.medianDomDays} –¥–Ω., —Å–¥–µ–ª–∫–∏ ${analysisResults.closeToListRatio ? `–Ω–∞ ${analysisResults.closeToListRatio.medianPct.toFixed(1)}% –æ—Ç —Ü–µ–Ω—ã` : '–±–µ–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–∫–∏–¥–∫–µ'}`
    : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  const reportData = [
    ['üè¢ –í–ê–® –û–ë–™–ï–ö–¢', ''],
    ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
    ['–†–∞–π–æ–Ω', objectData[1]],
    ['–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏', `${objectData[3]}-–∫–æ–º–Ω. –∫–≤–∞—Ä—Ç–∏—Ä–∞, ${objectData[4]} –º¬≤`],
    ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', `${objectData[10]} –≥.`],
    ['–°–æ—Å—Ç–æ—è–Ω–∏–µ (—Ä–µ–º–æ–Ω—Ç)', objectData[6]],
    ['–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ', objectData[12] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    ['–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400 —Å–∏–º–≤.', objectData[13] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    ['–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞', objectData[14] || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    ['–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è', `${Number(objectData[7]).toLocaleString()} ‚ÇΩ`],
    ['–¶–µ–Ω–∞ –∑–∞ –∫–≤. –º–µ—Ç—Ä', `${objectData[4] > 0 ? Math.round(Number(objectData[7])/Number(objectData[4])).toLocaleString() : '0'} ‚ÇΩ/–º¬≤`],
    ['--------------------------------', '---'],
    ['üìä –°–û–°–¢–û–Ø–ù–ò–ï –†–´–ù–ö–ê', ''],
    ['–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä—ã–Ω–∫–∞ —Å–µ–π—á–∞—Å', analysisResults.marketAssessment],
    ['–¢–µ–º–ø –ø—Ä–æ–¥–∞–∂ –≤ —Ä–∞–π–æ–Ω–µ', `${analysisResults.demandPerMonth.toFixed(1)} –æ–±—ä–µ–∫—Ç–æ–≤/–º–µ—Å.`],
    ['–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤', `${activeCompetitors.length} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π`],
    ['–ü—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (–º–µ—Å)', `+${analysisResults.avgNewObjectsPerMonth.toFixed(1)}`],
    ['–†—ã–Ω–æ–∫ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω (–Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º —Å–¥–µ–ª–æ–∫)', `${analysisResults.arrivalToDemandRatio.toFixed(0)}%`],
    ['–°–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –≤ —Ä–∞–π–æ–Ω–µ', formatLiquidityForClient(analysisResults.liquidityType)],
    ['–ë–∞–ª–∞–Ω—Å —Ä—ã–Ω–∫–∞: –∫–æ–º—É –≤—ã–≥–æ–¥–Ω–µ–µ —Å–µ–π—á–∞—Å (–ø–æ–∫—É–ø–∞—Ç–µ–ª—é/–ø—Ä–æ–¥–∞–≤—Ü—É)', analysisResults.marketBalance],
    ['--------------------------------', '---'],
    ['üìç –ö–û–ù–ö–£–†–ï–ù–¢–ù–ê–Ø –ü–û–ó–ò–¶–ò–Ø', ''],
    ['–†–µ–π—Ç–∏–Ω–≥ –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤', `${analysisResults.objectRank}-–µ –º–µ—Å—Ç–æ –∏–∑ ${activeCompetitors.length}`],
    ['–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è–º–∏', `${analysisResults.marketRatios.activeRatio < 0 ? '–¥–µ—à–µ–≤–ª–µ –Ω–∞ ' : '–¥–æ—Ä–æ–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.activeRatio).toFixed(1)}%`],
    ['–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–æ–¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏', `${analysisResults.marketRatios.soldRatio < 0 ? '–¥–µ—à–µ–≤–ª–µ –Ω–∞ ' : '–¥–æ—Ä–æ–∂–µ –Ω–∞ '}${Math.abs(analysisResults.marketRatios.soldRatio).toFixed(1)}%`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤', `${Math.round(analysisResults.marketRatios.avgActivePrice * Number(objectData[4])).toLocaleString()} ‚ÇΩ`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', `${Math.round(analysisResults.marketRatios.avgSoldPrice * Number(objectData[4])).toLocaleString()} ‚ÇΩ`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø–æ—Ö–æ–∂–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤', `${Math.round(analysisResults.marketRatios.avgActivePrice).toLocaleString()} ‚ÇΩ/–º¬≤`],
    ['–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö', `${Math.round(analysisResults.marketRatios.avgSoldPrice).toLocaleString()} ‚ÇΩ/–º¬≤`],
    ['--------------------------------', '---'],
    ['üì£ –†–ï–ö–õ–ê–ú–ê –ò –ü–†–û–°–ú–û–¢–†–´', ''],
    adLines[0] || ['–ê–≤–∏—Ç–æ', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    adLines[1] || ['–¶–∏–∞–Ω', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    adLines[2] || ['–î–æ–º–∫–ª–∏–∫', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    adLines[3] || ['–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'],
    ['--------------------------------', '---'],
    ['üí∞ –¶–ï–ù–û–í–´–ï –°–¢–†–ê–¢–ï–ì–ò–ò', ''],
    ['‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞ (–¥–æ 1 –º–µ—Å)', `${analysisResults.forecasts.quickPrice.toLocaleString()} ‚ÇΩ ‚Ä¢ –†–∞–Ω–≥ ${forecasts.quickPosition} –∏–∑ ${activeCompetitors.length} ‚Ä¢ –°—Ä–æ–∫: ${forecasts.quickMonths || '-'} –º–µ—Å.`],
    ['üè† –†—ã–Ω–æ—á–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞ (–¥–æ 3 –º–µ—Å)', `${analysisResults.forecasts.marketPrice.toLocaleString()} ‚ÇΩ ‚Ä¢ ${fmtRank(forecasts.marketPosition)} ‚Ä¢ –°—Ä–æ–∫: ${forecasts.marketMonths || '-'} –º–µ—Å.`],
    ['üìä –ü—Ä–∏ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω–µ', `${Number(objectData[7]).toLocaleString()} ‚ÇΩ ‚Ä¢ –†–∞–Ω–≥ ${analysisResults.objectRank} –∏–∑ ${activeCompetitors.length} ‚Ä¢ –°—Ä–æ–∫: ${forecasts.currentMonths || forecasts.marketMonths} –º–µ—Å.`],
    ['--------------------------------', '---']
  ];
  
  return reportData;
}

/**
 * –û—á–∏—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (9, null, undefined, 0).
 * @param {*} value –ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏.
 * @returns {*} –û—á–∏—â–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null.
 */
function cleanDataValue(value) {
  if (value === null || value === undefined || value === '' || value === 0 || value === '9' || value === 9) {
    return null;
  }
  return value;
}

/**
 * –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–∞—Ä—Å–∏—Ç –¥–∞—Ç—É –∏–∑ —á–∏—Å–ª–∞/—Å—Ç—Ä–æ–∫–∏/Date (—É—á–∏—Ç—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç—ã dd.mm.yyyy).
 * @param {*} value –ó–Ω–∞—á–µ–Ω–∏–µ –¥–∞—Ç—ã.
 * @returns {Date|null} –û–±—ä–µ–∫—Ç Date –∏–ª–∏ null.
 */
function parseDateSafe(value) {
  if (value === null || value === undefined || value === '') return null;
  if (Object.prototype.toString.call(value) === '[object Date]') {
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }
  if (typeof value === 'number' && isFinite(value)) {
    // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ Excel/Sheets serial
    if (value > 20000 && value < 60000) {
      const d = new Date(Math.round((value - 25569) * 86400 * 1000));
      return isNaN(d.getTime()) ? null : d;
    }
    const d = new Date(value);
    return isNaN(d.getTime()) ? null : d;
  }
  const s = String(value).trim();
  if (!s) return null;

  // dd.mm.yyyy or dd.mm.yyyy hh:mm(:ss)
  let m = s.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m) {
    const day = parseInt(m[1], 10);
    const month = parseInt(m[2], 10) - 1;
    let year = parseInt(m[3], 10);
    if (year < 100) year += 2000;
    const hour = m[4] ? parseInt(m[4], 10) : 0;
    const min = m[5] ? parseInt(m[5], 10) : 0;
    const sec = m[6] ? parseInt(m[6], 10) : 0;
    const d = new Date(year, month, day, hour, min, sec);
    return isNaN(d.getTime()) ? null : d;
  }

  // yyyy-mm-dd or yyyy-mm-dd hh:mm(:ss)
  m = s.match(/^(\d{4})[.\/-](\d{1,2})[.\/-](\d{1,2})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if (m) {
    const year = parseInt(m[1], 10);
    const month = parseInt(m[2], 10) - 1;
    const day = parseInt(m[3], 10);
    const hour = m[4] ? parseInt(m[4], 10) : 0;
    const min = m[5] ? parseInt(m[5], 10) : 0;
    const sec = m[6] ? parseInt(m[6], 10) : 0;
    const d = new Date(year, month, day, hour, min, sec);
    return isNaN(d.getTime()) ? null : d;
  }

  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
 * @param {*} value –ó–Ω–∞—á–µ–Ω–∏–µ –∫–æ–¥–∞.
 * @returns {string}
 */
function normalizeCode(value) {
  if (value === null || value === undefined) return '';
  return String(value).trim().replace(/[\s\u00A0]+/g, '');
}

/**
 * –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∫–æ–¥—ã —Å —É—á–µ—Ç–æ–º —á–∏—Å–ª–æ–≤—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.
 * @param {*} a
 * @param {*} b
 * @returns {boolean}
 */
function codesEqual(a, b) {
  const sa = normalizeCode(a);
  const sb = normalizeCode(b);
  if (!sa || !sb) return false;
  const numA = /^\d+(\.0+)?$/.test(sa);
  const numB = /^\d+(\.0+)?$/.test(sb);
  if (numA && numB) {
    return String(parseInt(sa, 10)) === String(parseInt(sb, 10));
  }
  return sa.toLowerCase() === sb.toLowerCase();
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—É—é —Ü–µ–Ω—É.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {Object} forecasts –ü—Ä–æ–≥–Ω–æ–∑—ã.
 * @returns {number} –°—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateWeightedRecommendedPrice(marketRatios, forecasts) {
  const activePrice = marketRatios.avgActivePrice || 0;
  const soldPrice = marketRatios.avgSoldPrice || 0;
  const marketPrice = forecasts.marketPrice || 0;
  
  if (activePrice > 0 && soldPrice > 0 && marketPrice > 0) {
    return (activePrice + soldPrice + marketPrice) / 3;
  }
  
  return marketPrice || 0;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 */
function calculateDemandPerMonth(soldCompetitors) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω–æ–µ –æ–∫–Ω–æ –∞–Ω–∞–ª–∏–∑–∞
  const { months: periodMonths } = getAnalysisWindow();
  
  return soldCompetitors.length / periodMonths;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –¢–∏–ø –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏.
 */
function determineLiquidityType(competitors, sales, demand) {
  if (competitors === 0) return 'C-';
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞: (–°–ø—Ä–æ—Å / –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ) * 100%
  const liquidityIndex = calculateLiquidityIndex(competitors, demand);
  
  // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏
  if (liquidityIndex > 25 && demand >= 3) return 'A+'; // –ò—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 20) return 'A'; // –í—ã—Å–æ–∫–∏–π
  if (liquidityIndex >= 10) return 'B'; // –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
  if (liquidityIndex >= 5) return 'C'; // –ù–∏–∑–∫–∏–π
  return 'C-'; // –û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ–∫.
 * @param {number} competitors –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} sales –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–∂.
 * @param {number} demand –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @returns {string} –û—Ü–µ–Ω–∫–∞ —Ä—ã–Ω–∫–∞.
 */
function assessMarket(competitors, sales, demand) {
  if (competitors === 0) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  const liquidityIndex = calculateLiquidityIndex(competitors, demand);
  return getMarketAssessment(liquidityIndex, demand);
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (–≤ %).
 */
function calculateLiquidityIndex(competitors, demand) {
  if (!competitors || competitors <= 0 || !demand || demand <= 0) return 0;
  return (demand / competitors) * 100;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å —Ä—ã–Ω–∫–∞ –ø–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–Ω–æ–º—É –ø–µ—Ä–∏–æ–¥—É.
 * @param {number|null} inventoryMonths –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {string} –û–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —Ä—ã–Ω–∫–∞.
 */
function getMarketBalanceByInventory(inventoryMonths) {
  if (inventoryMonths === null || inventoryMonths === undefined || isNaN(inventoryMonths)) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  if (inventoryMonths < 4) return '–†—ã–Ω–æ–∫ –ø—Ä–æ–¥–∞–≤—Ü–∞';
  if (inventoryMonths <= 6) return '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—ã–Ω–æ–∫';
  return '–†—ã–Ω–æ–∫ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è';
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞–Ω–Ω—ã–π —Å—Ä–æ–∫ —ç–∫—Å–ø–æ–∑–∏—Ü–∏–∏ (DOM) –ø–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã (–æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ).
 * @returns {number|null} –ú–µ–¥–∏–∞–Ω–∞ –≤ –¥–Ω—è—Ö –∏–ª–∏ null.
 */
function calculateMedianDaysOnMarket(soldCompetitors) {
  const days = (soldCompetitors || [])
    .map(c => {
      const v = c[7];
      if (typeof v === 'number') return v;
      const n = parseFloat(String(v).replace(',', '.'));
      return isFinite(n) ? n : null;
    })
    .filter(v => typeof v === 'number' && v >= 0);
  if (days.length === 0) return null;
  const sorted = [...days].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  const median = (sorted.length % 2 !== 0) ? sorted[mid] : Math.round((sorted[mid - 1] + sorted[mid]) / 2);
  return median;
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç Close-to-List Ratio –ø–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã–º (–µ—Å–ª–∏ –µ—Å—Ç—å —Ü–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏).
 * @param {Array} soldRaw –°—ã—Ä—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {Object|null} headerMap Map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * @returns {{medianPct:number,count:number}|null}
 */
function calculateCloseToListRatio(soldRaw, headerMap) {
  if (!soldRaw || soldRaw.length === 0 || !headerMap) return null;

  const listPriceCol = getColumnIndexByKeywords(headerMap, [
    '—Ü–µ–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', '—Ü–µ–Ω–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '—Ü–µ–Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', '—Ü–µ–Ω–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏',
    '—Ü–µ–Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è', '—Ü–µ–Ω–∞ –≤ —Ä–µ–∫–ª–∞–º–µ', 'listing price', 'list price'
  ]);
  const salePriceCol = getColumnIndexByKeywords(headerMap, [
    '—Ü–µ–Ω–∞ —Å–¥–µ–ª–∫–∏', '—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏', '—Ü–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è', '—Ñ–∞–∫—Ç –ø—Ä–æ–¥–∞–∂–∏', '–ø—Ä–æ–¥–∞–Ω–æ –∑–∞'
  ]) || getColumnIndexByKeywords(headerMap, ['—Ü–µ–Ω–∞']);

  if (!listPriceCol || !salePriceCol || listPriceCol === salePriceCol) return null;

  const ratios = soldRaw.map(row => {
    const sale = parseFloat(String(row[salePriceCol - 1]).replace(/\s/g, '').replace(',', '.'));
    const list = parseFloat(String(row[listPriceCol - 1]).replace(/\s/g, '').replace(',', '.'));
    if (!sale || !list || !isFinite(sale) || !isFinite(list)) return null;
    return sale / list;
  }).filter(v => v && isFinite(v));

  if (ratios.length === 0) return null;
  const sorted = ratios.sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  const median = (sorted.length % 2 !== 0) ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;

  return { medianPct: Math.round(median * 1000) / 10, count: ratios.length };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} periodMonths –ü–µ—Ä–∏–æ–¥ –≤ –º–µ—Å—è—Ü–∞—Ö.
 * @returns {number} –¢—Ä–µ–Ω–¥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –≤ %.
 */
function calculateCompetitionTrendForSingleObject(activeCompetitors, periodMonths) {
  if (activeCompetitors.length === 0) return 0;
  
  // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∫–∞–∫ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
  const endDate = new Date();
  const startDate = new Date(endDate.getTime() - (periodMonths * 30.44 * 24 * 60 * 60 * 1000));
  const midPoint = new Date(startDate.getTime() + (endDate.getTime() - startDate.getTime()) / 2);
  
  // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
  const firstHalfCount = activeCompetitors.filter(row => {
    const rowDate = parseDateSafe(row[13]); // –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    return rowDate && rowDate >= startDate && rowDate < midPoint;
  }).length;
  
  const secondHalfCount = activeCompetitors.filter(row => {
    const rowDate = parseDateSafe(row[13]); // –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    return rowDate && rowDate >= midPoint && rowDate <= endDate;
  }).length;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç—Ä–µ–Ω–¥
  if (firstHalfCount === 0 && secondHalfCount > 0) return 100; // –†–µ–∑–∫–∏–π —Ä–æ—Å—Ç
  if (firstHalfCount === 0 || secondHalfCount === 0) return 0; // –°—Ç–∞–±–∏–ª—å–Ω–æ
  
  const trend = ((secondHalfCount - firstHalfCount) / firstHalfCount) * 100;
  return Math.round(trend);
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –†–∞–Ω–≥ –æ–±—ä–µ–∫—Ç–∞.
 */
/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–º–ø –ø—Ä–∏—Ö–æ–¥–∞ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (arrival) –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞—Ç.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü.
 */
function calculateRealArrivalRate(activeCompetitors) {
  if (!activeCompetitors || activeCompetitors.length === 0) return 0;
  
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
  
  // –°—á–∏—Ç–∞–µ–º –æ–±—ä–µ–∫—Ç—ã, –≤—ã—à–µ–¥—à–∏–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ c[13]
  const recentObjects = activeCompetitors.filter(c => {
    const pubDate = parseDateSafe(c[13]); 
    return pubDate && pubDate >= thirtyDaysAgo;
  });
  
  return recentObjects.length;
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ü–µ–Ω–æ–≤–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} ourPrice –ù–∞—à–∞ —Ü–µ–Ω–∞.
 * @returns {number} –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–∞–≤–ª–µ–Ω–∏—è (0-1), –≥–¥–µ 1 - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ.
 */
function calculateRecentPricingTrend(activeCompetitors, ourPricePerM2) {
  if (!activeCompetitors || activeCompetitors.length === 0 || !ourPricePerM2) return 0.5;
  
  const now = new Date();
  const fortyFiveDaysAgo = new Date(now.getTime() - (45 * 24 * 60 * 60 * 1000));
  
  // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ "–Ω–æ–≤–∏—á–∫–æ–≤" (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 45 –¥–Ω–µ–π)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –º–∞—Å—Å–∏–≤–µ –¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ c[13]
  const newcomers = activeCompetitors.filter(c => {
    const pubDate = parseDateSafe(c[13]);
    return pubDate && pubDate >= fortyFiveDaysAgo;
  });
  
  if (newcomers.length === 0) return 0.5;
  
  // –°—á–∏—Ç–∞–µ–º —Å–∫–æ–ª—å–∫–æ –∏–∑ –Ω–∏—Ö –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å (–ø–æ —Ü–µ–Ω–µ –∑–∞ –º2)
  const cheaperNewcomers = newcomers.filter(c => {
    const priceM2 = Number(c[6]); // –¶–µ–Ω–∞ –∑–∞ –º2 —Ç–µ–ø–µ—Ä—å –≤ –∏–Ω–¥–µ–∫—Å–µ 6
    return priceM2 > 0 && priceM2 < ourPricePerM2;
  });
  
  return cheaperNewcomers.length / newcomers.length;
}

function calculateObjectRank(objectData, activeCompetitors) {
  const ourPriceM2 = Math.round(Number(objectData[7]) / Number(objectData[4])) || 0;
  
  if (activeCompetitors.length === 0) return 1;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤ (–∏–Ω–¥–µ–∫—Å 6) –¥–ª—è –Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è
  const competitorPricesM2 = activeCompetitors.map(c => Number(c[6]) || 0).filter(p => p > 0);
  
  const hasOurObject = competitorPricesM2.some(price => Math.abs(price - ourPriceM2) < 10);
  
  const allPricesM2 = hasOurObject 
    ? competitorPricesM2 
    : [...competitorPricesM2, ourPriceM2];
  
  allPricesM2.sort((a, b) => a - b);
  const rank = 1 + allPricesM2.filter(p => p < ourPriceM2).length;
  
  return rank;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Ç—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω–µ–π–Ω–æ–π —Ä–µ–≥—Ä–µ—Å—Å–∏–∏.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –¢—Ä–µ–Ω–¥ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –≤ —Ä—É–±/–º–µ—Å.
 */
function calculatePriceTrendPerM2(soldCompetitors) {
  const defaultResult = { trend: 0, r2: 0, indicator: '‚û°Ô∏è', reliable: false };
  
  if (soldCompetitors.length < 2) return defaultResult;
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–≥—Ä–µ—Å—Å–∏–∏
  const dataPoints = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]);
      const area = cleanDataValue(row[4]);
      const date = parseDateSafe(row[13]);
      
      if (price && area && area > 0 && date) {
        return {
          x: date.getTime(), // –í—Ä–µ–º—è –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
          y: Number(price) / Number(area) // –¶–µ–Ω–∞ –∑–∞ –º¬≤
        };
      }
      return null;
    })
    .filter(point => point !== null);
  
  if (dataPoints.length < 2) return defaultResult;
  
  // –í—ã—á–∏—Å–ª—è–µ–º –ª–∏–Ω–µ–π–Ω—É—é —Ä–µ–≥—Ä–µ—Å—Å–∏—é
  const regression = calculateLinearRegression(dataPoints);
  if (!regression) return defaultResult;
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–∫–ª–æ–Ω –≤ —Ä—É–±/–º–µ—Å (–º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã –≤ –º–µ—Å—è—Ü)
  const millisecondsPerMonth = 1000 * 60 * 60 * 24 * 30.4375;
  const trend = regression.slope * millisecondsPerMonth;
  const r2 = regression.r2;
  
  // R¬≤ >= 0.3 —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–º —Ç—Ä–µ–Ω–¥–æ–º
  const reliable = r2 >= 0.3;
  
  // –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—ã–π)
  let indicator = '‚û°Ô∏è'; // —Å—Ç–∞–±–∏–ª—å–Ω–æ
  if (reliable) {
    if (trend > 500) indicator = '‚ÜóÔ∏è'; // —Ä–æ—Å—Ç > 500 —Ä—É–±/–º¬≤/–º–µ—Å
    else if (trend < -500) indicator = '‚ÜòÔ∏è'; // —Å–Ω–∏–∂–µ–Ω–∏–µ
  }
  
  return { trend: Math.round(trend), r2: Math.round(r2 * 100) / 100, indicator, reliable };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 */
function calculateMarketRatios(objectPricePerM2, activeCompetitors, soldCompetitors) {
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (—É—Å–µ—á–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ - –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç 20% –∫—Ä–∞–π–Ω–∏—Ö)
  // –í –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: —Å—Ç–æ–ª–±–µ—Ü 5 = —Ü–µ–Ω–∞, —Å—Ç–æ–ª–±–µ—Ü 4 = –ø–ª–æ—â–∞–¥—å
  const activePricesPerM2 = activeCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgActivePricePerM2 = activePricesPerM2.length > 0 ? calculateTrimmedMean(activePricesPerM2) : 0;
  
  // –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–º–µ–¥–∏–∞–Ω–∞)
  const soldPricesPerM2 = soldCompetitors
    .map(row => {
      const price = cleanDataValue(row[5]); // —Ü–µ–Ω–∞
      const area = cleanDataValue(row[4]); // –ø–ª–æ—â–∞–¥—å
      if (price && area && area > 0) {
        return Number(price) / Number(area); // —Ü–µ–Ω–∞ –∑–∞ –º¬≤
      }
      return null;
    })
    .filter(price => price !== null && price > 0);
  const avgSoldPricePerM2 = soldPricesPerM2.length > 0 ? calculateMedian(soldPricesPerM2) : 0;
  
  // –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö —Å –∑–Ω–∞–∫–æ–º)
  // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –≤—ã—à–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ = –Ω–∞—à–∞ —Ü–µ–Ω–∞ –Ω–∏–∂–µ
  const activeRatio = avgActivePricePerM2 > 0 ? ((objectPricePerM2 - avgActivePricePerM2) / avgActivePricePerM2) * 100 : 0;
  const soldRatio = avgSoldPricePerM2 > 0 ? ((objectPricePerM2 - avgSoldPricePerM2) / avgSoldPricePerM2) * 100 : 0;
  
  return {
    avgActivePrice: avgActivePricePerM2,
    avgSoldPrice: avgSoldPricePerM2,
    activeRatio,
    soldRatio
  };
}

/**
 * [v1.0] –í—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ —Å –∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏.
 * –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ –∞–Ω–∞–ª–∏–∑–µ 13,490 —Å–¥–µ–ª–æ–∫.
 * @param {Array|Object} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞ (–º–∞—Å—Å–∏–≤ –∏–ª–∏ dataMap).
 * @returns {number} –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞ (1.0 = —Å—Ä–µ–¥–Ω–∏–π, >1.0 = –ª—É—á—à–µ, <1.0 = —Ö—É–∂–µ).
 */
function calculateQualityScore(objectData) {
  let score = 1.0; // –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
  try {
    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ –º–∞—Å—Å–∏–≤–∞, —Ç–∞–∫ –∏ –æ–±—ä–µ–∫—Ç–∞ dataMap
    const repair = (Array.isArray(objectData) ? objectData[6] : objectData['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞'] || '').toLowerCase();
    const buildYear = Number(Array.isArray(objectData) ? objectData[10] : objectData['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏']) || 0;
    const floor = Number(Array.isArray(objectData) ? objectData[8] : objectData['–≠—Ç–∞–∂']) || 0;
    const totalFloors = Number(Array.isArray(objectData) ? objectData[9] : objectData['–≠—Ç–∞–∂–Ω–æ—Å—Ç—å']) || 0;
    const currentYear = new Date().getFullYear();
    
    // === –†–ï–ú–û–ù–¢ (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (repair.includes('–¥–∏–∑–∞–π–Ω') || repair.includes('–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫')) {
      score += QUALITY_COEFFICIENTS.REPAIR_DESIGNER;
    } else if (repair.includes('–µ–≤—Ä–æ')) {
      score += QUALITY_COEFFICIENTS.REPAIR_EURO;
    } else if (repair.includes('—Å–æ–≤—Ä–µ–º–µ–Ω–Ω')) {
      score += QUALITY_COEFFICIENTS.REPAIR_MODERN;
    } else if (repair.includes('—Ç—Ä–µ–±—É–µ—Ç') || repair.includes('–±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞') || repair.includes('—á–µ—Ä–Ω–æ–≤–∞—è')) {
      score += QUALITY_COEFFICIENTS.REPAIR_NEEDS_WORK;
    } else if (repair.includes('—Å—Ç–∞—Ä—ã–π') || repair.includes('—É–±–∏—Ç')) {
      score += QUALITY_COEFFICIENTS.REPAIR_OLD;
    }
    // –ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç: 0%
    
    // === –ì–û–î –ü–û–°–¢–†–û–ô–ö–ò (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (buildYear > 0) {
      const age = currentYear - buildYear;
      if (age <= 5) {
        score += QUALITY_COEFFICIENTS.BUILDING_NEW;       // –ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞
      } else if (age <= 15) {
        score += QUALITY_COEFFICIENTS.BUILDING_MODERN;    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π
      } else if (age <= 40) {
        score += QUALITY_COEFFICIENTS.BUILDING_NORMAL;    // –û–±—ã—á–Ω—ã–π
      } else if (buildYear >= 1980) {
        score += QUALITY_COEFFICIENTS.BUILDING_OLD;       // –°—Ç–∞—Ä—ã–π (–ø–æ—Å–ª–µ 1980)
      } else {
        score += QUALITY_COEFFICIENTS.BUILDING_VERY_OLD;  // –û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–π (–¥–æ 1980)
      }
    }
    
    // === –≠–¢–ê–ñ (–∫–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã) ===
    if (floor === 1) {
      score += QUALITY_COEFFICIENTS.FLOOR_FIRST;            // –ü–µ—Ä–≤—ã–π —ç—Ç–∞–∂
    } else if (totalFloors > 2 && floor === totalFloors) {
      score += QUALITY_COEFFICIENTS.FLOOR_LAST;             // –ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–∂
    } else if (totalFloors > 3 && floor > 1 && floor < totalFloors) {
      score += QUALITY_COEFFICIENTS.FLOOR_MIDDLE;           // –°—Ä–µ–¥–Ω–∏–µ —ç—Ç–∞–∂–∏
    }
    
    // === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–ê–ö–¢–û–†–´ ===
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ
    const hasPhoto = Array.isArray(objectData) ? objectData[12] : (objectData['–ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ'] || objectData['–ù–∞–ª–∏—á–∏–µ –ø—Ä–æ—Ñ. —Ñ–æ—Ç–æ?'] || '');
    if (hasPhoto && (String(hasPhoto).toLowerCase().includes('–¥–∞') || hasPhoto === '1' || hasPhoto === true)) {
      score += QUALITY_COEFFICIENTS.HAS_PROF_PHOTO;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –æ–ø–∏—Å–∞–Ω–∏—è
    const hasDesc = Array.isArray(objectData) ? objectData[13] : (objectData['–æ–ø–∏—Å–∞–Ω–∏–µ'] || objectData['–û–ø–∏—Å–∞–Ω–∏–µ –±–æ–ª—å—à–µ 400?'] || '');
    if (hasDesc && (String(hasDesc).toLowerCase().includes('–¥–∞') || hasDesc === '1' || hasDesc === true)) {
      score += QUALITY_COEFFICIENTS.HAS_GOOD_DESC;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
    const hasFloorPlan = Array.isArray(objectData) ? objectData[14] : (objectData['–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞'] || objectData['–ï—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞?'] || '');
    if (hasFloorPlan && (String(hasFloorPlan).toLowerCase().includes('–¥–∞') || hasFloorPlan === '1' || hasFloorPlan === true)) {
      score += QUALITY_COEFFICIENTS.HAS_FLOOR_PLAN;
    }
    
  } catch(e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ calculateQualityScore: ${e.message}`);
  }
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –æ—Ç 0.70 –¥–æ 1.30
  return Math.max(0.70, Math.min(1.30, score));
}

/**
 * [v1.0] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ —Å —É—á—ë—Ç–æ–º –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ —Ä–∞–Ω–≥–∞.
 * –£—á–∏—Ç—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ—è–≤–ª–µ–Ω–∏–µ –±–æ–ª–µ–µ –¥–µ—à—ë–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ —É—Ö—É–¥—à–∞–µ—Ç –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞.
 * @returns {Object} { months: number, info: string }
 */
function calculateDynamicTimeOnMarket(params) {
  const { rank, demand, arrival, price, activePrices, pricePressure } = params;
  // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –º–∞–∫—Ä–æ-—Ñ–∞–∫—Ç–æ—Ä (—Å—Ç–∞–≤–∫–∞ –¶–ë) –∏—Å–∫–ª—é—á–µ–Ω –∏–∑ —Ä–∞—Å—á–µ—Ç–∞,
  // —Ç.–∫. –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –ø–æ —Å—Ç–∞–≤–∫–µ –∏ —ç—Ç–æ –∏—Å–∫–∞–∂–∞–µ—Ç —Å—Ä–æ–∫.
  
  // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∏–±—ã—Ç–∏—è –∏–ª–∏ —Å–ø—Ä–æ—Å–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Ñ–æ—Ä–º—É–ª—É
  if (arrival <= 0 || demand <= 0) {
    const baseMonths = rank / demand;
    return { months: baseMonths, info: `–ë–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏.` };
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ–ª—é –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—à–µ–π —Ü–µ–Ω—ã
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π pricePressure (–∞–Ω–∞–ª–∏–∑ –Ω–æ–≤–∏—á–∫–æ–≤), –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
  const priceBelowRatio = pricePressure !== undefined ? pricePressure : calculatePriceBelowRatio(price, activePrices, arrival);
  
  // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ—Ç–µ—Ä–∏ –ø–æ–∑–∏—Ü–∏–∏ = –ü—Ä–∏–±—ã—Ç–∏–µ * –î–æ–ª—è_–¥–µ—à–µ–≤–ª–µ_–Ω–∞—Å
  const rankLossPerMonth = arrival * priceBelowRatio;
  
  // –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å = –°–ø—Ä–æ—Å - –°–∫–æ—Ä–æ—Å—Ç—å_–ø–æ—Ç–µ—Ä–∏
  const effectiveDemand = demand - rankLossPerMonth;
  
  // –ï—Å–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π, —Ä—ã–Ω–æ–∫ –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è
  if (effectiveDemand <= 0) {
    // –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å —É—Ö—É–¥—à–∞—é—â–∏–º—Å—è —Ä–∞–Ω–≥–æ–º
    let currentRank = rank;
    let monthsPassed = 0;
    const maxMonths = 36; // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏
    
    while (currentRank > 0 && monthsPassed < maxMonths) {
      currentRank -= demand; // –ó–∞ –º–µ—Å—è—Ü –ø—Ä–æ–¥–∞—ë—Ç—Å—è demand –æ–±—ä–µ–∫—Ç–æ–≤
      currentRank += rankLossPerMonth; // –ù–æ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–æ–≤—ã–µ –¥–µ—à–µ–≤–ª–µ
      monthsPassed++;
      
      if (currentRank <= 0) break;
    }
    
    return { 
      months: monthsPassed, 
      info: `–†—ã–Ω–æ–∫ –∑–∞—Ç–æ–≤–∞—Ä–∏–≤–∞–µ—Ç—Å—è (${(priceBelowRatio * 100).toFixed(0)}% –Ω–æ–≤—ã—Ö –¥–µ—à–µ–≤–ª–µ)` 
    };
  }
  
  // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø—Ä–æ—Å ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –≤–æ–∑–º–æ–∂–Ω–∞
  const months = (rank / effectiveDemand);
  
  return { 
    months: months, 
    info: `–≠—Ñ—Ñ. —Å–ø—Ä–æ—Å: ${effectiveDemand.toFixed(2)}/–º–µ—Å (–¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è: ${(rankLossPerMonth).toFixed(2)}/–º–µ—Å).` 
  };
}

/**
 * [v1.0] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–æ–ª—é –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—à–µ–π —Ü–µ–Ω—ã.
 * @param {number} ourPrice –ù–∞—à–∞ —Ü–µ–Ω–∞.
 * @param {Array<number>} activePrices –¶–µ–Ω—ã –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} newObjectsCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.
 * @returns {number} –î–æ–ª—è –æ—Ç 0 –¥–æ 1.
 */
function calculatePriceBelowRatio(ourPrice, activePrices, newObjectsCount) {
  if (!ourPrice || ourPrice <= 0) return 0.5; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 50%
  
  // –≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è
  const sortedPrices = activePrices.filter(p => p > 0).sort((a, b) => a - b);
  const totalActive = sortedPrices.length;
  
  if (totalActive === 0) return 0.5; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî 50%
  
  // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞—à–µ–π —Ü–µ–Ω—ã
  const cheaperCount = sortedPrices.filter(p => p < ourPrice).length;
  const empiricalRatio = cheaperCount / totalActive; // –î–æ–ª—è –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ >= 10, –¥–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–º
  if (newObjectsCount >= 10) {
    return empiricalRatio;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö 5-9, –∫–æ–º–±–∏–Ω–∏—Ä—É–µ–º 60% –¥–∞–Ω–Ω—ã–µ + 40% —ç–º–ø–∏—Ä–∏–∫–∞ (–ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
  if (newObjectsCount >= 5) {
    const baseRatio = 0.5; // –ë–∞–∑–æ–≤–æ–µ –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ 50%
    return 0.6 * empiricalRatio + 0.4 * baseRatio;
  }
  
  // –ï—Å–ª–∏ –Ω–æ–≤—ã—Ö < 5, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –∫–∞–∫ –æ—Å–Ω–æ–≤—É
  return empiricalRatio;
}

/**
 * [v1.0] –í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–≤–æ–π–Ω–æ–π –∞–Ω–∞–ª–∏–∑ —Ü–µ–Ω—ã: –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ –∏ –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ.
 * –†–∞–∑–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π —Å–º–æ—Ç—Ä—è—Ç –Ω–∞ —Ä–∞–∑–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
 * - –ò–Ω–≤–µ—Å—Ç–æ—Ä—ã: —Ü–µ–Ω–∞ –∑–∞ –º¬≤ (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
 * - –°–µ–º—å–∏: –æ–±—â–∞—è —Ü–µ–Ω–∞ (–±—é–¥–∂–µ—Ç)
 * @param {Object} params –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—á—ë—Ç–∞.
 * @returns {Object} –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –ø–æ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
 */
function calculateDualPriceAnalysis(params) {
  const { price, area, activeCompetitors, soldCompetitors } = params;
  
  if (!price || !area || area <= 0) {
    return { 
      byTotal: { rank: '-', percentile: '-', avgDiff: '-' },
      byPricePerSqm: { rank: '-', percentile: '-', avgDiff: '-' },
      recommendation: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö'
    };
  }
  
  const pricePerSqm = Math.floor(price / area);
  
  // === –ê–Ω–∞–ª–∏–∑ –ø–æ –û–ë–©–ï–ô –¶–ï–ù–ï ===
  const activeTotalPrices = activeCompetitors
    .map(c => c[5]) // –¶–µ–Ω–∞
    .filter(p => typeof p === 'number' && p > 0);
  
  const sortedActiveTotals = [...activeTotalPrices].sort((a, b) => a - b);
  const rankByTotal = sortedActiveTotals.filter(p => p < price).length + 1;
  const percentileByTotal = sortedActiveTotals.length > 0 
    ? Math.round((rankByTotal / sortedActiveTotals.length) * 100) 
    : 0;
  const avgActiveTotal = activeTotalPrices.length > 0 
    ? Math.floor(activeTotalPrices.reduce((a, b) => a + b, 0) / activeTotalPrices.length)
    : 0;
  const diffFromAvgTotal = avgActiveTotal > 0 
    ? Math.round((price - avgActiveTotal) / avgActiveTotal * 100) 
    : 0;
  
  // === –ê–Ω–∞–ª–∏–∑ –ø–æ –¶–ï–ù–ï –ó–ê –ú¬≤ ===
  const activePricesPerSqm = activeCompetitors
    .map(c => {
      const cPrice = c[5];
      const cArea = c[4];
      return (cPrice && cArea && cArea > 0) ? Math.floor(cPrice / cArea) : null;
    })
    .filter(p => p !== null && p > 0);
  
  const sortedActivePpsm = [...activePricesPerSqm].sort((a, b) => a - b);
  const rankByPpsm = sortedActivePpsm.filter(p => p < pricePerSqm).length + 1;
  const percentileByPpsm = sortedActivePpsm.length > 0 
    ? Math.round((rankByPpsm / sortedActivePpsm.length) * 100) 
    : 0;
  const avgActivePpsm = activePricesPerSqm.length > 0 
    ? Math.floor(activePricesPerSqm.reduce((a, b) => a + b, 0) / activePricesPerSqm.length)
    : 0;
  const diffFromAvgPpsm = avgActivePpsm > 0 
    ? Math.round((pricePerSqm - avgActivePpsm) / avgActivePpsm * 100) 
    : 0;
  
  // === –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é ===
  let recommendation = '';
  
  // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ –ª—É—á—à–µ, —á–µ–º –ø–æ –º¬≤ ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–µ–º–µ–π
  if (percentileByTotal < percentileByPpsm - 10) {
    recommendation = '–û–±—ä–µ–∫—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–µ–Ω –ø–æ –æ–±—â–µ–π —Ü–µ–Ω–µ (—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: —Å–µ–º—å–∏ —Å –±—é–¥–∂–µ—Ç–æ–º)';
  } 
  // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø–æ –º¬≤ –ª—É—á—à–µ ‚Äî –æ–±—ä–µ–∫—Ç –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
  else if (percentileByPpsm < percentileByTotal - 10) {
    recommendation = '–û–±—ä–µ–∫—Ç –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª–µ–Ω –ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤ (—Ü–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã)';
  }
  // –ü–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω—ã
  else {
    recommendation = '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –æ–±–µ–∏–º –º–µ—Ç—Ä–∏–∫–∞–º';
  }
  
  return {
    byTotal: {
      rank: rankByTotal,
      totalActive: sortedActiveTotals.length,
      percentile: percentileByTotal,
      avgDiff: `${diffFromAvgTotal > 0 ? '+' : ''}${diffFromAvgTotal}%`,
      avgPrice: avgActiveTotal
    },
    byPricePerSqm: {
      rank: rankByPpsm,
      totalActive: sortedActivePpsm.length,
      percentile: percentileByPpsm,
      avgDiff: `${diffFromAvgPpsm > 0 ? '+' : ''}${diffFromAvgPpsm}%`,
      avgPricePerSqm: avgActivePpsm
    },
    ourPrice: price,
    ourPricePerSqm: pricePerSqm,
    recommendation: recommendation
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ —Å —É—á–µ—Ç–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –∑–∞ –º¬≤ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketRatios –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Ä—ã–Ω–∫–æ–º.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateSingleObjectForecasts(objectPrice, objectPricePerM2, marketRatios, demandPerMonth, objectData, activeCompetitors, soldCompetitors) {
  const qualityScore = calculateQualityScore(objectData);
  const hasSoldData = soldCompetitors.length > 0;
  const hasActiveData = activeCompetitors.length > 0;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  const marketSituation = assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, objectData[1]);

  // –î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–∏—Ç–æ–∫–∞ –∏ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è (–Ω—É–∂–Ω—ã –¥–ª—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –±–µ–∑ –ø—Ä–æ–¥–∞–∂)
  const avgNewObjectsPerMonth = calculateRealArrivalRate(activeCompetitors);
  const activePrices = activeCompetitors.map(c => c[6]).filter(p => p > 0);
  const pricePressure = calculateRecentPricingTrend(activeCompetitors, objectPricePerM2);
  
  // –ë–∞–∑–æ–≤—ã–µ —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
  let baseSoldPrice, baseActivePrice, baseMarketPrice;
  const objectArea = Number(objectData[4]) || 1; // –ü–ª–æ—â–∞–¥—å –æ–±—ä–µ–∫—Ç–∞
  
  if (hasSoldData) {
    baseSoldPrice = marketRatios.avgSoldPrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    baseSoldPrice = calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation);
  }
  
  if (hasActiveData) {
    baseActivePrice = marketRatios.avgActivePrice * objectArea; // –¶–µ–Ω–∞ –∑–∞ –º¬≤ * –ø–ª–æ—â–∞–¥—å = –ø–æ–ª–Ω–∞—è —Ü–µ–Ω–∞
  } else {
    // –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∫–∞–∫ –±–∞–∑—É
    baseActivePrice = objectPrice;
  }
  
  // –†—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
  baseMarketPrice = baseSoldPrice || baseActivePrice || objectPrice;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞
  const forecasts = calculateForecastsByPosition(
    objectPrice, 
    baseSoldPrice, 
    baseActivePrice, 
    baseMarketPrice,
    qualityScore,
    marketSituation,
    activeCompetitors,
    soldCompetitors,
    demandPerMonth,
    objectData, // [+] [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ReferenceError]
    avgNewObjectsPerMonth,
    pricePressure
  );
  
  // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  Logger.log(`[DYNAMICS] Arrival: ${avgNewObjectsPerMonth}/–º–µ—Å, Price Pressure: ${(pricePressure * 100).toFixed(1)}%`);

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ —Å —É—á–µ—Ç–æ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
  const timeForecasts = calculateTimeForecasts(
    {...forecasts, position: calculateObjectPosition(objectPricePerM2, activeCompetitors)}, 
    demandPerMonth, 
    marketSituation,
    activeCompetitors.length,
    soldCompetitors.length,
    objectData,
    avgNewObjectsPerMonth,
    objectPricePerM2,
    activePrices,
    pricePressure
  );
  
  return {
    ...forecasts,
    ...timeForecasts,
    qualityScore,
    marketSituation
  };
}

/**
 * –û—Ü–µ–Ω–∏–≤–∞–µ—Ç —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.
 * @param {boolean} hasSoldData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö.
 * @param {boolean} hasActiveData –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –æ–± –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {string} district –†–∞–π–æ–Ω.
 * @returns {Object} –û–ø–∏—Å–∞–Ω–∏–µ —Ä—ã–Ω–æ—á–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.
 */
function assessMarketSituation(hasSoldData, hasActiveData, demandPerMonth, district) {
  if (!hasSoldData && !hasActiveData) {
    return {
      type: 'NO_DATA',
      description: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞—Ö –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –∞–Ω–∞–ª–∏–∑ —Å–æ—Å–µ–¥–Ω–∏—Ö —Ä–∞–π–æ–Ω–æ–≤'
    };
  }
  
  if (!hasSoldData && hasActiveData) {
    return {
      type: 'NO_SALES',
      description: '–ù–µ—Ç –ø—Ä–æ–¥–∞–∂ –≤ —Ä–∞–π–æ–Ω–µ –∑–∞ –ø–µ—Ä–∏–æ–¥',
      riskLevel: 'MEDIUM',
      recommendation: '–†—ã–Ω–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –≤–æ–∑–º–æ–∂–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ä–æ–∫–∏ –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  if (hasSoldData && !hasActiveData) {
    return {
      type: 'NO_ACTIVE',
      description: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'LOW',
      recommendation: '–ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–º–∏–∞–ª—å–Ω—É—é —Ü–µ–Ω—É'
    };
  }
  
  if (demandPerMonth < 0.5) {
    return {
      type: 'LOW_DEMAND',
      description: '–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å –≤ —Ä–∞–π–æ–Ω–µ',
      riskLevel: 'HIGH',
      recommendation: '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø—Ä–æ–¥–∞–∂–∏'
    };
  }
  
  return {
    type: 'NORMAL',
    description: '–û–±—ã—á–Ω–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è',
    riskLevel: 'LOW',
    recommendation: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ü–µ–Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏–º–µ–Ω–∏–º—ã'
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —Ü–µ–Ω–∞.
 */
function calculateAlternativeSoldPrice(objectPrice, objectData, marketSituation) {
  // –ë–∞–∑–æ–≤—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
  const typeMultipliers = {
    '–ö–≤–∞—Ä—Ç–∏—Ä–∞': 1.0,
    '–°—Ç—É–¥–∏—è': 0.85,
    '–î–æ–º': 1.2,
    '–¢–∞—É–Ω—Ö–∞—É—Å': 1.1
  };
  
  const objectType = objectData[2] || '–ö–≤–∞—Ä—Ç–∏—Ä–∞';
  const baseMultiplier = typeMultipliers[objectType] || 1.0;
  
  // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞ —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
  let situationMultiplier = 1.0;
  switch (marketSituation.type) {
    case 'NO_DATA':
      situationMultiplier = 0.9; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 10% –∏–∑-–∑–∞ –Ω–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç–∏
      break;
    case 'LOW_DEMAND':
      situationMultiplier = 0.85; // –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 15% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–≥–æ —Å–ø—Ä–æ—Å–∞
      break;
    case 'NO_ACTIVE':
      situationMultiplier = 1.05; // –ü–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞ 5% –∏–∑-–∑–∞ –Ω–∏–∑–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
      break;
  }
  
  return objectPrice * baseMultiplier * situationMultiplier;
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ —Ü–µ–Ω –∑–∞ –º¬≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {Array} activeCompetitors –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {Array<number>} –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞ –º¬≤.
 */
function getSortedActivePricesPerM2(activeCompetitors) {
  return (activeCompetitors || [])
    .map(c => Number(c[6]) || 0)
    .filter(p => p > 0)
    .sort((a, b) => a - b);
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–ª–µ–≤–æ–π —Ä–∞–Ω–≥ –ø–æ —Å–ø—Ä–æ—Å—É –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç—É —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {number} targetMonths –ì–æ—Ä–∏–∑–æ–Ω—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–º–µ—Å).
 * @param {number} totalCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @returns {number|null} –¶–µ–ª–µ–≤–æ–π —Ä–∞–Ω–≥ –∏–ª–∏ null –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö.
 */
function getTargetRankByDemand(demandPerMonth, targetMonths, totalCount) {
  if (!demandPerMonth || demandPerMonth <= 0 || !targetMonths || targetMonths <= 0) return null;
  const raw = Math.ceil(demandPerMonth * targetMonths);
  const maxRank = Math.max(1, Number(totalCount) || 0);
  return Math.max(1, Math.min(raw, maxRank));
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∑–∞ –º¬≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ü–µ–ª–µ–≤–æ–º—É —Ä–∞–Ω–≥—É, —Å —É—á–µ—Ç–æ–º undercut.
 * @param {Array<number>} sortedPricesPerM2 –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞ –º¬≤.
 * @param {number|null} targetRank –¶–µ–ª–µ–≤–æ–π —Ä–∞–Ω–≥ (1 = —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π).
 * @param {number} undercut –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.98 –¥–ª—è –ª—ë–≥–∫–æ–≥–æ –¥–∏—Å–∫–æ–Ω—Ç–∞).
 * @returns {number|null} –¶–µ–Ω–∞ –∑–∞ –º¬≤ –∏–ª–∏ null, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç.
 */
function getPricePerM2ByRank(sortedPricesPerM2, targetRank, undercut) {
  if (!sortedPricesPerM2 || sortedPricesPerM2.length === 0 || !targetRank) return null;
  const idx = Math.min(Math.max(1, targetRank) - 1, sortedPricesPerM2.length - 1);
  const base = sortedPricesPerM2[idx];
  const coef = (typeof undercut === 'number' && undercut > 0) ? undercut : 1;
  return Math.floor(base * coef);
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ä–µ–¥–Ω—é—é —Ü–µ–Ω—É –∑–∞ –º¬≤ —Å—Ä–µ–¥–∏ —Ç–æ–ø-N (—Å–∞–º—ã—Ö –¥–µ—à–µ–≤—ã—Ö) –æ–±—ä–µ–∫—Ç–æ–≤.
 * @param {Array<number>} sortedPricesPerM2 –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã –∑–∞ –º¬≤ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é).
 * @param {number|null} targetRank –¶–µ–ª–µ–≤–æ–π —Ä–∞–Ω–≥ (1 = —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π).
 * @param {number} undercut –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä 0.98 –¥–ª—è –ª—ë–≥–∫–æ–≥–æ –¥–∏—Å–∫–æ–Ω—Ç–∞).
 * @returns {number|null} –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –º¬≤ –∏–ª–∏ null, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç.
 */
function getAvgPricePerM2ByTopRank(sortedPricesPerM2, targetRank, undercut) {
  if (!sortedPricesPerM2 || sortedPricesPerM2.length === 0 || !targetRank) return null;
  const count = Math.min(Math.max(1, targetRank), sortedPricesPerM2.length);
  const top = sortedPricesPerM2.slice(0, count).filter(p => p > 0);
  if (top.length === 0) return null;
  const avg = calculateAverage(top);
  const coef = (typeof undercut === 'number' && undercut > 0) ? undercut : 1;
  return Math.floor(avg * coef);
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å —É—á–µ—Ç–æ–º –ø–æ–∑–∏—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} objectPrice –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞.
 * @param {number} baseSoldPrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {number} baseActivePrice –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} baseMarketPrice –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞.
 * @param {number} qualityScore –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞—á–µ—Å—Ç–≤–∞.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {Array} soldCompetitors –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {number} arrivalPerMonth –ü—Ä–∏—Ç–æ–∫ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –º–µ—Å—è—Ü.
 * @param {number} pricePressure –î–æ–ª—è –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å (0..1).
 * @returns {Object} –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 */
function calculateForecastsByPosition(objectPrice, baseSoldPrice, baseActivePrice, baseMarketPrice, qualityScore, marketSituation, activeCompetitors, soldCompetitors, demandPerMonth, objectData, arrivalPerMonth, pricePressure) {
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤)
  const area = Number(objectData[4]) || 1;
  const objectPricePerM2 = area > 0 ? (objectPrice / area) : objectPrice;
  const position = calculateObjectPosition(objectPricePerM2, activeCompetitors);
  const totalCompetitors = activeCompetitors.length;
  
  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–∑–∏—Ü–∏–∏
  let positionMultiplier = 1.0;
  if (totalCompetitors > 0) {
    const positionRatio = position / (totalCompetitors + 1);
    if (positionRatio <= 0.2) {
      // –í —Ç–æ–ø-20% - –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 1.05;
    } else if (positionRatio >= 0.8) {
      // –í –Ω–∏–∂–Ω–∏—Ö 20% - —Å–∫–∏–¥–æ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
      positionMultiplier = 0.95;
    }
  }
  
  // –ë–∞–∑–æ–≤–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞ (–æ—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–Ω–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–æ–≤)
  let basePrice;
  if (baseSoldPrice > 0) {
    basePrice = baseSoldPrice * qualityScore * positionMultiplier;
  } else if (baseActivePrice > 0) {
    basePrice = baseActivePrice * qualityScore * positionMultiplier;
  } else {
    basePrice = objectPrice * qualityScore * positionMultiplier;
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ —Ä–∞–Ω–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–ø—Ä–æ—Å–∞ (—Å —É—á–µ—Ç–æ–º –ø—Ä–∏—Ç–æ–∫–∞ –∏ –¥–∞–≤–ª–µ–Ω–∏—è)
  const sortedPricesPerM2 = getSortedActivePricesPerM2(activeCompetitors);
  const priceBelowRatio = calculatePriceBelowRatio(objectPricePerM2, sortedPricesPerM2, arrivalPerMonth || 0);
  const effectiveDemand = Math.max(0.1, (demandPerMonth || 0) - (arrivalPerMonth || 0) * priceBelowRatio);
  let quickTargetRank = getTargetRankByDemand(demandPerMonth || 0, STRATEGY_TARGET_MONTHS.QUICK, sortedPricesPerM2.length);
  let marketTargetRank = getTargetRankByDemand(effectiveDemand, STRATEGY_TARGET_MONTHS.MARKET, sortedPricesPerM2.length);
  const totalCount = sortedPricesPerM2.length;

  if (totalCount > 0) {
    const maxQuickRank = Math.min(10, totalCount);
    if (quickTargetRank) quickTargetRank = Math.min(Math.max(1, quickTargetRank), maxQuickRank);
    if (marketTargetRank) marketTargetRank = Math.min(Math.max(1, marketTargetRank), totalCount);
    
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —Ä–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É –±—ã—Å—Ç—Ä—ã–º –∏ —Ä—ã–Ω–æ—á–Ω—ã–º —Ä–∞–Ω–≥–æ–º (–º–∏–Ω–∏–º—É–º 1 –ø–æ–∑–∏—Ü–∏—è)
    if (quickTargetRank && marketTargetRank) {
      if (marketTargetRank <= quickTargetRank && totalCount > quickTargetRank) {
        marketTargetRank = quickTargetRank + 1;
      }
    }
  }

  // –ü–æ–ª—É—á–∞–µ–º —Ü–µ–ª–µ–≤—ã–µ —Ü–µ–Ω—ã –∑–∞ –º¬≤ –ø–æ —Ä–∞–Ω–≥—É
  const quickPpsm = getAvgPricePerM2ByTopRank(sortedPricesPerM2, quickTargetRank, STRATEGY_UNDERCUT.QUICK);
  const marketPpsm = getAvgPricePerM2ByTopRank(sortedPricesPerM2, marketTargetRank, STRATEGY_UNDERCUT.MARKET);

  // –ë—ã—Å—Ç—Ä–∞—è –∏ —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω—ã (–ú–µ—Ç–æ–¥ –ó–∞–ø–∞—Å–∞ –ü—Ä–æ—á–Ω–æ—Å—Ç–∏: –°—Ä–µ–¥–Ω–µ–µ –ø–æ –¢–û–ü—É * –ö–∞—á–µ—Å—Ç–≤–æ)
  let quickPrice = (quickPpsm && area > 0) ? (quickPpsm * area * qualityScore) : (basePrice * 0.87);
  let marketPrice = (marketPpsm && area > 0) ? (marketPpsm * area * qualityScore) : basePrice;

  // –ü—Ä–∞–≤–∏–ª–æ –¥–≤—É—Ö —è–∫–æ—Ä–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ü–µ–Ω—ã (–ê–∫—Ç–∏–≤–Ω—ã–µ vs –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ)
  let quickPriceAnchor = 'active';
  if (baseSoldPrice > 0 && soldCompetitors.length >= 3) {
    const soldPriceAdjusted = baseSoldPrice * qualityScore * 0.95; // 0.95 - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ 
    if (soldPriceAdjusted < quickPrice) {
      quickPrice = soldPriceAdjusted;
      quickPriceAnchor = 'sold';
    }
  }

  // –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è —Ä—ã–Ω–∫–∞ –±–µ–∑ –ø—Ä–æ–¥–∞–∂: –¥–∏—Å–∫–æ–Ω—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏—Ç–æ–∫–∞ –∏ —Ü–µ–Ω–æ–≤–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è
  if (marketSituation && marketSituation.type === 'NO_SALES') {
    const arrivalRate = Math.max(0, Number(arrivalPerMonth) || 0);
    const pressure = (typeof pricePressure === 'number') ? Math.min(1, Math.max(0, pricePressure)) : 0.5;
    const arrivalPressure = Math.min(1, arrivalRate / 6); // 6+ –Ω–æ–≤—ã—Ö –≤ –º–µ—Å = –º–∞–∫—Å–∏–º—É–º
    const positionPenalty = totalCompetitors > 0 ? Math.min(1, (position - 1) / totalCompetitors) : 0;
    const combined = Math.min(1, arrivalPressure * 0.5 + pressure * 0.4 + positionPenalty * 0.1);

    const quickDiscount = 0.10 + combined * 0.10;  // 10%..20%
    const marketDiscount = 0.05 + combined * 0.07; // 5%..12%
    quickPrice = objectPrice * (1 - quickDiscount);
    marketPrice = objectPrice * (1 - marketDiscount);
  }

  if (marketPrice < quickPrice) {
    marketPrice = quickPrice;
  }
  if (quickPrice > 0 && marketPrice <= quickPrice) {
    const minGap = Math.max(50000, Math.round(quickPrice * 0.03)); // –ú–∏–Ω–∏–º—É–º 50–∫ –∏–ª–∏ 3% —Ä–∞–∑—Ä—ã–≤
    marketPrice = quickPrice + minGap;
  }

  // [–í–ê–†–ò–ê–ù–¢ –ê]: –ñ–µ—Å—Ç–∫–∏–π –ø–æ—Ç–æ–ª–æ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–¥–∞–∂–∏ (—á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ—Ç–µ—Ç—å –∏–∑ –æ–∫–Ω–∞ –≤—ã–∫—É–ø–∞)
  // –ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞ —Å —É—á–µ—Ç–æ–º –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã —Å–∞–º–æ–≥–æ –¥–æ—Ä–æ–≥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ –æ–∫–Ω–∞ —Å–ø—Ä–æ—Å–∞
  if (sortedPricesPerM2.length > 0 && quickTargetRank) {
    const maxAllowedPpsm = sortedPricesPerM2[Math.min(quickTargetRank, sortedPricesPerM2.length) - 1];
    if (maxAllowedPpsm && area > 0) {
      const maxQuickPrice = maxAllowedPpsm * area;
      if (quickPrice > maxQuickPrice) {
        quickPrice = maxQuickPrice; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º "—Å–≤–µ—Ä—Ö—É"
      }
    }
  }

  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–ø–æ —Ü–µ–Ω–µ –∑–∞ –º¬≤)
  let quickPosition = calculateObjectPosition(quickPrice / area, activeCompetitors);
  let marketPosition = calculateObjectPosition(marketPrice / area, activeCompetitors);
  if (quickPosition === marketPosition && totalCount > 1) {
    const nextIdx = Math.min(totalCount - 1, marketPosition);
    const nextPpsm = sortedPricesPerM2[nextIdx];
    if (nextPpsm && area > 0) {
      const bumped = Math.ceil(nextPpsm * area);
      if (bumped > marketPrice) {
        marketPrice = bumped;
        marketPosition = calculateObjectPosition(marketPrice / area, activeCompetitors);
      }
    }
  }

  return {
    quickPrice: Math.round(quickPrice),
    marketPrice: Math.round(marketPrice),
    position: calculateObjectPosition(objectPricePerM2, activeCompetitors),
    quickPosition,
    marketPosition,
    quickTargetRank,
    marketTargetRank,
    positionMultiplier,
    quickAvgPpsm: quickPpsm,
    quickTargetN: quickTargetRank,
    quickPriceAnchor
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∑–∏—Ü–∏—é –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–µ–¥–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ calculateObjectRank).
 * @param {number} objectPricePerM2 –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞ –∑–∞ –º¬≤.
 * @param {Array} activeCompetitors –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã.
 * @returns {number} –ü–æ–∑–∏—Ü–∏—è (1 = —Å–∞–º—ã–π –¥–µ—à–µ–≤—ã–π).
 */
function calculateObjectPosition(objectPricePerM2, activeCompetitors) {
  if (activeCompetitors.length === 0) return 1;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–µ–Ω—É –∑–∞ –º¬≤ (–∏–Ω–¥–µ–∫—Å 6) –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤ –ø–æ–∑–∏—Ü–∏–π
  const competitorPrices = activeCompetitors.map(c => Number(c[6]) || 0).filter(p => p > 0);
  
  const hasOurObject = competitorPrices.some(price => Math.abs(price - objectPricePerM2) < 10);
  
  const allPrices = hasOurObject 
    ? competitorPrices 
    : [...competitorPrices, objectPricePerM2];
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ü–µ–Ω–µ
  allPrices.sort((a, b) => a - b);
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é: —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–µ—à–µ–≤–ª–µ –Ω–∞—Å + 1
  const position = 1 + allPrices.filter(p => p < objectPricePerM2).length;
  
  return position;
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤ –ø—Ä–æ–¥–∞–∂–∏.
 * @param {Object} forecasts –¶–µ–Ω–æ–≤—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã.
 * @param {number} demandPerMonth –°–ø—Ä–æ—Å –≤ –º–µ—Å—è—Ü.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @returns {Object} –ü—Ä–æ–≥–Ω–æ–∑—ã —Å—Ä–æ–∫–æ–≤.
 */
function calculateTimeForecasts(forecasts, demandPerMonth, marketSituation, activeCount, soldCount, objectData, arrival, price, activePrices, pricePressure) {
  // –°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ –∫–æ–º–Ω–∞—Ç–Ω–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω—ã: –∞–Ω–∞–ª–æ–≥–∏ —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º.
  const seasonalCoef = 1.0;
  const roomsFactor = 1.0;
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–æ–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏ —Å–ø—Ä–æ—Å–∞
  let quickMonths, marketMonths, currentMonths, currentMonthsLinear;
  
  if (demandPerMonth > 0) {
    const area = objectData ? Number(objectData[4]) || 1 : 1;
    const currentPricePerM2 = price || 0;
    const quickPricePerM2 = (area > 0 && forecasts.quickPrice) ? (forecasts.quickPrice / area) : currentPricePerM2;
    const marketPricePerM2 = (area > 0 && forecasts.marketPrice) ? (forecasts.marketPrice / area) : currentPricePerM2;

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π, —Ä—ã–Ω–æ—á–Ω–æ–π –∏ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    const quickRank = forecasts.quickPosition || forecasts.position || 1;
    const marketRank = forecasts.marketPosition || forecasts.position || 1;
    const currentRank = forecasts.position || marketRank;

    const quickResult = calculateDynamicTimeOnMarket({
      rank: quickRank,
      demand: demandPerMonth,
      arrival: arrival || 0,
      price: quickPricePerM2 || 0,
      activePrices: activePrices || [],
      pricePressure: pricePressure
    });

    const marketResult = calculateDynamicTimeOnMarket({
      rank: marketRank,
      demand: demandPerMonth,
      arrival: arrival || 0,
      price: marketPricePerM2 || 0,
      activePrices: activePrices || [],
      pricePressure: pricePressure
    });
    
    const currentResult = calculateDynamicTimeOnMarket({
      rank: currentRank,
      demand: demandPerMonth,
      arrival: arrival || 0,
      price: currentPricePerM2 || 0,
      activePrices: activePrices || [],
      pricePressure: pricePressure
    });
    
    quickMonths = Math.round(quickResult.months * seasonalCoef * roomsFactor * 10) / 10;
    marketMonths = Math.round(marketResult.months * seasonalCoef * roomsFactor * 10) / 10;
    currentMonths = Math.round(currentResult.months * seasonalCoef * roomsFactor * 10) / 10;
    currentMonthsLinear = Math.round((currentRank / demandPerMonth) * 10) / 10;
    
    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞–¥–µ–∫–≤–∞—Ç–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    quickMonths = Math.max(1, quickMonths);
    marketMonths = Math.max(quickMonths + 0.5, marketMonths);
    currentMonths = Math.max(1, currentMonths); // Ensure currentMonths is at least 1
  } else {
    // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –ª–æ–≥–∏–∫—É
    const baseMonths = calculateAlternativeTime(activeCount, soldCount, marketSituation);
    quickMonths = Math.ceil(baseMonths * 0.7 * seasonalCoef * roomsFactor);
    marketMonths = Math.ceil(baseMonths * 1.0 * seasonalCoef * roomsFactor);
    currentMonthsLinear = Math.round(baseMonths * 10) / 10;
  }
  
  // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ - 1 –º–µ—Å—è—Ü, –º–∞–∫—Å–∏–º—É–º 24 –º–µ—Å—è—Ü–∞
  quickMonths = Math.max(1, Math.min(24, quickMonths));
  marketMonths = Math.max(1, Math.min(24, marketMonths));
  
  // –¶–µ–ª–µ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–π: –±—ã—Å—Ç—Ä–∞—è = 1 –º–µ—Å (—Ñ–∏–∫—Å), —Ä—ã–Ω–æ—á–Ω–∞—è <= 4 –º–µ—Å (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ)
  const quickTarget = Number(STRATEGY_TARGET_MONTHS && STRATEGY_TARGET_MONTHS.QUICK) || null;
  const marketTarget = Number(STRATEGY_TARGET_MONTHS && STRATEGY_TARGET_MONTHS.MARKET) || null;
  if (quickTarget && quickTarget > 0) {
    quickMonths = quickTarget;
  }
  if (marketTarget && marketTarget > 0) {
    marketMonths = Math.min(marketMonths, marketTarget);
  }
  if (typeof quickMonths === 'number' && typeof marketMonths === 'number') {
    marketMonths = Math.max(quickMonths + 0.5, marketMonths);
  }
  
  return {
    quickMonths,
    marketMonths,
    currentMonths,
    currentMonthsLinear,
    seasonalCoef,
    roomsFactor
  };
}

/**
 * –í—ã—á–∏—Å–ª—è–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø—Ä–æ—Å–µ.
 * @param {number} activeCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
 * @param {number} soldCount –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö.
 * @param {Object} marketSituation –†—ã–Ω–æ—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.
 * @returns {number} –ë–∞–∑–æ–≤—ã–π —Å—Ä–æ–∫ –≤ –º–µ—Å—è—Ü–∞—Ö.
 */
function calculateAlternativeTime(activeCount, soldCount, marketSituation) {
  if (marketSituation.type === 'NO_ACTIVE') {
    return 3; // –ù–∏–∑–∫–∞—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è - –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'LOW_DEMAND') {
    return 12; // –ù–∏–∑–∫–∏–π —Å–ø—Ä–æ—Å - –¥–æ–ª–≥–∞—è –ø—Ä–æ–¥–∞–∂–∞
  }
  
  if (marketSituation.type === 'NO_DATA') {
    return 8; // –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ—Å—Ç—å - —Å—Ä–µ–¥–Ω–∏–π —Å—Ä–æ–∫
  }
  
  // –û–±—ã—á–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
  if (activeCount > 0) {
    return Math.max(2, Math.min(8, activeCount * 0.5)); // 0.5 –º–µ—Å—è—Ü–∞ –Ω–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞
  }
  
  return 6; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 */
function createCriteriaSheet() {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–∏—Å—Ç
    let sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    
    if (!sheet) {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–∏—Å—Ç
      sheet = SPREADSHEET.insertSheet('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω');
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–†–∞–π–æ–Ω', ''],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', ''],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ü–ª–æ—â–∞–¥—å', ''],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', ''],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', ''],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', '']
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    SpreadsheetApp.getUi().alert('‚úÖ –õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
    Logger.log('–õ–∏—Å—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ createCriteriaSheet: ${e.stack}`);
    SpreadsheetApp.getUi().alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ª–∏—Å—Ç–∞ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤: ' + e.message);
  }
}

/**
 * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –Ω–∞ –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤".
 * @param {Array} objectData –î–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç–∞.
 * @param {Object} criteria –ö—Ä–∏—Ç–µ—Ä–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
 */
function writeCompetitorCriteria(objectData, criteria) {
  try {
    const sheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (!sheet) {
      Logger.log('–õ–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç
    sheet.clear();
    
    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = [
      ['–ö–†–ò–¢–ï–†–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –ö–û–ù–ö–£–†–ï–ù–¢–û–í', ''],
      ['', ''],
      ['–ü–ê–†–ê–ú–ï–¢–†–´ –û–ë–™–ï–ö–¢–ê', '–ó–ù–ê–ß–ï–ù–ò–ï'],
      ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞', objectData[5]],
      ['–†–∞–π–æ–Ω', objectData[1]],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', objectData[2]],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', objectData[3]],
      ['–ü–ª–æ—â–∞–¥—å', objectData[4]],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', objectData[6]],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', objectData[10]],
      ['', ''],
      ['–ö–†–ò–¢–ï–†–ò–ò –§–ò–õ–¨–¢–†–ê–¶–ò–ò', ''],
      ['', ''],
      ['–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞–π–æ–Ω–∞'],
      ['–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞', '–°—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'],
      ['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', '–î–æ–ø—É—Å–∫ ¬±1 –∫–æ–º–Ω–∞—Ç–∞'],
      ['–ü–ª–æ—â–∞–¥—å', '–î–æ–ø—É—Å–∫ ¬±20%'],
      ['–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', '–î–æ–ø—É—Å–∫ ¬±10 –ª–µ—Ç'],
      ['–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞', '–ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–∞–∫—Ç–∏–≤–Ω—ã–µ)', '–ù–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä (–ø—Ä–æ–¥–∞–Ω–Ω—ã–µ)', '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ 6 –º–µ—Å—è—Ü–µ–≤'],
      ['', ''],
      ['–†–ê–°–ß–ï–¢–ù–´–ï –ö–†–ò–¢–ï–†–ò–ò', ''],
      ['', ''],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 0.8)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø–ª–æ—â–∞–¥—å', Math.round(criteria.area * 1.2)],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear - 10],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', criteria.buildYear + 10],
      ['–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', Math.max(0, criteria.rooms - 1)],
      ['–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç', criteria.rooms + 1],
      ['', ''],
      ['–î–ê–¢–ê –ê–ù–ê–õ–ò–ó–ê', new Date().toLocaleString('ru-RU')]
    ];
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    sheet.getRange(1, 1, headers.length, 2).setValues(headers);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
    sheet.getRange('A1:B1').merge().setFontWeight('bold').setFontSize(14).setHorizontalAlignment('center');
    sheet.getRange('A3:B3').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A12:B12').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A23:B23').setFontWeight('bold').setBackground('#D3D3D3');
    sheet.getRange('A1:B' + headers.length).setFontSize(9);
    sheet.getRange('A1:B' + headers.length).setVerticalAlignment('middle');
    sheet.getRange('A1:A' + headers.length).setHorizontalAlignment('left');
    sheet.getRange('B1:B' + headers.length).setHorizontalAlignment('center');
    
    Logger.log('–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –ª–∏—Å—Ç');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ writeCompetitorCriteria: ${e.stack}`);
  }
}

/**
 * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞.
 */
function clearAnalysisData() {
  try {
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É" (–æ—Ç—á–µ—Ç)
    const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (analyticsSheet) {
      analyticsSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞"
    const analysisSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYSIS);
    if (analysisSheet) {
      analysisSheet.getRange('A3:AQ1000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
    const competitorsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_COMPETITORS);
    if (competitorsSheet) {
      // [–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ]: –û—á–∏—â–∞–µ–º –¥–æ —Å—Ç–æ–ª–±—Ü–∞ M (13) –∏ —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏
      competitorsSheet.getRange('A2:M2000').clearContent().clearFormat();
    }
    
    // –û—á–∏—â–∞–µ–º –ª–∏—Å—Ç "–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤"
    const criteriaSheet = SPREADSHEET.getSheetByName('–∫—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤');
    if (criteriaSheet) {
      criteriaSheet.getRange('A4:B50').clearContent().clearFormat();
    }
    
    Logger.log('–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞ –æ—á–∏—â–µ–Ω—ã');
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–∏–∑–∞: ${e.stack}`);
  }
}

/**
 * –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —è—á–µ–π–∫–∏ B2 –≤ –ª–∏—Å—Ç–µ "–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –û–ù –ø–æ –∫–æ–¥—É".
 * @param {Event} e –°–æ–±—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
 */
function onEditTrigger(e) {
  const lock = LockService.getDocumentLock();
  if (!lock.tryLock(10000)) {
    Logger.log('‚ö†Ô∏è onEditTrigger: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É.');
    return;
  }
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ –Ω—É–∂–Ω–æ–º –ª–∏—Å—Ç–µ –∏ —è—á–µ–π–∫–µ
    if (e.range.getSheet().getName() === SHEETS.SINGLE_OBJECT_ANALYTICS && 
        e.range.getA1Notation() === 'B2') {
      
      const objectCode = e.value;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–¥ –Ω–µ –ø—É—Å—Ç–æ–π
      if (objectCode && String(objectCode).trim() !== '') {
        Logger.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analyzeSingleObjectByCode(String(objectCode).trim());
      } else {
        // –ï—Å–ª–∏ –∫–æ–¥ –ø—É—Å—Ç–æ–π –∏–ª–∏ —É–¥–∞–ª–µ–Ω - –æ—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞
        Logger.log('–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞ —É–¥–∞–ª–µ–Ω, –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑–∞');
        clearAnalysisData();
      }
    }
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ onEditTrigger: ${error.stack}`);
  } finally {
    lock.releaseLock();
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram –±–æ—Ç–∞ (Webhook).
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function doPost(e) {
  const lock = LockService.getDocumentLock();
  if (!lock.tryLock(10000)) {
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'Busy, try again' }))
      .setMimeType(ContentService.MimeType.JSON);
  }
  try {
    return processBotRequest(e);
  } catch (error) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ doPost: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ error: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –±–æ—Ç–∞.
 * @param {Object} e –°–æ–±—ã—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞.
 * @returns {ContentService.TextOutput} –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.
 */
function processBotRequest(e) {
  try {
    if (!e || !e.postData || !e.postData.contents) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No data' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const contents = JSON.parse(e.postData.contents);
    const objectCode = contents.objectCode;
    
    if (!objectCode) {
      return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: 'No object code' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    Logger.log(`–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç –±–æ—Ç–∞ –¥–ª—è –∫–æ–¥–∞: ${objectCode}`);
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞
    const analysisText = getAnalysisTextForBot(objectCode.toString().trim());
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: 'success', 
      text: analysisText 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ processBotRequest: ${error.stack}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –¥–ª—è –±–æ—Ç–∞ –ø–æ –∫–æ–¥—É –æ–±—ä–µ–∫—Ç–∞.
 * @param {string} objectCode –ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞.
 * @returns {string} –¢–µ–∫—Å—Ç –∞–Ω–∞–ª–∏–∑–∞.
 */
function getAnalysisTextForBot(objectCode) {
  try {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
    const objectData = findObjectByCode(objectCode);
    if (!objectData) {
      return `‚ùå –û–±—ä–µ–∫—Ç —Å –∫–æ–¥–æ–º ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ª–∏—Å—Ç–µ "2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–æ–¥–∞.`;
    }
    
    // 2. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    const competitorsData = buildSingleObjectCompetitorsArray(objectData, objectCode);
    if (competitorsData.activeCompetitors.length === 0 && competitorsData.soldCompetitors.length === 0) {
      return `‚ö†Ô∏è –î–ª—è –æ–±—ä–µ–∫—Ç–∞ ${objectCode} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –ê–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.`;
    }
    
    // 3. –ê–Ω–∞–ª–∏–∑ (–±–µ–∑ –∑–∞–ø–∏—Å–∏ –≤ –ª–∏—Å—Ç, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É)
    const advertisingData = getAdvertisingData(objectCode);
    const result = calculateSingleObjectMetrics(
      objectData,
      competitorsData.activeCompetitors,
      competitorsData.soldCompetitors,
      advertisingData,
      competitorsData.soldRaw,
      competitorsData.soldHeaderMap
    );
    
    // 3.1. üÜï –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø: –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞ –ª–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    try {
      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–∏—Å–∫–∞
      const criteria = {
        district: objectData[1],
        type: objectData[2],
        rooms: Number(objectData[3]),
        area: Number(objectData[4]),
        repair: objectData[6],
        buildYear: Number(objectData[10])
      };
      writeCompetitorCriteria(objectData, criteria);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –Ω–∞ –ª–∏—Å—Ç–µ
      generateSingleObjectReport(objectData, result, competitorsData);
      
      SpreadsheetApp.flush();
      Logger.log('‚úÖ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –Ω–∞ –ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    } catch (uiErr) {
      Logger.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –Ω–∞ –ª–∏—Å—Ç: ${uiErr.message}`);
    }

    // 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¢–ï–ö–°–¢–û–í–û–ì–û –æ—Ç—á–µ—Ç–∞ (–≤–µ—Å—å –¥–∏–∞–ø–∞–∑–æ–Ω A4:B48)
    const fullTextReport = getFormattedFullReportText();
    
    return fullTextReport;
    
  } catch (e) {
    Logger.log(`–û—à–∏–±–∫–∞ –≤ getAnalysisTextForBot: ${e.stack}`);
    return `‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ–±—ä–µ–∫—Ç–∞: ${e.message}`;
  }
}

/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ A4:B48 –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏—Ö.
 */
function getFormattedFullReportText() {
  const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
  if (!sheet) return '‚ùå –õ–∏—Å—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω';
  
  const values = sheet.getRange('A4:B48').getValues();
  let text = '';
  
  for (let i = 0; i < values.length; i++) {
    const label = String(values[i][0] || '').trim();
    const val = String(values[i][1] || '').trim();
    
    if (!label && !val) continue;
    if (label.includes('---')) continue;
    
    // –†–∞–∑–¥–µ–ª—ã (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –≤ –¢–ì —á–µ—Ä–µ–∑ Markdown)
    if (label && !val) {
      text += "\n*" + label + "*\n";
    } else {
      text += label + ": " + val + "\n";
    }
  }
  
  return text;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç PDF-—Ñ–∞–π–ª –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ A4:B48 –ª–∏—Å—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.
 */
function exportRangeToPdf(objectCode) {
  try {
    const sheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);
    if (!sheet) return null;

    const gid = sheet.getSheetId();
    const spreadsheetId = SPREADSHEET.getId();
    
    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ PDF
    const url = "https://docs.google.com/spreadsheets/d/" + spreadsheetId + "/export" +
      "?format=pdf&" +
      "size=A4&" +
      "portrait=true&" +
      "fitw=true&" +
      "sheetnames=false&printtitle=false&pagenumbers=false&gridlines=false&fzr=false&" +
      "gid=" + gid + "&" +
      "range=A4:B48";

    const token = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    return response.getBlob().setName("–ê–Ω–∞–ª–∏–∑_–û–ù_" + objectCode + ".pdf");
  } catch (e) {
    Logger.log("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF: " + e.message);
    return null;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PDF-–¥–æ–∫—É–º–µ–Ω—Ç –≤ Telegram –Ω–∞–ø—Ä—è–º—É—é –∏–∑ GAS.
 */
function sendPdfToTelegramFromGAS(chatId, objectCode, pdfBlob) {
  if (!pdfBlob || !chatId) return false;
  
  const BOT_TOKEN = "8232668997:AAH1oMWo7ZqnwjVX2GH3avEjPrCTNK2kVmc";
  const url = "https://api.telegram.org/bot" + BOT_TOKEN + "/sendDocument";
  
  const payload = {
    'chat_id': chatId,
    'document': pdfBlob,
    'caption': "üìÑ –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è –æ–±—ä–µ–∫—Ç–∞ " + objectCode
  };
  
  const options = {
    'method': 'post',
    'payload': payload,
    'muteHttpExceptions': true
  };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    Logger.log("PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram. –ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: " + response.getResponseCode());
    return true;
  } catch (e) {
    Logger.log("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ PDF –≤ Telegram: " + e.message);
    return false;
  }
}

// ================== –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–¢–†–£–ö–¢–£–†–´ –¢–ê–ë–õ–ò–¶–´ ==================

/**
 * –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤—Å–µ–π —Ç–∞–±–ª–∏—Ü—ã.
 * –í—ã–≤–æ–¥–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–±–æ –≤—Å–µ—Ö –ª–∏—Å—Ç–∞—Ö, –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∏ –ø—Ä–∏–º–µ—Ä–∞—Ö –¥–∞–Ω–Ω—ã—Ö.
 * –ó–∞–ø—É—Å–∫: –≤ Google Apps Script –≤—ã–±—Ä–∞—Ç—å diagnoseSpreadsheetStructure –∏ –Ω–∞–∂–∞—Ç—å –ó–∞–ø—É—Å–∫.
 */
function diagnoseSpreadsheetStructure() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheets = ss.getSheets();
  
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –°–¢–†–£–ö–¢–£–†–´ –¢–ê–ë–õ–ò–¶–´: ' + ss.getName());
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–∞—Ç–∞: ' + new Date().toLocaleString('ru-RU'));
  Logger.log('–í—Å–µ–≥–æ –ª–∏—Å—Ç–æ–≤: ' + sheets.length);
  Logger.log('');
  
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–∏—Å—Ç—ã –≤ –≥—Ä—É–ø–ø–µ "3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ"
  const skipSheets = ['3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ'];
  
  sheets.forEach((sheet, index) => {
    const sheetName = sheet.getName();
    
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ –ª–∏—Å—Ç—ã
    if (skipSheets.some(skip => sheetName.includes(skip))) {
      Logger.log(`[${index + 1}] –ü–†–û–ü–£–°–ö: "${sheetName}"`);
      Logger.log('');
      return;
    }
    
    Logger.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    Logger.log(`[${index + 1}] –õ–ò–°–¢: "${sheetName}"`);
    Logger.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();
    
    Logger.log(`–†–∞–∑–º–µ—Ä: ${lastRow} —Å—Ç—Ä–æ–∫ x ${lastCol} —Å—Ç–æ–ª–±—Ü–æ–≤`);
    
    if (lastRow === 0 || lastCol === 0) {
      Logger.log('‚ö†Ô∏è –õ–∏—Å—Ç –ø—É—Å—Ç–æ–π');
      Logger.log('');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
    const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    Logger.log('');
    Logger.log('–ó–ê–ì–û–õ–û–í–ö–ò (—Å—Ç—Ä–æ–∫–∞ 1):');
    headers.forEach((header, colIndex) => {
      const colLetter = columnToLetter(colIndex + 1);
      Logger.log(`  [${colLetter}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
    });
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∞ 2, –µ—Å–ª–∏ –µ—Å—Ç—å)
    if (lastRow >= 2) {
      const exampleRow = sheet.getRange(2, 1, 1, lastCol).getValues()[0];
      Logger.log('');
      Logger.log('–ü–†–ò–ú–ï–† –î–ê–ù–ù–´–• (—Å—Ç—Ä–æ–∫–∞ 2):');
      exampleRow.forEach((value, colIndex) => {
        const colLetter = columnToLetter(colIndex + 1);
        const displayValue = String(value).substring(0, 50); // –û–±—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        Logger.log(`  [${colLetter}]: "${displayValue}${String(value).length > 50 ? '...' : ''}"`);
      });
    }
    
    // –ò—â–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å —Å—Å—ã–ª–∫–∞–º–∏
    Logger.log('');
    Logger.log('–ê–ù–ê–õ–ò–ó –°–¢–û–õ–ë–¶–û–í:');
    headers.forEach((header, colIndex) => {
      const headerLower = String(header).toLowerCase();
      if (headerLower.includes('—Å—Å—ã–ª–∫') || headerLower.includes('link') || headerLower.includes('url')) {
        Logger.log(`  üìé –°–°–´–õ–ö–ê –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
      if (headerLower.includes('–∫–æ–¥') || headerLower.includes('code') || headerLower.includes('id')) {
        Logger.log(`  üîë –ö–û–î –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
      if (headerLower.includes('—Ä–∏—ç–ª—Ç–æ—Ä') || headerLower.includes('–∞–≥–µ–Ω—Ç') || headerLower.includes('–º–µ–Ω–µ–¥–∂–µ—Ä')) {
        Logger.log(`  üë§ –†–ò–≠–õ–¢–û–† –Ω–∞–π–¥–µ–Ω –≤ —Å—Ç–æ–ª–±—Ü–µ [${columnToLetter(colIndex + 1)}] (–∏–Ω–¥–µ–∫—Å ${colIndex}): "${header}"`);
      }
    });
    
    Logger.log('');
  });
  
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  Logger.log('–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê');
  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}

/**
 * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–±—Ü–∞ –≤ –±—É–∫–≤—É (1 -> A, 2 -> B, ... 27 -> AA).
 */
function columnToLetter(column) {
  let letter = '';
  while (column > 0) {
    let temp = (column - 1) % 26;
    letter = String.fromCharCode(temp + 65) + letter;
    column = Math.floor((column - temp - 1) / 26);
  }
  return letter;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (—Å–∞–º–∞—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Å—Ä–µ–¥–∏ –ø–µ—Ä–≤—ã—Ö maxRows).
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet –õ–∏—Å—Ç.
 * @param {number} maxRows –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
 * @returns {number} –ù–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 */
function detectHeaderRow(sheet, maxRows) {
  const rows = Math.min(maxRows || 10, sheet.getLastRow() || 1);
  const cols = sheet.getLastColumn() || 1;
  const preview = sheet.getRange(1, 1, rows, cols).getValues();
  let headerRow = 1;
  let bestScore = -1;
  const headerToken = /(–∫–æ–¥|id|–Ω–æ–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞|—Å—Ç–∞—Ç—É—Å|–¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞|–¥–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏|—Ä–∞–π–æ–Ω|—Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞|–ø–ª–æ—â–∞–¥—å|—Ü–µ–Ω–∞|—Å—Å—ã–ª–∫–∞|—ç—Ç–∞–∂|–≥–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏|–ø—Ä–æ—Å–º–æ—Ç—Ä—ã|–∞–≤–∏—Ç–æ|—Ü–∏–∞–Ω|–¥–æ–º–∫–ª–∏–∫|–∏—Ç–æ–≥–æ)/i;
  preview.forEach((row, idx) => {
    const count = row.filter(v => String(v).trim() !== '').length;
    const headerHits = row.reduce((acc, v) => {
      const s = String(v || '').trim();
      return acc + (s && headerToken.test(s) ? 1 : 0);
    }, 0);
    const score = count + headerHits * 2;
    if (score > bestScore) {
      bestScore = score;
      headerRow = idx + 1;
    }
  });
  return headerRow;
}

/**
 * –°–æ–∑–¥–∞–µ—Ç map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: lower(header) -> –∏–Ω–¥–µ–∫—Å (1-based).
 * @param {Array} headers –ó–∞–≥–æ–ª–æ–≤–∫–∏.
 * @returns {Object} Map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 */
function buildHeaderIndexMap(headers) {
  const map = {};
  headers.forEach((h, i) => {
    const key = String(h || '').trim().toLowerCase();
    if (key && map[key] === undefined) map[key] = i + 1;
  });
  return map;
}

/**
 * –ò—â–µ—Ç –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ –ø–æ –Ω–∞–±–æ—Ä—É –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
 * @param {Object} headerMap Map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * @param {Array<string>} patterns –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π.
 * @returns {number|null} –ò–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ null.
 */
function getColumnIndexByHeader(headerMap, patterns) {
  if (!headerMap || !patterns) return null;
  for (const p of patterns) {
    const key = String(p || '').trim().toLowerCase();
    if (key && headerMap[key]) return headerMap[key];
  }
  return null;
}

/**
 * –ò—â–µ—Ç –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
 * @param {Object} headerMap Map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * @param {Array<string>} keywords –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.
 * @returns {number|null} –ò–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ –∏–ª–∏ null.
 */
function getColumnIndexByKeywords(headerMap, keywords) {
  if (!headerMap || !keywords) return null;
  const keys = Object.keys(headerMap);
  for (const kw of keywords) {
    const needle = String(kw || '').trim().toLowerCase();
    if (!needle) continue;
    if (headerMap[needle]) return headerMap[needle];
    const foundKey = keys.find(k => k.includes(needle));
    if (foundKey) return headerMap[foundKey];
  }
  return null;
}

/**
 * –ò—â–µ—Ç –∏–Ω–¥–µ–∫—Å –∫–æ–ª–æ–Ω–∫–∏ –ø–æ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–ª—é (—á–µ—Ä–µ–∑ FIELD_ALIASES).
 * @param {Object} headerMap Map –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * @param {string} field –ö–∞–Ω–æ–Ω–∏—á–Ω–æ–µ –ø–æ–ª–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'code', 'price').
 * @param {Array<string>} extraAliases –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞–ª–∏–∞—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ).
 * @returns {number|null}
 */
function getColumnIndexByField(headerMap, field, extraAliases) {
  if (!headerMap || !field) return null;
  const base = FIELD_ALIASES[field] || [];
  const aliases = [...base, ...(extraAliases || [])];
  return getColumnIndexByKeywords(headerMap, aliases);
}

/**
 * –ë–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å—Ç—Ä–æ–∫–∏ –ø–æ —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –ø–æ–ª—é.
 */
function getRowField(row, headerMap, field, fallbackIndex) {
  const idx = getColumnIndexByField(headerMap, field);
  if (idx) return row[idx - 1];
  if (typeof fallbackIndex === 'number') return row[fallbackIndex];
  return null;
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (—É—Å–∫–æ—Ä–µ–Ω–∏–µ).
 */
function getHeaderMapCached(sheet) {
  const cache = CacheService.getScriptCache();
  const cacheKey = `HEADERMAP_${sheet.getName()}`;
  const cached = cache.get(cacheKey);
  if (cached) {
    try { return JSON.parse(cached); } catch (e) {}
  }
  const headerRow = detectHeaderRow(sheet, 10);
  const headerValues = sheet.getRange(headerRow, 1, 1, sheet.getLastColumn()).getValues()[0];
  const headerMap = buildHeaderIndexMap(headerValues);
  const payload = JSON.stringify({ headerRow, headerMap });
  cache.put(cacheKey, payload, HEADER_CACHE_TTL);
  return { headerRow, headerMap };
}

/**
 * –ß–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ª–∏—Å—Ç–∞ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * @returns {{rows:Array, headerRow:number, headerMap:Object}}
 */
function readSheetDataWithHeader(sheet) {
  if (!sheet || sheet.getLastRow() < 2) return { rows: [], headerRow: 1, headerMap: {} };
  const { headerRow, headerMap } = getHeaderMapCached(sheet);
  const dataStartRow = headerRow + 1;
  if (dataStartRow > sheet.getLastRow()) return { rows: [], headerRow, headerMap };
  const rows = sheet.getRange(dataStartRow, 1, sheet.getLastRow() - dataStartRow + 1, sheet.getLastColumn()).getValues();
  return { rows, headerRow, headerMap };
}

/**
 * –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
 * –ò—Å–∫–ª—é—á–∞–µ—Ç –ª–∏—Å—Ç—ã: "–õ–∏—Å—Ç4", "3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ".
 */
function runFullAudit() {
  const EXCLUDE = new Set(['–õ–∏—Å—Ç4', '3. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –≥—Ä—É–ø–ø–µ']);
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const auditSheetName = '–ê–£–î–ò–¢';
  let auditSheet = ss.getSheetByName(auditSheetName);
  if (!auditSheet) auditSheet = ss.insertSheet(auditSheetName);
  auditSheet.clear();
  auditSheet.appendRow(['–õ–∏—Å—Ç', 'HeaderRow', 'HeaderCount', 'EmptyHeaders', 'DuplicateHeaders', 'MissingExpected', 'SampleDataRows']);

  const EXPECTED = {
    '2. 2. –∞–∫—Ç–∏–≤–Ω—ã–µ': [
      '–î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ','–†–∞–π–æ–Ω','–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞','–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç','–ü–ª–æ—â–∞–¥—å',
      '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞','–¶–µ–Ω–∞','–≠—Ç–∞–∂','–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π','–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏','–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç'
    ],
    '1. 2. –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ': [
      '–î–∞—Ç–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏','–†–∞–π–æ–Ω','–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞','–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç','–ü–ª–æ—â–∞–¥—å',
      '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞','–¶–µ–Ω–∞','–≠—Ç–∞–∂','–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π','–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏','–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç','–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'
    ],
    '3. 56. –∞–≤–∏—Ç–æ': ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','–∞–≤–∏—Ç–æ','–¥–∞—Ç–∞'],
    '5. 56. —Ü–∏–∞–Ω': ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','—Ü–∏–∞–Ω','–¥–∞—Ç–∞'],
    '6. 56. –¥–æ–º–∫–ª–∏–∫': ['–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','–¥–æ–º–∫–ª–∏–∫','–¥–∞—Ç–∞'],
    '–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–±—ä–µ–∫—Ç–∞': [
      '–î–∞—Ç–∞ –≤—ã–≤–æ–¥–∞ –∑–∞—è–≤–∫–∏ –≤ –∞–∫—Ç–∏–≤–Ω—ã–µ','–†–∞–π–æ–Ω','–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞','–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç','–ü–ª–æ—â–∞–¥—å','–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç',
      '–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞','–¶–µ–Ω–∞','–≠—Ç–∞–∂','–ö–æ–ª-–≤–æ —ç—Ç–∞–∂–µ–π','–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
    ],
    '–∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø—Ä–æ–¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞': [
      '–ö–æ–¥ –æ–±—ä–µ–∫—Ç–∞','–†–∞–π–æ–Ω','–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞','–ö–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç','–ü–ª–æ—â–∞–¥—å','–¶–µ–Ω–∞','–¶–µ–Ω–∞ –∑–∞ –º¬≤',
      '–°—Ä–æ–∫ –ø—Ä–æ–¥–∞–∂–∏, –¥–Ω–µ–π','–°—Å—ã–ª–∫–∞','–†–µ–º–æ–Ω—Ç','–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞','–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å','–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏'
    ]
  };

  ss.getSheets().forEach(sheet => {
    const name = sheet.getName();
    if (EXCLUDE.has(name)) return;

    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    if (!lastRow || !lastCol) {
      auditSheet.appendRow([name, '-', 0, '-', '-', '-', 0]);
      return;
    }

    const headerRowIndex = detectHeaderRow(sheet, 10);
    const header = sheet.getRange(headerRowIndex, 1, 1, lastCol).getValues()[0]
      .map(v => String(v).trim());

    const emptyHeaders = header
      .map((v, i) => v === '' ? i + 1 : null)
      .filter(v => v !== null);

    const dup = header.reduce((acc, v) => {
      if (!v) return acc;
      acc[v] = (acc[v] || 0) + 1;
      return acc;
    }, {});
    const duplicates = Object.keys(dup).filter(k => dup[k] > 1);

    const expected = EXPECTED[name] || [];
    const headerLower = new Set(header.map(h => h.toLowerCase()));
    const missingExpected = expected.filter(e => !headerLower.has(e.toLowerCase()));

    const dataRows = sheet.getRange(headerRowIndex + 1, 1, Math.min(3, lastRow - headerRowIndex), lastCol).getValues();
    const nonEmptyData = dataRows.filter(r => r.some(v => String(v).trim() !== '')).length;

    auditSheet.appendRow([
      name,
      headerRowIndex,
      header.length,
      emptyHeaders.length ? emptyHeaders.join(',') : '',
      duplicates.length ? duplicates.join(',') : '',
      missingExpected.length ? missingExpected.join(' | ') : '',
      nonEmptyData
    ]);
  });

  SpreadsheetApp.flush();
  Logger.log('–ê—É–¥–∏—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ª–∏—Å—Ç–µ "–ê–£–î–ò–¢".');
}

// ================== –û–ë–†–ê–ë–û–¢–ö–ê –û–ß–ï–†–ï–î–ò –ó–ê–ü–†–û–°–û–í (Telegram Bot) ==================

const QUEUE_SHEET_NAME = '–û—á–µ—Ä–µ–¥—å';
const QUEUE_STATUSES = { NEW: 'NEW', PROCESSING: 'PROCESSING', DONE: 'DONE', ERROR: 'ERROR' };
const MAX_RETRIES = 3;
const STUCK_THRESHOLD_MS = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç ‚Äî –ø–æ—Ä–æ–≥ –∑–∞–≤–∏—Å—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ—Ç Telegram-–±–æ—Ç–∞.
 * –ë–µ—Ä–µ—Ç –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º NEW, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑, –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã (installQueueTrigger).
 *
 * –°—Ç–æ–ª–±—Ü—ã –ª–∏—Å—Ç–∞ "–û—á–µ—Ä–µ–¥—å":
 *   A(1)=id, B(2)=created_at, C(3)=object_code, D(4)=chat_id,
 *   E(5)=user, F(6)=status, G(7)=started_at, H(8)=finished_at,
 *   I(9)=tries, J(10)=error, K(11)=result_text, L(12)=eta_sec
 */
function processQueue() {
  const lock = LockService.getDocumentLock();
  if (!lock.tryLock(10000)) {
    Logger.log('‚ö†Ô∏è processQueue: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É. –ü—Ä–æ–ø—É—Å–∫.');
    return;
  }
  try {
    const sheet = SPREADSHEET.getSheetByName(QUEUE_SHEET_NAME);
    if (!sheet) {
      Logger.log('‚ùå processQueue: –ª–∏—Å—Ç "–û—á–µ—Ä–µ–¥—å" –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return;
    }

    const lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      // –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞
      return;
    }

    // –ß–∏—Ç–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    const data = sheet.getRange(2, 1, lastRow - 1, 12).getValues();

    // –ò—â–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º NEW (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –ø–æ—Ä—è–¥–∫—É, —Ç.–µ. –ø–æ created_at)
    let targetIdx = -1;
    for (let i = 0; i < data.length; i++) {
      if (String(data[i][5]).trim().toUpperCase() === QUEUE_STATUSES.NEW) {
        targetIdx = i;
        break;
      }
    }

    // –ï—Å–ª–∏ –Ω–µ—Ç NEW ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å—à–∏–µ PROCESSING
    if (targetIdx === -1) {
      checkStuckProcessing_(sheet, data);
      return;
    }

    const rowNumber = targetIdx + 2; // +1 –∑–∞–≥–æ–ª–æ–≤–æ–∫, +1 –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è —Å 1
    const objectCode = String(data[targetIdx][2]).trim();
    const chatId = String(data[targetIdx][3]).trim();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞
    if (!objectCode) {
      sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.ERROR);
      sheet.getRange(rowNumber, 8).setValue(new Date().toISOString());
      sheet.getRange(rowNumber, 10).setValue('–ü—É—Å—Ç–æ–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞');
      Logger.log(`‚ùå –°—Ç—Ä–æ–∫–∞ ${rowNumber}: –ø—É—Å—Ç–æ–π –∫–æ–¥ –æ–±—ä–µ–∫—Ç–∞`);
      return;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å PROCESSING
    sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.PROCESSING);
    sheet.getRange(rowNumber, 7).setValue(new Date().toISOString());
    SpreadsheetApp.flush();

    Logger.log(`üîÑ processQueue: –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫–∏ ${rowNumber}, –∫–æ–¥=${objectCode}, chat_id=${chatId}`);

    try {
      const analyticsSheet = SPREADSHEET.getSheetByName(SHEETS.SINGLE_OBJECT_ANALYTICS);

      // [1/3] –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ü–ï–†–ï–î –∞–Ω–∞–ª–∏–∑–æ–º, —á—Ç–æ–±—ã –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –ø—Ä–∏–∑—Ä–∞–∫–æ–≤
      try {
        if (analyticsSheet) {
          analyticsSheet.getRange('B2').setValue(objectCode);
          analyticsSheet.getRange('A4:B48').clearContent();
          SpreadsheetApp.flush();
        }
      } catch (uiErr) {
        Logger.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ª–∏—Å—Ç: ${uiErr.message}`);
      }

      // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
      const resultText = getAnalysisTextForBot(objectCode);

      // [2/3] –û—Ç–ø—Ä–∞–≤–∫–∞ PDF –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ (–Ω–µ –æ—à–∏–±–∫–∞)
      const isError = resultText && (resultText.startsWith('‚ùå') || resultText.startsWith('‚ö†Ô∏è'));
      if (!isError && chatId) {
        try {
          const pdfBlob = exportRangeToPdf(objectCode);
          if (pdfBlob) {
            sendPdfToTelegramFromGAS(chatId, objectCode, pdfBlob);
          }
        } catch (pdfErr) {
          Logger.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ PDF: ${pdfErr.message}`);
        }
      }

      // [3/3] –û—á–∏—â–∞–µ–º B2 –ø–æ—Å–ª–µ —Ä–∞–±–æ—Ç—ã, —á—Ç–æ–±—ã –ª–∏—Å—Ç –Ω–µ —Ö—Ä–∞–Ω–∏–ª —Å—Ç–∞—Ä—ã–π –∫–æ–¥
      try {
        if (analyticsSheet) {
          analyticsSheet.getRange('B2').setValue('');
          SpreadsheetApp.flush();
        }
      } catch (cleanErr) {
        Logger.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å B2: ${cleanErr.message}`);
      }

      // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.DONE);
      sheet.getRange(rowNumber, 8).setValue(new Date().toISOString());
      sheet.getRange(rowNumber, 11).setValue(resultText || '–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω, –Ω–æ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç.');

      // –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç—Ä–æ–∫–∏ (—á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞–ª–æ –ª–∏—Å—Ç –æ—Ç –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
      sheet.setRowHeight(rowNumber, 21);

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º ETA –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
      updateQueueETA_(sheet, data, targetIdx);

      Logger.log(`‚úÖ processQueue: –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω –¥–ª—è –∫–æ–¥–∞ ${objectCode}`);

    } catch (analysisError) {
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
      const currentTries = (Number(data[targetIdx][8]) || 0) + 1;
      sheet.getRange(rowNumber, 9).setValue(currentTries);
      sheet.getRange(rowNumber, 10).setValue(String(analysisError.message).substring(0, 500));

      if (currentTries >= MAX_RETRIES) {
        // –ò—Å—á–µ—Ä–ø–∞–Ω—ã –ø–æ–ø—ã—Ç–∫–∏ ‚Äî ERROR
        sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.ERROR);
        sheet.getRange(rowNumber, 8).setValue(new Date().toISOString());
        sheet.setRowHeight(rowNumber, 21);
        Logger.log(`‚ùå processQueue: –æ—à–∏–±–∫–∞ (${currentTries}/${MAX_RETRIES}), –∫–æ–¥=${objectCode}: ${analysisError.message}`);
      } else {
        // –ï—Å—Ç—å –µ—â—ë –ø–æ–ø—ã—Ç–∫–∏ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ NEW
        sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.NEW);
        sheet.getRange(rowNumber, 7).setValue(''); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º started_at
        Logger.log(`‚ö†Ô∏è processQueue: –æ—à–∏–±–∫–∞ (${currentTries}/${MAX_RETRIES}), –≤–æ–∑–≤—Ä–∞—Ç –≤ –æ—á–µ—Ä–µ–¥—å, –∫–æ–¥=${objectCode}: ${analysisError.message}`);
      }
    }

  } catch (e) {
    Logger.log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê processQueue: ${e.stack}`);
  } finally {
    lock.releaseLock();
  }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ –∑–∞–ø—Ä–æ—Å—ã (PROCESSING –¥–æ–ª—å—à–µ 5 –º–∏–Ω—É—Ç) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ –æ—á–µ—Ä–µ–¥—å.
 * @private
 */
function checkStuckProcessing_(sheet, data) {
  const now = new Date().getTime();

  for (let i = 0; i < data.length; i++) {
    if (String(data[i][5]).trim().toUpperCase() !== QUEUE_STATUSES.PROCESSING) continue;

    const startedAt = data[i][6];
    if (!startedAt) continue;

    const startTime = new Date(startedAt).getTime();
    if (isNaN(startTime) || (now - startTime) <= STUCK_THRESHOLD_MS) continue;

    const rowNumber = i + 2;
    const currentTries = (Number(data[i][8]) || 0) + 1;

    if (currentTries >= MAX_RETRIES) {
      sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.ERROR);
      sheet.getRange(rowNumber, 8).setValue(new Date().toISOString());
      sheet.getRange(rowNumber, 10).setValue('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (> 5 –º–∏–Ω)');
    } else {
      sheet.getRange(rowNumber, 6).setValue(QUEUE_STATUSES.NEW);
      sheet.getRange(rowNumber, 7).setValue('');
      sheet.getRange(rowNumber, 9).setValue(currentTries);
    }

    Logger.log(`‚ö†Ô∏è –ó–∞–≤–∏—Å—à–∏–π –∑–∞–ø—Ä–æ—Å –≤ —Å—Ç—Ä–æ–∫–µ ${rowNumber}, tries=${currentTries}, –≤–æ–∑–≤—Ä–∞—â—ë–Ω`);
  }
}

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ ETA –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –≤ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
 * @private
 */
function updateQueueETA_(sheet, data, completedIdx) {
  try {
    // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ DONE –∑–∞–ø–∏—Å—è–º
    let totalSec = 0;
    let doneCount = 0;
    for (let i = 0; i < data.length; i++) {
      if (String(data[i][5]).trim().toUpperCase() === QUEUE_STATUSES.DONE && data[i][6] && data[i][7]) {
        const started = new Date(data[i][6]).getTime();
        const finished = new Date(data[i][7]).getTime();
        if (!isNaN(started) && !isNaN(finished) && finished > started) {
          totalSec += (finished - started) / 1000;
          doneCount++;
        }
      }
    }

    if (doneCount === 0) return;

    const avgSec = Math.round(totalSec / doneCount);
    let queuePosition = 0;

    for (let i = 0; i < data.length; i++) {
      if (String(data[i][5]).trim().toUpperCase() === QUEUE_STATUSES.NEW) {
        queuePosition++;
        const eta = avgSec * queuePosition;
        sheet.getRange(i + 2, 12).setValue(eta);
      }
    }
  } catch (e) {
    Logger.log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ updateQueueETA_: ${e.message}`);
  }
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏ (–∫–∞–∂–¥—É—é 1 –º–∏–Ω—É—Ç—É).
 */
function installQueueTrigger() {
  // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã processQueue
  ScriptApp.getProjectTriggers()
    .filter(t => t.getHandlerFunction() === 'processQueue')
    .forEach(t => ScriptApp.deleteTrigger(t));

  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ç—Ä–∏–≥–≥–µ—Ä ‚Äî –∫–∞–∂–¥—É—é 1 –º–∏–Ω—É—Ç—É
  ScriptApp.newTrigger('processQueue')
    .timeBased()
    .everyMinutes(1)
    .create();

  Logger.log('‚úÖ –¢—Ä–∏–≥–≥–µ—Ä processQueue —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∫–∞–∂–¥—É—é 1 –º–∏–Ω)');
  try {
    SPREADSHEET.toast('‚úÖ –ê–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—É—â–µ–Ω–∞ (1 –º–∏–Ω).', '–ë–æ—Ç');
  } catch (e) { /* –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –±–µ–∑ UI */ }
}

/**
 * –£–¥–∞–ª—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—á–µ—Ä–µ–¥–∏.
 */
function removeQueueTrigger() {
  const removed = ScriptApp.getProjectTriggers()
    .filter(t => t.getHandlerFunction() === 'processQueue');
  removed.forEach(t => ScriptApp.deleteTrigger(t));

  Logger.log(`‚èπÔ∏è –£–¥–∞–ª–µ–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ processQueue: ${removed.length}`);
  try {
    SpreadsheetApp.getUi().alert(`‚èπÔ∏è –ê–≤—Ç–æ–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (—É–¥–∞–ª–µ–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤: ${removed.length}).`);
  } catch (e) { /* –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω–∞ –±–µ–∑ UI */ }
}
