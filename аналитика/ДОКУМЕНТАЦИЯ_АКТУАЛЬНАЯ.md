# ДОКУМЕНТАЦИЯ (АКТУАЛЬНАЯ): АНАЛИЗ НЕДВИЖИМОСТИ

**Файл скрипта:** `аналитика и прогноз улучшенный`
**Версия:** 3.1.0
**Дата:** 2026-02-08

## 1) Что изменилось
- **Единые метрики рынка** для массового и индивидуального анализа.
- **Ранг по цене за м²** — одинаково везде, явно подписан в листах.
- **Исправлен инвентарный период** в массовом анализе.
- **Единый словарь полей** — данные читаются по названиям колонок, а не по номерам.
- **Батчинг массового анализа** — большие объёмы обрабатываются по частям.
- **Блокировки от параллельных запусков** — защита от конфликтов.
- **Кэш заголовков** — меньше обращений к таблицам.
- **Единый стандарт AI‑текстов** (5–7 предложений, 700–900 символов).

## 2) Где отображается инвентарный период
- **Лист:** `аналитика ОН по коду` → в текстовом отчёте строка **"Инвентарный период (Months of Supply)"**.
- **Лист:** `Аналитика всех ОН в группе` → колонка **"Инвентарный период, мес."**.

## 3) Единое окно анализа (период)
**Источник настройки:** лист `⚙️ Настройки`, ячейка **B8**.

- Если **B8 заполнена** (например, 6), анализ считает окно **последних N месяцев**.
- Если **B8 пустая**:
  - массовый анализ берёт даты из **C1–C2** листа `Аналитика всех ОН в группе`;
  - индивидуальный анализ использует **6 месяцев** по умолчанию.

## 4) Единый словарь полей
Данные конкурентов читаются по заголовкам. Примеры:
- Код объекта: `Код объекта`, `код`, `id`, `номер объекта`
- Цена: `Цена`, `стоимость`
- Площадь: `Площадь`, `пл.`
- Дата публикации: `Дата публикации`, `Дата начала публикации`, и т.д.

Это уменьшает риск, что данные «уедут», если кто‑то сдвинет колонку.

## 5) Ранг по цене за м²
Ранг теперь везде считается одинаково — по цене за м².
В интерфейсе это подписано как **"место/ранг по цене м²"**.

## 6) Стандартизация AI‑текстов
Все промпты теперь требуют:
- **5–7 предложений**
- **700–900 символов**
- стартовая фраза: **"Что это значит для вас:"**

## 7) Массовый анализ (батчи)
Если объектов много, анализ идёт частями, чтобы не упираться в лимиты Apps Script.
Система автоматически продолжает обработку следующего батча.

## 8) Безопасность от параллельных запусков
Добавлены блокировки в:
- `startAllFunctions`
- `onEditTrigger`
- `doPost`

Это предотвращает одновременный запуск и конфликт данных.

