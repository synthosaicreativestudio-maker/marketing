# План миграции на PythonAnywhere

## Обзор

Данный документ описывает план миграции Telegram бота с локального развертывания на [PythonAnywhere](http://pythonanywhere.com/) для решения проблем с конфликтами экземпляров и масштабирования до 2,000+ пользователей.

## Проблемы текущего решения

### 1. Конфликты экземпляров
- **Ошибка:** `Conflict: terminated by other getUpdates request`
- **Причина:** Polling (getUpdates) позволяет только одному экземпляру бота работать одновременно
- **Последствия:** Дублирование сообщений, нестабильная работа

### 2. Ограничения масштабирования
- **Текущий лимит:** ~100-200 пользователей
- **Целевой лимит:** 2,000+ пользователей
- **Проблема:** Polling неэффективен при высокой нагрузке

## Преимущества PythonAnywhere

### 1. Решение проблем конфликтов
- **Webhook архитектура** вместо polling
- **Один экземпляр** на сервере
- **Нет конфликтов** getUpdates

### 2. Масштабирование
- **$5/месяц** - Hacker план
- **10,000 хитов/день** - легко для 2,000 пользователей
- **Автоматическое масштабирование** при росте

### 3. Готовое окружение
- **Python 3.10** - уже установлен
- **HTTPS из коробки** - не нужно настраивать SSL
- **Git интеграция** - автоматический деплой
- **Все библиотеки** - gspread, python-telegram-bot, openai, flask

## План миграции

### Этап 1: Подготовка (1-2 дня)

#### 1.1 Создание аккаунта PythonAnywhere
- [ ] Регистрация на [pythonanywhere.com](http://pythonanywhere.com/)
- [ ] Выбор тарифа Hacker ($5/месяц)
- [ ] Настройка базового аккаунта

#### 1.2 Подготовка кода
- [ ] Создание webhook версии бота
- [ ] Адаптация кода для PythonAnywhere
- [ ] Тестирование локально

### Этап 2: Настройка окружения (1 день)

#### 2.1 Установка зависимостей
- [ ] Установка всех Python библиотек
- [ ] Настройка виртуального окружения
- [ ] Проверка совместимости версий

#### 2.2 Настройка переменных окружения
- [ ] Перенос .env файла
- [ ] Настройка всех переменных
- [ ] Проверка доступа к API

### Этап 3: Настройка сервисов (1-2 дня)

#### 3.1 Google Sheets API
- [ ] Настройка доступа с PythonAnywhere сервера
- [ ] Проверка работы с таблицами
- [ ] Тестирование всех операций

#### 3.2 OpenAI API
- [ ] Проверка доступа к API
- [ ] Тестирование генерации ответов
- [ ] Настройка лимитов

#### 3.3 Telegram Webhook
- [ ] Настройка webhook URL
- [ ] Тестирование получения обновлений
- [ ] Отключение polling

### Этап 4: Деплой приложения (1 день)

#### 4.1 Загрузка кода
- [ ] Клонирование репозитория из GitHub
- [ ] Настройка автоматического обновления
- [ ] Проверка структуры файлов

#### 4.2 Настройка WebApp
- [ ] Деплой статических файлов (index.html, menu.html, app.js)
- [ ] Настройка HTTPS для WebApp
- [ ] Тестирование открытия в Telegram

#### 4.3 Настройка Flask приложения
- [ ] Создание WSGI приложения
- [ ] Настройка маршрутов
- [ ] Тестирование webhook endpoints

### Этап 5: Тестирование (1-2 дня)

#### 5.1 Функциональное тестирование
- [ ] Тестирование авторизации
- [ ] Тестирование системы акций
- [ ] Тестирование системы обращений
- [ ] Тестирование ИИ ассистента

#### 5.2 Нагрузочное тестирование
- [ ] Тестирование с 100+ пользователями
- [ ] Проверка стабильности
- [ ] Мониторинг производительности

#### 5.3 Интеграционное тестирование
- [ ] Тестирование всех интеграций
- [ ] Проверка работы webhook
- [ ] Тестирование уведомлений

### Этап 6: Мониторинг и оптимизация (ongoing)

#### 6.1 Настройка мониторинга
- [ ] Настройка логирования
- [ ] Мониторинг ошибок
- [ ] Алерты при проблемах

#### 6.2 Оптимизация
- [ ] Оптимизация производительности
- [ ] Настройка кэширования
- [ ] Мониторинг ресурсов

## Технические детали

### Webhook архитектура

```python
# Пример webhook endpoint
@app.route('/webhook', methods=['POST'])
def webhook():
    update = request.get_json()
    # Обработка обновления
    return 'OK'
```

### Автоматический деплой

```bash
# Настройка автоматического обновления
git clone https://github.com/username/marketingbot.git
cd marketingbot
pip install -r requirements.txt
```

### Конфигурация PythonAnywhere

```python
# WSGI конфигурация
import sys
path = '/home/username/marketingbot'
if path not in sys.path:
    sys.path.append(path)

from webhook_handler import app as application
```

## Стоимость

### PythonAnywhere
- **Hacker план:** $5/месяц
- **10,000 хитов/день**
- **512MB дискового пространства**
- **HTTPS включен**

### GitHub (опционально)
- **Публичный репозиторий:** Бесплатно
- **Приватный репозиторий:** $4/месяц

### Итого: $5-9/месяц

## Риски и митигация

### Риски
1. **Совместимость кода** - некоторые библиотеки могут не работать
2. **Ограничения PythonAnywhere** - лимиты на CPU и память
3. **Сложность отладки** - удаленный сервер

### Митигация
1. **Тестирование** - тщательное тестирование перед миграцией
2. **Мониторинг** - настройка детального мониторинга
3. **Резервные копии** - регулярные бэкапы кода и данных

## Критерии успеха

### Технические
- [ ] Отсутствие ошибок `Conflict: terminated by other getUpdates request`
- [ ] Стабильная работа webhook
- [ ] Все функции работают корректно
- [ ] Производительность соответствует требованиям

### Бизнес
- [ ] Поддержка 2,000+ пользователей
- [ ] Стабильная работа 24/7
- [ ] Быстрое время отклика
- [ ] Надежность системы

## Следующие шаги

1. **Создать аккаунт PythonAnywhere**
2. **Начать с этапа 1.1** - регистрация и настройка
3. **Подготовить webhook версию бота**
4. **Настроить автоматический деплой**

## Контакты и поддержка

- **PythonAnywhere Support:** liveusercare@pythonanywhere.com
- **Документация:** [help.pythonanywhere.com](https://help.pythonanywhere.com/)
- **Форумы:** [www.pythonanywhere.com/forums](https://www.pythonanywhere.com/forums)

---

**Дата создания:** 09.10.2025  
**Версия:** 1.0  
**Статус:** Планирование
