# API Documentation

> ⚠️ **ВАЖНО:** После упрощения архитектуры FastAPI сервер удален. Авторизация теперь происходит напрямую через Telegram WebApp и простую логику в bot.py

## Текущая архитектура авторизации

### Упрощенный поток авторизации
1. Пользователь отправляет `/start` боту
2. Бот отправляет кнопку с WebApp
3. WebApp собирает данные (код партнера + телефон)
4. Данные отправляются боту через Telegram WebApp API
5. Бот проверяет данные и отвечает пользователю

## Устаревшая API документация (для справки)

### POST /api/webapp/auth (УДАЛЕН)
~~Авторизация пользователя через веб-приложение.~~

**Описание:** ~~Проверяет данные партнёра и авторизует пользователя в системе.~~ **Функциональность перенесена в bot.py**

**Request:**
```json
{
  "init_data": "query_id=AAH...&user=%7B%22id%22%3A12345...",
  "partner_code": "111098", 
  "partner_phone": "+7 982 770-1055"
}
```

**Параметры:**
- `init_data` (string) - Данные от Telegram Web App для валидации
- `partner_code` (string) - Код партнёра (только цифры)
- `partner_phone` (string) - Телефон партнёра (любой формат)

**Response (успех):**
```json
{
  "ok": true,
  "message": "authorized",
  "row": 2,
  "telegram_id": 12345
}
```

**Response (ошибка валидации):**
```json
{
  "detail": "partner_code must be numeric"
}
```
**HTTP коды:**
- `200` - Успешная авторизация
- `400` - Неверные данные (код партнёра не числовой)
- `401` - Неверная подпись init_data или отсутствует
- `404` - Партнёр не найден в базе
- `500` - Внутренняя ошибка сервера

### GET /healthz
Проверка состояния сервиса.

**Описание:** Endpoint для мониторинга доступности API.

**Response:**
```json
{
  "status": "ok"
}
```

**HTTP коды:**
- `200` - Сервис работает

### GET /
Редирект на веб-приложение.

**Описание:** Перенаправляет с корневого адреса на веб-приложение.

**Response:** HTTP 307 Redirect to `/webapp/index.html`

### GET /webapp/index.html
Веб-приложение для авторизации.

**Описание:** HTML страница с формой авторизации и Telegram Web App интеграцией.

**Response:** HTML страница с формой

### GET /webapp/app.js
JavaScript код веб-приложения.

**Описание:** Клиентский код для обработки формы и взаимодействия с API.

**Response:** JavaScript файл

## Валидация данных

### partner_code
- Только цифры (0-9)
- Длина: 1-20 символов
- Пример: "111098"

### partner_phone
- Любой формат номера телефона
- Автоматическая нормализация к формату 89XXXXXXXXX
- Примеры: "+7 982 770-1055", "8 982 770 1055", "79827701055"

### init_data
- Строка параметров от Telegram Web App
- Содержит подпись для валидации
- Проверяется с помощью bot_token

## Интеграция с Google Sheets
При наличии настроек Google Sheets API:
- Поиск партнёра по коду и телефону
- Обновление статуса авторизации
- Сохранение Telegram ID пользователя

## Fallback режим (разработка)
При отсутствии Google Sheets:
- Тестовые данные: код "111098", телефон заканчивающийся на "1055"
- Всегда возвращает успешную авторизацию для тестовых данных

## Безопасность
- HTTPS обязателен для продакшена
- Валидация Telegram Web App подписи
- Нормализация и санитизация входных данных
- Логирование всех попыток авторизацииошибок.
