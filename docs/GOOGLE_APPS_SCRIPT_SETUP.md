# Настройка автоматической публикации акций через Google Apps Script

## Обзор

Эта система позволяет автоматически отправлять уведомления в Telegram бот при нажатии кнопки "Опубликовать" в таблице акций.

## Архитектура

1. **Google Apps Script** - отслеживает изменения в таблице
2. **Webhook сервер** - получает уведомления от Google Sheets
3. **Telegram бот** - отправляет уведомления пользователям

## Настройка

### Шаг 1: Настройка webhook сервера

1. Добавьте переменную окружения в `.env`:
```bash
WEBHOOK_SECRET=your_secret_key_here
```

2. Запустите webhook сервер:
```bash
python3 webhook_handler.py
```

3. Настройте доступ к серверу (через ngrok или ваш домен):
```bash
# Если используете ngrok
ngrok http 5000
```

### Шаг 2: Настройка Google Apps Script

1. Откройте вашу таблицу акций: https://docs.google.com/spreadsheets/d/1V3-cPRq_SmbCbIzn1-CWSqD8pdpDqraq_GJ7LjMmwf8/edit

2. Перейдите в **Расширения** → **Apps Script**

3. Удалите весь существующий код и вставьте код из файла `docs/GOOGLE_APPS_SCRIPT_CODE.js`

4. Обновите конфигурацию в начале файла:
```javascript
const CONFIG = {
  // Замените на ваш URL webhook сервера
  WEBHOOK_URL: 'https://your-domain.com/webhook/promotions',
  
  // Замените на ваш секретный ключ
  WEBHOOK_SECRET: 'your_secret_key_here',
  
  // Остальные настройки оставьте как есть
  SHEET_NAME: 'Акции',
  // ...
};
```

5. Сохраните проект (Ctrl+S)

6. Запустите функцию настройки:
   - Выберите функцию `setupTrigger` в выпадающем списке
   - Нажмите **Выполнить**

7. Создайте кнопки "Опубликовать":
   - Выберите функцию `createPublishButtons`
   - Нажмите **Выполнить**

### Шаг 3: Тестирование

1. В таблице акций найдите строку с акцией
2. В колонке H (Действие) должно появиться "Опубликовать"
3. Нажмите на "Опубликовать"
4. Проверьте, что:
   - Статус изменился на "Активна"
   - Дата релиза установилась на сегодня
   - Кнопка "Опубликовать" исчезла
   - В бот пришло уведомление

## Как это работает

1. **Сотрудник нажимает "Опубликовать"** в колонке H
2. **Google Apps Script** отслеживает изменение через триггер `onEdit`
3. **Скрипт обновляет** статус на "Активна" и дату релиза
4. **Скрипт отправляет** webhook уведомление на ваш сервер
5. **Webhook сервер** получает данные и отправляет уведомления в бот
6. **Пользователи получают** уведомления с кнопкой "Посмотреть все акции"

## Безопасность

- Используется секретный ключ для проверки подлинности webhook
- Проверяется, что изменение происходит в нужной колонке
- Логируются все операции для отладки

## Отладка

### Проверка логов Google Apps Script:
1. В Apps Script перейдите в **Выполнения**
2. Просмотрите логи выполнения функций

### Проверка логов webhook сервера:
```bash
tail -f webhook_handler.log
```

### Ручное тестирование:
```javascript
// В Apps Script выполните функцию
testPublishPromotion();
```

## Возможные проблемы

1. **Webhook не отправляется**:
   - Проверьте URL в CONFIG.WEBHOOK_URL
   - Убедитесь, что сервер доступен
   - Проверьте секретный ключ

2. **Триггер не срабатывает**:
   - Проверьте, что триггер создан: **Триггеры** в Apps Script
   - Убедитесь, что функция `onEdit` существует

3. **Кнопки не создаются**:
   - Запустите функцию `createPublishButtons` вручную
   - Проверьте, что в таблице есть данные

## Дополнительные возможности

### Отправка уведомлений об обновлениях:
```javascript
// В Google Apps Script добавьте отслеживание изменений
function onEdit(e) {
  // ... существующий код ...
  
  // Если изменена акция со статусом "Активна"
  if (status === 'Активна' && actionValue !== 'Опубликовать') {
    sendWebhookNotification('update', promotionData);
  }
}
```

### Настройка времени отправки:
```javascript
// В CONFIG добавьте
const CONFIG = {
  // ... существующие настройки ...
  SEND_TIME: '09:00', // Время отправки уведомлений
  TIMEZONE: 'Europe/Moscow'
};
```
