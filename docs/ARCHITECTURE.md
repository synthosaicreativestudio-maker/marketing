# Архитектура MarketingBot v3.2

## Обзор системы

MarketingBot v3.2 - это комплексная система маркетингового бота с интеграцией ИИ-ассистента и системой управления обращениями. Система построена на микросервисной архитектуре с четким разделением ответственности между компонентами и развернута на PythonAnywhere для максимальной производительности и масштабируемости.

## 🏗️ Компоненты системы

### Основные сервисы:
- **`bot.py`** — основной файл бота с инициализацией сервисов
- **`handlers.py`** — обработчики команд и сообщений (31KB)
- **`auth_service.py`** — сервис авторизации с кэшированием (13KB)
- **`sheets.py`** — интеграция с Google Sheets (7KB)
- **`appeals_service.py`** — сервис обращений (24KB)
- **`openai_service.py`** — интеграция с OpenAI (3KB)
- **`response_monitor.py`** — мониторинг ответов (8KB)
- **`promotions_api.py`** — API для работы с акциями (10KB)
- **`promotions_notifier.py`** — уведомления об акциях (7KB)
- **`webhook_handler.py`** — обработчик webhook для Flask (7KB)

### WebApp (Mini App):
- **`index.html`** — страница авторизации партнеров
- **`menu.html`** — личный кабинет с акциями, событиями и дополнительными услугами
- **`app.js`** — JavaScript для WebApp

### Конфигурация:
- **`.env`** — переменные окружения
- **`requirements.txt`** — зависимости Python

### Архитектурные принципы:
- **Модульность** — каждый сервис в отдельном файле
- **Разделение ответственности** — четкие границы между компонентами
- **Кэширование** — оптимизация производительности
- **Логирование** — подробные логи для отладки
- **Асинхронность** — неблокирующие операции

## 🔄 Потоки и сценарии

### Запуск бота:
```bash
# Простой запуск
python3 bot.py

# С виртуальным окружением
.venv/bin/python bot.py
```

### Поток авторизации:
1. **Пользователь** отправляет `/start`
2. **Бот** проверяет статус авторизации через `AuthService`
3. **Если не авторизован**: отправляет кнопку с `index.html` (форма авторизации)
4. **Если авторизован**: отправляет кнопку с `menu.html` (личный кабинет)
5. **WebApp** собирает код партнера + телефон
6. **Бот** получает данные через Telegram WebApp API
7. **AuthService** проверяет данные в Google Sheets
8. **Обновление** статуса авторизации и кэша
9. **Ответ** пользователю (успех/ошибка)

### Поток обработки сообщений:
1. **Пользователь** отправляет сообщение
2. **handlers.py** проверяет авторизацию
3. **openai_service.py** генерирует ответ ИИ
4. **appeals_service.py** записывает обращение в Google Sheets
5. **response_monitor.py** отслеживает ответы специалистов
6. **Бот** отправляет ответ пользователю

### Поток эскалации к специалисту:
1. **ИИ-ассистент** определяет необходимость эскалации
2. **handlers.py** обрабатывает триггерные фразы
3. **appeals_service.py** обновляет статус на "Передано специалисту"
4. **response_monitor.py** отслеживает ответы специалиста
5. **Бот** уведомляет пользователя о передаче специалисту

### Поток работы с акциями:
1. **Пользователь** открывает "Акции и события" в WebApp
2. **menu.html** загружает данные через Telegram WebApp API
3. **promotions_api.py** получает данные из Google Sheets
4. **WebApp** отображает акции в виде карточек
5. **promotions_notifier.py** отправляет уведомления о новых акциях

### Поток работы с дополнительными услугами:
1. **Пользователь** открывает "Дополнительные услуги и сервисы" в WebApp
2. **menu.html** отображает 5 категорий услуг в виде аккордеона
3. **JavaScript** управляет раскрытием/скрытием категорий
4. **WebApp** показывает список услуг в выбранной категории
5. **Навигация** происходит внутри WebApp без отправки данных в бот

## 🔧 Техническая архитектура

### Схема взаимодействия компонентов:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │    │   PythonAnywhere│    │  Google Sheets  │
│                 │    │                 │    │                 │
│  ┌─────────────┐│    │  ┌─────────────┐│    │  ┌─────────────┐│
│  │   handlers  ││◄───┤  │   bot.py    ││    │  │   Auth      ││
│  └─────────────┘│    │  └─────────────┘│    │  │   Appeals   ││
│                 │    │                 │    │  │ Promotions  ││
│  ┌─────────────┐│    │  ┌─────────────┐│    │  └─────────────┘│
│  │   WebApp    ││◄───┤  │  services   ││◄───┤                 │
│  │ (index.html)││    │  │             ││    │                 │
│  │ (menu.html) ││    │  │             ││    │                 │
│  └─────────────┘│    │  └─────────────┘│    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Ключевые особенности архитектуры v3.2:

#### 1. **PythonAnywhere Integration**
- **Встроенный HTTPS** для webhook
- **Автоматическое развертывание** через Git
- **Встроенная поддержка Flask** для webhook
- **Масштабируемость** до 2000+ пользователей

#### 2. **Асинхронная обработка**
- **Неблокирующие операции** с Google Sheets
- **Параллельная обработка** сообщений
- **Эффективное использование ресурсов**

#### 3. **Безопасность**
- **Переменные окружения** для конфиденциальных данных
- **Google Service Account** для доступа к Sheets
- **HTTPS** для всех внешних соединений
- **Валидация данных** на всех уровнях

## 📊 Структура данных

### Google Sheets - Авторизация:
| Колонка | Название | Описание |
|---------|----------|----------|
| A | Код партнера | Уникальный идентификатор |
| C | Телефон партнера | Номер телефона |
| D | Статус авторизации | "авторизован" / пусто |
| E | Telegram ID | ID пользователя в Telegram |
| F | Дата авторизации | Время последней авторизации |

### Google Sheets - Обращения:
| Колонка | Название | Описание |
|---------|----------|----------|
| A | Код партнера | Связь с авторизацией |
| B | Телефон партнера | Контактные данные |
| C | ФИО партнера | Полное имя |
| D | Telegram ID | ID в Telegram |
| E | Текст обращений | История сообщений |
| F | Статус | "Новое", "В работе", "Решено" |
| G | Ответ специалиста | Ответы специалистов |
| H | Время обновления | Timestamp |

### Google Sheets - Акции:
| Колонка | Название | Описание |
|---------|----------|----------|
| A | Дата релиза | Дата публикации |
| B | Название | Заголовок акции |
| C | Описание | Подробное описание |
| D | Статус | "Активна", "Ожидает", "Закончена" |
| E | Дата начала | Начало действия |
| F | Дата окончания | Конец действия |

## 🔄 Жизненный цикл обращения

### 1. **Создание обращения**
- Пользователь отправляет сообщение
- `appeals_service.py` создает запись в Google Sheets
- Статус: "Новое"

### 2. **Обработка ИИ**
- `openai_service.py` генерирует ответ
- Ответ записывается в колонку E
- Статус: "Ответ ИИ"

### 3. **Эскалация к специалисту**
- При необходимости эскалации
- Статус: "Передано специалисту"
- `response_monitor.py` отслеживает ответы

### 4. **Ответ специалиста**
- Специалист отвечает в Google Sheets
- `response_monitor.py` отправляет ответ пользователю
- Статус: "В работе" или "Решено"

## 🚀 Развертывание и мониторинг

### PythonAnywhere Configuration:
```python
# webhook_handler.py
app = Flask(__name__)

@app.route('/webhook', methods=['POST'])
def webhook():
    # Обработка webhook от Google Apps Script
    pass

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### Мониторинг:
- **Логи** в консоли PythonAnywhere
- **Метрики** использования через Google Sheets
- **Ошибки** отслеживаются в логах

### Масштабирование:
- **Текущая нагрузка**: до 2000 пользователей
- **Планируемое**: до 5000 пользователей с оптимизацией
- **Будущее**: миграция на микросервисы при росте

## 🔧 Настройка и конфигурация

### Переменные окружения (.env):
```env
# Telegram
TELEGRAM_TOKEN=your_bot_token
ADMIN_TELEGRAM_ID=your_admin_id

# OpenAI
OPENAI_API_KEY=your_openai_key
OPENAI_ASSISTANT_ID=your_assistant_id

# Google Sheets
GCP_SA_JSON={"type":"service_account",...}
SHEET_ID=your_sheet_id
APPEALS_SHEET_ID=your_appeals_sheet_id
PROMOTIONS_SHEET_ID=your_promotions_sheet_id

# WebApp
WEB_APP_URL=https://your-domain.github.io/marketing/
WEBHOOK_URL=https://your-domain.pythonanywhere.com/webhook
```

### Зависимости (requirements.txt):
```
requests>=2.32.0
python-dotenv>=1.0.0
gspread>=6.1.0
google-auth>=2.37.0
python-telegram-bot>=20.7
openai>=1.45.0
flask>=3.0.0
```

## 📈 Производительность и оптимизация

### Кэширование:
- **Авторизация**: 5 минут TTL
- **Google Sheets**: кэш на уровне приложения
- **WebApp**: кэш на 5 минут

### Асинхронность:
- **Неблокирующие операции** с внешними API
- **Параллельная обработка** сообщений
- **Эффективное использование** ресурсов

### Мониторинг:
- **Логирование** всех операций
- **Метрики** производительности
- **Алерты** при ошибках

---

**Версия архитектуры:** v3.3  
**Последнее обновление:** 10 октября 2025  
**Статус:** ✅ Актуально