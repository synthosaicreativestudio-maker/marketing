```markdown
# Архитектура бота (свод)

Краткое описание: маркетинговый Telegram-бот на Python с плагинной архитектурой. Цели: легко расширяемый, безопасный запуск, удобная поддержка и тестирование.

Компоненты:
- `bot.py` — основной запускной файл: инициализация логов, загрузка .env, создание диспетчера/апдейтера и загрузка плагинов через `plugins/loader.py`.
- `plugins/` — каталог плагинов. Каждый плагин должен предоставлять функцию `register(dispatcher, bot, settings)` и опционально `unregister()`.
- `config/plugins.json` — включенные плагины и их настройки.
- `tools/` — утилиты (логирование переписки, запись реализаций, автогенератор документации).
- `docs/` — проектная документация (правила, реализации, changelog и пр.).

Потоки и сценарии:
- Запуск: `scripts/restart_bot.sh` читает `.env`, экспортирует переменные, останавливает старые инстансы и запускает `bot.py` в фоне с логированием в `logs/bot.log`.
- Обработчики команд: плагины регистрируют command/handler-ы через API выбранной Telegram-библиотеки (в нашем коде — адаптируемо для `python-telegram-bot`).
- Логирование: runtime-логи → `logs/bot.log`; проектная документация и результат реализации фиксируются в `docs/IMPLEMENTATIONS.md`.

Точки расширения:
- Добавление плагина: поместить модуль в `plugins/`, добавить запись в `config/plugins.json` и перезапустить бот.
- Добавление команды админ‑панели: реализовать плагин с проверкой по списку админов (env `ADMINS`).

Переменные окружения (важные):
- `TELEGRAM_TOKEN` — обязательна.
- `ADMINS` — список админ id через запятую (опционально).
- `ENV` — окружение (dev|prod).

Требования к плагину (контракт):
1. Наличие `register(dispatcher, bot, settings)`.
2. Опционально: `METADATA` с `name`, `version`, `description`.
3. Безопасность: не логировать секреты и избегать длинных dump-ов в `logs/`.

Процессы развёртывания и CI:
- CI должен запускать тесты, линтер и после merge в main/safe запускать автогенерацию документации (tools/generate_docs.py) и создавать PR с изменениями в `docs/` (опционально — сразу коммитить в ту же ветку при доверенном runner-е).

Примеры команд:
- Добавить плагин: создать `plugins/myplugin.py` с `register` и добавить в `config/plugins.json`.
- Перезапуск: `bash scripts/restart_bot.sh`.

`IMPLEMENTATIONS.md` → источник правды о том, как и почему сделаны изменения.

``` 
# Описание логики бота

## Цель и назначение
MarketingBot — это Telegram бот для авторизации пользователей через веб-приложение. Основная функция: предоставить пользователям удобный способ авторизации с проверкой данных партнёра.

## Архитектура системы
1. **Telegram Bot** (синхронный HTTP API)
   - Обрабатывает команду `/start`
   - Показывает кнопку "Авторизоваться" с Web App
   - Использует прямые HTTP запросы к Telegram Bot API

2. **Web Application** (HTML + JavaScript)
   - Форма авторизации с полями: код партнёра, телефон
   - Интеграция с Telegram Web App API
   - Адаптивный дизайн с поддержкой тем Telegram
   - Деплой на GitHub Pages

3. **API Server** (FastAPI)
   - Endpoint `/api/webapp/auth` для обработки авторизации
   - Валидация данных партнёра
   - Интеграция с Google Sheets (опционально)
   - HTTPS с самоподписанными сертификатами

## Поток авторизации
1. Пользователь отправляет `/start` боту
2. Бот показывает кнопку "Авторизоваться" (Web App)
3. Открывается веб-приложение в Telegram
4. Пользователь заполняет форму (код партнёра, телефон)
5. Данные отправляются на API `/api/webapp/auth`
6. API проверяет данные и возвращает результат
7. Пользователь получает подтверждение авторизации

## Технические особенности
- **Синхронный подход**: Устранены конфликты event loop
- **HTTPS поддержка**: SSL сертификаты для мобильного доступа
- **GitHub Pages**: Автоматический деплой веб-приложения
- **Качество кода**: 0 ошибок ruff, mypy, bandit
- **Документация**: Полная техническая документация

## Компоненты системы
- `bot.py` — основной файл бота с HTTP API polling
- `app/main.py` — FastAPI сервер с API endpoints
- `webapp/` — веб-приложение (HTML, CSS, JavaScript)
- `start_system.sh` — скрипт автоматического запуска
- `docs/` — техническая документация
