# Функционал эскалации к специалисту

## Описание

Реализован автоматический функционал эскалации обращений к специалисту отдела маркетинга. Когда AI-ассистент не может ответить на запрос пользователя, он автоматически передает обращение специалисту и обновляет статус в Google Sheets.

## Как это работает

### 1. Детекция эскалации

AI-ассистент анализирует свой ответ и определяет, нужно ли передать запрос специалисту. Если в ответе содержатся фразы типа:
- "Передаю ваш запрос специалисту отдела маркетинга"
- "Свяжу вас с ответственным специалистом"
- "Специалист свяжется с вами в ближайшее время"
- И другие подобные фразы

То система автоматически определяет это как эскалацию.

### 2. Обновление статуса

При обнаружении эскалации система:
1. Устанавливает статус обращения на "в работе" в колонке F
2. Применяет заливку цвета #f4cccc (красноватый оттенок)
3. Логирует операцию для мониторинга

### 3. Структура таблицы

Таблица обращений должна содержать следующие колонки:
- A: код партнера
- B: телефон партнера  
- C: ФИО партнера
- D: telegram_id
- E: текст_обращений
- **F: статус** (новое, в работе, решено, закрыто)
- G: специалист_ответ
- H: время_обновления

## Технические детали

### Файлы изменены:
- `handlers.py` - добавлена функция `_is_escalation_response()` и логика обработки эскалации в `chat_handler()`
- `appeals_service.py` - добавлен метод `set_status_escalated()`

### Новые функции:

#### `_is_escalation_response(text: str) -> bool`
Проверяет, содержит ли ответ ассистента фразы эскалации.

#### `set_status_escalated(telegram_id: int) -> bool`
Устанавливает статус "в работе" с заливкой #f4cccc для указанного пользователя.

## Настройка

### Переменные окружения:
- `APPEALS_SHEET_ID` - ID таблицы с обращениями
- `APPEALS_SHEET_NAME` - название листа (по умолчанию "обращения")

### Настройка выпадающего списка в Google Sheets:
1. Выделите колонку F (статус)
2. Данные → Проверка данных
3. Установите список значений: "новое", "в работе", "решено", "закрыто"
4. Настройте условное форматирование:
   - Если статус = "в работе" → цвет #f4cccc
   - Если статус = "в работе" → другой цвет
   - И т.д.

## Мониторинг

Все операции эскалации логируются в файл `bot.log` с уровнем INFO:
- Обнаружение эскалации
- Успешная установка статуса
- Ошибки при обновлении статуса

## Тестирование

Функционал протестирован и работает корректно:
- ✅ Детекция фраз эскалации
- ✅ Установка статуса "в работе"
- ✅ Применение заливки #f4cccc
- ✅ Логирование операций

