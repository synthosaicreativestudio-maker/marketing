# Поток авторизации (Mini App → Бот → Google Sheets)

## Обзор
Этот документ описывает полный сценарий авторизации партнёра: от нажатия `/start` в Telegram до обновления статуса в Google Sheets.

## Предварительные требования
- Переменные окружения в `.env`:
  - `TELEGRAM_TOKEN`
  - `WEB_APP_URL` (HTTPS, GitHub Pages подходит)
  - `SHEET_ID`
  - Один из: `GCP_SA_FILE` (абсолютный путь) или `GCP_SA_JSON` (содержимое JSON)
  - Опционально: `SHEET_NAME` (по умолчанию используется первый лист)
- Таблица Google Sheets (пример: `список сотрудников для авторизации`) со столбцами:
  - A: `Код партнера`
  - C: `Телефон партнера`
  - D: `Статус авторизации` (или `Статус`)
  - E: `Telegram ID`
  - F: `Дата авторизации`

## Шаги сценария

### 1) Пользователь отправляет `/start`
- Бот отвечает приветствием и отображает Reply‑клавиатуру с кнопкой запуска Mini App:
  - `KeyboardButton(web_app=WebAppInfo(url=WEB_APP_URL))`
- Важно: запуск через Reply‑кнопку — обязательное условие для работоспособности `Telegram.WebApp.sendData()`.

### 2) Mini App (WebView) открывается по `WEB_APP_URL`
- Файлы: `index.html`, `app.js`.
- Происходит инициализация `Telegram.WebApp` и `MainButton`.
- Поля формы:
  - Код партнёра (только цифры)
  - Телефон партнёра (достаточно ввести в формате цифр, например `89827701055`)
- При валидных данных `MainButton` активируется. Нажатие вызывает:
  - `tg.MainButton.showProgress(true)`
  - `tg.MainButton.disable()`
  - `tg.sendData(JSON.stringify({ partner_code, partner_phone }))`
  - Небольшая задержка (≈300мс) и `tg.close()` для предотвращения race‑condition на части устройств.

### 3) Бот принимает данные Mini App
- Обработчик зарегистрирован с фильтром `filters.StatusUpdate.WEB_APP_DATA`.
- Бот получает JSON, логирует сырье и извлекает поля `partner_code`, `partner_phone`.
- Пользователю отправляется промежуточное сообщение «Проверяю ваши данные…».

### 4) Поиск в Google Sheets и обновление статуса
- Код выполняется через `AuthService` → `sheets.py`.
- Сопоставление строки:
  - Код партнёра сравнивается строго как строка (цифры без пробелов).
  - Телефон нормализуется до цифр; сравнение по цифрам (поддерживается формат `89827701055`).
  - Поддерживаются русские заголовки колонок: `Код партнера`, `Телефон партнера`, `Статус авторизации`/`Статус`.
- При совпадении строка обновляется пакетно (диапазон `D:F` одной операцией):
  - D: `авторизован`
  - E: `Telegram ID`
  - F: дата/время авторизации
- При успехе бот отвечает: «Авторизация прошла успешно! Добро пожаловать.» и скрывает клавиатуру (`ReplyKeyboardRemove()`).

### 5) Отсутствие совпадения
- Если строка не найдена, бот отвечает: «Данные не найдены. Пожалуйста, проверьте код партнёра и телефон и попробуйте снова.»
- Для удобства повторной попытки бот снова показывает кнопку запуска Mini App.

## Требования к данным
- Код партнёра: только цифры, без пробелов (например, `111098`).
- Телефон партнёра: допустим любой ввод, но для сопоставления берутся только цифры. Рекомендуемый формат ввода — `89827701055`.

## Диагностика и отладка (мобильные клиенты)
- Запуск Mini App строго через Reply‑кнопку (не inline) — иначе `sendData()` будет молча игнорироваться.
- Проверить наличие обработчика `filters.StatusUpdate.WEB_APP_DATA` в боте.
- Добавлена задержка перед `tg.close()` (~300мс) для избежания потенциальной гонки.
- При проблемах с мобильным WebView используйте удалённую отладку (Android Chrome DevTools / iOS Safari Web Inspector) и проверьте ошибки в консоли.

## Частые причины ошибок
- Неправильный способ запуска (inline вместо reply).
- Не заполнены `SHEET_ID`/`GCP_SA_FILE|GCP_SA_JSON` или у сервисного аккаунта нет доступа «Редактор» к таблице.
- В ячейках кода/телефона лишние пробелы/символы; код должен быть строго цифрами.
- Ошибки записи в Sheets при поячеечном обновлении. В проекте используется батч‑обновление `D:F` для надёжности.

## Где смотреть логи
- `bot.log` — общий лог бота и подробные логи сопоставления первых строк таблицы.

## Ссылки
- Telegram Mini Apps: Main Button / Debugging / Web events
- Пример `webappbot.py` в python‑telegram‑bot
