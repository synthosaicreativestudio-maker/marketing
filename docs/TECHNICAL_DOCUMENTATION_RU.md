# Техническая Документация MarketingBot (v3.4.0)

> **Статус:** Активен / Стабилен
> **Последнее обновление:** 11 февраля 2026
> **Роль:** Единый Источник Истины (Single Source of Truth)

---

## 1. Высокоуровневая Архитектура

Проект представляет собой отказоустойчивый **Telegram-бот**, написанный на Python, разработанный для высокой доступности (24/7). Он работает как монолитное приложение с модульными сервисами, используя **Google Sheets** в качестве основной базы данных и **Google Gemini** как основной ИИ.

### Технологический Стек
*   **Язык:** Python 3.12+
*   **Фреймворк:** `python-telegram-bot` (v20+, Async)
*   **База Данных:** Google Sheets (через `gspread` + `tenacity` для повторных попыток)
*   **ИИ Движок:** Google Gemini (модель `gemini-3-flash-preview` / `gemini-1.5-pro` для анализа)
*   **Автоматизация:** Google Apps Script (GAS) для тяжелых расчетов аналитики и генерации PDF
*   **Развертывание:** Systemd Service (Linux/Ubuntu) на Yandex VM

### Диаграмма Архитектуры (Логическая)

```mermaid
graph TD
    User((Пользователь)) <-->|Telegram API| Bot[Core Бота]
    User <-->|Mini App| WebApp[Web App / Фронтенд]
    
    subgraph "Основные Сервисы"
        Bot --> AuthService[Сервис Авторизации]
        Bot --> AppealsService[Сервис Обращений]
        Bot --> AIService[Gemini AI Service]
        Bot --> Notifier[Уведомления Акций]
        Bot --> Analytics[Модуль Аналитики]
    end
    
    subgraph "Слой Данных (Gateway)"
        AuthService --> Gateway[Async Google Sheets Gateway]
        AppealsService --> Gateway
        Notifier --> Gateway
        Analytics --> Gateway
        Gateway -->|Circuit Breaker| GSheets[(Google Sheets)]
    end
    
    subgraph "Автоматизация и ИИ"
        GSheets <-->|Queue Trigger| GAS[Google Apps Script]
        GAS <-->|Reports/PDF| GeminiAPI[Google AI Platform]
        Bot <--|Polling Status| GSheets
        AIService <-->|RAG/Chat/History| GeminiAPI
    end
```

### Ключевые Архитектурные Решения
1.  **Паттерн Gateway:** Все взаимодействия с Google Sheets проходят через `AsyncGoogleSheetsGateway`. Этот слой управляет лимитами запросов и повторными попытками.
2.  **Stateless History:** Бот не хранит историю диалогов локально. Контекст подгружается напрямую из Google Sheets (лист «обращения») при каждом запросе, что обеспечивает консистентность между сессиями.
3.  **Асинхронная Аналитика:** Тяжелые маркетинговые расчеты вынесены в Google Apps Script. Бот лишь ставит задачу в очередь и уведомляет пользователя о готовности.

---

## 2. Структура Данных

### 2.1 Лист Auth (Пользователи)
| Колонка | Заголовок | Описание |
| :--- | :--- | :--- |
| **A** | *Код партнера* | Уникальный код сотрудника/партнера. |
| **B** | *Телефон* | Номер телефона (нормализованный). |
| **D** | **STATUS** | `authorized` / `avtorizovan`. |
| **E** | **Telegram ID** | Привязанный ID пользователя. |

### 2.2 Лист Appeals (Обращения)
| Колонка | Заголовок | Описание |
| :--- | :--- | :--- |
| **D** | Telegram ID | ID пользователя Telegram. |
| **E** | **текст_обращений** | **Накопленная История**. Весь лог чата. |
| **F** | **Статус** | `Новое`, `Ответ ИИ`, `В работе`, `Решено`. |

### 2.3 Лист Очередь (Аналитика)
| Колонка | Заголовок | Описание |
| :--- | :--- | :--- |
| **A** | *id* | Уникальный ID запроса (UUID). |
| **B** | *created_at* | Время создания. |
| **C** | *object_code* | Код объекта недвижимости из CRM. |
| **F** | **status** | `NEW`, `PROCESSING`, `DONE`, `ERROR`. |
| **K** | **result_text** | Текстовый отчёт (анализ рынка). |

---

## 3. Бизнес-Логика и Алгоритмы

### 3.1 Чат и Флоу ИИ
1.  **Ввод:** Пользователь отправляет сообщение.
2.  **Эскалация:** Если сообщение содержит ключевые слова (например, "оператор"), статус меняется на `В работе`, ИИ отключается.
3.  **Контекст:** Бот читает последние сообщения из листа «Обращения» и подставляет их в промпт Gemini.
4.  **Скрипты:** Бот следует сценариям из `system_prompt.txt` (§1-§14).

### 3.2 Модуль «Аналитика 360»
1.  **Инициация:** Пользователь выбирает «Аналитика» в Mini App и вводит код объекта.
2.  **Постановка в очередь:** Бот пишет запрос в лист «Очередь».
3.  **Обработка (GAS):** Скрипт анализирует конкурентов, считает тренды, ранг цены и генерирует текстовый саммари + PDF.
4.  **Polling:** Бот проверяет статус в таблице каждые 15 сек.
5.  **Выдача:** При статусе `DONE` бот отправляет результат пользователю.

---

## 4. Развертывание и Поддержка

### 4.1 Серверная часть
*   Развернуто на **Yandex VM**.
*   Управление через `systemd`: `sudo systemctl restart marketingbot`.
*   Логирование: `journalctl -u marketingbot -f`.

### 4.2 Секреты и Конфигурация
*   Все ключи хранятся в `/home/marketing/shared/.env`.
*   Доступ к Google API через `/home/marketing/shared/credentials.json`.
*   Файлы в `shared/` являются общими для всех релизов.

### 4.3 Blue-Green Развертывание
Для обеспечения нулевого простоя (Zero Downtime) и возможности мгновенного отката используется стратегия Blue-Green деплоя.

#### Структура каталогов на сервере:
```
/home/marketing/
├── shared/              # Постоянные данные (общие для всех версий)
│   ├── .env             # Секреты
│   ├── credentials.json # Google API
│   ├── chat_memory.db   # БД истории
│   └── logs/            # Централизованные логи
├── releases/            # Архив релизов (папки YYYYMMDD_HHMMSS_HASH)
├── current -> releases/X # Симлинк на активную версию
└── deploy.sh            # Скрипт автоматического деплоя
```

#### Механизм работы:
1. **Изоляция**: Каждая новая версия разворачивается в отдельную папку в `releases/` со своим собственным виртуальным окружением `.venv`.
2. **Atomic Switch**: Переключение на новую версию происходит путем мгновенного обновления симлинка `current`.
3. **Smoke Test**: Перед переключением скрипт деплоя выполняет проверку критических импортов. Если проверка не проходит — деплой прерывается, работа продолжается на старой версии.
4. **Rollback**: В случае обнаружения ошибок после деплоя, команда `./rollback.sh` за 1 секунду возвращает предыдущую стабильную версию.

---

## 5. Технический Архив
*   История перехода от SQLite к Google Sheets: [LEGACY_SQLITE.md](archive/LEGACY_SQLITE.md)
*   План устранения проблем стабильности (Январь 2026): [STABILITY_FIX_REPORT.md](STABILITY_FIX_REPORT.md)
