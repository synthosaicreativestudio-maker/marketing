# Решение проблем с акциями

## Общие проблемы

### Проблема: "Failed to fetch" или "Не удалось загрузить акции"

**Симптомы:**
- Mini App показывает ошибку "Не удалось загрузить акции"
- В консоли браузера видна ошибка "Failed to fetch"

**Возможные причины и решения:**

#### 1. Google Apps Script не настроен или недоступен

**Проверка:**
1. Откройте URL Google Apps Script в браузере
2. Должен вернуться JSON массив с акциями

**Решение:**
- Проверьте, что скрипт развернут с доступом "Anyone"
- Обновите развертывание в Google Apps Script
- См. [Настройка Google Apps Script](../guides/GOOGLE_APPS_SCRIPT_SETUP.md)

#### 2. CORS проблема (самая частая причина)

**Симптомы:**
- В консоли браузера видна ошибка "Failed to fetch"
- Google Apps Script возвращает HTML вместо JSON
- Ошибка "TypeError: Failed to fetch" при попытке загрузки

**Причина:**
Google Apps Script блокирует запросы из-за неправильных настроек доступа.

**Решение (пошагово):**

1. **Откройте Google Apps Script:**
   - Перейдите на https://script.google.com
   - Найдите ваш проект с акциями

2. **Проверьте развертывание:**
   - Нажмите "Развернуть" → "Управление развертываниями"
   - Найдите активное развертывание (должно быть с типом "Веб-приложение")

3. **Обновите настройки доступа:**
   - Нажмите на иконку редактирования ✏️ рядом с развертыванием
   - В поле **"У кого есть доступ"** выберите **"Все"** (Anyone)
   - **ВАЖНО:** Это критически важно для работы CORS!

4. **Создайте новую версию:**
   - Нажмите "Новая версия"
   - Нажмите "Развернуть"
   - Скопируйте новый URL (если изменился)

5. **Подождите 1-2 минуты:**
   - Google Apps Script может потребовать время для обновления настроек

6. **Проверьте работу:**
   - Откройте URL развертывания в браузере
   - Должен вернуться JSON, а не HTML страница
   - Если видите HTML - доступ все еще не настроен правильно

**Если не помогло:**
- Удалите старое развертывание
- Создайте новое развертывание с самого начала
- Убедитесь, что выбрали "Все" (Anyone) при создании

#### 3. Нет активных акций в таблице

**Проверка:**
1. Откройте Google Sheets с акциями
2. Убедитесь, что есть строки со статусом "Активна" в колонке D

**Решение:**
- Добавьте акции со статусом "Активна"
- Проверьте, что колонка статуса называется "Статус" или "D"

#### 4. Неправильный формат данных

**Проверка:**
1. Откройте консоль браузера (F12)
2. Посмотрите логи загрузки акций
3. Проверьте формат ответа от Google Apps Script

**Решение:**
- Убедитесь, что Google Apps Script возвращает массив JSON
- Проверьте код функции `doGet()` в Google Apps Script

## Отладка

### Шаг 1: Проверить консоль браузера

1. Откройте Mini App в Telegram
2. Нажмите F12 (DevTools)
3. Перейдите на вкладку Console
4. Посмотрите логи:
   - `Попытка загрузить акции с: ...`
   - `Ответ от ...`
   - Любые ошибки

### Шаг 2: Проверить Google Apps Script URL

Откройте URL в браузере:
```
https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec
```

**Ожидаемый результат:** JSON массив, например:
```json
[
  {
    "id": "test_тест_функции_акции_09.10.2025_11.10.2025",
    "title": "тест",
    "description": "тест функции акции",
    "status": "Активна",
    "start_date": "09.10.2025",
    "end_date": "11.10.2025"
  }
]
```

**Если видите ошибку:**
- Проверьте, что скрипт обновлен в Google Apps Script
- Проверьте логи в Google Apps Script (Выполнения → Журнал выполнения)

### Шаг 3: Проверить таблицу Google Sheets

1. Откройте таблицу "Акции"
2. Убедитесь, что есть строки со статусом "Активна" в колонке D
3. Убедитесь, что заполнены:
   - Название (колонка B)
   - Описание (колонка C)
   - Статус = "Активна" (колонка D)

### Шаг 4: Проверить Google Apps Script

1. Откройте Google Apps Script
2. Убедитесь, что код из `GOOGLE_APPS_SCRIPT_FULL.js` вставлен
3. Сохраните (Ctrl+S)
4. Обновите развертывание:
   - "Развернуть" → "Управление развертываниями"
   - Иконка редактирования ✏️
   - "Новая версия"
   - "Развернуть"

## Известные проблемы

### Ошибка: `TypeError: ContentService.createTextOutput(...).setMimeType(...).setHeader is not a function`

**Причина:** Метод `setHeader()` не существует в Google Apps Script API.

**Решение:**
Удалите все вызовы `.setHeader('Access-Control-Allow-Origin', '*')` из функции `doGet`.

**Исправленный код:**
```javascript
return ContentService
  .createTextOutput(JSON.stringify(result))
  .setMimeType(ContentService.MimeType.JSON);
```

CORS заголовки устанавливаются автоматически при настройке доступа "Anyone" в веб-приложении.

## Быстрое решение

1. Откройте URL Google Apps Script в браузере
2. Если видите JSON - всё работает, проблема в Mini App
3. Если видите ошибку - обновите скрипт в Google Apps Script
4. Проверьте консоль браузера в Mini App (F12)
5. Убедитесь, что доступ "Anyone" установлен в Google Apps Script

## Дополнительная помощь

- [Настройка Google Apps Script](../guides/GOOGLE_APPS_SCRIPT_SETUP.md)
- [Общее руководство по устранению неполадок](TROUBLESHOOTING.md)
