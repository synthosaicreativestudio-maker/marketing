# Настройка Google Apps Script для получения акций

## Обзор

Google Apps Script позволяет создать бесплатный API для получения акций из Google Sheets. Это решение обходит проблему с DNS для Cloudflare Tunnel и работает сразу после настройки.

## Преимущества

- ✅ Работает сразу, без ожидания DNS
- ✅ Официальный инструмент Google - надежность 99.9%
- ✅ Бесплатно без ограничений
- ✅ Данные сразу в JSON формате
- ✅ HTTPS по умолчанию
- ✅ Нет проблем с DNS (script.google.com всегда работает)

## Шаг 1: Открыть Apps Script

1. Откройте вашу Google Таблицу с акциями
2. В меню выберите: **Расширения** → **Apps Script**
3. Откроется редактор Apps Script

## Шаг 2: Вставить код

1. Удалите весь существующий код в редакторе (если есть)
2. Откройте файл `google_apps_script_promotions.js` из проекта
3. Скопируйте весь код
4. Вставьте в редактор Apps Script
5. Сохраните проект: **Ctrl+S** (или **Cmd+S** на Mac) или кнопка "Сохранить"

## Шаг 3: Настроить имя листа (если нужно)

Если ваш лист с акциями называется не "Акции", измените в коде:

```javascript
var sheet = spreadsheet.getSheetByName("Акции"); // Замените "Акции" на имя вашего листа
```

## Шаг 4: Развернуть как веб-приложение

1. Нажмите кнопку **"Развернуть"** (Deploy) в правом верхнем углу
2. Выберите **"Новое развертывание"** (New deployment)
3. Нажмите на иконку шестеренки ⚙️ рядом с "Выберите тип"
4. Выберите **"Веб-приложение"** (Web app)

## Шаг 5: Настроить доступ

1. В поле **"У кого есть доступ"** (Who has access) выберите **"Все"** (Anyone)
   - Это безопасно, так как данные акций публичные
   - Это необходимо для работы из Mini App
2. Нажмите **"Развернуть"** (Deploy)

## Шаг 6: Скопировать URL

1. После развертывания появится окно с URL веб-приложения
2. Скопируйте URL (он будет вида: `https://script.google.com/macros/s/.../exec`)
3. Сохраните этот URL - он понадобится для обновления `menu.html`

## Шаг 7: Протестировать

Откройте скопированный URL в браузере. Вы должны увидеть JSON с активными акциями:

```json
[
  {
    "id": "Акция_1_...",
    "title": "Скидка 20% на все услуги",
    "description": "Специальное предложение",
    "status": "Активна",
    "start_date": "05.10.2025",
    "end_date": "31.10.2025"
  }
]
```

## Шаг 8: Обновить menu.html

1. Откройте файл `menu.html`
2. Найдите переменную `API_BASE_URL`
3. Замените URL на ваш Google Apps Script URL:

```javascript
// Для Google Apps Script используем полный URL
API_BASE_URL = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
```

Или добавьте fallback:

```javascript
const urlsToTry = [
    'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec', // Google Apps Script
    `${API_BASE_URL}/api/promotions`, // Cloudflare Tunnel (fallback)
];
```

## Структура таблицы

Скрипт ожидает следующую структуру таблицы:

| Колонка | Название | Описание |
|---------|----------|----------|
| A | Дата релиза | Дата публикации |
| B | Название | Название акции |
| C | Описание | Подробное описание |
| D | Статус | "Активна", "Ожидает", "Закончена" |
| E | Дата начала | Дата начала акции |
| F | Дата окончания | Дата окончания акции |
| G | Контент | Дополнительный контент (опционально) |

Скрипт автоматически определяет колонки по заголовкам, поддерживая как русские, так и английские названия.

## Обновление кода

Если вы изменили код в Apps Script:

1. Сохраните изменения (Ctrl+S)
2. Нажмите **"Развернуть"** → **"Управление развертываниями"** (Manage deployments)
3. Нажмите на иконку редактирования ✏️ рядом с вашим развертыванием
4. Выберите **"Новая версия"** (New version)
5. Нажмите **"Развернуть"** (Deploy)

**Важно:** URL не изменится, изменения применятся автоматически.

## Отладка

Если что-то не работает:

1. В редакторе Apps Script выберите функцию `testGetPromotions`
2. Нажмите **"Выполнить"** (Run)
3. Откройте **"Журнал выполнения"** (Execution log) для просмотра ошибок

## Безопасность

- URL веб-приложения публичный, но это нормально для публичных данных (акции)
- Скрипт возвращает только акции со статусом "Активна"
- Данные читаются только, не изменяются
- HTTPS включен по умолчанию

## Преимущества перед Cloudflare Tunnel

- ✅ Работает сразу, без ожидания DNS
- ✅ Не зависит от внешних сервисов
- ✅ Бесплатно и без ограничений
- ✅ Проще в настройке
- ✅ Надежность Google инфраструктуры

## Альтернатива: Fallback механизм

Можно использовать оба варианта одновременно:

1. Сначала пробовать Google Apps Script (быстро и надежно)
2. Если не работает - fallback на Cloudflare Tunnel
3. Это обеспечивает максимальную надежность

---

**Версия:** 1.0  
**Дата:** 6 января 2026  
**Статус:** ✅ Готово к использованию
