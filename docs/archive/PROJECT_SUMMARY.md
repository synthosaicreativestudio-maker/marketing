# 📋 Project Summary: Система акций в MarketingBot

## 🎯 Что хочет пользователь

### Основная цель
Отображать **акции из Google Sheets** в **Telegram Mini App (WebApp)**. Пользователь должен открыть Mini App и увидеть список активных акций.

### Требования к системе акций

1. **Управление акциями через Google Sheets**
   - Акции хранятся в таблице "Акции" в Google Sheets
   - Колонки: Дата релиза, Название, Описание, Статус, Дата начала/окончания, Контент
   - Менеджер заполняет данные в таблице и устанавливает статус "Активна"

2. **Отображение акций в Mini App**
   - Акции со статусом "Активна" должны отображаться в личном кабинете (Mini App)
   - Пользователь открывает Mini App (`menu.html`) → видит раздел "Акции и события" → видит список активных акций в виде карточек
   - Акции должны загружаться автоматически при открытии раздела

---

## 🏗️ Как это было реализовано

### Архитектура системы акций

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Mini App       │    │  Yandex Cloud VM │    │  Google Sheets   │
│  (menu.html)    │    │  (89.169.176.108) │    │                 │
│  GitHub Pages   │    │                 │    │  ┌─────────────┐│
│                 │    │  ┌─────────────┐│    │  │  Таблица    ││
│  JavaScript     │───►│  │ Flask API   ││───►│  │  "Акции"    ││
│  fetch()        │    │  │ /api/       ││    │  │             ││
│                 │    │  │ promotions  ││    │  └─────────────┘│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                      │
         │                      │
         │                      ▼
         │              ┌─────────────────┐
         │              │ Cloudflare      │
         │              │ Tunnel          │
         │              │ (API Proxy)     │
         │              └─────────────────┘
         │
         └──────────────► https://marketingbot.trycloudflare.com/api/promotions
```

### Компоненты системы акций

#### 1. **Google Sheets (Источник данных)**
- Таблица "Акции" с колонками:
  - Дата релиза, Название, Описание, Статус, Дата начала/окончания, Контент
- Менеджер заполняет данные и устанавливает статус "Активна"
- Используется Google Service Account для доступа через API

#### 2. **Backend API (Python)**
- **`promotions_api.py`** - читает данные из Google Sheets, фильтрует активные акции, кэширует на 5 минут
- **`api/main.py`** или **`webhook_handler.py`** - Flask приложение с эндпоинтом `/api/promotions`
- Возвращает JSON с активными акциями

#### 3. **Frontend Mini App (JavaScript)**
- **`menu.html`** - личный кабинет с разделом "Акции и события"
- JavaScript делает `fetch()` запрос к `/api/promotions`
- Отображает акции в виде карточек с названием, описанием, датами

#### 4. **Инфраструктура**
- **Yandex Cloud VM** (89.169.176.108) - сервер для API
- **Cloudflare Tunnel** - туннель для публичного доступа к API
- **GitHub Pages** - хостинг для Mini App

### Поток работы с акциями

#### Как это должно работать:

1. **Менеджер добавляет акцию в Google Sheets:**
   - Открывает таблицу "Акции"
   - Заполняет: Название, Описание, Дата начала/окончания
   - Устанавливает статус "Активна"

2. **Бот получает данные:**
   - `promotions_api.py` читает данные из Google Sheets через API
   - Фильтрует акции со статусом "Активна"
   - Кэширует на 5 минут для оптимизации

3. **API предоставляет данные:**
   - Flask API на `/api/promotions` возвращает JSON с акциями
   - API работает на `http://localhost:8080` на сервере
   - Cloudflare Tunnel проксирует запросы на `https://marketingbot.trycloudflare.com/api/promotions`

4. **Mini App загружает акции:**
   - Пользователь открывает Mini App (`menu.html`)
   - JavaScript делает `fetch()` запрос к `/api/promotions`
   - Отображает акции в виде карточек

### Технические детали реализации

#### Поток получения акций:
```
1. Пользователь открывает Mini App (menu.html)
2. JavaScript делает fetch() запрос к /api/promotions
3. Запрос идет через Cloudflare Tunnel на https://marketingbot.trycloudflare.com/api/promotions
4. Cloudflare Tunnel проксирует на Yandex VM (localhost:8080)
5. Flask API вызывает promotions_api.py
6. promotions_api.py читает данные из Google Sheets через gspread
7. Фильтрует акции со статусом "Активна"
8. Возвращает JSON с акциями
9. Mini App отображает акции в виде карточек
```

#### Используемые технологии:
- **Python 3.x** - для API сервера
- **Flask** - веб-фреймворк для REST API
- **gspread** - библиотека для Google Sheets API
- **Google Service Account** - для доступа к Google Sheets
- **Cloudflare Tunnel (cloudflared)** - туннель для публичного доступа к API
- **JavaScript (Vanilla)** - для Mini App
- **GitHub Pages** - хостинг для Mini App

---

## ⚠️ Проблематика

### Основные проблемы, с которыми столкнулись

#### 1. **DNS не разрешается для Cloudflare Tunnel** ❌

**Проблема:**
- Создан маршрут `marketingbot.trycloudflare.com` в Cloudflare Dashboard
- Туннель работает и подключен (4 соединения)
- Локальный API доступен на `http://localhost:8080/api/promotions`
- Но DNS для `marketingbot.trycloudflare.com` не разрешается (NXDOMAIN)

**Проверки:**
```bash
nslookup marketingbot.trycloudflare.com 8.8.8.8
# Server can't find marketingbot.trycloudflare.com: NXDOMAIN
```

**Причины:**
- Домен `trycloudflare.com` - динамический домен Cloudflare для тестирования
- DNS может распространяться до 30-60 минут после создания маршрута
- Возможно, маршрут не полностью активирован в Dashboard

**Решение:**
- Пересоздать маршрут в Cloudflare Dashboard
- Подождать 30-60 минут для распространения DNS
- Использовать свой домен вместо `trycloudflare.com` (если доступен)

#### 2. **Акции не загружаются в Mini App** ⚠️

**Проблема:**
- В Google Sheets есть 3 активные акции со статусом "Активна"
- Локальный API возвращает правильные данные (`curl http://localhost:8080/api/promotions`)
- Но Mini App показывает "Failed to load promotions"

**Причины:**
- Mini App не может достучаться до API из-за DNS проблемы
- `menu.html` пытается загрузить данные с `https://marketingbot.trycloudflare.com/api/promotions`
- Но домен не разрешается, поэтому запрос не проходит

**Решение:**
- После решения DNS проблемы акции должны загрузиться автоматически
- Добавлены fallback механизмы в `menu.html` для обработки ошибок
- Улучшено логирование для диагностики

#### 3. **Кэширование и производительность** ✅ (Оптимизировано)

**Проблема:**
- Частые запросы к Google Sheets API могут привести к лимитам
- Медленная загрузка данных

**Решение:**
- Добавлено кэширование на 5 минут в `promotions_api.py`
- Оптимизированы запросы к Google Sheets

### Текущий статус компонентов системы акций

| Компонент | Статус | Детали |
|-----------|--------|--------|
| Google Sheets (таблица "Акции") | ✅ 100% | 3 активные акции, данные корректны |
| Backend API (promotions_api.py) | ✅ 100% | Читает данные из Google Sheets корректно |
| Локальный API (/api/promotions) | ✅ 100% | Возвращает 3 акции, HTTP 200 OK |
| Cloudflare Tunnel | ✅ 100% | 4 соединения, конфигурация правильная |
| Маршрут в Dashboard | ✅ 100% | Настроен правильно |
| DNS Resolution | ❌ 0% | NXDOMAIN - не разрешается |
| Mini App (код menu.html) | ✅ 100% | Код работает правильно, обработка ошибок добавлена |
| Mini App (загрузка данных) | ⚠️ 50% | Код работает, но не может загрузить из-за DNS |

### Что работает на 100%

1. ✅ **Google Sheets** - таблица "Акции" содержит 3 активные акции
2. ✅ **Backend API** - `promotions_api.py` читает данные корректно, кэширует на 5 минут
3. ✅ **Локальный API** - `http://localhost:8080/api/promotions` возвращает правильные данные
4. ✅ **Cloudflare Tunnel** - настроен и подключен, туннель работает
5. ✅ **Mini App код** - `menu.html` правильно написан, обработка ошибок добавлена

### Что не работает

1. ❌ **DNS для `marketingbot.trycloudflare.com`** - не разрешается (NXDOMAIN)
2. ⚠️ **Загрузка акций в Mini App** - не работает из-за DNS проблемы (Mini App не может достучаться до API)

### Следующие шаги

1. **Пересоздать маршрут в Cloudflare Dashboard:**
   - Удалить старый маршрут `marketingbot.trycloudflare.com`
   - Создать новый с теми же параметрами
   - Подождать 10-15 минут

2. **Проверить DNS:**
   ```bash
   nslookup marketingbot.trycloudflare.com 8.8.8.8
   ```

3. **Когда DNS разрешится:**
   - Проверить API: `curl https://marketingbot.trycloudflare.com/api/promotions`
   - Открыть Mini App и проверить загрузку акций

4. **Альтернатива:**
   - Использовать свой домен в Cloudflare вместо `trycloudflare.com`
   - Обновить `menu.html` с новым URL

---

## 📊 Итоговая сводка

### Что было сделано:
- ✅ Настроена интеграция с Google Sheets для чтения акций
- ✅ Создан API эндпоинт `/api/promotions` для получения акций
- ✅ Реализован раздел "Акции и события" в Mini App (`menu.html`)
- ✅ Добавлено кэширование на 5 минут для оптимизации
- ✅ Настроен Cloudflare Tunnel для публичного доступа к API
- ✅ Добавлена обработка ошибок в Mini App

### Что осталось решить:
- ❌ DNS проблема для Cloudflare Tunnel домена (`marketingbot.trycloudflare.com`)
- ⚠️ Загрузка акций в Mini App (зависит от DNS)

### Ожидаемый результат:
После решения DNS проблемы:
- ✅ Mini App сможет загрузить акции из API
- ✅ Пользователи увидят 3 активные акции в разделе "Акции и события"
- ✅ Система акций будет работать полностью

---

**Версия:** 1.0  
**Дата:** 6 января 2026  
**Статус:** 🟡 В процессе (ожидание DNS)

