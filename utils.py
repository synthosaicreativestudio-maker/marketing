import os
import logging
import re
from urllib.parse import urlparse
from telegram import InlineKeyboardButton, InlineKeyboardMarkup, MenuButtonDefault

logger = logging.getLogger(__name__)


async def alert_admin(bot, message: str, level: str = "ERROR") -> bool:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –≤ Telegram.
    
    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞
        message: –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        level: –£—Ä–æ–≤–µ–Ω—å (ERROR, CRITICAL, WARNING)
    
    Returns:
        True –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, False –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
    """
    admin_id = os.getenv("ADMIN_TELEGRAM_ID")
    if not admin_id:
        logger.warning("ADMIN_TELEGRAM_ID –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –∞–ª–µ—Ä—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
        return False
    
    emoji = {"ERROR": "‚ö†Ô∏è", "CRITICAL": "üö®", "WARNING": "‚ö°"}.get(level, "‚ÑπÔ∏è")
    
    try:
        await bot.send_message(
            chat_id=admin_id,
            text=f"{emoji} {level}\n\n{message}"
        )
        logger.info(f"–ê–ª–µ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω—É: {message[:50]}...")
        return True
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–ª–µ—Ä—Ç –∞–¥–º–∏–Ω—É: {e}")
        return False


def sanitize_ai_text(text: str, ensure_emojis: bool = True) -> str:
    """–û—á–∏—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –æ—Ç Markdown/—Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∏ –ø—Ä–∏–≤–æ–¥–∏—Ç —Å—Å—ã–ª–∫–∏ –∫ –≤–∏–¥—É '–ù–∞–∑–≤–∞–Ω–∏–µ ‚Äî URL'."""
    if not text:
        return text

    # –°–Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º Markdown –≤ HTML —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    text = _markdown_to_telegram_html(text)
    
    # –ó–∞—Ç–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ò–ò –º–æ–≥ –ø—Ä–∏—Å–ª–∞—Ç—å "–≥–æ–ª—ã–º–∏"
    text = _format_links_safe(text)

    return text


def sanitize_ai_text_plain(text: str, ensure_emojis: bool = True) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —á–∏—Å—Ç—ã–π plain-text –±–µ–∑ Markdown/HTML, —Å—Å—ã–ª–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ '–ù–∞–∑–≤–∞–Ω–∏–µ: URL'."""
    if not text:
        return text

    # Remove HTML tags if any
    text = re.sub(r"<[^>]+>", "", text)

    # Convert markdown links to "Text: URL"
    text = re.sub(r'\[([^\]]+)\]\((https?://[^\s)]+)\)', r'\1: \2', text)

    # –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ –û–¢–ö–õ–Æ–ß–ï–ù–û, —á—Ç–æ–±—ã –±–æ—Ç –º–æ–≥ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—É
    # text = re.sub(r'(?i)\b—Å–æ–≥–ª–∞—Å–Ω–æ (?:–Ω–∞—à–µ–π )?–±–∞–∑–µ –∑–Ω–∞–Ω–∏–π[^.]*\.\s*', '', text)

    # Strip markdown formatting markers
    text = text.replace("```", "")
    text = text.replace("`", "")
    text = text.replace("**", "")
    text = text.replace("__", "")
    text = re.sub(r'(?m)^#{1,6}\s*', '', text)
    text = re.sub(r'(?m)^\s*[\-\*\+]\s+', '', text)

    text = _normalize_whitespace(text)
    return text

def safe_truncate_html(text: str, limit: int = 3900) -> str:
    """
    –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–µ–∑–∞–µ—Ç HTML-—Å—Ç—Ä–æ–∫—É –¥–ª—è Telegram, –Ω–µ —Ä–∞–∑—Ä—ã–≤–∞—è —Ç–µ–≥–∏ <... >.
    –ï—Å–ª–∏ —Ä–∞–∑—Ä–µ–∑ –ø–æ–ø–∞–¥–∞–µ—Ç –≤–Ω—É—Ç—Ä—å —Ç–µ–≥–∞, –æ–±—Ä–µ–∑–∞–µ—Ç –¥–æ –Ω–∞—á–∞–ª–∞ —ç—Ç–æ–≥–æ —Ç–µ–≥–∞.
    """
    if len(text) <= limit:
        return text
    
    # –û–±—Ä–µ–∑–∞–µ–º –ø–æ –ª–∏–º–∏—Ç—É
    truncated = text[:limit]
    
    # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ '<'
    last_open_bracket = truncated.rfind('<')
    if last_open_bracket != -1:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫—Ä—ã—Ç –ª–∏ —ç—Ç–æ—Ç —Ç–µ–≥ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–µ–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        if '>' not in truncated[last_open_bracket:]:
            # –¢–µ–≥ –Ω–µ –∑–∞–∫—Ä—ã—Ç, –æ–±—Ä–µ–∑–∞–µ–º –î–û '<'
            return truncated[:last_open_bracket]
            
    return truncated


def _markdown_to_telegram_html(text: str) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç Markdown-—Ä–∞–∑–º–µ—Ç–∫—É Gemini –≤ HTML –¥–ª—è Telegram —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""
    if not text:
        return ""
    
    # 0. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã HTML
    text = text.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;')

    # 1. –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç: **text** -> <b>text</b>
    text = re.sub(r'\*\*(.*?)\*\*', r'<b>\1</b>', text)
    text = re.sub(r'__(.*?)__', r'<b>\1</b>', text)
    
    # 2. –ö—É—Ä—Å–∏–≤: *text* -> <i>text</i>
    text = re.sub(r'(?<!\*)\*(?!\*)(.*?)(?<!\*)\*(?!\*)', r'<i>\1</i>', text)
    
    # 3. –°—Å—ã–ª–∫–∏: [Text](URL) -> <a href="URL">Text</a>
    # Telegram —Ç—Ä–µ–±—É–µ—Ç 'href="URL"', –ø—Ä–∏—á–µ–º URL —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç &amp; –ø–æ—Å–ª–µ —à–∞–≥–∞ 0.
    text = re.sub(r'\[([^&\]]+)\]\((https?://[^\s)]+)\)', r'<a href="\2">\1</a>', text)
    
    # 4. –ó–∞–≥–æ–ª–æ–≤–∫–∏: ### Header -> <b>Header</b>
    text = re.sub(r'^#{1,6}\s+(.*)$', r'<b>\1</b>', text, flags=re.MULTILINE)
    
    return text

def _format_links_safe(text: str) -> str:
    """–ë–µ–∑–æ–ø–∞—Å–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –≥–æ–ª—ã–µ URL, –Ω–µ –ª–æ–º–∞—è —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ <a> —Ç–µ–≥–∏."""
    # –†–µ–≥—É–ª—è—Ä–∫–∞ –¥–ª—è URL, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï –≤–Ω—É—Ç—Ä–∏ href="..."
    url_re = re.compile(r'(?<!href=")(https?://[^\s\)\]\}>]+)')
    
    def repl(match):
        url = match.group(1)
        # –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å—Ç—ã–π URL –≤ —Ç–µ–∫—Å—Ç–µ, –ø—Ä–µ–≤—Ä–∞—Ç–∏–º –µ–≥–æ –≤ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É "–ò—Å—Ç–æ—á–Ω–∏–∫"
        # –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –≤ HTML Telegram –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–Ω—É—Ç—Ä–∏ <a> –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –∞–Ω–∫–æ—Ä.
        # –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç–æ –æ–±–µ—Ä–Ω–µ–º –µ–≥–æ –≤ <a> –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if len(url) < 100:
            return f'<a href="{url}">—Å—Å—ã–ª–∫–∞</a>'
        return url

    return url_re.sub(repl, text)


def _convert_markdown_links(text: str) -> str:
    # [–¢–µ–∫—Å—Ç](https://example.com) -> –¢–µ–∫—Å—Ç ‚Äî https://example.com
    return re.sub(r'\[([^\]]+)\]\((https?://[^\s)]+)\)', r'\1 ‚Äî \2', text)


def _format_links(text: str) -> str:
    url_re = re.compile(r'https?://[^\s\)\]\}>]+')
    lines = text.splitlines()
    out_lines = []

    for line in lines:
        stripped = line.strip()
        if not stripped:
            out_lines.append(line)
            continue

        urls = url_re.findall(stripped)
        if not urls:
            out_lines.append(line)
            continue

        # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∞(–∏)
        if stripped in urls or stripped.rstrip(".,;") in urls:
            if len(urls) == 1:
                out_lines.append(f"–°—Å—ã–ª–∫–∞ ‚Äî {urls[0]}")
            else:
                for u in urls:
                    out_lines.append(f"–°—Å—ã–ª–∫–∞ ‚Äî {u}")
            continue

        # –ò–Ω–∞—á–µ –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É –∏ –¥–µ–ª–∞–µ–º "–¢–µ–∫—Å—Ç ‚Äî URL"
        url = urls[0]
        label = stripped.replace(url, "").strip()
        label = re.sub(r'[:‚Äî‚Äì-]+$', '', label).strip()
        if not label:
            label = "–°—Å—ã–ª–∫–∞"
        out_lines.append(f"{label} ‚Äî {url}")

    return "\n".join(out_lines)


def _strip_markdown(text: str) -> str:
    # –£–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç —Å–ª–æ–º–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã 
    # (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∂–∏—Ä–Ω—ã–π, –∫—É—Ä—Å–∏–≤ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¢–µ–ª–µ–≥—Ä–∞–º–∞)
    text = text.replace("```", "")
    text = text.replace("`", "")
    return text


def _normalize_whitespace(text: str) -> str:
    lines = []
    for line in text.splitlines():
        line = re.sub(r"[ \t]+", " ", line).strip()
        lines.append(line)
    return "\n".join(lines).strip()


def _ensure_emojis(text: str) -> str:
    """–û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å. –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–º–æ–¥–∑–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ –ø—Ä–æ–º–ø—Ç."""
    return text


def mask_phone(phone: str) -> str:
    """–ú–∞—Å–∫–∏—Ä—É–µ—Ç –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞: 89123456789 -> 8*******89."""
    if not phone or not str(phone).strip():
        return "****"
    s = str(phone).strip()
    if len(s) < 4:
        return "****"
    return s[:1] + "*" * (len(s) - 3) + s[-2:]


def mask_telegram_id(tid) -> str:
    """–ú–∞—Å–∫–∏—Ä—É–µ—Ç Telegram ID: 123456789 -> 123***789."""
    if tid is None:
        return "***"
    s = str(tid)
    if len(s) < 6:
        return "***"
    return s[:3] + "***" + s[-3:]


def mask_fio(fio: str) -> str:
    """–ú–∞—Å–∫–∏—Ä—É–µ—Ç –§–ò–û: –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á -> –ò***–≤ –ò***–Ω –ò***—á."""
    if not fio or not str(fio).strip():
        return "***"
    parts = str(fio).strip().split()
    masked = []
    for part in parts:
        if len(part) < 3:
            masked.append("***")
        else:
            masked.append(part[0] + "*" * (len(part) - 2) + part[-1])
    return " ".join(masked)


def _validate_url(url: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∞–ª–∏–¥–Ω—ã–º URL."""
    if not url:
        return False
    try:
        result = urlparse(url)
        return all([result.scheme, result.netloc])
    except Exception:
        return False

def get_web_app_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL WebApp –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ .env)."""
    base_url = os.getenv("WEB_APP_URL") or ""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = base_url + "index.html"
    logger.debug(f"Generated WebApp URL: {url}")
    return url

def get_spa_menu_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL SPA –º–µ–Ω—é –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    base_url = os.getenv("WEB_APP_URL") or ""
    # –í–µ—Ä—Å–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞ WebApp
    cache_bust = "v=20260107-4"
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = f"{base_url}menu.html?{cache_bust}"
    logger.debug(f"Generated SPA Menu URL: {url}")
    return url

def create_specialist_button() -> InlineKeyboardMarkup:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    keyboard = [[InlineKeyboardButton("üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", callback_data="contact_specialist")]]
    return InlineKeyboardMarkup(keyboard)

def _is_user_escalation_request(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
    """
    import re
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: —É–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    text_normalized = re.sub(r'[^\w\s]', '', text.lower())
    
    # –ü—Ä—è–º—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (30 —Ñ—Ä–∞–∑)
    escalation_phrases = [
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Ö–æ—á—É –∫ —á–µ–ª–æ–≤–µ–∫—É',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫',
        '—Ä–µ–∞–ª—å–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–¥–∞–π—Ç–µ –º–Ω–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫',
        '—Ö–æ—á—É –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–Ω—É–∂–µ–Ω –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
        '—Ö–æ—á—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–¥–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–π –≤–æ–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ—é –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–¥–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    for phrase in escalation_phrases:
        if phrase in text_normalized:
            return True
    
    return False

def _is_ai_asking_for_escalation(ai_response: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ò–ò –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    if not ai_response:
        return False
        
    response_lower = ai_response.lower()
    
    # –§—Ä–∞–∑—ã, –∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    escalation_questions = [
        '–Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º',
        # –§—Ä–∞–∑—ã –∏–∑ system_prompt.txt (—Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ò–ò)
        '–ø–µ—Ä–µ–¥–∞–º –≤–∞—à—É –∑–∞–¥–∞—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–ø–µ—Ä–µ–¥–∞–º –∑–∞–¥–∞—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–ø–µ—Ä–µ–¥–∞–º –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–ø–µ—Ä–µ–¥–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞–º –µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–∑–∞—Ñ–∏–∫—Å–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å –∏ –ø–µ—Ä–µ–¥–∞–º',
        '—Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏',
        '–æ–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏',
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    for phrase in escalation_questions:
        if phrase in response_lower:
            return True
    
    return False

def _is_escalation_confirmation(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    text_lower = text.lower()
    
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    confirmation_phrases = [
        '–¥–∞',
        '–¥–∞, –Ω—É–∂–Ω–æ',
        '–¥–∞, –ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '–¥–∞, —Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '–¥–∞, —Å–≤—è–∂–∏—Ç–µ',
        '–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–¥–∞, –∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞, –¥–∞–≤–∞–π—Ç–µ',
        '–¥–∞, —Ö–æ—Ä–æ—à–æ',
        '–¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω',
        '–Ω—É–∂–Ω–æ',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '—Å–≤—è–∂–∏—Ç–µ',
        '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞–≤–∞–π—Ç–µ',
        '—Ö–æ—Ä–æ—à–æ',
        '—Å–æ–≥–ª–∞—Å–µ–Ω',
        '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—Ä–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    for phrase in confirmation_phrases:
        if phrase in text_lower:
            return True
    
    return False

def _should_show_specialist_button(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å –µ–≥–æ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º/–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
    """
    text_lower = text.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
    specialist_keywords = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–º—É —á–µ–ª–æ–≤–µ–∫—É', '–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–º–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞', '–º–µ–Ω–µ–¥–∂–µ—Ä—É', '–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º',
        '–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä—É', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
        '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å', '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ', '—Å–æ–µ–¥–∏–Ω–∏', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
        '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '—á–µ–ª–æ–≤–µ–∫', '—á–µ–ª–æ–≤–µ–∫–∞', '—á–µ–ª–æ–≤–µ–∫—É', '—á–µ–ª–æ–≤–µ–∫–æ–º',
        '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç–µ', '–∑–≤–æ–Ω–æ–∫', '–∑–≤–æ–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '—Å–≤—è–∑–∞—Ç—å—Å—è —Å', '—Å–≤—è–∑–∞—Ç—å', '—Å–≤—è–∑–∞—Ç—å —Å',
        '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '–ø–æ–¥–¥–µ—Ä–∂–∫—É', '–ø–æ–¥–¥–µ—Ä–∂–∫–µ', '–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',
        '–ø–æ–º–æ—â—å', '–ø–æ–º–æ—â–∏', '–ø–æ–º–æ—á—å', '–ø–æ–º–æ—â—å—é',
        '–Ω–µ –º–æ–≥—É', '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
        '–ø—Ä–æ–±–ª–µ–º–∞', '–ø—Ä–æ–±–ª–µ–º—ã', '–ø—Ä–æ–±–ª–µ–º—É', '–ø—Ä–æ–±–ª–µ–º–æ–π',
        '—Å–ª–æ–∂–Ω–æ', '—Å–ª–æ–∂–Ω—ã–π', '—Å–ª–æ–∂–Ω–∞—è', '—Å–ª–æ–∂–Ω–æ–µ',
        '–Ω–µ –ø–æ–Ω–∏–º–∞—é', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ', '–Ω–µ —è—Å–Ω–æ',
        '–æ–±—ä—è—Å–Ω–∏—Ç–µ', '–æ–±—ä—è—Å–Ω–∏', '–æ–±—ä—è—Å–Ω–∏—Ç—å',
        '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–ø–æ–¥—Ä–æ–±–Ω–æ', '–ø–æ–¥—Ä–æ–±–Ω—ã–π',
        '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '–¥–µ—Ç–∞–ª—å–Ω–æ'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for keyword in specialist_keywords:
        if keyword in text_lower:
            return True
    
    return False

async def set_dynamic_menu_button(bot, chat_id: int, is_authorized: bool = False):
    """
    –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∫–Ω–æ–ø–∫—É –º–µ–Ω—é (Menu Button) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
    –ú—ã –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ReplyKeyboardMarkup –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π.
    """
    try:
        await bot.set_chat_menu_button(
            chat_id=chat_id,
            menu_button=MenuButtonDefault()
        )
        logger.debug(f"Menu button reset to default for {chat_id}")
    except Exception as e:
        logger.error(f"Failed to reset menu button for {chat_id}: {e}")
