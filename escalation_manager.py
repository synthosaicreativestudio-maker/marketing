"""
–°–∏—Å—Ç–µ–º–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ (–æ–¥–Ω–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è).

–õ–æ–≥–∏–∫–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞/—á–µ–ª–æ–≤–µ–∫–∞ ‚Üí —Å—Ä–∞–∑—É –∫–Ω–æ–ø–∫–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è keyword-–º–∞—Ç—á–∏–Ω–≥ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è.
"""
import re


# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –∑–∞–ø—Ä–æ—Å —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
# –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –û–°–ù–û–í–´ –°–õ–û–í (—Å—Ç–µ–º—ã) –¥–ª—è –ø–æ–∫—Ä—ã—Ç–∏—è –≤—Å–µ—Ö —Å–ª–æ–≤–æ—Ñ–æ—Ä–º.
_ESCALATION_STEMS = [
    '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',   # —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º...
    '–º–µ–Ω–µ–¥–∂–µ—Ä',     # –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä—É...
    '–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',   # –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞, –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥—É...
    '–æ–ø–µ—Ä–∞—Ç–æ—Ä',     # –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –æ–ø–µ—Ä–∞—Ç–æ—Ä—É...
    '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç',  # –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞, –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É...
]

# –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã/—Å–ª–æ–≤–∞, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
_ACTION_STEMS = [
    '—Å–æ–µ–¥–∏–Ω',       # —Å–æ–µ–¥–∏–Ω–∏, —Å–æ–µ–¥–∏–Ω–∏—Ç–µ, —Å–æ–µ–¥–∏–Ω–∏—Ç—å
    '—Å–≤—è–∂',         # —Å–≤—è–∂–∏, —Å–≤—è–∂–∏—Ç–µ, —Å–≤—è–∑–∞—Ç—å, —Å–≤—è–∑–∞—Ç—å—Å—è
    '–ø–µ—Ä–µ–≤–µ–¥',      # –ø–µ—Ä–µ–≤–µ–¥–∏, –ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ
    '–ø–µ—Ä–µ–¥–∞–π',      # –ø–µ—Ä–µ–¥–∞–π—Ç–µ
    '–ø–µ—Ä–µ–¥–∞',       # –ø–µ—Ä–µ–¥–∞—Ç—å, –ø–µ—Ä–µ–¥–∞–π—Ç–µ
    '–ø–æ–∑–æ–≤',        # –ø–æ–∑–æ–≤–∏, –ø–æ–∑–æ–≤–∏—Ç–µ
    '–≤—ã–∑–æ–≤',        # –≤—ã–∑–æ–≤–∏, –≤—ã–∑–æ–≤–∏—Ç–µ
]

# –§—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –°–ê–ú–ò –ü–û –°–ï–ë–ï –æ–∑–Ω–∞—á–∞—é—Ç —ç—Å–∫–∞–ª–∞—Ü–∏—é (–±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).
_STANDALONE_TRIGGERS = [
    '–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫',
    '—Ö–æ—á—É –∫ —á–µ–ª–æ–≤–µ–∫—É',
    '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫',
    '—Ä–µ–∞–ª—å–Ω—ã–π —á–µ–ª–æ–≤–µ–∫',
    '—Å —á–µ–ª–æ–≤–µ–∫–æ–º',
    '–¥–∞–π —á–µ–ª–æ–≤–µ–∫',
    '–¥–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫',
    '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
    '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
    '–¥–∞–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
    '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
    '–Ω—É–∂–µ–Ω –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
    '—Ö–æ—á—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
    '–¥–∞–π –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
    '–Ω–µ —Ö–æ—á—É —Å –±–æ—Ç–æ–º',
    '–Ω–µ —Ö–æ—á—É —Å —Ä–æ–±–æ—Ç–æ–º',
    '–Ω–∞–¥–æ–µ–ª –±–æ—Ç',
    '–Ω–∞–¥–æ–µ–ª —Ä–æ–±–æ—Ç',
]

# –û–¥–∏–Ω–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ‚Äî –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –¢–û–õ–¨–ö–û —ç—Ç–æ —Å–ª–æ–≤–æ.
_SINGLE_WORD_TRIGGERS = [
    '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
    '—Å–æ–µ–¥–∏–Ω–∏',
    '—Å–≤—è–∂–∏—Ç–µ',
    '–ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ',
    '–ø–µ—Ä–µ–≤–µ–¥–∏',
]


def is_escalation_request(text: str) -> bool:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–º —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.

    –°—Ç—Ä–∞—Ç–µ–≥–∏—è:
    1. –û–¥–∏–Ω–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ('—Å–æ–µ–¥–∏–Ω–∏—Ç–µ', '–ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ')
    2. Standalone-—Ñ—Ä–∞–∑—ã ('–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫')
    3. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: action_stem + escalation_stem ('—Å–æ–µ–¥–∏–Ω–∏ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º')
    4. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: action_stem + '—á–µ–ª–æ–≤–µ–∫' ('–¥–∞–π —á–µ–ª–æ–≤–µ–∫–∞', '—Å–≤—è–∂–∏ —Å —á–µ–ª–æ–≤–µ–∫–æ–º')

    Args:
        text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    Returns:
        True –µ—Å–ª–∏ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    """
    if not text:
        return False

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º: –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä, —É–±–∏—Ä–∞–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é
    text_clean = re.sub(r'[^\w\s]', '', text.lower().strip())
    words = text_clean.split()

    # 1. –û–¥–∏–Ω–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (1-2 —Å–ª–æ–≤–∞)
    if len(words) <= 2:
        for trigger in _SINGLE_WORD_TRIGGERS:
            if trigger in text_clean:
                return True

    # 2. Standalone-—Ñ—Ä–∞–∑—ã (–ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–µ–º—ã)
    for trigger in _STANDALONE_TRIGGERS:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–ª–æ–≤–∞-—Å—Ç–µ–º—ã –∏–∑ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
        trigger_parts = trigger.split()
        if all(any(stem in word for word in words) for stem in trigger_parts):
            return True

    # 3. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: action + —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç/–º–µ–Ω–µ–¥–∂–µ—Ä/–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥
    has_action = any(stem in text_clean for stem in _ACTION_STEMS)
    has_target = any(stem in text_clean for stem in _ESCALATION_STEMS)

    if has_action and has_target:
        return True

    # 4. –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: action + —á–µ–ª–æ–≤–µ–∫
    has_human = '—á–µ–ª–æ–≤–µ–∫' in text_clean or '—á–µ–ª–æ–≤–µ–∫–æ–º' in text_clean
    if has_action and has_human:
        return True

    return False


def get_escalation_message() -> str:
    """–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å –∫–Ω–æ–ø–∫–æ–π."""
    return (
        "–ü–µ—Ä–µ–¥–∞—é –≤–∞—à –∑–∞–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞, "
        "–æ–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. ü§ù"
    )
