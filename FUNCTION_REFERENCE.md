# Справочник по функциям и модулям

Этот документ предоставляет техническое и текстовое описание каждого компонента проекта.

## 1. `bot.py`

*   **Текстовое описание:**
    Это главный файл проекта, точка входа. Он отвечает за инициализацию всех сервисов (подключение к Google Sheets, сервис авторизации), настройку и запуск самого бота.
*   **Техническое описание:**
    *   `main()`: Основная функция. Загружает переменные окружения из `.env`. Последовательно инициализирует `GoogleSheetsService` и `AuthService`. Если инициализация проходит успешно, создает экземпляр `Application` от `python-telegram-bot`, регистрирует обработчики из `handlers.py` и запускает бота в режиме `polling`.

## 2. `google_sheets_service.py`

*   **Текстовое описание:**
    Модуль-обертка для работы с Google Sheets API. Его задача — предоставить простой интерфейс для подключения к таблицам по URL. Он абстрагирует детали аутентификации и авторизации.
*   **Техническое описание:**
    *   `GoogleSheetsService`: Класс, который при инициализации (`__init__`) считывает `credentials.json`, аутентифицируется в Google API и создает клиент `gspread`.
    *   `get_sheet_by_url(sheet_url)`: Метод, который принимает URL таблицы, открывает ее с помощью клиента `gspread` и возвращает объект листа для дальнейшей работы.

## 3. `auth_service.py`

*   **Текстовое описание:**
    Сервис, реализующий конкретную бизнес-логику авторизации. Он использует `GoogleSheetsService` для доступа к таблице и содержит методы для проверки и обновления данных пользователей.
*   **Техническое описание:**
    *   `AuthService`: Класс, который при инициализации получает экземпляр `GoogleSheetsService` и URL таблицы авторизации из `.env`.
    *   `find_and_update_user(...)`: Ищет в таблице строку, совпадающую по коду партнера и телефону. Если находит, обновляет в этой строке колонки статуса, Telegram ID и даты. Возвращает `True` или `False`.
    *   `get_user_auth_status(...)`: Проверяет, есть ли пользователь с указанным `telegram_id` в таблице и имеет ли он статус "Авторизован". Используется для быстрой проверки без повторного запроса данных.

## 4. `handlers.py`

*   **Текстовое описание:**
    Модуль, который связывает логику бота с командами и действиями пользователя в Telegram. Он определяет, какая функция будет вызвана на команду `/start` или на получение данных из Mini App.
*   **Техническое описание:**
    *   `setup_handlers(...)`: Функция, которая регистрирует все обработчики в приложении `python-telegram-bot`.
    *   `start_command_handler(...)`: Фабрика, создающая обработчик для команды `/start`. Она проверяет статус авторизации пользователя и в зависимости от результата либо показывает кнопку "Авторизоваться", либо приветствует уже авторизованного пользователя.
    *   `web_app_data_handler(...)`: Фабрика, создающая обработчик для данных, пришедших из Mini App. Она парсит полученный JSON, вызывает `AuthService` для проверки данных и отправляет пользователю результат.

## 5. `index.html`

*   **Текстовое описание:**
    Это фронтенд-часть авторизации. Простая веб-страница (Mini App) с двумя полями для ввода и кнопкой. Она разработана для открытия внутри Telegram.
*   **Техническое описание:**
    *   Содержит HTML-форму с полями "Код партнера" и "Телефон партнера".
    *   JavaScript-код использует `window.Telegram.WebApp` API.
    *   При отправке формы данные из полей собираются, валидируются (на предмет заполненности и формата), упаковываются в JSON и отправляются боту с помощью `tg.sendData()`.