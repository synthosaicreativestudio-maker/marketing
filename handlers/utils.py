import os
import logging
from urllib.parse import urlparse
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

logger = logging.getLogger(__name__)

def _validate_url(url: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∞–ª–∏–¥–Ω—ã–º URL."""
    if not url:
        return False
    try:
        result = urlparse(url)
        return all([result.scheme, result.netloc])
    except Exception:
        return False

def get_web_app_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL WebApp –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ .env)."""
    base_url = os.getenv("WEB_APP_URL") or ""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = base_url + "index.html"
    logger.debug(f"Generated WebApp URL: {url}")
    return url

def get_spa_menu_url() -> str:
    """–õ–µ–Ω–∏–≤–æ–µ —á—Ç–µ–Ω–∏–µ URL SPA –º–µ–Ω—é –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    base_url = os.getenv("WEB_APP_URL") or ""
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    if base_url and not _validate_url(base_url):
        logger.error(f"WEB_APP_URL —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π URL: {base_url}")
        return ""
    
    if base_url and not base_url.endswith('/'):
        base_url += '/'
    url = base_url + "menu.html"
    logger.debug(f"Generated SPA Menu URL: {url}")
    return url

def create_specialist_button() -> InlineKeyboardMarkup:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    keyboard = [[InlineKeyboardButton("üë®‚Äçüíº –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É", callback_data="contact_specialist")]]
    return InlineKeyboardMarkup(keyboard)

def _is_user_escalation_request(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏.
    """
    import re
    
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–∫—Å—Ç: —É–±–∏—Ä–∞–µ–º –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    text_normalized = re.sub(r'[^\w\s]', '', text.lower())
    
    # –ü—Ä—è–º—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (30 —Ñ—Ä–∞–∑)
    escalation_phrases = [
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ —Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Ö–æ—á—É –∫ —á–µ–ª–æ–≤–µ–∫—É',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫',
        '—Ä–µ–∞–ª—å–Ω—ã–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç',
        '–¥–∞–π—Ç–µ –º–Ω–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞',
        '–Ω—É–∂–µ–Ω —á–µ–ª–æ–≤–µ–∫',
        '—Ö–æ—á—É –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '–Ω—É–∂–µ–Ω –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥',
        '—Ö–æ—á—É –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–¥–∞–π—Ç–µ –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∞',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É',
        '–Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '—Ö–æ—á—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–¥–∞–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ –æ—Ç–¥–µ–ª–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–π –≤–æ–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ—é –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ –º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä—É–π—Ç–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—Ö–æ—á—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–¥–∞–π—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã—Ö —Ñ—Ä–∞–∑ –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ
    for phrase in escalation_phrases:
        if phrase in text_normalized:
            return True
    
    return False

def _is_ai_asking_for_escalation(ai_response: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ª–∏ –ò–ò –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    if not ai_response:
        return False
        
    response_lower = ai_response.lower()
    
    # –§—Ä–∞–∑—ã, –∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    escalation_questions = [
        '–Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–¥–∞—Ç—å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É',
        '—ç—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '–ø–µ—Ä–µ–¥–∞—Ç—å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥—É',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º',
        '—Å–≤—è–∑–∞—Ç—å —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏
    for phrase in escalation_questions:
        if phrase in response_lower:
            return True
    
    return False

def _is_escalation_confirmation(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.
    """
    text_lower = text.lower()
    
    # –§—Ä–∞–∑—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ –ò–ò —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç)
    confirmation_phrases = [
        '–¥–∞',
        '–¥–∞, –Ω—É–∂–Ω–æ',
        '–¥–∞, –ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '–¥–∞, —Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '–¥–∞, —Å–≤—è–∂–∏—Ç–µ',
        '–¥–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–¥–∞, –∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞, –¥–∞–≤–∞–π—Ç–µ',
        '–¥–∞, —Ö–æ—Ä–æ—à–æ',
        '–¥–∞, —Å–æ–≥–ª–∞—Å–µ–Ω',
        '–Ω—É–∂–Ω–æ',
        '–ø–µ—Ä–µ–¥–∞–π—Ç–µ',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ',
        '—Å–≤—è–∂–∏—Ç–µ',
        '–ø–æ–∂–∞–ª—É–π—Å—Ç–∞',
        '–∫–æ–Ω–µ—á–Ω–æ',
        '–¥–∞–≤–∞–π—Ç–µ',
        '—Ö–æ—Ä–æ—à–æ',
        '—Å–æ–≥–ª–∞—Å–µ–Ω',
        '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ—Ä–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    for phrase in confirmation_phrases:
        if phrase in text_lower:
            return True
    
    return False

def _should_show_specialist_button(text: str) -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø—Ä–æ—Å–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å –µ–≥–æ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º/–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º.
    """
    text_lower = text.lower()
    
    # –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑—ã–≤–∞—é—Ç –Ω–∞ –∂–µ–ª–∞–Ω–∏–µ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
    specialist_keywords = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É', '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º',
        '–∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–º—É —á–µ–ª–æ–≤–µ–∫—É', '–∂–∏–≤—ã–º —á–µ–ª–æ–≤–µ–∫–æ–º',
        '–º–µ–Ω–µ–¥–∂–µ—Ä', '–º–µ–Ω–µ–¥–∂–µ—Ä–∞', '–º–µ–Ω–µ–¥–∂–µ—Ä—É', '–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º',
        '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É', '—Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º',
        '–æ–ø–µ—Ä–∞—Ç–æ—Ä', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', '–æ–ø–µ—Ä–∞—Ç–æ—Ä—É', '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º',
        '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É', '–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º',
        '—Å–æ–µ–¥–∏–Ω–∏—Ç—å', '—Å–æ–µ–¥–∏–Ω–∏—Ç–µ', '—Å–æ–µ–¥–∏–Ω–∏', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è',
        '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å', '–ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º',
        '—á–µ–ª–æ–≤–µ–∫', '—á–µ–ª–æ–≤–µ–∫–∞', '—á–µ–ª–æ–≤–µ–∫—É', '—á–µ–ª–æ–≤–µ–∫–æ–º',
        '–ø–æ–∑–≤–æ–Ω–∏—Ç—å', '–ø–æ–∑–≤–æ–Ω–∏—Ç–µ', '–∑–≤–æ–Ω–æ–∫', '–∑–≤–æ–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '—Å–≤—è–∑–∞—Ç—å—Å—è —Å', '—Å–≤—è–∑–∞—Ç—å', '—Å–≤—è–∑–∞—Ç—å —Å',
        '–ø–æ–¥–¥–µ—Ä–∂–∫–∞', '–ø–æ–¥–¥–µ—Ä–∂–∫—É', '–ø–æ–¥–¥–µ—Ä–∂–∫–µ', '–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',
        '–ø–æ–º–æ—â—å', '–ø–æ–º–æ—â–∏', '–ø–æ–º–æ—á—å', '–ø–æ–º–æ—â—å—é',
        '–Ω–µ –º–æ–≥—É', '–Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è', '–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
        '–ø—Ä–æ–±–ª–µ–º–∞', '–ø—Ä–æ–±–ª–µ–º—ã', '–ø—Ä–æ–±–ª–µ–º—É', '–ø—Ä–æ–±–ª–µ–º–æ–π',
        '—Å–ª–æ–∂–Ω–æ', '—Å–ª–æ–∂–Ω—ã–π', '—Å–ª–æ–∂–Ω–∞—è', '—Å–ª–æ–∂–Ω–æ–µ',
        '–Ω–µ –ø–æ–Ω–∏–º–∞—é', '–Ω–µ –ø–æ–Ω—è—Ç–Ω–æ', '–Ω–µ —è—Å–Ω–æ',
        '–æ–±—ä—è—Å–Ω–∏—Ç–µ', '–æ–±—ä—è—Å–Ω–∏', '–æ–±—ä—è—Å–Ω–∏—Ç—å',
        '–ø–æ–¥—Ä–æ–±–Ω–µ–µ', '–ø–æ–¥—Ä–æ–±–Ω–æ', '–ø–æ–¥—Ä–æ–±–Ω—ã–π',
        '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è', '–¥–µ—Ç–∞–ª—å–Ω–æ'
    ]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    for keyword in specialist_keywords:
        if keyword in text_lower:
            return True
    
    return False
